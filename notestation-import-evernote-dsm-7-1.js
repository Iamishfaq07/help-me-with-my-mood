/* Copyright (c) 2022 Synology Inc. All rights reserved. */

function _extends(){return _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=o[i])}return t},_extends.apply(this,arguments)}Ext.define("SYNO.SDS.NoteStation.Define",{statics:{isBeta:!1,CATEGORY:"category",TAG:"tag",NOTEBOOK:"notebook",NOTE:"note",SHORTCUT:"shortcut",JOINEDNOTEBOOK:"joinednotebook",USERNAME:"username",STACK:"stack",ALL:"all",SHARED:"shared",JOINED:"joined",COMMON:"common",DELETED:"deleted",DEFAULT:"default",ARCHIVE:"archive",SMART:"smart",PUBLIC:"public",OPEN_IN_NEW_TAB:"open_in_new_tab",CARDVIEW_MINIMUM_WIDTH:234,SNIPPETVIEW_MINIMUM_WIDTH:330,SHAREMODE:Ext.isFunction(window.getNoteStationShareMode)?window.getNoteStationShareMode():Ext.urlDecode(Ext.urlDecode(window.location.search.substring(1)).launchParam).mode||"",SHARETYPE:Ext.isFunction(window.getNoteStationShareType)?window.getNoteStationShareType():Ext.urlDecode(Ext.urlDecode(window.location.search.substring(1)).launchParam).type||"",OBJECT_ID:Ext.isFunction(window.getNoteStationObjectID)?window.getNoteStationObjectID():Ext.urlDecode(Ext.urlDecode(window.location.search.substring(1)).launchParam).object_id||"",MAGIC:"NoTeStAtIoNMaGic",TITLE_MAX_LENGTH:256,LINK_MAX_LENGTH:8192,IMAGE_PROPER_LENGTH:400,NOTIFY_PROMPT_VERSION:1}}),Ext.ns("SYNO.SDS.NoteStation"),window.SYNO.SDS.NoteStation._T=function(t,e){try{return _TT("SYNO.SDS.NoteStation.Application",t,e)||_T(t,e)}catch(o){return _T(t,e)}},Ext.define("SYNO.SDS.NoteStation.Utils",{statics:{imageFormat:["jpg","jpeg","jpe","bmp","gif","png"],isSupportImageFormat:function(t){var e;return!!Ext.isString(t)&&(e=t.split(".").pop(),!Ext.isEmpty(e)&&-1!==this.imageFormat.indexOf(e.toLowerCase()))},initErrorStr:function(){SYNO.SDS.NoteStation.ErrorString={900:_S("is_admin")?SYNO.SDS.NoteStation._T("error","moving_data"):SYNO.SDS.NoteStation._T("error","maintenance"),901:_S("is_admin")?SYNO.SDS.NoteStation._T("error","backuping"):SYNO.SDS.NoteStation._T("error","maintenance"),902:_S("is_admin")?SYNO.SDS.NoteStation._T("error","backuping"):SYNO.SDS.NoteStation._T("error","maintenance"),1e3:SYNO.SDS.NoteStation._T("error","error_system"),1001:"",1002:SYNO.SDS.NoteStation._T("error","error_system"),1003:SYNO.SDS.NoteStation._T("error","error_system"),1004:SYNO.SDS.NoteStation._T("error","error_system"),1005:SYNO.SDS.NoteStation._T("error","error_system"),1006:SYNO.SDS.NoteStation._T("error","error_system"),1007:SYNO.SDS.NoteStation._T("error","error_invalid"),1008:SYNO.SDS.NoteStation._T("error","object_not_exist"),1009:SYNO.SDS.NoteStation._T("error","error_demo"),1010:SYNO.SDS.NoteStation._T("error","error_system"),1011:SYNO.SDS.NoteStation._T("error","default_create_fail"),1012:SYNO.SDS.NoteStation._T("error","error_ns_disabled"),1013:SYNO.SDS.NoteStation._T("error","error_system"),1014:SYNO.SDS.NoteStation._T("error","error_system"),1015:SYNO.SDS.NoteStation._T("error","error_system"),1016:SYNO.SDS.NoteStation._T("error","error_system"),1017:SYNO.SDS.NoteStation._T("error","error_system"),1018:SYNO.SDS.NoteStation._T("error","error_system"),1019:SYNO.SDS.NoteStation._T("error","error_system"),1020:SYNO.SDS.NoteStation._T("error","object_no_permission"),1021:SYNO.SDS.NoteStation._T("error","error_system"),1022:SYNO.SDS.NoteStation._T("error","error_no_such_user"),1023:SYNO.SDS.NoteStation._T("error","object_no_permission"),1024:SYNO.SDS.NoteStation._T("error","error_system"),1025:SYNO.SDS.NoteStation._T("error","error_system"),1026:SYNO.SDS.NoteStation._T("error","error_system"),1027:SYNO.SDS.NoteStation._T("error","error_ns_disabled"),1028:SYNO.SDS.NoteStation._T("error","object_no_permission"),1029:SYNO.SDS.NoteStation._T("error","error_system"),1030:SYNO.SDS.NoteStation._T("error","error_expired"),1031:SYNO.SDS.NoteStation._T("error","error_synodrive"),1032:SYNO.SDS.NoteStation._T("error","error_synodrive"),1033:SYNO.SDS.NoteStation._T("error","drive_get_failed"),1034:SYNO.SDS.NoteStation._T("error","error_synodrive"),1035:SYNO.SDS.NoteStation._T("error","error_synodrive"),1036:SYNO.SDS.NoteStation._T("error","error_system"),1037:SYNO.SDS.NoteStation._T("error","cannot_delete_preset"),1038:SYNO.SDS.NoteStation._T("error","already_in_shortcut"),1039:SYNO.SDS.NoteStation._T("error","tag_already_exist"),1040:SYNO.SDS.NoteStation._T("error","default_create_fail"),1041:SYNO.SDS.NoteStation._T("error","preset_already_exist"),1042:SYNO.SDS.NoteStation._T("error","note_not_in_recycle"),1043:SYNO.SDS.NoteStation._T("error","no_available_notebook"),1044:SYNO.SDS.NoteStation._T("error","perm_op_fail"),1045:SYNO.SDS.NoteStation._T("error","error_system"),1046:SYNO.SDS.NoteStation._T("error","error_system"),1047:SYNO.SDS.NoteStation._T("error","default_create_fail_directory"),1048:SYNO.SDS.NoteStation._T("error","object_not_exist"),1049:SYNO.SDS.NoteStation._T("error","error_system"),1050:SYNO.SDS.NoteStation._T("error","no_enough_space"),1051:SYNO.SDS.NoteStation._T("error","export_op_fail"),1052:SYNO.SDS.NoteStation._T("error","compress_fail"),1053:SYNO.SDS.NoteStation._T("error","error_system"),1054:SYNO.SDS.NoteStation._T("error","note_not_exist"),1055:SYNO.SDS.NoteStation._T("error","extract_fail"),1056:SYNO.SDS.NoteStation._T("error","import_op_fail"),1057:SYNO.SDS.NoteStation._T("error","import_export_running"),1058:SYNO.SDS.NoteStation._T("error","import_export_not_running"),1059:SYNO.SDS.NoteStation._T("error","error_system"),1060:SYNO.SDS.NoteStation._T("error","error_system"),1061:SYNO.SDS.NoteStation._T("error","error_system"),1062:SYNO.SDS.NoteStation._T("error","error_system"),1063:SYNO.SDS.NoteStation._T("error","error_filename"),1064:SYNO.SDS.NoteStation._T("error","note_conflict"),1066:SYNO.SDS.NoteStation._T("error","error_system"),1067:SYNO.SDS.NoteStation._T("error","moving_data"),1068:SYNO.SDS.NoteStation._T("error","space_not_enough")}},getErrorStr:function(t){var e=Ext.isObject(t)?t.code:t;return Ext.isNumber(e)?e<400?SYNO.API.Errors.common[e]:e in SYNO.SDS.NoteStation.ErrorString?SYNO.SDS.NoteStation.ErrorString[e]:_T("error","error_error"):_T("error","error_error")},showErrorMsg:function(t,e,o,i){SYNO.SDS.NoteStation.Utils.showAlertMsg(t,SYNO.SDS.NoteStation.Utils.getErrorStr(e),o,i)},showAlertMsg:function(t,e,o,i){var n=t.getMsgBox();Ext.isEmpty(n)||n.alert("",e,o,i)},getClassName:function(t){return"category"===t||"owner"===t?"SYNO.SDS.NoteStation.Note.DataView.Category":"notebook"===t?"SYNO.SDS.NoteStation.Note.DataView":void 0},now:function(){return Math.round((new Date).getTime()/1e3)},isOnLine:function(){return navigator.onLine},supportOffline:function(){return!!(SYNO.SDS.HTML5Utils.isSupportIndexedDB&&SYNO.SDS.HTML5Utils.isSupportHTML5Upload()&&"onLine"in window.navigator&&window.FormData&&window.FileReader)},calculateMD5:function(t){var e="0123456789abcdef".split(""),o=function(t,e){var o=t[0],i=t[1],l=t[2],d=t[3];o=n(o,i,l,d,e[0],7,-680876936),d=n(d,o,i,l,e[1],12,-389564586),l=n(l,d,o,i,e[2],17,606105819),i=n(i,l,d,o,e[3],22,-1044525330),o=n(o,i,l,d,e[4],7,-176418897),d=n(d,o,i,l,e[5],12,1200080426),l=n(l,d,o,i,e[6],17,-1473231341),i=n(i,l,d,o,e[7],22,-45705983),o=n(o,i,l,d,e[8],7,1770035416),d=n(d,o,i,l,e[9],12,-1958414417),l=n(l,d,o,i,e[10],17,-42063),i=n(i,l,d,o,e[11],22,-1990404162),o=n(o,i,l,d,e[12],7,1804603682),d=n(d,o,i,l,e[13],12,-40341101),l=n(l,d,o,i,e[14],17,-1502002290),i=n(i,l,d,o,e[15],22,1236535329),o=s(o,i,l,d,e[1],5,-165796510),d=s(d,o,i,l,e[6],9,-1069501632),l=s(l,d,o,i,e[11],14,643717713),i=s(i,l,d,o,e[0],20,-373897302),o=s(o,i,l,d,e[5],5,-701558691),d=s(d,o,i,l,e[10],9,38016083),l=s(l,d,o,i,e[15],14,-660478335),i=s(i,l,d,o,e[4],20,-405537848),o=s(o,i,l,d,e[9],5,568446438),d=s(d,o,i,l,e[14],9,-1019803690),l=s(l,d,o,i,e[3],14,-187363961),i=s(i,l,d,o,e[8],20,1163531501),o=s(o,i,l,d,e[13],5,-1444681467),d=s(d,o,i,l,e[2],9,-51403784),l=s(l,d,o,i,e[7],14,1735328473),i=s(i,l,d,o,e[12],20,-1926607734),o=a(o,i,l,d,e[5],4,-378558),d=a(d,o,i,l,e[8],11,-2022574463),l=a(l,d,o,i,e[11],16,1839030562),i=a(i,l,d,o,e[14],23,-35309556),o=a(o,i,l,d,e[1],4,-1530992060),d=a(d,o,i,l,e[4],11,1272893353),l=a(l,d,o,i,e[7],16,-155497632),i=a(i,l,d,o,e[10],23,-1094730640),o=a(o,i,l,d,e[13],4,681279174),d=a(d,o,i,l,e[0],11,-358537222),l=a(l,d,o,i,e[3],16,-722521979),i=a(i,l,d,o,e[6],23,76029189),o=a(o,i,l,d,e[9],4,-640364487),d=a(d,o,i,l,e[12],11,-421815835),l=a(l,d,o,i,e[15],16,530742520),i=a(i,l,d,o,e[2],23,-995338651),o=r(o,i,l,d,e[0],6,-198630844),d=r(d,o,i,l,e[7],10,1126891415),l=r(l,d,o,i,e[14],15,-1416354905),i=r(i,l,d,o,e[5],21,-57434055),o=r(o,i,l,d,e[12],6,1700485571),d=r(d,o,i,l,e[3],10,-1894986606),l=r(l,d,o,i,e[10],15,-1051523),i=r(i,l,d,o,e[1],21,-2054922799),o=r(o,i,l,d,e[8],6,1873313359),d=r(d,o,i,l,e[15],10,-30611744),l=r(l,d,o,i,e[6],15,-1560198380),i=r(i,l,d,o,e[13],21,1309151649),o=r(o,i,l,d,e[4],6,-145523070),d=r(d,o,i,l,e[11],10,-1120210379),l=r(l,d,o,i,e[2],15,718787259),i=r(i,l,d,o,e[9],21,-343485551),t[0]=S(o,t[0]),t[1]=S(i,t[1]),t[2]=S(l,t[2]),t[3]=S(d,t[3])},i=function(t,e,o,i,n,s){return e=S(S(e,t),S(i,s)),S(e<<n|e>>>32-n,o)},n=function(t,e,o,n,s,a,r){return i(e&o|~e&n,t,e,s,a,r)},s=function(t,e,o,n,s,a,r){return i(e&n|o&~n,t,e,s,a,r)},a=function(t,e,o,n,s,a,r){return i(e^o^n,t,e,s,a,r)},r=function(t,e,o,n,s,a,r){return i(o^(e|~n),t,e,s,a,r)},l=function(t){var e,i=t.length,n=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=t.length;e+=64)o(n,d(t.substring(e-64,e)));t=t.substring(e-64);var s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<t.length;e++)s[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(s[e>>2]|=128<<(e%4<<3),e>55)for(o(n,s),e=0;e<16;e++)s[e]=0;return s[14]=8*i,o(n,s),n},d=function(t){var e,o=[];for(e=0;e<64;e+=4)o[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return o},c=function(t){var o,i;for(o="",i=0;i<4;i++)o+=e[t>>8*i+4&15]+e[t>>8*i&15];return o},h=function(t){var e;for(e=0;e<t.length;e++)t[e]=c(t[e]);return t.join("")},u=function(t){return h(l(t))},S=function(t,e){return t+e&4294967295};return"5d41402abc4b2a76b9719d911017c592"!==u("hello")&&(S=function(t,e){var o=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(o>>16)<<16|65535&o},"5d41402abc4b2a76b9719d911017c592"!==u("hello")&&SYNO.Debug("calculateMD5 self test failed")),u(t)},dataURItoBlob:function(t){var e,o,i,n,s;window.atob||(window.atob=this.base64Decode),e=t.split(",");try{o=e[0].split(":")[1].split(";")[0],i=window.atob(decodeURIComponent(e[1]))}catch(t){o="image/gif",i=window.atob("R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==")}n=new ArrayBuffer(i.length),s=new Uint8Array(n);for(var a=0;a<i.length;a++)s[a]=i.charCodeAt(a);return new Blob([n],{type:o})},loadExternalScript:function(t){var e=document.createElement("script");e.type="text/javascript",e.src=t,document.body.appendChild(e)},getGoogleMapApiKey:function(){return"AIzaSyBXG6lKBSQxQFR48lJ2_v9pzS7MFXu5XNU"},getGoogleMapScriptUrl:function(){return"https://maps.google.com/maps/api/js?key="+SYNO.SDS.NoteStation.Utils.getGoogleMapApiKey()+"&libraries=places"},getStackId:function(t){return t+"#"+SYNO.SDS.NoteStation.Window.owner_uid},getIconCls:function(t,e){return"default"===e&&(e="common"),String.format("syno-ns-notebook-fullmenu-{0}-{1}-icon",t,e)},getShardViewLink:function(t){var e=window.location.pathname.substr(0,window.location.pathname.lastIndexOf("/"));return 0<=e.indexOf("/ns/sharing")&&(e=e.substr(0,e.indexOf("/ns/sharing"))),window.location.protocol+"//"+window.location.host+e+"/ns/sharing/"+t},getPublicShareLink:function(t){return SYNO.SDS.NoteStation.Utils.getShardViewLink(t)},getCurrentNoteData:function(){var t,e,o,i,n={};return t=SYNO.SDS.NoteStation.Window,Ext.isEmpty(t)?"":(o=t.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel"),i=t.getPanelScope("SYNO.SDS.NoteStation.Editor.ReadOnly.Panel"),e=[o,i],Ext.each(e,function(t){if(!Ext.isEmpty(t)&&!Ext.isEmpty(t.noteData)&&!Ext.isEmpty(t.noteData.object_id))return Ext.apply(n,t.noteData),!1},this),Ext.isEmpty(n)?"":n)},getNoteDataById:function(t,e){var o=t.owned.note,i={};return e in o?Ext.apply(i,o[e]):null},setLeftSplitBarPosition:function(t){var e,o;e=SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.MainPanel"),o=e.layout.west.getSplitBar().el,o.setLeft(t)},getEmptyTextTpl:function(){return['<div id="{0}" ','class="{1}" ','style= "line-height:{2}px;" >',"{3}","</div>"].join("")},setEmptyTextLineHeight:function(t){var e=Ext.get(this.emptyTextId);if(Ext.isEmpty(e))return void SYNO.SDS.NoteStation.Utils.setEmptyText.call(this,t);Ext.isEmpty(t)&&(t=this.getHeight()),e.setStyle("line-height",t+"px")},setEmptyText:function(t){var e=SYNO.SDS.NoteStation.Utils.getEmptyTextTpl(),o=SYNO.SDS.NoteStation._T("note","no_item");"note_search"===this.itemId||"todo_search"===this.itemId?o=SYNO.SDS.NoteStation._T("search","no_search_result"):"todo_view"===this.itemId&&(o=SYNO.SDS.NoteStation._T("todo","no_todo_task")),Ext.isEmpty(t)&&(t=this.getHeight()),this.emptyText=String.format(e,this.emptyTextId,"todo_view"===this.itemId||"todo_search"===this.itemId?"syno-ns-todo-empty-text":"syno-ns-note-empty-text disable-font",t,o)},getTagsArray:function(t){var e=[];return Ext.isEmpty(t)?e:(t.getValueEx().forEach(function(o){e.push(o[t.valueField])},this),e)},loadTags:function(t,e){var o=[],i=[],n=SYNO.SDS.NoteStation.Window;Ext.iterate(n.tag,function(t,e){i.push(new Ext.data.Record({tag:e.title,text:e.title}))},this),t.clearValue(!0),Ext.isEmpty(i)||(t.getStore().removeAll(),t.getStore().add(i)),e.forEach(function(t){o.push({tag:t,text:t})},this),Ext.isEmpty(o)||t.addItems(o),t.originalValue=t.getValue()},parseTagStructure:function(t){var e=[];Ext.iterate(t,function(t,o){o.items={},e.push(o)},this),e.sort(function(t,e){return t.title.length-e.title.length});var o={},i={};return Ext.iterate(e,function(t){var e=t.title,n="";Ext.iterate(i,function(t,o){t.length>n.length&&SYNO.SDS.NoteStation.Utils.checkTagIsParent(t,e)&&(n=t)});var s=SYNO.SDS.NoteStation.Utils.getTagChild(e,n);t.text=s,Ext.isEmpty(n)?(o[s]=t,i[e]=o[s]):(i[n].items[s]=t,i[e]=i[n].items[s])}),this.getSortedTag(o)},getSortedTag:function(t){var e=[];return Ext.iterate(t,function(t,o){var i=Ext.apply({},o);i.items=SYNO.SDS.NoteStation.Utils.getSortedTag(o.items),e.push(i)},this),e.sort(function(t,e){return t.text<e.text?-1:1}),e},isSeparatorTag:function(t){for(var e=0;e<t.length;e++)if("/"!==t[e])return!1;return!0},checkTagIsParent:function(t,e){return t!==e&&0===e.indexOf(t)&&("/"===e[t.length]||"/"===e[t.length-1])},combineToFullTag:function(t,e,o){if(Ext.isEmpty(t))return e;void 0===o&&(o=SYNO.SDS.NoteStation.Utils.isSeparatorTag(e));var i="/"===t[t.length-1];return o||i?t+e:t+"/"+e},getTagChild:function(t,e){if(Ext.isEmpty(e))return t;var o=t.substr(e.length),i=SYNO.SDS.NoteStation.Utils.isSeparatorTag(o),n="/"===e[e.length-1];return i||n?o:o.substr(1)},getTagParent:function(t,e){var o=t.substr(0,t.length-e.length),i=t.substr(0,t.length-e.length-1);return o+"@"+SYNO.SDS.NoteStation.Window.uid_map[_S("user")]in SYNO.SDS.NoteStation.Window.tag?o:i},getAllChildTags:function(t,e,o){var i=[];return i.push(Ext.copyTo({prefix:e,all_separator:o},t,"tag_id,id,title,text")),Ext.iterate(t.items,function(t){i=i.concat(SYNO.SDS.NoteStation.Utils.getAllChildTags(t,e,o))},this),i},switchNotebookBtn:function(t){var e,o,i,n,s;e=SYNO.SDS.NoteStation.Window,o=e.getPanelScope("SYNO.SDS.NoteStation.Note.Panel"),i=o.getTopToolbar(),n=i.getComponent("btn_switch_notebook"),s=i.getComponent("display_title"),"full"===t?(s.show(),n.hide()):"light"===t&&(s.hide(),n.show())},getFullMenuNodeAttr:function(t){var e,o=SYNO.SDS.NoteStation.Window.getMainPanel().getNotebookPanel(),i=o.fullMenu;return e=i.getNodeById(t),Ext.isEmpty(e)?null:e.attributes},isIndividualSharedAcl:function(t){if(!Ext.isObject(t)||!1===t.enabled)return!1;if("public"in t&&Ext.isString(t.public.perm)&&!1===t.public.inherit)return!0;if("dsm_user"in t&&Ext.isObject(t.dsm_user))for(var e in t.dsm_user)if(Ext.isObject(t.dsm_user[e])&&Ext.isString(t.dsm_user[e].perm)&&!1===t.dsm_user[e].inherit)return!0;if("dsm_group"in t&&Ext.isObject(t.dsm_group))for(var o in t.dsm_group)if(Ext.isObject(t.dsm_group[o])&&Ext.isString(t.dsm_group[o].perm)&&!1===t.dsm_group[o].inherit)return!0;return!1},isIndividualJoined:function(t,e){if(!Ext.isObject(t)||!1===t.enabled)return!1;if("dsm_user"in t&&Ext.isObject(t.dsm_user)&&Ext.isObject(t.dsm_user[e])&&!1===t.dsm_user[e].inherit)return!0;if("dsm_group"in t&&Ext.isObject(t.dsm_group))for(var o in t.dsm_group)if(Ext.isObject(t.dsm_group[o])&&!1===t.dsm_group[o].inherit)return!0;return!1},isSharedAcl:function(t){if(!Ext.isObject(t)||!1===t.enabled)return!1;if("public"in t&&Ext.isString(t.public.perm))return!0;if("dsm_user"in t&&Ext.isObject(t.dsm_user))for(var e in t.dsm_user)if(Ext.isObject(t.dsm_user[e])&&Ext.isString(t.dsm_user[e].perm))return!0;if("dsm_group"in t&&Ext.isObject(t.dsm_group))for(var o in t.dsm_group)if(Ext.isObject(t.dsm_group[o])&&Ext.isString(t.dsm_group[o].perm))return!0;return!1},isDescendant:function(t,e){var o;if(Ext.isEmpty(e))return!1;for(o=e.parentNode;null!==o;){if(o==t)return!0;o=o.parentNode}return!1},isJoinednote:function(t,e){return e in t.joined.note},getExternalHref:function(t,e,o){var i,n="";return i=window.location.port,o._S("rewrite_mode")||(i="https:"===window.location.protocol?o._S("external_port_dsm_https")&&""!==o._S("external_port_dsm_https")?o._S("external_port_dsm_https"):window.location.port:o._S("external_port_dsm_http")&&""!==o._S("external_port_dsm_http")?o._S("external_port_dsm_http"):window.location.port),!t&&o._S("external_host_ip")&&""!==o._S("external_host_ip")?n=window.location.protocol+"//"+o._S("external_host_ip")+":"+i:!t&&o._S("ddns_hostname")&&""!==o._S("ddns_hostname")?n=window.location.protocol+"//"+o._S("ddns_hostname")+":"+i:e&&""!==e?n=e:t||window.location.hostname.startsWith("192.168.")||window.location.hostname.startsWith("127.")||window.location.hostname.startsWith("10.")||(n=window.location.protocol+"//"+window.location.hostname+":"+i),n},getAttachmentEncode:function(t){var e,o,i="";if(!Ext.isString(t))return i;if(e=CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(t)),!Ext.isString(e))return i;for(o=0;o<e.length;o++)"A"<=e[o]&&e[o]<="Z"?i+=e[o]:"0"<=e[o]&&e[o]<="9"?i+=e[o]:i+="{"+e.charCodeAt(o)+"}";return i},isQuickConnectHost:function(t){return t=t.toLowerCase(),t.endsWith("quickconnect.to")||t.endsWith("quickconnect.cn")},getWidthAttr:function(t){return Ext.isEmpty(t)||"null"===t?"":String.format('width="{0}"',t)},getHeightAttr:function(t){return Ext.isEmpty(t)||"null"===t?"":String.format('height="{0}"',t)},openNoteInNewTab:function(t,e,o){var i,n,s;if(SYNO.SDS.NoteStation.Utils.isPublicShare){var a=o||t.noteData.link_id;i=SYNO.SDS.NoteStation.Utils.getPublicShareLink(a),window.open(i)}else n={type:"note",mode:"open_in_new_tab",object_id:e},s=window.open("about:blank"),t.saveNote(function(){var o,i;SYNO.SDS.NoteStation.WindowLaunch("SYNO.SDS.NoteStation.Application",n,!1,s),o=window.setInterval(function(){if(t.isDestroyed)return void window.clearInterval(o);!0===s.closed&&(delete SYNO.SDS.NoteStation.Window.NewTabNoteSavedCallback,Ext.isObject(i)&&t.owner.fireEvent("notesaved",!0,i),Ext.isObject(t.noteData)&&e===t.noteData.object_id&&t.saveNote(function(){t.loadNote(e,void 0,t.notePerm)}),window.clearInterval(o))},1200),SYNO.SDS.NoteStation.Window.NewTabNoteSavedCallback=function(t,e){t&&(i=e)}})},base64Encode:function(t){var e,o,i,n,s,a,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(i=t.length,o=0,e="";o<i;){if(n=255&t.charCodeAt(o++),o==i){e+=r.charAt(n>>2),e+=r.charAt((3&n)<<4),e+="==";break}if(s=t.charCodeAt(o++),o==i){e+=r.charAt(n>>2),e+=r.charAt((3&n)<<4|(240&s)>>4),e+=r.charAt((15&s)<<2),e+="=";break}a=t.charCodeAt(o++),e+=r.charAt(n>>2),e+=r.charAt((3&n)<<4|(240&s)>>4),e+=r.charAt((15&s)<<2|(192&a)>>6),e+=r.charAt(63&a)}return e},base64Decode:function(t){var e,o,i,n,s,a,r,l=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1];for(a=t.length,s=0,r="";s<a;){do{e=l[255&t.charCodeAt(s++)]}while(s<a&&-1==e);if(-1==e)break;do{o=l[255&t.charCodeAt(s++)]}while(s<a&&-1==o);if(-1==o)break;r+=String.fromCharCode(e<<2|(48&o)>>4);do{if(61==(i=255&t.charCodeAt(s++)))return r;i=l[i]}while(s<a&&-1==i);if(-1==i)break;r+=String.fromCharCode((15&o)<<4|(60&i)>>2);do{if(61==(n=255&t.charCodeAt(s++)))return r;n=l[n]}while(s<a&&-1==n);if(-1==n)break;r+=String.fromCharCode((3&i)<<6|n)}return r},maskEditor:function(t){var e,o,i=Ext.get(t.getBody());!0!==t.isMask&&(t.mask=Ext.DomHelper.createDom({tag:"div",cls:"syno-ns-editor-mask-msg",style:"font-size:16px; font-family:verdana, tahoma, arial, helvetica, sans-serif;",children:[{tag:"div",html:SYNO.SDS.NoteStation._T("filetable","drop_file"),contenteditable:"false"}]}),e=Ext.util.TextMetrics.measure(t.mask,SYNO.SDS.NoteStation._T("filetable","drop_file")),o=Ext.fly(t.mask),o.setStyle({left:String.format("{0}px",(t.owner.getWidth()-(e.width+40))/2),top:String.format("{0}px",(t.owner.getHeight()-40)/2)}),o.addListener("dragover",function(t){t.preventDefault()}),o.addListener("drop",function(t){t.preventDefault()}),i.addClass("file-drag-over"),i.appendChild(t.mask),t.isMask=!0)},unMaskEditor:function(t){var e=t.getBody();!1!==t.isMask&&(e.classList.remove("file-drag-over"),Ext.isElement(t.mask)&&e.removeChild(t.mask),t.isMask=!1)},utf8_to_b64:function(t){return(Ext.isFunction(window.btoa)?window.btoa:SYNO.SDS.NoteStation.Utils.base64Encode)(window.unescape(window.encodeURIComponent(t)))},genUniqueImageRef:function(t,e){var o,i,n,s=new Date,a=[];if(i=Ext.get(t),Ext.isEmpty(i))return!1;n=i.query("img[ref]"),n.forEach(function(t){a.push(t.getAttribute("ref"))}),s=s.getTime();do{o=SYNO.SDS.NoteStation.Utils.utf8_to_b64(s+e)}while(-1!==a.indexOf(o));return o},serializeContent:function(t){var e,o,i,n,s={},a=[],r={content_attachment:{},attachment:{}},l=!1,d=!1;if(!Ext.isObject(t)||!t.editor||!Ext.isFunction(t.callback)||Ext.isEmpty(t.appWin)||!Ext.isObject(t.noteData))return!1;e=t.editor.getDoc(),o=document.createElement("div"),o.innerHTML=t.editor.getContent(),n=Ext.copyTo({object_id:t.noteData.object_id,app:"DSMPHPMailer"},t.notePerm,"perm_from,smart_id"),Ext.iterate(o.querySelectorAll("input.syno-notestation-editor-checkbox"),function(t,e){var o=document.createElement("img");t.classList.contains("syno-notestation-editor-checkbox-checked")?(o.src="/webman/modules/TinyMCE/js/tinymce/plugins/syno_checkbox/editor_checkbox_03.png",o.setAttribute("content_id","#checkbox_checked"),r.content_attachment["#checkbox_checked"]={name:"checked.png",remove:!0},l=!0):(o.src="/webman/modules/TinyMCE/js/tinymce/plugins/syno_checkbox/editor_checkbox_01.png",o.setAttribute("content_id","#checkbox_unchecked"),r.content_attachment["#checkbox_unchecked"]={name:"unchecked.png",remove:!0},d=!0),["class","style"].forEach(function(e){var i=t.getAttribute(e);i&&o.setAttribute(e,i)}),t.parentNode.insertBefore(o,t),t.parentNode.removeChild(t)}),l&&a.push({api:"SYNO.NoteStation.Note.AppLink",version:1,method:"get",params:Ext.apply({file_id:"#checkbox_checked"},n)}),d&&a.push({api:"SYNO.NoteStation.Note.AppLink",version:1,method:"get",params:Ext.apply({file_id:"#checkbox_unchecked"},n)}),i=o.querySelectorAll("table"),Ext.iterate(i,function(t){t.classList.add("mce-item-table")});for(var c=0;c<e.styleSheets.length;c++)if(null!==e.styleSheets[c].cssRules)for(var h=0;h<e.styleSheets[c].cssRules.length;h++){var u=e.styleSheets[c].cssRules[h];try{for(var S=o.querySelectorAll(u.selectorText),p=0;p<S.length;p++){var m=S[p];m.style.cssText+=u.style.cssText,m.cssText=m.style.cssText}}catch(t){}}return Ext.iterate(i,function(t){t.classList.remove("mce-item-table")}),!0===t.noteData.encrypt&&(n.token=t.appWin.getEncryptPassword(t.noteData.object_id).token),Ext.isObject(t.attachment)&&(Ext.iterate(t.attachment,function(t,e){Ext.isEmpty(e.ref)?(r.attachment[t]=e,r.attachment[t].remove=!0):s[e.ref]=t,a.push({api:"SYNO.NoteStation.Note.AppLink",version:2,method:"get",params:Ext.apply({file_id:t},n)})}),Ext.iterate(o.querySelectorAll("img[ref]"),function(e,o){var i=e.getAttribute("ref"),n=s[i];i in s&&(r.content_attachment[n]=t.attachment[n],r.content_attachment[n].remove=!0,e.setAttribute("content_id",s[i]),delete s[i]),e.removeAttribute("ref")},this)),Ext.iterate(o.querySelectorAll(".syno-ns-chart-object"),function(e,o){e=SYNO.SDS.NoteStation.Chart.ChartObjectHelper.translateChartTag(e,"DIV","IMG"),SYNO.SDS.NoteStation.Chart.ChartObjectHelper.draw(t.editor.getWin().Flotr,e),e.removeAttribute("chart-data"),e.removeAttribute("chart-config")}),r.content=o.innerHTML,t.appWin.sendWebAPI({compound:{stopwhenerror:!1,params:a},callback:function(e,o){var i;if(!e)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(t.appWin,o.code);Ext.iterate(o.result,function(t,e){i=a[e].params.file_id,i in r.content_attachment?r.content_attachment[i].symlink=t.data.filename:i in r.attachment&&(r.attachment[i].symlink=t.data.filename)}),t.callback.call(t.scope||window,r)},scope:this}),r},supportPersonalMail:function(){var t=!1;try{t=Ext.isFunction(SYNO.SDS.App.MailDialog.Utils.launchMailFn)}catch(e){t=!1}return t},supportFullscreen:function(){return!!(document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled)},getInternalLink:function(t,e){var o,i,n,s=SYNO.SDS.NoteStation.Window;if(t in s.owned.note)o="self/"+t,i=s.owned.note[t].title;else{if(!(t in s.joined.note))return null;n=s.joined.note[t],i=n.title,o=e?"smart/"+e+"/"+t:"self/"+t}return o="notestation://remote/"+o,String.format('<a href="{0}">{1}</a>',o,Ext.util.Format.htmlEncode(i))},genElementToCopy:function(t){var e=document.createElement("div");return e.innerHTML=t,e.setAttribute("contenteditable",!0),e.style.left="-100000px",e.style.top="-100000px",e.style.position="absolute",e},copyElement:function(t){t.focus();var e=window.getSelection(),o=document.createRange();o.selectNodeContents(t),e.removeAllRanges(),e.addRange(o);var i=!0;try{document.execCommand("copy")}catch(t){i=!1}return i},showNotebookMenu:function(t,e,o){var i=[],n={},s=function(t,e){return t.text>e.text?1:t.text<e.text?-1:0};if(!Ext.isEmpty(e)){t.removeAll(),Ext.iterate(e.owned.stack,function(t,e){var o={text:e.title,total:e.items.length,iconCls:"syno-ns-create-btn-collection-notebook-menu-icon",menu:{cls:"syno-ns-menu",items:[]}};n[e.title]=o}),Ext.iterate(e.owned.notebook,function(t,e){var s,a;if(s=!0===e.preset?"default":!0===e.shared?"shared":"common",!0===e.owned&&!0!==e.archive&&(a=o(e))){var r={text:e.title,total:e.item_count,category:"notebook",type:s,iconCls:String.format("syno-ns-create-btn-{0}-notebook-menu-icon",s),handler:a,scope:this};e.stack&&n.hasOwnProperty(e.stack)?n[e.stack].menu.items.push(r):i.push(r)}},this);var a=Object.entries(n).filter(function(t){t[0];return t[1].menu.items.length>0}).map(function(t){var e=(t[0],t[1]);return e.menu.items.sort(s),e}).sort(s);i.sort(s),a.length>0&&i.length>0&&a.push("-"),t.add(a.concat(i))}},getReminderOffset:function(t,e,o){var i=-1;if(Ext.isEmpty(t)||Ext.isEmpty(e)||Ext.isEmpty(o))return i;if("none"===t)i=-1;else if("ontime"===t)i=0;else if("30min"===t)i=1800;else if("1hour"===t)i=3600;else if("12hour"===t)i=43200;else if("1day"===t)i=86400;else{var n=60;"min"===e?n=60:"hour"===e?n=3600:"day"===e?n=86400:"week"===e&&(n=604800),i=o*n}return i},getReminderObject:function(t){var e="none",o=1,i="hour";-1===t?e="none":0===t?e="ontime":1800===t?e="30min":3600===t?e="1hour":43200===t?e="12hour":86400===t?e="1day":(60<=t&&3600>=t?(i="min",o=Math.round(t/60)):3600<=t&&86400>=t?(i="hour",o=Math.round(t/3600)):86400<=t&&2678400>=t?(i="day",o=Math.round(t/86400)):604800<=t&&4838400>=t&&(i="week",o=Math.round(t/604800)),e="customized");var n={};return n.predefined=e,n.unit=i,n.value=o,n},getPriorityCode:function(t){return{none:-1,low:100,medium:200,high:300}[t]},getPriority:function(t){return{"-1":"none",100:"low",200:"medium",300:"high"}[t]},isNoDueDate:function(t){return Ext.isDate(t)?-1===this.dateToEpoch(t):Ext.isNumber(t)?-1===t:!Ext.isString(t)||""===t},epochToDate:function(t){return new Date(1e3*t)},dateToEpoch:function(t){return Ext.isDate(t)?Math.round(t.getTime()/1e3):-1},convertDateToObject:function(t){var e={};return e.year=t.getFullYear(),e.month=t.getMonth(),e.day=t.getDate(),e.hour=t.getHours(),e.min=t.getMinutes(),e.sec=t.getSeconds(),e},convertStringToDate:function(t){if(Ext.isString(t)){var e=new Date,o=this.convertDateToObject(e);if(o.hour=23,o.min=59,o.sec=59,"today"===t);else if("tomorrow"===t)o.day+=1;else if("next_7_days"===t)o.day+=6;else if("next_30_days"===t)o.day+=29;else{if("yesterday"!==t&&"overdue"!==t)return-1;o.day-=1}return new Date(o.year,o.month,o.day,o.hour,o.min,o.sec)}},convertDateToString:function(t){if(this.isNoDueDate(t))return"no_due_date";var e=t;Ext.isDate(t)&&(e=this.dateToEpoch(t));var o=new Date,i=this.convertDateToObject(o),n=new Date(i.year,i.month,i.day,0,0,0),s=this.dateToEpoch(n),a=new Date(i.year,i.month,i.day,23,59,59),r=this.dateToEpoch(a),l=new Date(i.year,i.month,i.day+1,23,59,59),d=this.dateToEpoch(l),c=new Date(i.year,i.month,i.day+6,23,59,59),h=this.dateToEpoch(c),u=new Date(i.year,i.month,i.day+29,23,59,59),S=this.dateToEpoch(u);return s>e?"overdue":r>=e&&s<=e?"today":d>=e&&r<e?"tomorrow":h>=e&&d<e?"next_7_days":S>=e&&h<e?"next_30_days":"others"},formatDateString:function(t,e){if(Ext.isDate(t)){var o,i=new Date,n=i.getFullYear(),s=t.getMonth()+1,a=t.getDay(),r=t.getDate(),l=t.getFullYear(),d=t.format("H"),c=t.format("i"),h=_T("login","mon_"+s),u=_T("login","weekday_"+a);o=n===l?String.format(_T("login","date_format"),h,r,u):String.format(SYNO.SDS.NoteStation._T("common","date_format_with_year"),h,r,u,l);var S=String.format("{0}:{1}",d,c);return e?o+", "+S:o}},dateTimeFormatter:function(t,e){if(SYNO.SDS.DateTimeFormatter)return SYNO.SDS.DateTimeFormatter(t,e);if(!t||"[object Date]"!==Object.prototype.toString.call(t))return"";var o,i=e&&e.type,n=SYNO.SDS.Session.date_format||"Y-m-d",s=SYNO.SDS.Session.time_format||"H:i",a=s.endsWith(" a")?" a":"",r=s.substr(0,s.length-a.length);return o="date"===i?n:"time"===i?r+":s"+a:"datetimesec"===i?n+" "+r+":s"+a:n+" "+s,t.format(o)},getTodoPanel:function(){return SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.Todo.Panel")},leadingZero:function(t){return Ext.isNumber(t)?t>=0&&t<10?"0"+t.toString():t.toString():t},isPublicShare:"public"===SYNO.SDS.NoteStation.Define.SHAREMODE,isOpenInNewTab:"open_in_new_tab"===SYNO.SDS.NoteStation.Define.SHAREMODE,isNormal:!!Ext.isEmpty(SYNO.SDS.NoteStation.Define.SHAREMODE),isMobileDevice:/Android|webOS|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile|windows phone os 7|windows phone 8/i.test(navigator.userAgent),isMobileiOS:/iPhone|iPad|iPod/i.test(navigator.userAgent),isShowNote:"note"===SYNO.SDS.NoteStation.Define.SHARETYPE,isShowNotebook:"notebook"===SYNO.SDS.NoteStation.Define.SHARETYPE,isShowSmart:"smart"===SYNO.SDS.NoteStation.Define.SHARETYPE,clipperExtensionId:"pcfbfimijgibligmbglggnbiobgjgmbk",detectClipperInstalled:function(t,e){var o;if(Ext.isFunction(t)){if(!Ext.isChrome||Ext.isEmpty(window.chrome))return void t.call(e,!1);o=new XMLHttpRequest,o.open("HEAD","chrome-extension://"+SYNO.SDS.NoteStation.Utils.clipperExtensionId+"/manifest.json",!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.timeout=1e3,o.onreadystatechange=function(){4===o.readyState&&(200===o.status?t.call(e,!0):t.call(e,!1))},o.ontimeout=function(){t.call(e,!1)},o.send()}}}}),SYNO.SDS.NoteStation.WindowLaunch=function(t,e,o,i){var n=SYNO.SDS.Config.FnMap[t],s="";if(!n)return!1;if("standalone"===n.config.type||!0===n.config.allowStandalone||"url"===n.config.type||"legacy"===n.config.type){
if(!n.config.url&&!SYNO.SDS.UrlTag[n.config.urlTag])return!1;Ext.isObject(e)&&(s={launchParam:Ext.urlEncode(e)},Ext.isDefined(e.ieMode)&&(s.ieMode=e.ieMode));var a=n.config.url||SYNO.SDS.UrlTag[n.config.urlTag]||"";if(SYNO.SDS.QuickConnect.Utils.isInTunnel()&&!SYNO.SDS.IsDSMPortalWhiteList(t)&&"url"===n.config.type){return new SYNO.SDS.MessageBoxV5({modal:!0,draggable:!1,renderTo:document.body}).alert(_T("relayservice","package_not_supported"),_T("relayservice","package_not_supported")),!1}if((n.config.port||n.config.protocol)&&"http"!==a.substr(0,4).toLowerCase()){var r=n.config.protocol||window.location.protocol,l=n.config.port||window.location.port||"";l&&(l=":"+l),SYNO.SDS.QuickConnect.Utils.isInTunnel()&&(r="https",l=""),a=r+"://"+window.location.hostname+l+a}return Ext.isEmpty(i)&&(i=window),!1===o?i.location=Ext.urlAppend(a,Ext.urlEncode(s),!1):i.open(Ext.urlAppend(a,Ext.urlEncode(s),!1),n.config.urlTarget?n.config.urlTarget+SYNO.SDS.LaunchTime:"_blank",n.config.windowParam||""),!0}return!1},Ext.ns("SYNO.SDS.NoteStation.Storage"),Ext.define("SYNO.SDS.NoteStation.Storage.WebAPI",{extend:"Ext.util.Observable",constructor:function(t){this.appWindow=t.appWindow,this.instance=t.instance,this.list_note_id=null,this.callParent([t])},destroy:Ext.emptyFn,initial:function(t){this.appWindow.sendWebAPI({compound:{stopwhenerror:!1,params:[{api:"SYNO.NoteStation.Setting",version:1,method:"init"},{api:"SYNO.NoteStation.Info",version:2,method:"get"},{api:"SYNO.NoteStation.Setting",version:2,method:"get"}]},callback:function(e,o){this.instance.storageready=!0,t.callback.call(t.scope||window,e,o)},scope:this})},sendWebAPIPromise:function(t){return this.appWindow.sendWebAPIPromise(t).then(function(t){return{succ:!0,resp:t}}).catch(function(t){return{succ:!1,resp:t}})},listNotebook:function(t){var e=function(e,o){var i={};!0===e?i.notebook=o:i=o,t.callback.call(t.scope||window,e,i)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Notebook",version:2,method:"list",params:Ext.copyTo({},t,"filter,field,offset,limit,sort_by,sort_direction"),callback:e,scope:this})},createNotebook:function(t){var e=function(e,o){var i;i=!0===e?{object_id:o.object_id,title:t.title,item_count:0,shared:!1,ver:o.ver,ctime:o.ctime,owner:{display_name:this.appWindow._S("user")},owned:!0}:o,t.callback.call(t.scope||window,e,i)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Notebook",version:2,method:"create",params:{title:t.title,commit_msg:Ext.apply({device:"desktop"},t.commit_msg)},callback:e,scope:this})},setNotebook:function(t){var e=function(e,o){var i;i=!0===e?{object_id:o.object_id,title:t.title,shared:!1,ver:o.ver,ctime:o.ctime,mtime:o.mtime,owner:{display_name:this.appWindow._S("user")}}:o,t.callback.call(t.scope||window,e,i)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Notebook",version:2,method:"set",params:Ext.copyTo({commit_msg:Ext.apply({device:"desktop"},t.commit_msg)},t,"object_id,title,stack"),callback:e,scope:this})},deleteNotebook:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Notebook",version:2,method:"delete",params:Ext.copyTo({},t,"object_id,recursive"),callback:t.callback,scope:t.scope||window})},getNotebook:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Notebook",version:2,method:"get",params:Ext.copyTo({},t,"object_id"),callback:t.callback,scope:t.scope||window})},listNote:function(t){var e=function(e,o){var i={};!0===e?(i.note=o,this.appWindow.analyzeNote(o)):i=o,t.callback.call(t.scope||window,e,i)};Ext.isEmpty(this.list_note_id)||(!1!==t.cancel_previous_request&&Ext.Ajax.abort(this.list_note_id),this.list_note_id=null),this.list_note_id=this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note",version:3,method:"list",params:Ext.copyTo({},t,"filter,field,offset,limit,sort_by,sort_direction,mode,stack,perm_from,smart_id"),callback:e,scope:this})},createNoteAsync:function(t){var e=this;return this.sendWebAPIPromise({api:"SYNO.NoteStation.Note",version:3,method:"create",params:Ext.copyTo({commit_msg:Ext.apply({device:"desktop",listable:!1},t.commit_msg)},t,"title,parent_id,encrypt,content,brief,ctime,mtime,latitude,longitude")}).then(function(o){var i=o.succ,n=o.resp;return{succ:i,resp:n,result:!0===i?{object_id:n.object_id,title:t.title,item_count:0,shared:!1,ver:n.ver,owner:e.appWindow._S("user"),owned:n.owner.display_name===e.appWindow._S("user"),parent_id:t.parent_id,encrypt:t.encrypt,password:t.password}:n}})},getNote:function(t){var e=function(e,o){!0===e&&this.appWindow.analyzeNote({total:1,offset:0,notes:[o]}),t.callback.call(t.scope||window,e,o)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note",version:3,method:"get",params:Ext.copyTo({},t,"object_id,ver,perm_from,smart_id"),callback:e,scope:this})},setNoteWithFiles:function(t,e){var o,i,n=[],s=function(e,o,i){if(!0!==e)return void t.callback.call(t.scope||window,e,o);o.ver!==i.ver&&(o.modified_ver=i.ver,o.conflict=!0),t.callback.call(t.scope||window,e,o)};o=new window.FormData,Ext.iterate(t.attachment,function(e,s){switch(i=Ext.copyTo({rotate:!0},s,"action,format,ref,convert,rotate"),s.action){case"create":"url"===s.format?(i.name=e,i.source=s.source):"raw"===s.format?(i.name=Ext.id(),o.append(i.name,t.attachment[e].source,e)):"ds"===s.format&&(i.name=e,i.source=s.source);break;case"delete":i.file_id=e;break;default:return}n.push(i)},this),e.attachment=n,Ext.iterate(e,function(t,e){o.append(t,Ext.encode(e))}),this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note",version:3,method:"set",html5upload:!0,uploadData:o,progress:t.progress,callback:function(e,o){if(!0!==e)return void t.callback.call(t.scope||window,e,o);this.getNote(Ext.copyTo({callback:function(t,e){s.call(this,t,e,o.data[0])},scope:this},t,"object_id,perm_from,smart_id"))},scope:this})},setNote:function(t){var e,o=!!window.FormData,i=function(e,o,i){if(!0!==e)return void t.callback.call(t.scope||window,e,o);t.callback.call(t.scope||window,e,o)};if(e=Ext.copyTo({commit_msg:Ext.apply({device:"desktop"},t.commit_msg)},t,"object_id,ver,content,brief,tag,title,source_url,latitude,longitude,location,def_latitude,def_longitude,parent_id,encrypt,recycle,token,ctime,mtime,check_conflict,perm_from,smart_id"),Ext.isObject(t.attachment)){if(o)return void this.setNoteWithFiles(t,e);e.attachment=[],Ext.iterate(t.attachment,function(t,o){"delete"===o.action&&e.attachment.push({action:"delete",file_id:t})}),0===e.attachment.length&&delete e.attachment}this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note",version:3,method:"set",params:e,async:e.async,callback:function(e,o){if(!0!==e||Ext.isArray(t.object_id))return void t.callback.call(t.scope||window,e,o);this.getNote(Ext.copyTo({ver:o.data[0].ver,callback:function(t,e){i.call(this,t,e,o.data[0])},scope:this},t,"object_id,perm_from,smart_id"))},scope:this})},setNotePollingWithFiles:function(t,e){var o,i,n=[];o=new window.FormData,Ext.iterate(t.attachment,function(e,s){switch(i=Ext.copyTo({rotate:!0},s,"action,format,ref,convert,rotate"),s.action){case"create":"url"===s.format?(i.name=e,i.source=s.source):"raw"===s.format?(i.name=Ext.id(),o.append(i.name,t.attachment[e].source,e)):"ds"===s.format&&(i.name=e,i.source=s.source);break;case"delete":i.file_id=e;break;default:return}n.push(i)},this),e.attachment=n,Ext.iterate(e,function(t,e){o.append(t,Ext.encode(e))}),this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note.Polling",version:3,method:"set",html5upload:!0,uploadData:o,progress:t.progress,callback:function(e,o){if(!0!==e||Ext.isArray(t.object_id))return void t.callback.call(t.scope||window,e,o);this.pollingSetStatus(o.task_id,t)},scope:this})},setNotePolling:function(t){var e,o=!!window.FormData;if(e=Ext.copyTo({commit_msg:Ext.apply({device:"desktop"},t.commit_msg)},t,"object_id,ver,content,brief,tag,title,source_url,latitude,longitude,def_latitude,def_longitude,location,parent_id,encrypt,recycle,token,ctime,check_conflict,perm_from,smart_id"),Ext.isObject(t.attachment)){if(o)return void this.setNotePollingWithFiles(t,e);e.attachment=[],Ext.iterate(t.attachment,function(t,o){"delete"===o.action&&e.attachment.push({action:"delete",file_id:t})}),0===e.attachment.length&&delete e.attachment}this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note.Polling",version:3,method:"set",params:e,async:e.async,callback:function(e,o){if(!0!==e||Ext.isArray(t.object_id))return void t.callback.call(t.scope||window,e,o);this.pollingSetStatus(o.task_id,t)},scope:this})},pollingSetStatus:function(t,e){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note.Polling",version:3,method:"set_status",params:{task_id:t},callback:function(o,i){if(!0!==o)return void e.callback.call(e.scope||window,o,i);i.finish?this.pollingSetDone(t,e,i.data||i.error):Ext.defer(function(){this.pollingSetStatus(t,e)},1e3,this)},scope:this})},pollingSetDone:function(t,e,o){var i=function(t,o,i){if(!0!==t)return void e.callback.call(e.scope||window,t,o);e.callback.call(e.scope||window,t,o)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note.Polling",version:3,method:"set_stop",params:{task_id:t},callback:function(t,n){if(!0!==t)return void e.callback.call(e.scope||window,t,n);this.getNote(Ext.copyTo({ver:o.data[0].ver,callback:function(t,e){i.call(this,t,e,o.data[0])},scope:this},e,"object_id,perm_from,smart_id"))},scope:this})},deleteNoteAsync:function(t){return this.sendWebAPIPromise({api:"SYNO.NoteStation.Note",version:3,method:"delete",params:Ext.copyTo({},t,"object_id,recycle,perm_from,smart_id")})},restoreNote:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note",version:3,method:"restore",params:Ext.copyTo({},t,"object_id,perm_from,smart_id"),callback:t.callback,scope:t.scope||window})},copyNote:function(t){synowebapi.request({api:"SYNO.NoteStation.Note",version:3,method:"copy",params:Ext.copyTo({commit_msg:{device:"desktop"}},t,"object_id,ver,content,brief,tag,title,source_url,latitude,longitude,location,parent_id,encrypt,commit_msg,recycle,title_postfix,old_password,new_password,perm_from,smart_id"),encryption:["old_password","new_password"],callback:t.callback,scope:t.scope||window})},copyNotePolling:function(t){synowebapi.request({api:"SYNO.NoteStation.Note.Polling",version:3,method:"copy",params:Ext.copyTo({commit_msg:{device:"desktop"}},t,"object_id,ver,content,brief,tag,title,source_url,latitude,longitude,location,parent_id,encrypt,commit_msg,recycle,title_postfix,old_password,new_password,perm_from,smart_id"),encryption:["old_password","new_password"],callback:function(e,o){this.pollingCopyStatus(o.task_id,t)},scope:this})},pollingCopyStatus:function(t,e){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note.Polling",version:3,method:"copy_status",params:{task_id:t},callback:function(o,i){if(!0!==o)return void e.callback.call(e.scope||window,o,i);i.finish?this.pollingCopyDone(t,e,i.data):Ext.defer(function(){this.pollingCopyStatus(t,e)},1e3,this)},scope:this})},pollingCopyDone:function(t,e,o){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note.Polling",version:3,method:"copy_stop",params:{task_id:t},callback:function(t,i){e.callback.call(e.scope||window,t,o)},scope:this})},listTag:function(t){var e=function(e,o){var i={};!0===e?i.tag=o:i=o,t.callback.call(t.scope||window,e,i)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Tag",version:1,method:"list",params:Ext.copyTo({},t,"filter,field,offset,limit,sort_by,sort_direction"),callback:e,scope:this})},batchSetTag:function(t){var e=[];Ext.each(t.tag,function(t){e.push({api:"SYNO.NoteStation.Tag",version:1,method:"set",params:Ext.copyTo({},t,"tag_id,title")})},this),this.appWindow.sendWebAPI({compound:{stopwhenerror:!1,mode:"parallel",params:e},callback:t.callback,scope:t.scope||window})},setTag:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Tag",version:1,method:"set",params:Ext.copyTo({},t,"tag_id,title"),callback:t.callback,scope:t.scope||window})},deleteTag:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Tag",version:1,method:"delete",params:Ext.copyTo({},t,"tag_id"),callback:t.callback,scope:t.scope||window})},listShortcut:function(t){var e=function(e,o){var i={};!0===e?i.shortcut=o:i=o,t.callback.call(t.scope||window,e,i)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Shortcut",version:1,method:"list",params:Ext.copyTo({},t,"filter,field,offset,limit,sort_by,sort_direction"),callback:e,scope:this})},setShortcut:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Shortcut",version:1,method:"set",params:Ext.copyTo({},t,"tag_id,object_id,stack_id"),callback:t.callback,scope:t.scope||window})},deleteShortcut:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Shortcut",version:1,method:"delete",params:Ext.copyTo({},t,"tag_id,object_id,stack_id"),callback:t.callback,scope:t.scope||window})},listAllAsync:function(){return this.sendWebAPIPromise({compound:{stopwhenerror:!1,params:[{api:"SYNO.NoteStation.Notebook",version:2,method:"list"},{api:"SYNO.NoteStation.Note",version:3,method:"list",params:{filter:{fast_result:!0},field:{commit_msg:!0}}},{api:"SYNO.NoteStation.Tag",version:1,method:"list"},{api:"SYNO.NoteStation.Shortcut",version:1,method:"list"},{api:"SYNO.NoteStation.Todo",version:1,method:"list"},{api:"SYNO.NoteStation.Smart",version:1,method:"list"}]}}).then(function(t){var e=t.succ,o=t.resp;if(!e)return{succ:e,resp:o};var i={notebook:null,note:null,tag:null,shortcut:null,smart:null};return o.result.forEach(function(t){switch(t.api){case"SYNO.NoteStation.Notebook":!0===t.success&&(i.notebook=t.data);break;case"SYNO.NoteStation.Note":!0===t.success&&(i.note=t.data);break;case"SYNO.NoteStation.Tag":!0===t.success&&(i.tag=t.data);break;case"SYNO.NoteStation.Shortcut":!0===t.success&&(i.shortcut=t.data);break;case"SYNO.NoteStation.Todo":!0===t.success&&(i.todo=t.data);break;case"SYNO.NoteStation.Smart":!0===t.success&&(i.smart=t.data)}}),{succ:e,resp:i}})},listTagAndShortcut:function(t){var e={tag:null,shortcut:null},o=function(o,i){i.result.forEach(function(t){switch(t.api){case"SYNO.NoteStation.Tag":!0===t.success&&(e.tag=t.data);break;case"SYNO.NoteStation.Shortcut":!0===t.success&&(e.shortcut=t.data)}}),t.callback.call(t.scope||window,!0,e)};this.appWindow.sendWebAPI({compound:{stopwhenerror:!1,params:[{api:"SYNO.NoteStation.Tag",version:1,method:"list"},{api:"SYNO.NoteStation.Shortcut",version:1,method:"list"}]},callback:o,scope:this})},getShardLink:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Shard.Link",version:1,method:"get",params:Ext.copyTo({},t,"object_id,mode"),callback:t.callback,scope:t.scope||window})},setPermission:function(t){var e,o,i=[];if(o=function(e,o){var n={dsm_user:{},dsm_group:{}};if(!0!==e)return void t.callback.apply(t.scope||window,arguments);o.result.forEach(function(t,e){switch(t.api){case"SYNO.NoteStation.Permission.Public":n.public=Ext.copyTo({},t,"success,data,error");break;case"SYNO.NoteStation.Permission.User":n.dsm_user[i[e].params.username]=Ext.copyTo({},t,"success,data,error");break;case"SYNO.NoteStation.Permission.Group":n.dsm_group[i[e].params.groupname]=Ext.copyTo({},t,"success,data,error")}},this),t.callback.call(t.scope||window,!o.has_fail,n)},"public"in t&&(e={api:"SYNO.NoteStation.Permission.Public",version:1,method:t.public.op,params:Ext.copyTo({object_id:t.object_id},t.public,"perm")},i.push(e)),"dsm_user"in t&&Ext.iterate(t.dsm_user,function(e,o){i.push({api:"SYNO.NoteStation.Permission.User",version:1,method:o.op,params:Ext.copyTo({object_id:t.object_id,username:e},o,"perm, uid")})},this),"dsm_group"in t&&Ext.iterate(t.dsm_group,function(e,o){i.push({api:"SYNO.NoteStation.Permission.Group",version:1,method:o.op,params:Ext.copyTo({object_id:t.object_id,groupname:e},o,"perm, gid")})},this),Ext.isEmpty(i))return void t.callback.call(t.scope||window,!0);i=[{api:"SYNO.NoteStation.Permission",version:1,method:"set",params:{object_id:t.object_id,enabled:!0}}].concat(i),this.appWindow.sendWebAPI({compound:{params:i,stopwhenerror:!1},callback:o,scope:this})},deletePermission:function(t){var e=[];Ext.isString(t.object_id)?this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Permission.User",version:1,method:"delete",params:Ext.copyTo({},t,"object_id, username"),callback:t.callback,scope:t.scope||window}):Ext.isArray(t.object_id)&&(t.object_id.forEach(function(o){e.push({api:"SYNO.NoteStation.Permission.User",version:1,method:"delete",params:{object_id:o,username:t.username}})}),this.appWindow.sendWebAPI({compound:{params:e,stopwhenerror:!1},callback:function(e,o){!1===e?t.callback.call(t.scope,!1,SYNO.API.Response.GetFirstError(o)):t.callback.call(t.scope,!0)},scope:this}))},restoreNoteVersion:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Note.Version",version:2,method:"restore",params:Ext.copyTo({},t,"object_id,ver,perm_from,smart_id"),callback:t.callback,scope:t.scope||window})},setAsPreset:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Notebook.Preset",version:1,method:"set",params:Ext.copyTo({commit_msg:Ext.apply({device:"desktop"},t.commit_msg)},t,"object_id"),callback:t.callback,scope:t.scope||window})},setStack:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Stack",version:1,method:"set",params:Ext.copyTo({},t,"stack_id,name"),callback:t.callback,scope:t.scope||window})},deleteStack:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Stack",version:1,method:"delete",params:Ext.copyTo({},t,"stack_id"),callback:t.callback,scope:t.scope||window})},exportNotebook:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Export.Notebook",version:1,method:"start",params:Ext.copyTo({},t,"object_id,save_config,dest,export_todo"),callback:function(e,o){t.callback.call(t.scope||window,e,o)},scope:this})},importNotebook:function(t){var e,o=[],i=!1,n={api:"SYNO.NoteStation.Import.Notebook",version:1,method:"start",isUpload:!0,params:{}};SYNO.SDS.HTML5Utils.isSupportHTML5Upload()?(e=new window.FormData,Ext.iterate(t.file,function(t,n){"raw"===t.format?(e.append(t.name,t.source),o.push({format:"raw",name:t.name}),i=!0):o.push(t)}),i?(e.append("file",Ext.encode(o)),n.html5upload=!0,n.uploadData=e):n.params.file=o):Ext.isEmpty(t.form)||(n.form=t.form,n.params.file=t.file),n.callback=function(e,o){t.callback.call(t.scope||window,e,o)},n.scope=this,this.appWindow.sendWebAPI(n)},importEnex:function(t){var e,o=[],i=!1,n={api:"SYNO.NoteStation.Import.Enex",version:1,method:"start",isUpload:!0,params:{}};SYNO.SDS.HTML5Utils.isSupportHTML5Upload()?(e=new window.FormData,Ext.iterate(t.file,function(t,n){"raw"===t.format?(e.append(t.name,t.source),o.push({format:"raw",name:t.name}),i=!0):o.push(t)}),i?(e.append("file",Ext.encode(o)),n.html5upload=!0,n.uploadData=e):n.params.file=o):Ext.isEmpty(t.form)||(n.form=t.form,n.params.file=t.file),n.callback=function(e,o){t.callback.call(t.scope||window,e,o)},n.scope=this,this.appWindow.sendWebAPI(n)},exportNote:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Export.Note",version:1,method:"start",params:Ext.copyTo({},t,"object_id,timezone_offset,token"),callback:function(e,o){if(!e)return void t.callback.call(t.scope||window,e,o);this.pollingExportNoteStatus(o.task_id,t)},scope:this})},pollingExportNoteStatus:function(t,e){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Export.Note",version:1,method:"status",params:{task_id:t},callback:function(o,i){if(!0!==o)return void e.callback.call(e.scope||window,o,i);i.finish?this.pollingExportNoteDone(t,e,i):Ext.defer(function(){this.pollingExportNoteStatus(t,e)},1200,this)},scope:this})},pollingExportNoteDone:function(t,e,o){this.appWindow.downloadWebAPI({webapi:{api:"SYNO.NoteStation.Export.Note",version:1,method:"download",params:{task_id:t,remove:!0}},filename:o.filename}),e.callback.defer(1200,e.scope,[!0])},exportWord:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Export.Word",version:1,method:"start",params:Ext.copyTo({},t,"object_id,token"),callback:function(e,o){if(!e)return void t.callback.call(t.scope||window,e,o);this.pollingExportWordStatus(o.task_id,t)},scope:this})},pollingExportWordStatus:function(t,e){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Export.Word",version:1,method:"status",params:{task_id:t},callback:function(o,i){if(!0!==o)return void e.callback.call(e.scope||window,o,i);i.finish?this.pollingExportWordDone(t,e,i):Ext.defer(function(){this.pollingExportWordStatus(t,e)},1200,this)},scope:this})},pollingExportWordDone:function(t,e,o){this.appWindow.downloadWebAPI({webapi:{api:"SYNO.NoteStation.Export.Word",version:1,method:"download",params:{task_id:t,remove:!0}},filename:o.filename}),e.callback.defer(1200,e.scope,[!0])},archiveNotebook:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Notebook.Polling",version:1,method:"archive",params:Ext.copyTo({},t,"object_id,enable"),callback:function(e,o){if(!e)return void t.callback.call(t.scope||window,e,o);this.pollingArchiveNotebookStatus(o.task_id,t)},scope:this})},pollingArchiveNotebookStatus:function(t,e){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Notebook.Polling",version:1,method:"archive_status",params:{task_id:t},callback:function(o,i){if(!0!==o)return void e.callback.call(e.scope||window,o,i);i.errors&&SYNO.SDS.NoteStation.Utils.showErrorMsg(this.appWindow,i.errors),i.finish?this.pollingArchiveNotebookDone(t,e,i):Ext.defer(function(){this.pollingArchiveNotebookStatus(t,e)},1200,this)},scope:this})},pollingArchiveNotebookDone:function(t,e,o){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Notebook.Polling",version:1,method:"archive_stop",params:{task_id:t},callback:e.callback,scope:e.scope})},getTodo:function(t){var e=function(e,o){t.callback.call(t.scope||window,e,o)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Todo",version:2,method:"get",params:Ext.copyTo({},t,"object_id"),callback:e,scope:this})},listTodo:function(t){var e=function(e,o){t.callback.call(t.scope||window,e,o)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Todo",version:2,method:"list",params:Ext.copyTo({field:{items:!0}},t,"filter,offset,limit,sort_by,sort_direction,raw_sort"),callback:e,scope:this})},createTodo:function(t){var e=function(e,o){t.callback.call(t.scope||window,e,o)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Todo",version:2,method:"create",params:Ext.copyTo({},t,"title,due_date,done,priority,reminder_offset,note_id,parent_id"),callback:e,scope:this})},setTodo:function(t){var e=function(e,o){t.callback.call(t.scope||window,e,o)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Todo",version:2,method:"set",params:Ext.copyTo({},t,"object_id,title,due_date,done,priority,reminder_offset,note_id,star,comment"),callback:e,scope:this})},deleteTodo:function(t){var e=function(e,o){t.callback.call(t.scope||window,e,o)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Todo",version:1,method:"delete",params:Ext.copyTo({},t,"object_id"),callback:e,scope:this})},listSmart:function(t){var e=function(e,o){var i={};!0===e?i.smart=o:i=o,t.callback.call(t.scope||window,e,i)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Smart",version:1,method:"list",params:Ext.copyTo({},t,"filter,field,offset,limit,sort_by,sort_direction"),callback:e,scope:this})},createSmart:function(t){var e=function(e,o){var i;i=!0===e?{object_id:o.object_id,title:t.title,shared:!1,ctime:o.ctime,mtime:o.mtime,owner:{display_name:this.appWindow._S("user")},owned:!0}:o,t.callback.call(t.scope||window,e,i)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Smart",version:1,method:"create",params:{title:t.title,query:t.query,commit_msg:Ext.apply({device:"desktop"},t.commit_msg)},callback:e,scope:this})},getSmart:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Smart",version:1,method:"get",params:Ext.copyTo({},t,"object_id"),callback:t.callback,scope:t.scope||window})},setSmart:function(t){var e=function(e,o){var i,n;!0===e?(n=o.data[0],i={object_id:n.object_id,title:t.title,shared:!1,ctime:n.ctime,mtime:n.mtime,owner:{display_name:this.appWindow._S("user"),uid:this.appWindow.uid_map[this.appWindow._S("user")]}}):i=o,t.callback.call(t.scope||window,e,i)};this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Smart",version:1,method:"set",params:Ext.copyTo({commit_msg:Ext.apply({device:"desktop"},t.commit_msg)},t,"object_id,title,query"),callback:e,scope:this})},deleteSmart:function(t){this.appWindow.sendWebAPI({api:"SYNO.NoteStation.Smart",version:1,method:"delete",params:Ext.copyTo({},t,"object_id"),callback:t.callback,scope:t.scope||window})},setSetting:function(t){this.appWindow.sendWebAPI({compound:{stopwhenerror:!0,params:[{api:"SYNO.NoteStation.Setting",version:2,method:"set",params:Ext.copyTo({},t,"pointer_color,slide_theme,inline_thumb,font_size,todo_show_badge,copy_delete_orig,todo_purge,todo_priority,todo_due_date_day,todo_reminder_predefined,todo_reminder_value,todo_reminder_unit,todo_reminder_offse")},{api:"SYNO.NoteStation.Setting",version:2,method:"get"}]},callback:function(e,o){return e?o.result[0].success?o.result[1].success?void t.callback.call(t.scope||window,!0,o.result[1].data):void t.callback.call(t.scope||window,!1,o.result[1].error):void t.callback.call(t.scope||window,!1,o.result[0].error):void t.callback.call(t.scope||window,!1,o)},scope:this})}}),Ext.ns("SYNO.SDS.NoteStation.Storage"),Ext.define("SYNO.SDS.NoteStation.Storage.Database",{extend:"Ext.util.Observable",name:"note_station_storage",ERR_OPEN_DATABASE:0,constructor:function(){this.db=void 0},open:function(t){if(!Ext.isObject(t)||!Ext.isFunction(t.callback))return!1;this.request=window.indexedDB.open(this.name,1),this.request.onerror=function(e){t.callback.call(t.scope||this,!1,{code:this.ERR_OPEN_DATABASE,data:e.target.result})},this.request.onsuccess=function(e){this.db=this.request.result,t.callback.call(t.scope||this,!0,this.db)},this.request.onupgradeneeded=function(t){}}}),Ext.ns("SYNO.SDS.NoteStation.Storage"),Ext.define("SYNO.SDS.NoteStation.Storage.Interface",{extend:"Ext.util.Observable",constructor:function(t){var e=Ext.apply({backend:null},t);this.callParent([e])},checkObject:function(t){return!(!Ext.isObject(t)||!Ext.isFunction(t.callback))},initial:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.appWindow))&&(this.backend?(t.callback.call(t.scope||this,"ready"),!0):(this.backend=new SYNO.SDS.NoteStation.Storage.WebAPI({appWindow:t.appWindow,instance:this}),!0!==SYNO.SDS.NoteStation.Utils.isPublicShare?this.backend.initial(t):t.callback.call(t.scope,!1),!0))},isReady:function(){return!0===this.storageready},destroy:function(){this.backend&&(this.backend.destroy(),delete this.backend),Ext.isFunction(this.onLineFunc)&&(window.removeEventListener("online",this.onLineFunc),window.removeEventListener("offline",this.onLineFunc))},mointorOnline:function(){var t=this;this.onLineFunc=function(){var e=SYNO.SDS.NoteStation.Utils.IsOnLine()?"online":"offline";t.fireEvent("network",e)},window.addEventListener("online",this.onLineFunc),window.addEventListener("offline",this.onlineFunc)},listNotebook:function(t){return!!this.checkObject(t)&&(this.backend.listNotebook(t),!0)},createNotebook:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.title))&&(this.backend.createNotebook(t),!0)},setNotebook:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id)||Ext.isEmpty(t.title)&&!Ext.isString(t.stack))&&(this.backend.setNotebook(t),!0)},deleteNotebook:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.deleteNotebook(t),!0)},getNotebook:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.getNotebook(t),!0)},listNote:function(t){return!!this.checkObject(t)&&(this.backend.listNote(t),!0)},createNoteAsync:function(t){return!Ext.isObject(t)||Ext.isEmpty(t.parent_id)?Promise.resolve({succ:!1,resp:{}}):this.backend.createNoteAsync(t)},deleteNoteAsync:function(t){return!Ext.isObject(t)||Ext.isEmpty(t.object_id)?Promise.resolve({succ:!1,resp:{}}):this.backend.deleteNoteAsync(t)},restoreNote:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.restoreNote(t),!0)},getNote:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.getNote(t),!0)},setNote:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.setNote(t),!0)},setNotePolling:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.setNotePolling(t),!0)},copyNote:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.copyNote(t),!0)},listTag:function(t){return!!this.checkObject(t)&&(this.backend.listTag(t),!0)},batchSetTag:function(t){return!(!this.checkObject(t)||!Ext.isArray(t.tag))&&(this.backend.batchSetTag(t),!0)},setTag:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.tag_id)||Ext.isEmpty(t.title))&&(this.backend.setTag(t),!0)},deleteTag:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.tag_id))&&(this.backend.deleteTag(t),!0)},listShortcut:function(t){return!!this.checkObject(t)&&(this.backend.listShortcut(t),!0)},setShortcut:function(t){return!!this.checkObject(t)&&(this.backend.setShortcut(t),!0)},deleteShortcut:function(t){return!!this.checkObject(t)&&(this.backend.deleteShortcut(t),!0)},listAllAsync:function(){return this.backend.listAllAsync()},listTagAndShortcut:function(t){return!!this.checkObject(t)&&(this.backend.listTagAndShortcut(t),!0)},setPermission:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.setPermission(t),!0)},deletePermission:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id)||Ext.isEmpty(t.username))&&(this.backend.deletePermission(t),!0)},restoreNoteVersion:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id)||Ext.isEmpty(t.ver))&&(this.backend.restoreNoteVersion(t),!0)},getShardLink:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id)||Ext.isEmpty(t.mode))&&(this.backend.getShardLink(t),!0)},setAsPreset:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.setAsPreset(t),!0)},setStack:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.stack_id)||!Ext.isString(t.name))&&(this.backend.setStack(t),!0)},deleteStack:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.stack_id))&&(this.backend.deleteStack(t),!0)},exportNotebook:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.dest))&&(this.backend.exportNotebook(t),!0)},importNotebook:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.file))&&(this.backend.importNotebook(t),!0)},importEnex:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.file))&&(this.backend.importEnex(t),!0)},exportNote:function(t){if(!this.checkObject(t)||Ext.isEmpty(t.object_id))return!1;this.backend.exportNote(t)},exportWord:function(t){if(!this.checkObject(t)||Ext.isEmpty(t.object_id))return!1;this.backend.exportWord(t)},getTodo:function(t){return!!this.checkObject(t)&&(this.backend.getTodo(t),!0)},listTodo:function(t){return!!this.checkObject(t)&&(this.backend.listTodo(t),!0)},createTodo:function(t){return!!this.checkObject(t)&&(this.backend.createTodo(t),!0)},setTodo:function(t){return!!this.checkObject(t)&&(this.backend.setTodo(t),!0)},deleteTodo:function(t){return!!this.checkObject(t)&&(this.backend.deleteTodo(t),!0)},archiveNotebook:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id)||!Ext.isBoolean(t.enable))&&(this.backend.archiveNotebook(t),!0)},listSmart:function(t){return!!this.checkObject(t)&&(this.backend.listSmart(t),!0)},createSmart:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.title)||Ext.isEmpty(t.query))&&(this.backend.createSmart(t),!0)},getSmart:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.getSmart(t),!0)},setSmart:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.setSmart(t),!0)},deleteSmart:function(t){return!(!this.checkObject(t)||Ext.isEmpty(t.object_id))&&(this.backend.deleteSmart(t),!0)},setSetting:function(t){return!!this.checkObject(t)&&(this.backend.setSetting(t),!0)}}),Ext.ns("SYNO.SDS.NoteStation.Note.DataView"),Ext.define("SYNO.SDS.NoteStation.Note.DataView.Scroll",{extend:"SYNO.ux.FleXcroll.DataView",
isLoadingData:!1,canLoadMore:!0,query_limit:50,trackResetOnLoad:!1,constructor:function(){this.query_info={offset:0,limit:this.query_limit},this.addEvents("dataloaded"),this.delayedCheckLoadMore=new Ext.util.DelayedTask(this.checkLoadMore,this),this.on("dataloaded",this.onDataLoaded,this),this.forceScrollTop=!1,this.callParent(arguments)},onDataLoaded:function(){var t=this.findAppWindow(),e=Math.floor(t.owned.all.length/4);if(!Ext.isNumber(e)||e<this.query_limit?this.query_info.limit=this.query_limit:this.query_info.limit=e,this.handleNotebookAction(),Ext.isEmpty(this.forceSelectedObjectId)){if(!1!==this.forceScrollTop){var o=this._getScrollLimit()||0;this.canLoadMore&&this.forceScrollTop>o?this.loadData():(this.setScroll(Math.min(o,this.forceScrollTop)),this.forceScrollTop=!1)}}else this.forceScrollTop=!1,this.all.elements.forEach(function(t){if(t.getAttribute("object_id")===this.forceSelectedObjectId)return this.select(t,!1,!0),this.scrollToNode(t),this.forceSelectedObjectId=void 0,!1},this),Ext.isEmpty(this.forceSelectedObjectId)||this.getSelectionCount()>0||(!0===this.canLoadMore?this.loadData():this.forceSelectedObjectId=void 0)},onRender:function(){this.on("afterrender",function(){this.on("fleXcroll",function(){this.delayedCheckLoadMore.delay(250)},this)},this),this.callParent(arguments)},checkLoadMore:function(){var t;this.isDestroyed||(this.owner.doLayout(),!1!==this.canLoadMore&&!0!==this.isLoadingData&&(t=this.el.dom.fleXdata)&&!1!==t.scrollPosition[1][1]&&2*this.getHeight()>t.scrollPosition[1][1]-t.scrollPosition[1][0]&&this.loadData())},createStore:function(){return new Ext.data.JsonStore({owner:this.owner,idProperty:"object_id",defaultParamNames:{start:"offset",limit:"limit",sort:"sort_by",dir:"sort_direction"},autoLoad:!1,root:"notes",fields:["object_id","owner","acl","title","category","brief","ctime","mtime","thumb","parent_id","attachment","encrypt","link_id","recycle","archive"],listeners:{beforeload:function(){this.owner.setStatusBusy()},load:function(){this.owner.clearStatusBusy()},exception:function(){this.owner.clearStatusBusy()},scope:this}})},showDate:function(t){var e,o;return!0===t.forceHeader?t.forceDate:"title"!==this.query_info.sort_by&&(o="mtime"===this.query_info.sort_by?t.mtime:(this.query_info.sort_by,t.ctime),e=new Date(1e3*o).format("F Y"),this.date_index!=e&&(this.date_index=e,!0))},getTimeInfo:function(t,e){var o,i;return i="mtime"===this.query_info.sort_by?t.mtime:(this.query_info.sort_by,t.ctime),o=new Date(1e3*i),"yearmonth"===e?o.format("F Y"):"time"===e?o.format("H : i"):"day"===e?o.format("d"):SYNO.SDS.NoteStation.Utils.dateTimeFormatter(o,{type:e})},getType:function(t){return t.owner.display_name!==this._S("user")?"joined":!0===t.archive?"archive":"common"},showCtxMenu:function(t,e,o,i){i.preventDefault();var n,s,a,r,l,d,c=[],h=[],u=[];1>o.childElementCount||(-1===t.getSelectedIndexes().indexOf(e)&&t.select(o),s=t.getSelectionCount()>1,r=this.getSelectedNodes(),n=o.lastElementChild,!0===this.owner.query_params.recycle&&(n.parent_info={category:SYNO.SDS.NoteStation.Define.NOTEBOOK,type:SYNO.SDS.NoteStation.Define.DELETED}),Ext.each(r,function(t){d=this.getStore().getById(t.getAttribute("object_id")),u.push(d),!Ext.isObject(d)||Ext.isEmpty(d.data)},this),Ext.each(u,function(t){l=t.data,h.push(l)}),Ext.each(r,function(t,e){c.push(h[e].object_id)},this),a=Ext.copyTo({isMultiSelected:s,object_id_array:c,isEncryptedNote:!s&&l.encrypt},this.query_info,"perm_from,smart_id"),this.ctxMenu.getMenu(n,a,this.onClickCtxMenu,this),this.ctxMenu.isShowMenu&&this.ctxMenu.showAt(i.getXY()))},removeRecord:function(t,e){var o,i,n=this.getStore(),s=n.indexOfId(t.id),a=!Ext.isEmpty(e.querySelector(".syno-ns-note-group-header")),r=this.findAppWindow(),l=r.getMainPanel().getEditorPanel(),d=l.layout.activeItem;"editor_password"===d.itemId?l.layout.setActiveItem("editor_empty"):"editor_empty"!==d.itemId&&Ext.isObject(d.noteData)&&t.id===d.noteData.object_id&&(d.clearNote(),l.layout.setActiveItem("editor_empty")),n.remove(t),!1===a||0===n.getCount()||s>n.getCount()||(o=this.getNode(s),Ext.isEmpty(o)||Ext.isEmpty(o.querySelector(".syno-ns-note-group-header"))&&(i=Ext.apply({},n.getAt(s).data),i.forceHeader=!0,i.forceDate=!0,this.tpl.overwrite(o,i)))},getSelectedInfo:function(){var t,e,o=this.findAppWindow(),i=this.getSelectedNodes(),n=this.getSelectionCount(),s=[],a=[],r=!1,l="";return Ext.each(i,function(t){e=this.getStore().getById(t.getAttribute("object_id")),Ext.isObject(e)&&!Ext.isEmpty(e.data)&&a.push(e)},this),Ext.iterate(a,function(e,o){0===o&&(l=e.data.object_id),t=e.data,s.push(t)}),l in o.owned.note&&!0===o.owned.note[l].archive&&(r=!0),{selectedArray:i,total:n,dataArray:s,recordArray:a,isArchive:r}},onClickCtxMenu:function(t,e){var o=this.findAppWindow(),i=o.getMainPanel(),n=i.getEditorPanel().normalPanel,s=i.getEditorPanel().readOnlyPanel,a=[],r={},l=this.getSelectedInfo(),d=l.selectedArray,c=l.dataArray,h=l.recordArray,u=c[c.length-1];if(!Ext.isEmpty(d))switch(Ext.copyTo(r,this.owner.query_params,"perm_from,smart_id"),r.recycle=u.recycle,t.itemAction){case"delete":this.handleDeleteNote(l,!1);break;case"add_to_shortcut":this.handleAddShortcut(l);break;case"edit":o.selectNote(u.object_id,"edit",r);break;case"print":o.selectNote(u.object_id,"print",r);break;case"open_note_in_new_tab":u.object_id in o.owned.note?SYNO.SDS.NoteStation.Utils.openNoteInNewTab(n,u.object_id,u.link_id):SYNO.SDS.NoteStation.Utils.openNoteInNewTab(s,u.object_id,u.link_id);break;case"restore":Ext.each(d,function(t,e){a.push(c[e].object_id),this.removeRecord(h[e],d[0])},this),i.restoreNote(a);break;case"remove":this.handleDeleteNote(l,!0);break;case"copy":if(Ext.each(d,function(t,e){a.push(c[e].object_id)},this),"joined"===this.getType(u)){new SYNO.SDS.NoteStation.CopyTo.Window({owner:o,param:{object_id:a,title_postfix:" - "+SYNO.SDS.NoteStation._T("common","duplicate")}}).show()}else i.copyNote({object_id:a,title_postfix:" - "+SYNO.SDS.NoteStation._T("common","duplicate"),choosed:o.choosed});break;case"leave":Ext.each(d,function(t,e){a.push(c[e].object_id),this.removeRecord(h[e],d[0])},this),i.deletePermission(a);break;case"move":i.moveNotesToNotebook(c.map(function(t){return t.object_id}),t.object_id);break;case"info":o.selectNote(u.object_id,"info",r);break;case"share":o.selectNote(u.object_id,"share",r);break;case"encrypt":o.selectNote(u.object_id,"encrypt",r);break;case"mail":o.selectNote(u.object_id,"mail",r);break;case"export":o.selectNote(u.object_id,"export",r);break;case"export_word":o.selectNote(u.object_id,"export_word",r)}},handleDeleteNote:function(t,e){t||(t=this.getSelectedInfo());var o,i,n=this.findAppWindow(),s=t.selectedArray,a=t.total,r=t.dataArray,l=t.recordArray,d=t.isArchive,c=[];Ext.isEmpty(s)||(o=n.getMsgBox(),i=e?String.format(SYNO.SDS.NoteStation._T("note","delete_title"),a):!0===d?String.format(SYNO.SDS.NoteStation._T("note","archive_delete"),a):String.format(SYNO.SDS.NoteStation._T("note","delete_to_recycle"),a),o.confirmDelete(SYNO.SDS.NoteStation._T("note","delete"),i,function(t,o){"yes"===t&&(this.forceScrollTop=this._getScrollTop(),this.clearSelections(),Ext.each(s,function(t,e){c.push(r[e].object_id),this.removeRecord(l[e],s[0])},this),n.getMainPanel().deleteNoteAsync(c,{recycle:!e&&!d}))},this))},handleAddShortcut:function(t,e){t||(t=this.getSelectedInfo());var o=this.findAppWindow(),i=t.selectedArray,n=t.dataArray,s=[];Ext.each(i,function(t,e){s.push(n[e].object_id)});var a=s.filter(function(t){return!(t in o.shortcut)});a.length>0?o.getMainPanel().addToShortcut({object_id:a}):e&&o.getMainPanel().removeFromShortcut({object_id:s})},handleMoveNotes:function(t){t||(t=this.getSelectedInfo());var e=this.findAppWindow(),o=t.selectedArray,i=t.dataArray,n=[];if(!Ext.isEmpty(o)){Ext.each(o,function(t,e){n.push(i[e].object_id)});new SYNO.SDS.NoteStation.Move.Window({owner:e,object_id:n}).show()}},getFilterParams:function(){return Ext.copyTo({},this.owner.query_params,"parent_id,tag,tag_operator,recycle,owner,individual_shared,individual_joined,stack,archive")},getFieldParams:function(){return Ext.copyTo({},this.owner.field_params,"link_id,commit_msg")},scrollToNode:function(t){var e,o=Ext.get(this.getScrollTarget()),i=Ext.get(t);Ext.isEmpty(o)||Ext.isEmpty(i)||((e=i.getOffsetsTo(o)[1])<0||e+i.getHeight()>o.getHeight())&&this.fleXcrollTo(t)},loadData:function(t,e,o,i){var n=this.findAppWindow().getStorage();this.isLoadingData=!0,!1===t&&(this.date_index=void 0,this.canLoadMore=!0,this.query_info=Ext.copyTo({offset:0,limit:this.query_limit},this.owner.query_params,"perm_from,smart_id"),!0===SYNO.SDS.NoteStation.Utils.isPublicShare&&(this.query_info.mode="public")),Ext.isString(e)&&(this.query_info.sort_by=e),Ext.isString(o)&&(this.query_info.sort_direction=o),Ext.isString(i)&&(this.action=i),this.last_query_limit=this.query_info.limit,n.listNote(Ext.apply({filter:this.getFilterParams(),field:this.getFieldParams(),callback:this.onLoadData,scope:this},this.query_info))},onLoadData:function(t,e){if(this.query_info.offset+=this.last_query_limit,this.isDestroyed||!t||!Ext.isObject(e.note)||!Ext.isArray(e.note.notes)||0===e.note.total)return Ext.isObject(e.note)&&0===e.note.offset&&0===e.note.total&&(this.getStore().removeAll(),this.onResizeEvent()),this.canLoadMore=!1,void this.fireEvent("dataloaded",this);this.query_info.limit>e.note.notes.length&&(this.canLoadMore=!1),this.getStore().loadData(e.note,0!==e.note.offset),this.updateFleXcroll(),this.isLoadingData=!1,this.fireEvent("dataloaded",this)},onSelectionChange:function(t,e,o){var i;e.length<1||(document.activeElement!==t.el.dom&&t.el.focus(),i=e[0],SYNO.SDS.NoteStation.Utils.isMobileDevice?this.onSelectNoteMobile(t,t.indexOf(i),i,o):this.onSelectNote(t,t.indexOf(i),i,o))},onSelectNote:function(t,e,o,i){var n,s,a;t.getSelectionCount()>1||(n=o.getAttribute("object_id"),Ext.isEmpty(n)||(s=this.getStore().getAt(e),Ext.isEmpty(s)||(a=Ext.copyTo({recycle:s.get("recycle")},this.query_info,"perm_from,smart_id"),this.findAppWindow().selectNote(n,"single",a))))},onSelectNoteMobile:function(t,e,o,i){var n=SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.Mobile.Panel"),s=SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.MainPanel"),a=s.getTopToolbar(),r=["share_btn","search_btn"];a.getComponent("cancel_btn").isVisible()&&s.onClickCancel(),(SYNO.SDS.NoteStation.Utils.isShowNotebook||SYNO.SDS.NoteStation.Utils.isShowSmart)&&a.getComponent("prev_btn").show(),Ext.each(r,function(t){a.getComponent(t).hide()},this),n.layout.setActiveItem("editor"),this.onSelectNote(t,e,o,i)},handleNotebookAction:function(){var t,e={};if(Ext.isString(this.action))return Ext.copyTo(e,this.owner.query_params,"perm_from,smart_id"),"selectfirst"===this.action?(this.action=null,t=this.getStore().getAt(0),void(Ext.isObject(t)?(e.recycle=t.get("recycle"),this.select(t,!1,!0),this.findAppWindow().selectNote(t.id,"single",e)):this.findAppWindow().selectNote("","single",e))):void 0},_getScrollTop:function(){var t=this.el.dom;return t.fleXdata?t.fleXdata.scrollPosition[1][0]:0},_getScrollLimit:function(){var t=this.el.dom;return t.fleXdata?t.fleXdata.scrollPosition[1][1]:0}}),Ext.ns("SYNO.SDS.NoteStation.Note.DragZone"),Ext.define("SYNO.SDS.NoteStation.Note.DragZone.Base",{extend:"Ext.dd.DragZone",constructor:function(t,e){this.component=t,this.callParent([t.getEl(),this.fillConfig(e)])},fillConfig:function(t){var e={targetCls:String.format("syno-ns-note-{0}-container",t.viewType),titleCls:String.format("syno-ns-note-{0}-title",t.viewType)};return Ext.apply(e,t)},getDragData:function(t){var e,o,i,n,s,a;return e=this.component.getSelectedNodes(),o=this.component.getSelectionCount(),a=this.component.owner.query_params,!(!Ext.isEmpty(a)&&!0===a.recycle)&&(i=t.getTarget("div."+this.targetCls),!Ext.isEmpty(i)&&(n=document.createElement("div"),n.className="syno-ns-note-dd-preview",o>1?(n.textContent=String.format(SYNO.SDS.NoteStation._T("dd","multi_items"),o),s=this.getDragNodeDataArray(e)):(n.textContent=i.getElementsByClassName(this.titleCls)[0].textContent,s=[this.getDragNodeData(i)]),{nodeDataArray:s,target:i,ddel:n}))},getRepairXY:function(t){return Ext.Element.fly(this.dragData.target).getXY()},getDragNodeDataArray:function(t){var e=[];return Ext.isArray(t)?(Ext.each(t,function(t){var o=t.getElementsByClassName(this.targetCls);Ext.isEmpty(o)||e.push(this.getDragNodeData(o[0]))},this),e):e},getDragNodeData:function(t){return{object_id:t.getAttribute("object_id"),category:t.getAttribute("category"),type:t.getAttribute("type")}}}),Ext.ns("SYNO.SDS.NoteStation.Note.DataView"),Ext.define("SYNO.SDS.NoteStation.Note.DataView.Card",{extend:"SYNO.SDS.NoteStation.Note.DataView.Scroll",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e=SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.MainPanel").getCrossPanelCtxMenu(),o=new Ext.XTemplate('<tpl for=".">','<div object_id="{object_id}" class="syno-ns-note-card-group-container">','<tpl if="this.showDate(values) == true">','<div class="syno-ns-note-group-header syno-ns-note-group-header-card {[xindex == 1? "syno-ns-note-group-header-card-first":""]}">','<div class="syno-ns-note-yearmonth"> {[this.getTimeInfo(values, "yearmonth")]} </div>',"</div>","</tpl>",'<div object_id="{object_id}" type="{[this.getType(values)]}" category="note" ','class="syno-ns-note-card-container {[this.getSmallThumbClass(values)]} ','{[xindex == 1? "syno-ns-note-card-container-first": ""]}">','<div class="syno-ns-note-card-text">','<div class="syno-ns-note-card-title"> {[Ext.util.Format.htmlEncode(values.title)]} </div>','<div class="syno-ns-note-card-date"> {[this.getTimeInfo(values, "datetime")]} </div>',"</div>","{[this.showContent(values)]}","</div>","</div>","</tpl>",{getBackgroundImage:this.getBackgroundImage.createDelegate(this),getTimeInfo:this.getTimeInfo.createDelegate(this),showDate:this.showDate.createDelegate(this),getType:this.getType.createDelegate(this),showContent:this.showContent.createDelegate(this),getSmallThumbClass:this.getSmallThumbClass.createDelegate(this)});this.emptyTextId="syno-ns-"+Ext.id();var i={ctxMenu:e,itemSelector:"div.syno-ns-note-card-group-container",overClass:"syno-ns-note-card-container-over",selectedClass:"syno-ns-note-card-container-select",multiSelect:!0,store:this.createStore(),tpl:o,listeners:{afterrender:{fn:function(t){this.dragZone=new SYNO.SDS.NoteStation.Note.DragZone.Base(t,{ddGroup:"ns-dd-group",viewType:"card"})},scope:this},contextmenu:{fn:this.showCtxMenu,scope:this},resize:{fn:this.onResizeEvent,scope:this},selectionchange:{fn:this.onSelectionChange,scope:this}}};return Ext.apply(i,t),i},getSmallThumbClass:function(t){return Ext.isEmpty(t.thumb)&&Ext.isObject(t.attachment)?"syno-ns-note-card-thumbnail-small-container":""},showContent:function(t){var e,o='<div class="syno-ns-note-card-thumbnail-small" style="height:154px;"> <img src="{0}"> </img> </div>';return t.encrypt?String.format(o,this.findAppWindow()._getImageURL("icon_encrypted.png")):Ext.isObject(t.thumb)&&t.thumb.hasOwnProperty("width")?t.thumb.width<200?(e=SYNO.API.GetBaseURL({api:"SYNO.NoteStation.Note",version:3,method:"download",params:Ext.copyTo({object_id:t.object_id,format:"raw",md5:t.thumb.md5,file_id:"thumb"},this.owner.query_params,"perm_from,smart_id")}),String.format(o,e)):String.format('<img class="syno-ns-note-card-thumbnail" src="{0}"></img>',this.getBackgroundImage(t)):String.format('<div class="syno-ns-note-card-content"> {0} </div>',Ext.util.Format.htmlEncode(t.brief))},getBackgroundImage:function(t){var e=Ext.BLANK_IMAGE_URL;return Ext.isEmpty(t.thumb)||(e=SYNO.API.GetBaseURL({api:"SYNO.NoteStation.Note",version:3,method:"download",params:Ext.copyTo({object_id:t.object_id,format:"raw",md5:t.thumb.md5,file_id:"thumb",filename:"thumb.png"},this.owner.query_params,"perm_from,smart_id")})),e},onResizeEvent:function(t,e,o,i,n){SYNO.SDS.NoteStation.Utils.setEmptyText.call(this,o),SYNO.SDS.NoteStation.Utils.setEmptyTextLineHeight.call(this,o)}}),Ext.define("SYNO.SDS.NoteStation.TextMeasure",{statics:{NUMBER_SIZE_CACHE:new Map,TEXT_SIZE_CACHE:new Map,_dom:null,getDom:function(){if(!SYNO.SDS.NoteStation.TextMeasure._dom){var t=document.createElement("div");t.style.setProperty("position","absolute"),t.style.setProperty("top","-9999px"),t.style.setProperty("left","-9999px"),document.body.appendChild(t),SYNO.SDS.NoteStation.TextMeasure._dom=t}return SYNO.SDS.NoteStation.TextMeasure._dom},getTotalNumWidth:function(t){var e="("+t+")",o=SYNO.SDS.NoteStation.TextMeasure.NUMBER_SIZE_CACHE.get(e.length);if(o)return o;var i=SYNO.SDS.NoteStation.TextMeasure.getSize(e);return o=Math.ceil(i.width),SYNO.SDS.NoteStation.TextMeasure.NUMBER_SIZE_CACHE.set(e.length,o),o},getSize:function(t,e){var o=SYNO.SDS.NoteStation.TextMeasure.TEXT_SIZE_CACHE.get(t);if(o)return o;var i=SYNO.SDS.NoteStation.TextMeasure.getDom();return i.innerText=t,o=i.getBoundingClientRect(),e&&SYNO.SDS.NoteStation.TextMeasure.TEXT_SIZE_CACHE.set(t,o),o}}}),Ext.define("SYNO.SDS.NoteStation.Note.DragZone.Category",{extend:"Ext.dd.DragZone",constructor:function(t,e){this.component=t,this.callParent([t.getEl(),this.fillConfig(e)])},fillConfig:function(t){var e={};return Ext.apply(e,t)},getDragData:function(t){var e,o=t.getTarget("div.syno-ns-note-category-container");return!Ext.isEmpty(o)&&(e=document.createElement("div"),e.className="syno-ns-notebook-dd-preview",e.appendChild(o.cloneNode(!0)),{nodeDataArray:[this.getDragNodeData(o)],target:o,ddel:e})},getRepairXY:function(t){return Ext.Element.fly(this.dragData.target).getXY()},getDragNodeData:function(t){var e=this.component.findAppWindow(),o={object_id:t.getAttribute("ref_id"),category:t.getAttribute("category"),type:t.getAttribute("type")};return SYNO.SDS.NoteStation.Define.TAG===o.category&&(o.tag_id=o.object_id,Ext.copyTo(o,e.tag[o.tag_id],"text,title")),o}}),Ext.define("SYNO.SDS.NoteStation.Note.DataView.Category",{extend:"SYNO.ux.FleXcroll.DataView",constructor:function(t){var e=this.fillConfig(t);this.query_info={},this.callParent([e])},fillConfig:function(t){var e=SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.MainPanel").getCrossPanelCtxMenu(),o=new Ext.XTemplate('<tpl for=".">','<div ref_id="{ref_id:htmlEncode}" type="{type}" category="{category}" class="syno-ns-note-category-container">',"<table> <tbody>","<tr>","<td>",'<div class="{[this.getIconCls(values)]}"></div>',"</td>",'<td><table class="syno-ns-note-category-table"><tbody>',"<tr><td>",'<div class="syno-ns-note-category-title" style="display: inline-block; max-width: {[this.getTextWidth(null, values.total)]}px">{title:htmlEncode}</div>','<div class="syno-ns-note-category-total disable-font" style="display: inline-block;">{[this.getTotal(values)]}</div>',"</td></tr>",'<tr><td class="syno-ns-note-category-detail">{[this.getDetail(values)]}</td></tr>',"</tbody></table></td>","</tr>","</tbody></table>","</div>","</tpl>",'<div class="x-clear"></div>',{compiled:!0,getIconCls:this.getIconCls.createDelegate(this),getDetail:this.getDetail.createDelegate(this),getTotal:this.getTotal.createDelegate(this),getTextWidth:this.getTextWidth.createDelegate(this)});this.emptyTextId="syno-ns-"+Ext.id();var i={ctxMenu:e,tpl:o,itemSelector:"div.syno-ns-note-category-container",overClass:"syno-ns-note-category-over",selectedClass:"syno-ns-note-category-select",multiSelect:!0,store:new Ext.data.JsonStore({idProperty:"ref_id",fields:["ref_id",{name:"title",sortType:Ext.data.SortTypes.asUCString},"ctime","mtime","category","type","total","username","hide_detail","sort_order","leaf"]}),listeners:{afterrender:{fn:function(t){this.dragZone=new SYNO.SDS.NoteStation.Note.DragZone.Category(t,{ddGroup:"ns-dd-group",viewType:"category"})},scope:this},click:{fn:this.selectCategory,scope:this},contextmenu:{fn:this.showCtxMenu,scope:this},resize:{fn:this.onResizeEvent,scope:this}}};return Ext.apply(i,t),i},onResizeEvent:function(t,e,o,i,n){this.setTextWidth(e),SYNO.SDS.NoteStation.Utils.setEmptyText.call(this,o),SYNO.SDS.NoteStation.Utils.setEmptyTextLineHeight.call(this,o)},getTextWidth:function(t,e){var o;return Ext.isEmpty(t)&&(t=this.getWidth()),o=t-76,Ext.isEmpty(e)||(o-=SYNO.SDS.NoteStation.TextMeasure.getTotalNumWidth(e)),o},setTextWidth:function(t){var e;Ext.each(this.getNodes(),function(o){e=this.getTextWidth(t,this.getRecord(o).get("total")),o.getElementsByClassName("syno-ns-note-category-title")[0].style.maxWidth=e+"px"},this)},selectCategory:function(t,e,o,i){var n=o.getAttribute("category"),s=o.getAttribute("type"),a=o.getAttribute("ref_id"),r=this.findAppWindow();if(!Ext.isEmpty(n)&&!Ext.isEmpty(a))switch(n){case"smart":r.selectSmart(a);break;case"notebook":r.selectNotebook(a);break;case"note":r.selectNote(a,"single");break;case"tag":r.selectTag(a);break;case"category":"username"===s&&r.selectUser(t.getStore().getAt(e).get("title"));break;case"joinednote":r.selectJoinedNote(parseInt(a,10),t.getStore().getAt(e).get("username"));break;case"stack":r.selectStack(a);break;case"todo":r.selectTodo(a)}},getIconCls:function(t){var e=t.category,o=t.type,i=this.findAppWindow();return"shared"===t.ref_id?"syno-ns-note-category-shared-notes-icon":"stack"===e?"syno-ns-note-common-stack-icon":("joinednote"===e&&(e="notebook"),"tag"===e&&!1===t.leaf&&(e="tags"),Ext.isString(t.ref_id)&&"joined"===o&&("note"===e&&t.ref_id in i.joined.note&&"rw"===i.joined.note[t.ref_id].perm?o="joined-editable":"notebook"===e&&t.ref_id in i.joined.notebook&&"rw"===i.joined.notebook[t.ref_id].perm&&(o="joined-editable")),["syno-ns-note",e,o,"icon"].join("-"))},getTotal:function(t){return Ext.isNumber(t.total)?String.format(" ({0})",t.total):""},getDetail:function(t){var e,o;return!0===t.hide_detail||(SYNO.SDS.NoteStation.Define.NOTE===t.category?("mtime"===this.owner.sort_info.sort_by||"title"===this.owner.sort_info.sort_by?e=t.mtime:"ctime"===this.owner.sort_info.sort_by&&(e=t.ctime),o=SYNO.SDS.NoteStation.Utils.dateTimeFormatter(new Date(1e3*e),{type:"datetime"}),SYNO.SDS.NoteStation.Define.JOINED===t.type&&(o+=" "+t.username)):SYNO.SDS.NoteStation.Define.NOTEBOOK===t.category&&SYNO.SDS.NoteStation.Define.JOINED===t.type&&(o=t.username)),Ext.isEmpty(o)?"":o},showCtxMenu:function(t,e,o,i){var n={isMultiSelected:!1};-1===t.getSelectedIndexes().indexOf(e)&&t.select(o),o.parent_info={category:"category",type:this.fillDataType},this.ctxNode=o,this.ctxMenu.getMenu(o,n,this.onClickCtxMenu,this),this.ctxMenu.isShowMenu&&this.ctxMenu.showAt(i.getXY())},onClickCtxMenu:function(t,e){var o,i,n,s,a,r,l,d=this,c=this.findAppWindow(),h=c.getMainPanel();if(!Ext.isEmpty(this.ctxNode)&&-1!==(s=this.indexOf(this.ctxNode)))if(o=this.ctxNode.getAttribute("category"),i=this.ctxNode.getAttribute("ref_id"),a=this.getStore().getAt(s).data,"remove_shortcut"===(l=t.itemAction)){var u=[],S=[],p=[],m=this.getSelectedNodes();if(Ext.isEmpty(m))return;Ext.each(m,function(t){var e=this.getStore().getById(t.getAttribute("ref_id"));"tag"===e.data.category?u.push(e.data.ref_id):S.push(e.data.ref_id),p.push(e)},this),p.forEach(function(t){this.getStore().remove(t)},this),n={},n.tag_id=u,n.object_id=S,h.removeFromShortcut(n)}else if("delete_tag"===l)h.deleteTag(i),this.getStore().removeAt(s);else if("add_to_shortcut"===l)n={},"tag"===o?n.tag_id=i:"stack"===o?n.stack_id=i:n.object_id=i,h.addToShortcut(n);else if("rename"===l){if("notebook"===o)r="renameNotebook";else{if("tag"!==o)return"stack"===o?void h.renameStackAsync(i).then(function(t){t&&(a.title=t,d.tpl.overwrite(d.ctxNode,a),d.refresh())}):void 0;r="renameTag"}h[r](i,a.title,function(t,e){a.title=e,this.tpl.overwrite(this.ctxNode,a),this.refresh()},this)}else if("delete_stack"===l)h.deleteStack(i);else if("delete"===l)"notebook"===o?h.deleteNotebook(i):"note"===o?h.deleteNoteAsync(i):"smart"===o&&h.deleteSmart(i);else if("empty_recylce_bin"===l)h.emptyRecycleBin();else if("leave"===l)h.deletePermission(i),this.getStore().removeAt(s);else if("share"===l)"smart"===o?h.shareSmart(i,c.loadAllDataAsync,c):"notebook"===o&&h.shareNotebook(i,c.loadAllDataAsync,c);else if("preset"===l)this.owner.setStatusBusy(),h.setAsPreset(i,function(){this.owner.clearStatusBusy(),this.owner.reloadData()},this);else{if("add_to_stack"===l)return!1;"add_to_exist_stack"===l?h.moveNotebooksToStack(i,t.text):"add_to_new_stack"===l?h.createStack([i]):"remove_from_stack"===l?h.moveNotebooksToStack(i,""):"archive_notebook"===l?h.archiveNotebook(i,!0):"unarchive_notebook"===l?h.archiveNotebook(i,!1):"edit"===l&&"smart"===o&&h.setSmart(i)}},fillData:function(t,e){var o,i=this.findAppWindow(),n=i.getMainPanel();switch(this.fillDataType=t,o=n.getNotePanel().getTopToolbar().getComponent("btn_sort"),o.show(),t){case"shortcut":this.fillShortcutData(i.shortcut,i.owned.preset_id);break;case"tag":this.fillTagData(i.tag);break;case"note":this.fillNoteData(i.owned);break;case"owned":this.fillNotebookData(i.owned);break;case"stack":this.fillStackData(i.owned,e);break;case"joined":this.fillJoinedData(i.joined);break;case"username":this.fillJoinedUserData(i.joined,e);break;case"archive":this.fillArchiveData(i.owned);break;case"todo":this.fillTodoData(i.owned);break;case"smart":this.fillSmartData(i.owned.smart)}},fillShortcutData:function(t,e){var o=[],i=this.getStore(),n=this.findAppWindow();if(Ext.isEmpty(i))return void i.loadData([]);Ext.iterate(t,function(t,i){var s,a;s=!1===i.owned?SYNO.SDS.NoteStation.Define.JOINED:i.id==e?SYNO.SDS.NoteStation.Define.DEFAULT:!0===i.shared?SYNO.SDS.NoteStation.Define.SHARED:SYNO.SDS.NoteStation.Define.COMMON;var r=!0;if("notebook"===i.category)a=10;else if("note"===i.category)a=20;else if("tag"===i.category){a=30;var l=n.tag[i.id];r=!Ext.isObject(l.items)||"{}"===Ext.encode(l.items)}else a=40;o.push({ref_id:i.id,sort_order:a,title:i.title,total:i.item_count,category:i.category,ctime:i.ctime||1/0,mtime:i.mtime||1/0,leaf:r,username:i.owner||"",type:s})},this),i.loadData(o)},fillTagData:function(t){var e=[],o=this.getStore();if(Ext.isEmpty(o))return void o.loadData([]);Ext.iterate(t,function(t,o){e.push({ref_id:o.id,sort_order:10,title:o.title,total:o.item_count,ctime:0,mtime:0,leaf:!Ext.isObject(o.items)||"{}"===Ext.encode(o.items),category:"tag",type:"common"})},this),o.loadData(e)},_fillStore:function(t){var e=this.getStore();if(Ext.isEmpty(e))return void e.loadData([]);e.loadData(t)},fillNoteData:function(t){var e=[];e.push({ref_id:"all",sort_order:10,title:SYNO.SDS.NoteStation._T("category","all_notes"),category:"notebook",type:"all",total:t.all.length,ctime:1/0,mtime:1/0}),e.push({ref_id:"shared",sort_order:20,title:SYNO.SDS.NoteStation._T("category","all_shared_notes"),category:"notebook",type:"all",total:t.shared.length,ctime:1/0,mtime:1/0}),this._fillStore(e)},_createNotebookItemCfg:function(t,e){var o;return o=!0===t.preset?"default":!0===t.shared?"shared":"common",{title:t.title,sort_order:e,total:t.item_count,ctime:t.ctime,mtime:t.mtime,category:"notebook",type:o,ref_id:t.id}},fillNotebookData:function(t){var e=[];Ext.iterate(t.stack,function(t,o){e.push({ref_id:t,sort_order:40,title:o.title,total:o.items.length,category:"stack",type:"stack",ctime:1/0,mtime:1/0})},this),Ext.iterate(t.notebook,function(t,o){Ext.isEmpty(o.stack)&&!0!==o.archive&&e.push(this._createNotebookItemCfg(o,50))},this),this._fillStore(e)},fillStackData:function(t,e){var o=this,i=[];Ext.iterate(t.notebook,function(t,n){Ext.isEmpty(n.stack)||n.stack!==e||!0===n.archive||i.push(o._createNotebookItemCfg(n,50))}),this._fillStore(i)},fillSmartData:function(t){var e=[];Ext.iterate(t,function(t,o){e.push({title:o.title,sort_order:50,ctime:o.ctime,mtime:o.mtime,category:"smart",type:"common",ref_id:t})},this),this._fillStore(e)},fillTodoData:function(t){var e,o=[],i=this.findAppWindow(),n=i.getMainPanel();e=n.getNotePanel().getTopToolbar().getComponent("btn_sort"),e.hide(),o.push({ref_id:"all",sort_order:10,title:SYNO.SDS.NoteStation._T("todo","all_tasks"),category:"todo",type:"all",total:t.todo.total}),o.push({ref_id:"starred",sort_order:15,title:SYNO.SDS.NoteStation._T("todo","starred"),category:"todo",type:"starred",total:t.star_todo.total}),o.push({ref_id:"overdue",sort_order:20,title:SYNO.SDS.NoteStation._T("todo","overdue"),category:"todo",type:"overdue",total:t.overdue_todo.total}),o.push({ref_id:"today",sort_order:30,title:SYNO.SDS.NoteStation._T("todo","today"),category:"todo",type:"today",total:t.today_todo.total}),o.push({ref_id:"next_7_days",sort_order:40,title:SYNO.SDS.NoteStation._T("todo","next_7_days"),category:"todo",type:"next_7_days",total:t.n7d_todo.total}),this._fillStore(o)},fillArchiveData:function(t){var e=[];Ext.iterate(t.archive,function(o){var i=t.notebook[o];Ext.isEmpty(i.stack)&&e.push({title:i.title,sort_order:50,total:i.item_count,ctime:i.ctime,mtime:i.mtime,category:"notebook",type:"archive",ref_id:o})},this),this._fillStore(e)},fillJoinedData:function(t){var e=[];this.owner.getTopToolbar().getComponent("btn_sort").hide(),Ext.iterate(t.owner,function(t,o){e.push({title:t,sort_order:10,total:null,category:"category",type:"username",ref_id:t})},this),this._fillStore(e)},fillJoinedUserData:function(t,e){var o=[],i=this.findAppWindow().uid_map;if(!Ext.isObject(t.owner[e]))return void this._fillStore(o);Ext.isArray(t.owner[e].all)&&o.push({title:SYNO.SDS.NoteStation._T("category","all_joined_notes"),sort_order:10,total:t.owner[e].all.length,category:"joinednote",type:"joined",ctime:1/0,mtime:1/0,ref_id:i[e],username:e,hide_detail:!0}),t.owner[e].notebook.forEach(function(e){o.push({title:t.notebook[e].title,sort_order:50,total:t.notebook[e].item_count,category:"notebook",type:"joined",ctime:t.notebook[e].ctime,mtime:t.notebook[e].mtime,ref_id:e,username:t.notebook[e].owner,hide_detail:!0})},this),Ext.iterate(t.owner[e].smart,function(e){o.push({title:t.smart[e].title,sort_order:50,total:null,category:"smart",type:"joined",ctime:t.smart[e].ctime,mtime:t.smart[e].mtime,ref_id:e,username:t.smart[e].owner,hide_detail:!0})},this),this._fillStore(o)},loadData:function(t,e,o,i,n,s){!1===t&&(this.query_info={}),Ext.isEmpty(n)||Ext.isEmpty(s)||(this.getStore().removeAll(),this.date_index=void 0,this.fillData(n,s)),Ext.isString(e)&&(this.query_info.sort_by=e),Ext.isString(o)&&(this.query_info.sort_direction=o),Ext.isString(n)&&(this.query_info.category=n),Ext.isString(s)&&(this.query_info.title=s),this.query_info.action=i,this.getStore().each(function(t){"tag"===t.data.category&&(t.data.ctime=t.data.mtime="asc"===o?1/0:0)},this),this.getStore().sort([{field:"sort_order",direction:"ASC"},{field:e,direction:o}]),this.handleNotebookAction(i)},handleNotebookAction:function(t){"selectfirst"===t&&this.findAppWindow().selectNote("")}}),Ext.ns("SYNO.SDS.NoteStation.Note.DataView"),Ext.define("SYNO.SDS.NoteStation.Note.DataView.Snippet",{extend:"SYNO.SDS.NoteStation.Note.DataView.Scroll",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){
var e=SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.MainPanel").getCrossPanelCtxMenu(),o=new Ext.XTemplate('<tpl for=".">','<div object_id="{object_id}" category="{category}" type="{type}" class="syno-ns-note-snippet-group-container">','<tpl if="this.showDate(values) == true">','<div class="syno-ns-note-group-header syno-ns-note-snippet-group-header">','<div class="syno-ns-note-yearmonth"> {[this.getTimeInfo(values, "yearmonth")]} </div>',"</div>","</tpl>",'<div object_id="{object_id}" type="{[this.getType(values)]}" category="note" class="syno-ns-note-snippet-container">',"<table> <tbody>","<tr>",'<td style="top:-5px; position:relative;">','<div class="syno-ns-note-snippet-thumbnail"style="{[this.getBackgroundImage(values)]}">','<tpl if="encrypt === false">','<tpl if="this.showThumb(values.thumb) == true">','<div class="syno-ns-note-snippet-day">{[this.getTimeInfo(values, "day")]}</div><div class="syno-ns-note-snippet-time">{[this.getTimeInfo(values, "time")]}</div>',"</tpl>",'<tpl if="this.showThumb(values.thumb) == false">','<div class="syno-ns-note-snippet-day-blank">{[this.getTimeInfo(values, "day")]}</div><div class="syno-ns-note-snippet-time-blank">{[this.getTimeInfo(values, "time")]}</div>',"</tpl>","</tpl>","</div>","</td>",'<td style="top:-5px; position:relative;"><table><tbody>','<tr><td><div class="syno-ns-note-snippet-title" style="width: {[this.getTextWidth()]}px">{[Ext.util.Format.htmlEncode(values.title)]}</div></td></tr>','<tr><td><div class="syno-ns-note-snippet-content">{[this.getBrief(values)]}</div></td></tr>',"</tbody></table></td>","</tr>","</tbody></table>","</div>","</div>","</tpl>",{getTimeInfo:this.getTimeInfo.createDelegate(this),getBackgroundImage:this.getBackgroundImage.createDelegate(this),getTextWidth:this.getTextWidth.createDelegate(this),showDate:this.showDate.createDelegate(this),getType:this.getType.createDelegate(this),showThumb:this.showThumb.createDelegate(this),getBrief:this.getBrief.createDelegate(this)});this.emptyTextId="syno-ns-"+Ext.id();var i={itemId:"note_snippet",ctxMenu:e,itemSelector:"div.syno-ns-note-snippet-group-container",overClass:"syno-ns-note-snippet-container-over",selectedClass:"syno-ns-note-snippet-container-select",multiSelect:!0,store:this.createStore(),tpl:o,listeners:{afterrender:{fn:function(t){this.dragZone=new SYNO.SDS.NoteStation.Note.DragZone.Base(t,{ddGroup:"ns-dd-group",viewType:"snippet"})},scope:this},contextmenu:{fn:this.showCtxMenu,scope:this},resize:{fn:this.onResizeEvent,scope:this},selectionchange:{fn:this.onSelectionChange,scope:this}}};return Ext.apply(i,t),i},showThumb:function(t){return!(!Ext.isObject(t)||Ext.isEmpty(t.md5))&&!(t.width<200)},getBackgroundImage:function(t){var e=Ext.BLANK_IMAGE_URL;return t.encrypt?e=this.findAppWindow()._getImageURL("icon_encrypted.png"):this.showThumb(t.thumb)&&(e=SYNO.API.GetBaseURL({api:"SYNO.NoteStation.Note",version:3,method:"download",params:Ext.copyTo({object_id:t.object_id,format:"raw",md5:t.thumb.md5,file_id:"thumb",filename:"thumb.png"},this.owner.query_params,"perm_from,smart_id")})),String.format("background-image: url({0})",e)},getBrief:function(t){return t.encrypt?SYNO.SDS.NoteStation._T("note","encrypted_note"):Ext.util.Format.htmlEncode(t.brief)},onResizeEvent:function(t,e,o,i,n){this.setTextWidth(e),SYNO.SDS.NoteStation.Utils.setEmptyText.call(this,o),SYNO.SDS.NoteStation.Utils.setEmptyTextLineHeight.call(this,o)},getTextWidth:function(t){return Ext.isEmpty(t)&&(t=this.getWidth()),t-108},setTextWidth:function(t){var e=this.getTextWidth(t),o=document.getElementsByClassName("syno-ns-note-snippet-title");Ext.each(o,function(t){t.style.width=e+"px"})}}),Ext.ns("SYNO.SDS.NoteStation.Note.DataView"),Ext.define("SYNO.SDS.NoteStation.Note.DataView.Search",{extend:"SYNO.SDS.NoteStation.Note.DataView.Scroll",constructor:function(t){this.owner=t.owner,this.addEvents("dataloaded"),this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e=SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.MainPanel").getCrossPanelCtxMenu(),o=new Ext.XTemplate('<tpl for=".">','<div object_id="{object_id}" class="syno-ns-note-snippet-group-container">','<div object_id="{object_id}" category="note" type={[this.getType(values)]} class="syno-ns-note-snippet-container">',"<table> <tbody>","<tr>",'<td style="top:-5px; position:relative;">','<div class="syno-ns-note-snippet-thumbnail"style="{[this.getBackgroundImage(values)]}">','<tpl if="this.showThumb(values.thumb) == true">','<div class="syno-ns-note-snippet-day">{[this.getTimeInfo(values, "day")]}</div><div class="syno-ns-note-snippet-time">{[this.getTimeInfo(values, "time")]}</div>',"</tpl>",'<tpl if="this.showThumb(values.thumb) == false">','<div class="syno-ns-note-snippet-day-blank">{[this.getTimeInfo(values, "day")]}</div><div class="syno-ns-note-snippet-time-blank">{[this.getTimeInfo(values, "time")]}</div>',"</tpl>","</div>","</td>",'<td style="top:-5px; position:relative;"><table><tbody>','<tr><td><div class="syno-ns-note-snippet-title" style="width: {[this.getTextWidth()]}px">{[Ext.util.Format.htmlEncode(values.title)]}</div></td></tr>','<tr><td><div class="syno-ns-note-snippet-content">{[this.getBrief(values)]}</div></td></tr>',"</tbody></table></td>","</tr>","</tbody></table>","</div>","</div>","</tpl>",'<div class="syno-ns-note-search-result-smart-place-holder"> </div>',{getTimeInfo:this.getTimeInfo.createDelegate(this),getBackgroundImage:this.getBackgroundImage.createDelegate(this),getTextWidth:this.getTextWidth.createDelegate(this),showDate:this.showDate.createDelegate(this),getType:this.getType.createDelegate(this),showThumb:this.showThumb.createDelegate(this),getBrief:this.getBrief.createDelegate(this)}),i=new Ext.data.JsonStore({owner:this.owner,idProperty:"object_id",defaultParamNames:{start:"offset",limit:"limit",sort:"sort_by",dir:"sort_direction"},autoLoad:!1,fields:["object_id","owner","title","ctime","mtime","brief","thumb","encrypt"],listeners:{beforeload:function(){this.owner.setStatusBusy()},load:function(){this.owner.clearStatusBusy()},exception:function(){this.owner.clearStatusBusy()},scope:this}});this.emptyTextId="syno-ns-"+Ext.id();var n={itemId:"note_search",ctxMenu:e,cls:"syno-ns-note-search-result-panel",itemSelector:"div.syno-ns-note-snippet-group-container",overClass:"syno-ns-note-snippet-container-over",selectedClass:"syno-ns-note-snippet-container-select",multiSelect:!0,store:i,tpl:o,listeners:{afterrender:{fn:function(t){this.dragZone=new SYNO.SDS.NoteStation.Note.DragZone.Base(t,{ddGroup:"ns-dd-group",viewType:"snippet"})},scope:this},contextmenu:{fn:this.showCtxMenu,scope:this},resize:{fn:this.onResizeEvent,scope:this},click:{fn:SYNO.SDS.NoteStation.Utils.isMobileDevice?this.onSelectNoteMobile:this.onSelectNote,scope:this}}};return Ext.apply(n,t),n},showThumb:function(t){return!(!Ext.isObject(t)||Ext.isEmpty(t.md5))&&!(t.width<200)},getBackgroundImage:function(t){var e=Ext.BLANK_IMAGE_URL;return t.encrypt?e=this.findAppWindow()._getImageURL("icon_encrypted.png"):this.showThumb(t.thumb)&&(e=SYNO.API.GetBaseURL({api:"SYNO.NoteStation.Note",version:3,method:"download",params:Ext.copyTo({object_id:t.object_id,format:"raw",md5:t.thumb.md5,file_id:"thumb",filename:"thumb.png"},this.owner.query_params,"perm_from,smart_id")})),String.format("background-image: url({0})",e)},getBrief:function(t){return t.encrypt?SYNO.SDS.NoteStation._T("note","encrypted_note"):Ext.util.Format.htmlEncode(t.brief)},onResizeEvent:function(t,e,o,i,n){this.setTextWidth(e),SYNO.SDS.NoteStation.Utils.setEmptyText.call(this,o),SYNO.SDS.NoteStation.Utils.setEmptyTextLineHeight.call(this,o)},getTextWidth:function(t){return Ext.isEmpty(t)&&(t=this.getWidth()),t-108},setTextWidth:function(t){var e=this.getTextWidth(t),o=document.getElementsByClassName("syno-ns-note-snippet-title");Ext.each(o,function(t){t.style.width=e+"px"})},onSelectNote:function(t,e,o,i){var n=o.getAttribute("object_id");t.focus(),Ext.isEmpty(n)||this.findAppWindow().selectNote(n)},loadData:function(t,e,o,i){if(this.isLoadingData=!0,!1===t&&(this.owner.setStatusBusy(),Ext.isObject(i)&&(this.query_info={}),this.getStore().removeAll(),this.date_index=void 0,this.canLoadMore=!0,this.query_info.offset=0,this.query_info.limit=this.query_limit,SYNO.SDS.NoteStation.Utils.isPublicShare&&(this.query_info.mode="public")),Ext.isString(e)&&(this.query_info.sort_by=e),Ext.isString(o)&&(this.query_info.sort_direction=o),Ext.isObject(i)){var n=i.keyword;n&&'"'!==n.charAt(0)&&'"'!==n.charAt(n.length-1)&&(n=n.split(/\s+/).filter(function(t){return t.length>0}).map(function(t){return'"'+t+'"'}).join(" ")),Object.assign(this.query_info,i,{keyword:n})}this.sendFTSQuery({callback:this.onLoadData,scope:this})},onLoadData:function(t,e){var o;if(this.owner.clearStatusBusy(),this.SetSmartBarVisible(!0),!t||Ext.isEmpty(e.note.notes))return this.canLoadMore=!1,void this.fireEvent("dataloaded",this);this.query_info.limit>e.note.notes.length&&(this.canLoadMore=!1),this.query_info.offset+=this.query_limit,o=this.getStore().reader.readRecords(e.note.notes),this.getStore().add(o.records),this.updateFleXcroll(),this.isLoadingData=!1,this.fireEvent("dataloaded",this)},sendFTSQuery:function(t){var e=function(e,o){var i={};this.query_id=null,this.current_query=null,!0===e&&(i.note={},i.note.notes=o.matches),t.callback.call(t.scope||window,e,i)};this.query_id&&Ext.isObject(this.current_query)&&Ext.encode(this.current_query)===Ext.encode(this.query_info)||(this.query_id&&(Ext.Ajax.abort(this.query_id),this.query_id=null),this.current_query=Ext.apply({},this.query_info),this.query_id=this.findAppWindow().sendWebAPI({api:"SYNO.NoteStation.FTS",version:1,method:"search",params:this.query_info,callback:e,scope:this}))},SetSmartBarVisible:function(t){return this.smart_bar||(this.smart_bar=new SYNO.ux.Panel({renderTo:this.el.dom,cls:"syno-ns-note-search-result-smart-panel",layout:"fit",items:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("search","save_as_smart"),handler:function(){this.findAppWindow().getMainPanel().createSmart({query:Ext.copyTo({},this.query_info,"keyword, title, mtime_start, mtime_end, ctime_start, ctime_end, tag, tag_operator, parent_id"),owner:this})},scope:this}]})),!0===t&&!0!==this.query_info.archive?(this.addClass("show-smart-button"),this.smart_bar.setWidth(this.getWidth()-12)):this.removeClass("show-smart-button"),this.smart_bar}}),Ext.define("SYNO.SDS.NoteStation.Note.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Note.Panel",this);var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e;return this.owner=t.owner,this.noteCategory=new SYNO.SDS.NoteStation.Note.DataView.Category({itemId:"note_category",owner:this}),this.noteCard=new SYNO.SDS.NoteStation.Note.DataView.Card({itemId:"note_card",owner:this}),this.noteSnippet=new SYNO.SDS.NoteStation.Note.DataView.Snippet({itemId:"note_snippet",owner:this}),this.noteSearch=new SYNO.SDS.NoteStation.Note.DataView.Search({itemId:"note_search",owner:this}),this.owner.on("selectnote",function(t,e){var o,i;this.currentNoteId=t,o=this.layout.activeItem,Ext.isEmpty(o)||"note_search"===o.itemId||"select"!==e||("note_card"!==o.itemId&&"note_snippet"!==o.itemId&&(i=this.getTopToolbar().getComponent("btn_note_display_mode"),Ext.isObject(i)&&(i.mode="snippet",i.setIconClass("syno-ns-note-display-mode-card")),this.layout.setActiveItem("note_snippet"),o=this.layout.activeItem),1===o.getSelectionCount()&&o.getSelectedNodes()[0].getAttribute("object_id")===t||(o.clearSelections(),o.forceSelectedObjectId=t,o.loadData(!1,this.sort_info.sort_by,this.sort_info.sort_direction)))},this),this.owner.on("selectuser",function(t){this.unlockSplitBar(),this.layout.setActiveItem("note_category"),this.layout.activeItem.fillData("username",t)},this),e={cls:"syno-ns-note-container-panel",tbar:this.createTBar(t),sort_info:{sort_by:"mtime",sort_direction:"desc"},items:[this.noteCategory,this.noteCard,this.noteSnippet,this.noteSearch],listeners:{resize:function(t,e,o,i,n){var s;Ext.isEmpty(this.getLayout().activeItem)||"note_card"==this.getLayout().activeItem.getItemId()||(this.setTitleFieldWidth(i-8-12),this.snippetview_width=i,s=this.findAppWindow().appInstance,Ext.isObject(s)&&s.setUserSettings("snippetview_width",this.snippetview_width))},scope:this}},Ext.apply(e,t),e},applyDefaultSetting:function(){var t,e,o,i,n,s,a="syno-ns-note-display-mode-";t=this.findAppWindow(),n=t.getMainPanel().getComponent("center_region"),Ext.isEmpty(t.appInstance)?(e={sort_by:"mtime",sort_direction:"desc"},this.view_by="snippet",this.snippetview_width=SYNO.SDS.NoteStation.Utils.SNIPPETVIEW_MINIMUM_WIDTH):(e=t.appInstance.getUserSettings("sort_info")||{sort_by:"mtime",sort_direction:"desc"},this.view_by=t.appInstance.getUserSettings("view_by")||"snippet",this.snippetview_width=t.appInstance.getUserSettings("snippetview_width")||SYNO.SDS.NoteStation.Utils.SNIPPETVIEW_MINIMUM_WIDTH),this.sort_info=e,this.sortMenu.getComponent(this.sort_info.sort_by).setChecked(!0),this.sortMenu.getComponent(this.sort_info.sort_direction).setChecked(!0),o=this.getTopToolbar(),i=o.getComponent("btn_note_display_mode"),i.mode=this.view_by,Ext.isObject(n)&&n.getLayout().west&&(s=n.getLayout().west.getSplitBar()),"snippet"===this.view_by?(a+="card",Ext.isObject(s)&&n.getLayout().west.onSplitMove(s,this.snippetview_width)):(a+="snippet",Ext.isObject(s)&&n.getLayout().west.onSplitMove(s,SYNO.SDS.NoteStation.Define.CARDVIEW_MINIMUM_WIDTH)),i.setIconClass(a)},createTBar:function(t){var e=this.getListViewTBar();return new SYNO.ux.Toolbar({cls:"syno-ns-note-toolbar",ctCls:"syno-ns-note-toolbar-ct",items:e})},getMenuItems:function(){var t=[];switch(this.menu_info.type){case"tag":t=this.getTagMenu(this.menu_info.id);break;case"note":t=this.getNoteMenu(this.menu_info.id);break;case"owned":t=this.getNotebookMenu(this.menu_info.id);break;case"recycle":t=[];break;case"joined":t=this.getJoinedMenu(this.menu_info.username,this.menu_info.id);break;case"smart":t=this.getSmartMenu(this.menu_info.id)}return t},getListMenu:function(){var t=function(t){var e=this.getMenuItems();t.removeAll(),t.add(e)};return new SYNO.ux.Menu({cls:"syno-ux-groupcheck-menu syno-ns-menu",listeners:{beforeshow:t,scope:this}})},getTagMenu:function(t){var e=[],o=this.findAppWindow();return Ext.iterate(o.tag,function(i,n){e.push({text:n.title,checked:i===t,handler:o.selectTag.createDelegate(o,[i])})},this),e},getNoteMenu:function(t){var e=this.findAppWindow();return[{text:SYNO.SDS.NoteStation._T("category","all_notes"),checked:"all"===t,handler:e.selectNotebook.createDelegate(e,["all"]),scope:this},{text:SYNO.SDS.NoteStation._T("category","all_shared_notes"),checked:"shared"===t,handler:e.selectNotebook.createDelegate(e,["shared"]),scope:this}]},getNotebookMenu:function(t){var e=this,o=[],i=this.findAppWindow();return Ext.iterate(i.owned.stack,function(n,s){o.push({text:s.title,checked:n===t,handler:i.selectStack.createDelegate(i,[n]),scope:e})}),Ext.iterate(i.owned.notebook,function(e,n){o.push({text:n.title,checked:e===t,handler:i.selectNotebook.createDelegate(i,[n.id]),scope:this})},this),o},getJoinedMenu:function(t,e){var o,i=[],n=this.findAppWindow(),s=n.uid_map[t];if(Ext.isNumber(s))return o=SYNO.SDS.NoteStation._T("category","all_joined_notes"),i.push({text:o,checked:e===s,handler:n.selectJoinedNote.createDelegate(n,[s,o])}),n.joined.owner[t].notebook.forEach(function(t){i.push({text:n.joined.notebook[t].title,checked:e===t,handler:n.selectNotebook.createDelegate(n,[t])})},this),i},getSmartMenu:function(t){var e=[],o=this.findAppWindow();return Ext.iterate(o.owned.smart,function(i,n){e.push({text:n.title,checked:i===t,handler:o.selectSmart.createDelegate(o,[n.id])})},this),e},getListViewTBar:function(){return this.menuBtn=new SYNO.ux.Button({hidden:!0,cls:"syno-ns-note-switch-notebook",itemId:"btn_switch_notebook",menu:this.getListMenu(),autoWidth:!0,listeners:{onSetMenuBtnText:function(){this.setTitleFieldWidth()},show:function(){this.setTitleFieldWidth()},scope:this}}),this.menuBtn.addEvents("onSetMenuBtnText"),[{hidden:!0,cls:"syno-ns-note-display-notebook",itemId:"search_title",xtype:"syno_displayfield"},{hidden:!0,cls:"syno-ns-note-display-notebook",itemId:"display_title",xtype:"syno_displayfield"},this.menuBtn,"->",{hidden:!0,cls:"syno-ns-note-display-mode",iconCls:"syno-ns-note-display-mode-card",tooltip:SYNO.SDS.NoteStation._T("tooltip","view_by"),itemId:"btn_note_display_mode",mode:"snippet",xtype:"syno_button",handler:this.switchMode,scope:this},{hidden:!0,cls:"syno-ns-note-sort-btn",iconCls:"syno-ns-note-sort-btn-icon",tooltip:SYNO.SDS.NoteStation._T("tooltip","sort_by"),itemId:"btn_sort",split:!1,menu:this.sortMenu=new SYNO.ux.Menu({cls:"syno-ux-groupcheck-menu",items:[{text:SYNO.SDS.NoteStation._T("sort","by_title"),itemId:"title",group:"sort_by",handler:this.onSortByChanged,checked:!1,scope:this},{text:SYNO.SDS.NoteStation._T("sort","by_ctime"),itemId:"ctime",group:"sort_by",handler:this.onSortByChanged,checked:!1,scope:this},{text:SYNO.SDS.NoteStation._T("sort","by_mtime"),itemId:"mtime",group:"sort_by",handler:this.onSortByChanged,checked:!0,scope:this},"-",{text:SYNO.SDS.NoteStation._T("sort","order_desc"),itemId:"desc",checked:!0,group:"sort_direction",handler:this.onSortDirectionChanged,scope:this},{text:SYNO.SDS.NoteStation._T("sort","order_asc"),itemId:"asc",checked:!1,group:"sort_direction",handler:this.onSortDirectionChanged,scope:this},this.tagShowModeSep=new Ext.menu.Separator({hidden:!0}),{hidden:!0,text:SYNO.SDS.NoteStation._T("tag","show_subtag"),itemId:"tag_show_mode",checked:!1,handler:this.switchTagView,scope:this}]})}]},switchTagView:function(t){var e=this.query_params.tag[0];this.query_params.tag=[e],this.isListAllSubTag?this.isListAllSubTag=!1:(this.isListAllSubTag=!0,Ext.iterate(SYNO.SDS.NoteStation.Window.tag,function(t,o){SYNO.SDS.NoteStation.Utils.checkTagIsParent(e,o.title)&&this.query_params.tag.push(o.title)},this)),this.layout.activeItem.loadData(!1,this.sort_info.sort_by,this.sort_info.sort_direction)},switchMode:function(t,e){var o,i,n,s,a=this.findAppWindow(),r=t.mode,l="note_";n=SYNO.SDS.NoteStation.Utils.isShowNotebook||SYNO.SDS.NoteStation.Utils.isShowSmart?a.getMainPanel():a.getMainPanel().getComponent("center_region"),Ext.isObject(n)&&n.getLayout().west&&(s=n.getLayout().west.getSplitBar()),"snippet"===r?(t.mode="card",t.setIconClass("syno-ns-note-display-mode-snippet")):"card"===r&&(t.mode="snippet",t.setIconClass("syno-ns-note-display-mode-card")),l+=t.mode,o=this.getComponent(l),o.getStore().removeAll(),this.layout.setActiveItem(o),Ext.isObject(s)&&("card"===t.mode?(i=SYNO.SDS.NoteStation.Define.CARDVIEW_MINIMUM_WIDTH,n.getLayout().west.onSplitMove(s,i),s.dd.lock()):"snippet"===t.mode&&(i=this.snippetview_width||SYNO.SDS.NoteStation.Define.SNIPPETVIEW_MINIMUM_WIDTH,n.getLayout().west.onSplitMove(s,i),s.dd.unlock())),this.setStatusBusy(),Ext.isObject(this.findAppWindow().appInstance)&&this.findAppWindow().appInstance.setUserSettings("view_by",t.mode),this.view_by=t.mode,o.loadData(!1,this.sort_info.sort_by,this.sort_info.sort_direction),o.on("dataloaded",this.clearStatusBusy,this,{single:!0})},switchTitleOnlySortBy:function(t){var e=this.sortMenu.getComponent("title"),o=this.sortMenu.getComponent("ctime"),i=this.sortMenu.getComponent("mtime");t?(e.setChecked(!0),o.setDisabled(!0),i.setDisabled(!0),this.onSortByChanged(e)):(o.setDisabled(!1),i.setDisabled(!1))},unlockSplitBar:function(){var t,e,o;o=this.findAppWindow(),t=o.getMainPanel().getComponent("center_region"),Ext.isObject(t)&&t.getLayout().west&&(e=t.getLayout().west.getSplitBar()),Ext.isObject(e)&&e.dd.unlock()},switchPanel:function(t,e,o,i,n,s){var a,r,l,d,c,h,u,S,p,m,f,g,y;if(this.currentNoteListId=e,p=this.findAppWindow(),h=this.getTopToolbar(),a=h.getComponent("btn_switch_notebook"),r=h.getComponent("display_title"),g=h.getComponent("search_title"),l=h.getComponent("btn_note_display_mode"),c=h.getComponent("btn_sort"),d=c.menu.getComponent("tag_show_mode"),u=this.getComponent("note_"+l.mode),!Ext.isEmpty(u)){!0===t?this.getLayout().setActiveItem("note_"+l.mode):(this.getLayout().setActiveItem("note_category"),this.unlockSplitBar()),S=p.getMainPanel().getNotebookPanel();var N=(!Ext.isObject(S.layout)||"light_menu"===S.layout.activeItem.itemId)&&(t&&"recycle"!==e||"stack"===o);if(N?(a.setText(i),a.fireEvent("onSetMenuBtnText")):r.setValue(i),g.hide(),c.show(),l.setVisible(t),d.setVisible("tag"===o),this.tagShowModeSep.setVisible("tag"===o),Ext.isObject(S.layout)&&(f=N?"light":"full",SYNO.SDS.NoteStation.Utils.switchNotebookBtn(f)),this.setTitleFieldWidth(),"highlight"!==s){switch(this.query_params={},this.field_params={},this.menu_info={type:"owned",id:e},this.switchTitleOnlySortBy(!1),o){case"category":return"tag"===e&&this.switchTitleOnlySortBy(!0),SYNO.SDS.NoteStation.Utils.switchNotebookBtn("full"),void this.noteCategory.loadData(!1,this.sort_info.sort_by,this.sort_info.sort_direction,s,e,i);case"notebook":this.field_params={link_id:!0,commit_msg:!0},e in p.joined.notebook?(m=p.joined.notebook[e].owner,this.query_params.owner=p.uid_map[m],this.menu_info.type="joined",this.menu_info.username=m):this.query_params.owner=p.uid_map[this._S("user")],"all"===e?(this.query_params.recycle=!1,this.query_params.archive=!1,this.menu_info.type="note"):"shared"===e?(this.query_params.recycle=!1,this.query_params.individual_shared=!0,this.menu_info.type="note"):"recycle"===e?(this.query_params.recycle=!0,this.query_params.archive=!1,this.menu_info.type="recycle"):(e in p.owned.notebook&&(this.query_params.archive=p.owned.notebook[e].archive),this.query_params.parent_id=e,this.query_params.recycle=!1);break;case"smart":e in p.owned.smart?(this.query_params.owner=p.uid_map[this._S("user")],this.menu_info.type="smart"):(m=p.joined.smart[e].owner,this.query_params.owner=p.uid_map[m],this.menu_info.type="joined",this.menu_info.username=m),this.query_params.perm_from="smart",this.query_params.smart_id=e,this.query_params.recycle=!1;break;case"tag":this.query_params.tag=[i],this.query_params.tag_operator="or",this.isListAllSubTag&&Ext.iterate(SYNO.SDS.NoteStation.Window.tag,function(t,e){SYNO.SDS.NoteStation.Utils.checkTagIsParent(i,e.title)&&this.query_params.tag.push(e.title)},this),this.menu_info.type="tag";break;case"stack":return void this.noteCategory.loadData(!1,this.sort_info.sort_by,this.sort_info.sort_direction,s,o,i);case"note":return e in p.owned.note?(y=p.owned.note[e].parent_id,this.switchPanel(!0,y,"notebook",p.owned.notebook[y].title),p.selectNote(e,"select")):e in p.joined.note?(p.joined.note[e].parent_id in p.joined.notebook?(y=p.joined.note[e].parent_id,this.switchPanel(!0,y,"notebook",p.joined.notebook[y].title)):this.switchPanel(!0,p.uid_map[p.joined.note[e].owner],"joinednote",SYNO.SDS.NoteStation._T("category","all_joined_notes")),p.selectNote(e,"select")):this.switchPanel(!0,e,"notebook",""),void p.selectNote(e);case"joinednote":this.query_params.owner=e,this.query_params.recycle=!1,this.query_params.individual_joined=!0,this.menu_info.type="joined",Ext.iterate(p.uid_map,function(t,o){if(o===e)return this.menu_info.username=t,!1},this);break;default:return}0===this.getMenuItems().length&&SYNO.SDS.NoteStation.Utils.switchNotebookBtn("full"),this.setStatusBusy(),u.on("dataloaded",this.clearStatusBusy,this,{single:!0}),u.loadData(!1,this.sort_info.sort_by,this.sort_info.sort_direction,s)}}},setTitleFieldWidth:function(t){var e,o=this.getTopToolbar(),i=o.getComponent("display_title"),n=o.getComponent("btn_switch_notebook");Ext.isEmpty(i)||Ext.isEmpty(n)||(e=this.getTitleFieldWidth(t),i.isVisible()?i.getEl().setStyle("max-width",String.format("{0}px",e)):n.isVisible()&&(n.getEl().dom.getElementsByTagName("button")[0].removeAttribute("style"),n.setWidth(void 0),n.getWidth()>e&&(n.setWidth(e),n.getEl().dom.getElementsByTagName("button")[0].style.width=e-26+"px")))},getTitleFieldWidth:function(t){var e,o=this.getTopToolbar();return e=Ext.isEmpty(t)?o.getWidth():t,e-=Ext.fly(o.getLayout().rightTr).getWidth()},setStatusBusy:function(){this.el&&!this.el.isMasked()&&this.el.mask(SYNO.SDS.NoteStation._T("common","loading"),"x-mask-loading")},clearStatusBusy:function(){this.el&&this.el.unmask()},handleDeleteNote:function(){var t=this.getLayout().activeItem;t===this.noteCategory||this.query_params.owner&&this.query_params.owner!==this.findAppWindow().owner_uid||t.handleDeleteNote(null,this.query_params.recycle)},handleAddShortcut:function(){var t=this.getLayout().activeItem;t===this.noteCategory||this.query_params.recycle||this.query_params.archive||t.handleAddShortcut(null,!0)},handleMoveNotes:function(){var t=this.getLayout().activeItem;t===this.noteCategory||this.query_params.recycle||this.query_params.archive||this.query_params.owner&&this.query_params.owner!==this.findAppWindow().owner_uid||t.handleMoveNotes()},updateNote:function(t,e){var o,i,n;!0===t&&Ext.isObject(e)&&(o=this.layout.activeItem,Ext.isObject(o)&&0!==o.getNodes().length&&(i=this.findAppWindow(),1===o.getSelectionCount()&&(n=o.getSelectedNodes()[0].getAttribute("object_id")),Ext.isString(n)?(o.clearSelections(),i.selectNote(n,"select")):o.loadData(!1,this.sort_info.sort_by,this.sort_info.sort_direction)))},onSortByChanged:function(t){t.itemId!==this.sort_info.sort_by&&(this.sort_info.sort_by=t.itemId,this.layout.activeItem.loadData(!1,this.sort_info.sort_by,this.sort_info.sort_direction),Ext.isObject(this.findAppWindow().appInstance)&&this.findAppWindow().appInstance.setUserSettings("sort_info",this.sort_info))},onSortDirectionChanged:function(t){t.itemId!==this.sort_info.sort_direction&&(this.sort_info.sort_direction=t.itemId,this.layout.activeItem.loadData(!1,this.sort_info.sort_by,this.sort_info.sort_direction),Ext.isObject(this.findAppWindow().appInstance)&&this.findAppWindow().appInstance.setUserSettings("sort_info",this.sort_info))},clearData:function(){var t,e,o,i,n,s,a,r=this.getLayout();n=this.getTopToolbar(),t=n.getComponent("btn_switch_notebook"),e=n.getComponent("display_title"),o=n.getComponent("btn_note_display_mode"),i=n.getComponent("btn_sort"),Ext.isObject(r)&&(s=r.activeItem.getStore(),Ext.isObject(s)&&(Ext.isEmpty(s.root)?a=[]:(a={},a[s.root]=[]),r.activeItem.getStore().loadData(a)),t.hide(),e.hide(),o.hide(),i.hide())},reloadData:function(){var t=this.getLayout().activeItem;Ext.isObject(t)&&Ext.isFunction(t.loadData)&&("note_category"===t.itemId?t.loadData(!1,t.query_info.sort_by,t.query_info.sort_direction,t.query_info.action,t.query_info.category,t.query_info.title):"note_search"===t.itemId||t.loadData(!1,t.query_info.sort_by,t.query_info.sort_direction,"selectfirst"))}}),Ext.define("SYNO.SDS.NoteStation.Notebook.ListView.LightMenu",{extend:"Ext.list.ListView",shortcut_id:Ext.id(void 0,"shortcut_"),todo_id:Ext.id(void 0,"todo_"),note_id:Ext.id(void 0,"note_"),notebook_id:Ext.id(void 0,"notebook_"),joined_id:Ext.id(void 0,"joined_"),tag_id:Ext.id(void 0,"tag_"),archive_id:Ext.id(void 0,"archive_"),smart_id:Ext.id(void 0,"smart_"),recycle_id:Ext.id(void 0,"recycle_"),constructor:function(t){var e;this.owner=t.owner,e=this.findAppWindow(),this.callParent([this.fillConfig(t)]);var o={id:this.shortcut_id,text:SYNO.SDS.NoteStation._T("category","shortcut"),category:"category",note_type:"shortcut",type:"shortcut"},i={id:this.todo_id,text:SYNO.SDS.NoteStation._T("category","todo_task"),category:"category",note_type:"todo",type:"todo"},n={id:this.note_id,text:SYNO.SDS.NoteStation._T("todo","note"),category:"category",note_type:"note",type:"note"},s={id:this.notebook_id,text:SYNO.SDS.NoteStation._T("category","notebook"),category:"category",note_type:"owned",type:"notebook"},a={id:this.smart_id,text:SYNO.SDS.NoteStation._T("category","smart"),category:"category",note_type:"smart",type:"smart"},r={id:this.archive_id,text:SYNO.SDS.NoteStation._T("category","archive"),category:"category",note_type:"archive",type:"archive"},l={id:this.joined_id,text:SYNO.SDS.NoteStation._T("category","joined"),category:"category",note_type:"joined",type:"joinednotebook"},d={id:this.tag_id,text:SYNO.SDS.NoteStation._T("category","tag"),category:"category",note_type:"tag",type:"tag"},c={id:this.recycle_id,text:SYNO.SDS.NoteStation._T("category","recycle"),category:"notebook",note_type:"recycle",type:"recycle"};this.getStore().loadData([o,i,n,s,a,r,l,d,c]),e.on("ownednotebookloaded",this.fillArchiveData,this),e.on("joinednotebookloaded",this.fillJoinedData,this),e.on("ownedsmartloaded",this.fillSmartData,this)},fillConfig:function(t){var e=SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.MainPanel").getCrossPanelCtxMenu(),o={store:this.getStore(),hideHeaders:!0,singleSelect:!0,ctxMenu:e,cls:"syno-ns-notebook-lightmenu-listview",itemSelector:"div.syno-ns-notebook-lightmenu-icon-wrapper",columns:[{dataIndex:"name",tpl:['<div ext:qtip="{text}" class="syno-ns-notebook-lightmenu-icon-wrapper" id="{id}">','<div class="syno-ns-notebook-lightmenu" >','<div class="syno-ns-notebook-lightmenu-{type}-icon" >',"</div></div></div>"].join("")}],listeners:{selectionchange:{fn:this.onSelectionChange,scope:this},activate:{fn:function(){var t=this.findAppWindow().getMainPanel().getNotePanel();if("note_category"===t.getLayout().activeItem.getItemId()||0===t.getMenuItems().length)return void SYNO.SDS.NoteStation.Utils.switchNotebookBtn("full");SYNO.SDS.NoteStation.Utils.switchNotebookBtn("light")},scope:this},contextmenu:{fn:this.showCtxMenu,scope:this}}};return Ext.apply(o,t),o},getStore:function(){return this.store||(this.store=new Ext.data.JsonStore({fields:["id","type","category","note_type","text"]})),this.store},fillSmartData:function(t){var e,o=!1;if(e=this.getNode(this.smart_id),!Ext.isObject(t))return void(e.style.display="none");Ext.iterate(t,function(t){return o=!0,!1}),e.style.display=!0===o?"":"none"},fillArchiveData:function(t){var e,o=!1;if(e=this.getNode(this.archive_id),!Ext.isObject(t)||Ext.isEmpty(t.archive))return void(e.style.display="none");Ext.iterate(t.archive,function(e,i){if(!Ext.isEmpty(t.notebook[e]))return o=!0,!1}),e.style.display=!0===o?"":"none"},fillJoinedData:function(t){var e,o=!1;if(e=this.getNode(this.joined_id),!Ext.isObject(t))return void(e.style.display="none");Ext.iterate(t.owner,function(t,e){return o=!0,!1}),e.style.display=!0===o?"":"none"},onSelectionChange:function(t,e){var o,i,n,s,a;i=this.findAppWindow(),o=i.getPanelScope("SYNO.SDS.NoteStation.Note.Panel"),n=i.getPanelScope("SYNO.SDS.NoteStation.Editor.Panel"),a=i.getPanelScope("SYNO.SDS.NoteStation.MainPanel"),a.searchField.reset(),Ext.isEmpty(e)||(s=this.getRecord(e[0]),Ext.isEmpty(s)||(a.switchCenterPanel("notebook"),n.getLayout().setActiveItem(0),o.switchPanel("notebook"===s.data.category,s.data.note_type,s.data.category,s.data.text)))},showCtxMenu:function(t,e,o,i){var n=this.getStore().getAt(e),s=n.get("category"),a=n.get("type"),r={isMultiSelected:!1};this.ctxMenu.getMenu(s,r,a),this.ctxMenu.isShowMenu&&this.ctxMenu.showAt(i.getXY())},selectNotebookById:function(t){var e,o,i,n,s,a;if(o=this.findAppWindow(),e=o.getPanelScope("SYNO.SDS.NoteStation.Note.Panel"),"all"===t)n=this.note_id,i=SYNO.SDS.NoteStation._T("category","all_notes"),s="notebook",a=!0;else if("recycle"===t)n=this.recycle_id,i=SYNO.SDS.NoteStation._T("category","recycle"),s="notebook",a=!0;else if("note"===t)n=this.note_id,i=SYNO.SDS.NoteStation._T("category","note"),s="category",a=!1;else if("shared"===t)n=this.note_id,i=SYNO.SDS.NoteStation._T("category","all_shared_notes"),s="notebook",a=!0;else if("owned"===t)n=this.notebook_id,i=SYNO.SDS.NoteStation._T("category","notebook"),s="category",a=!1;else if("smart"===t)n=this.smart_id,i=SYNO.SDS.NoteStation._T("category","smart"),s="category",a=!1;else if("archive"===t)n=this.archive_id,i=SYNO.SDS.NoteStation._T("category","archive"),s="category",a=!1;else if("joined"===t)n=this.joined_id,i=SYNO.SDS.NoteStation._T("category","joined"),s="category",a=!1;else if("shortcut"===t)n=this.shortcut_id,
i=SYNO.SDS.NoteStation._T("category","shortcut"),s="category",a=!1;else if("tag"===t)n=this.tag_id,i=SYNO.SDS.NoteStation._T("category","tag"),s="category",a=!1;else if(t in o.owned.notebook)!0===o.owned.notebook[t].archive?n=this.archive_id:(n=this.notebook_id,o.owned.choosed=t),i=o.owned.notebook[t].title,s="notebook",a=!0;else{if(!(t in o.joined.notebook))return;n=this.joined_id,i=o.joined.notebook[t].title,s="notebook",a=!0}Ext.isEmpty(n)||this.select(n,!1,!0),e.switchPanel(a,t,s,i)},selectStackByName:function(t,e){var o,i,n,s;n=this.findAppWindow(),o=n.getPanelScope("SYNO.SDS.NoteStation.Note.Panel"),i=n.getPanelScope("SYNO.SDS.NoteStation.Editor.Panel"),s=this.notebook_id,i.getLayout().setActiveItem(0),Ext.isEmpty(s)||this.select(s,!1,!0),o.switchPanel(!1,t,"stack",n.owned.stack[t].title)},selectSmartById:function(t,e){var o,i,n,s;n=this.findAppWindow(),o=n.getPanelScope("SYNO.SDS.NoteStation.Note.Panel"),i=n.getPanelScope("SYNO.SDS.NoteStation.Editor.Panel"),t in n.owned.smart?s=this.smart_id:t in n.joined.smart&&(s=this.joined_id),i.getLayout().setActiveItem(0),Ext.isEmpty(s)||this.select(s,!1,!0),t in n.owned.smart&&o.switchPanel(!0,t,"smart",n.owned.smart[t].title)},selectTodoById:function(t){this.findAppWindow().getPanelScope("SYNO.SDS.NoteStation.MainPanel").switchCenterPanel("todo",t)},selectTagById:function(t){var e,o,i,n;i=this.findAppWindow(),e=i.getPanelScope("SYNO.SDS.NoteStation.Note.Panel"),o=i.getPanelScope("SYNO.SDS.NoteStation.Editor.Panel"),t in i.tag&&(n=i.tag[t].title,o.getLayout().setActiveItem(0),e.switchPanel(!0,t,"tag",n,"owned"))},selectJoinedNote:function(t,e){var o,i,n;n=this.findAppWindow(),o=n.getPanelScope("SYNO.SDS.NoteStation.Note.Panel"),i=n.getPanelScope("SYNO.SDS.NoteStation.Editor.Panel"),i.getLayout().setActiveItem(0),this.select(this.joined_id,!1,!0),o.switchPanel(!0,t,"joinednote",e)}}),Ext.define("SYNO.SDS.NoteStation.DateField",{extend:"SYNO.ux.DateTimeField",constructor:function(t){this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={value:"",allowBlank:!0,editable:!1,menuCfg:{allowOtherMenus:!0}};return Ext.apply(e,t),e},initValue:function(t){t=t||"",this.setValue(t),this.originalValue=this.getValue()}}),Ext.define("SYNO.SDS.NoteStation.SuperBoxSelect",{extend:"SYNO.ux.SuperBoxSelect",constructor:function(t){var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e={mode:"local",triggerAction:"all",allowAddNewData:!0,addNewDataOnBlur:!0,grow:!0,minChars:1,resizable:!0,emptyText:SYNO.SDS.NoteStation._T("tag","add_tag"),tpl:this.getListTemplate(t),displayFieldTpl:this.getDisplayTemplate(t)};return Ext.apply(e,t),e},initEvents:function(){this.callParent(arguments),this.mon(this,"newitem",this.onAddNewitem,this),this.mon(this.items,"add",this.onBoxAdded,this)},getListTemplate:function(t){return new Ext.XTemplate(String.format('<tpl for="."><div class="x-combo-list-item" ext:qtip="{[this.getTooltip(values)]}">{values.{0}:htmlEncode}</div></tpl>',t.displayField),{getTooltip:function(e){return Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(e[t.displayField]))}})},getDisplayTemplate:function(t){return new Ext.XTemplate("{[this.getDisplayName(values)]}",{getDisplayName:function(e){var o=e[t.displayField],i="",n=this.findAppWindow();return Ext.iterate(n.tag,function(t,e){var n=e.title;if(n.length<=i.length||n.length>=o)return!0;SYNO.SDS.NoteStation.Utils.checkTagIsParent(n,o)&&(i=n)},this),Ext.util.Format.htmlEncode(SYNO.SDS.NoteStation.Utils.getTagChild(o,i))}.createDelegate(this)})},onAddNewitem:function(t,e,o){var i={};e=e.trim(),Ext.isEmpty(e)||(i[this.valueField]=e,i[this.displayField]=e,t.addItem(i,!0))},onBoxAdded:function(t,e,o){e.el.set({"ext:qtip":Ext.util.Format.htmlEncode(e.display)})},doQuery:function(t,e,o,i){if(t=Ext.isEmpty(t)?"":t,this.queryFilterRe){this.filteredQueryData="";var n=t.match(this.queryFilterRe);if(n&&n.length&&(this.filteredQueryData=n[0]),!(t=t.replace(this.queryFilterRe,""))&&n)return}var s={query:t,forceAll:e,combo:this,cancel:!1};if(!1===this.fireEvent("beforequery",s)||s.cancel)return!1;t=s.query,(!0===(e=s.forceAll)||t.length>=this.minChars||o&&!Ext.isEmpty(t))&&(i||this.forceSameValueQuery||this.shouldQuery(t)?(this.lastQuery=t,"local"==this.mode?(this.selectedIndex=-1,e?this.store.clearFilter():this.store.filter(this.displayField,t,!0),this.onLoad()):(this.store.baseParams[this.queryParam]=t,this.store.baseParams[this.queryValuesIndicator]=o,this.store.load({params:this.getParams(t)}),i||this.expand())):(this.selectedIndex=-1,this.onLoad()))}}),Ext.define("SYNO.SDS.NoteStation.AnyMatchCombo",{extend:"SYNO.ux.ComboBox",doQuery:function(t,e){t=Ext.isEmpty(t)?"":t;var o={query:t,forceAll:e,combo:this,cancel:!1};if(!1===this.fireEvent("beforequery",o)||o.cancel)return!1;t=o.query,(!0===(e=o.forceAll)||t.length>=this.minChars)&&(this.lastQuery!==t?(this.lastQuery=t,"local"==this.mode?(this.selectedIndex=-1,e?this.store.clearFilter():this.store.filter(this.displayField,t,!0),this.onLoad()):(this.store.baseParams[this.queryParam]=t,this.store.load({params:this.getParams(t)}),this.expand())):(this.selectedIndex=-1,this.onLoad()))}}),Ext.define("SYNO.SDS.NoteStation.ModalWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(t){var e=Ext.isString(t.cls)?t.cls+" syno-ns-dialog":"syno-ns-dialog";t.cls=e,this.callParent([t])},_getAbsoluteURL:function(){return this._getOwner()._getAbsoluteURL.apply(this._getOwner(),arguments)},_getWebAPIURL:function(){return this._getOwner()._getWebAPIURL.apply(this._getOwner(),arguments)},_getOwner:function(){return this.owner.findAppWindow()}}),Ext.define("SYNO.SDS.NoteStation.Operate.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={cls:"syno-ns-create-notebook-window",height:t.height||192,autoHeight:!0,width:352,layout:"fit",items:this.getFormPanel(t),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),handler:this.onCancel,scope:this},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onOk,scope:this}],listeners:{show:{fn:function(){this.textField.focus(!0,200),"create_tag"===t.type&&this.textField.clearInvalid()},single:!0}}};return Ext.apply(e,t)},getInvalidWords:function(t){return"rename_tag"!==t?[]:Object.values(this.findAppWindow().tag).map(function(t){return t.title})},getFormPanel:function(t){var e=t.ori_title,o=this.getInvalidWords(t.type);this.textField=new SYNO.ux.TextField({xtype:"syno_textfield",itemCls:"syno-ns-form-last-child",width:312,hideLabel:!0,name:"notebook_name",allowBlank:!1,enableKeyEvents:!0,value:e,validator:function(i){if(Ext.isEmpty(i.trim()))return this.blankText;if("rename_tag"===t.type||"create_tag"===t.type){var n=this.findWindow().tagParent.getValue();i=SYNO.SDS.NoteStation.Utils.combineToFullTag(n,i),e=SYNO.SDS.NoteStation.Utils.combineToFullTag(t.ori_parent,t.ori_title)}return e===i||-1===o.indexOf(i)},listeners:{keyup:function(t,e){if(13===e.keyCode)return""===t.getValue().trim()?void t.setValue(""):void this.onOk()},scope:this}});var i=[{xtype:"syno_displayfield",itemCls:"syno-ns-form-display-field",value:t.message+SYNO.SDS.NoteStation._T("common","colon"),hideLabel:!0},this.textField];return i=i.concat(this.getExtensionItemCfg(t)),this.formPanel=new SYNO.SDS.NoteStation.Operate.FormPanel({items:i}),this.formPanel},getExtensionItemCfg:function(t){return"rename_tag"!==t.type&&"create_tag"!==t.type?[]:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("tag","select_parent")+SYNO.SDS.NoteStation._T("common","colon"),hideLabel:!0},this.tagParent=new SYNO.ux.ComboBox({width:312,hideLabel:!0,tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" style="{[this.getStyle(values)]}">',"{values.text:htmlEncode}","</div>","</tpl>",{getStyle:function(t){var e=8;return"padding-left: "+(e+=10*t.level)+"px;"}}),value:t.ori_parent,store:this.getTagStore(t.tag_id),displayField:"text",valueField:"title",mode:"local"})]},getTagStore:function(t){if(Ext.isEmpty(this.tagStore)){var e,o=[{text:"",title:"",id:""}],i=this.findAppWindow(),n=SYNO.SDS.NoteStation.Utils.parseTagStructure(i.tag);!function i(n,s){Ext.iterate(n,function(n){if(n.id===t)return void(e=n);o.push({text:n.text,title:n.title,level:s,id:n.id}),i(n.items,s+1)})}(n,0),this.tagStore=new Ext.data.JsonStore({autoDestroy:!0,fields:["text","title","id","level"],data:o}),this.move_target=e}return this.tagStore},setTrimValue:function(){var t=this.textField.getValue().trim();this.textField.setValue(t)},onOk:function(){this.setTrimValue(this.textField),this.formPanel.getForm().isValid()&&(this.applyForm(),this.close())},onCancel:function(){this.close()},applyForm:function(){var t,e=this.findAppWindow(),o=e.getMainPanel(),i=this.textField.getValue();if("create_notebook"===this.type)e.fireEvent("beforedataload","notebook"),e.getStorage().createNotebook({title:Ext.isEmpty(i)?SYNO.SDS.NoteStation._T("notebook","untitled"):i,callback:o.afterCreateNotebook,scope:o});else if("rename_notebook"===this.type)e.getStorage().setNotebook({object_id:this.object_id,title:i,callback:function(t,n){if(!0!==t)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(e,n);o.getNotebookPanel().updateNotebook(this.object_id,{title:i,text:i}),o.getEditorPanel().updateData({object_id:this.object_id,title:i}),Ext.isFunction(this.callback)&&this.callback.call(this.callback_scope||window,this.object_id,i)},scope:this});else if("rename_tag"===this.type){var n,s=o.getNotebookPanel(),a=this.tagParent.getValue();if((t=SYNO.SDS.NoteStation.Utils.getTagParent(this.move_target.title,this.move_target.text))===a&&i===this.move_target.text)return void this.close();n=SYNO.SDS.NoteStation.Utils.combineToFullTag(t,i),this.move_target.title=n,this.move_target.text=i;var r=[],l=this.move_target;r.push(Ext.apply({prefix:l.title.substr(0,l.title.length-l.text.length),all_separator:SYNO.SDS.NoteStation.Utils.isSeparatorTag(l.text)},this.move_target)),Ext.iterate(l.items,function(t){var e=t.title.substr(0,t.title.length-t.text.length),o=SYNO.SDS.NoteStation.Utils.isSeparatorTag(t.text);r=r.concat(SYNO.SDS.NoteStation.Utils.getAllChildTags(t,e,o))},this);var d=[];Ext.iterate(r,function(t){a=this.tagParent.getValue(),t.title!==this.move_target.title&&(a=SYNO.SDS.NoteStation.Utils.combineToFullTag(a,i));var e=SYNO.SDS.NoteStation.Utils.combineToFullTag(a,t.title.substr(t.prefix.length),t.all_separator);d.push({tag_id:t.id,title:e})},this),s.setStatusBusy(),e.mainPanel.editorPanel.normalPanel.saveNote(function(){e.getStorage().batchSetTag({tag:d,scope:this,callback:function(t,o){t&&!o.has_fail||SYNO.SDS.NoteStation.Utils.showErrorMsg(e,SYNO.API.Util.Response(o)),s.clearStatusBusy(),e.loadTagAndShortcut.call(e,function(){var t=d[0].title+"@"+e.uid_map[this._S("user")];e.selectTag(t),e.mainPanel.editorPanel.reloadNote()}),Ext.isFunction(this.callback)&&this.callback.call(this.callback_scope||window,this.tag_id,i)}})},this)}else"create_tag"===this.type?(t=this.tagParent.getValue(),i=SYNO.SDS.NoteStation.Utils.combineToFullTag(t,i),Ext.isFunction(this.callback)&&this.callback.call(this.callback_scope||window,t,i)):"create_smart"===this.type?(e.fireEvent("beforedataload","smart"),e.getStorage().createSmart({title:Ext.isEmpty(i)?SYNO.SDS.NoteStation._T("notebook","untitled"):i,query:this.query,callback:o.afterCreateSmart,scope:o})):"rename_smart"===this.type&&e.getStorage().setSmart({object_id:this.object_id,title:i,callback:function(t,n){if(!0!==t)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(e,n);o.getNotebookPanel().updateNotebook(this.object_id,{title:i,text:i}),Ext.isFunction(this.callback)&&this.callback.call(this.callback_scope||window,this.object_id,i)},scope:this})}}),Ext.define("SYNO.SDS.NoteStation.Operate.FormPanel",{extend:"SYNO.ux.FormPanel",constructor:function(t){var e=Ext.apply({bodyStyle:"padding: 0",autoHeight:!0},t);e.cls?e.cls+=" syno-ns-operate-form":e.cls="syno-ns-operate-form",this.callParent([e])}}),Ext.define("SYNO.SDS.NoteStation.Rename.Window",{extend:"SYNO.SDS.NoteStation.Operate.Window",constructor:function(t){var e=this;this.callParent([t]),this.dialogPromise=new Promise(function(t){e.resolveFn=t})},applyForm:function(){this.resolveFn(this.getValueEx())},getValueEx:function(){return{name:this.textField.getValue()}},getDialogPromise:function(){return this.dialogPromise},onCancel:function(){this.resolveFn(null),this.callParent(arguments)}}),Ext.define("SYNO.SDS.NoteStation.RenameStack.Window",{extend:"SYNO.SDS.NoteStation.Rename.Window",constructor:function(t){this.callParent([Object.assign({title:SYNO.SDS.NoteStation._T("stack","rename"),message:SYNO.SDS.NoteStation._T("stack","create_title")},t)])},getInvalidWords:function(){return Object.values(this.findAppWindow().owned.stack).map(function(t){return t.title})}}),Ext.define("SYNO.SDS.NoteStation.Stack.Window",{extend:"SYNO.SDS.NoteStation.Operate.Window",getExtensionItemCfg:function(t){var e=t.notebookIds,o=this.getNotebookSuperBox(e),i=this.findAppWindow();return o.setValueEx(e.map(function(t){var e=i.owned.notebook[t];return e?{notebook:e.title,id:e.id}:null}).filter(function(t){return t})),[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("stack","add_notebook_to_stack")},this.notebookSuperBox]},getNotebookSuperBox:function(t){if(!this.notebookSuperBox){var e=this.findAppWindow(),o=new Ext.data.SimpleStore({fields:["notebook","id"]}),i=[];Ext.iterate(e.owned.notebook,function(e,o){if(!o.stack||t.includes(e)){var n=new Ext.data.Record({notebook:o.title,id:o.id});i.push(n)}}),o.add(i),this.notebookSuperBox=new SYNO.ux.SuperBoxSelect({store:o,mode:"local",displayField:"notebook",valueField:"id",allowBlank:!1,hideLabel:!0,listeners:{addItem:this.doLayout,removeItem:this.doLayout,scope:this}})}return this.notebookSuperBox},applyForm:function(){var t=this.findAppWindow(),e=this.textField.getValue();t.getMainPanel().moveNotebooksToStack(this.getNotebookSuperBox().getValueEx().map(function(t){return t.id}),e)}}),Ext.define("SYNO.SDS.NoteStation.Notify.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e={width:450,autoHeight:!0,layout:"fit",items:this.getNotifyFormPanel(t),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),scope:this,handler:this.onClickOk}]};return this.notify_handler={callback:t.callback,scope:t.scope},delete t.callback,delete t.scope,Ext.apply(e,t)},getNotifyFormPanel:function(t){return this.notifyPanel||(this.notifyPanel=new SYNO.SDS.NoteStation.Operate.FormPanel({items:[{xtype:"syno_displayfield",value:t.notify_text},{name:"notify_checkbox",xtype:"syno_checkbox",boxLabel:SYNO.SDS.NoteStation._T("common","skip_notify")}]})),this.notifyPanel},onClickCancel:function(){Ext.isFunction(this.notify_handler.callback)&&this.notify_handler.callback.call(this.notify_handler.scope,"no"),this.close()},onClickOk:function(){!0===this.getNotifyFormPanel().getForm().findField("notify_checkbox").getValue()&&Ext.isString(this.notify_state)&&this.findAppWindow().appInstance.setUserSettings(this.notify_state,!0),Ext.isFunction(this.notify_handler.callback)&&this.notify_handler.callback.call(this.notify_handler.scope,"yes"),this.close()}}),Ext.define("SYNO.SDS.NoteStation.Move.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e]),this.notebookStore.loadData(this.getNotebookData())},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("common","move"),width:450,autoHeight:!0,layout:"fit",items:this.getMoveFormPanel(),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),scope:this,handler:this.onClickOk}],listeners:{beforeshow:function(){var t,e=this.findAppWindow();t=Ext.isEmpty(e.owned.choosed)?e.owned.preset_id:e.owned.choosed,this.notebookComboBox.setValue(t)},scope:this}};return Ext.apply(e,t)},getMoveFormPanel:function(){return this.notebookStore=new Ext.data.JsonStore({autoDestroy:!0,fields:["notebook_title","notebook_id"]}),this.notebookComboBox=new SYNO.ux.ComboBox({xtype:"syno_combobox",fieldLabel:SYNO.SDS.NoteStation._T("info","notebook"),store:this.notebookStore,displayField:"notebook_title",valueField:"notebook_id",name:"parent_id",mode:"local",allowBlank:!1,enableKeyEvents:!0,listeners:{keyup:function(t,e){13===e.keyCode&&this.onClickOk()},scope:this},scope:this}),this.moveFormPanel=new SYNO.SDS.NoteStation.Operate.FormPanel({items:[this.notebookComboBox]}),this.moveFormPanel},onClickCancel:function(){this.close()},onClickOk:function(){var t=this.findAppWindow(),e=t.getMainPanel();this.moveFormPanel.getForm().isValid()&&(e.moveNotesToNotebook(this.object_id,this.notebookComboBox.getValue()),this.close())},getNotebookData:function(){var t=SYNO.SDS.NoteStation.Window,e=[];if(!Ext.isEmpty(t))return Ext.iterate(t.owned.notebook,function(t,o){!0===o.owned&&!0!==o.archive&&e.push({notebook_title:Ext.util.Format.htmlEncode(o.title),notebook_id:o.id})},this),e}}),Ext.define("SYNO.SDS.NoteStation.CopyTo.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e]),this.notebookStore.loadData(this.getNotebookData())},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("common","copy"),width:450,autoHeight:!0,layout:"fit",items:this.getCopyToFormPanel(),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),scope:this,handler:this.onClickOk}],listeners:{beforeshow:function(){var t,e=this.findAppWindow();t=Ext.isEmpty(e.owned.choosed)?e.owned.preset_id:e.owned.choosed,this.notebookComboBox.setValue(t)},scope:this}};return Ext.apply(e,t)},getCopyToFormPanel:function(){return this.notebookStore=new Ext.data.JsonStore({autoDestroy:!0,fields:["notebook_title","notebook_id"]}),this.notebookComboBox=new SYNO.ux.ComboBox({xtype:"syno_combobox",fieldLabel:SYNO.SDS.NoteStation._T("info","notebook"),store:this.notebookStore,displayField:"notebook_title",valueField:"notebook_id",name:"parent_id",mode:"local",allowBlank:!1,listeners:{keyup:function(t,e){13===e.keyCode&&this.onClickOk()},scope:this},scope:this}),this.CopyToFormPanel=new SYNO.SDS.NoteStation.Operate.FormPanel({items:[this.notebookComboBox],scope:this}),this.CopyToFormPanel},onClickCancel:function(){Ext.isObject(this.cancleCallback)&&this.cancleCallback.cb.call(this.cancleCallback.scope),this.close()},onClickOk:function(){var t=this.findAppWindow(),e=t.getMainPanel(),o=this.CopyToFormPanel.getForm(),i=Ext.copyTo({},this.param,"object_id,title,title_postfix,ver");i.parent_id=this.notebookComboBox.getValue(),o.isValid()&&(e.copyNote(i),Ext.isObject(this.okCallback)&&this.okCallback.cb.call(this.okCallback.scope),this.close())},getNotebookData:function(){var t=SYNO.SDS.NoteStation.Window,e=[];if(!Ext.isEmpty(t))return Ext.iterate(t.owned.notebook,function(t,o){!0===o.owned&&e.push({notebook_title:Ext.util.Format.htmlEncode(o.title),notebook_id:o.id})},this),e}}),Ext.define("SYNO.SDS.NoteStation.Copy.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){return Ext.apply({layout:"fit",autoHeight:!0,width:400,items:[new SYNO.SDS.NoteStation.Operate.FormPanel({itemId:"main_panel",items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("error","copy_note_link")},{xtype:"syno_displayfield",itemId:"link_field",cls:"syno-ns-link-copy-field",value:t.copy_content,hideLabel:!0,htmlEncode:!1}]})],buttons:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","close"),scope:this,handler:function(){Ext.isFunction(t.close_callback)&&t.close_callback(),this.close()}}],listeners:{scope:this,show:function(t){function e(t){if(window.getSelection&&document.createRange){var e=window.getSelection(),o=document.createRange();o.selectNodeContents(t),e.removeAllRanges(),e.addRange(o)}else if(document.selection&&document.body.createTextRange){var i=document.body.createTextRange();i.moveToElementText(t),i.select()}}var o=t.getComponent("main_panel").getComponent("link_field").el.dom;e.defer(100,this,[o])}}},t)}}),Ext.define("SYNO.SDS.NoteStation.CtxMenu",{extend:"SYNO.ux.Menu",constructor:function(t){var e=this.fillConfig(t);this.cancel_click_fn=function(){return!1},this.callParent([e])},fillConfig:function(t){this.menuMap={emptyMenu:[],shortcutMenu:[0],noteHeaderMenu:[30],notebookHeaderMenu:[1,31],notebookMenu:[2,5,19,32,20,3,"-",18,23,4],notebookDefaultMenu:[2,5,19,32,20,"-",4],notebookDeletedMenu:[14],notebookArchiveMenu:[2,3,24],noteCommonMenuEncrypted:[5,8,29,3,"-",13,15,6,"-",4,7,22,28,21,16,26],noteCommonMenuDecrypted:[5,8,17,3,"-",13,15,6,"-",4,7,22,28,21,16,26],noteArchiveMenu:[8,3,6,"-",7,22,28,21,16,26],noteCommonMenuMultiSelected:[5,3,13,15],noteArchiveMenuMultiSelected:[3],notePublicMenu:[6,7],noteJoinedMenu:[5,8,13,6,7,9,26],noteJoinedMenuMultiSelected:[5,9,13],notebookJoinedMenu:[9],tagHeaderMenu:[],tagMenu:[2,10,5],recycleMenu:[11,12],stackMenu:[2,5,25],smartCommonMenu:[3,4,5,8],smartJoinedMenu:[5,9],smartHeaderMenu:[27]};var e={cls:"syno-ns-notebook-menu",isShowMenu:!1,items:[]};return this.menu_item_config=[{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("shortcut","remove"),itemAction:"remove_shortcut"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("notebook","create"),itemAction:"create_notebook"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("common","rename"),itemAction:"rename"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("common","delete"),itemAction:"delete"},{text:SYNO.SDS.NoteStation._T("common","share"),itemAction:"share"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("common","add_to_shortcut"),itemAction:"add_to_shortcut",listeners:{beforerender:function(t){if(!_S("demo_mode")){if(this.isMultiSelected)return t.disable(),void this.object_id_array.forEach(function(e){if(!(e in this.findAppWindow().shortcut))return void t.enable()},this);this.getTargetId("tag_id")in this.findAppWindow().shortcut?t.disable():t.enable()}},scope:this}},{text:SYNO.SDS.NoteStation._T("common","open_note_in_new_tab"),itemAction:"open_note_in_new_tab"},{text:SYNO.SDS.NoteStation._T("common","print"),itemAction:"print"},{text:SYNO.SDS.NoteStation._T("common","edit"),itemAction:"edit"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("common","leave"),itemAction:"leave"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("tag","remove_from_all"),itemAction:"delete_tag"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("common","restore"),itemAction:"restore"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("common","delete"),itemAction:"remove"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("common","copy"),itemAction:"copy"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("common","empty_recycle"),itemAction:"empty_recycle_bin"},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("common","move_to"),menu:{xtype:"syno_menu",cls:"syno-ns-menu",items:[]},listeners:{beforerender:function(t){var e=this.findAppWindow(),o=[];new Set(this.object_id_array.map(function(t){return e.owned.note[t].parent_id}).filter(function(t){return!!e.owned.notebook[t]})).forEach(function(t){o.push(t)}),SYNO.SDS.NoteStation.Utils.showNotebookMenu(t.menu,e,function(e){return 1===o.length&&o[0]===e.id?null:function(o){t.menu_callback.call(t.menu_scope,{itemAction:"move",object_id:e.id})}})},scope:this}},{text:SYNO.SDS.NoteStation._T("common","info"),itemAction:"info"},{text:SYNO.SDS.NoteStation._T("tooltip","encrypt"),itemAction:"encrypt"},{text:SYNO.SDS.NoteStation._T("common","set_as_preset"),itemAction:"preset"},{text:SYNO.SDS.NoteStation._T("common","add_to_stack"),itemAction:"add_to_stack",menu:{xtype:"syno_menu",items:[]},listeners:{beforerender:function(t){var e,o=this.findAppWindow();return e=this.getTargetId(),Ext.isEmpty(e)||Ext.isEmpty(o.owned.notebook[e])?void t.hide():Ext.isEmpty(o.owned.notebook[e].stack)?void this.fillStackMenu(t.menu,t.menu_callback,t.menu_scope):void t.hide()},scope:this}},{text:SYNO.SDS.NoteStation._T("common","remove_from_stack"),itemAction:"remove_from_stack",listeners:{beforerender:function(t){var e,o=this.findAppWindow();if(e=this.getTargetId(),Ext.isEmpty(e)||Ext.isEmpty(o.owned.notebook[e])||Ext.isEmpty(o.owned.notebook[e].stack))return void t.hide()},scope:this}},{text:SYNO.SDS.NoteStation._T("common","send_as_mail"),itemAction:"mail",listeners:{beforerender:function(t){if(!SYNO.SDS.NoteStation.Utils.supportPersonalMail())return void t.hide()},scope:this}},{text:SYNO.SDS.NoteStation._T("export","note"),itemAction:"export"},{text:SYNO.SDS.NoteStation._T("notebook","archive"),itemAction:"archive_notebook"},{text:SYNO.SDS.NoteStation._T("notebook","unarchive"),itemAction:"unarchive_notebook"},{text:SYNO.SDS.NoteStation._T("stack","disassemble"),itemAction:"delete_stack"},{text:SYNO.SDS.NoteStation._T("note","copy_link"),itemAction:"note_link",noStopEvent:!0,listeners:{afterrender:function(t){var e,o,i,n,s=this.findAppWindow();e=this.getTargetId();var a=null;if(Ext.isObject(this.object_info)&&"smart"===this.object_info.perm_from&&Ext.isString(this.object_info.smart_id)&&(a=this.object_info.smart_id),i=SYNO.SDS.NoteStation.Utils.getInternalLink(e,a),Ext.isEmpty(i))return void t.disable();n=SYNO.SDS.NoteStation.Utils.genElementToCopy(i),n.id=Ext.id(),document.body.appendChild(n),o=new SYNO.SDS.ClipBoardUtil({handlerId:t.el.dom.id,clipTarget:n.id}),t.mon(o,"clipsucceed",function(t){Ext.removeNode(n)},this),t.mon(o,"clipfailed",function(t){new SYNO.SDS.NoteStation.Copy.Window({owner:s,title:SYNO.SDS.NoteStation._T("note","copy_link"),copy_content:n.innerHTML,close_callback:function(){Ext.removeNode(n)}}).show()},this),t.on("destory",function(t){Ext.removeNode(n)})},scope:this}},{text:SYNO.SDS.NoteStation._T("smart","create"),itemAction:"create_smart"},{text:SYNO.SDS.NoteStation._T("export","word"),itemAction:"export_word"},{text:SYNO.SDS.NoteStation._T("tooltip","decrypt"),itemAction:"encrypt"},{text:SYNO.SDS.NoteStation._T("note","create"),itemAction:"create_note"},{text:SYNO.SDS.NoteStation._T("stack","create"),itemAction:"create_stack"},{text:SYNO.SDS.NoteStation._T("common","move_to"),menu:{xtype:"syno_menu",items:[]},listeners:{beforerender:function(t){var e=this.getTargetId(),o=this.findAppWindow();return Ext.isEmpty(e)||Ext.isEmpty(o.owned.notebook[e])?void t.hide():Ext.isEmpty(o.owned.notebook[e].stack)?void t.hide():void this.fillStackMenu(t.menu,t.menu_callback,t.menu_scope)},scope:this}}],Ext.apply(e,t)},fillStackMenu:function(t,e,o){var i=this.findAppWindow(),n=this.getTargetId(),s=SYNO.SDS.NoteStation.Utils.getStackId(i.owned.notebook[n].stack),a=i.owned.stack;t.removeAll(),Ext.iterate(a,function(i,n){i!==s&&t.addItem({text:n.title,itemAction:"add_to_exist_stack",listeners:{click:{fn:e,scope:o,single:!0}}})}),t.items.length>0&&t.addItem("-"),t.addItem({text:SYNO.SDS.NoteStation._T("stack","new"),itemAction:"add_to_new_stack",listeners:{click:{fn:e,scope:o,single:!0}}})},filterMenuItem:function(t,e,o){if(Ext.isEmpty(t))return void(this.isShowMenu=!1);this.isShowMenu=!0,this.removeAll(),Ext.iterate(t,function(t,i){var n;"-"===t?this.addMenuItem({xtype:"menuseparator"}):(n=this.addMenuItem(Ext.apply({menu_callback:e,menu_scope:o},this.menu_item_config[t])),Ext.isFunction(e)&&(Ext.isObject(n.menu)?(n.un("click",this.cancel_click_fn),n.on("click",this.cancel_click_fn)):n.on("click",e,o,{single:!0})))},this)},getMenu:function(t,e,o,i){var n,s,a,r,l,d,c=[],h=this.findAppWindow();if(!Ext.isObject(t)&&!Ext.isElement(t))return void(this.isShowMenu=!1);if(this.target_node=t,this.applyExtraInfo(e),Ext.isFunction(t.getAttribute)?(n=t.getAttribute("category"),s=t.getAttribute("type")):(n=t.attributes.category,s=t.attributes.type,a=t.parentNode),Ext.isEmpty(a)?Ext.isObject(t.parent_info)&&(a=!0,r=t.parent_info.category,l=t.parent_info.type):(r=a.attributes.category,l=a.attributes.type),this.filterMenuItem(this.menuMap.emptyMenu),!Ext.isEmpty(a)){if(SYNO.SDS.NoteStation.Define.CATEGORY==r&&SYNO.SDS.NoteStation.Define.SHORTCUT==l)return void this.filterMenuItem(this.menuMap.shortcutMenu,o,i);if(SYNO.SDS.NoteStation.Define.NOTEBOOK===r&&SYNO.SDS.NoteStation.Define.DELETED===l)return void this.filterMenuItem(this.menuMap.recycleMenu,o,i)}SYNO.SDS.NoteStation.Define.CATEGORY==n?SYNO.SDS.NoteStation.Define.NOTE===s?this.filterMenuItem(this.menuMap.noteHeaderMenu,o,i):SYNO.SDS.NoteStation.Define.NOTEBOOK==s?this.filterMenuItem(this.menuMap.notebookHeaderMenu,o,i):SYNO.SDS.NoteStation.Define.TAG==s?this.filterMenuItem(this.menuMap.tagHeaderMenu,o,i):SYNO.SDS.NoteStation.Define.SMART===s&&this.filterMenuItem(this.menuMap.smartHeaderMenu,o,i):SYNO.SDS.NoteStation.Define.SMART==n?SYNO.SDS.NoteStation.Define.COMMON==s?this.filterMenuItem(this.menuMap.smartCommonMenu,o,i):SYNO.SDS.NoteStation.Define.JOINED==s&&this.filterMenuItem(this.menuMap.smartJoinedMenu,o,i):SYNO.SDS.NoteStation.Define.NOTEBOOK==n?SYNO.SDS.NoteStation.Define.COMMON==s||SYNO.SDS.NoteStation.Define.SHARED==s?this.filterMenuItem(this.menuMap.notebookMenu,o,i):SYNO.SDS.NoteStation.Define.DELETED==s?this.filterMenuItem(this.menuMap.notebookDeletedMenu,o,i):SYNO.SDS.NoteStation.Define.JOINED==s?this.filterMenuItem(this.menuMap.notebookJoinedMenu,o,i):SYNO.SDS.NoteStation.Define.DEFAULT==s?this.filterMenuItem(this.menuMap.notebookDefaultMenu,o,i):SYNO.SDS.NoteStation.Define.ARCHIVE===s&&this.filterMenuItem(this.menuMap.notebookArchiveMenu,o,i):SYNO.SDS.NoteStation.Define.TAG==n?SYNO.SDS.NoteStation.Define.COMMON==s&&this.filterMenuItem(this.menuMap.tagMenu,o,i):SYNO.SDS.NoteStation.Define.NOTE==n?SYNO.SDS.NoteStation.Utils.isPublicShare?this.isMultiSelected||this.filterMenuItem(this.menuMap.notePublicMenu,o,i):SYNO.SDS.NoteStation.Define.COMMON==s||SYNO.SDS.NoteStation.Define.SHARED==s?this.isMultiSelected?this.filterMenuItem(this.menuMap.noteCommonMenuMultiSelected,o,i):this.isEncryptedNote?this.filterMenuItem(this.menuMap.noteCommonMenuEncrypted,o,i):this.filterMenuItem(this.menuMap.noteCommonMenuDecrypted,o,i):SYNO.SDS.NoteStation.Define.JOINED==s?(d=this.object_id_array[0],this.isMultiSelected?this.filterMenuItem(this.menuMap.noteJoinedMenuMultiSelected,o,i):(Ext.apply(c,this.menuMap.noteJoinedMenu),d in h.joined.note&&"ro"===h.joined.note[d].perm&&c.remove(8),this.filterMenuItem(c,o,i))):SYNO.SDS.NoteStation.Define.ARCHIVE===s&&(this.isMultiSelected?this.filterMenuItem(this.menuMap.noteArchiveMenuMultiSelected,o,i):this.filterMenuItem(this.menuMap.noteArchiveMenu,o,i)):SYNO.SDS.NoteStation.Define.STACK===n&&this.filterMenuItem(this.menuMap.stackMenu,o,i)},applyExtraInfo:function(t){this.isMultiSelected=!1,this.object_id_array=[],this.isEncryptedNote=!1,this.object_info={},Ext.isObject(t)&&(Ext.copyTo(this,t,"isMultiSelected, object_id_array, isEncryptedNote"),Ext.copyTo(this.object_info,t,"perm_from, smart_id"))},getTargetId:function(t){var e=this.target_node;return Ext.isFunction(e.getAttribute)?t&&e.getAttribute(t)||e.getAttribute("object_id")||e.getAttribute("ref_id"):t&&e.attributes[t]||e.attributes.object_id||e.attributes.ref_id}}),Ext.define("SYNO.SDS.NoteStation.Notebook.DragZone.FullMenu",{extend:"Ext.dd.DragZone",constructor:function(t,e){this.component=t,this.callParent([t.getEl(),this.fillConfig(e)])},fillConfig:function(t){var e={};return Ext.apply(e,t)},getDragData:function(t){var e,o,i,n,s,a,r;return t.preventDefault(),e=this.component.getSelectionModel(),i=e.getSelectedNodes(),s=i.length,
o=t.getTarget("div.x-tree-node-el"),!Ext.isEmpty(o)&&(s<=1&&(i=[this.owner.getNodeById(o.getAttribute("ext:tree-node-id"))]),r=this.getDragNodeDataArray(i),!Ext.isEmpty(r)&&(!this.findItemByData(r,SYNO.SDS.NoteStation.Define.CATEGORY)&&(!this.findItemByNode(i,SYNO.SDS.NoteStation.Define.CATEGORY,SYNO.SDS.NoteStation.Define.SHORTCUT)&&(n=document.createElement("div"),n.className="syno-ns-notebook-dd-preview",s>1?(a=document.createElement("div"),a.textContent=String.format("Multiple items({0})",s)):a=o.cloneNode(!0),n.appendChild(a),{nodeDataArray:r,target:o,ddel:n}))))},getDragNodeDataArray:function(t){var e=[];return Ext.isArray(t)?(Ext.each(t,function(t){Ext.isEmpty(t)||e.push(t.attributes)},this),e):e},getRepairXY:function(t){return Ext.Element.fly(this.dragData.target).getXY()},findItemByData:function(t,e){var o=!1;return Ext.each(t,function(t){if(e===t.category)return o=!0,!1},this),o},findItemByNode:function(t,e,o){var i,n,s=!1;return Ext.each(t,function(t){if(i=t.parentNode,!Ext.isEmpty(i))return n=i.attributes,e===n.category&&o===n.type?(s=!0,!1):void 0},this),s}}),Ext.define("SYNO.SDS.NoteStation.Notebook.DropTarget.FullMenu",{extend:"Ext.dd.DropTarget",constructor:function(t,e){this.component=t,this.callParent([t.getEl(),this.fillConfig(e)])},fillConfig:function(t){var e={};return Ext.apply(e,t)},getAllowTypeArray:function(t){return SYNO.SDS.NoteStation.Notebook.DropTarget.FullMenu[t]},statics:{NoteToNotebook:[SYNO.SDS.NoteStation.Define.COMMON,SYNO.SDS.NoteStation.Define.SHARED,SYNO.SDS.NoteStation.Define.DEFAULT],NotebookToDeleted:[SYNO.SDS.NoteStation.Define.COMMON,SYNO.SDS.NoteStation.Define.SHARED],NoteToDeleted:[SYNO.SDS.NoteStation.Define.COMMON,SYNO.SDS.NoteStation.Define.SHARED],NotebookToShortCut:[SYNO.SDS.NoteStation.Define.COMMON,SYNO.SDS.NoteStation.Define.DEFAULT,SYNO.SDS.NoteStation.Define.SHARED,SYNO.SDS.NoteStation.Define.JOINED],NoteToShortcut:[SYNO.SDS.NoteStation.Define.COMMON,SYNO.SDS.NoteStation.Define.JOINED,SYNO.SDS.NoteStation.Define.SHARED],TagToShortcut:[SYNO.SDS.NoteStation.Define.COMMON],TagToTag:[SYNO.SDS.NoteStation.Define.COMMON],StackToShortcut:[SYNO.SDS.NoteStation.Define.STACK],NotebookToNotebook:[SYNO.SDS.NoteStation.Define.COMMON,SYNO.SDS.NoteStation.Define.DEFAULT],NotebookToStack:[SYNO.SDS.NoteStation.Define.COMMON,SYNO.SDS.NoteStation.Define.DEFAULT],SmartToShortcut:[SYNO.SDS.NoteStation.Define.COMMON]},ddTarget:null,notifyOver:function(t,e,o){var i,n;if(!(i=this.getShortcutItemsTarget(e)||this.getShortcutTitleTarget(e)))return t.endDrag(),!1;if(n=this.getDropTargetNodeAttr(i),Ext.isEmpty(n))return t.endDrag(),!1;if(SYNO.SDS.NoteStation.Define.SHORTCUT===n.type&&this.checkAllowDropToShortcut(t,e,o))return this.dropAllowed;if(i=e.getTarget("div"),n=this.getDropTargetNodeAttr(i),Ext.isEmpty(n))return t.endDrag(),!1;if(SYNO.SDS.NoteStation.Define.NOTEBOOK===n.category){if(SYNO.SDS.NoteStation.Define.DELETED===n.type){if(this.checkAllowDropToDeleted(t,e,o))return this.dropAllowed}else if(SYNO.SDS.NoteStation.Define.COMMON===n.type||SYNO.SDS.NoteStation.Define.SHARED===n.type||SYNO.SDS.NoteStation.Define.DEFAULT===n.type){if(this.checkAllowDropToNotebook(t,e,o,n))return this.dropAllowed}else if(("all"===n.ref_id||"shared"===n.ref_id)&&this.checkAllowDroptoVirtualNode(t,e,o,n))return this.dropAllowed}else if(SYNO.SDS.NoteStation.Define.STACK===n.category&&this.checkAllowDropToStack(t,e,o))return this.dropAllowed;return i=e.getTarget("div"),n=this.getDropTargetNodeAttr(i),Ext.isEmpty(n)?(t.endDrag(),!1):SYNO.SDS.NoteStation.Define.TAG!==n.category&&SYNO.SDS.NoteStation.Define.TAG!==n.type||!this.checkAllowDropToTag(t,e,o,n)?(t.endDrag(),!1):this.dropAllowed},notifyDrop:function(t,e,o){var i,n;if(_S("demo_mode"))return void SYNO.SDS.NoteStation.Utils.showErrorMsg(this.component.findAppWindow(),116);if(!(i=this.getShortcutItemsTarget(e)||this.getShortcutTitleTarget(e)))return t.endDrag(),!1;if(n=this.getDropTargetNodeAttr(i),Ext.isEmpty(n))return t.endDrag(),!1;if(SYNO.SDS.NoteStation.Define.SHORTCUT===n.type)return this.dropOnShortcut(t,e,o);if(i=e.getTarget("div"),n=this.getDropTargetNodeAttr(i),Ext.isEmpty(n))return t.endDrag(),!1;if(SYNO.SDS.NoteStation.Define.STACK===n.category)return this.dropOnStack(t,e,o,n);if(SYNO.SDS.NoteStation.Define.NOTEBOOK===n.category){if(SYNO.SDS.NoteStation.Define.DELETED===n.type)return this.dropOnDeleted(t,e,o);if(SYNO.SDS.NoteStation.Define.COMMON===n.type||SYNO.SDS.NoteStation.Define.SHARED===n.type||SYNO.SDS.NoteStation.Define.DEFAULT===n.type)return this.dropOnNotebook(t,e,o,n);if("all"===n.ref_id||"shared"===n.ref_id)return this.dropOnVirtualNode(t,e,o,n)}return i=e.getTarget("div"),n=this.getDropTargetNodeAttr(i),Ext.isEmpty(n)?(t.endDrag(),!1):SYNO.SDS.NoteStation.Define.TAG===n.category||SYNO.SDS.NoteStation.Define.TAG===n.type?this.dropOnTag(t,e,o,n):(t.endDrag(),!1)},getShortcutTitleTarget:function(t){var e;return e=t.getTarget("div.syno-ns-notebook-category-title"),!Ext.isEmpty(e)&&e},getShortcutItemsTarget:function(t){var e=t.getTarget("ul");if(Ext.isEmpty(e)||!e.previousSibling&&!e.nextSibling)return!1;for(var o=e;o.previousSibling;)o=o.previousSibling;return o},getDropTargetNodeAttr:function(t){var e;return Ext.isEmpty(t)?null:(e=SYNO.SDS.NoteStation.Utils.getFullMenuNodeAttr(t.getAttribute("ext:tree-node-id")),Ext.isEmpty(e)?null:e)},dropOnShortcut:function(t,e,o){var i,n=SYNO.SDS.NoteStation.Window,s=n.getMainPanel(),a=[],r=[],l=[];return this.checkAllowDropToShortcut(t,e,o)?(Ext.each(o.nodeDataArray,function(t,e){"tag"===t.category?r.push(t.tag_id||t.object_id):"stack"===t.category?l.push(t.ref_id||t.object_id):a.push(t.object_id)},this),i={tag_id:r,object_id:a,stack_id:l},s.addToShortcut(i),t.endDrag(),!0):(t.endDrag(),!1)},dropOnDeleted:function(t,e,o){var i,n,s,a=SYNO.SDS.NoteStation.Window,r=a.getMainPanel(),l=[];return s=a.getMsgBox(),this.checkAllowDropToDeleted(t,e,o)?!Ext.isEmpty(o.nodeDataArray)&&(i=o.nodeDataArray[0].category,SYNO.SDS.NoteStation.Define.NOTEBOOK===i?(Ext.each(o.nodeDataArray,function(t){l.push(t.object_id)},this),r.deleteNotebook(l)):(Ext.each(o.nodeDataArray,function(t){l.push(t.object_id)},this),n=String.format(SYNO.SDS.NoteStation._T("note","delete_to_recycle"),o.nodeDataArray.length),s.confirmDelete(SYNO.SDS.NoteStation._T("note","delete"),n,function(t,e){"yes"===t&&r.deleteNoteAsync(l)},this)),t.endDrag(),!0):(t.endDrag(),!1)},dropOnNotebook:function(t,e,o,i){var n,s=SYNO.SDS.NoteStation.Window,a=s.getMainPanel(),r=[],l=[];return this.checkAllowDropToNotebook(t,e,o,i)?(n=Ext.isEmpty(i.stack)?"":i.stack,Ext.each(o.nodeDataArray,function(t){"notebook"===t.category?(Ext.isEmpty(t.stack)||t.stack!==n)&&l.push(t.object_id):"note"===t.category&&r.push(t.object_id)},this),0<r.length&&a.moveNotesToNotebook(r,i.object_id),0<l.length&&(Ext.isEmpty(n)?(l.push(i.object_id),a.createStack(l)):a.moveNotebooksToStack(l,i.stack)),t.endDrag(),!0):(t.endDrag(),!1)},dropOnStack:function(t,e,o,i){var n=SYNO.SDS.NoteStation.Window,s=n.getMainPanel(),a=[];return this.checkAllowDropToStack(t,e,o)&&Ext.isObject(i)&&!Ext.isEmpty(i.text)?(Ext.each(o.nodeDataArray,function(t){a.push(t.object_id)},this),s.moveNotebooksToStack(a,i.text),t.endDrag(),!0):(t.endDrag(),!1)},dropOnTag:function(t,e,o,i){var n=SYNO.SDS.NoteStation.Window;if(!this.checkAllowDropToTag(t,e,o,i)||!Ext.isObject(i))return t.endDrag(),!1;var s=[];Ext.each(o.nodeDataArray,function(t){var e=t.title.substr(0,t.title.length-t.text.length),o=SYNO.SDS.NoteStation.Utils.isSeparatorTag(t.text);s=s.concat(SYNO.SDS.NoteStation.Utils.getAllChildTags(t,e,o))},this);var a=[],r=[];return Ext.each(s,function(t){var e=SYNO.SDS.NoteStation.Utils.combineToFullTag(i.title,t.title.substr(t.prefix.length),t.all_separator);e+"@"+SYNO.SDS.NoteStation.Window.uid_map[_S("user")]in SYNO.SDS.NoteStation.Window.tag&&r.push(e),a.push({tag_id:t.tag_id,title:e})},this),r.length>0?void n.getMsgBox().alert("",SYNO.SDS.NoteStation._T("error","tag_conflict")):(n.mainPanel.notebookPanel.setStatusBusy(),n.mainPanel.editorPanel.normalPanel.saveNote(function(){n.getStorage().batchSetTag({tag:a,scope:this,callback:function(t,e){t&&!e.has_fail||SYNO.SDS.NoteStation.Utils.showErrorMsg(n,SYNO.API.Response.GetFirstError(e)),n.mainPanel.notebookPanel.clearStatusBusy(),n.loadTagAndShortcut.call(n,function(){var t=a[0].title+"@"+n.uid_map[this._S("user")];n.selectTag(t),n.mainPanel.editorPanel.reloadNote()})}})},this),t.endDrag(),!0)},dropOnVirtualNode:function(t,e,o,i){var n=SYNO.SDS.NoteStation.Window,s=n.getMainPanel(),a=[];return this.checkAllowDroptoVirtualNode(t,e,o,i)?(Ext.each(o.nodeDataArray,function(t){a.push(t.object_id)},this),s.moveNotebooksToStack(a,""),t.endDrag(),!0):(t.endDrag(),!1)},checkAllowDropToNotebook:function(t,e,o,i){var n,s,a=!0;return a=!0,Ext.each(o.nodeDataArray,function(t){if(n=t.type,s=t.category,SYNO.SDS.NoteStation.Define.NOTE===s){if(-1!==this.getAllowTypeArray("NoteToNotebook").indexOf(n))return}else if(SYNO.SDS.NoteStation.Define.NOTEBOOK===s&&Ext.isObject(i)&&i.object_id!==t.object_id&&-1!==this.getAllowTypeArray("NotebookToNotebook").indexOf(n))return;return a=!1,!1},this),a},checkAllowDropToStack:function(t,e,o){var i,n,s=!0;return s=!0,Ext.each(o.nodeDataArray,function(t){if(i=t.type,n=t.category,SYNO.SDS.NoteStation.Define.NOTEBOOK!==n||-1===this.getAllowTypeArray("NotebookToStack").indexOf(i))return s=!1,!1},this),s},checkAllowDropToTag:function(t,e,o,i){var n,s,a,r,l=!0;return l=!0,Ext.each(o.nodeDataArray,function(t){if(n=t.type,s=t.category,t.tag_id===i.tag_id)return l=!1,!1;try{r=i.title===t.title,a=SYNO.SDS.NoteStation.Utils.checkTagIsParent(t.title,i.title)}catch(t){r=!1,a=!1}return SYNO.SDS.NoteStation.Define.TAG!==s||-1===this.getAllowTypeArray("TagToTag").indexOf(n)||a||r?(l=!1,!1):void 0},this),l},checkAllowDroptoVirtualNode:function(t,e,o){var i,n,s=!0;return s=!0,Ext.each(o.nodeDataArray,function(t){if(i=t.type,n=t.category,SYNO.SDS.NoteStation.Define.NOTEBOOK!==n||Ext.isEmpty(t.stack)||-1===this.getAllowTypeArray("NotebookToStack").indexOf(i))return s=!1,!1},this),s},checkAllowDropToDeleted:function(t,e,o){var i,n,s=!0;return s=!0,Ext.each(o.nodeDataArray,function(t){if(i=t.type,n=t.category,SYNO.SDS.NoteStation.Define.NOTEBOOK===n){if(-1!==this.getAllowTypeArray("NotebookToDeleted").indexOf(i))return}else if(SYNO.SDS.NoteStation.Define.NOTE===n&&-1!==this.getAllowTypeArray("NoteToDeleted").indexOf(i))return;return s=!1,!1},this),s},checkAllowDropToShortcut:function(t,e,o){var i,n,s=!0;return s=!0,Ext.each(o.nodeDataArray,function(t){if(i=t.type,n=t.category,SYNO.SDS.NoteStation.Define.NOTEBOOK===n){if(-1!==this.getAllowTypeArray("NotebookToShortCut").indexOf(i))return}else if(SYNO.SDS.NoteStation.Define.NOTE===n){if(-1!==this.getAllowTypeArray("NoteToShortcut").indexOf(i))return}else if(SYNO.SDS.NoteStation.Define.TAG===n){if(-1!==this.getAllowTypeArray("TagToShortcut").indexOf(i))return}else if(SYNO.SDS.NoteStation.Define.STACK===n){if(-1!==this.getAllowTypeArray("StackToShortcut").indexOf(i))return}else if(SYNO.SDS.NoteStation.Define.SMART===n&&-1!==this.getAllowTypeArray("SmartToShortcut").indexOf(i))return;return s=!1,!1},this),s}}),Ext.define("SYNO.SDS.NoteStation.Notebook.TreePanel.FullMenu",{extend:"SYNO.ux.TreePanel",updateScrollBarEventNames:["afterlayout","resize","expandnode","collapsenode","append"],constructor:function(t){var e;this.owner=t.owner,this.callParent([this.fillConfig(t)]),e=this.findAppWindow(),e.on("shortcutloaded",this.fillShortcutData,this),e.on("tagloaded",this.fillTagData,this),e.on("ownednotebookloaded",function(t){this.fillNoteData(t),this.fillNotebookData(t),this.fillArchiveData(t)},this),e.on("joinednotebookloaded",this.fillJoinedData,this,{buffer:100}),e.on("ownedtodoloaded",this.fillTodoData,this),e.on("ownedsmartloaded",this.fillSmartData,this)},fillConfig:function(t){var e=this.createLoader(t),o=this.findAppWindow().getPanelScope("SYNO.SDS.NoteStation.MainPanel").getCrossPanelCtxMenu(),i={width:200,ctxMenu:o,rootVisible:!1,useArrows:!0,animate:!0,autoScroll:!1,autoFlexcroll:!0,titleCollapse:!1,border:!1,loader:e,stateful:!0,stateEvents:["dblclick","collapsenode","expandnode"],initState:function(){var t,e=this.findAppWindow().appInstance;e&&(t=e.getUserSettings("notebook_full_menu_states"))&&!1!==this.fireEvent("beforestaterestore",this,t)&&this.fireEvent("staterestore",this,t)}.bind(this),saveState:function(){var t=this.findAppWindow().appInstance;t&&t.setUserSettings("notebook_full_menu_states",this.getState())}.bind(this),getState:function(){return{shortcut:this.getNodeById(this.shortcut_id).isExpanded(),todo:this.getNodeById(this.todo_id).isExpanded(),note:this.getNodeById(this.note_id).isExpanded(),notebook:this.getNodeById(this.notebook_id).isExpanded(),stack:this.getStackExpandedState(this.notebook_id),archive:this.getNodeById(this.archive_id).isExpanded(),joined:this.getNodeById(this.joined_id).isExpanded(),tag:this.getNodeById(this.tag_id).isExpanded(),smart:this.getNodeById(this.smart_id).isExpanded()}}.bind(this),selModel:new Ext.tree.MultiSelectionModel({listeners:{selectionchange:this.onNotebookListSelect,scope:this}}),root:new Ext.tree.AsyncTreeNode({id:"notebook_root",expand:!0,text:"root"}),listeners:{afterrender:{fn:function(t){this.dragZone=new SYNO.SDS.NoteStation.Notebook.DragZone.FullMenu(t,{ddGroup:"ns-dd-group",owner:this}),this.dropTarget=new SYNO.SDS.NoteStation.Notebook.DropTarget.FullMenu(t,{ddGroup:"ns-dd-group"}),this.initState()},single:!0,scope:this},activate:{fn:function(){SYNO.SDS.NoteStation.Utils.switchNotebookBtn("full")},scope:this},contextmenu:{fn:this.showCtxMenu,scope:this},staterestore:{fn:function(t,e){Ext.isObject(e)&&(!0===Ext.isObject(e.stack)&&(this.last_stack_expanded_state=e.stack,delete e.stack),Ext.iterate(e,function(t,e){var o=this.getNodeById(this[t+"_id"]);Ext.isEmpty(o)||(!0===e?o.expand():o.collapse())},this))},scope:this}}};return Ext.apply(i,t),i},proxyNodeEvent:function(t,e,o,i,n,s,a){return Ext.isIE9&&("collapse"==t||"expand"==t)&&this.el&&this.el.repaint(),"collapse"!=t&&"expand"!=t&&"beforecollapse"!=t&&"beforeexpand"!=t&&"move"!=t&&"beforemove"!=t||(t+="node"),this.fireEvent(t,e,o,i,n,s,a)},getStackExpandedState:function(t){var e=this.getNodeById(t),o={};return e?(Ext.iterate(e.childNodes,function(t){var e=t.attributes.ref_id||t.attributes.object_id;"stack"===t.attributes.category&&(o[e]=t.isExpanded())}),o):o},showCtxMenu:function(t,e){var o={isMultiSelected:!1};this.getSelectionModel().select(t),this.ctxMenu.getMenu(t,o,this.onClickCtxMenu,this),this.ctxMenu.isShowMenu&&this.ctxMenu.showAt(e.getXY())},onClickCtxMenu:function(t,e){var o=this.findAppWindow(),i=o.getMainPanel(),n=this.getSelectionModel().getSelectedNodes(),s=n[0];if("create_note"===t.itemAction)i.createNote(o.owned.preset_id);else if("create_notebook"===t.itemAction)i.createNotebook();else if("delete_stack"===t.itemAction){if(Ext.isEmpty(s))return;i.deleteStack(s.attributes.ref_id)}else if("create_stack"===t.itemAction)i.createStack([]);else if("delete"===t.itemAction){if(Ext.isEmpty(s))return;if("notebook"===s.attributes.category)i.deleteNotebook(s.attributes.object_id);else if("note"===s.attributes.category)i.deleteNoteAsync(s.attributes.object_id);else if("tag"===s.attributes.category)i.deleteTag(s.attributes.tag_id);else{if("smart"!==s.attributes.category)return;i.deleteSmart(s.attributes.object_id)}}else if("rename"===t.itemAction){if(Ext.isEmpty(s))return;"notebook"===s.attributes.category?i.renameNotebook(s.attributes.object_id,s.text):"tag"===s.attributes.category?i.renameTag(s.attributes.tag_id,s.attributes.text):"stack"===s.attributes.category?i.renameStackAsync(s.attributes.ref_id).then(function(t){t&&o.selectStack(SYNO.SDS.NoteStation.Utils.getStackId(t))}):"smart"===s.attributes.category&&i.renameSmart(s.attributes.object_id,s.text)}else if("add_to_shortcut"===t.itemAction){if(Ext.isEmpty(s))return;"stack"===s.attributes.category?i.addToShortcut({stack_id:s.attributes.ref_id}):i.addToShortcut(s.attributes)}else if("remove_shortcut"===t.itemAction){var a={};if(Ext.isEmpty(s))return;"tag"===s.attributes.category?a.tag_id=s.attributes.ref_id:"stack"===s.attributes.category?a.stack_id=s.attributes.ref_id:a.object_id=s.attributes.ref_id||s.attributes.object_id,i.removeFromShortcut(a)}else if("delete_tag"===t.itemAction){if(Ext.isEmpty(s))return;i.deleteTag(s.attributes.tag_id),i.getNotePanel().clearData()}else if("share"===t.itemAction){if(Ext.isEmpty(s))return;"notebook"===s.attributes.category?i.shareNotebook(s.attributes.object_id,o.loadAllDataAsync,o):"note"===s.attributes.category?i.shareNote(s.attributes.object_id,o.loadAllDataAsync,o):"smart"===s.attributes.category&&i.shareSmart(s.attributes.object_id,o.loadAllDataAsync,o)}else if("empty_recycle_bin"===t.itemAction){if(Ext.isEmpty(s))return;i.emptyRecycleBin()}else if("leave"===t.itemAction){if(Ext.isEmpty(s))return;i.deletePermission(s.attributes.object_id)}else if("preset"===t.itemAction){if(Ext.isEmpty(s))return;i.setAsPreset(s.attributes.object_id)}else{if("add_to_stack"===t.itemAction)return!1;"add_to_exist_stack"===t.itemAction?i.moveNotebooksToStack(s.attributes.object_id,t.text):"add_to_new_stack"===t.itemAction?i.createStack([s.attributes.object_id]):"remove_from_stack"===t.itemAction?i.moveNotebooksToStack(s.attributes.object_id,""):"archive_notebook"===t.itemAction?i.archiveNotebook(s.attributes.object_id,!0):"unarchive_notebook"===t.itemAction?i.archiveNotebook(s.attributes.object_id,!1):"edit"===t.itemAction?i.setSmart(s.attributes.object_id):"create_smart"===t.itemAction&&i.createSmart()}},sortNodeByTitle:function(t,e){var o,i,n,s;return!Ext.isArray(t)||Ext.isEmpty(e)?[]:(s=Ext.apply([],e),n=e.indexOf("text"),-1!==n&&(e[n]={name:"text",sortType:Ext.data.SortTypes.asUCString}),o=new Ext.data.JsonStore({fields:e}),o.loadData(t),o.sort([{field:"sort_order",direction:"ASC"},{field:"text",direction:"ASC"}]),i=[],o.each(function(t){i.push(Ext.copyTo({},t.data,s))},this),i)},fillTodoData:function(t){var e,o=[],i=!1,n="syno-ns-todo-fullmenu-{0}-icon";e=this.getNodeById(this.todo_id),i=e.isExpanded(),o=[{ref_id:"todo_all",text:SYNO.SDS.NoteStation._T("todo","all_tasks"),category:"todo",type:"all",total:t.todo.total,iconCls:String.format(n,"all")},{ref_id:"todo_star",text:SYNO.SDS.NoteStation._T("todo","starred"),category:"todo",type:"starred",total:t.star_todo.total,iconCls:String.format(n,"starred")},{ref_id:"todo_overdue",text:SYNO.SDS.NoteStation._T("todo","overdue"),category:"todo",type:"overdue",total:t.overdue_todo.total,iconCls:String.format(n,"overdue")},{ref_id:"todo_today",text:SYNO.SDS.NoteStation._T("todo","today"),category:"todo",type:"today",total:t.today_todo.total,iconCls:String.format(n,"today")},{ref_id:"todo_next_7_days",text:SYNO.SDS.NoteStation._T("todo","next_7_days"),category:"todo",type:"next_7_days",total:t.n7d_todo.total,iconCls:String.format(n,"next_7_days")}],0===e.childNodes.length?e.appendChild(o):o.forEach(function(t){e.replaceChild(new Ext.tree.TreeNode(Ext.apply({leaf:!0,uiProvider:SYNO.SDS.NoteStation.Notebook.TreeNodeUI},t)),e.findChild("ref_id",t.ref_id))}),!0===i&&e.expand()},getTagNodeItems:function(t){var e=[];return Ext.iterate(t,function(t){var o=0===t.items.length;e.push({tag_id:t.id,text:t.text,title:t.title,total:t.item_count,category:"tag",type:"common",items:this.getTagNodeItems(t.items),iconCls:String.format("syno-ns-notebook-fullmenu-{0}-common-icon",o?"tag":"tags"),leaf:o})},this),e},fillTagData:function(t){var e=this.getNodeById(this.tag_id),o=e.isExpanded();if(e.removeAll(),Ext.isObject(t)){var i=SYNO.SDS.NoteStation.Utils.parseTagStructure(t);e.appendChild(this.getTagNodeItems(i)),!0===o&&e.expand()}},_fillTreeData:function(t,e,o){var i=this.getNodeById(t),n=i.isExpanded();if(i.removeAll(),0===e.length)return void(o&&i.getUI().hide());i.getUI().show(),i.appendChild(e),!0===n&&i.expand(!1,!1)},fillShortcutData:function(t){var e=[],o=this.findAppWindow(),i=o.owned.preset_id;Ext.iterate(t,function(t,n){var s,a;!1===n.owned?(s=SYNO.SDS.NoteStation.Define.JOINED,"note"===n.category&&"rw"===o.joined.note[n.id].perm?s+="-editable":"notebook"===n.category&&"rw"===o.joined.notebook[n.id].perm&&(s+="-editable")):s=n.id==i?SYNO.SDS.NoteStation.Define.DEFAULT:!0===n.shared?SYNO.SDS.NoteStation.Define.SHARED:SYNO.SDS.NoteStation.Define.COMMON;var r=n.category;if("notebook"===n.category)a=10;else if("note"===n.category)a=20;else if("tag"===n.category){a=30;var l=o.tag[n.id];r=Ext.isObject(l.items)&&"{}"!==Ext.encode(l.items)?"tags":"tag"}else a=40;e.push({ref_id:n.id,sort_order:a,text:n.title,total:n.item_count,category:n.category,type:s,iconCls:String.format("syno-ns-notebook-fullmenu-{0}-{1}-icon",r,s),leaf:!0})},this),this._fillTreeData(this.shortcut_id,this.sortNodeByTitle(e,["ref_id","sort_order","text","total","category","type","iconCls","leaf"]))},fillNoteData:function(t){var e=[];e.push({ref_id:"all",sort_order:10,text:SYNO.SDS.NoteStation._T("category","all_notes"),category:"notebook",total:t.all.length,type:"all",iconCls:String.format("syno-ns-notebook-fullmenu-notebook-{0}-icon","all"),leaf:!0}),e.push({ref_id:"shared",sort_order:30,text:SYNO.SDS.NoteStation._T("category","all_shared_notes"),category:"notebook",total:t.shared.length,type:"all",iconCls:"syno-ns-notebook-fullmenu-shared-notes-icon",leaf:!0}),this._fillTreeData(this.note_id,this.sortNodeByTitle(e,["ref_id","object_id","sort_order","text","total","category","type","iconCls","leaf","items","expanded","expandable"]))},fillNotebookData:function(t){var e,o=[],i="syno-ns-notebook-fullmenu-notebook-{0}-icon";!0===Ext.isObject(this.last_stack_expanded_state)?(e=this.last_stack_expanded_state,this.last_stack_expanded_state=void 0):e=this.getStackExpandedState(this.notebook_id),Ext.iterate(t.stack,function(n,s){var a=[];Ext.iterate(s.items,function(e,o){var n,r;r=t.notebook[e],n=!0===r.preset?"default":!0===r.shared?"shared":"common",a.push({sort_order:50,text:r.title,total:r.item_count,category:"notebook",type:n,iconCls:String.format(i,n),object_id:e,stack:s.title,leaf:!0})},this),Ext.isEmpty(a)||o.push({ref_id:n,sort_order:40,text:s.title,total:s.items.length,iconCls:"syno-ns-notebook-fullmenu-stack-common-icon",category:"stack",type:"stack",expandable:!0,expanded:e[n]||!1,items:this.sortNodeByTitle(a,["ref_id","object_id","sort_order","text","total","category","type","iconCls","leaf","stack"]),leaf:!1})},this),Ext.iterate(t.notebook,function(t,e){var n;Ext.isEmpty(e.stack)&&!0!==e.archive&&(n=!0===e.preset?"default":!0===e.shared?"shared":"common",o.push({sort_order:50,text:e.title,total:e.item_count,category:"notebook",type:n,iconCls:String.format(i,n),object_id:t,leaf:!0}))},this),this._fillTreeData(this.notebook_id,this.sortNodeByTitle(o,["ref_id","object_id","sort_order","text","total","category","type","iconCls","leaf","items","expanded","expandable"]))},fillSmartData:function(t){var e=[];Ext.iterate(t,function(t,o){e.push({sort_order:50,text:o.title,category:"smart",type:"common",iconCls:"syno-ns-notebook-fullmenu-smart-common-icon",object_id:t,leaf:!0})},this),this._fillTreeData(this.smart_id,this.sortNodeByTitle(e,["ref_id","object_id","sort_order","text","category","type","iconCls","leaf"]))},fillArchiveData:function(t){var e=[];Ext.iterate(t.archive,function(o,i){var n=t.notebook[o];Ext.isEmpty(n)||e.push({sort_order:50,text:n.title,total:n.item_count,category:"notebook",type:"archive",iconCls:"syno-ns-notebook-fullmenu-notebook-archive-icon",object_id:o,leaf:!0})},this),this._fillTreeData(this.archive_id,this.sortNodeByTitle(e,["ref_id","object_id","sort_order","text","total","category","type","iconCls","leaf","items"]),!0)},fillJoinedData:function(t){var e,o=[];e=this.findAppWindow().uid_map,Ext.iterate(t.owner,function(i,n){var s=[];s.push({sort_order:10,text:SYNO.SDS.NoteStation._T("category","all_joined_notes"),total:n.all.length,category:"joinednote",type:"joined",iconCls:"syno-ns-notebook-fullmenu-notebook-all-icon",ref_id:e[i],leaf:!0}),Ext.iterate(n.notebook,function(e){var o=t.notebook[e];s.push({sort_order:50,text:o.title,total:o.item_count,category:"notebook",type:"joined",iconCls:String.format("syno-ns-notebook-fullmenu-notebook-{0}-icon","joined"),object_id:e,leaf:!0})},this),Ext.iterate(n.smart,function(e){var o=t.smart[e];s.push({sort_order:50,text:o.title,total:null,category:"smart",type:"joined",iconCls:String.format("syno-ns-notebook-fullmenu-smart-{0}-icon","joined"),object_id:e,leaf:!0})},this),o.push({ref_id:"username",text:i,iconCls:"syno-ns-notebook-fullmenu-category-username-icon",category:"category",type:"username",items:this.sortNodeByTitle(s,["ref_id","object_id","sort_order","text","total","category","type","iconCls","leaf"])})},this),this._fillTreeData(this.joined_id,o,!0)},showNBCtxMenu:function(t,e){this.NBCtxMenu.showAt(e.getXY())},NBCtxMenu:null,initNBCtxMenu:function(){var t=new Ext.menu.Menu({cls:"syno-ns-notebook-menu",items:[{text:"a"},{text:"b"}]});this.NBCtxMenu=t},createLoader:function(t){var e;return this.shortcut_id=Ext.id(void 0,"notestation_shortcut_"),this.todo_id=Ext.id(void 0,"notestation_todo_"),this.note_id=Ext.id(void 0,"notestation_note_"),this.notebook_id=Ext.id(void 0,"notestation_notebook_"),this.joined_id=Ext.id(void 0,"notestation_joined_"),this.tag_id=Ext.id(void 0,"notestation_tag_"),this.archive_id=Ext.id(void 0,"notestation_archive_"),this.smart_id=Ext.id(void 0,"notestation_smart_"),this.recycle_id=Ext.id(void 0,"notestation_recycle_"),e=[{ref_id:"shortcut",text:SYNO.SDS.NoteStation._T("category","shortcut"),category:"category",type:"shortcut",iconCls:"syno-ns-notebook-fullmenu-none",id:this.shortcut_id,items:[]},{ref_id:"todo",text:SYNO.SDS.NoteStation._T("category","todo_task"),category:"category",type:"todo",iconCls:"syno-ns-notebook-fullmenu-none",id:this.todo_id,items:[]},{ref_id:"note",text:SYNO.SDS.NoteStation._T("todo","note"),category:"category",type:"note",iconCls:"syno-ns-notebook-fullmenu-none",id:this.note_id,items:[]},{ref_id:"owned",text:SYNO.SDS.NoteStation._T("category","notebook"),category:"category",type:"notebook",iconCls:"syno-ns-notebook-fullmenu-none",id:this.notebook_id,items:[]},{ref_id:"smart",text:SYNO.SDS.NoteStation._T("category","smart"),category:"category",type:"smart",iconCls:"syno-ns-notebook-fullmenu-none",id:this.smart_id,items:[]},{ref_id:"archive",text:SYNO.SDS.NoteStation._T("category","archive"),category:"category",type:"archive",iconCls:"syno-ns-notebook-fullmenu-none",id:this.archive_id,items:[]},{ref_id:"joined",text:SYNO.SDS.NoteStation._T("category","joined"),iconCls:"syno-ns-notebook-fullmenu-none",category:"category",type:"joinednotebook",id:this.joined_id,items:[]},{ref_id:"tag",text:SYNO.SDS.NoteStation._T("category","tag"),iconCls:"syno-ns-notebook-fullmenu-none",category:"category",id:this.tag_id,type:"tag",items:[]},{ref_id:"recycle",text:SYNO.SDS.NoteStation._T("category","recycle"),iconCls:"syno-ns-notebook-fullmenu-none",category:"notebook",id:this.recycle_id,type:"deleted",items:[]}],new SYNO.SDS.NoteStation.Notebook.Loader({appWindow:this.findAppWindow(),notebookList:e})},onBeforeSelect:function(t,e,o){return!!e.leaf},selectUser:function(t){var e;Ext.isEmpty(t)||(e=this.getNodeById(this.joined_id).findChild("text",t),e.select())},selectJoinedNote:function(t,e){var o;Ext.isEmpty(e)||(this.notebookAction="single",o=this.getNodeById(this.joined_id).findChild("text",e),o.findChild("ref_id",t).select())},selectNode:function(t){this.getSelectionModel().select(t),Ext.defer(function(t){this.scrollToNode(t)},600,this,[t.getUI().getEl()])},selectShortcutById:function(t){var e,o;e=this.getNodeById(this.shortcut_id),o=e.findChild("ref_id",t),Ext.isEmpty(o)||this.selectNode(o)},selectTagById:function(t){var e,o;e=this.getNodeById(this.tag_id),o=e.findChild("tag_id",t,!0),Ext.isEmpty(o)||this.selectNode(o)},selectTodoById:function(t){var e,o;e=this.getNodeById(this.todo_id),o=e.findChild("type",t),Ext.isEmpty(o)||this.selectNode(o)},selectNotebookById:function(t,e){var o,i,n=this.findAppWindow();if(!Ext.isEmpty(n)){if("all"===t)o=this.getNodeById(this.note_id),i=o.findChild("ref_id",t);else if("shared"===t)o=this.getNodeById(this.note_id),i=o.findChild("ref_id",t);else if("recycle"===t)o=this.getNodeById(this.notebook_id),i=o.findChild("ref_id",t);else if("note"===t)i=this.getNodeById(this.note_id);else if("owned"===t)i=this.getNodeById(this.notebook_id);else if("smart"===t)i=this.getNodeById(this.smart_id);else if("archive"===t)i=this.getNodeById(this.archive_id);else if("joined"===t)i=this.getNodeById(this.joined_id);else if("shortcut"===t)i=this.getNodeById(this.shortcut_id);else if("tag"===t)i=this.getNodeById(this.tag_id);else if("todo"===t)i=this.getNodeById(this.todo_id);else if("todo_all"===t||"todo_today"===t||"todo_next_7_days"===t||"todo_overdue"===t)o=this.getNodeById(this.todo_id),i=o.findChild("ref_id",t);else if(t in n.owned.notebook){o=!0===n.owned.notebook[t].archive?this.getNodeById(this.archive_id):this.getNodeById(this.notebook_id);var s=n.owned.notebook[t];if(s.stack){var a=SYNO.SDS.NoteStation.Utils.getStackId(s.stack);i=o.findChild("ref_id",a),i&&(i.expand(),o=i)}i=o.findChild("object_id",t,!0)}else if(t in n.owned.smart)o=this.getNodeById(this.smart_id),i=o.findChild("object_id",t,!0);else if(t in n.joined.notebook)o=this.getNodeById(this.joined_id),o=o.findChild("text",n.joined.notebook[t].owner),i=o.findChild("object_id",t);else{if(!Ext.isNumber(t))return void this.getSelectionModel().clearSelections();var r=!1,l="";if(Ext.iterate(n.uid_map,function(e,o){if(t===o)return l=e,r=!0,!1}),!1===r)return void this.getSelectionModel().clearSelections();o=this.getNodeById(this.joined_id),o=o.findChild("text",l),i=o.findChild("ref_id",t)}Ext.isEmpty(i)||(Ext.isEmpty(e)?this.notebookAction="single":this.notebookAction=e,this.getSelectionModel().select(i),Ext.defer(function(t){this.isDestroyed||this.scrollToNode(t)},600,this,[i.getUI().getEl()]))}},selectStackByName:function(t,e){var o,i,n=this.findAppWindow();Ext.isEmpty(n)||(o=this.getNodeById(this.notebook_id),i=o.findChild("ref_id",t),Ext.isEmpty(i)||(Ext.isEmpty(e)?this.notebookAction="selectfirst":this.notebookAction=e,this.getSelectionModel().select(i),Ext.defer(function(t){this.isDestroyed||this.scrollToNode(t)},600,this,[i.getUI().getEl()])))},selectSmartById:function(t,e){var o,i,n=this.findAppWindow();Ext.isEmpty(t)||(t in n.owned.smart?(o=this.getNodeById(this.smart_id),i=o.findChild("object_id",t)):t in n.joined.smart&&(o=this.getNodeById(this.joined_id),o=o.findChild("text",n.joined.smart[t].owner),i=o.findChild("object_id",t)),Ext.isEmpty(i)||(this.notebookAction=e||"selectfirst",this.getSelectionModel().select(i),Ext.defer(function(t){this.isDestroyed||this.scrollToNode(t)},600,this,[i.getUI().getEl()])))},scrollToNode:function(t){var e,o=Ext.get(this.getScrollTarget()),i=Ext.get(t);Ext.isEmpty(o)||Ext.isEmpty(i)||((e=i.getOffsetsTo(o)[1])<0||e+i.getHeight()>o.getHeight())&&this.fleXcrollTo(t)},onNotebookListSelect:function(t,e){var o,i,n,s,a,r,l,d,c,h=null;if(s=this.findAppWindow(),l=s.getPanelScope("SYNO.SDS.NoteStation.MainPanel"),l.hasTodoSearch||l.searchField.reset(),l.hasTodoSearch=!1,Ext.isEmpty(this.notebookAction)?h="selectfirst":(h=this.notebookAction,this.notebookAction=void 0),r=e[e.length-1],e.length>1&&!this.isSelectableNode(e))return r.unselect(),!1;if(o=s.getPanelScope("SYNO.SDS.NoteStation.Note.Panel"),s.owned.choosed=null,!(Ext.isEmpty(e)||e.length>1)&&(d=e[0],a=d.attributes.object_id||d.attributes.tag_id||d.attributes.ref_id,i=d.attributes.category,c=d.attributes.type,l.switchCenterPanel(i,c),"todo"!==i)){"notebook"===i&&!Ext.isEmpty(a)&&a in s.owned.notebook&&(s.owned.choosed=a),s.choosed={type:i,id:a},n="empty"!==i&&"category"!==i&&"username"!==i&&"stack"!==i;var u="tag"===i?a.substr(0,a.lastIndexOf("@")):d.attributes.text;o.switchPanel(n,a,i,u,null,h)}},isSelectableNode:function(t){var e=t[t.length-1],o=t[0],i=e.parentNode.attributes,n=o.parentNode.attributes;return i.id===n.id},getLocalizedString:function(t){return t},selectModule:function(t){var e
;(e=this.getNodeById(t))&&(this.getSelectionModel().select(e),Ext.fly(e.getUI().wrap).isVisible()&&this.fleXcrollTo(e.getUI().wrap))},setModuleVisible:function(t,e){var o;(o=this.getNodeById(t))&&(e?o.getUI().show():o.getUI().hide(),this.updateScrollbar(this.body.dom))},removeModule:function(t){var e;(e=this.getNodeById(t))&&e.remove()},insertModule:function(t,e){var o,i;i=this.getRootNode(),o=this.getNodeById(e),i&&o&&i.insertBefore(t,o)},appendModule:function(t){var e;(e=this.getRootNode())&&e.appendChild(t)}}),Ext.define("SYNO.SDS.NoteStation.Notebook.Loader",{extend:"Ext.tree.TreeLoader",constructor:function(t){this.callParent(arguments)},load:function(t,e,o){if(this.clearOnLoad)for(;t.firstChild;)t.removeChild(t.firstChild);this.doPreload(t)?this.runCallback(e,o||t,[t]):(this.directFn||this.dataUrl||this.url||this.notebookList)&&this.requestData(t,e,o||t)},doPreload:function(t){return t.attributes.children=t.attributes.items,this.callParent(arguments)},createNode:function(t){return this.baseAttrs&&Ext.applyIf(t,this.baseAttrs),!1===this.applyLoader||t.loader||(t.loader=this),t.uiProvider||(t.uiProvider=SYNO.SDS.NoteStation.Notebook.TreeNodeUI),t.fn&&(t.id=t.fn),t.nodeType?new Ext.tree.TreePanel.nodeTypes[t.nodeType](t):t.items?(!1!==t.expanded&&(t.expanded=!0),new Ext.tree.AsyncTreeNode(t)):(t.leaf=!0,new Ext.tree.TreeNode(t))},requestData:function(t,e,o){if(t.isRoot)return void this.processResponse(null,t,e,o);this.callParent(arguments)},processResponse:function(t,e,o,i){var n,s;try{this.notebookList?s=this.notebookList:t&&(n=t.responseText,s=t.responseData||Ext.decode(n),s.notebookList&&(s=s.notebookList)),e.beginUpdate();for(var a=0,r=s.length;a<r;a++){var l=this.createNode(s[a]);l&&e.appendChild(l)}e.endUpdate(),this.runCallback(o,i||e,[e])}catch(e){this.handleFailure(t)}}}),Ext.define("SYNO.SDS.NoteStation.Notebook.TreeNodeUI",{extend:"Ext.tree.TreeNodeUI",renderElements:function(t,e,o,i){var n;e.icon&&(n=e.icon,delete e.icon),this.base_renderElements(t,e,o,i),n&&(e.icon=n)},getTextMaxWidth:function(t){var e,o=0;if(!Ext.isObject(t.attributes)||Ext.isEmpty(t.attributes.category))return"";e=t.attributes.total,Ext.isNumber(e)&&(o=SYNO.SDS.NoteStation.TextMeasure.getTotalNumWidth(e));var i="stack"===t.attributes.category?20:0;return SYNO.SDS.NoteStation.Window.getMainPanel().getNotebookPanel().getWidth()-o-28*(t.getDepth()-1)-i-24-24-10},base_renderElements:function(t,e,o,i){this.indentMarkup=t.parentNode?t.parentNode.ui.getChildIndent():"";var n,s=Ext.isNumber(e.total)?String.format('<span class="syno-ns-notebook-total disable-font" >({0})</span>',e.total):"",a=String.format('style="max-width:{0}px"',this.getTextMaxWidth(t)),r=t.parentNode.isRoot?"syno-ns-notebook-category-title ":"",l=t.parentNode.isRoot||"stack"===t.category?"x-tree-elbow":"syno-ns-notebook-fullmenu-none",d=Ext.util.Format.htmlEncode(t.attributes.ref_id||""),c=t.attributes.type||"",h=t.attributes.category||"",u=Ext.util.Format.htmlEncode(t.text),S=Ext.isBoolean(e.checked),p=this.getHref(e.href),m=Ext.isFunction(e.getTpl)?e.getTpl(this,t,e,o,i):['<li class="x-tree-node"><div ext:tree-node-id="',t.id,'" class="x-tree-node-el x-tree-node-leaf x-unselectable ',r,e.cls,'" unselectable="on">','<span class="x-tree-node-indent">',this.indentMarkup,"</span>",'<img ref_attr="',d,'" type_attr="',c,'" category="',h,'" alt="" src="',this.emptyIcon,'" class="x-tree-ec-icon '+l+'" />','<img alt="" src="',e.icon||this.emptyIcon,'" class="x-tree-node-icon',e.icon?" x-tree-node-inline-icon":"",e.iconCls?" "+e.iconCls:"",'" unselectable="on" />',S?'<input class="x-tree-node-cb" type="checkbox" '+(e.checked?'checked="checked" />':"/>"):"",'<a hidefocus="on" class="x-tree-node-anchor" href="',p,'" tabIndex="1" ',e.hrefTarget?' target="'+e.hrefTarget+'"':"",'><span unselectable="on" class="syno-ns-notebook-title" ',a,">",u,"</span>",s,"</a></div>",'<ul class="x-tree-node-ct" style="display:none;"></ul>',"</li>"].join("");!0!==i&&t.nextSibling&&(n=t.nextSibling.ui.getEl())?this.wrap=Ext.DomHelper.insertHtml("beforeBegin",n,m):this.wrap=Ext.DomHelper.insertHtml("beforeEnd",o,m),this.elNode=this.wrap.childNodes[0],this.ctNode=this.wrap.childNodes[1];var f=this.elNode.childNodes;this.indentNode=f[0],this.ecNode=f[1],this.iconNode=f[2];var g=3;S&&(this.checkbox=f[3],this.checkbox.defaultChecked=this.checkbox.checked,g++),this.anchor=f[g],this.textNode=f[g].firstChild},updateExpandIcon:function(){if(this.rendered){var t,e,o=this.node,i=o.isLast()?"x-tree-elbow-end":"x-tree-elbow";o.hasChildNodes()||o.attributes.expandable?((o.parentNode.isRoot||"stack"===o.attributes.category)&&(o.expanded?(i+="-minus",t="x-tree-node-collapsed",e="x-tree-node-expanded"):(i+="-plus",t="x-tree-node-expanded",e="x-tree-node-collapsed")),this.wasLeaf&&(this.removeClass("x-tree-node-leaf"),this.wasLeaf=!1),this.c1==t&&this.c2==e||(Ext.fly(this.elNode).replaceClass(t,e),this.c1=t,this.c2=e)):this.wasLeaf||(Ext.fly(this.elNode).replaceClass("x-tree-node-expanded","x-tree-node-collapsed"),delete this.c1,delete this.c2,this.wasLeaf=!0);var n="x-tree-ec-icon "+i;this.ecc!=n&&(this.ecNode.className=n,this.ecc=n)}}}),Ext.define("SYNO.SDS.NoteStation.Notebook.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){this.callParent([this.fillConfig(t)])},lightMenu:null,fullMenu:null,defaultWidth:250,fillConfig:function(t){var e,o;return this.owner=t.owner,this._widthCache=this.defaultWidth,this.lightMenu=new SYNO.SDS.NoteStation.Notebook.ListView.LightMenu({owner:this,itemId:"light_menu"}),this.fullMenu=new SYNO.SDS.NoteStation.Notebook.TreePanel.FullMenu({owner:this,itemId:"full_menu"}),this.owner.on("selectnotebook",function(t,e){this.fullMenu.isVisible()?this.fullMenu.selectNotebookById(t,e):this.lightMenu.isVisible()&&this.lightMenu.selectNotebookById(t,e)},this),this.owner.on("selecttag",function(t){this.fullMenu.isVisible()?this.fullMenu.selectTagById(t):this.lightMenu.isVisible()&&this.lightMenu.selectTagById(t)},this),this.owner.on("selectuser",function(t){this.fullMenu.isVisible()&&this.fullMenu.selectUser(t)},this),this.owner.on("selectjoinednote",function(t,e){this.fullMenu.isVisible()?this.fullMenu.selectJoinedNote(t,e):this.lightMenu.isVisible()&&this.lightMenu.selectJoinedNote(t,e)},this),this.owner.on("selectstack",function(t,e){this.fullMenu.isVisible()?this.fullMenu.selectStackByName(t,e):this.lightMenu.isVisible()&&this.lightMenu.selectStackByName(t,e)},this),this.owner.on("selecttodo",function(t){this.fullMenu.isVisible()?this.fullMenu.selectTodoById(t):this.lightMenu.isVisible()&&this.lightMenu.selectTodoById(t)},this),this.owner.on("selectsmart",function(t,e){this.fullMenu.isVisible()?this.fullMenu.selectSmartById(t,e):this.lightMenu.isVisible()&&this.lightMenu.selectSmartById(t,e)},this),o=this.findAppWindow(),o.on("beforedataload",this.setStatusBusy,this),o.on("afterdataload",this.clearStatusBusy,this),e={activeItem:0,items:[this.fullMenu,this.lightMenu],listeners:{resize:{fn:this.onResizeNotebookPanel,buffer:200,scope:this}}},Ext.apply(e,t),e},onResizeNotebookPanel:function(t,e,o,i,n){var s,a,r,l,d,c,h,u=["shortcut_id","notebook_id","joined_id","tag_id","archive_id","todo_id"];if(Ext.isEmpty(t.oldWidth)&&(t.oldWidth=e),t.oldWidth<e&&t.oldWidth<150||e>=150)if(e<this.defaultWidth)SYNO.SDS.NoteStation.Utils.setLeftSplitBarPosition(this.defaultWidth),t.setWidth(this.defaultWidth),this._widthCache=this.defaultWidth;else{if(this._widthCache=e,r=this.findAppWindow().getMainPanel().getNotePanel(),l=this.findAppWindow().getMainPanel().getTodoPanel(),s=r.currentNoteListId,a=r.currentNoteId,h=this.lightMenu.getSelectedRecords()[0],Ext.isObject(h)){var S=h.get("type");"shortcut"===S?this.fullMenu.selectShortcutById(a):"tag"===S?this.fullMenu.selectTagById(a):"todo"===S&&l.isVisible()?this.fullMenu.selectTodoById(l.currentTodoId):this.fullMenu.selectNotebookById(s)}t.layout.setActiveItem("full_menu"),this.fullMenu.getRootNode().cascade(function(){var t,e;Ext.isObject(this.attributes)&&!Ext.isEmpty(this.attributes.category)&&(e=this.getUI().textNode)&&(t=this.getUI().getTextMaxWidth(this),Ext.fly(e).setStyle({"max-width":t+"px"}))}),this.findAppWindow().getMainPanel().doLayout()}else e<150&&(e<=60?(c=this.fullMenu.getSelectionModel(),d=c.getSelectedNodes()[0],!1===Ext.isEmpty(d)&&Ext.each(u,function(t){var e=this.fullMenu[t],o=this.fullMenu.getNodeById(e),i=this.lightMenu[t];if(d===o||d.isAncestor(o))return void this.lightMenu.select(i,!1,!0)},this),t.layout.setActiveItem("light_menu"),this._widthCache=e,this.findAppWindow().getMainPanel().doLayout()):(SYNO.SDS.NoteStation.Utils.setLeftSplitBarPosition(60),t.setWidth(60),this._widthCache=60));t.oldWidth=e;var p=Ext.Element.data(this.el.dom,"maskMsg");p&&p.center(this.el)},getWidth:function(){return this._widthCache},setStatusBusy:function(){this.el&&!this.el.isMasked()&&this.el.mask(SYNO.SDS.NoteStation._T("common","loading"),"x-mask-loading")},clearStatusBusy:function(){this.el&&this.el.unmask()},updateNotebook:function(t,e){var o,i,n,s,a,r=!1,l=!1;a=this.findAppWindow(),!1!==this.fullMenu.isVisible()&&(t in a.owned.notebook?(a.owned.notebook[t].title=e.text,i=!0===a.owned.notebook[t].archive?this.fullMenu.getNodeById(this.fullMenu.archive_id):this.fullMenu.getNodeById(this.fullMenu.notebook_id)):t in a.owned.smart&&(a.owned.smart[t].title=e.text,i=this.fullMenu.getNodeById(this.fullMenu.smart_id)),t in a.shortcut&&(r=!0,a.shortcut[t].title=e.text),o=i.findChild("object_id",t,!0),Ext.isEmpty(o)||(i=o.parentNode,Ext.isString(e.text)&&(e.text=Ext.util.Format.htmlEncode(e.text)),s=new Ext.tree.AsyncTreeNode(Ext.apply(o.attributes,e)),l=i.isExpanded()&&1===i.childNodes.length,i.replaceChild(s,o),!0===l&&i.expand(),s.select(),!1!==r&&(n=this.fullMenu.getNodeById(this.fullMenu.shortcut_id),o=n.findChild("ref_id",t),Ext.isEmpty(o)||(s=new Ext.tree.AsyncTreeNode(Ext.apply(o.attributes,e)),n.replaceChild(s,o)))))}}),Ext.define("SYNO.SDS.NoteStation.Editor.Base.Panel",{extend:"SYNO.ux.Panel",transparent_gif_selector:'img.syno-notestation-image-object[src="webman/3rdparty/NoteStation/images/transparent.gif"]',pdf_selector:'embed[type="application/pdf"]',constructor:function(t){this.addEvents("resetidle"),this.addEvents("loadnotedone"),this.callParent(arguments),this.addListener("loadnotedone",this.handleNoteDone,this)},_createShortcutBtnConfig:function(){return{xtype:"syno_button",itemId:"shortcut_btn",iconCls:"syno-ns-editor-shortcut-btn",tooltip:SYNO.SDS.NoteStation._T("category","shortcut"),handler:function(t){var e=this.findAppWindow(),o=this.noteData.object_id;o in e.shortcut?(e.getMainPanel().removeFromShortcut({object_id:[o]}),t.toggle(!1)):(e.getMainPanel().addToShortcut({object_id:[o]}),t.toggle(!0))},scope:this}},handleNoteDone:function(){var t=this.getEditor();Ext.isChrome?!0===!!t.getBody().querySelector(this.pdf_selector)&&this.replaceContentByPdfRef():Ext.iterate(t.getBody().querySelectorAll(this.pdf_selector),function(t){Ext.fly(t.parentNode).setHeight(0)})},handleNoteAction:Ext.emptyFn,replaceContentByPdfRef:function(){var t,e,o,i,n=this.getEditor(),s=n.getBody(),a=this.owner.findAppWindow();t=Ext.fly(this.getEditor().getContentAreaContainer()).getHeight(),o=this.noteData||this.owner.noteData,i=this.notePerm||this.owner.notePerm,Ext.iterate(o.attachment,function(n,r){Ext.isEmpty(r.pdf_ref)||Ext.iterate(s.querySelectorAll(String.format('embed[pdf_ref="{0}"]',r.pdf_ref)),function(s){var l,d,c={object_id:o.object_id,ver:o.ver,format:"raw",file_id:n};o.encrypt&&(c.token=a.getEncryptPassword(this.module.noteData.object_id).token),Ext.isObject(i)&&Ext.copyTo(c,i,"perm_from,smart_id"),d=a.getBaseURL({api:"SYNO.NoteStation.Note",version:3,method:"download",params:c},!0,r.name),e=Ext.fly(s.parentNode),e.setHeight(t),s.parentNode.setAttribute("contenteditable","false"),l=s.cloneNode(!0),l.setAttribute("data-mce-src",s.src),l.setAttribute("src",d),s.parentNode.replaceChild(l,s)},this)},this)},loadNote:Ext.emptyFn,saveNote:function(t,e){Ext.isFunction(t)&&t.call(e||window)},clearNote:function(){var t=this.getEditor();if(!Ext.isEmpty(t))try{this.getFloatTodoWindow().hide()}catch(t){}},isActive:function(){return this.owner.isPanelActive(this)},setStatusBusy:function(){this.el&&!this.el.isMasked()&&this.el.mask(SYNO.SDS.NoteStation._T("common","loading"),"x-mask-loading")},clearStatusBusy:function(){this.el&&this.el.unmask()},isEmptyObject:function(t){if(!Ext.isObject(t))return!0;for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},showErrorMsg:function(t,e,o){var i=this.findAppWindow();SYNO.SDS.NoteStation.Utils.showErrorMsg(i,t,e,o)},updateData:Ext.emptyFn,openNoteInNewTab:function(){SYNO.SDS.NoteStation.Utils.openNoteInNewTab(this,this.noteData.object_id)},getPrintTitle:function(){return Ext.util.Format.htmlEncode(this.getTopToolbar().getComponent("title").getValue())},getPrintInfo:function(){var t=['<table cellspacing="0">','<tbody> <tr class="x-toolbar-left-row">','<td class="x-toolbar-cell">',"<label>{0}</label>","</td>",'<td class="x-toolbar-cell"> <div class="xtb-spacer" style="width: 4px;" ></div> </td>','<td class="x-toolbar-cell" >',"<label>{1}</label>","</td>",'<td class="x-toolbar-cell" > <div class="xtb-spacer" style="width: 16px;" ></div> </td>','<td class="x-toolbar-cell" >',"<label >{2}</label>","</td>",'<td class="x-toolbar-cell" > <div class="xtb-spacer" style="width: 4px;" ></div> </td>','<td class="x-toolbar-cell" >',"<label>{3}</label>","</td>",'<td class="x-toolbar-cell" > <div class="xtb-spacer" style="width: 16px;" ></div> </td>','<td class="x-toolbar-cell" >','<label class="syno-ns-editor-metadata-url"> {4} </label>',"</td> </tr> </tbody> </table>"].join("");return String.format(t,SYNO.SDS.NoteStation._T("info","modified"),SYNO.SDS.NoteStation.Utils.dateTimeFormatter(new Date(1e3*this.noteData.mtime),{type:"datetimesec"}),SYNO.SDS.NoteStation._T("info","created"),SYNO.SDS.NoteStation.Utils.dateTimeFormatter(new Date(1e3*this.noteData.ctime),{type:"datetimesec"}),this.noteData.source_url||"")},onImageReady:function(t,e,o){return this.ddupload.onImageReady(t,e,o)},print:function(){var t=this.getEditor();Ext.isEmpty(t)||this.onImageReady(function(e){t.execCommand("syno_print")},this,"print")},launchMail:function(t,e,o){var i=Ext.get(t.getEditor().getBody()).query(this.transparent_gif_selector);if(!Ext.isEmpty(i))return void Ext.defer(function(){this.launchMail(t,e,o)},500,this);SYNO.SDS.NoteStation.Utils.serializeContent({editor:t.getEditor(),noteData:e,notePerm:o,appWin:t.findAppWindow(),attachment:t.getExistAttachment(),callback:function(t){t.data=t.attachment,t.attachment=null,t.appName="SYNO.SDS.NoteStation.Application",t.appTitle="tree:leaf_notestation",SYNO.SDS.App.MailDialog.Utils.launchMailFn(t)}})},exportNote:function(t,e){var o,i,n,s=Ext.get(t.getEditor().getBody()).query(this.transparent_gif_selector);if(!Ext.isEmpty(s))return void Ext.defer(function(){this.exportNote(t,e)},500,this);this.setStatusBusy(),o=function(t,e){this.clearStatusBusy()},n=this.findAppWindow(),i={object_id:e.object_id},!0===e.encrypt&&(i.token=n.getEncryptPassword(e.object_id).token),n.getMainPanel().exportNote(i,o,this)},exportWord:function(t,e){var o,i,n,s=Ext.get(t.getEditor().getBody()).query(this.transparent_gif_selector);if(!Ext.isEmpty(s))return void Ext.defer(function(){this.exportWord(t,e)},500,this);this.setStatusBusy(),o=function(t,e){this.clearStatusBusy()},n=this.findAppWindow(),i={object_id:e.object_id},!0===e.encrypt&&(i.token=n.getEncryptPassword(e.object_id).token),n.getMainPanel().exportWord(i,o,this)},applySetting:function(){var t,e,o="";if(e=this.findAppWindow(),Ext.isObject(e.settings)&&(t=this.getEditor().getBody(),!0===Ext.isElement(t)&&(Object.prototype.hasOwnProperty.call(e.settings,"font_size")&&(o="syno-fontsize-"+e.settings.font_size,Ext.iterate(t.className.replace(/^\s+|\s+$/g,"").split(/\s+/),function(t){!0!==t.startsWith("syno-fontsize-")&&(o+=" "+t+" ")},this),t.className=o),Object.prototype.hasOwnProperty.call(e.settings,"spell_check")))){!1!==e.settings.spell_check?t.removeAttribute("spellcheck"):t.setAttribute("spellcheck","false")}},enterFullscreen:function(){if(Ext.isObject(this.fsObj)||(this.fsObj={},this.fsObj.elem=Ext.DomHelper.createDom({tag:"iframe",cls:"syno-ns-fullscreen-presentation",page:"init",src:"about:blank"}),document.body.appendChild(this.fsObj.elem),this.fsObj.handler=this.handleFullscreen.createDelegate(this)),Ext.DomHelper.applyStyles(this.fsObj.elem,{width:"100%",height:"100%",position:"fixed",left:"0",top:"0",frameborder:"0",scrolling:"true"}),this.fsObj.elem.requestFullscreen)this.fsObj.eventName="fullscreenchange",this.fsObj.fnName="requestFullscreen";else if(this.fsObj.elem.msRequestFullscreen)this.fsObj.eventName="MSFullscreenChange",this.fsObj.fnName="msRequestFullscreen";else if(this.fsObj.elem.mozRequestFullScreen)this.fsObj.eventName="mozfullscreenchange",this.fsObj.fnName="mozRequestFullScreen";else{if(!this.fsObj.elem.webkitRequestFullscreen)return;this.fsObj.eventName="webkitfullscreenchange",this.fsObj.fnName="webkitRequestFullscreen"}Ext.get(document).addListener(this.fsObj.eventName,this.fsObj.handler),this.fsObj.elem[this.fsObj.fnName]()},handleFullscreen:function(){var t,e=this;Ext.isObject(this.fsObj)&&(t=this.fsObj.elem.getAttribute("page"),"init"===t?this.initFullscreen().then(function(){e.addPagesToFullscreen()}):(Ext.removeNode(this.fsObj.elem),Ext.get(document).removeListener(this.fsObj.eventName,this.fsObj.handler),this.fsObj.handler=null,this.fsObj=null))},initFullscreen:function(){var t,e,o=this.getEditor(),i=this.findAppWindow().settings,n="white";if(!Ext.isObject(this.fsObj)||Ext.isEmpty(o))return!1;Ext.isObject(i)&&Ext.isString(i.slide_theme)&&(n=i.slide_theme),e=this.fsObj.elem.contentDocument,e.head.appendChild(o.dom.create("meta",{charset:"utf-8"})),e.head.appendChild(o.dom.create("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"}));for(var s=[o.dom.create("link",{rel:"stylesheet",href:"webman/3rdparty/NoteStation/js/reveal.js/css/reveal.css"}),o.dom.create("link",{rel:"stylesheet",href:"webman/3rdparty/NoteStation/js/reveal.js/css/theme/"+n+".css",id:"theme"}),o.dom.create("script",{src:"webman/3rdparty/NoteStation/js/reveal.js/lib/js/head.min.js"}),o.dom.create("script",{src:"webman/3rdparty/NoteStation/js/reveal.js/js/reveal.min.js"}),o.dom.create("script",{src:"webman/3rdparty/NoteStation/js/flotr2/flotr2.min.js"})],a=Promise.all(s.map(function(t){return new Promise(function(e,o){t.onload=e,t.onerror=o})})),r=0;r<s.length;r++){var l=s[r];e.head.appendChild(l)}return this.fsObj.elem.contentDocument.body.appendChild(Ext.DomHelper.createDom({tag:"div",cls:"syno_blank_mask",style:{width:"100%",height:"100%"}})),this.fsObj.elem.contentDocument.body.appendChild(Ext.DomHelper.createDom({tag:"div",cls:"reveal",children:{tag:"div",cls:"slides",html:""}})),Ext.get(this.fsObj.elem).focus(),t=Ext.get(this.fsObj.elem.contentDocument.body),t.focus(),a},addPagesToFullscreen:function(){var t,e,o,i,n,s=this,a=this.getEditor(),r=this.findAppWindow().settings;if(!(e=this.fsObj.elem.contentDocument.body.querySelector(".reveal .slides")))return!1;e.appendChild(Ext.DomHelper.createDom({tag:"section",children:{tag:"div",cls:"syno-ns-presentation-title",html:this.getPrintTitle()}})),n=new SYNO.SDS.NoteStation.Editor.Base.FontSizeConverter({defaultNoteFontSize:r.font_size}),t=this.convertNoteContentToPresentation(a),Ext.isEmpty(t)||Ext.iterate(t,function(t){var o,i=Ext.DomHelper.createDom({tag:"section",children:{tag:"div",cls:"syno-ns-presentation-content",html:t}});if(this.replaceSectionTagByDiv(i),n.convert(i),o=(i.textContent||i.innerText||"").trim(),!Ext.isEmpty(i.querySelector("img, iframe, audio, video, embed, input, applet, canvas, .syno-ns-chart-object"))||!Ext.isEmpty(o)){for(var s=i.querySelectorAll("a"),a=Array.isArray(s),r=0,s=a?s:s[Symbol.iterator]();;){var l;if(a){if(r>=s.length)break;l=s[r++]}else{if(r=s.next(),r.done)break;l=r.value}l.setAttribute("target","_blank")}e.appendChild(i)}},this),Ext.iterate(e.querySelectorAll("input.syno-notestation-editor-checkbox"),function(t,e){t.classList.contains("syno-notestation-editor-checkbox-checked")?t.src="webman/modules/TinyMCE/js/tinymce/plugins/syno_checkbox/editor_checkbox_03.png":t.src="webman/modules/TinyMCE/js/tinymce/plugins/syno_checkbox/editor_checkbox_01.png"}),Ext.iterate(e.querySelectorAll(".syno-ns-chart-object"),function(t){t=SYNO.SDS.NoteStation.Chart.ChartObjectHelper.translateChartTag(t,"DIV","IMG")}),Ext.isObject(r)||(r={slide_theme:"white",pointer_color:"blue"}),o=this.fsObj.elem.contentWindow,i=window.setInterval(function(){Ext.isObject(o.Reveal)&&(window.clearInterval(i),o.Reveal.addEventListener("ready",function(){Ext.iterate(o.document.body.querySelectorAll(".syno_blank_mask"),function(t){Ext.removeNode(t)})}),o.Reveal.initialize({controls:!1,progress:!1,history:!1,center:!0,mouseWheel:!0,width:document.body.clientWidth,height:document.body.clientHeight,margin:0,minScale:1,maxScale:1.5,synoNoteMode:!0,synoDrawChartHelper:SYNO.SDS.NoteStation.Chart.ChartObjectHelper,synoControl:!0,synoControlPointerColor:r.pointer_color,synoControlTheme:r.slide_theme,synoControlSettingFunc:s.savePresentationSetting.createDelegate(s),synoControlStings:{theme_display:SYNO.SDS.NoteStation._T("presentation","theme_display")+":"},mouseWheelThrottle:0,transition:"slide",keyboard:{27:function(t){27===t.keyCode&&(document.cancelFullScreen?document.cancelFullScreen():document.msCancelFullScreen?document.msCancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen())}},dependencies:[{src:"lib/js/classList.js",condition:function(){return!document.body.classList}},{src:"plugin/highlight/highlight.js",async:!0,condition:function(){return!!document.querySelector("pre code")},callback:function(){window.hljs.initHighlightingOnLoad()}}]}))},80),this.fsObj.elem.setAttribute("page","content")},replaceSectionTagByDiv:function(t){for(var e=t.querySelector("section");Ext.isElement(e);){var o,i=document.createElement("div");for(o=0;o<e.attributes.length;o++)i.setAttribute(e.attributes[o],e.getAttribute(e.attirbutes[o]));i.innerHTML=e.innerHTML,e.parentNode.replaceChild(i,e),e=t.querySelector("section")}},convertNoteContentToPresentation:function(t){var e,o,i,n=[];if(e=t.getBody(),o=e.querySelectorAll("hr,h1,h2,h3,h4,h5,h6"),o.length<1)return n.push(t.getContent()),n;if(i=e.firstChild,Ext.iterate(o,function(e){var o=t.dom.createRng();1===i.nodeType&&"HR"===i.tagName?o.setStartAfter(i):o.setStart(i,0),1===e.nodeType?o.setEndBefore(e):o.setEndAfter(e),t.selection.setRng(o),n.push(t.selection.getContent()),t.selection.collapse(),i=e}),1===i.nodeType){var s=t.dom.createRng();"HR"===i.tagName?s.setStartAfter(i):s.setStart(i,0),s.setEndAfter(e.lastChild),t.selection.setRng(s),n.push(t.selection.getContent()),t.selection.collapse()}return n},savePresentationSetting:function(t){var e=this.findAppWindow();!0!==SYNO.SDS.NoteStation.Utils.isPublicShare&&e.getStorage().setSetting(Ext.apply({callback:function(t,o){!0===t&&e.reloadSettings(o)},scope:this},t))}}),Ext.define("SYNO.SDS.NoteStation.Editor.Base.FontSizeConverter",{statics:{fontSizePxMap:{"xx-small":10,"x-small":12,small:14,medium:16,initial:16,large:18,"x-large":24,"xx-large":32},synoFontSizePtMap:{"xxx-small":8,"xx-small":10,"x-small":12,small:14,normal:16,large:18,"x-large":24,"xx-large":36},synoFontSizes:["syno-fontsize-xxx-small","syno-fontsize-xx-small","syno-fontsize-x-small","syno-fontsize-small","syno-fontsize-normal","syno-fontsize-large","syno-fontsize-x-large","syno-fontsize-xx-large"]},constructor:function(t){this.initFontSizeRatio(t)},initFontSizeRatio:function(t){var e=SYNO.SDS.NoteStation.Editor.Base.FontSizeConverter.synoFontSizePtMap,o=Ext.isEmpty(t.defaultNoteFontSize)?12:e[t.defaultNoteFontSize];this.fontSizeRatio=36/o},convert:function(t){this.removeAllFontSizeAndLineHeightOfHeading(t),this.convertAllFontSizeAndLineHeight(t)},removeAllFontSizeAndLineHeightOfHeading:function(t){var e=t.querySelectorAll("h1,h2,h3,h4,h5,h6");Ext.each(e,function(t){Ext.isEmpty(t.style.fontSize)||(t.style.fontSize=""),Ext.isEmpty(t.style.lineHeight)||(t.style.lineHeight="")})},convertAllFontSizeAndLineHeight:function(t){var e=t.querySelectorAll('[style*="font-size"]');Ext.each(e,function(t){this.convertFontSizeByElementStyle(t)},this),this.convertAllFontSizeBySynoClass(t),e=t.querySelectorAll('[style*="line-height"]'),Ext.each(e,function(t){this.convertLineHeightByElementStyle(t)},this)},convertFontSizeByElementStyle:function(t){if(!Ext.isEmpty(t.style.fontSize)){var e=parseFloat(t.style.fontSize);Ext.isNumber(e)?this.convertStyleFromScale("fontSize",t,e):this.convertFontSizeFromString(t)}},convertAllFontSizeBySynoClass:function(t){var e=String.format(".{0}",SYNO.SDS.NoteStation.Editor.Base.FontSizeConverter.synoFontSizes.join(",.")),o=t.querySelectorAll(e);Ext.each(o,function(t){if(Ext.isEmpty(t.style.fontSize)){var e=this.getIntersectionWithSynoFontClasses(t);Ext.isDefined(e)&&this.convertFontSizeBySynoClass(t,e)}},this)},getIntersectionWithSynoFontClasses:function(t){var e=SYNO.SDS.NoteStation.Editor.Base.FontSizeConverter.synoFontSizes,o=Ext.each(e,function(e){if(t.classList.contains(e))return!1});return Ext.isDefined(o)?e[o]:void 0},convertFontSizeBySynoClass:function(t,e){var o=e.substring("syno-fontsize-".length),i=SYNO.SDS.NoteStation.Editor.Base.FontSizeConverter.synoFontSizePtMap[o];t.style.fontSize=i*this.fontSizeRatio+"pt",t.style.letterSpacing="normal"},convertLineHeightByElementStyle:function(t){if(!Ext.isEmpty(t.style.lineHeight)){var e=parseFloat(t.style.lineHeight);Ext.isNumber(e)&&this.convertStyleFromScale("lineHeight",t,e)}},convertFontSizeFromString:function(t){var e=SYNO.SDS.NoteStation.Editor.Base.FontSizeConverter.fontSizePxMap[t.style.fontSize];e&&(t.style.fontSize=e*this.fontSizeRatio+"px",t.style.letterSpacing="normal")},convertStyleFromScale:function(t,e,o){var i=["pt","px","in","cm","mm","pc"],n=e.style[t].substring(o.toString().length);-1!==i.indexOf(n)&&(e.style[t]=o*this.fontSizeRatio+n,e.style.letterSpacing="normal")}}),Ext.define("SYNO.SDS.NoteStation.Editor.Empty.Panel",{extend:"SYNO.SDS.NoteStation.Editor.Base.Panel",constructor:function(t){SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Editor.Empty.Panel",this);var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e=String.format('<div class="syno-ns-editor-empty-ct"><div class="syno-ns-editor-empty-icon"></div><div class="disable-font syno-ns-editor-empty-slogan">{0}</div></div>',SYNO.SDS.NoteStation._T("common","please_select_item")),o={cls:"syno-ns-editor-empty-panel",html:e,listeners:{activate:function(t){t.items.each(function(t){t.fireEvent("activate",t)},this)}}};return Ext.apply(o,t),o}}),Ext.define("SYNO.SDS.NoteStation.Editor.Password.Panel",{extend:"SYNO.SDS.NoteStation.Editor.Base.Panel",constructor:function(t){SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Editor.Password.Panel",this);var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e={cls:"syno-ns-editor-passsword-panel",items:[{xtype:"box",cls:"syno-ns-editor-password-icon"},{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("common","enter_password")+":",hideLabel:!0,cls:"syno-ns-editor-password-message"},{xtype:"syno_compositefield",hideLabel:!0,cls:"syno-ns-editor-password-input",items:[{xtype:"syno_textfield",textType:"password",id:this.textfieldId=Ext.id(void 0,"syno-ns-password"),enableKeyEvents:!0,listeners:{keyup:function(t,e){13!==e.keyCode||Ext.isEmpty(t.getValue())||this.onClickOk()},scope:this}},{xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onClickOk,scope:this}]}],listeners:{show:function(){Ext.getCmp(this.textfieldId).focus(!0,100)},activate:function(t){t.items.each(function(t){t.fireEvent("activate",t)},this)}}};return Ext.apply(e,t),e},saveEncryptedObj:function(t){this.encryptedObj=t},onClickOk:function(){var t,e,o,i,n,s,a=Ext.getCmp(this.textfieldId),r=a.getValue();t=this.encryptedObj.succ,e=this.encryptedObj.resp,s=this.encryptedObj.activeItemId,n=this.owner.getComponent(s),o=function(o){o?(this.owner.layout.setActiveItem(s),n.onLoadNoteDone(e)):(n.onLoadNote(t,e),a.focus(!0,100)),this.clearStatusBusy()},i={callback:o,input:r,scope:this},a.setValue(""),this.setStatusBusy(),this.onDecryptContent(t,e,i)},onDecryptContent:function(t,e,o){var i,n,s,a=this.findAppWindow(),r="";if(Ext.isObject(o)){n=o.input,i=o.callback,s=o.scope;try{r=CryptoJS.AES.decrypt(e.content,n).toString(CryptoJS.enc.Utf8)}catch(t){}return r.substring(0,SYNO.SDS.NoteStation.Define.MAGIC.length)===SYNO.SDS.NoteStation.Define.MAGIC?void a.createEncryptToken({object_id:e.object_id,password:n},function(){e.content=r.substring(SYNO.SDS.NoteStation.Define.MAGIC.length),Ext.isFunction(i)&&i.call(s||window,!0)},this):void a.getMsgBox().alert(SYNO.SDS.NoteStation._T("error","title"),_T("common","err_pass"),function(){Ext.isFunction(i)&&i.call(s||window,!1)},this)}}}),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.FileLabel",{extend:"Ext.util.Observable",constructor:function(t){this.addEvents("upload","remove","preview"),this.owner=t.owner,this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e=Ext.apply({width:"480px",labelHolderCls:"syno-ddupload-fileLabelHolder",labelCls:"syno-ddupload-fileLabel",labelContainerCls:"syno-ddupload-fileLabelContainer",labelTextCls:"syno-ddupload-fileLabelText",labelOperCls:"syno-ddupload-fileOper",fileNameContainerCls:"syno-ddupload-fileNameContainer",fileNameCls:"syno-ddupload-fileName",fileSizeCls:"syno-ddupload-fileSize",delBtnCls:"syno-ddupload-fileDelButton",previewBtnCls:"syno-ddupload-filePreviewButton",normalColor:"rgb(228, 243, 253)",succColor:"#BFB",warnColor:"#FFC",errorColor:"#FDD"},t.settings),o=Ext.applyIf(t.file,{name:"EmptyFileName",size:"0"}),i={UPLOADING:1,UPLOADED:2,DELETING:3,DELETED:4,ABORTED:5,REMOTE:6,LOCAL:7,ERROROCCURED:9,CALCULATING:10},n=Ext.applyIf({owner:t.owner,isRealFile:!Ext.isEmpty(t.file_id),stateEnum:i,state:Ext.isEmpty(t.file_id)?i.LOCAL:i.REMOTE,file_id:t.file_id,file:o,settings:e},t);return Ext.apply(this,n),n},onProgress:function(t){var e;return Ext.isEmpty(this.elms)?(this.state=this.stateEnum.UPLOADED,100):"ds"===this.file.format?(this.elms.fileSize.innerHTML=String.format("({0})",SYNO.SDS.NoteStation._T("editor","upload_processing")),this.state=this.stateEnum.UPLOADED,100):(e=Math.round(t/this.file.size*100),(!0===isNaN(e)||e>100)&&(e=100),this.elms.fileSize.innerHTML=String.format("({0})",e.toFixed(2)+"%"),100===e?(this.elms.fileSize.innerHTML=String.format("({0})",SYNO.SDS.NoteStation._T("editor","upload_processing")),this.state=this.stateEnum.UPLOADED):this.state=this.stateEnum.UPLOADING,e)},onError:function(t){this.elms.fileSize.innerHTML=String.format("({0})",t),this.state=this.stateEnum.LOCAL},isImage:function(){return 0===this.file.type.indexOf("image")},download:function(){Ext.isEmpty(this.webapi_params)||(!0===SYNO.SDS.NoteStation.Utils.isMobileiOS?window.open(this.appWindow.getBaseURL(this.webapi_params,!0,this.file.name)):this.appWindow.downloadWebAPI({webapi:this.webapi_params,filename:this.file.name}))},renderTo:function(t){if(this.elms&&Ext.isElement(this.elms.main))return void t.appendChild(this.elms.main);if(!Ext.isEmpty(this.module.noteData)){if(this.elms={},this.elms.main=Ext.DomHelper.createDom({tag:"div",cls:"clearfix "+this.settings.labelCls,style:{width:this.settings.width}}),this.elms.container=Ext.DomHelper.createDom({tag:"div",cls:this.settings.labelContainerCls},this.elms.main),this.elms.labelText=Ext.DomHelper.createDom({tag:"div",cls:this.settings.labelTextCls},this.elms.container),this.elms.fileNameContainer=Ext.DomHelper.createDom({tag:"div",cls:this.settings.fileNameContainerCls},this.elms.labelText),this.stateEnum.REMOTE===this.state){this.elms.fileName=Ext.DomHelper.createDom({tag:"div",
cls:"link-font "+this.settings.fileNameCls,html:Ext.util.Format.htmlEncode(this.file.name)+" "},this.elms.fileNameContainer);var e={object_id:this.module.noteData.object_id,ver:this.module.noteData.ver,format:"raw",file_id:this.file_id,mode:"download"};this.module.noteData.encrypt&&(e.token=this.owner.owner.findAppWindow().getEncryptPassword(this.module.noteData.object_id).token),Ext.isObject(this.module.notePerm)&&Ext.copyTo(e,this.module.notePerm,"perm_from,smart_id"),this.webapi_params={api:"SYNO.NoteStation.Note",version:3,method:"download",params:e},Ext.get(this.elms.fileName).on("click",this.download,this),this.elms.fileSize=Ext.DomHelper.createDom({tag:"div",cls:"disable-font "+this.settings.fileSizeCls,html:"("+Ext.util.Format.fileSize(this.file.size)+")"},this.elms.labelText),this.elms.labelOper=Ext.DomHelper.createDom({tag:"div",cls:this.settings.labelOperCls},this.elms.container),this.elms.previewBtn=Ext.DomHelper.createDom({tag:"div",cls:this.settings.previewBtnCls},this.elms.labelOper),Ext.get(this.elms.previewBtn).on("click",function(t){this.fireEvent("preview",this,t)},this),!0!==this.readonly&&(this.elms.delBtn=Ext.DomHelper.createDom({tag:"div",cls:this.settings.delBtnCls},this.elms.labelOper),Ext.get(this.elms.delBtn).on("click",function(){this.fireEvent("remove",this)},this))}else this.elms.fileName=Ext.DomHelper.createDom({tag:"div",cls:"normal-font "+this.settings.fileNameCls,html:Ext.util.Format.htmlEncode(this.file.name)+" "},this.elms.fileNameContainer),this.elms.fileSize=Ext.DomHelper.createDom({tag:"div",cls:"disable-font "+this.settings.fileSizeCls,html:"("+SYNO.SDS.NoteStation._T("editor","upload_waiting")+")"},this.elms.labelText);t.appendChild(this.elms.main),this.adjustTextWidth()}},adjustTextWidth:function(){var t,e,o;o=Ext.get(this.elms.fileSize).getWidth()+12,this.elms.labelOper&&(o+=Ext.get(this.elms.labelOper).getWidth()+10),e=Ext.get(this.elms.container),t=Ext.get(this.elms.fileName),t.getWidth()+o>e.getWidth()&&t.setWidth(e.getWidth()-o)},showContext:function(t,e,o){var i,n,s,a=this.editor.plugins.syno_attachment_viewer,r=0,l=0;s=Ext.get(o.previewBtn),i=o.insertAfterPlace,t.previewClickBtn=s,s.addClass("syno-ddupload-filePreviewButton-clicked"),t.update(""),Ext.each(e,function(e){var i;n=Ext.DomHelper.createDom({tag:"div",cls:"syno-ns-editor-tinymce-preview-content",html:a.support_ext_collect[e].doc}),Ext.get(n).on("click",function(){this.editor.execCommand("syno_attachment_viewer",{},Ext.apply({type:e},o)),this.owner.deletePreviewBubbleElm()},this),t.appendChild(n),i=Ext.util.TextMetrics.measure(n,a.support_ext_collect[e].doc),i.width>r&&(r=i.width),l+=i.height},this),t.show(),i===this.editor.getContentAreaContainer()?(r+=56,r+s.getX()<=i.offsetWidth?t.setX(s.getX()):t.setX(s.getX()+s.getWidth()-r),l+=14,l+s.getY()+s.getHeight()<=i.offsetHeight?t.setY(s.getY()+s.getHeight()):t.setY(s.getY()-l)):(t.setXY(t.getAlignToXY(s,"tr-br")),t.getBottom()>i.getBottom()&&t.setXY(t.getAlignToXY(s,"br-tr")))}}),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.DDUpload",{extend:"Ext.util.Observable",local_prefix:"tmp_file_",adjust_size:SYNO.SDS.NoteStation.Define.IMAGE_PROPER_LENGTH,transparent_gif:"webman/3rdparty/NoteStation/images/transparent.gif",constructor:function(t){this.addEvents("drop","refresh"),this.owner=t.owner,this.module=t.module,this.img_loading_list=[],this.img_loading_callback={},this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e=Ext.applyIf({imageTypes:/^image/i,owner:t.owner,modified:!1,items:[],listeners:{drop:function(t){var e,o,i=this.owner.getEditor(),n=i.getDoc();if(this.owner._S("demo_mode"))return void SYNO.SDS.NoteStation.Utils.showErrorMsg(this.owner.findAppWindow(),116);Ext.isFunction(n.caretRangeFromPoint)||Ext.isFunction(n.caretPositionFromPoint)||Ext.isFunction(n.body.createTextRange)?i.selection.placeCaretAt(t.clientX,t.clientY):(o=t.toElement?t.toElement:t.target?t.target:this.owner.getEditor().getBody().lastChild,o.parentNode===n?i.selection.setCursorLocation(this.owner.getEditor().getBody().lastChild):i.selection.setCursorLocation(o)),this.listAllFiles(t.dataTransfer,function(t){if(!Ext.isEmpty(t))for(this.modified=!0,e=0;e<t.length;++e)this.addFile(void 0,t[e])},this)},refresh:{fn:this.refresh,buffer:100,scope:this},scope:this}},t);return Ext.apply(this,e),e},traverseFileTree:function(t,e){var o=this;if(t)if(e.total++,!0===t.isFile)t.file(function(t){e.files.push(t),e.count++});else if(!0===t.isDirectory){var i=t.createReader();i.readEntries(function(t){for(var i=0;i<t.length;i++)o.traverseFileTree(t[i],e);e.total--})}},listAllFiles:function(t,e,o){var i,n,s={count:0,total:0,files:[]};if(t.items){for(i=0;i<t.items.length;i++){var a=t.items[i];a.GetAsEntry?this.traverseFileTree(a.getAsEntry(),s):a.webkitGetAsEntry&&this.traverseFileTree(a.webkitGetAsEntry(),s)}n=window.setInterval(function(){s.total===s.count&&(window.clearInterval(n),e.call(o,s.files))},500)}else if(t.files){for(i=0;i<t.files.length;i++){var r=t.files[i];if(Ext.isGecko){try{var l;if(window.File&&window.File.prototype.slice?l=r.slice(0,1):window.File&&window.File.prototype.webkitSlice?l=r.webkitSlice(0,1):window.File&&window.File.prototype.mozSlice?l=r.mozSlice(0,1):s.files.push(r),l&&window.FileReader){var d=new FileReader;d.readAsBinaryString(l)}}catch(t){continue}s.files.push(r)}else s.files.push(r)}e.call(o,s.files)}},checkImage:function(){var t=this,e=this.owner.getEditor().getBody();Promise.all(Array.from(e.querySelectorAll("img")).map(function(e){return e.classList.contains("syno-notestation-image-object")?Promise.resolve(!1):e.classList.contains("syno-notestation-image-object-convert-to-dataurl")?t.convertSynoImageToDataUrl(e).then(function(){return!0}):Promise.resolve(!0)})).then(function(e){e.some(function(t){return t})&&(t.modified=!0,t.module.saveNote())})},getRandomString:function(t){return(new Date*Math.random()).toString(36).replace(".","A").substr(0,t)},addImage:function(t,e,o){var i,n,s,a,r=this.owner.getEditor();if(Ext.isObject(t)||Ext.isObject(o))return Ext.isObject(o)||(o={isAdjust:"false"}),Ext.isEmpty(o.dimensions)&&(o.dimensions=["null","null"]),"null"===o.dimensions[0]&&"null"===o.dimensions[1]||(o.isAdjust="true"),Ext.isEmpty(o.ref)?(n=SYNO.SDS.NoteStation.Utils.genUniqueImageRef(t.editor.getBody(),t.file.name),t.file.ref=n):n=o.ref,s=SYNO.SDS.NoteStation.Utils.getWidthAttr(o.dimensions[0]),a=SYNO.SDS.NoteStation.Utils.getHeightAttr(o.dimensions[1]),Ext.isEmpty(e)?(i=String.format('<img class="syno-notestation-image-object" src="{4}" data-mce-src="{4}" ref="{0}" {1} {2} adjust="{3}"> </img>',n,s,a,o.isAdjust,Ext.isEmpty(o.src)?this.transparent_gif:o.src),!1===r.getBody().contains(r.selection.getNode())&&r.selection.setCursorLocation(this.owner.getEditor().getBody().lastChild),r.insertContent(i)):(e.dom.setAttribute("ref",n),Ext.isEmpty(e.dom.src)&&e.dom.setAttribute("src",this.transparent_gif),e.dom.setAttribute("data-mce-src",this.transparent_gif),"null"!==o.dimensions[0]&&e.dom.setAttribute("width",o.dimensions[0]),"null"!==o.dimensions[1]&&e.dom.setAttribute("height",o.dimensions[1]),Ext.isBoolean(o.isAdjust)&&e.dom.setAttribute("adjust",o.isAdjust)),n},adjustImageDimension:function(t){var e,o,i,n;if(Ext.isObject(t)&&!Ext.isEmpty(t.ref)&&!Ext.isEmpty(t.mode)&&(o=Ext.get(this.owner.getEditor().getBody()),e=o.query(String.format('img[ref="{0}"]',t.ref)),0!==e.length&&!Ext.isEmpty(this.module.noteData))){if("original"===t.mode)i="null",n="null";else if("proper"===t.mode&&Ext.isObject(t.file))t.file.width>=t.file.height&&t.file.width>this.adjust_size?(i=this.adjust_size,n="null"):t.file.width<t.file.height&&t.file.height>this.adjust_size&&(i="null",n=this.adjust_size);else{if("userset"!==t.mode||!Ext.isArray(t.dimensions))return;i=t.dimensions[0],n=t.dimensions[1]}e.forEach(function(t){"null"===i?t.removeAttribute("width"):t.setAttribute("width",i),"null"===n?t.removeAttribute("height"):t.setAttribute("height",n),t.setAttribute("adjust","true")},this),this.fireEvent("refresh")}},showOriginImageByRef:function(t){var e=this.items.filter(function(e){return!!Ext.isObject(e.file)&&(e.file.ref===t||void 0)});if(0!==e.length){var o=e[0];window.open(this.getFileUrl(o,o.file.diff_ver||this.module.noteData.ver,o.file.name))}},getFileUrl:function(t,e,o){var i=this.owner.findAppWindow(),n=window.location.pathname.substr(0,window.location.pathname.lastIndexOf("/"))+"/",s=n+"ns/dv/"+this.module.noteData.link_id+"/"+e+"/"+t.file_id+"/"+encodeURIComponent(o);return this.module.noteData.encrypt&&(s+='?token="'+i.getEncryptPassword(this.module.noteData.object_id).token+'"'),Ext.isObject(this.module.notePerm)&&(s=Ext.urlAppend(s,Ext.urlEncode(SYNO.API.EncodeParams(Ext.copyTo({},this.module.notePerm,"perm_from,smart_id"))))),i.tid&&(s=Ext.urlAppend(s,"tid="+i.tid)),s},updateImage:function(t){var e,o,i,n,s=this.owner.findAppWindow();return!(Ext.isEmpty(t.file_id)||Ext.isEmpty(t.file.md5)||Ext.isEmpty(t.file.name)||Ext.isEmpty(t.file.ref))&&(!t.file_id.startsWith(this.local_prefix)&&(e=Ext.get(this.owner.getEditor().getBody()),!Ext.isEmpty(e)&&(o=e.select(String.format('img[ref="{0}"]',t.file.ref)),0===o.getCount()||Ext.isEmpty(this.module.noteData)?(t.state=t.stateEnum.DELETED,!1):(i=this.getFileUrl(t,t.file.diff_ver||this.module.noteData.ver,t.file.name),Ext.isObject(s.settings)&&!0===s.settings.inline_thumb&&(i+="&thumb=true"),n={adjust:!0},t.file.width>=t.file.height&&t.file.width>this.adjust_size?n.width=this.adjust_size:t.file.width<t.file.height&&t.file.height>this.adjust_size&&(n.height=this.adjust_size),o.each(function(e){this.img_loading_list.push(t.file.ref),e.on("load",this.onImageLoaded,this,{single:!0}),e.on("error",this.onImageLoaded,this,{single:!0}),e.set({src:i,"data-mce-src":i},!0),Ext.isObject(n)&&"true"!==e.getAttribute("adjust")&&(e.dom.setAttribute("adjust","true"),Ext.isNumber(n.width)?e.dom.setAttribute("width",n.width):e.dom.removeAttribute("width"),Ext.isNumber(n.height)?e.dom.setAttribute("height",n.height):e.dom.removeAttribute("height"))},this),!0))))},onImageLoaded:function(t,e){var o=e.getAttribute("ref"),i=-1;Ext.isEmpty(o)||(i=this.img_loading_list.indexOf(o),-1!==i&&this.img_loading_list.splice(i,1),this.handleImageReadyCallback())},handleImageReadyCallback:function(){var t;0===this.img_loading_list.length&&(t=this.img_loading_callback,this.img_loading_callback={},window.setTimeout(function(){Ext.iterate(t,function(t,e){e.callback.call(e.scope)})},120))},onImageReady:function(t,e,o){if(!Ext.isFunction(t))return!1;Ext.isEmpty(o)&&(o=Ext.id()),this.img_loading_callback[o]={callback:t,scope:e},this.handleImageReadyCallback()},addFile:function(t,e,o){var i,n,s;try{n=this.owner.getEditor().plugins.syno_attachment_viewer.getSupportExt}catch(t){n=function(){return!1}}return s=this.owner.findAppWindow(),i=new SYNO.SDS.NoteStation.Editor.Tinymce.FileLabel({file_id:t,file:e,owner:this,module:this.module,appWindow:s,editor:this.owner.getEditor(),readonly:this.readonly,previewFn:n,listeners:{remove:function(t){var e=this.items.indexOf(t);if(-1===e)return void SYNO.Debug(t);this.modified=!0,this.items.splice(e,1),this.removeImage(t),this.fireEvent("refresh")},preview:function(t,e,o){var i,n,s,a=window.encodeURIComponent(t.file.name),r=t.previewFn(a);return i=this.getFileUrl(t,this.module.noteData.ver,a),n={object_id:this.module.noteData.object_id,ver:this.module.noteData.ver,file_id:t.file_id,url:i,filename:t.file.name,encrypt:this.module.noteData.encrypt,previewBtn:t.elms.previewBtn,insertAfterPlace:t.editor.getContentAreaContainer()},this.previewBubbleElm&&this.deletePreviewBubbleElm(),Ext.isString(r)?(n.type=r,t.editor.execCommand("syno_attachment_viewer",{},n)):Ext.isArray(r)?(Ext.isObject(o)&&Ext.apply(n,o),s=this.getPreviewContext(o),t.showContext(s,r,n)):window.open(Ext.urlAppend(i,"")),e&&(e.stopPropagation(),e.preventDefault()),!1},scope:this}}),Ext.isEmpty(t)?i.isImage()&&this.addImage(i,o):Ext.isEmpty(this.originalFiles[t])&&(this.originalFiles[t]=e),this.modified=!0,this.items.push(i),this.fireEvent("refresh"),i},deletePreviewBubbleElm:function(){Ext.isEmpty(this.previewBubbleElm)||(this.previewBubbleElm.previewClickBtn&&this.previewBubbleElm.previewClickBtn.removeClass("syno-ddupload-filePreviewButton-clicked"),Ext.destroy(this.previewBubbleElm),delete this.previewBubbleElm)},getPreviewContext:function(t){var e,o,i,n=this;return e=Ext.DomHelper.createDom({tag:"div",cls:"syno-ns-editor-tinymce-preview-bubble"}),o=this.owner.getEditor(),this.previewBubbleElm=Ext.get(e),this.previewBubbleElm.setVisibilityMode(Ext.Element.DISPLAY),Ext.isObject(t)?i=t.insertAfterPlace:(i=o.getBody(),o.once("click blur",function(){Ext.isEmpty(n.previewBubbleElm)||n.previewBubbleElm.isVisible()&&n.deletePreviewBubbleElm()})),Ext.isEmpty(this.clickHandler)||Ext.getBody().un("click",this.clickHandler),this.clickHandler=function(t){Ext.isEmpty(n.previewBubbleElm)||!t.within(n.previewBubbleElm)&&n.previewBubbleElm.isVisible()&&n.deletePreviewBubbleElm()},Ext.getBody().on("click",this.clickHandler),this.previewBubbleElm.insertAfter(i),this.previewBubbleElm},getLabelByRef:function(t){var e;return Ext.isEmpty(t)?e:(this.items.forEach(function(o){if(Ext.isObject(o.file))return o.file.file_ref===t?(e=o,!1):void 0}),e)},showAttachmentMenuByRef:function(t,e){var o,i=this.getLabelByRef(t),n=this,s=this.owner.getEditor();return!!i&&(i.fireEvent("preview",i,null,{previewBtn:e,insertAfterPlace:Ext.get(this.owner.getEditor().getBody())}),o=Ext.get(s.getBody()),o.addListener("click",function(){Ext.isEmpty(n.previewBubbleElm)||n.previewBubbleElm.isVisible()&&n.deletePreviewBubbleElm()},this,{single:!0}),o.addListener("blur",function(){Ext.isEmpty(n.previewBubbleElm)||n.previewBubbleElm.isVisible()&&n.deletePreviewBubbleElm()},this,{single:!0}),!0)},removeAttachmentByRef:function(t){var e=this.getLabelByRef(t);return!!e&&(e.fireEvent("remove",e),!0)},downloadAttachmentByRef:function(t){var e=this.getLabelByRef(t);return!!e&&(e.download(),!0)},removeImage:function(t){var e,o;t.state=t.stateEnum.DELETED,Ext.isEmpty(t.file.name)||Ext.isEmpty(t.file.md5)||(e=Ext.get(this.owner.getEditor().getBody()),o=e.select(String.format('img[ref="{0}"]',t.file.ref)),0!==o.getCount()&&o[0].remove())},setFiles:function(t,e,o){var i,n=[],s={};if(this.originalFiles={},this.img_loading_list=["null"],Ext.isObject(e)&&(Ext.iterate(e,function(t,e){e.local_id&&(s[e.local_id]=!0)},this),Ext.iterate(this.items,function(t){Ext.isEmpty(t.file_id)&&t.state!==t.stateEnum.UPLOADED&&(Ext.isEmpty(t.local_id)||!0!==s[t.local_id])&&n.push(t)},this)),this.items=[],Ext.isObject(t))for(i in t)t.hasOwnProperty&&(this.originalFiles[i]=Ext.apply({},t[i]),this.addFile(i,t[i]));n.length>0?(this.modified=!0,this.items=this.items.concat(n)):this.modified=!1,this.fireEvent("refresh",o)},renderTo:function(t){this.elm||(this.elm=Ext.DomHelper.createDom({tag:"div",cls:"clearfix syno-ddupload-fileLabelHolder",style:{position:"relative"}})),Ext.get(this.elm).insertAfter(t),this.refresh()},removeInvalidImg:function(){var t={};this.items.forEach(function(e){Ext.isObject(e.file)&&!Ext.isEmpty(e.file.ref)&&(t[e.file.ref]=!0)}),Ext.iterate(this.owner.getEditor().getBody().querySelectorAll("img[ref]"),function(e){var o=e.getAttribute("ref");Ext.isEmpty(o)||o in t||Ext.removeNode(e)})},refresh:function(t){var e=!1;if("null"===this.img_loading_list[0]&&(this.img_loading_list=[]),!Ext.isDefined(this.elm))return void SYNO.Debug("elm is not defined");this.elm.innerHTML="",this.items.forEach(function(t){!1===this.updateImage(t)&&t.state!==t.stateEnum.DELETED&&t.renderTo(this.elm),t.state===t.stateEnum.LOCAL&&(e=!0)},this),t&&(this.resetContent(),this.owner.originalContent=this.owner.getEditor().getContent(),this.restoreContent()),!0===e&&this.module.saveNote(),this.handleImageReadyCallback()},renderImages:function(t){Ext.isObject(t)&&Ext.iterate(t,function(t,e){this.items.forEach(function(o){o.file.md5===e.md5&&o.file.name===e.name&&(o.file=e,o.file_id=t,this.updateImage(o))},this)},this)},handleHttpSrc:function(t,e){var o,i,n;o=t.dom.src,i=o.indexOf("?"),-1!==i&&(o=o.substr(0,i)),i=o.lastIndexOf("/"),o=-1===i?(new Date).getTime()+".jpg":o.substr(i+1),Ext.isEmpty(o)&&(o=(new Date).getTime()+".jpg"),o=Ext.id(void 0,"ns_attach_image_")+o,n=SYNO.SDS.NoteStation.Utils.utf8_to_b64(o),t.dom.setAttribute("ref",n),t.dom.setAttribute("adjust","true"),e[o]={action:"create",format:"url",source:t.dom.src,ref:n,rotate:!1}},handleDataUrlSrc:function(t,e){var o,i,n;o=t.dom.src.match(/^data:image\/([a-zA-Z0-9]*);base64,/),Ext.isEmpty(o)||(i=Ext.id(void 0,"ns_attach_image_")+(new Date).getTime(),2==o.length?i+="."+o[1]:i+=".jpg",n=SYNO.SDS.NoteStation.Utils.dataURItoBlob(t.dom.src),n.name=i,Ext.isEmpty(n)||(t.dom.setAttribute("adjust","true"),this.addFile(void 0,n,t)))},convertSynoImageToDataUrl:function(t){var e=t.src;return t.crossOrigin="use-credentials",t.removeAttribute("src"),new Promise(function(o){t.addEventListener("load",function(e){var i=document.createElement("canvas"),n=i.getContext("2d");if(!n)return void o();if(!t.classList.contains("syno-notestation-image-object-convert-to-dataurl"))return void o();t.classList.remove("syno-notestation-image-object-convert-to-dataurl"),i.width=t.naturalWidth,i.height=t.naturalHeight;try{n.drawImage(t,0,0),t.src=i.toDataURL()}catch(e){SYNO.Debug(e),t.classList.add("syno-notestation-image-object")}t.removeAttribute("crossorigin"),t.removeAttribute("data-mce-src"),t.removeAttribute("id"),o()}),t.src=Ext.urlAppend(e,"_nsdc=52",!1)})},getModifiedFiles:function(){var t,e,o={},i={},n={};e=Ext.get(this.owner.getEditor().getBody()),e.select("img").each(function(t){var e;if(!t.hasClass("syno-ns-chart-object")){if(t.hasClass("syno-notestation-image-object"))return void(Ext.isEmpty(t.getAttribute("ref"))||(n[t.getAttribute("ref")]=!0));if(t.addClass("syno-notestation-image-object"),e=t.dom.src,Ext.isString(e)){if(Ext.isEmpty(e.match(/^http[s]?:/i))){if(Ext.isEmpty(e.match(/^data:image\/[a-zA-z0-9]*;base64/)))return;this.handleDataUrlSrc(t,o)}else this.handleHttpSrc(t,o);o.local_id=Ext.id(void 0,this.local_prefix)}}},this),this.items.forEach(function(t){Ext.isEmpty(t.file_id)?(t.file.local_id=Ext.id(void 0,this.local_prefix),"ds"===t.file.format?o[t.file.name]={action:"create",format:"ds",source:t.file.source,ref:t.file.ref,local_id:t.file.local_id}:o[t.file.name]={action:"create",format:"raw",source:t.file,ref:t.file.ref,local_id:t.file.local_id}):i[t.file_id]=!0},this),Ext.iterate(this.originalFiles,function(t,e){t in i&&Ext.isEmpty(e.ref)||e.ref in n||(o[t]={action:"delete",name:t})},this);for(t in o)if(o.hasOwnProperty(t))return o},getExistFiles:function(){var t,e,o={},i={},n={};e=Ext.get(this.owner.getEditor().getBody()),e.select("img").each(function(t){if(t.hasClass("syno-notestation-image-object"))return void(Ext.isEmpty(t.getAttribute("ref"))||(n[t.getAttribute("ref")]=!0))},this),this.items.forEach(function(t){Ext.isEmpty(t.file_id)||(i[t.file_id]=!0)},this),Ext.iterate(this.originalFiles,function(t,e){if(t in i||e.ref in n)return void(o[t]=e)},this);for(t in o)if(o.hasOwnProperty(t))return o},isDirty:function(){return this.modified},clearDirty:function(t){this.modified=!1,this.originalFiles={},this.items.forEach(function(e){!0!==t&&Ext.isEmpty(e.file_id)&&(e.file_id=Ext.id(void 0,this.local_prefix)),Ext.isEmpty(e.file_id)||(this.originalFiles[e.file_id]=e.file)},this)},resetContent:function(){var t,e,o,i={};o=this.owner.getEditor(),Ext.isEmpty(o)||(Ext.iterate(this.originalFiles,function(t,e){Ext.isEmpty(e.ref)||(i[e.ref]=!0)},this),t=Ext.get(this.owner.getEditor().getBody()),Ext.each(t.query("img.syno-notestation-image-object"),function(t){e=t.getAttribute("ref"),Ext.isEmpty(e)||e in i&&t.setAttribute("data-mce-src",this.transparent_gif)},this))},restoreContent:function(){var t,e,o,i={};Ext.iterate(this.originalFiles,function(t,e){Ext.isEmpty(e.ref)||(i[e.ref]=!0)},this),t=Ext.get(this.owner.getEditor().getBody()),Ext.each(t.query("img.syno-notestation-image-object"),function(t){e=t.getAttribute("ref"),o=t.getAttribute("src"),Ext.isEmpty(e)||o===t.getAttribute("data-mce-src")||e in i&&t.setAttribute("data-mce-src",o)},this)}}),Ext.define("SYNO.SDS.NoteStation.FileButton",{extend:"SYNO.ux.FileButton",multiSelect:!0,constructor:function(t){this.callParent(arguments),this.filenames=[],this.files=[]},onRender:function(){this.callParent(arguments),this.multiSelect&&this.el.dom.setAttribute("multiple","")},onFileChange:function(t,e,o){var i=t.target.files;this.files=[],Ext.each(i,function(t){this.files.push(t)},this);var n=this.getFilenames().join(",");this.fileTextField.setValue(n),this.fireEvent("change",n)},getFiles:function(){return this.files},getFilenames:function(){return this.files.map(function(t){return t.name})}}),Ext.ns("SYNO.SDS.NoteStation.Editor.Tinymce"),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.Image",{extend:"SYNO.SDS.NoteStation.ModalWindow",isHiddenUploadPart:!1,properLength:SYNO.SDS.NoteStation.Define.IMAGE_PROPER_LENGTH,constructor:function(t){this.module=t.module,this.owner=t.owner,this.appWin=this.findAppWindow(),this.enableKeepFocusOnEditor(),this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e=t.imageData;Ext.isEmpty(e)||(this.isHiddenUploadPart=!0);var o={title:SYNO.SDS.NoteStation._T("tooltip","insert_image"),width:620,height:this.isHiddenUploadPart?240:440,layout:"fit",cls:"syno-ns-insert-image-win",items:this.getImageUploadFormPanel(t),buttons:[{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:_T("common","ok"),handler:this.onClickOk,scope:this}],listeners:{show:function(){var t=this.appWin.getMainPanel().getEditorPanel().normalPanel;Ext.isEmpty(t)||!0===t.noteSaving&&(this.mon(t.owner,"notesaved",this.clearStatusBusy,this,{single:!0}),this.setStatusBusy())}}};return Ext.apply(o,t)},saveAndShow:function(){var t,e=this.appWin.getMainPanel().getEditorPanel().normalPanel,o=e.tinymcePanel;if(!0!==e.noteSaving&&e.saveNote(),e.noteDialogOpened=!0,t=Ext.get(o.getEditor().getBody()),Ext.isEmpty(t))return!1;this.on("close",function(){delete e.noteDialogOpened}),this.show()},isProperSize:function(t){var e,o,i,n;return e=t.oriWidth,o=t.oriHeight,i=t.width,n=t.height,e>=o&&this.properLength==i||o>e&&this.properLength==n},getImageUploadFormPanel:function(t){var e,o,i,n,s=t.imageData,a=!1,r=!1,l=!1;return Ext.isEmpty(s)?l=!0:(e=s.oriWidth,o=s.oriHeight,i=s.width,n=s.height,i===e&&n===o?a=!0:!0===this.isProperSize(s)?l=!0:r=!0),this.imageUploadFormPanel=new SYNO.SDS.Utils.FormPanel({bodyStyle:"padding: 0",webapi:{api:"SYNO.NoteStation.Note",version:1,method:"set"},fieldWidth:250,labelWidth:200,cls:"syno-ns-editor-image-formpanel",fileUpload:!0,items:[{xtype:"hidden",name:"commit_msg",value:Ext.encode({device:"desktop"})},{xtype:"syno_radio",boxLabel:SYNO.SDS.NoteStation._T("tinymce","from_local_file"),inputValue:"from_local_file",hideLabel:!1,fieldLabel:SYNO.SDS.NoteStation._T("tinymce","image_source"),name:"image_from",checked:!0,hidden:this.isHiddenUploadPart},new SYNO.SDS.NoteStation.FileButton({name:"file",hideLabel:!1,buttonText:SYNO.SDS.NoteStation._T("tinymce","choose_file"),hidden:this.isHiddenUploadPart,multiSelect:SYNO.SDS.HTML5Utils.isSupportHTML5Upload()}),{xtype:"syno_radio",boxLabel:SYNO.SDS.NoteStation._T("tinymce","from_url"),hideLabel:!1,inputValue:"from_url",name:"image_from",hidden:this.isHiddenUploadPart},{xtype:"syno_textfield",textType:"default",name:"image_url",cls:"syno-ns-editor-image-url",width:292,hidden:this.isHiddenUploadPart},{xtype:"syno_radio",boxLabel:SYNO.SDS.NoteStation._T("upload","from_ds"),inputValue:"from_ds",hideLabel:!1,name:"image_from",hidden:this.isHiddenUploadPart},{xtype:"syno_filebutton",name:"ds_file_chooser",hideLabel:!1,buttonText:SYNO.SDS.NoteStation._T("tinymce","choose_file"),hidden:this.isHiddenUploadPart},{xtype:"syno_displayfield",hidden:this.isHiddenUploadPart},{xtype:"syno_radio",boxLabel:SYNO.SDS.NoteStation._T("tinymce","proper_size"),hideLabel:!1,name:"dimension_group",fieldLabel:SYNO.SDS.NoteStation._T("tinymce","dimensions"),inputValue:"proper",checked:l},{xtype:"syno_radio",boxLabel:SYNO.SDS.NoteStation._T("tinymce","original"),hideLabel:!1,name:"dimension_group",inputValue:"original",checked:a},{xtype:"syno_compositefield",name:"image_dimension",items:[{xtype:"syno_radio",hideLabel:!1,name:"dimension_group",inputValue:"userset",ctCls:"syno-ns-editor-image-dimension",boxLabel:" ",checked:r},{xtype:"syno_numberfield",hideLabel:!0,width:100,itemId:"image_width",name:"user_set_width",maxlength:5,cls:"syno-ns-editor-image-width",value:i&&r?i:void 0,allowBlank:!0},{xtype:"syno_displayfield",hideLabel:!0,value:"x"},{xtype:"syno_numberfield",hideLabel:!0,width:100,itemId:"image_height",name:"user_set_height",maxlength:5,cls:"syno-ns-editor-image-height",allowBlank:!0,value:n&&r?n:void 0}]}],listeners:{single:!0,afterlayout:function(t,e){var o;this.dummyRadioGroup1=new SYNO.ux.Utils.EnableRadioGroup(t.getForm(),"image_from",{from_url:["image_url"],from_local_file:["file"],from_ds:["ds_file_chooser"]}),this.dummyRadioGroup2=new SYNO.ux.Utils.EnableRadioGroup(t.getForm(),"dimension_group",{userset:["user_set_width","user_set_height"],original:[]}),o=this.imageUploadFormPanel.getForm().findField("ds_file_chooser"),o.el.addListener("click",function(t){return t.preventDefault(),this.onChooseFromDS(o),!1},this)},scope:this}}),this.imageUploadFormPanel},onFormSuccess:function(t,e){},onFormFailed:function(t,e){},enableKeepFocusOnEditor:function(){this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel").tinymcePanel.enableKeepFocusOnEditor()},disableKeepFocusOnEditor:function(){this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel").tinymcePanel.disableKeepFocusOnEditor()},closeModalWindow:function(){this.disableKeepFocusOnEditor(),this.close()},onClickCancel:function(){this.closeModalWindow()},onClickOk:function(t){var e,o=this.imageUploadFormPanel.getForm().findField("image_from").getGroupValue();this.isHiddenUploadPart?(e=this.getDimensions(),this.resizeFn(e),this.closeModalWindow()):"from_url"===o?this.uploadByURL():"from_local_file"===o?this.uploadImage(this.imageUploadFormPanel.getForm().findField("file").getFilenames(),"raw"):"from_ds"===o&&this.uploadImage(this.dsPaths,"ds")},onChooseFromDS:function(t){new SYNO.SDS.Utils.FileChooser.Chooser({owner:this,width:800,enumC2Share:!0,usage:{multiple:!0,type:"open"},getFilterPattern:function(t){return"jpg,jpeg,jpe,bmp,gif,png"},listeners:{choose:{fn:function(e,o,i){this.dsPaths=o.records.map(function(t){return t.data.path}),t.fileTextField.setValue(this.dsPaths.join(",")),e.close()}},scope:this}}).show()},getImageOriginalSize:function(t,e,o){var i;return!!Ext.isFunction(e)&&(i=Ext.get(Ext.DomHelper.createDom({tag:"img",src:t})),i.on("load",function(){e.call(o||window,[i.dom.width,i.dom.height])},this,{single:!0}),i.on("error",function(){e.call(o||window,[null,null])},this,{single:!0}),!0)},getProperDimension:function(t,e){var o=["null","null"];return t>=e&&t>this.properLength?o[0]=this.properLength:e>t&&e>this.properLength?o[1]=this.properLength:0!==t||0!==e?o=[t,e]:o[0]=this.properLength,o},getDimensions:function(){var t,e,o,i,n,s,a,r=["null","null"],l=this.imageData,d=this.imageUploadFormPanel.getForm().findField("image_from").getGroupValue();return t=this.imageUploadFormPanel.getForm(),a=t.findField("dimension_group").getGroupValue(),Ext.isEmpty(l)||(o=l.oriWidth,i=l.oriHeight),"original"==a?r:"proper"==a?Ext.isEmpty(l)?("from_url"===d&&(r="proper_from_url"),r):r=this.getProperDimension(o,i):(e=t.findField("image_dimension"),n=e.items.itemAt(1).getValue(),s=e.items.itemAt(3).getValue(),r=[Ext.isEmpty(n)||0===n?"null":n,Ext.isEmpty(s)||0===s?"null":s])},getAdjustType:function(){var t;return t=this.imageUploadFormPanel.getForm(),"proper"!==t.findField("dimension_group").getGroupValue()},getCurrentFileID:function(t,e){var o;for(o in e)if(e[o].ref===t)return o;return null},getNoteContent:function(t,e){var o,i;Ext.isObject(t)&&Ext.isObject(e)&&(i=this.owner.findAppWindow(),!0===t.noteData.encrypt&&(o=i.getEncryptPassword(t.noteData.object_id)),t.tinymcePanel.resetContentAttachment(),t.tinymcePanel.isContentDirty()&&(t.noteData.encrypt?e.content=CryptoJS.AES.encrypt(SYNO.SDS.NoteStation.Define.MAGIC+t.tinymcePanel.getContent(),o.password).toString():e.content=t.tinymcePanel.getContent(),e.brief=t.tinymcePanel.getBrief(),t.tinymcePanel.clearContentDirty()),t.tinymcePanel.restoreContentAttachment())},getNameFromURL:function(t){var e,o,i,n=Ext.id(void 0,"url_")+".jpg";return i=document.createElement("a"),i.href=t,-1===(e=i.pathname.lastIndexOf("/"))?n:(o=i.pathname.substr(e+1),-1===o.indexOf(".")?n:o)},uploadByURL:function(){var t,e,o,i,n,s=this.imageUploadFormPanel.getForm(),a=s.findField("image_url").getValue(),r=s.findField("dimension_group").getGroupValue();if(-1===a.search(/^http[s]?:\/\//))return o=this.appWin.getMsgBox(),void(Ext.isEmpty(o)||o.alert(SYNO.SDS.NoteStation._T("error","title"),SYNO.SDS.NoteStation._T("error","error_format")));i=this.getDimensions(),t=this.appWin.getMainPanel().getEditorPanel().normalPanel,e=t.tinymcePanel,t.setStatusBusy(),n=SYNO.SDS.NoteStation.Utils.genUniqueImageRef(e.getEditor().getBody(),a),e.ddupload.addImage(void 0,void 0,{ref:n,mode:r,isAdjust:!0,src:"webman/3rdparty/NoteStation/images/transparent.gif"});var l={attachment:[{action:"create",name:this.getNameFromURL(a),format:"url",source:a,ref:n,rotate:!0}],object_id:this.module.noteData.object_id,ver:this.module.noteData.ver,commit_msg:{device:"desktop",listable:!1}};t.owner.fireEvent("beforenotesaved",t),this.getNoteContent(t,l),this.module.noteData.encrypt&&(l.token=this.appWin.getEncryptPassword(this.module.noteData.object_id).token),Ext.isObject(this.module.notePerm)&&Ext.copyTo(l,this.module.notePerm,"perm_from,smart_id"),this.appWin.sendWebAPI({api:"SYNO.NoteStation.Note",version:3,method:"set",params:l,callback:function(o,s){var l,d;return t.clearStatusBusy(),t.owner.fireEvent("notesaved",o,s),o?(s=s.data[0],s.object_id!==this.module.noteData.object_id?void SYNO.Debug("resp.object_id !== noteData.object_id",o,s):(this.module.noteData.ver=s.ver,this.module.noteData.attachment=s.attachment,l=this.getCurrentFileID(n,s.attachment),void(Ext.isEmpty(l)?(d=e.getEditor().getBody().querySelector(String.format('img[ref="{0}"]',n)),"proper_from_url"===i?this.getImageOriginalSize(a,function(t){i=this.getProperDimension(t[0],t[1]),d.setAttribute("src",a),d.setAttribute("adjust",!0),"null"!==i[0]&&d.setAttribute("width",i[0]),"null"!==i[1]&&d.setAttribute("height",i[1])},this):(d.setAttribute("src",a),d.setAttribute("adjust",!0),"null"!==i[0]&&d.setAttribute("width",i[0]),"null"!==i[1]&&d.setAttribute("height",i[1]))):(e.ddupload.adjustImageDimension({file:s.attachment[l],ref:n,mode:r,dimensions:i}),e.ddupload.addFile(l,s.attachment[l]))))):void SYNO.Debug("upload failed",o,s)},scope:this}),this.closeModalWindow()},uploadImage:function(t,e){var o,i=this.imageUploadFormPanel.getForm(),n=i.findField("dimension_group").getGroupValue(),s=this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel"),a=s.tinymcePanel,r=this.getDimensions();if(!Array.isArray(t)||0===t.length)return void this.closeModalWindow();if("raw"===e&&!t.every(function(t){return SYNO.SDS.NoteStation.Utils.isSupportImageFormat(t)}))return void this.findAppWindow().getMsgBox().alert("",SYNO.SDS.NoteStation._T("error","error_format"));s.setStatusBusy(),o=t.map(function(t){return SYNO.SDS.NoteStation.Utils.genUniqueImageRef(a.getEditor().getBody(),t)}),o.forEach(function(t){a.ddupload.addImage(void 0,void 0,{ref:t,mode:n,isAdjust:!0})});var l={attachment:o.map(function(o,i){return{action:"create",name:SYNO.SDS.HTML5Utils.isSupportHTML5Upload()?t[i]:"file",format:e,source:t[i],ref:o,rotate:!0}}),commit_msg:{device:"desktop",listable:!1},object_id:this.module.noteData.object_id,ver:this.module.noteData.ver};s.owner.fireEvent("beforenotesaved",s),
this.getNoteContent(s,l),this.module.noteData.encrypt&&(l.token=this.appWin.getEncryptPassword(this.module.noteData.object_id).token),Ext.isObject(this.module.notePerm)&&Ext.copyTo(l,this.module.notePerm,"perm_from,smart_id");var d={api:"SYNO.NoteStation.Note",version:3,method:"set",params:l,callback:function(t,e){var i;return s.clearStatusBusy(),s.owner.fireEvent("notesaved",t,e),t?(e=e.data[0],e.object_id!==this.module.noteData.object_id?void SYNO.Debug("resp.object_id !== noteData.object_id",t,e):(this.module.noteData.ver=e.ver,this.module.noteData.attachment=e.attachment,void o.forEach(function(o){if(i=this.getCurrentFileID(o,e.attachment),Ext.isEmpty(i))return void SYNO.Debug("Can't getCurrentFileID",t,e,i);a.ddupload.adjustImageDimension({file:e.attachment[i],ref:o,mode:n,dimensions:r}),a.ddupload.addFile(i,e.attachment[i])},this))):void SYNO.Debug("upload failed",t,e)},scope:this};if("raw"===e)if(d.isUpload=!0,SYNO.SDS.HTML5Utils.isSupportHTML5Upload()){var c=new window.FormData;this.imageUploadFormPanel.getForm().findField("file").getFiles().forEach(function(t){c.append(t.name,t)}),Ext.iterate(d.params,function(t,e){c.append(t,Ext.encode(e))}),delete d.params,d.html5upload=!0,d.uploadData=c}else d.form=this.imageUploadFormPanel.getForm().getEl().dom;this.appWin.sendWebAPI(d),this.closeModalWindow()}}),Ext.ns("SYNO.SDS.NoteStation.Editor.Tinymce.Link"),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.Link.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.module=t.module,this.owner=t.owner,this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={resizable:!1,title:SYNO.SDS.NoteStation._T("tinymce","insert_edit_link"),autoHeight:!0,width:540,layout:"fit",cls:"syno-ns-insert-link-win",items:this.getFormPanel(t),buttons:[{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.onClickCancel},{xtype:"syno_button",btnStyle:"blue",text:_T("common","ok"),handler:this.onClickOk,scope:this}],listeners:{scope:this,single:!0,beforeshow:function(){this.pluginVar.onlyText&&!Ext.isEmpty(this.pluginVar.initialText)&&this.linkPanel.onUrlCheck()},show:function(){this.linkPanel.show()}}};return Ext.apply(e,t)},getFormPanel:function(t){return Ext.isEmpty(this.linkPanel)&&(this.linkPanel=new SYNO.SDS.NoteStation.Editor.Tinymce.Link.Panel({owner:this,data:t.data,pluginVar:t.pluginVar,isPreviewYoutube:t.isPreviewYoutube||!1})),this.linkPanel},onClickCancel:function(){this.onCloseWin()},onClickOk:function(t){this.handleInsertLink(t),this.onCloseWin()},onCloseWin:function(){this.mceConfig.keepFocusOnEditor=!1,this.close()},handleInsertLink:function(t){var e=this.linkPanel.getForm(),o={data:{href:e.findField("link_url").getValue(),text:e.findField("link_text").getValue()}};this.linkPanel.isPreviewYoutube?this.onSubmitYoutubeCode(this.linkPanel.youtubeCode):this.onSubmitLink(o)}}),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.Link.Youtube",{statics:{youtubeRegexr:"((http://)?)(www\\.)?((youtube\\.com/)|(youtu\\.be)|(youtube)).+",matchUrl:function(t){return Ext.isString(t)&&null!==t.match(this.youtubeRegexr)&&Ext.isString(this.youtubeId(t))},youtubeId:function(t){var e=t.match(/^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);return!(!e||11!==e[2].length)&&e[2]},convertUrl:function(t,e){var o=this.youtubeId(t);return t&&o&&(t="https://www.youtube.com/"+(e?"embed/":"v/")+this.youtubeId(t)),t},dataToHtml:function(t,e,o,i,n){var s,a,r;return i&&(s='width="'+e+'" height="'+o+'"',r=String.format(' anchorhref="{0}"',n),a=t?'<iframe src="'+i+'" '+s+r+' frameborder="0" youtube="true" allowfullscreen >&nbsp;</iframe>':'<div class="youtube" anchorhref="'+n+'"><object type="application/x-shockwave-flash" '+s+' data="'+i+'&modestbranding=1"><param name="movie" value="'+i+'&modestbranding=1" /><param name="wmode" value="transparent" /></object></div>'),a}}}),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.Link.Panel",{extend:"SYNO.SDS.NoteStation.Operate.FormPanel",url:"",youtubeCode:"",isPreviewYoutube:!1,constructor:function(t){this.callParent([this.fillConfig(t||{})]),this.linkUrl.addEvents("afterpaste")},fillConfig:function(t){var e=t.data,o=t.pluginVar.onlyText;this.youtube=SYNO.SDS.NoteStation.Editor.Tinymce.Link.Youtube,!0===t.isPreviewYoutube&&(this.isPreviewYoutube=!0),this.linkUrl=new SYNO.ux.TextField({xtype:"syno_textfield",cls:"syno-ns-tinymce-insert-link-url-textfield",fieldLabel:SYNO.SDS.NoteStation._T("tinymce","url"),name:"link_url",allowBlank:!1,enableKeyEvents:!0,value:Ext.isEmpty(e.href)?void 0:e.href,maxlength:SYNO.SDS.NoteStation.Define.LINK_MAX_LENGTH,selectOnFocus:!0,listeners:{scope:this,keyup:this.onUrlCheck}});var i={labelWidth:150,fieldWidth:300,items:[this.linkUrl,{xtype:"syno_textfield",hidden:!o,cls:"syno-ns-tinymce-insert-link-display-textfield",fieldLabel:SYNO.SDS.NoteStation._T("tinymce","text_to_display"),value:Ext.isEmpty(e.text)?void 0:e.text,name:"link_text",allowBlank:!1,isDirty:!1,enableKeyEvents:!0,selectOnFocus:!0,maxlength:SYNO.SDS.NoteStation.Define.LINK_MAX_LENGTH,listeners:{scope:this,keyup:this.onTextKeyup}},{xtype:"syno_checkbox",hidden:!0,boxLabel:SYNO.SDS.NoteStation._T("tinymce","show_as_youtube_video"),name:"show_youtube",checked:!1,listeners:{check:this.onPreviewYoutube,scope:this}},{hidden:!0,xtype:"syno_displayfield",cls:"syno-ns-tinymce-insert-link-preview-youtube",id:Ext.id(void 0,"youtube_iframe"),htmlEncode:!1,html:"<div></div>",name:"preview_youtube"}],listeners:{scope:this,afterlayout:{fn:function(){this.linkUrl.getEl().dom.onpaste=this.onPaste.createDelegate(this),this.linkUrl.on("afterpaste",this.onUrlCheck.createDelegate(this))},single:!0},show:{fn:function(){this.linkUrl.focus(!0,200)},single:!0}}};return Ext.apply(i,t)},onPaste:function(){Ext.defer(function(){this.linkUrl.fireEvent("afterpaste")},100,this)},onUrlCheck:function(t){var e=this.pluginVar.initialText,o=this.data,i=this.pluginVar.onlyText,n=this.getForm(),s=n.findField("preview_youtube"),a=n.findField("link_url"),r=n.findField("show_youtube");this.url=a.getValue(),e||0!==o.text.length||!i||n.findField("link_text").isDirty||(n.findField("link_text").setValue(this.url),this.isPreviewYoutube&&(this.youtubeCode=this.youtube.dataToHtml(!0,420,315,this.youtube.convertUrl(this.url,!0),this.url),s.setValue(this.youtubeCode))),this.youtube.matchUrl(this.url)?(r.show(),this.isPreviewYoutube&&(r.setValue(!0),this.youtubeCode=this.youtube.dataToHtml(!0,420,315,this.youtube.convertUrl(this.url,!0),this.url),s.setValue(this.youtubeCode))):(r.hide(),s.isVisible()&&this.showPreviewYoutube(!1))},onTextKeyup:function(t){t.isDirty=!0},onPreviewYoutube:function(t,e){var o=this.getForm(),i=o.findField("preview_youtube");Ext.isEmpty(this.url)||(e?(this.showPreviewYoutube(!0),this.youtubeCode=this.youtube.dataToHtml(!0,420,315,this.youtube.convertUrl(this.url,!0),this.url),i.setValue(this.youtubeCode)):this.showPreviewYoutube(!1))},showPreviewYoutube:function(t){var e=this.getForm(),o=e.findField("preview_youtube"),i=e.findField("show_youtube"),n=e.findField("link_text");t?(o.show(),this.isPreviewYoutube=!0,n.hide(),this.owner.setHeight(485)):(o.hide(),i.setValue(!1),n.show(),this.isPreviewYoutube=!1,this.owner.setHeight(200))}}),Ext.ns("SYNO.SDS.NoteStation.Editor.Tinymce.FormUpload"),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.FormUpload.GridPanel",{extend:"SYNO.ux.GridPanel",constructor:function(t){this.module=t.module,this.owner=t.owner,this.appWin=this.findAppWindow(),this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={xtype:"syno_editorgrid",itemId:"upload_file_grid",cls:"syno-ns-tinymce-fileupload-grid",tbar:{items:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("upload","from_ds"),scope:this,handler:function(){this.createFileInputFromDS()}}]},colModel:new Ext.grid.ColumnModel({defaults:{menuDisabled:!0},columns:[{dataIndex:"filename",hideable:!1,header:SYNO.SDS.NoteStation._T("common","name")},{dataIndex:"filesize",header:SYNO.SDS.NoteStation._T("common","size"),width:60,hidden:!SYNO.SDS.Utils.FileChooser.Chooser.supportMultiSelect},{xtype:"actioncolumn",css:"syno-ns-actioncolumn",header:SYNO.SDS.NoteStation._T("common","action"),items:[{iconCls:"syno-ns-tinymce-fileupload-delete-icon",handler:function(t,e,o){var i=t.getStore().getAt(e).get("inputElm");t.getStore().removeAt(e),Ext.isObject(i)&&Ext.removeNode(Ext.getDom(i))}}],width:24,align:"center"}]}),store:this.getFileStore(),listeners:{scope:this,afterrender:this.createFileInputFromPC}};return Ext.apply(e,t)},getFileStore:function(){return this.fileStore?this.fileStore:(this.fileStore=new Ext.data.JsonStore({fields:["filename","filesize"]}),this.fileStore)},createFileInputFromPC:function(){var t,e=this.getTopToolbar();this.fromPCBtn&&(this.mun(this.fromPCBtn.getEl(),"change"),t=Ext.get(this.body.dom),this.fromPCBtn.getEl().insertAfter(t),this.fromPCBtn.hide()),this.fromPCBtn=new SYNO.ux.FileButton({name:Ext.id(void 0,"file_"),buttonText:SYNO.SDS.NoteStation._T("upload","from_pc"),buttonOnly:!0}),e.add(this.fromPCBtn),e.doLayout(),this.fromPCBtn.getEl().set({multiple:!0},!0),this.mon(this.fromPCBtn.getEl(),"change",function(t,e,o){this.handleFileSelectFromPC(t,e,o),this.createFileInputFromPC()},this)},handleFileSelectFromPC:function(t,e,o){var i=t.target.files;Ext.each(i,function(t){var o=new Ext.data.Record({inputElm:e,name:Ext.id(void 0,"file_upload_"),filename:t.name,filesize:Ext.util.Format.fileSize(t.size),fileObj:t,selectfrom:"pc"});this.getStore().add(o)},this)},createFileInputFromDS:function(){new SYNO.SDS.Utils.FileChooser.Chooser({owner:this.owner,width:800,enumC2Share:!0,usage:{type:"open",multiple:!0},listeners:{choose:{fn:function(t,e,o){this.handleFileSelectFromDS(e),t.close()}},scope:this}}).show()},handleFileSelectFromDS:function(t){if(Ext.isEmpty(t.records)){var e=t.path.substr(t.path.lastIndexOf("/")+1),o=new Ext.data.Record({name:e,filename:e,sharepath:t.path,selectfrom:"ds"});this.getStore().add(o)}else Ext.each(t.records,function(t){var e=new Ext.data.Record({name:t.get("filename"),filename:t.get("filename"),filesize:Ext.util.Format.fileSize(t.get("filesize")),sharepath:t.get("path"),selectfrom:"ds"});this.getStore().add(e)},this)}}),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.ListFile.GridPanel",{extend:"SYNO.ux.GridPanel",constructor:function(t){this.module=t.module,this.owner=t.owner,this.appWin=this.findAppWindow(),this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e=new Ext.grid.ColumnModel({defaults:{menuDisabled:!0,sortable:!0},columns:[{dataIndex:"filelabel",sortable:!1,hideable:!1,hidden:!0},{header:SYNO.SDS.NoteStation._T("common","name"),dataIndex:"filename",menuDisabled:!1,hideable:!1,id:"filename",renderer:function(t){return'<font class="syno-ns-filelist-filename">'+t+"</font>"},listeners:{click:function(t,e,o,i){e.getStore().getAt(o).get("filelabel").elms.fileName.click()}}},{header:SYNO.SDS.NoteStation._T("common","size"),menuDisabled:!1,dataIndex:"filesize",id:"filesize"},{header:SYNO.SDS.NoteStation._T("common","preview"),xtype:"actioncolumn",css:"syno-ns-actioncolumn",items:[{iconCls:"syno-ns-tinymce-fileupload-preview-icon",handler:function(t,e,o,i,n){var s=t.getStore().getAt(e).get("filelabel"),a=t.getEl().dom.getElementsByClassName("x-grid3-col-"+this.id)[e].firstChild,r={previewBtn:a,insertAfterPlace:t.body};s.fireEvent("preview",s,n,r)}}],width:70,align:"center",id:Ext.id(void 0,"preview")},{header:SYNO.SDS.NoteStation._T("common","delete"),xtype:"actioncolumn",css:"syno-ns-actioncolumn",items:[{iconCls:"syno-ns-tinymce-fileupload-delete-icon",handler:function(t,e,o){var i=t.getStore().getAt(e).get("filelabel");i.fireEvent("remove",i),t.getStore().removeAt(e)}}],width:70,align:"center"}]}),o={colModel:e,store:this.getAttachmentStore(),cls:"syno-ns-tinymce-filelist-grid",autoExpandColumn:"filename",enableColumnMove:!1,listeners:{viewready:function(t){t.getView().updateScroller()}}};return Ext.apply(t,o)},getAttachmentStore:function(){return this.attachmentStore?this.attachmentStore:(this.attachmentStore=new Ext.data.JsonStore({fields:["filename","filesize"]}),this.attachmentStore)}}),Ext.ns("SYNO.SDS.NoteStation.Editor.Tinymce.FormUpload"),Ext.ns("SYNO.SDS.NoteStation.Editor.Tinymce.ListFile"),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.FormUpload.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.module=t.module,this.owner=t.owner,this.appWin=this.findAppWindow(),this.enableKeepFocusOnEditor(),this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){this.tabPanel={xtype:"syno_tabpanel",items:[this.getFileUploadGridPanel(),this.getFileListGridPanel()],activeTab:0};var e={title:SYNO.SDS.NoteStation._T("tooltip","attach_file"),width:600,height:500,cls:"syno-ns-add-file-win",items:this.tabPanel,layout:"fit",buttons:[{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.onClickCancel},{xtype:"syno_button",btnStyle:"blue",text:_T("common","ok"),handler:this.onClickOk,scope:this}],listeners:{beforeshow:function(){Ext.each(this.module.tinymcePanel.ddupload.items,function(t){if(!Ext.isString(t.file.ref)){var e=new Ext.data.Record({filename:t.file.name,filesize:Ext.util.Format.fileSize(t.file.size),filelabel:t});this.fileListGridPanel.getStore().add(e)}},this)}}};return Ext.apply(e,t)},getFileListGridPanel:function(){return this.fileListGridPanel=new SYNO.SDS.NoteStation.Editor.Tinymce.ListFile.GridPanel({owner:this.owner,module:this.module,title:SYNO.SDS.NoteStation._T("upload","list_file"),itemId:"list_file_grid"}),this.fileListGridPanel},getFileUploadGridPanel:function(){return this.fileUploadGridPanel=new SYNO.SDS.NoteStation.Editor.Tinymce.FormUpload.GridPanel({owner:this.owner,module:this.module,title:SYNO.SDS.NoteStation._T("upload","upload_file")}),this.fileUploadGridPanel},getAttachment:function(){var t=[];return this.fileUploadGridPanel.getStore().each(function(e){var o={action:"create",name:e.get("name"),format:"raw"};"ds"===e.get("selectfrom")&&Ext.apply(o,{format:"ds",source:e.get("sharepath")}),t.push(o)},this),t},enableKeepFocusOnEditor:function(){this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel").tinymcePanel.enableKeepFocusOnEditor()},disableKeepFocusOnEditor:function(){this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel").tinymcePanel.disableKeepFocusOnEditor()},closeModalWindow:function(){this.disableKeepFocusOnEditor(),this.close()},onClickCancel:function(){this.closeModalWindow()},onClickOk:function(){this.uploadFile(),this.closeModalWindow()},uploadFile:function(){var t,e,o,i,n,s=[],a=this;if(t=this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel"),o=this.fileUploadGridPanel,t.setStatusBusy(),s=this.getAttachment(),Ext.isEmpty(s))return t.clearStatusBusy(),void this.closeModalWindow();i=Ext.apply({attachment:s,object_id:a.module.noteData.object_id,ver:a.module.noteData.ver},a.module.notePerm,"perm_from,smart_id"),a.module.noteData.encrypt&&(i.token=this.appWin.getEncryptPassword(a.module.noteData.object_id).token),n=this.getWebAPICfg(),e=new window.FormData,o.getStore().each(function(t){Ext.isEmpty(t.get("fileObj"))||e.append(t.get("name"),t.get("fileObj"))}),Ext.iterate(i,function(t,o){e.append(t,Ext.encode(o))}),e.append("commit_msg",Ext.encode({device:"desktop"})),Ext.apply(n,{isUpload:!0,html5upload:!0,uploadData:e}),this.appWin.sendWebAPI(n)},getWebAPICfg:function(){var t=this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel"),e=t.tinymcePanel,o=this;return{api:"SYNO.NoteStation.Note",version:3,method:"set",timeout:36e5,callback:function(i,n){return t.clearStatusBusy(),i?(n=n.data[0],n.object_id!==o.module.noteData.object_id?void SYNO.Debug("resp.object_id !== noteData.object_id",i,n):(o.module.noteData.ver=n.ver,o.module.noteData.attachment=n.attachment,void e.setAttachment(n.attachment))):(Ext.isObject(n)&&SYNO.SDS.NoteStation.Utils.showErrorMsg(this.appWin,n),void SYNO.Debug("upload failed",i,n))},success:function(t,e){try{t.responseText=/{[\s\S]+}/.exec(t.responseText)[0]}catch(t){}},failure:function(t,e){try{t.responseText=/{[\s\S]+}/.exec(t.responseText)[0]}catch(t){}},scope:this}}}),Ext.define("SYNO.SDS.NoteStation.Todo.Component.DateTimeField",{extend:"SYNO.ux.DateTimeField",width:26,constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={altFormats:"Y/m/d H:i:s|Y/m/d H:i",isAllDay:!1,setValue:function(t){this.colorDateText(this,t);var e=Ext.isDate(t)&&!SYNO.SDS.NoteStation.Utils.isNoDueDate(t)?t.format(this.format):"";return Ext.form.DateField.superclass.setValue.call(this,e)}};return!Ext.isObject(t)||!0!==t.hideDateIcon&&void 0!==t.hideDateIcon||Ext.apply(e,{focusClass:"",cls:t.cls,listeners:{select:this.onDateSelect,scope:this}}),Ext.apply(e,t),e},onTriggerClick:function(){SYNO.ux.DateTimeField.prototype.onTriggerClick.apply(this,arguments),this.menu.picker.show(),this.menu.picker.todayBtn.disabled=!1,this.menu.picker.todayBtn.setText(SYNO.SDS.NoteStation._T("todo","today"));var t=this.getValue();if(Ext.isEmpty(t)){var e=SYNO.SDS.NoteStation.Todo.Common,o=String.format("{0}:{1} {2}",e.defaultHour,e.defaultMin,e.defaultAmpm);this.menu.picker.tf.setValue(o)}var i=this.menu.picker.tf.hourCombo,n=this.menu.picker.tf.minCombo;i.triggerBlur(),n.triggerBlur(),i.on("specialkey",function(t,e){e.ENTER===e.getKey()&&this.menu.picker.fireEvent("select",this.menu.picker,this.getDateTime())},this),n.on("specialkey",function(t,e){e.ENTER===e.getKey()&&this.menu.picker.fireEvent("select",this.menu.picker,this.getDateTime())},this)},getDateTime:function(){var t=this.menu.picker.tf.getRawValue(),e=this.menu.picker.getValue(),o=e.format("Y/m/d")+" "+("0"+t.h).slice(-2)+":"+("0"+t.m).slice(-2)+":00";return Date.parseDate(o,"Y/m/d H:i:s")},selectClear:function(){this.menu.picker.todayBtn.disabled=!0;var t=new Date(-1e3),e=this.menu.picker;e.value=t;var o=t.format("H:i:s");e.tf.setValue(o),e.fireEvent("select",e,t),this.setValue("")},colorDateText:function(t,e){"overdue"===SYNO.SDS.NoteStation.Utils.convertDateToString(e)?t.el.setStyle("color","#fa7070"):t.el.setStyle("color","#6b95b2")},onMenuHide:function(){!0!==this.menuHideFocus&&void 0!==this.menuHideFocus||this.focus(!1,60),this.menuEvents("un"),this.updateDateTime(),this.fireEvent("select",this,this.getValue())},onDateSelect:function(t){t.menu.picker.setValue(t.menu.picker.getValue()),""===t.el.getValue()?t.trigger.setVisible(!0):(t.trigger.setVisible(!1),t.setValue(t.menu.picker.getValue())),t.fireEvent("blur",t)},showDateMenu:function(t){!Ext.isEmpty(t.menu)&&t.menu.isVisible()||t.onTriggerClick()}}),Ext.reg("syno_todo_datetimefield",SYNO.SDS.NoteStation.Todo.Component.DateTimeField),Ext.define("SYNO.SDS.NoteStation.Todo.Common",{statics:{newTaskId:"new_task",defaultHour:6,defaultMin:0,defaultAmpm:"pm",createReader:function(){return new Ext.data.JsonReader({fields:[{name:"object_id",type:"string"},{name:"title",type:"string"},{name:"done",type:"boolean"},{name:"due_date",type:"date",convert:function(t){return SYNO.SDS.NoteStation.Utils.epochToDate(t)}},{name:"star",type:"boolean"},{name:"comment",type:"string"},{name:"parent_id",type:"string"},{name:"priority",type:"int"},{name:"reminder_offset",type:"int"},{name:"note_id",type:"string"},{name:"note_title",type:"string"},{name:"note_parent_id",type:"string"},{name:"items",type:"array"},{name:"date_category",type:"string"}]})},replaceNewline:function(t){return t.replace(/(\r\n|\n|\r)/g," ")},getTodoIndicator:function(t){var e="",o='<span class="indicator indicator-{0}"></span>';if(-1!==t.get("priority")){var i=SYNO.SDS.NoteStation.Utils.getPriority(t.get("priority"));e+=String.format(o,String.format("priority priority-{0}",i))}return-1!==t.get("reminder_offset")&&(e+=String.format(o,"reminder")),Ext.isEmpty(t.get("comment"))||(e+=String.format(o,"comment")),Ext.isEmpty(t.get("note_id"))||(e+=String.format(o,"note")),Ext.isEmpty(t.get("items"))||(e+=String.format(o,"subtask")),e},renderTodoTitle:function(t,e,o,i,n,s){var a=s.getAt(i).get("done"),r="";a&&(r='style = "text-decoration:line-through; color: #96a0aa;"');var l=this.getTodoIndicator(o),d="<div>";d+='<div class="syno-ns-todo-grid-title {4}" {0} {1}>{2}</div>',d+=Ext.isEmpty(l)?"":'<div class="syno-ns-todo-grid-indicator">{3}</div>',d+="</div>";var c=Ext.isEmpty(l)?"single-line-title":"",h=SYNO.SDS.NoteStation.Todo.Common.replaceNewline(Ext.util.Format.htmlEncode(t)),u="";return u=String.format('ext:qtip="{0}"',Ext.util.Format.htmlEncode(h)),String.format(d,r,u,h,l,c)},renderTodoStar:function(t,e,o,i,n,s){var a=t?"star-on":"star-off";return String.format('<div class="syno-ns-todo-grid-star {0}"></div>',a)},renderTodoPriority:function(t,e,o,i,n,s){var a=SYNO.SDS.NoteStation.Utils.getPriority(t);return String.format('<div class="syno-ns-todo-grid-priority syno-ns-todo-grid-priority-{0}"></div>',a)},renderTodoReminderOffset:function(t,e,o,i,n,s){var a=-1!==t,r=!SYNO.SDS.NoteStation.Utils.isNoDueDate(o.get("due_date")),l=a?"on":"off",d="";if(a){var c=SYNO.SDS.NoteStation.Utils.dateToEpoch(o.get("due_date"))-t,h=SYNO.SDS.NoteStation.Utils.epochToDate(c),u=SYNO.SDS.NoteStation.Utils.formatDateString(h,!0);d=String.format('ext:qtip="{0}"',u)}else r||(d=String.format('ext:qtip="{0}"',SYNO.SDS.NoteStation._T("todo","set_due_date_first")));return String.format('<div class="syno-ns-todo-grid-reminder syno-ns-todo-grid-reminder-{0}" {1}></div>',l,d)},renderTodoDueDate:function(t,e,o,i,n,s,a,r){var l=document.createElement("div");Ext.isEmpty(t)&&(t=new Date(-1e3));var d,c;if(SYNO.SDS.NoteStation.Utils.isNoDueDate(t))d="";else{var h,u,S=SYNO.SDS.NoteStation.Utils.convertDateToString(t);h="overdue"===S?'style = "color: #fa7070;"':'style = "color: #6b95b2;"',u="today"===S?SYNO.SDS.NoteStation._T("todo","today"):"tomorrow"===S?SYNO.SDS.NoteStation._T("todo","tomorrow"):SYNO.SDS.NoteStation.Utils.formatDateString(t,!1);var p,m="";if(r){p=-1===o.get("reminder_offset")?SYNO.SDS.NoteStation.Utils.formatDateString(t,!1):SYNO.SDS.NoteStation.Utils.formatDateString(t,!0),m=String.format('ext:qtip="{0}"',p)}c='<div class="syno-ns-todo-display-date" {0} {1}>{2}</div>',d=String.format(c,h,m,u)}return l.innerHTML=d,a.updateDueDateWidth(Ext.util.TextMetrics.measure(l,l.textContent).width),d},renderTodoMore:function(t,e,o,i,n,s,a){return'<div class="syno-ns-todo-grid-more"></div>'},renderTodoDelete:function(t,e,o,i,n,s,a){var r=a.getSelectionModel().isSelected(i);return String.format('<div class="syno-ns-todo-grid-delete syno-ns-todo-grid-delete-{0}" lockHover="{1}"></div>',r?"on":"off",r?"true":"false")},rowShowDeleteIcon:function(t,e,o){null!==e&&"true"!==e.getAttribute("lockHover")&&(e[o?"addClass":"removeClass"]("syno-ns-todo-grid-delete-on"),e[o?"removeClass":"addClass"]("syno-ns-todo-grid-delete-off"))},onGridRowClick:function(t,e,o){t.lastClickRowIndex=e;var i,n,s,a,r;for(i=0;i<t.lastSelectedRowIndex.length;i++)n=null,s=t.lastSelectedRowIndex[i],a=t.getStore().getAt(s),r=t.getView().getRow(s),Ext.isEmpty(r)||(n=Ext.get(r).select(".syno-ns-todo-grid-delete").first(),n.set({lockHover:"false"}),this.rowShowDeleteIcon(t,n,!1));t.lastSelectedRowIndex=[];var l=t.getSelectionModel().getSelections();for(i=0;i<l.length;i++)n=null,a=l[i],s=t.getStore().indexOf(a),r=t.getView().getRow(s),Ext.isEmpty(r)||(n=Ext.get(r).select(".syno-ns-todo-grid-delete").first(),this.rowShowDeleteIcon(t,n,!0),n.set({lockHover:"true"}),t.lastSelectedRowIndex.push(s))},onGridMouseover:function(t,e,o){var i,n;if(!0===o&&(n=e.getTarget(".syno-ns-todo-display-date"))){var s,a=t.getView().findRowIndex(n),r=t.getStore().getAt(a);if(r&&(s=r.get("due_date"))&&!SYNO.SDS.NoteStation.Utils.isNoDueDate(s)){var l;l=-1===r.get("reminder_offset")?SYNO.SDS.NoteStation.Utils.formatDateString(s,!1):SYNO.SDS.NoteStation.Utils.formatDateString(s,!0),i=Ext.get(n),i.dom.innerText=l,i.addClass("syno-ns-todo-display-date-hover"),t.updateDueDateWidth(Ext.util.TextMetrics.measure(i.dom,l).width,!0)}}if(n=e.getTarget(".x-grid3-row")){var d=Ext.get(n),c=d.select(".syno-ns-todo-grid-delete").first();this.rowShowDeleteIcon(t,c,!0)}n=e.getTarget(".syno-ns-todo-grid-delete"),n&&(i=Ext.get(n),i.addClass("syno-ns-todo-grid-delete-hover")),(n=e.getTarget(".syno-ns-todo-grid-date"))&&(i=Ext.get(n),i.addClass("syno-ns-todo-grid-date-hover"))},onGridMouseout:function(t,e,o){var i,n;if(!0===o&&(n=e.getTarget(".syno-ns-todo-display-date"))){var s=t.getView().findRowIndex(n),a=t.getStore().getAt(s),r=a.get("due_date");if(!SYNO.SDS.NoteStation.Utils.isNoDueDate(r)){var l,d=SYNO.SDS.NoteStation.Utils.convertDateToString(r);l="today"===d||"tomorrow"===d?SYNO.SDS.NoteStation._T("todo",d):SYNO.SDS.NoteStation.Utils.formatDateString(r,!1),i=Ext.get(n),i.dom.innerText=l,i.removeClass("syno-ns-todo-display-date-hover"),t.updateDueDateWidth(Ext.util.TextMetrics.measure(i.dom,l).width)}}if(n=e.getTarget(".x-grid3-row")){var c=Ext.get(n);if(!e.within(c,!0)){var h=c.select(".syno-ns-todo-grid-delete").first();this.rowShowDeleteIcon(t,h,!1)}}n=e.getTarget(".syno-ns-todo-grid-delete"),n&&(i=Ext.get(n),i.removeClass("syno-ns-todo-grid-delete-hover")),(n=e.getTarget(".syno-ns-todo-grid-date"))&&(i=Ext.get(n),i.removeClass("syno-ns-todo-grid-date-hover"))},uniformStoreDataFormat:function(t,e){var o=e;return"due_date"===t&&(o=-1===e?new Date(-1e3):SYNO.SDS.NoteStation.Utils.epochToDate(e)),o},updateEditPanelByObjectId:function(t,e,o){if(!Ext.isEmpty(t.record)&&t.record.get("object_id")===e)for(var i in o)o.hasOwnProperty(i)&&("star"===i?t.getComponent("todo_title").label[o.star?"addClass":"removeClass"]("star-on"):"due_date"===i?t.getComponent("todo_due_date").setValue(SYNO.SDS.NoteStation.Utils.epochToDate(o.due_date)):"title"===i?(t.getComponent("todo_title").setValue(o.title),t.getComponent("todo_title").oldvalue=o.title):"done"===i?t.enableSubtask(!o.done):"priority"===i?t.setPriorityValue(o.priority):"reminder_offset"===i&&t.setReminderValue(o.reminder_offset))},updateStoreByObjectId:function(t,e,o){var i=t.getStore().find("object_id",e);if(-1!==i){var n;for(var s in o)if(o.hasOwnProperty(s)){if("object_id"===s)continue;n=this.uniformStoreDataFormat(s,o[s]),t.getStore().getAt(i).set(s,n)}}},increaseLastSelectIndex:function(t,e){if(0!==t.lastClickRowIndex&&!Ext.isEmpty(t.lastSelectedRowIndex)){e<=t.lastClickRowIndex&&t.lastClickRowIndex++;for(var o=0;o<t.lastSelectedRowIndex.length;o++)e<=t.lastSelectedRowIndex[o]&&t.lastSelectedRowIndex[o]++}},addNewTaskStyle:function(t,e){Ext.get(t.getView().getRow(e)).setStyle("background-color","#fffceb")},listTodo:function(t,e,o,i,n){t.isLoadingData=!0;var s={},a=!1;t.query_info.sort_by=i,t.query_info.sort_direction=n,!1===e?(t.owner.setStatusBusy(),t.uncompleteNoteId={},t.canLoadMore=!0,t._due_date_width=null,t.query_info.offset=0,t.query_info.limit=t.query_limit):"ddRefresh"===e?(t.owner.setStatusBusy(),t.uncompleteNoteId={},Ext.copyTo(s,{sort_by:i,sort_direction:n,offset:0,limit:t.query_info.offset+t.query_limit},"offset,limit,sort_by,sort_direction"),a=!0):(t.query_info.offset+=t.query_limit,t.query_info.limit=t.query_limit),a||Ext.copyTo(s,t.query_info,"offset,limit,sort_by,sort_direction"),t.findAppWindow().getStorage().listTodo(Ext.apply({filter:o,callback:SYNO.SDS.NoteStation.Todo.Common.onlistTodo.createDelegate(t,[e],!0),scope:t},s))},onlistTodo:function(t,e,o){var i=this;if(!t||!Ext.isObject(e)||!Ext.isArray(e.todos)||0===e.count)return t||SYNO.SDS.NoteStation.Utils.showErrorMsg(i.getAppWin(),e),0===e.offset&&0===e.count&&i.getStore().loadData([]),i.canLoadMore=!1,i.owner.clearStatusBusy(),void i.getTodoPanel().doLayout();Ext.each(e.todos,function(t,e,o){if(t.done)t.date_category="completed";else{var n=SYNO.SDS.NoteStation.Utils.convertDateToString(t.due_date);t.date_category=n}t.done||(i.uncompleteNoteId[t.note_id]=!0),Ext.isEmpty(t.note_id)||(i.noteTitle[t.note_id]=t.note_title)},i);var n=0!==e.offset,s=i.getView(),a=s.getScrollState(),r=a.hasOwnProperty("top")?a.top:0;i.getStore().loadData(e.todos,n),n||"ddRefresh"===o?s.scroller.dom.fleXcroll&&s.scroller.dom.fleXcroll.setScrollPos(0,r):s.scrollToTop(),i.resetSelectRecord(),i.isLoadingData=!1,i.owner.clearStatusBusy(),i.getTodoPanel().doLayout()},addTodo:function(t,e,o,i){e.hasOwnProperty("title")&&(e.title=SYNO.SDS.NoteStation.Todo.Common.replaceNewline(e.title));var n=e;t.owner.setStatusBusy(),t.findAppWindow().getStorage().createTodo(Ext.apply({callback:SYNO.SDS.NoteStation.Todo.Common.onAddTodo.createDelegate(t,{rowIndex:o,focus:i},!0),scope:t},n))},onAddTodo:function(t,e,o){var i=this;if(!t||!Ext.isObject(e))return t||SYNO.SDS.NoteStation.Utils.showErrorMsg(i.getAppWin(),e),void i.owner.clearStatusBusy();var n,s=o.rowIndex,a=o.focus;e.date_category=SYNO.SDS.NoteStation.Todo.Common.newTaskId;for(var r in e)e.hasOwnProperty(r)&&(n=SYNO.SDS.NoteStation.Todo.Common.uniformStoreDataFormat(r,e[r]),e[r]=n);var l=new Ext.data.Record(e);i.getStore().insert(s,[l]),SYNO.SDS.NoteStation.Todo.Common.addNewTaskStyle(i,s),SYNO.SDS.NoteStation.Todo.Common.increaseLastSelectIndex(i,s),i.owner.clearStatusBusy(),0===s&&i.getView().scrollToTop(),a&&i.focusNewTask(s);var d=SYNO.SDS.NoteStation.Window;d.owned.todo.total++;var c=SYNO.SDS.NoteStation.Todo.Common.belongToWhichSubCategory(e);-1!==c.indexOf("today")&&d.owned.today_todo.total++,-1!==c.indexOf("next_7_days")&&d.owned.n7d_todo.total++,-1!==c.indexOf("overdue")&&d.owned.overdue_todo.total++,SYNO.SDS.NoteStation.Window.mainPanel.getEditorPanel().normalPanel.updateTodoBtnIndicator(),d.fireEvent("ownedtodoloaded",d.owned)},setTodo:function(t,e,o){e.hasOwnProperty("title")&&(e.title=SYNO.SDS.NoteStation.Todo.Common.replaceNewline(e.title)),-1===e.due_date&&(e.reminder_offset=-1);var i=e;t.findAppWindow().getStorage().setTodo(Ext.apply({callback:SYNO.SDS.NoteStation.Todo.Common.onSetTodo.createDelegate(t,[e,!0!==o],!0),scope:t},i))},onSetTodo:function(t,e,o,i){var n=this;if(!t||!Ext.isObject(e)||!Ext.isArray(e.data))return void(t||SYNO.SDS.NoteStation.Utils.showErrorMsg(n.getAppWin(),114));e.data.forEach(function(t){SYNO.SDS.NoteStation.Todo.Common.updateStoreByObjectId(n,t.object_id,o),i&&SYNO.SDS.NoteStation.Todo.Common.updateEditPanelByObjectId(n.getTodoPanel().todoEditPanel,t.object_id,o)},n),o.refresh&&SYNO.SDS.NoteStation.Todo.Common.listTodo(n,"ddRefresh",n.owner.getFilter(),"note_id",n.owner.getSortOrder()),(o.hasOwnProperty("due_date")||o.hasOwnProperty("done")||o.hasOwnProperty("star"))&&SYNO.SDS.NoteStation.Window.loadTodo()},deleteTodo:function(t,e){var o=e;t.getTodoPanel().setStatusBusy(),t.findAppWindow().getStorage().deleteTodo(Ext.apply({callback:SYNO.SDS.NoteStation.Todo.Common.onDeleteTodo.createDelegate(t,{object_ids:e.object_id},!0),scope:t},o))},onDeleteTodo:function(t,e,o){var i=this;if(!t||!Ext.isObject(e))return t||SYNO.SDS.NoteStation.Utils.showErrorMsg(i.findAppWindow(),e),void i.getTodoPanel().clearStatusBusy();var n=o.object_ids;Ext.each(n,function(t,e,o){var n=i.getStore().find("object_id",t);i.getStore().removeAt(n)},i),i.getTodoPanel().todoEditPanel.exitEditPanel(),i.getTodoPanel().clearStatusBusy(),SYNO.SDS.NoteStation.Window.mainPanel.getEditorPanel().normalPanel.updateTodoBtnIndicator(),SYNO.SDS.NoteStation.Window.loadTodo()},onSetStar:function(t,e){var o=e.grid,i=t.record,n=t.star;if(n!==i.get("star")){var s={object_id:[i.get("object_id")],star:n};SYNO.SDS.NoteStation.Todo.Common.setTodo(o,s)}},onSetPriority:function(t,e){var o=e.grid,i=t.record,n=t.priority;if(n!==i.get("priority")){var s={},a=[];a.push(i.get("object_id")),s.object_id=a,s.priority=n,SYNO.SDS.NoteStation.Todo.Common.setTodo(o,s)}},onSetReminderOffset:function(t,e){var o=e.grid,i=t.record,n=t.reminderOffset;if(n!==i.get("reminder_offset")){var s={},a=[];a.push(i.get("object_id")),s.object_id=a,s.reminder_offset=n,SYNO.SDS.NoteStation.Todo.Common.setTodo(o,s)}},onDoneClick:function(t,e,o,i){e.lastClickRowIndex=o;var n=e.getStore().getAt(o),s=n.get("done"),a={},r=[];r.push(n.get("object_id")),a.object_id=r,a.done=s,a.done&&(a.object_id=a.object_id.concat(n.get("items"))),
SYNO.SDS.NoteStation.Todo.Common.setTodo(e,a)},newTaskColorStyle:function(t,e){if(SYNO.SDS.NoteStation.Todo.Common.newTaskId===t.get("date_category"))return"syno-ns-todo-grid-row-new-task"},convertTodoToNoteParam:function(t,e){var o={};if(!Ext.isArray(t))return void e(o);var i=[];t.forEach(function(t){i.push(t.get("object_id"))},this),SYNO.SDS.NoteStation.Todo.Common.getTodoListHtml(i,function(t){var i=document.createElement("div");i.innerHTML=t,o.content=t,o.brief=(i.innerText||i.textContent||"").substr(0,80),o.title=SYNO.SDS.NoteStation._T("setting","todo_task")+"-"+(new Date).format("Y/m/d H:i:s"),o.commit_msg={first_version:!1},e(o)})},getPredefinedFilter:function(t){var e={},o=SYNO.SDS.NoteStation.Utils.convertStringToDate(t);return e.done=!1,e.due_date_end=SYNO.SDS.NoteStation.Utils.dateToEpoch(o),e},belongToWhichSubCategory:function(t){if(Ext.isObject(t)){var e=Ext.isDate(t.due_date)?SYNO.SDS.NoteStation.Utils.dateToEpoch(t.due_date):t.due_date,o=[],i=SYNO.SDS.NoteStation.Utils.convertStringToDate("today"),n=SYNO.SDS.NoteStation.Utils.dateToEpoch(i),s=SYNO.SDS.NoteStation.Utils.convertStringToDate("next_7_days"),a=SYNO.SDS.NoteStation.Utils.dateToEpoch(s),r=SYNO.SDS.NoteStation.Utils.convertStringToDate("overdue"),l=SYNO.SDS.NoteStation.Utils.dateToEpoch(r);return!1===t.done&&-1!=e&&n>=e&&o.push("today"),!1===t.done&&-1!=e&&a>=e&&o.push("next_7_days"),!1===t.done&&-1!=e&&l>=e&&o.push("overdue"),!0===t.star&&o.push("star"),o}},addTodoByNoteHtml:function(t,e,o){var i,n=document.createElement("div"),s=[];n.innerHTML=t,Ext.iterate(n.querySelectorAll("ul li"),function(t){i=t.textContent.replace(/(\r\n|\n|\r)/g," ").trim(),Ext.isEmpty(i)||s.push(i),Ext.removeNode(t)}),Ext.iterate(n.querySelectorAll("ol li"),function(t){i=t.textContent.replace(/(\r\n|\n|\r)/g," ").trim(),Ext.isEmpty(i)||s.push(i),Ext.removeNode(t)}),Ext.iterate(n.querySelectorAll("div > input.syno-notestation-editor-checkbox"),function(t){Ext.isEmpty(t.parentNode)||"true"===t.parentNode.getAttribute("syno_ns_todo_parsing_remove")||(i=t.parentNode.textContent.replace(/(\r\n|\n|\r)/g," ").trim(),Ext.isEmpty(i)||s.push(i),t.parentNode.setAttribute("syno_ns_todo_parsing_remove","true"),t.parentNode.innerHTML="",Ext.removeNode(t.parentNode))}),i=n.textContent.replace(/(\r\n|\n|\r)/g," ").trim(),Ext.isEmpty(i)||s.push(i),Ext.iterate(s,function(t,i){SYNO.SDS.NoteStation.Todo.Common.addTodo.defer(80*i,void 0,[e,{note_id:o,title:t},0,!1])})},getExportTodoTitleTemplate:function(){return SYNO.SDS.NoteStation.Todo.Common.TodoExportTitleTemplate||(SYNO.SDS.NoteStation.Todo.Common.TodoExportTitleTemplate=new Ext.XTemplate("<ul>",'<tpl for=".">',"<li>{values.title}</li>","</tpl>","</ul>")),SYNO.SDS.NoteStation.Todo.Common.TodoExportTitleTemplate},getExportTodoTemplate:function(){return SYNO.SDS.NoteStation.Todo.Common.TodoExportTemplate||(SYNO.SDS.NoteStation.Todo.Common.TodoExportTemplate=new Ext.XTemplate('<tpl for=".">','<div style="padding-right: 16px;">',"{[this.getDoneTpl(values)]}","{[this.getStarTpl(values)]}","{[this.getPriorityTpl(values)]}","{[this.getTitleTpl(values)]}","</div>","{[this.getDueDateTpl(values)]}","{[this.getSubtask(values.subtask)]}","{[this.getCommentTpl(values)]}",'<div style="height: 8px; border-bottom: 1px solid #D7E1EB; margin-bottom: 10px;"></div>',"</tpl>","<div></div>",{iconBaseURL:"webman/3rdparty/NoteStation/images/_1x/",getDoneTpl:function(t){if(!t.hasOwnProperty("done"))return"";return String.format('<div style="{0}"><input class="syno-notestation-editor-checkbox {1}" type="image" /></div>',"display: inline-flex; vertical-align: middle;",t.done?"syno-notestation-editor-checkbox-checked":"")},getStarTpl:function(t){if(!t.hasOwnProperty("star"))return"";var e=this.iconBaseURL+(t.star?"icon_star_2x.png":"icon_greystar_2x.png");return String.format('<div style="{0}" class="{1}"><img src="{2}" width="22px" height="22px"></img></div>',"display: inline-flex; vertical-align: middle; padding-right: 4px;","syno-notestation-editor-star-icon",e)},getPriorityTpl:function(t){if(!t.hasOwnProperty("priority"))return"";var e;switch(t.priority){case 300:e="icon_priority_high.png";break;case 200:e="icon_priority_medium.png";break;case 100:e="icon_priority_low.png"}var o=this.iconBaseURL+e,i=Ext.isEmpty(e)?"":String.format('<img src="{0}" width="10px" height="10px"></img>',o);return String.format('<div style="{0}" class="{1}">{2}</div>',"display: inline-flex; vertical-align: middle; padding-right: 6px; width: 10px;","syno-notestation-editor-priority-icon",i)},getTitleTpl:function(t,e){var o=String.format("font-weight: {0}; font-size: {1}; color: #505A64; line-height: 1.4em;",e?"normal":"bold",e?"0.9em":"1em");return String.format('<div style="{0}"><div style="{1}">{2}</div></div>',"display: inline-flex; vertical-align: middle;",o,t.title)},getDueDateTpl:function(t){if(!t.hasOwnProperty("due_date")||t.due_date<0)return"";var e=String.format("font-size: 0.9em; padding: 2px 16px 2px {0}px; color: #6A7885; line-height: 1.4em;",this.getIndentSize(t));return String.format('<div style="{0}">{1}</div>',e,this.getDueDate(t.due_date))},getSubtask:function(t){if(Ext.isEmpty(t))return"";var e=t[0].hasOwnProperty("done");return new Ext.XTemplate('<tpl for=".">','<div style="padding: 6px 16px 0 {[this.getSubIndentSize(values)]}px;">',"{[this.getSubListTpl(values)]}","{[this.getSubTitleTpl(values)]}","</div>","</tpl>",{getSubIndentSize:this.getIndentSize.createDelegate(this),getSubTitleTpl:this.getTitleTpl.createDelegate(this,[!0],!0),getSubListTpl:e?this.getDoneTpl.createDelegate(this):function(t){return String.format('<ul style="{0}"><li>&nbsp;</li></ul>',"display: inline-flex; margin: 0px; padding-left: 26px; font-size: 10pt; width: 0px;")}}).apply(t)},getCommentTpl:function(t){if(!t.hasOwnProperty("comment")||Ext.isEmpty(t.comment))return"";var e=this.getIndentSize(t),o=String.format('<div style="margin: 0 16px 0 {0}px; height: 8px; border-bottom: 1px dashed #D7E1EB;"></div>',e),i=String.format("font-size: 0.9em; margin: 8px 4px 0 {0}px; color: #6A7885; line-height: 1.4em;",e+4);return String.format('{0}<div style="{1}">{2}</div>',o,i,this.getComment(t.comment))},getDueDate:function(t){return t=SYNO.SDS.NoteStation.Utils.epochToDate(t),SYNO.SDS.NoteStation.Utils.isNoDueDate(t)?"":SYNO.SDS.NoteStation.Utils.formatDateString(t,!0)},getComment:function(t){return t.replace(/\n/g,"<br>")},getIndentSize:function(t){var e=0;return t.hasOwnProperty("done")&&(e+=26),t.hasOwnProperty("star")&&(e+=26),t.hasOwnProperty("priority")&&(e+=16),e}})),SYNO.SDS.NoteStation.Todo.Common.TodoExportTemplate},getTodoListHtml:function(t,e){var o=[],i=SYNO.SDS.NoteStation.Window.settings.todo_export_info||"title,subtask,comment";!function n(s){if(s===t.length){var a=SYNO.SDS.NoteStation.Todo.Common,r="title"!==i?a.getExportTodoTemplate():a.getExportTodoTitleTemplate(),l=r.apply(o);return void e(l)}var d=t[s];SYNO.SDS.NoteStation.Window.getStorage().getTodo({object_id:d,scope:this,callback:function(t,e){if(!t)return void n(s+1);var a=Ext.copyTo({},e,i);if(o.push(a),i.indexOf("subtask")<0)return void n(s+1);SYNO.SDS.NoteStation.Window.getStorage().listTodo({filter:{parent_id:d},sort_by:"title",sort_direction:"asc",raw_sort:!0,scope:this,callback:function(t,e){if(o[o.length-1].subtask=[],!t||!Ext.isObject(e)||!Ext.isArray(e.todos)||0===e.count)return void n(s+1);Ext.each(e.todos,function(t,e){var n=Ext.copyTo({},t,i);o[o.length-1].subtask.push(n)},this),n(s+1)}})}})}(0)}}}),Ext.define("SYNO.SDS.NoteStation.Todo.EditPanel",{extend:"SYNO.ux.FormPanel",record:null,menuPriority:null,menuReminderOffset:null,subtask:{},constructor:function(t){SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Todo.EditPanel",this),this.owner=t.owner,this.addEvents("setpriority","setreminderoffset");var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e={};return e={cls:"syno-ns-todo-edit-panel",labelWidth:25,items:[{xtype:"syno_textarea",itemId:"todo_title",width:290,growMin:28,autoFlexcroll:!1,grow:!0,itemCls:"syno-ns-todo-title",save_task:null,enableKeyEvents:!0,listeners:{scope:this,autosize:this.doLayout,afterrender:function(t){var e=this;t.label.addClassOnHover("icon-mouseover"),t.label.addClassOnClick("icon-click"),t.label.on("click",function(){var o={object_id:[e.record.get("object_id")],star:!t.label.hasClass("star-on")};o.star?t.label.addClass("star-on"):t.label.removeClass("star-on"),SYNO.SDS.NoteStation.Todo.Common.setTodo(e.owner.todoMainPanel.getActiveGrid(),o,!0)})},blur:function(t){window.clearTimeout(t.save_task),this.saveTitle(t,!0)},keydown:function(t,e){window.clearTimeout(t.save_task),13===e.keyCode?t.blur():t.save_task=window.setTimeout(this.saveTitle.createDelegate(this,[t,!1]),3e3)}}},{xtype:"syno_displayfield",itemCls:"syno-ns-todo-title-sep"},{xtype:"syno_displayfield",itemId:"todo_priority",htmlEncode:!1,hideLabel:!1,value:"No Priority",itemCls:"syno-ns-todo-label-field todo-priority",listeners:{scope:this,afterrender:function(){var t=this;this.getComponent("todo_priority").getEl().on("click",function(e){t.menuPriority||(t.menuPriority=new SYNO.SDS.NoteStation.Todo.Menu.Priority({owner:t})),t.menuPriority.showAt(e.getXY())})}}},new SYNO.SDS.NoteStation.Todo.Component.DateTimeField({xtype:"syno_datetimefield",itemId:"todo_due_date",width:290,menuHideFocus:!1,editable:!1,hideTrigger:!0,itemCls:"syno-ns-todo-label-field syno-ns-todo-add-task-date todo-due-date",emptyText:SYNO.SDS.NoteStation._T("todo","set_due_date"),listeners:{scope:this,select:function(t,e){var o=SYNO.SDS.NoteStation.Utils.dateToEpoch(e),i={object_id:[this.record.get("object_id")],due_date:o};this.getComponent("todo_reminder_date")[-1===o?"disable":"enable"](),-1===o&&this.fireEvent("setreminderoffset",{record:this.record,reminderOffset:-1}),SYNO.SDS.NoteStation.Todo.Common.setTodo(this.owner.todoMainPanel.getActiveGrid(),i,!0)}}}),{xtype:"syno_displayfield",itemId:"todo_reminder_date",hideLabel:!1,itemCls:"syno-ns-todo-label-field todo-reminder-date",value:"Off",listeners:{scope:this,afterrender:function(){var t=this;this.getComponent("todo_reminder_date").getEl().on("click",function(e){this.hasClass("x-item-disabled")||(t.menuReminderOffset||(t.menuReminderOffset=new SYNO.SDS.NoteStation.Todo.Menu.ReminderOffset({owner:t})),t.menuReminderOffset.showAt(e.getXY()),t.menuReminderOffset.initValue(t.record.get("reminder_offset")))})}}},{xtype:"syno_textfield",itemId:"todo_sub_task",itemCls:"syno-ns-todo-label-field todo-sub-task",emptyClass:"disable-font",emptyText:SYNO.SDS.NoteStation._T("todo","add_sub_task"),enableKeyEvents:!0,width:290,listeners:{scope:this,keyup:function(t,e){if(13===e.keyCode){var o=t.getValue().trim();if(Ext.isEmpty(o))return;t.setValue("");var i=this.appendSubtask(o,void 0,!1),n=this.record.get("object_id");this.findAppWindow().getStorage().createTodo({parent_id:n,title:o,scope:this,callback:function(t,e){!0===t&&n===this.record.get("object_id")&&!0===Ext.isObject(this.subtask[i])&&(this.subtask[i].object_id=e.object_id,this.updateGridSubtask())}})}}}},{xtype:"syno_textarea",itemId:"todo_comment",autoFlexcroll:!1,grow:!0,emptyText:SYNO.SDS.NoteStation._T("todo","add_comment"),width:290,growMin:28,itemCls:"syno-ns-todo-label-field todo-comment",save_task:null,enableKeyEvents:!0,listeners:{scope:this,autosize:this.doLayout,blur:function(t){window.clearTimeout(t.save_task),this.saveComment(t)},keydown:function(t,e){window.clearTimeout(t.save_task),13===e.keyCode?this.saveComment(t):t.save_task=window.setTimeout(this.saveComment.createDelegate(this,[t]),3e3)}}},{xtype:"syno_displayfield",itemId:"todo_note_title",htmlEncode:!1,hideLabel:!1,hidden:!0,itemCls:"syno-ns-todo-label-field todo-note-title",listeners:{scope:this,afterrender:function(t){var e=this;t.getEl().on("click",function(t){var o=e.record.get("note_id");new SYNO.SDS.NoteStation.Todo.Preview.Window({owner:e.findAppWindow(),object_id:o}).show()})}}}],listeners:{scope:this,setpriority:function(t){this.setPriorityValue(t.priority);var e={object_id:[this.record.get("object_id")],priority:t.priority};SYNO.SDS.NoteStation.Todo.Common.setTodo(this.owner.todoMainPanel.getActiveGrid(),e,!0)},setreminderoffset:function(t){this.setReminderValue(t.reminderOffset);var e={object_id:[this.record.get("object_id")],reminder_offset:t.reminderOffset};SYNO.SDS.NoteStation.Todo.Common.setTodo(this.owner.todoMainPanel.getActiveGrid(),e,!0)}},buttonAlign:"left",fbar:new Ext.Toolbar({items:[{xtype:"syno_button",cls:"syno-ns-todo-delete",scope:this,handler:function(){var t={object_id:[this.record.get("object_id")]};SYNO.SDS.NoteStation.Todo.Common.deleteTodo(this.owner.todoMainPanel.getActiveGrid(),t)}},"->",{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","finish"),scope:this,handler:this.exitEditPanel.createDelegate(this)}]})},Ext.apply(e,t),e},exitEditPanel:function(){this.hide(),this.owner.owner.doLayout()},enableSubtask:function(t){this.getComponent("todo_sub_task")[t?"enable":"disable"](),Ext.iterate(this.subtask,function(e,o){Ext.getCmp(e)[t?"enable":"disable"](),t||Ext.getCmp(e).items.items[0].setValue(!0)},this)},saveTitle:function(t,e){var o=t.getValue().trim();if(Ext.isEmpty(o))return void(e&&t.setValue(t.oldvalue));t.setValue(o),t.oldvalue=o;var i={object_id:[this.record.get("object_id")],title:o};SYNO.SDS.NoteStation.Todo.Common.setTodo(this.owner.todoMainPanel.getActiveGrid(),i,!0)},saveComment:function(t){var e={object_id:[this.record.get("object_id")],comment:t.getValue().trim()};SYNO.SDS.NoteStation.Todo.Common.setTodo(this.owner.todoMainPanel.getActiveGrid(),e,!0)},setPriorityValue:function(t){var e=SYNO.SDS.NoteStation.Utils.getPriority(t),o="syno-ns-todo-priority priority-"+e,i=SYNO.SDS.NoteStation._T("todo","priority_"+e);"none"===e&&(i=SYNO.SDS.NoteStation._T("todo","priority_no")),this.getComponent("todo_priority").setValue(String.format('<div><div class="{0}"></div>{1}</div>',o,i))},setReminderValue:function(t){var e;t>=0?(e=SYNO.SDS.NoteStation.Utils.dateToEpoch(this.getComponent("todo_due_date").getValue())-t,e=SYNO.SDS.NoteStation.Utils.epochToDate(e),e=SYNO.SDS.NoteStation.Utils.formatDateString(e,!0)):e=SYNO.SDS.NoteStation._T("todo","off"),this.getComponent("todo_reminder_date").setValue(e)},appendSubtask:function(t,e,o){var i=Ext.id();this.subtask[i]={object_id:e};var n=new SYNO.ux.CompositeField({id:i,ownerCt:this,itemCls:"syno-ns-todo-subtask-composite",items:[new SYNO.ux.Checkbox({width:22,checked:o,boxLabel:"",listeners:{scope:this,check:function(t,e){var o={object_id:[this.subtask[i].object_id],done:e};SYNO.SDS.NoteStation.Todo.Common.setTodo(this.owner.todoMainPanel.getActiveGrid(),o,!0)}}}),{xtype:"syno_textfield",value:t,width:220,enableKeyEvents:!0,oldvalue:t,listeners:{scope:this,blur:function(t){var e=t.getValue().trim();if(Ext.isEmpty(e))return void t.setValue(t.oldvalue);t.oldvalue=e;var o={title:t.getValue(),object_id:[this.subtask[i].object_id]};SYNO.SDS.NoteStation.Todo.Common.setTodo(this.owner.todoMainPanel.getActiveGrid(),o,!0)},keydown:function(t,e){13===e.keyCode&&t.blur(),e.stopPropagation()}}},new SYNO.ux.Button({cls:"syno-ns-todo-remove-subtask",scope:this,handler:function(){this.remove(Ext.getCmp(i)),this.doLayout();var t={object_id:[this.subtask[i].object_id]};this.findAppWindow().getStorage().deleteTodo(Ext.apply({scope:this,callback:function(t,e){t&&(delete this.subtask[i],this.updateGridSubtask())}},t))}})]});return this.insert(6,n),this.doLayout(),i},updateGridSubtask:function(){var t=[];Ext.iterate(this.subtask,function(e,o){Ext.isEmpty(o.object_id)||t.push(o.object_id)},this),this.owner.todoMainPanel.getActiveGrid().updateStoreByObjectId(this.record.get("object_id"),{items:t})},loadRecord:function(t){this.record=t,t.get("star")?this.getComponent("todo_title").label.addClass("star-on"):this.getComponent("todo_title").label.removeClass("star-on"),this.getComponent("todo_title").setValue(t.get("title")),this.getComponent("todo_title").oldvalue=t.get("title"),this.setPriorityValue(t.get("priority")),this.getComponent("todo_due_date").setValue(t.get("due_date")),-1===SYNO.SDS.NoteStation.Utils.dateToEpoch(t.get("due_date"))?(this.getComponent("todo_reminder_date").disable(),this.setReminderValue(-1)):(this.getComponent("todo_reminder_date").enable(),this.setReminderValue(t.get("reminder_offset"))),this.getComponent("todo_comment").setValue(t.get("comment")),Ext.isEmpty(t.get("note_title"))||this.hideNoteLink?this.getComponent("todo_note_title").hide():(this.getComponent("todo_note_title").setValue('<a style="cursor: pointer;">'+t.get("note_title")+"</a>"),this.getComponent("todo_note_title").show()),this.loadSubtask(),this.updateFleXcroll(!0)},loadSubtask:function(){Ext.iterate(this.subtask,function(t,e){this.remove(Ext.getCmp(t))},this),this.subtask={},this.getComponent("todo_sub_task").setValue(""),this.setStatusBusy();var t=this.record.get("object_id");this.findAppWindow().getStorage().listTodo({filter:{parent_id:t},sort_by:"title",sort_direction:"asc",raw_sort:!0,scope:this,callback:function(t,e){if(this.clearStatusBusy(),!t||!Ext.isObject(e)||!Ext.isArray(e.todos)||0===e.count)return void this.enableSubtask(!this.record.get("done"));e.todos.reverse(),Ext.each(e.todos,function(t,e){this.appendSubtask(t.title,t.object_id,t.done)},this),this.enableSubtask(!this.record.get("done"))}})},setStatusBusy:function(){this.el&&!this.el.isMasked()&&this.el.mask(SYNO.SDS.NoteStation._T("common","loading"),"x-mask-loading")},clearStatusBusy:function(){this.el&&this.el.unmask()}}),Ext.ns("SYNO.SDS.NoteStation.Editor.Tinymce.Todo"),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.Todo.Window",{extend:"SYNO.SDS.Window",constructor:function(t){this.module=t.module,this.owner=t.owner,SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Editor.Tinymce.Todo.Window",this),this.createAddTaskTitle(),this.createAddTaskButton(),this.createAddTaskDate(),this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("setting","todo_task"),cls:"syno-ns-float-todo-win",width:386,height:400,resizable:!1,maximizable:!1,minimizable:!1,layout:"card",activeItem:0,items:[this.createTodoMainPanel(),this.createEditPanel()],listeners:{scope:this,move:this.windowMove,close:this.windowClose,show:this.windowShow,afterrender:this.windowAfterrender}};return Ext.apply(e,t)},windowClose:function(t,e){SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Editor.Tinymce.Todo.Window",null),this.addTitlePanel.getEl().removeAnchor(),this.addButton.getEl().removeAnchor(),this.addDate.getEl().removeAnchor(),this.addDate.trigger.removeAnchor()},windowMove:function(t,e,o,i){this.windowAfterrender(t,i)},windowShow:function(t){this.switchToMainPanel(),this.showEditorMode(!1)},windowAfterrender:function(t,e){var o=t.getEl();this.addTitlePanel.render(o),this.addTitlePanel.getEl().anchorTo(o,"bl-bl?"),this.addButton.render(o),this.addButton.getEl().anchorTo(o,"br-br?"),this.addDate.render(o),this.addDate.getEl().anchorTo(o,"br-br?"),this.addDate.trigger.anchorTo(this.addDate.getEl(),"bl-br?"),this.monitor_owner||(this.mon(this.owner,"activate",function(){this.setZIndex(11e3)},this),this.mon(this.owner,"deactivate",function(){this.setZIndex(this.owner.el.getZIndex())},this),this.monitor_owner=!0,this.registerDDEvents())},isAlwaysOnTop:function(){return!1},hasAllowedData:function(t){var e,o;if(!t||!t.dataTransfer)return!1;if(t.dataTransfer.types&&t.dataTransfer.types.length>0)for(e=0;e<t.dataTransfer.types.length;e++)if(o=t.dataTransfer.types[e].toLowerCase(),0===o.indexOf("text")||0===o.indexOf("url"))return!0;if(t.dataTransfer.items&&0<t.dataTransfer.items.length)for(e=0;e<t.dataTransfer.items.length;e++)if(o=t.dataTransfer.items[e].type.toLowerCase(),0===o.indexOf("text/"))return!0;return!1},registerDDEvents:function(){var t=this;this.el&&Ext.isElement(this.el.dom)&&(this.el.dom.ondragover=function(e){!0===t.hasAllowedData(e)&&(e.dataTransfer.dropEffect="copy",e.dataTransfer.effectAllowed="copy",e.preventDefault())},this.el.dom.ondrop=function(e){var o,i=Ext.isIE11||Ext.isIE,n=i?"Text":"URL",s=function(e){SYNO.SDS.NoteStation.Todo.Common.addTodoByNoteHtml(e,t.todoMainPanel,t.note_id)},a=function(e){SYNO.SDS.NoteStation.Todo.Common.addTodo(t.todoMainPanel,{note_id:t.note_id,title:e.trim()},0,!1)};if(o=e.dataTransfer.getData(n),i||(e.preventDefault(),e.stopPropagation(),Ext.isEmpty(o)&&(o=e.dataTransfer.getData("text/html"))),Ext.isString(o)&&!Ext.isEmpty(o.trim()))return o.indexOf("data:text/mce-internal,")>=0&&(o=window.unescape(o.substr("data:text/mce-internal,".length))),void SYNO.SDS.NoteStation.Todo.Common.addTodoByNoteHtml(o,t.todoMainPanel,t.note_id);if(e.dataTransfer.items)for(var r=0;r<e.dataTransfer.items.length;r++){var l=e.dataTransfer.items[r];if("text/html"===l.type)return void l.getAsString(s);if(0===l.type.indexOf("text/"))return void l.getAsString(a)}})},listNoteTodo:function(t){this.note_title=Ext.util.Format.htmlEncode(t.title),this.note_id=t.object_id,this.setTitle(this.note_title);var e={note_id:[this.note_id]};this.todoMainPanel.setNoteId(this.note_id),SYNO.SDS.NoteStation.Todo.Common.listTodo(this.todoMainPanel,!1,e,"due_date","asc")},createAddTaskButton:function(){this.addButton=new SYNO.ux.Button({height:37,cls:"syno-ns-float-todo-add-task-button",iconCls:"syno-ns-float-todo-add-task-button-icon",listeners:{scope:this,click:this.onAddTaskClick}})},createAddTaskTitle:function(){this.addTitle=new SYNO.ux.TextArea({cls:"syno-ns-float-todo-add-task-title",preventScrollbars:!0,enterIsSpecial:!0,id:this.addTitleId=Ext.id(),focusClass:"",hideLabel:!0,validationEvent:"blur",stripCharsRe:/(^\s+|\s+$)/g,emptyText:SYNO.SDS.NoteStation._T("todo","click_add_task"),listeners:{scope:this,focus:this.addTitleFocus,blur:this.addTitleBlur,specialkey:function(t,e){e.getKey()==e.ENTER&&(this.onAddTaskClick(t,e),this.addTitle.getEl().blur(),this.addTitle.reset(),this.showEditorMode(!1))}}}),this.addTitlePanel=new SYNO.ux.Panel({width:386,cls:"syno-ns-float-todo-add-panel",items:this.addTitle})},createAddTaskDate:function(){this.addDate=new SYNO.SDS.NoteStation.Todo.Component.DateTimeField({id:this.addDueDateId=Ext.id(),cls:"syno-ns-float-todo-add-task-date",owner:this,menuHideFocus:!1,editable:!1,height:36}),this.addDate.on("select",function(t,e){t.focus(),t.triggerBlur(),this.resetDueDateWidth()},this),this.addDate.on("show",function(){this.resetDueDateWidth(),this.addDate.wrap.setStyle("top","-36px")},this)},addTitleFocus:function(t,e){this.showEditorMode(!0)},addTitleBlur:function(t,e){this.showEditorMode(!1)},showEditorMode:function(t){var e=this.getEl();this.addTitlePanel[t?"addClass":"removeClass"]("syno-ns-float-todo-add-panel-expand"),this.addTitlePanel.getEl().anchorTo(e,"bl-bl?"),this.addTitlePanel[t?"addClass":"removeClass"]("syno-ns-float-todo-add-task-expand-color"),this.addTitle[t?"addClass":"removeClass"]("syno-ns-float-todo-add-task-expand-color"),this.addTitle[t?"addClass":"removeClass"]("syno-ns-float-todo-add-task-title-expand"),this.addDate[t?"addClass":"removeClass"]("syno-ns-float-todo-add-task-expand-color"),this.addDate.trigger[t?"addClass":"removeClass"]("syno-ns-float-todo-add-task-expand-color"),this.addButton[t?"addClass":"removeClass"]("syno-ns-float-todo-add-task-expand-color"),this.addTitle.updateFleXcroll()},createTodoMainPanel:function(){return this.todoMainPanel=new SYNO.SDS.NoteStation.Editor.Tinymce.Todo.MainPanel({itemId:"todo_main_panel",owner:this}),this.todoMainPanel},createEditPanel:function(){return this.todoEditPanel=new SYNO.SDS.NoteStation.Editor.Tinymce.Todo.EditPanel({itemId:"todo_edit_panel",owner:this,width:386,hideNoteLink:!0}),this.todoEditPanel},setStatusBusy:function(){this.el&&!this.el.isMasked()&&this.el.mask(SYNO.SDS.NoteStation._T("common","loading"),"x-mask-loading")},clearStatusBusy:function(){this.el&&this.el.unmask()},onAddTaskClick:function(t,e){var o={};o.note_id=this.note_id;var i=Ext.getCmp(this.addTitleId).getValue().trim();if(!Ext.isEmpty(i)){o.title=i;var n=Ext.getCmp(this.addDueDateId).getValue();Ext.isEmpty(n)||(o.due_date=SYNO.SDS.NoteStation.Utils.dateToEpoch(n)),SYNO.SDS.NoteStation.Todo.Common.addTodo(this.todoMainPanel,o,0,!1),this.resetAddTaskPanel()}},resetAddTaskPanel:function(){var t=Ext.getCmp(this.addTitleId),e=Ext.getCmp(this.addDueDateId);t.reset(),e.reset(),e.trigger.setVisible(!0),this.resetDueDateWidth()},resetDueDateWidth:function(){var t=Ext.getCmp(this.addDueDateId);t&&(Ext.isEmpty(t.getValue())?(t.setWidth(26),t.wrap.setStyle("left","306px")):(t.setWidth(146),t.wrap.setStyle("left","210px")))},showHeader:function(){this.removeClass("syno-ns-float-todo-win-no-header"),this.setHeight(401),this.setHeight(400)},hideHeader:function(){this.addClass("syno-ns-float-todo-win-no-header"),this.setHeight(401),this.setHeight(400)},switchToMainPanel:function(){this.showHeader(),this.layout.setActiveItem("todo_main_panel"),this.addTitlePanel.show(),this.addDate.show(),this.addButton.show()},switchToEditPanel:function(t){this.layout.setActiveItem("todo_edit_panel"),this.todoEditPanel.loadRecord(t),this.addTitlePanel.hide(),this.addDate.hide(),this.addButton.hide(),this.hideHeader()}}),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.Todo.MainPanel",{extend:"SYNO.ux.EditorGridPanel",canLoadMore:!0,isLoadingData:!1,query_limit:100,sortBy:"due_date",sortDirection:"asc",constructor:function(t){this.owner=t.owner,this.noteTitle={},this.createTitleEidtor(),this.createDateEditor(),this.addEvents("setstar","setpriority","setreminderoffset"),this.lastSelectedRowIndex=[],this.lastClickRowIndex=-1,this.query_info={sort_by:this.sortBy,sort_direction:this.sortDirection,offset:0,limit:this.query_limit},this.filter={},this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={hideHeaders:!0,width:386,height:320,colModel:this.createColModel(),selModel:this.createSelectModel(),plugins:this.checkColumn,autoExpandColumn:"mixed",collapsible:!1,store:this.createStore(),view:new SYNO.ux.FleXcroll.grid.GridView({itemId:"todo_view",rowSelectorDepth:15,markDirty:!1}),listeners:{scope:this,afterrender:this.onGridAfterrender,setstar:SYNO.SDS.NoteStation.Todo.Common.onSetStar.createDelegate(this,{grid:this},!0),setpriority:SYNO.SDS.NoteStation.Todo.Common.onSetPriority.createDelegate(this,{grid:this},!0),setreminderoffset:SYNO.SDS.NoteStation.Todo.Common.onSetReminderOffset.createDelegate(this,{grid:this},!0),bodyscroll:this.onBodyScroll,resize:this.onGridResize,rowclick:this.onGridRowClick,mouseout:this.onGridMouseout,mouseover:{fn:this.onGridMouseover,buffer:200,scope:this}}};return Ext.apply(e,t),e},updateDueDateWidth:Ext.emptyFn,adjustDueDateWidth:Ext.emptyFn,onGridAfterrender:function(t,e){this.titleEditor.render(this.getEl()),this.titleEditor.getEl().setStyle("z-index",11e3),this.dateEditor.render(this.getEl()),this.dateEditor.getEl().setStyle("z-index",11e3)},onLoadStore:function(){this.body.select(".syno-ns-todo-grid-star").elements.forEach(function(t){var e=Ext.fly(t);e.addClassOnOver("icon-mouseover"),e.addClassOnClick("icon-click")}),this.body.select(".syno-ns-todo-grid-more").elements.forEach(function(t){var e=Ext.fly(t);e.addClassOnOver("icon-mouseover"),e.addClassOnClick("icon-click")})},onUpdateStore:function(t,e,o){this.onLoadStore.createDelegate(this).defer(100)},onAddStore:function(t,e,o){this.onLoadStore.createDelegate(this).defer(100)},createStore:function(){var t=SYNO.SDS.NoteStation.Todo.Common.createReader();return new Ext.data.Store({reader:t,remoteSort:!0,listeners:{scope:this,add:this.onAddStore,load:this.onLoadStore,update:this.onUpdateStore}})},createColModel:function(){return this.checkColumn=new SYNO.ux.EnableColumn({id:"check",dataIndex:"done",width:40,fixed:!0,align:"center",renderer:this.renderCheckColumn,listeners:{click:SYNO.SDS.NoteStation.Todo.Common.onDoneClick,scope:this}}),this.divider=new Ext.grid.Column({id:"divider",dataIndex:"divider",scope:this,fixed:!0,width:1}),this.starColumn=new Ext.grid.Column({dataIndex:"star",id:"star",width:32,fixed:!0,renderer:SYNO.SDS.NoteStation.Todo.Common.renderTodoStar.createDelegate(this),listeners:{scope:this,click:function(t,e,o,i){var n=i.target.classList.contains("star-off");e.fireEvent("setstar",{record:e.getStore().getAt(o),star:n})}}}),this.mixColumn=new Ext.grid.Column({id:"mixed",scope:this,renderer:this.renderMixColumn}),this.moreColumn=new Ext.grid.Column({dataIndex:"more",width:32,id:"more",fixed:!0,renderer:function(){return'<div class="syno-ns-todo-grid-more"></div>'},listeners:{scope:this,click:function(t,e,o,i){var n=e.getStore().getAt(o);this.owner.switchToEditPanel(n)}}}),new Ext.grid.ColumnModel({columns:[this.checkColumn,this.divider,this.starColumn,this.mixColumn,this.moreColumn]})},createSelectModel:function(){return new Ext.grid.RowSelectionModel({single:!1})},createTitleEidtor:function(){this.titleEditor=new Ext.Editor({id:this.titleEditorId=Ext.id(),shadow:!1,cls:"syno-ns-todo-title-editor",field:{xtype:"syno_textfield",focusClass:"",cls:"syno-ns-todo-titlefield",allowBlank:!1,stripCharsRe:/(^\s+|\s+$)/g,listeners:{scope:this,focus:this.onTitleFieldFocus}},listeners:{scope:this,complete:this.onTitleEditorComplete}})},createDateEditor:function(){this.dateEditor=new Ext.Editor({id:this.dateEditor=Ext.id(),shadow:!1,cls:"syno-ns-todo-date-editor",field:new SYNO.SDS.NoteStation.Todo.Component.DateTimeField({owner:this,cls:"syno-ns-todo-date-textfield"}),listeners:{scope:this,complete:this.onDateEditorComplete,beforeshow:this.onBeforeShowDueDateEditor}})},onBeforeShowDueDateEditor:function(t){return t.field.showDateMenu(t.field),!1},renderCheckColumn:function(t,e,o,i,n,s){return String.format('<div class="syno-ux-grid-enable-column-{0} syno-ns-todo-grid-check">&nbsp;</div>',"gray"===t?"grayed":t?"checked":"unchecked")},renderMixColumn:function(t,e,o,i,n,s){var a=['<table class="x-grid3-row-table">',"<tbody>","<tr>",'<td class="x-grid3-td-title" colspan="2">{0}</td>',"</tr>","<tr>",'<td class="x-grid3-td-indicator">{1}</td>','<td class="x-grid3-td-date">{2}</td>',"</tr>","</tbody>","</table>"].join(""),r=SYNO.SDS.NoteStation.Todo.Common.getTodoIndicator(o),l=this.renderTitle(o.get("title"),e,o,i,n,s),d=this.renderDueDate(o.get("due_date"),e,o,i,n,s);return String.format(a,l,r,d)},renderTitle:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation.Todo.Common.renderTodoTitle(t,e,o,i,n,s)},renderPriority:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation.Todo.Common.renderTodoPriority(t,e,o,i,n,s)},renderReminderOffset:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation.Todo.Common.renderTodoReminderOffset(t,e,o,i,n,s)},renderDueDate:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation.Todo.Common.renderTodoDueDate(t,e,o,i,n,s,this,!0)},renderDelete:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation.Todo.Common.renderTodoDelete(t,e,o,i,n,s,this)},onBodyScroll:function(t,e){if(this.titleEditor.cancelEdit(!1),this.dateEditor.cancelEdit(!1),!1!==this.canLoadMore&&!0!==this.isLoadingData){var o=this.getView().scroller.dom.fleXdata;o&&!1!==o.scrollPosition[1][1]&&o.scrollPosition[1][1]===o.scrollPosition[1][0]&&SYNO.SDS.NoteStation.Todo.Common.listTodo(this,!0,this.filter,this.sortBy,this.sortDirection)}},onGridResize:function(t,e,o,i,n){SYNO.SDS.NoteStation.Utils.setEmptyTextLineHeight.call(this.getView(),Math.round(.9*o))},onGridRowClick:function(t,e,o){this.lastClickRowIndex=e;var i,n=this.getStore().getAt(e);if(i=o.getTarget(".syno-ns-todo-grid-priority"),i&&(this.menuPriority||(this.menuPriority=new SYNO.SDS.NoteStation.Todo.Menu.Priority({owner:this})),this.menuPriority.showAt(o.getXY()),this.menuPriority.setRecord(n)),i=o.getTarget(".syno-ns-todo-grid-reminder")){if(SYNO.SDS.NoteStation.Utils.isNoDueDate(n.get("due_date")))return;this.menuReminderOffset||(this.menuReminderOffset=new SYNO.SDS.NoteStation.Todo.Menu.ReminderOffset({owner:this})),this.menuReminderOffset.showAt(o.getXY()),this.menuReminderOffset.initValue(this.getStore().getAt(e).get("reminder_offset")),this.menuReminderOffset.setRecord(n)}if(i=o.getTarget(".syno-ns-todo-grid-delete")){var s,a,r=this.getAppWin(),l={}
;l.object_id=[],l.object_id.push(this.getStore().getAt(e).get("object_id")),s=r.getMsgBox(),a=String.format(SYNO.SDS.NoteStation._T("todo","delete_todo"),l.object_id.length),s.confirmDelete("",a,function(t,e){"yes"===t&&SYNO.SDS.NoteStation.Todo.Common.deleteTodo(this,l)},this)}if(i=o.getTarget(".syno-ns-todo-grid-title")){var d=Ext.get(i);this.titleEditor.startEdit(d,n.get("title")),this.titleEditor.getEl().anchorTo(d,"tl-tl?")}if(i=o.getTarget(".x-grid3-td-date")){var c=Ext.get(i);this.dateEditor.startEdit(c,n.get("due_date")),this.dateEditor.getEl().anchorTo(c,"br-br?")}},onGridMouseover:function(t){SYNO.SDS.NoteStation.Todo.Common.onGridMouseover(this,t,!1)},onGridMouseout:function(t){SYNO.SDS.NoteStation.Todo.Common.onGridMouseout(this,t,!1)},onTitleEditorComplete:function(t,e,o,i){if(e.trim()!==o.trim()){var n={},s=[],a=this.getStore().getAt(this.lastClickRowIndex);s.push(a.get("object_id")),n.object_id=s,n.title=e.trim(),SYNO.SDS.NoteStation.Todo.Common.setTodo(this,n)}},onTitleFieldFocus:function(t,e){var o=this.getStore().getAt(this.lastClickRowIndex),i=o.get("done");t.getEl()[i?"addClass":"removeClass"]("syno-ns-todo-titlefield-disabled")},onDateEditorComplete:function(t,e,o,i){if(e=Ext.isEmpty(e)?new Date(-1e3):e,e.getTime()!=o.getTime()){var n={},s=[],a=this.getStore().getAt(this.lastClickRowIndex);a.set("due_date",e),s.push(a.get("object_id")),n.object_id=s,n.due_date=SYNO.SDS.NoteStation.Utils.dateToEpoch(e),SYNO.SDS.NoteStation.Todo.Common.setTodo(this,n)}},setNoteId:function(t){this.filter.note_id=[t]},getAppWin:function(){return this.owner},getActiveGrid:function(){return this},getTodoPanel:function(){return this.owner},uniformStoreDataFormat:function(t,e){var o=e;return"due_date"===t&&(o=-1===e?new Date(-1e3):SYNO.SDS.NoteStation.Utils.epochToDate(e)),o},updateStoreByObjectId:function(t,e){var o=this.getStore().find("object_id",t);if(-1!==o){var i;for(var n in e)if(e.hasOwnProperty(n)){if("object_id"===n)continue;i=this.uniformStoreDataFormat(n,e[n]),this.getStore().getAt(o).set(n,i)}}},resetSelectRecord:function(){this.lastSelectedRowIndex=[],this.lastClickRowIndex=0}}),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.Todo.EditPanel",{extend:"SYNO.SDS.NoteStation.Todo.EditPanel",constructor:function(t){this.callParent([t])},exitEditPanel:function(){this.owner.switchToMainPanel()}}),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.FloatToolbar",{constructor:function(t){var e=this;this.buttonGroupBound=[],this.toolbarContainer=t.toolbarContainer,this.toolbar=this.toolbarContainer.items()[0],this.toolbarContainer.insert({type:"floatpanel",classes:"syno-ns-editor-float-toolbar",layout:"flow",autohide:!0,items:[{type:"button",icon:"synomore",onclick:function(){e._toggleFloatToolbar()}}]},0),this.floatToolbar=this.toolbarContainer.items()[0],this.floatToolbar.on("hide",function(){e.moreBtn.active(!1)}),this.floatToolbar.on("show",function(){e.moreBtn.active(!0)});var o=this.floatToolbar.getEl();o.addEventListener("click",function(t){var i=e.floatToolbar.getParentCtrl(t.target);i&&t.target!==o&&(t.stopPropagation(),"menubutton"===i.type||"colorbutton"===i.type&&tinymce.DOM.getParent(t.target,"."+i.classPrefix+"open")||tinymce.ui.FloatPanel.hideAll())}),this.moreBtn=this.floatToolbar.items()[0],this.moreBtnWidth=0,this.displayGroupCount=-1},updateButtons:function(t){0===this.moreBtnWidth&&this._initButtonSize();var e=this.buttonGroupBound[this.buttonGroupBound.length-1]>t,o=e?t-this.moreBtnWidth:t;o>this.buttonGroupBound[this.displayGroupCount-1]?this._incrementButtons(o):this._decrementButtons(o),e?this._buttonToToolbar(this.moreBtn):(this._buttonToFloatToolbar(this.moreBtn),this.floatToolbar.hide()),this.floatToolbar.getEl().style.setProperty("width",this._calcProperWidth(t)+"px")},_buttonToToolbar:function(t){this.toolbar.getEl().children[0].appendChild(t.getEl())},_buttonToFloatToolbar:function(t){var e=this.floatToolbar.getEl();e.insertBefore(t.getEl(),e.firstElementChild)},_incrementButtons:function(t){for(;this.displayGroupCount<this.buttonGroupBound.length&&this.buttonGroupBound[this.displayGroupCount]<t;)this._buttonToToolbar(this.toolbar.items()[this.displayGroupCount]),this.displayGroupCount+=1},_decrementButtons:function(t){for(;this.displayGroupCount>0&&this.buttonGroupBound[this.displayGroupCount-1]>t;)this._buttonToFloatToolbar(this.toolbar.items()[this.displayGroupCount-1]),this.displayGroupCount-=1},_initButtonSize:function(){var t=this;this.floatToolbar.show();var e=this.toolbar.items(),o=0;e.each(function(e){o+=e.getEl().offsetWidth+6,t.buttonGroupBound.push(o)}),this.displayGroupCount=e.length,this.moreBtnWidth=this.moreBtn.getEl().offsetWidth+4,this.floatToolbar.hide()},_calcProperWidth:function(t){var e=0===this.displayGroupCount?0:this.buttonGroupBound[this.displayGroupCount-1],o=0,i=0;return this.buttonGroupBound.slice(this.displayGroupCount).forEach(function(n){var s=n-e;s+o>t?(i=Math.max(i,o),o=s):o+=s,e=n}),i=Math.max(i,o)},_toggleFloatToolbar:function(){this.floatToolbar.state.get("visible")?this._hideFloatToolbar():this._showFloatToolbar()},_showFloatToolbar:function(){this.floatToolbar.show()},_hideFloatToolbar:function(){this.floatToolbar.hide()}}),Ext.define("SYNO.SDS.NoteStation.Font.Utils",{statics:{fontList:[{name:"Andale mono",value:"andale mono"},{name:"Arial",value:"arial"},{name:"Arial Black",value:"arial black"},{name:"Book Antiqua",value:"book antiqua"},{name:"Calibri",value:"calibri"},{name:"Cambria",value:"cambria"},{name:"Comic Sans MS",value:"comic sans ms"},{name:"Consolas",value:"consolas"},{name:"Courier",value:"courier"},{name:"Courier New",value:"courier new"},{name:"Georgia",value:"georgia"},{name:"Helvetica Neue",value:"helvetica neue"},{name:"Helvetica",value:"helvetica"},{name:"Impact",value:"impact"},{name:"Lucida Console",value:"lucida console"},{name:"Lucida Sans Unicode",value:"lucida sans unicode"},{name:"Symbol",value:"symbol"},{name:"Roman",value:"roman"},{name:"Tahoma",value:"tahoma"},{name:"Terminal",value:"terminal"},{name:"Times New Roman",value:"times new roman"},{name:"Trebuchet MS",value:"trebuchet ms"},{name:"Verdana",value:"verdana"},{name:"Webdings",value:"webdings"},{name:"Wingdings",value:"wingdings"},{name:"新細明體",value:"PMingLiu"},{name:"細明體",value:"MingLiu"},{name:"標楷體",value:"DFKai-sb"},{name:"微軟正黑體",value:"Microsoft JhengHei"},{name:"微软雅黑",value:"Microsoft Yahei"},{name:"宋体",value:"SimSun"},{name:"新宋体",value:"NSimSun"},{name:"楷体",value:"KaiTi"},{name:"黑体",value:"SimHei"}],availableFont:[],getAvailableFont:function(){function t(t){return e.style.fontFamily=t,e.offsetWidth}if(0!==SYNO.SDS.NoteStation.Font.Utils.availableFont.length)return SYNO.SDS.NoteStation.Font.Utils.availableFont;var e=document.createElement("span");e.style.fontSize="72px",e.style.visibility="hidden",e.innerHTML="mmmmmmmmmmlli",document.body.appendChild(e);var o={},i=["monospace","sans-serif","serif"];return i.forEach(function(e){o[e]=t(e)}),SYNO.SDS.NoteStation.Font.Utils.fontList.forEach(function(e){for(var n=0;n<i.length;n++){if(t(e.value+","+i[n])!==o[i[n]])return void SYNO.SDS.NoteStation.Font.Utils.availableFont.push(e.name+"="+e.value)}}),document.body.removeChild(e),SYNO.SDS.NoteStation.Font.Utils.availableFont}}}),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){this.owner=t.owner,this.addEvents("editorFocus","editorBlur","editorPaste","editorAfterPaste","editorLoadNote"),this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e="SYNO.SDS.NoteStation.Application",o=e+SYNO.SDS.Config.FnMap[e].config.version,i=["syno_autolink syno_searchreplace hr syno_table","syno_print syno_ddupload syno_checkbox syno_attachment_viewer textcolor","syno_fontselect syno_notefontsizeselect syno_listbox syno_copyformat syno_alignbutton","syno_tab syno_image syno_link syno_formupload syno_removeformat","syno_mobileoutput syno_lang syno_textcolor syno_recorder syno_paste syno_ns_lists syno_search","syno_reader_style syno_headingselect syno_gmail_style syno_chart syno_delete syno_save","syno_ns_shortcut"];return this.ddupload=new SYNO.SDS.NoteStation.Editor.Tinymce.DDUpload({module:this.owner,owner:this}),this.syno_editor=new SYNO.ux.TinyMCE({owner:this,autoEditorResize:!0,mceConfig:{synoPostfix:o,skin_url:"webman/3rdparty/NoteStation/js/TinyMCE/js/tinymce/skins/synostyle",content_css:"webman/3rdparty/NoteStation/js/tinymce_plugins/note_content_patch.css",automatic_uploads:!1,images_dataimg_filter:Ext.emptyFn,keepFocusOnEditor:!1,forced_root_block:"div",table_tab_navigation:!0,plugins:i,table_toolbar:!1,toolbar:"undo redo | syno_headingselect syno_fontselect syno_notefontsizeselect syno_forecolor syno_highlight | bold italic underline strikethrough subscript superscript | syno_align_button numlist bullist syno_outdent syno_indent syno_checkbox hr | syno_copyformat syno_removeformat syno_table syno_charteditor syno_link | syno_image syno_recorder syno_formupload syno_search",statusbar:!1,menubar:!1,editorPanel:this,convert_url:!1,browser_spellcheck:!0,module:this.owner,owner:this,syno_paste_format:!0,paste_data_images:!0,disable_editor_upload:!0,detect_reader_content:!0,paste_remove_styles_if_webkit:!1,indent:!1,paste_retain_style_properties:"all",syno_print:{onPrintHtml:function(t,e){var o='<div class="normal-font" style="font-size: 15px;font-weight: bold;padding-left: 4px;">{0}</div>';return o+='<hr style="border:dashed 1px #D7E1EB;" />',o+='<div class="normal-font">{1}</div>',o+='<img src="webman/3rdparty/NoteStation/images/_2x/shadow_title.png?v=0329" style="width: 100%; height: 4px;"> </img>',"header"===e?String.format(o,this.owner.getPrintTitle(),this.owner.getPrintInfo()):""},onPrintWindowTitle:function(){return this.owner.getPrintTitle()},scope:this},font_formats:SYNO.SDS.NoteStation.Font.Utils.getAvailableFont().join(";"),syno_ddupload:{instance:this.ddupload},extended_valid_elements:["img[class|src|border=0|alt|title|hspace|vspace|width|height|align|name|ref|adjust|style]","iframe[src|width|height|frameborder|allowfullscreen|youtube|anchorhref]","a[href|target|rel|media|hreflang|type|download|charset|name|rev|shape|coords|file_ref|style]","embed[src|type|width|height|pdf_ref]","table[id|style|title|border|summary|width|frame|rules|cellspacing|cellpadding|align|bgcolor]","div[accesskey|class|dir|lang|style|tabindex|title|contenteditable|contextmenu|draggable|dropzone|hidden|spellcheck|translate|xml|align|chart-data|chart-config]"].join(",")},listeners:{initialize:function(t,e){var o,i=this;this.floatToolbar=new SYNO.SDS.NoteStation.Editor.Tinymce.FloatToolbar({toolbarContainer:e.theme.panel.items()[0]}),o=Ext.get(e.getContainer()),e.on("focus BeforeSetContent BlockComponentChange",function(){0!==i.getHeight()&&t.fireEvent("resize",t,i.getWidth(),i.getHeight(),i.getWidth(),i.getHeight())}),(Ext.isIE||Ext.isIE11)&&e.on("SetContent",function(){Ext.iterate(e.dom.select("iframe"),function(t,e){var o=SYNO.SDS.NoteStation.Editor.Tinymce.Link.Youtube;o&&o.matchUrl(t.src)&&(t.src=Ext.urlAppend(t.src,"wmode=transparent",!1))})}),e.on("SetContent",function(){i.setImgContainer()}),e.on("focus",function(o){i.fireEvent("editorFocus",t,e),e.settings.syno_edit_mode=!0}),e.on("blur",function(o){this.settings.keepFocusOnEditor||(i.fireEvent("editorBlur",t,e),e.settings.syno_edit_mode=!1)}),e.on("BeforeAddUndo",function(t){!0===t.level.syno_prevent&&(t.lastLevel.content=t.level.content,t.preventDefault())}),e.on("undo",function(t){e.settings.syno_ddupload.instance.refresh(),e.undoManager.add({syno_prevent:!0})}),e.on("redo",function(){e.settings.syno_ddupload.instance.removeInvalidImg(),e.undoManager.add({syno_prevent:!0})}),e.on("paste",function(o){i.fireEvent("editorPaste",t,e,o),Ext.defer(function(){i.fireEvent("editorAfterPaste",t,e)},100)}),e.on("keydown keyup mousedown mouseup mousewheel scroll",function(t){i.owner.fireEvent("resetidle")}),e.on("keyup",function(t){13===t.keyCode&&i.adjustScrollPos()}),e.parser.addAttributeFilter("ref",function(t){Ext.iterate(t,function(t,e){"img"===t.name&&"3rdparty/NoteStation/images/transparent.gif"===t.attr("src")&&(t.attr("src","webman/3rdparty/NoteStation/images/transparent.gif"),t.attr("data-mce-src","webman/3rdparty/NoteStation/images/transparent.gif"))})}),e.parser.addNodeFilter("font",function(t,e){Ext.iterate(t,function(t,e){t.name="span";var o="";if(Ext.iterate(t.attributes,function(t){if(Ext.isEmpty(t.name)||Ext.isEmpty(t.value))return!0;switch(t.name){case"color":o+=t.name+":"+t.value+";";break;case"face":o+="font-family:"+t.value+";";break;case"size":o+="font-size:"+t.value+";";break;case"style":o+=t.value}}),Ext.isEmpty(o))return!0;t.attr("color",null),t.attr("face",null),t.attr("size",null),t.attr("style",o)})}),Ext.isObject(o)&&o.setStyle("border-width","0px"),Ext.isElement(e.getContentAreaContainer())&&(o=Ext.get(e.getContentAreaContainer()),o.setStyle("border-width","0px"),o.prev().setStyle("border-width","0px 0px 1px 0px"));var n=document.createElement("style");n.innerHTML="img {max-width:"+window.screen.width+"px;}",this.getEditor().getDoc().getElementsByTagName("head")[0].appendChild(n),Ext.fly(e.getDoc()).on("mousedown",function(){var t=i.findAppWindow();Ext.isObject(t)&&!t.isDestroyed&&Ext.isObject(t.manager)&&Ext.isFunction(t.manager.getActiveAppWindow)&&t.manager.getActiveAppWindow()!==t&&t.toFront()}),this.unmaskTask=new Ext.util.DelayedTask(function(){if(Ext.dd.DragDropMgr.dragCurrent)return void this.unmaskTask.delay(800);SYNO.SDS.NoteStation.Utils.unMaskEditor(this.getEditor())},this);var s=this.getEditor().getContentAreaContainer();this.dropTarget=new Ext.dd.DropZone(Ext.get(s),{ddGroup:"SDSShortCut",owner:this,s_targselect:"syno-ns-editor-drop-mask",getTarget:function(t,e,o){return!0},getTargetFromEvent:function(t){var e=Ext.get(s.getElementsByTagName("iframe")[0]);return e.dom},onNodeEnter:function(t,e,o,i){var n=this.owner.getEditor();SYNO.SDS.NoteStation.Utils.maskEditor(n)},onNodeOut:function(t,e,o,i){var n=this.owner.getEditor();SYNO.SDS.NoteStation.Utils.unMaskEditor(n)},onNodeOver:function(t,e,o,i){var n=this.owner.getEditor(),a=n.getDoc(),r=o.getXY()[0]-s.getClientRects()[0].left,l=o.getXY()[1]-s.getClientRects()[0].top;return n.isMask||SYNO.SDS.NoteStation.Utils.maskEditor(n),this.owner.unmaskTask.delay(800),n.focus(),i.ddel.innerHTML=SYNO.SDS.NoteStation._T("editor","drop_to_copy"),e.proxy.update(i.ddel),a.caretRangeFromPoint&&!Ext.isEmpty(a.caretRangeFromPoint(r,l))&&n.selection.setRng(a.caretRangeFromPoint(r,l)),Ext.dd.DropZone.prototype.dropAllowed},onNodeDrop:function(t,e,o,i){var n=this.owner.getEditor();return Ext.each(i.selections,function(t){this.owner.ddupload.addFile(void 0,{name:t.get("filename"),size:t.get("filesize"),type:SYNO.SDS.NoteStation.Utils.isSupportImageFormat(t.get("type"))?"image":"binary",format:"ds",source:t.get("path")})},this),SYNO.SDS.NoteStation.Utils.unMaskEditor(n),!0}}),Ext.EventManager.on(e.getDoc(),"mousemove",this.ddMouseMoveHandler,this),Ext.EventManager.on(e.getDoc(),"mouseup",this.ddMouseUpHandler,this)},resize:function(t,e){this.floatToolbar&&this.floatToolbar.updateButtons(e)},scope:this}}),this.on("editorAfterPaste",function(t,e){this.ddupload.checkImage()},this),this.on("activate",function(){this.getEditor()&&this.ddupload&&this.ddupload.renderTo(this.getEditor().getBody())},this),this.on("beforedestroy",function(){var t=this.getEditor();Ext.isEmpty(t)||(Ext.EventManager.un(t.getDoc(),"mousemove",this.ddMouseMoveHandler),Ext.EventManager.un(t.getDoc(),"mouseup",this.ddMouseUpHandler)),this.dropTarget&&this.dropTarget.unreg()}),Ext.apply({layout:"fit",items:[this.syno_editor]},t)},getCurrentFileID:function(t,e){var o;for(o in e)if(e[o].ref===t)return o;return null},setDDPos:function(t){var e=this.getEditor(),o=e.getDoc(),i=e.getContentAreaContainer(),n=Ext.get(i.getElementsByTagName("iframe")[0]),s=o.documentElement.scrollTop||o.body.scrollTop,a=o.documentElement.scrollLeft||o.body.scrollLeft;t.xy=[n.getXY()[0]+t.xy[0]+a,n.getXY()[1]+t.xy[1]-s]},ddMouseMoveHandler:function(t){Ext.isEmpty(Ext.dd.DragDropMgr.dragCurrent)||(t.preventDefault(),this.setDDPos(t),Ext.dd.DragDropMgr.handleMouseMove(t))},ddMouseUpHandler:function(t){if(Ext.isEmpty(Ext.dd.DragDropMgr.dragCurrent))return!0;this.setDDPos(t),Ext.dd.DragDropMgr.handleMouseUp(t)},getEditor:function(){return this.syno_editor.editor},setImgContainer:function(){var t=this.getEditor();Ext.get(t.getBody()).select("img").each(function(t){if(!t.hasClass("syno-ns-img-from-clipper")&&!t.hasClass("syno-ns-chart-object"))try{t.findParent("div").setAttribute("syno-ns-img-container",!0)}catch(t){}})},setContent:function(t){var e=this.getEditor();Ext.isEmpty(e)||Ext.isString(t)&&(e.selection.collapse(),e.selection.setCursorLocation(e.getBody(),0),e.setContent(t),e.getWin().scrollTo(0,0),this.originalContent=e.getContent(),this.rawOriginalContent=t,this.owner.resizeEditorHeight())},getContent:function(){var t=this.getEditor();if(!Ext.isEmpty(t))return t.getContent()},isContentDirty:function(){var t=this.getEditor();return!Ext.isEmpty(t)&&void 0!==this.originalContent&&(t.getContent()!==this.originalContent||!!this.isKeepModifyTime())},isKeepModifyTime:function(){return this.getEditor().getContent()===this.originalContent&&!Ext.isEmpty(this.rawOriginalContent)&&this.rawOriginalContent!==this.originalContent},clearContentDirty:function(t){var e=this.getEditor();Ext.isString(t)?this.originalContent=t:e&&(this.originalContent=e.getContent()),this.rawOriginalContent=this.originalContent},getBrief:function(){var t,e=this.getEditor();return Ext.isEmpty(e)?"":(t=e.getContent({format:"text"}),Ext.isEmpty(t)||!Ext.isString(t)?"":t.substr(0,80))},getSubstituteTitle:function(){var t,e=this.getEditor();if(!Ext.isEmpty(e)&&(t=e.getContent({format:"text"}),!Ext.isEmpty(t)))return t=t.trim().substr(0,SYNO.SDS.NoteStation.Define.TITLE_MAX_LENGTH),-1===t.indexOf("\n")?t:t.substr(0,t.indexOf("\n"))},adjustScrollPos:function(){var t=this.getEditor(),e=this.getEl().getY()+this.getEl().getHeight(),o=Ext.get(t.selection.getStart()).getY()+Ext.get(t.iframeElement).getY();e>o&&e-o<30&&Ext.get(t.getBody()).scroll("t",-60,!0)},setAttachment:function(t,e,o){this.ddupload.setFiles(t,e,o)},getAttachment:function(){return this.ddupload.getModifiedFiles()},getExistAttachment:function(){return this.ddupload.getExistFiles()},isAttachmentDirty:function(){return this.ddupload.isDirty()},clearAttachmentDirty:function(){this.ddupload.clearDirty()},onImageReady:function(t,e,o){return this.ddupload.onImageReady(t,e,o)},enableKeepFocusOnEditor:function(){this.getEditor().settings.keepFocusOnEditor=!0},disableKeepFocusOnEditor:function(){this.getEditor().settings.keepFocusOnEditor=!1},resetContentAttachment:function(){this.ddupload.resetContent()},restoreContentAttachment:function(){this.ddupload.restoreContent()}}),Ext.define("SYNO.SDS.NoteStation.Editor.MetaData.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Editor.MetaData.Panel",this);var e=this.fillConfig(t);this.callParent([e])},defaultLat:0,defaultLng:0,fillConfig:function(t){var e={cls:"syno-ns-editor-metadata-panel",layout:"table",layoutConfig:{columns:4},items:this.createItems(t),tbar:this.createTBar(),hideCollapseTool:!0,collapsible:!0,collapseFirst:!1,listeners:{beforecollapse:function(t){t.items.each(function(t){Ext.isFunction(t.hideMenu)?t.hideMenu():Ext.isFunction(t.collapse)&&t.collapse()})},expand:function(t){this.menuBtn&&this.menuBtn.fireEvent("onSetMenuBtnText",this.menuBtn)},resize:function(t,e,o,i,n){this.isDestroyed||Ext.isEmpty(this.tagSuperBox)||Ext.isEmpty(this.addTagBtn)||Ext.isEmpty(this.menuBtn)||(Ext.isEmpty(e)&&(e=this.getWidth()),this.setMenuBtnText(this.menuBtn,e))},scope:this}};return Ext.apply(e,t),e},createItems:function(t){if(!0!==this.readonly)return this.menuBtn=new SYNO.ux.Button({hidden:!0,text:"",cls:"syno-ns-editor-switch-notebook",iconCls:"syno-ns-editor-switch-notebook-icon",ctCls:"syno-ns-editor-switch-notebook-wrap",itemId:"notebook_menubtn",colspan:1,onMenuClick:function(t,e){this.menuBtn.setText(t.text),this.menuBtn.fireEvent("onSetMenuBtnText",this.menuBtn)},menu:this.getNotebookMenu(),listeners:{onSetMenuBtnText:{fn:this.setMenuBtnText,scope:this}}}),this.menuBtn.addEvents("onSetMenuBtnText"),[this.menuBtn]},setMenuBtnText:function(t,e){var o,i,n,s;n=t.btnEl,t.setWidth("auto"),n.setWidth("auto"),0!==(i=n.getWidth())&&(o=Ext.isEmpty(e)?this.getWidth():e,s=o/4,i>s&&(t.setWidth(s),n.setWidth(s-26)),this.setTagSuperBoxWidth(o))},setTagSuperBoxWidth:function(t){t=Ext.isEmpty(t)?this.getWidth():t;var e=this.menuBtn.getWidth()+this.addTagBtn.getWidth();0!==e&&(e+=12,this.tagSuperBox.setContainerWidth(t-e))},getNotebookMenu:function(){var t=function(t){var e=this;SYNO.SDS.NoteStation.Utils.showNotebookMenu(t,this.findAppWindow(),function(t){if(t.id!==e.menuBtn.currentParent)return e.changeParent.createDelegate(e,[t.id],!0)})};return new SYNO.ux.Menu({cls:"syno-ns-menu",listeners:{beforeshow:t,scope:this}})},changeParent:function(t,e,o){this.menuBtn.setText(t.text),this.setMenuBtnText(this.menuBtn),this.menuBtn.currentParent=o,this.owner.setStatusBusy(),this.owner.saveNote(this.owner.clearStatusBusy,this.owner)},createTBar:function(){var t=[{xtype:"label",text:SYNO.SDS.NoteStation._T("info","modified")+SYNO.SDS.NoteStation._T("common","colon")},{xtype:"tbspacer",width:4},{xtype:"label",text:"",itemId:"mtime"},{xtype:"tbspacer",width:16},{xtype:"label",text:SYNO.SDS.NoteStation._T("info","created")+SYNO.SDS.NoteStation._T("common","colon")},{xtype:"tbspacer",width:4},{xtype:"label",text:"",itemId:"ctime"},{xtype:"tbspacer",width:16},{xtype:"syno_displayfield",cls:"syno-ns-editor-metadata-url",htmlEncode:!1,text:"",itemId:"url"}];return new SYNO.ux.Toolbar({cls:"syno-ns-editor-metadata-tbar",items:t})},setData:function(t){var e=this.findAppWindow().owned,o=this.getTopToolbar(),i=!1;if(!1===e.note.hasOwnProperty(t.object_id)?(this.body.setVisibilityMode(Ext.Element.DISPLAY),this.body.hide()):this.body.show(),!0===this.readonly||(!Ext.isEmpty(t.parent_id)&&t.parent_id in e.notebook?(this.menuBtn.show(),this.menuBtn.setText(e.notebook[t.parent_id].title),this.menuBtn.fireEvent("onSetMenuBtnText",this.menuBtn),this.menuBtn.originalParent=t.parent_id,this.menuBtn.currentParent=t.parent_id,!0===e.notebook[t.parent_id].archive?(i=!0,this.menuBtn.disable()):this.menuBtn.enable()):this.menuBtn.hide()),Ext.isNumber(t.ctime)?o.getComponent("ctime").setText(SYNO.SDS.NoteStation.Utils.dateTimeFormatter(new Date(1e3*t.ctime),{type:"datetimesec"})):o.getComponent("ctime").setText(""),Ext.isNumber(t.mtime)?o.getComponent("mtime").setText(SYNO.SDS.NoteStation.Utils.dateTimeFormatter(new Date(1e3*t.mtime),{type:"datetimesec"})):o.getComponent("mtime").setText(""),Ext.isString(t.source_url)){var n=String.format('<a href="{0}" target="_blank" class="syno-ns-editor-metadata-url">{1}</a>',Ext.util.Format.htmlEncode(t.source_url),Ext.util.Format.htmlEncode(t.source_url));o.getComponent("url").setValue(n),o.getComponent("url").removeClass("syno-ux-displayfield")}else o.getComponent("url").setValue("");!0!==this.readonly&&(this.clearAllTags(),Ext.isArray(t.tag)&&this.loadTags(this.tagSuperBox,t.tag),this.fireEvent("resize"),this.tagSuperBox.setDisabled(i))},getDefaultLat:function(){return this.defaultLat},getDefaultLng:function(){return this.defaultLng},setDefaultLng:function(t){Ext.isNumber(t)&&(this.defaultLng=t)},setDefaultLat:function(t){Ext.isNumber(t)&&(this.defaultLat=t)},isDefaultGPSEmpty:function(){return 0===this.defaultLat&&0===this.defaultLng},loadTags:function(t,e){SYNO.SDS.NoteStation.Utils.loadTags(this.tagSuperBox,e),this.originalTag=Ext.encode(this.getTags())},getTags:function(){return SYNO.SDS.NoteStation.Utils.getTagsArray(this.tagSuperBox)},isTagDirty:function(){return!1!==this.body.isVisible()&&!(!Ext.isObject(this.tagSuperBox)||this.originalTag===Ext.encode(this.getTags()))},isParentIdDirty:function(){return!1!==this.body.isVisible()&&(!Ext.isEmpty(this.menuBtn.currentParent)&&this.menuBtn.originalParent!=this.menuBtn.currentParent)},clearTagDirty:function(){Ext.isObject(this.tagSuperBox)&&(this.originalTag=Ext.encode(this.getTags()))},clearParentIdDirty:function(t){Ext.isObject(this.menuBtn)&&(this.menuBtn.originalParent=this.menuBtn.currentParent)},getParentId:function(){return this.menuBtn.currentParent},clearAllTags:function(){this.createTagItem(),this.originalTag=Ext.encode([]),Ext.isEmpty(this.tagSuperBox.getEl())||(this.tagSuperBox.clearToOrigin(),this.tagSuperBox.getEl().set({placeholder:this.tagSuperBox.emptyText}))},createTagItem:function(){if(!Ext.isObject(this.tagSuperBox)){var t=this.findAppWindow();this.tagSuperBox=new SYNO.SDS.NoteStation.Editor.TagSuperBox({owner:this,listeners:{scope:this,afterrender:function(){this.setMenuBtnText(this.menuBtn,this.getWidth())}}}),this.addTagBtn=new SYNO.ux.Button({colspan:1,cls:"syno-ns-editor-add-tag",iconCls:"syno-ns-editor-add-tag-icon",ctCls:"syno-ns-editor-add-tag-wrap",scope:this,handler:this.openCreateTagDialog}),this.add(this.addTagBtn),this.add(this.tagSuperBox),this.tagSuperBox.on("keypress",function(){this.owner.fireEvent("resetidle")},this),this.tagSuperBox.on("blur",function(){this.isTagDirty()&&this.owner.saveNote()},this),this.doLayout(),t.addPanelScope("SYNO.SDS.NoteStation.Editor.MetaData.Panel",this)}},openCreateTagDialog:function(){this.findAppWindow().mainPanel.openCreateTagDialog(function(t,e){this.tagSuperBox.addItem({tag:e,text:e})},this)},updateParent:function(t){Ext.isObject(t)&&Ext.isString(t.title)&&this.menuBtn.setText(t.title)},updateTag:function(t){Ext.isObject(t)},focusOnTag:function(){this.tagSuperBox.focus()}}),Ext.define("SYNO.SDS.NoteStation.Editor.TagSuperBox",{extend:"SYNO.SDS.NoteStation.SuperBoxSelect",minInputWidth:48,constructor:function(t){this.totalWidth=0,this.emptyWidth=0;var e=Ext.apply({emptyText:SYNO.SDS.NoteStation._T("tag","quick_add"),renderFieldBtns:!1,store:new Ext.data.SimpleStore({autoDestroy:!0,fields:["tag","text"]}),displayField:"text",valueField:"tag",minListWidth:200,maxListWidth:380,colspan:2,enableKeyEvents:!0,navigateItemsWithTab:!1},t);this.callParent([e])},initEvents:function(){this.callParent(arguments),this.mon(this,"removeitem",function(t,e,o){var i=this.getWidthFromRecord(o);this.emptyWidth+=i,this.adjustItems()},this)},onRender:function(){var t=this;this.callParent(arguments),this.menu=new SYNO.SDS.NoteStation.Editor.TagMenu({tagStore:this.store,listeners:{hide:function(){this.moreBtn.getEl().dom.classList.remove("tag-more-btn-active")},tagremove:function(t){this.removeValuesFromStore&&this.usedRecords.containsKey(t.value)&&(this.store.add(this.usedRecords.get(t.value)),this.usedRecords.removeKey(t.value),this.sortStore(),this.view&&this.view.render()),this.adjustItems()},createtag:function(t){this.addItem({tag:t,text:t})},scope:this}}),this.moreBtn=new Ext.Container({cls:"syno-ns-editor-tag-more-btn",renderTo:this.inputEl,data:{},tpl:"<div></div>",overCls:"tag-more-btn-over"}),this.moreBtn.render(),this.moreBtn.getEl().dom.addEventListener("click",function(e){t.moreBtn.getEl().dom.classList.add("tag-more-btn-active"),t.menu.show(t.moreBtn.getEl())})},addRecord:function(t){var e=t.data[this.displayField],o=this.getCaption(t),i=t.data[this.valueField],n=this.classField?t.data[this.classField]:"",s=this.styleField?t.data[this.styleField]:"";this.removeValuesFromStore&&(this.usedRecords.add(i,t),this.store.remove(t));var a=this.getWidthFromRecord(t);a>this.emptyWidth||this.menu.getTagCount()>0?this.menu.addTag({value:i,text:e},!1):(this.addItemBox(i,e,o,n,s),this.emptyWidth-=a),this.fireEvent("additem",this,i,t),this.fireEvent.defer(250,this,["valuechanged",this]),this.checkInputWidth()},getWidthFromRecord:function(t){var e=SYNO.SDS.NoteStation.TextMeasure.getSize(t.get(this.displayField),!0);return Math.ceil(e.width)+2+42},clearToOrigin:function(){this.originalValue="",this.emptyWidth=this.totalWidth,this.reset(),this.checkInputWidth()},killItems:function(){this.menu.removeAllTags(),this.callParent(arguments)},removeAllItems:function(){return this.menu.removeAllTags(),this.callParent(arguments)},getValue:function(){var t=this.callParent(arguments),e=this.menu.getAllTags().map(function(t){return t.value});return t&&e.unshift(t),e.join(this.valueDelimiter)},getValueEx:function(){var t=this;return this.callParent(arguments).concat(this.menu.getAllTags().map(function(e){var o={};return o[t.valueField]=e.value,o[t.displayField]=e.text,o}))},hasValue:function(t){return this.callParent(arguments)||this.menu.hasTag(t)},doResize:function(t){if(!Ext.isDefined(this.listWidth)){var e=Math.max(t,this.minListWidth);e=Math.min(e,this.maxListWidth),this.list.setWidth(e),this.innerList.setWidth(e-this.list.getFrameWidth("lr"))}},setContainerWidth:function(t){var e=t-30;if(e!==this.totalWidth){var o=e-this.totalWidth;this.totalWidth=e,this.emptyWidth+=o,this.adjustItems()}this.onResize(t,void 0,t,void 0)},adjustItems:function(){for(;this.emptyWidth<0;){var t=this.items.removeAt(this.items.length-1),e=this.usedRecords.get(t.value),o=this.getWidthFromRecord(e);this.menu.addTag({value:e.get(this.valueField),text:e.get(this.displayField)},!0),t.kill(),this.emptyWidth+=o}for(;this.menu.getTagCount()>0;){var i=this.menu.getTag(0),n=this.usedRecords.get(i.value),s=this.getWidthFromRecord(n);if(s>this.emptyWidth)break;this.menu.removeTag(0),this.addItemBox(n.get(this.valueField),n.get(this.displayField),this.getCaption(n),"",""),this.emptyWidth-=s}this.checkInputWidth()},setInputVisible:function(t){this.setInputStyle("display",t?"":"none")},setInputStyle:function(t,e){this.getEl().dom.style.setProperty(t,e)},checkInputWidth:function(){if(this.emptyWidth<this.minInputWidth||this.menu.getTagCount()>0)return this.setInputVisible(!1),void this.moreBtn.show();this.setInputVisible(!0),this.moreBtn.hide(),this.setInputStyle("max-width",this.emptyWidth-2-9+"px")}}),Ext.define("SYNO.SDS.NoteStation.Editor.TagMenu",{extend:"SYNO.ux.Menu",maxTagHeight:450,constructor:function(t){var e=Ext.apply({cls:"syno-ns-editor-tag-menu",items:[this.tagContainer=new Ext.Container({cls:"syno-ns-editor-tag-menu-container",items:[]}),this.seperator=new Ext.menu.Separator({}),this.tagCombo=new SYNO.SDS.NoteStation.Editor.TagCombo({store:t.tagStore,displayField:"text",valueField:"tag",editable:!0,hideTrigger:!0,width:150,emptyText:SYNO.SDS.NoteStation._T("tag","add_tag"),listeners:{scope:this,select:function(t,e){this.fireEvent("createtag",e.get(this.tagCombo.valueField)),this._updateContentSize()},specialKey:function(t,e){if(e.getKey()===e.ENTER){var o=this.tagCombo.getRawValue();o&&(this.fireEvent("createtag",o),this._updateContentSize())}}}})]},t);this.callParent([e])},getTagCount:function(){return this.tagContainer.items.length},addTag:function(t,e){var o=new SYNO.SDS.NoteStation.Editor.TagMenuItem({text:t.text,value:t.value,listeners:{scope:this,trigger:this.handleTagRemove}});e?this.tagContainer.insert(0,o):this.tagContainer.add(o)},hasTag:function(t){return this.getAllTags().some(function(e){return e.value===t})},getTag:function(t){return this.tagContainer.get(t)},removeTag:function(t){this.tagContainer.remove(t)},removeAllTags:function(){this.tagContainer.removeAll()},getAllTags:function(){return this.tagContainer.items.items},findTagIndex:function(t){for(var e=this.getAllTags(),o=0;o<e.length;o++)if(e[o]===t)return o;return-1},handleTagRemove:function(t){var e=this.findTagIndex(t);e<0||(this.removeTag(e),this.fireEvent("tagremove",t),this._updateContentSize())},show:function(){this.callParent(arguments),this._updateContentSize()},_updateContentSize:function(){if(this.isVisible()){this.seperator.setVisible(this.getTagCount()>0),this.tagCombo.clearValue(),this.tagCombo.setWidth(150);var t=this.tagContainer.el.dom;if(!t.fleXcroll&&t.offsetHeight>this.maxTagHeight)t.style.setProperty("height",this.maxTagHeight+"px"),t.style.setProperty("width",t.offsetWidth+"px"),this.tagContainer.updateFleXcroll(!0),
this.flexMWrapper=t.querySelector(".mcontentwrapper"),this.flexWrapper=t.querySelector(".contentwrapper"),t.style.removeProperty("width");else if(t.fleXcroll){this.flexMWrapper.style.removeProperty("width"),this.flexWrapper.style.setProperty("padding","1px");var e=Math.max(1,Math.min(this.flexWrapper.offsetHeight-2,this.maxTagHeight));t.style.setProperty("height",e+"px"),this.tagContainer.updateFleXcroll(!0)}this.constrainScroll(),this._updateComboWidth()}},_updateComboWidth:function(){var t=this.getEl(),e=t.getWidth()-t.getBorderWidth("lr")-t.getPadding("lr")-this.tagCombo.wrap.getMargins("lr");this.tagCombo.setWidth(e)}}),Ext.define("SYNO.SDS.NoteStation.Editor.TagMenuItem",{extend:"Ext.BoxComponent",constructor:function(t){var e=Ext.apply({autoEl:"li",cls:"syno-ux-superboxselect-item",overCls:"syno-ux-superboxselect-item-hover",tabIndex:-1,role:"option"},t);this.callParent([e])},onRender:function(){var t=this;this.callParent(arguments);var e=Ext.util.Format.htmlEncode(this.text);this.el.set({"ext:qtip":e}),this.el.update(e),this.btnEl=this.el.createChild({tag:"span",cls:"syno-ux-superboxselect-item-close",tabIndex:-1}),this.btnEl.dom.addEventListener("click",function(e){t.fireEvent("trigger",t)})}}),Ext.define("SYNO.SDS.NoteStation.Editor.TagCombo",{extend:"SYNO.SDS.NoteStation.AnyMatchCombo",initList:function(){this.callParent(arguments),this.view.el.dom.addEventListener("mousedown",function(t){t.stopPropagation()})}}),Ext.define("SYNO.SDS.NoteStation.Info.Map.SearchField",{extend:"SYNO.SDS.Utils.SearchField",constructor:function(t){this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={itemId:"search",listEmptyText:SYNO.SDS.NoteStation._T("search","no_search_result"),tpl:this.getSearchResultTpl(),listAlign:["tl-bl?",[-1,1]],listClass:"sds-search-result syno-ns-info-gmap",listWidth:void 0};return Ext.apply(e,t),e},getSearchResultTpl:function(){return new Ext.XTemplate('<tpl for=".">','<tpl if="this.isSearch(type)">','<div class="x-combo-list-item">','<div class="syno-ns-info-searchresult-name normal-font">{name}</div>','<div class="syno-ns-info-searchresult-address disable-font">{address}</div>',"</div>","</tpl>",'<tpl if="this.isLocal(type)">','<div class="x-combo-list-item x-combo-list-item-local">','<div class="syno-ns-info-searchresult-local normal-font">',"<span > Use [</span>",'<span style="font-weight: bold"> {name:htmlEncode} </span>',"<span > ] </span>","</div>","</div>","</tpl>","</tpl>",{isLocal:function(t){return"local"===t},isSearch:function(t){return"search"===t},compiled:!0})}}),Ext.define("SYNO.SDS.NoteStation.Geolocation",{statics:{getCurrentGPS:function(){if(!navigator.geolocation)return Promise.resolve(null);var t=new Promise(function(t){navigator.geolocation.getCurrentPosition(function(e){t({lat:e.coords.latitude,lng:e.coords.longitude})},function(){t(null)})});return Promise.race([t,new Promise(function(t){setTimeout(function(){t(null)},100)})])}}}),Ext.define("SYNO.SDS.NoteStation.Info.Map.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){this.owner=t.owner;var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e={tbar:this.getMapTbar(),itemId:"gmap_panel",layout:"fit",cls:"syno-ns-info-gmap",listeners:{afterlayout:function(){this.createGmapIframe()},scope:this,single:!0}};return Ext.apply(e,t)},getMapTbar:function(){return this.mapSearch=new SYNO.SDS.NoteStation.Info.Map.SearchField({anchor:"100%",queryParam:"query",store:this.getSearchStore(),itemId:"geoinfo",enableKeyEvents:!0,listeners:{select:{fn:this.onSearchResultSelect.createDelegate(this),scope:this},keydown:{fn:function(t,e){e.ENTER===e.getKey()&&(this.collapse(),this.blur())}}}}),new SYNO.ux.Toolbar({items:this.mapSearch,layout:"anchor"})},createGmapIframe:function(){if(this.createGmapPromise)return this.createGmapPromise;var t=document.createElement("iframe");t.style.width="100%",t.style.height="100%",t.style.border="none",this.body.appendChild(t);var e=["webman/3rdparty/NoteStation/notestation_gmap.js",SYNO.SDS.NoteStation.Utils.getGoogleMapScriptUrl()].map(function(t){return'<script type="text/javascript" src="'+t+'"><\/script>'}).join("\n"),o=t.contentDocument;return o.open(),o.write('<!DOCTYPE html><html><head><meta charset="utf-8">'+e+"</head><body></body></html>"),o.close(),this.createGmapPromise=function(){return"complete"===o.readyState?Promise.resolve():new Promise(function(t){o.addEventListener("readystatechange",function e(){"complete"===o.readyState&&(t(),o.removeEventListener("readystatechange",e))})})}().then(function(){return t.contentWindow})},getGoogleMapMenu:function(){return this.gmapMenu||(this.gmapMenu=new SYNO.ux.Menu({cls:"syno-ns-info-gmap-set-coordinate",items:[{iconCls:"syno-ns-map-coordinate-map-red",text:SYNO.SDS.NoteStation._T("info","set_coordinates"),handler:function(){this.currentGPS=this.gmapWrapper.getRightClickPos(),this.saveDefaultGPSToUsersetting(this.currentGPS),this.onSetMap(this.currentGPS)},scope:this}]})),this.gmapMenu},initGoogleMap:function(t,e){var o=this;return this.createGmapIframe().then(function(i){o.currentGPS=null,0===parseFloat(t)&&0===parseFloat(e)||(o.mapCenter=o.currentGPS=i.createGPS(parseFloat(t),parseFloat(e))),(o.currentGPS?Promise.resolve(o.currentGPS):o.getDefaultGPS()).then(function(t){o.mapCenter=t,o.gmapWrapper=i.createGmapWrapper(),o.gmapWrapper.init({height:o.body.dom.offsetHeight,center:o.mapCenter,ctxHandler:function(t){var e=t[0],i=t[1],n=o.body.dom.getBoundingClientRect();o.getGoogleMapMenu().showAt([e+n.x,i+n.y])}}),o.on("resize",o.onResizeMap),Ext.isEmpty(o.currentGPS)||o.onSetMap(o.currentGPS)})})},onSearchResultSelect:function(t,e,o){var i=this;this.createGmapIframe().then(function(o){t.setValue(String.format("{0}",e.get("name"))),Ext.isEmpty(e.get("gps"))||(i.currentGPS=o.createGPS(e.get("gps").lat,e.get("gps").lng,!0),i.saveDefaultGPSToUsersetting(i.currentGPS),i.onSetMap(i.currentGPS))})},getDefaultGPS:function(t,e){var o=this;return Promise.all([SYNO.SDS.NoteStation.Geolocation.getCurrentGPS(),this.createGmapIframe()]).then(function(t){var e=t[0],i=t[1];return Ext.isEmpty(e)||Ext.isEmpty(e.lat)||Ext.isEmpty(e.lng)?(e=o.findAppWindow().appInstance.getUserSettings("defaultGPS"),Ext.isEmpty(e)||Ext.isEmpty(e.lat)||Ext.isEmpty(e.lng)||0===e.lat||0===e.lng?i.createGPS(25.050433,121.518649):i.createGPS(parseFloat(e.lat),parseFloat(e.lng))):i.createGPS(parseFloat(e.lat),parseFloat(e.lng))})},onSetMap:function(t){this.gmapWrapper.onSetMap(t)},getSearchStore:function(){return Ext.isEmpty(this.searchStore)?(this.searchStore=new SYNO.API.Store({autoDestroy:!0,api:"SYNO.NoteStation.Info",version:1,method:"searchplace",listeners:{scope:this,beforeload:function(t){t.setBaseParam("location",this.gmapWrapper.getCenter().lat()+","+this.gmapWrapper.getCenter().lng()),t.removeAll()},load:function(t,e,o){t.add(new Ext.data.Record({name:t.baseParams.query,address:"",gps:"",placeID:"",type:"local"}))}},appWindow:this,baseParams:{format:!0,radius:500,location:""},reader:new Ext.data.JsonReader({fields:["name","address","gps","placeID","type"]})}),this.searchStore):this.searchStore},removeGPS:function(){var t=this;return this.createGmapIframe().then(function(e){t.currentGPS=e.createGPS(null,null,!0),t.saveDefaultGPSToUsersetting(t.currentGPS),t.gmapWrapper.removeMarker()})},onResizeMap:function(t,e,o){Ext.isEmpty(this.gmapWrapper)||this.gmapWrapper.onResizeMap({width:e,height:o})},onStreetViewPositionChanged:function(){var t=this.gmapWrapper.getStreetView().getPosition();this.gmapWrapper.setCenter(t)},getLocation:function(){return this.mapSearch.getValue()},getLatitude:function(){return Ext.isEmpty(this.currentGPS)?0:this.currentGPS.lat()},getLongitude:function(){return Ext.isEmpty(this.currentGPS)?0:this.currentGPS.lng()},saveDefaultGPSToUsersetting:function(t){this.findAppWindow().appInstance.setUserSettings("defaultGPS",{lat:t.lat(),lng:t.lng()})}}),Ext.define("SYNO.SDS.NoteStation.Info.Map.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.owner=t.owner;var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){this.mapPanel=this.getMapPanel();var e={title:SYNO.SDS.NoteStation._T("info","location"),width:600,height:500,cls:"syno-ns-gmap-win",layout:"fit",items:[this.mapPanel],buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"red",scope:this,text:SYNO.SDS.NoteStation._T("info","delete_gps"),handler:this.onClickDelete},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",scope:this,text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onClickOK}],listeners:{scope:this,single:!0,afterlayout:function(){var t=this;this.mapPanel.initGoogleMap(this.latitude,this.longitude).then(function(){t.original={latitude:t.mapPanel.getLatitude(),longitude:t.mapPanel.getLongitude()}})},beforeShow:function(){this.mapPanel.getTopToolbar().getComponent("geoinfo").setValue(this.location)}}};return Ext.apply(e,t)},getMapPanel:function(){return this.mapPanel=new SYNO.SDS.NoteStation.Info.Map.Panel({owner:this}),this.mapPanel},onClickDelete:function(){var t=this;this.mapPanel.removeGPS().then(function(){t.setStatusOK({text:SYNO.SDS.NoteStation._T("info","delete_gps_message")})})},onClickCancel:function(){this.close()},onClickOK:function(){var t,e=this.findAppWindow(),o=e.getPanelScope("SYNO.SDS.NoteStation.Info.Panel"),i=o.getForm(),n=this.original;if(this.location=this.mapPanel.getLocation(),this.latitude=this.mapPanel.getLatitude(),this.longitude=this.mapPanel.getLongitude(),t=o.getLocationDisplayText(this.location,this.latitude,this.longitude),i.findField("location_display").setValue(t),i.findField("location").setValue(this.location),n.longitude!==this.longitude||n.latitude!==this.latitude){var s;s=i.findField("longitude"),s.originalValue=-1,s.setValue(this.longitude),s=i.findField("latitude"),s.originalValue=-1,s.setValue(this.latitude)}this.close()}}),Ext.define("SYNO.SDS.NoteStation.Editor.Preview.Panel",{extend:"SYNO.SDS.NoteStation.Editor.Base.Panel",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){return this.ddupload=new SYNO.SDS.NoteStation.Editor.Tinymce.DDUpload({readonly:!0,module:this.owner,owner:this}),this.syno_editor=new SYNO.ux.TinyMCE({owner:this,autoEditorResize:!0,mceConfig:{skin_url:"webman/3rdparty/NoteStation/js/TinyMCE/js/tinymce/skins/synostyle",content_css:"webman/3rdparty/NoteStation/js/tinymce_plugins/note_content_patch.css",editorPanel:this,forced_root_block:"div",module:this.owner,owner:this,plugins:["hr","syno_ddupload syno_checkbox syno_attachment_viewer syno_print syno_notefontsizeselect syno_print","syno_reader_style syno_link syno_table syno_chart"],syno_ddupload:{instance:this.ddupload},toolbar:[],statusbar:!1,menubar:!1,readonly:!0,convert_url:!1,mode:"textareas",detect_reader_content:!0,prevent_note_link:!0,indent:!1,extended_valid_elements:["img[class|src|border=0|alt|title|hspace|vspace|width|height|align|onmouseover|onmouseout|name|ref|adjust|syno_ns_diff_tag_result|style]","a[href|target=_blank|file_ref|style]","embed[src|type|width|height|pdf_ref]","table[id|style|title|border|summary|width|frame|rules|cellspacing|cellpadding|align|bgcolor]","div[id|accesskey|class|dir|lang|style|tabindex|title|contenteditable|contextmenu|draggable|dropzone|hidden|spellcheck|translate|xml|align|chart-data|chart-config]","input[id|accesskey|class|dir|lang|style|tabindex|title|accept|alt|autocomplete|checked|dirname|disabled|form|formaction|formenctype|formmethod|formnovalidate|formtarget|height|list|max|maxlength|min|multiple|name|pattern|readonly|required|size|src|step|type|value|width|syno_ns_diff_tag_result]"].join(",")},listeners:{initialize:function(t,e){var o,i=this;o=Ext.get(e.getContainer()),e.on("BeforeSetContent",function(){0!==i.getHeight()&&t.fireEvent("resize",t,i.getWidth(),i.getHeight(),i.getWidth(),i.getHeight())}),(Ext.isIE||Ext.isIE11)&&e.on("SetContent",function(){var t=SYNO.SDS.NoteStation.Editor.Tinymce.Link.Youtube;Ext.iterate(e.dom.select("iframe"),function(e,o){t&&t.matchUrl(e.src)&&(e.src=Ext.urlAppend(e.src,"wmode=transparent",!1))})}),Ext.isObject(o)&&o.setStyle("border-width","0px"),Ext.isElement(e.getContentAreaContainer())&&(o=Ext.get(e.getContentAreaContainer()),o.setStyle("border-width","0px")),Ext.fly(e.getDoc()).on("mousedown",function(){var t=i.findAppWindow();Ext.isObject(t)&&!t.isDestroyed&&Ext.isObject(t.manager)&&Ext.isFunction(t.manager.getActiveAppWindow)&&t.manager.getActiveAppWindow()!==t&&t.toFront()})},scope:this}}),Ext.apply({layout:"fit",items:[this.syno_editor]},t)},getEditor:function(){return this.syno_editor.editor},setData:function(t){if(this.applySetting(),t.encrypt){var e=this.findAppWindow(),o=CryptoJS.AES.decrypt(t.content,e.getEncryptPassword(t.object_id).password).toString(CryptoJS.enc.Utf8);this.setContent(o.substring(SYNO.SDS.NoteStation.Define.MAGIC.length))}else this.setContent(t.content);this.setAttachment(t.attachment),this.fireEvent("loadnotedone",this)},setContent:function(t){var e=this.getEditor();Ext.isEmpty(e)||Ext.isString(t)&&(e.setContent(t),e.isNotDirty=!0)},getContent:function(){var t=this.getEditor();if(!Ext.isEmpty(t))return t.getContent()},isDirty:function(){var t=this.getEditor();if(!Ext.isEmpty(t))return t.isDirty()},clearDirty:function(t){var e=this.getEditor();!Ext.isEmpty(e)&&t.hasOwnProperty("content")&&e.getContent()===t.content&&(e.isNotDirty=!0)},getBrief:function(){var t=this.getEditor();if(!Ext.isEmpty(t))return t.getContent({format:"text"}).substr(0,80)},getData:function(){return{content:this.getContent(),brief:this.getBrief()}},setAttachment:function(t){this.ddupload.setFiles(t)}}),Ext.define("SYNO.SDS.NoteStation.Info.History.Preview.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e]),this.loadNote()},fillConfig:function(t){var e=t.historyList,o=t.historyListIndex,i=t.historyList[t.historyListIndex],n=this.composeTitle(i.mtime,i.username),s={owner:t.owner,module:t.module,cls:"syno-ns-info-history-preview-win",width:700,height:520,historyList:e,historyListIndex:o,title:n,layout:"fit",tbar:this.getTBar(t),items:[this.getPreviewPanel()],buttons:[{disabled:_S("demo_mode"),xtype:"syno_button",text:SYNO.SDS.NoteStation._T("history","restore"),scope:this,handler:this.onClickRestore},{disabled:_S("demo_mode"),xtype:"syno_button",text:SYNO.SDS.NoteStation._T("history","copy_to_new_note"),scope:this,handler:this.onClickCopyTo},{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","close"),scope:this,handler:this.onClickClose}]};return Ext.apply(s,t)},getTBar:function(t){var e=t.historyList,o=t.historyListIndex,i=[{xtype:"syno_textfield",cls:"syno-ns-info-history-preview-title",text:"Title",readOnly:!0,listeners:{scope:this,single:!0,render:function(t){this.noteTitleLabel=t}}},"->",{xtype:"syno_button",iconCls:"syno-ns-info-history-preview-previous-icon",handler:this.onClickPrevNext.createDelegate(this,["prev"]),hideMode:"visibility",hidden:0===t.historyListIndex,listeners:{scope:this,render:function(t){this.prevBtn=t}}},{xtype:"syno_button",itemId:"date_btn",cls:"syno-ns-info-history-preview-split-btn",menu:this.dateMenu=new Ext.menu.Menu({items:this.getMenuItemList(e),listeners:{scope:this,single:!0,render:function(t){t.items.each(function(t){t.setHandler(this.onClickMenu.createDelegate(this,[t]))},this)}}}),text:e[o].mtime,listeners:{scope:this,single:!0,render:function(t){this.dateSplitBtn=t,this.dateMenu.items.each(function(t){t.setHandler(this.onClickMenu.createDelegate(this,[t.text]))},this)}}},{xtype:"syno_button",iconCls:"syno-ns-info-history-preview-next-icon",handler:this.onClickPrevNext.createDelegate(this,["next"]),hideMode:"visibility",hidden:t.historyListIndex===t.historyList.length-1,listeners:{scope:this,render:function(t){this.nextBtn=t}}}];return new SYNO.ux.Toolbar({cls:"syno-ns-info-history-preview-toolbar",items:i})},getMenuItemList:function(t){var e=[];return Ext.each(t,function(t){var o={};o.text=t.mtime,o.idx=t.id,o.username=t.username,e.push(o)}),e},getPreviewEditor:function(){return this.historyPreviewEditor=new SYNO.SDS.NoteStation.Editor.Preview.Panel({layout:"fit",anchor:"100% 100%",owner:this}),this.historyPreviewEditor},getPreviewPanel:function(){return this.historyPreviewPanel=new SYNO.ux.Panel({layout:"fit",items:[this.getPreviewEditor()],owner:this}),this.historyPreviewPanel},composeTitle:function(t,e){return String.format("{0} - {1}",t,e)},setWinTitle:function(t,e){this.setTitle(this.composeTitle(t,e))},setNoteTitle:function(t){this.noteTitleLabel.setValue(t)},onClickClose:function(){this.hide()},onClickPrevNext:function(t){"next"===t&&this.historyList.length-1>this.historyListIndex?this.switchVersion(this.historyListIndex+1):"prev"===t&&0!==this.historyListIndex&&this.switchVersion(this.historyListIndex-1)},onClickMenu:function(t){this.switchVersion(t.idx-1)},loadNote:function(){this.setStatusBusy(),this.noteData=null,this.notePerm=Ext.apply({},this.infoWin.notePerm),this.owner.findAppWindow().getStorage().getNote(Ext.copyTo({object_id:this.object_id,ver:this.historyList[this.historyListIndex].version,callback:this.onLoadNote,scope:this},this.notePerm,"perm_from,smart_id"))},onLoadNote:function(t,e){if(!t||Ext.isEmpty(this.historyPreviewEditor))return void this.clearStatusBusy();this.noteData=e,this.historyPreviewEditor.setData(e),this.setNoteTitle(e.title),this.clearStatusBusy(),this.onResize(this.getWidth()+1,this.getHeight()+1)},onClickCopyTo:function(){this.setStatusBusy();var t=this.owner.findAppWindow(),e=t.getMainPanel();if(SYNO.SDS.NoteStation.Utils.isJoinednote(t,this.noteData.object_id)){new SYNO.SDS.NoteStation.CopyTo.Window({owner:t,param:Ext.copyTo({title:this.noteData.title+" - "+this.historyList[this.historyListIndex].mtime,object_id:this.noteData.object_id,ver:this.noteData.ver},this.infoWin.notePerm,"perm_from,smart_id"),okCallback:{cb:function(){this.clearStatusBusy(),this.closeWin()},scope:this},cancleCallback:{cb:function(){this.clearStatusBusy()},scope:this}}).show()}else e.copyNote({object_id:this.noteData.object_id,title:this.noteData.title+" - "+this.historyList[this.historyListIndex].mtime,parent_id:this.noteData.parent_id,ver:this.noteData.ver},function(){this.clearStatusBusy(),this.closeWin()},this)},onClickRestore:function(){this.setStatusBusy();var t=this.owner.findAppWindow().getMainPanel(),e=this.noteData;t.restoreNoteVersion(e,function(t,e){!0!==t&&SYNO.SDS.NoteStation.Utils.showErrorMsg(this.owner.findAppWindow(),e),this.clearStatusBusy(),this.closeWin()},this)},switchVersion:function(t){var e,o;this.historyListIndex=t,e=this.historyList[this.historyListIndex].mtime,o=this.historyList[this.historyListIndex].username,this.dateSplitBtn.setText(e),this.setWinTitle(e,o),0===this.historyListIndex?this.prevBtn.hide():this.prevBtn.show(),this.historyListIndex===this.historyList.length-1?this.nextBtn.hide():this.nextBtn.show(),this.loadNote()},closeWin:function(){!0===this.closeParent&&this.infoWin?this.infoWin.close():this.owner.close()}}),Ext.define("SYNO.SDS.NoteStation.Info.History.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",itemsPerPage:100,constructor:function(t){this.owner=t.owner,this.noteId=this.owner.noteData.object_id,this.current_version=this.owner.noteData.ver,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={owner:t.owner,module:t.module,cls:"syno-ns-info-history-win",title:SYNO.SDS.NoteStation._T("info","view_history"),width:600,height:480,layout:"fit",items:this.getHistoryGridPanel(t),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","close"),scope:this,handler:this.onClickCancel}]};return Ext.apply(e,t)},getHistoryGridPanel:function(t){var e=new Ext.grid.ColumnModel({columns:[{header:SYNO.SDS.NoteStation._T("history","modify_time"),hideable:!1,dataIndex:"mtime",renderer:function(t,e,o,i,n,s){return'<font class="syno-ns-info-mtime">'+SYNO.SDS.NoteStation.Utils.dateTimeFormatter(new Date(1e3*t),{type:"datetimesec"})+"</font>"}},{header:SYNO.SDS.NoteStation._T("common","username"),dataIndex:"author"},{header:SYNO.SDS.NoteStation._T("history","device_name"),dataIndex:"commit_msg",renderer:function(t,e,o,i,n,s){return Ext.util.Format.htmlEncode(t.device)}}]}),o=new Ext.grid.RowSelectionModel({singleSelect:!0,listeners:{rowselect:function(e,o){var i=[];this.historyGridPanel.getStore().each(function(t){var e=SYNO.SDS.NoteStation.Utils.dateTimeFormatter(new Date(1e3*t.get("mtime")),{type:"datetimesec"}),o={id:t.get("id"),author:t.get("author"),version:t.get("version"),mtime:e,commit_msg:t.get("commit_msg"),last_version:t.get("last_version"),username:t.get("author"),devicename:t.get("commit_msg").device,title:t.get("id")};i.push(o)});var n={owner:this,infoWin:this.owner,object_id:this.noteId,current_version:this.current_version,historyList:i,historyListIndex:o,closeParent:t.closeParent};e.clearSelections(),this.showHistoryPreviewWin(n)},scope:this}}),i=new SYNO.API.Store({autoDestroy:!0,autoLoad:!0,api:"SYNO.NoteStation.Note.Version",method:"list",version:2,appWindow:this,baseParams:Ext.copyTo({object_id:this.noteId,limit:this.itemsPerPage,filter:{listable:!0}},this.owner.notePerm,"perm_from,smart_id"),reader:new Ext.data.JsonReader({root:"versions",totalProperty:"total",idProperty:"id"},["id","author","version","mtime","commit_msg","last_version"]),listeners:{load:function(t,e,o){t.filterBy(function(t){return!0===t.data.commit_msg.listable},this)},scope:this}});return this.paging=new SYNO.ux.PagingToolbar({store:i,displayInfo:!0,pageSize:this.itemsPerPage,refreshText:SYNO.SDS.NoteStation._T("common","refresh")}),this.historyGridPanel=new SYNO.ux.GridPanel({colModel:e,selModel:o,store:i,bbar:this.paging}),this.historyGridPanel},onClickCancel:function(){this.hide()},showHistoryPreviewWin:function(t){var e={owner:this};Ext.isEmpty(this.historyPreviewWin)||this.historyPreviewWin.destroy(),this.historyPreviewWin=new SYNO.SDS.NoteStation.Info.History.Preview.Window(Ext.apply(e,t)),this.historyPreviewWin.show()},onBeforeDestroy:function(){this.historyPreviewWin&&this.historyPreviewWin.close(),this.callParent(arguments)}}),Ext.define("SYNO.SDS.NoteStation.Info.Panel",{extend:"SYNO.SDS.NoteStation.Operate.FormPanel",constructor:function(t){this.owner=t.owner,this.module=t.module,this.findAppWindow().addPanelScope("SYNO.SDS.NoteStation.Info.Panel",this);var e=this.fillConfig(t);this.callParent([e]),this.notebookStore.loadData(this.getNotebookData())},fillConfig:function(t){var e=this.findAppWindow(),o=SYNO.SDS.NoteStation.Utils,i=o.getCurrentNoteData(),n=!0,s=!1;this.isJoinednote=SYNO.SDS.NoteStation.Utils.isJoinednote(e,i.object_id),this.isJoinednote&&(n=i.parent_id in e.joined.notebook),!0===i.archive&&(s=!0),this.locationStore=new Ext.data.SimpleStore({autoDestroy:!0,fields:["latitude","longitude"]}),this.tagStore=new Ext.data.SimpleStore({autoDestroy:!0,fields:["text","tag"]}),this.tagSuperBox=new SYNO.ux.SuperBoxSelect({mode:"local",allowAddNewData:!0,addNewDataOnBlur:!0,renderFieldBtns:!1,triggerAction:"all",minChars:1,fieldLabel:SYNO.SDS.NoteStation._T("category","tag"),displayField:"text",valueField:"tag",name:"tag",store:this.tagStore,width:400,hidden:!0,listeners:{scope:this,newitem:this.onAddNewitem}}),this.notebookStore=new Ext.data.JsonStore({autoDestroy:!0,fields:["notebook_title","notebook_id"]}),this.notebookComboBox=new SYNO.ux.ComboBox({xtype:"syno_combobox",listClass:"syno-ux-combobox-list syno-ns-combobox-list",fieldLabel:SYNO.SDS.NoteStation._T("info","notebook"),store:this.notebookStore,displayField:"notebook_title",valueField:"notebook_id",name:"parent_id",mode:"local",readOnly:this.isJoinednote,hidden:!n,disabled:s,scope:this});var a={fieldWidth:400,labelWidth:150,autoHeight:!0,items:[{xtype:"syno_textfield",cls:"syno-ns-info-title-textfield",fieldLabel:SYNO.SDS.NoteStation._T("info","title"),maxlength:SYNO.SDS.NoteStation.Define.TITLE_MAX_LENGTH,name:"title",validator:function(t){return!Ext.isEmpty(t.trim())||this.blankText},allowBlank:!1},this.notebookComboBox,this.tagSuperBox,{xtype:"syno_datetimefield",fieldLabel:SYNO.SDS.NoteStation._T("info","created"),isAllDay:!1,name:"ctime"},{xtype:"syno_displayfield",fieldLabel:SYNO.SDS.NoteStation._T("info","modified"),name:"mtime"},{xtype:"syno_combobox",itemCls:"syno-ns-info-location-combobox",fieldLabel:SYNO.SDS.NoteStation._T("info","location"),name:"location_display",store:this.locationStore,listeners:{scope:this,afterrender:function(t){t.getEl().on("click",this.showGoogleMap.createDelegate(this)),t.trigger.on("click",this.showGoogleMap.createDelegate(this))}}},{xtype:"syno_textfield",fieldLabel:SYNO.SDS.NoteStation._T("info","source_url"),name:"source_url"},{xtype:"syno_displayfield",fieldLabel:SYNO.SDS.NoteStation._T("info","history"),value:'<a id="'+Ext.id()+'" class="link-font" href="#">'+SYNO.SDS.NoteStation._T("info","view_history")+"</a>",htmlEncode:!1,listeners:{scope:this,single:!0,buffer:80,render:function(t){var e=t.el.first("a");e&&this.mon(e,"click",function(t){this.showHistoryGridWin(),t.preventDefault()},this)}}},{xtype:"syno_displayfield",name:"location",hidden:!0},{xtype:"syno_displayfield",name:"latitude",hidden:!0},{xtype:"syno_displayfield",name:"longitude",hidden:!0}]};return Ext.apply(a,t)},onAddNewitem:function(t,e,o){var i={};e=e.trim(),Ext.isEmpty(e)||(i[t.displayField]=Ext.util.Format.htmlEncode(e),i[t.valueField]=e,t.addItem(i,!0))},showHistoryGridWin:function(){this.historyGridWin=new SYNO.SDS.NoteStation.Info.History.Window({owner:this.owner,module:this,closeParent:!0}),this.historyGridWin.show()},showGoogleMap:function(){var t=this.getForm();this.GoogleMapWindow=new SYNO.SDS.NoteStation.Info.Map.Window({owner:this.owner,module:this,latitude:t.findField("latitude").getValue(),longitude:t.findField("longitude").getValue(),location:t.findField("location").getValue()}),this.GoogleMapWindow.show()},updateForm:function(t){var e={},o=this.getForm(),i=["tag"],n=this.findAppWindow(),s=this.isJoinednote?n.joined.notebook:n.owned.notebook;Ext.apply(e,t),SYNO.SDS.NoteStation.Utils.loadTags(this.tagSuperBox,Ext.isEmpty(t.tag)?[]:t.tag),Ext.isNumber(t.ctime)&&(e.ctime=new Date(1e3*t.ctime)),Ext.isNumber(t.mtime)&&(e.mtime=SYNO.SDS.NoteStation.Utils.dateTimeFormatter(new Date(1e3*t.mtime),{type:"datetimesec"})),t.parent_id in s?e.parent_id=s[t.parent_id].title:e.parent_id="",this.gmapLocation=t.location,this.gmapLongitude=t.longitude,this.gmapLatitude=t.latitude,Ext.iterate(e,function(t,n){var s=o.findField(t);-1===i.indexOf(t)&&(Ext.isEmpty(s)||(s.setValue(e[t]),s.originalValue=s.getValue()))})},getLocationDisplayText:function(t,e,o){var i,n="";return""!==t&&0!==o&&0!==e?(i="{0} ({1},{2})",n=String.format(i,t,Ext.util.Format.number(e,"0.00"),Ext.util.Format.number(o,"0.00"))):""===t&&0!==o&&0!==e?(i="({0},{1})",n=String.format(i,Ext.util.Format.number(e,"0.00"),Ext.util.Format.number(o,"0.00"))):(i="{0}",n=String.format(i,t)),n},getNotebookData:function(){var t=SYNO.SDS.NoteStation.Window,e=[],o=this.isJoinednote?t.joined.notebook:t.owned.notebook;if(!Ext.isEmpty(t))return Ext.iterate(o,function(t,o){(this.isJoinednote||!1!==o.owned)&&!0!==o.archive&&e.push({notebook_title:o.title,notebook_id:o.id,handler:this.selectNotebook.createDelegate(this,[o.title,o.id]),scope:this})},this),e},selectNotebook:function(t,e){this.notebookComboBox.setValue(t)}}),Ext.define("SYNO.SDS.NoteStation.Info.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.owner=t.owner,this.noteData=t.noteData,this.notePerm=t.notePerm,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("window","note_information"),width:640,autoHeight:!0,layout:"fit",cls:"syno-ns-info-win",items:this.getInfoFormPanel(),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onClickOk,scope:this}],listeners:{single:!0,beforeshow:function(){var t=SYNO.SDS.NoteStation.Utils,e=this.findAppWindow(),o=this.getInfoFormPanel(),i=e.getPanelScope("SYNO.SDS.NoteStation.Editor.MetaData.Panel"),n=e.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel"),s=i.tagSuperBox,a=n.getTitle();this.noteData.tag=t.getTagsArray(s),this.noteData.title=a,this.noteData.location_display=o.getLocationDisplayText(this.noteData.location,this.noteData.latitude,this.noteData.longitude),this.noteId=this.noteData.object_id,o.updateForm(this.noteData)},scope:this}};return Ext.apply(e,t)},getInfoFormPanel:function(){return Ext.isEmpty(this.infoFormPanel)&&(this.infoFormPanel=new SYNO.SDS.NoteStation.Info.Panel({owner:this,module:this})),this.infoFormPanel},onClickCancel:function(){this.infoFormPanel.getForm().reset(),this.close()},onClickOk:function(){var t=this.infoFormPanel.getForm(),e=t.findField("title");e.setValue(e.getValue().trim()),t.isValid()&&this.close()},onBeforeDestroy:function(){var t=this.findAppWindow(),e=t.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel");this.infoFormPanel.getForm().isDirty()&&e.saveNote(t.selectNote.createDelegate(t,[this.noteId])),this.getInfoFormPanel().historyGridWin&&this.getInfoFormPanel().historyGridWin.close(),this.getInfoFormPanel().GoogleMapWindow&&this.getInfoFormPanel().GoogleMapWindow.close(),this.callParent(arguments)}}),Ext.define("SYNO.SDS.NoteStation.Share.FormPanel",{extend:"SYNO.ux.FormPanel",shareType:"note",allow_share:!1,constructor:function(t){this.owner=t.owner,this.objectData=t.objectData,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={cls:"syno-ns-share-formpanel",items:this.getItemCfg(),objectAcl:{},listeners:{single:!0,scope:this,afterlayout:function(){this.enableChanged(null,!1),this.fillObjectPerm(),this.getShardLinkFromWebAPI()}}};return Ext.apply(e,t)},getShardLinkFromWebAPI:function(){this.owner.setStatusBusy(),this.findAppWindow().getStorage().getShardLink({object_id:this.objectData.object_id,mode:"public",callback:this.onGetShardLink,scope:this})},onGetShardLink:function(t,e){this.owner.clearStatusBusy(),!0===t&&this.shareLink.textField.setValue(e.url)},enableChanged:function(t,e){var o={};e?(this.shareLink.enable(),o={public:{op:"set",perm:"ro"}}):(this.shareLink.disable(),o={public:{op:"delete"}}),Ext.isEmpty(t)||!0===this.skipPublicCheckBox||(this.owner.setStatusBusy(),o.object_id=this.objectData.object_id,o.callback=function(t,e){t||this.owner.onPermissionFail(t,e),this.owner.clearStatusBusy()},o.scope=this,this.findAppWindow().getStorage().setPermission(o))},showNeedMsg:function(){!0!==this.allow_share&&0===this.getShareStore().getTotalCount()&&this.findBy(function(t){"sharegrid"===t.itemId&&t.el.mask(SYNO.SDS.NoteStation._T("setting","share_need_admin"))},this)},fillObjectPerm:function(){var t,e=[];if(this.objectAcl={public:!1,dsm_user:{},dsm_group:{}},this.uid_map={},this.gid_map={},!Ext.isEmpty(this.objectData)&&Ext.isObject(this.objectData.acl)&&!1!==this.objectData.acl.enabled){if("public"in this.objectData.acl){switch(t=this.find("itemId","public_share_checkbox")[0],this.skipPublicCheckBox=!0,this.objectData.acl.public.perm){case"rw":case"ro":this.objectAcl.public=!0,t.setValue(!0);break;default:this.objectAcl.public=!1,t.setValue(!1)}this.skipPublicCheckBox=null}"dsm_user"in this.objectData.acl&&(this.objectAcl.dsm_user={},Ext.iterate(this.objectData.acl.dsm_user,function(t,o){this.objectAcl.dsm_user[o.name]=o.perm,e.push({name:o.name,type:"user",perm:o.perm}),this.uid_map[o.name]=parseInt(t,10)},this),this.getShareStore().loadData(e)),"dsm_group"in this.objectData.acl&&(this.objectAcl.dsm_group={},Ext.iterate(this.objectData.acl.dsm_group,function(t,o){this.objectAcl.dsm_group[o.name]=o.perm,e.push({name:o.name,type:"group",perm:o.perm}),this.gid_map[o.name]=parseInt(t,10)},this),this.getShareStore().loadData(e)),this.showNeedMsg()}},getItemCfg:function(){
var t=this.findAppWindow();return this.sharePrivStore=new SYNO.API.Store({api:"SYNO.NoteStation.Share.Priv",version:2,method:"list",appWindow:this,autoLoad:!1,autoDestroy:!0,baseParams:{query:""},reader:new Ext.data.JsonReader({root:"list",fields:["name","type",{name:"cls",convert:function(t,e){return"group"===e.type?"syno-ns-combo-share-group":"syno-ns-combo-share-user"}}]}),listeners:{load:function(t,e,o){var i;-1!==(i=t.findExact("name",this._S("user")))&&t.removeAt(i)},scope:this}}),this.allow_share=t.settings.allow_share,[{xtype:"syno_fieldset",itemId:"public_share_fieldset",collapsible:!1,title:SYNO.SDS.NoteStation._T("share","public_share"),items:[{disabled:_S("demo_mode"),xtype:"syno_checkbox",itemId:"public_share_checkbox",boxLabel:SYNO.SDS.NoteStation._T("share","enable_public"),listeners:{scope:this,check:this.enableChanged}},this.shareLink=new SYNO.SDS.Utils.ClipBoardComposite({disableWhenEmpty:!1,textFieldCfg:{cls:"syno-ns-share-publicshare-text",width:300,readOnly:!0,selectOnFocus:!0,fieldLabel:SYNO.SDS.NoteStation._T("share","public_share_link")},btnCfg:{width:32,cls:"syno-ns-copy-btn",iconCls:"syno-ns-copy-btn-icon",tooltip:SYNO.SDS.NoteStation._T("common","copy")},listeners:{clipsucceed:function(t){this.owner.setStatusOK({text:SYNO.SDS.NoteStation._T("share","copy_url_done")})},clipfailed:function(t){this.owner.setStatusError({text:SYNO.SDS.NoteStation._T("error","copy_share_link")})},scope:this}})]},{xtype:"syno_fieldset",collapsible:!1,itemId:"sharefieldset",title:SYNO.SDS.NoteStation._T("share","share_to_dsm_user_or_group"),autoHeight:!0,items:[{xtype:"syno_compositefield",hideLabel:!0,hidden:!this.allow_share,items:[{xtype:"syno_combobox",emptyText:SYNO.SDS.NoteStation._T("common","user_or_group"),editable:!0,hideTrigger:!0,flex:1,store:this.sharePrivStore,minChars:1,valueField:"name",displayField:"name",queryParam:"query",mode:"remote",cls:"syno-ns-combo-share-chooser",validator:function(t){return-1!==this.getStore().findExact("name",t)},listeners:{select:function(t,e,o){this.share_name.select_data=e.data,"user"===e.data.type?(t.el.removeClass("syno-ns-combo-share-choose-group"),t.el.addClass("syno-ns-combo-share-choose-user")):(t.el.removeClass("syno-ns-combo-share-choose-user"),t.el.addClass("syno-ns-combo-share-choose-group"))},afterrender:function(t){this.share_name=t},scope:this}},{xtype:"syno_combobox",store:new Ext.data.JsonStore({autoDestroy:!0,fields:["perm","display"],data:[{perm:"ro",display:SYNO.SDS.NoteStation._T("perm","ro")},{perm:"rw",display:SYNO.SDS.NoteStation._T("perm","rw")}]}),displayField:"display",valueField:"perm",width:180,listeners:{afterrender:function(t){this.share_priv=t,t.setValue("ro")},scope:this}},{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","add"),listeners:{click:function(){var t,e,o,i,n,s=this.getShareStore();if(!Ext.isEmpty(this.share_name)&&!Ext.isEmpty(this.share_priv)){var a=!this.share_name.select_data||this.share_name.select_data.name!==this.share_name.getValue();t=a?this.share_name.getValue():this.share_name.select_data.name,-1!==(i=this.share_name.getStore().findExact("name",t))&&(a?(n=this.share_name.getStore().getAt(i),o=n.data.type):o=this.share_name.select_data.type,e=this.share_priv.getValue(),-1===s.findBy(function(e,i){if(e.data.name===t&&e.data.type===o)return!0},this)&&(s.insert(0,new Ext.data.Record({name:t,type:o,perm:e})),this.share_name.clearValue(),this.share_name.el.removeClass("syno-ns-combo-share-choose-group"),this.share_name.el.removeClass("syno-ns-combo-share-choose-user")))}},scope:this}}]},{xtype:"syno_editorgrid",height:150,itemId:"sharegrid",cls:"syno-ns-share-gridpanel",clicksToEdit:1,listeners:{viewready:function(t){t.getView().updateScroller()}},colModel:new Ext.grid.ColumnModel({defaults:{menuDisabled:!0},columns:[{id:"name",dataIndex:"name",width:180,renderer:this.nameRenderer.createDelegate(this),align:"left"},{dataIndex:"perm",width:180,renderer:this.permRenderer.createDelegate(this),align:"left"},{xtype:"actioncolumn",css:"syno-ns-actioncolumn",items:[{iconCls:"syno-ns-share-delete-icon",handler:function(t,e,o){t.getStore().removeAt(e)}}],align:"right"}]}),store:this.getShareStore()}]}]},getShareStore:function(){return this.shareStore||(this.shareStore=new Ext.data.JsonStore({fields:["name","perm","type"],sortInfo:{field:"type",direction:"ASC"}})),this.shareStore},getShareLink:function(){return this.shareLink.textField.getValue()},nameRenderer:function(t,e,o){var i;return i="group"===o.data.type?"syno-ns-share-group":"syno-ns-share-user",String.format('<img class="{0}" align="absmiddle" src="{1}"/>{2}',i,"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",Ext.util.Format.htmlEncode(t))},permRenderer:function(t,e,o){var i=Ext.id();return Ext.defer(this.createStatusButton,25,this,[t,i,o]),'<div id="'+i+'"></div>'},changePermStatus:function(t,e,o){t.setText(e.text),o.data.perm=e.value},createStatusButton:function(t,e,o){var i,n;Ext.isEmpty(Ext.get(e))||(n={text:SYNO.SDS.NoteStation._T("perm",t),renderTo:e,cls:"syno-ns-share-status-btn"},!1===this.allow_share?n.disabled=!0:n.menu=new SYNO.ux.Menu({items:[{text:SYNO.SDS.NoteStation._T("perm","rw"),value:"rw",handler:function(t,e){this.changePermStatus(i,t,o)},scope:this},{text:SYNO.SDS.NoteStation._T("perm","ro"),value:"ro",handler:function(t,e){this.changePermStatus(i,t,o)},scope:this}]}),i=new SYNO.ux.Button(n))},isPublicAclDirty:function(){return this.find("itemId","public_share_checkbox")[0].getValue()!==this.objectAcl.public},getRestorePublicAcl:function(){if(this.isPublicAclDirty())return!0===this.objectAcl.public?{op:"set",perm:"ro"}:{op:"delete"}},calculateAcl:function(t,e,o){var i={},n=!1;return Ext.iterate(t,function(t,o){if(e.hasOwnProperty(t)){if(e[t]===o)return void delete e[t];i[t]={op:"set",perm:o},delete e[t],n=!0}else i[t]={op:"set",perm:o},n=!0},this),Ext.iterate(e,function(t,e){i[t]=o?{op:"delete",gid:this.gid_map[t]}:{op:"delete",uid:this.uid_map[t]},n=!0},this),!0===n&&i},getModifiedAcl:function(){var t,e,o={},i={},n={};if(this.getShareStore().each(function(t,e,o){"group"===t.data.type?n[t.data.name]=t.data.perm:i[t.data.name]=t.data.perm},this),t=this.calculateAcl(i,this.objectAcl.dsm_user),e=this.calculateAcl(n,this.objectAcl.dsm_group,!0),Ext.isObject(t)||Ext.isObject(e))return t&&(o.dsm_user=t),e&&(o.dsm_group=e),o}}),Ext.define("SYNO.SDS.NoteStation.Share.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){this.owner=t.owner;var e={title:SYNO.SDS.NoteStation._T("common","share"),width:600,autoHeight:!0,layout:"fit",items:this.getShareFormPanel(t),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onClickOk,scope:this}],listeners:{beforeshow:function(){this.shareFormPanel.shareLink.textField.setValue(SYNO.SDS.NoteStation.Utils.getPublicShareLink(this.objectData.link_id))},single:!0,scope:this}};return Ext.apply(e,t)},getShareFormPanel:function(t){return this.shareFormPanel=new SYNO.SDS.NoteStation.Share.FormPanel({owner:this,autoHeight:!0,objectData:t.objectData,shareType:t.shareType}),this.shareFormPanel},onClickCancel:function(){var t={};return Ext.isEmpty(this.shareFormPanel)?void this.close():(t.public=this.shareFormPanel.getRestorePublicAcl(),Ext.isEmpty(t.public)?void this.close():(this.setStatusBusy(),t.object_id=this.objectData.object_id,t.callback=function(t,e){this.clearStatusBusy(),!0===t?this.close():this.updatePermission()},t.scope=this,this.findAppWindow().getStorage().setPermission(t),void this.close()))},onClickOk:function(){var t;return Ext.isEmpty(this.shareFormPanel)?void this.close():(t=this.shareFormPanel.getModifiedAcl(),Ext.isEmpty(t)?void(this.shareFormPanel.isPublicAclDirty()?this.updatePermission():this.close()):(this.setStatusBusy(),t.object_id=this.objectData.object_id,t.callback=function(t,e){!0!==t?this.onPermissionFail(t,e):this.updatePermission()},t.scope=this,void this.findAppWindow().getStorage().setPermission(t)))},onPermissionFail:function(t,e){var o,i=this.getMsgBox(),n=!1,s=SYNO.SDS.NoteStation.Utils.getErrorStr(e);if(!Ext.isEmpty(i)){for(o in e.dsm_group)if(!e.dsm_group[o].success){n=!0,s=SYNO.SDS.NoteStation.Utils.getErrorStr(e.dsm_group[o].error);break}if(!n)for(o in e.dsm_user)if(!e.dsm_user[o].success){n=!0,s=SYNO.SDS.NoteStation.Utils.getErrorStr(e.dsm_user[o].error);break}n||e.public&&!e.public.success&&(s=SYNO.SDS.NoteStation.Utils.getErrorStr(e.public.error)),i.alert("",s,function(){this.updatePermission()},this)}},updatePermission:function(){var t=this.findAppWindow(),e=function(e,o){!0===e&&(Ext.isObject(this.onObjectChanged)&&Ext.isFunction(this.onObjectChanged.callback)&&this.onObjectChanged.callback.call(this.onObjectChanged.scope||window,e,o),t.getMainPanel().syncNow(),this.close())};"note"===this.objectData.category?t.getStorage().getNote({object_id:this.objectData.object_id,callback:e,scope:this}):"notebook"===this.objectData.category?t.getStorage().getNotebook({object_id:this.objectData.object_id,callback:e,scope:this}):this.close()}}),Ext.define("SYNO.SDS.NoteStation.Editor.Normal.Panel",{extend:"SYNO.SDS.NoteStation.Editor.Base.Panel",idleTimeout:15e3,idleId:null,autoSaveTimeout:6e5,autoSaveId:null,idleSession:null,noteSaving:!1,constructor:function(t){var e,o;this.owner=t.owner,this.findAppWindow().addPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel",this),this.owner.on("beforenotesaved",function(){this.setSyncStatus("syncing"),Ext.isEmpty(this.tinymcePanel)||Ext.isEmpty(this.tinymcePanel.getEditor())||(this.tinymcePanel.getEditor().execCommand("syno_print_clean",!1,{},{skip_focus:!0}),this.tinymcePanel.getEditor().execCommand("syno_checkbox_clean_id",!1,{},{skip_focus:!0}),this.tinymcePanel.getEditor().execCommand("syno_remove_mask",!1,{},{skip_focus:!0}))},this),this.owner.on("notesaved",function(t){t?this.setSyncStatus("done"):this.setSyncStatus("error")},this),this.callParent([this.fillConfig(t)]),Ext.isObject(SYNO.SDS.StatusNotifier)?this.mon(SYNO.SDS.StatusNotifier,"beforeunload",function(){if(!0===this.saveNote())return!1},this):(Ext.isFunction(window.onbeforeunload)&&(e=window.onbeforeunload),window.onbeforeunload=Ext.createDelegate(function(){return!0===this.saveNote()?SYNO.SDS.NoteStation._T("common","confirm_leave"):Ext.isFunction(e)?e():void 0},this)),o=function(){this.saveNote(void 0,void 0,{async:!1})},Ext.EventManager.on(window,"unload",o,this),this.on("beforedestroy",function(){this.stopIdleSession(),this.saveNote(),Ext.isFunction(e)&&(window.onbeforeunload=e),Ext.EventManager.un(window,"unload",o,this)},this),this.save_callback=[]},fillConfig:function(t){var e;return this.tinymceEditMode=!1,this.metadataPanel=new SYNO.SDS.NoteStation.Editor.MetaData.Panel({owner:this}),this.tinymcePanel=new SYNO.SDS.NoteStation.Editor.Tinymce.Panel({layout:"fit",anchor:"100% 100%",owner:this,listeners:{editorFocus:function(){if(!this.isDestroyed){if(SYNO.SDS.NoteStation.Utils.isPublicShare){SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.MainPanel").getTopToolbar().getComponent("share_btn").hideMenu()}Ext.isEmpty(this.metadataPanel)||!0===this.metadataPanel.collapsed||!1===this.isVisible()||(this.tinymceEditMode=!0)}},editorBlur:function(){this.isDestroyed||this.metadataPanel&&!1!==this.metadataPanel.collapsed&&(this.tinymceEditMode=!1)},resize:function(){this.resizeEditorHeight()},scope:this}}),this.metadataPanel.on("expand",this.resizeEditorHeight,this),this.metadataPanel.on("collapse",this.resizeEditorHeight,this),e={tbar:this.createEditorTBar(),cls:"syno-ns-editor-normal-panel syno-sds-aceeditor-main-panel syno-sds-filestation-available-drop-target",itemId:"editor_normal",bodyCssClass:"syno-ns-editor-normal-panel-body",items:[this.metadataPanel,this.tinymcePanel],listeners:{afterrender:{fn:function(t){Ext.isObject(t.body)&&!0===SYNO.SDS.NoteStation.Utils.isMobileiOS&&t.body.setStyle("overflow-y","scroll")},scope:this,single:!0},activate:function(t){t.items.each(function(t){t.fireEvent("activate",t)},this),this.resetIdleTimeout(),this.resetAutoSaveTimeout(),this.startIdleSession()},deactivate:function(t){this.stopIdleSession(),this.saveNote()},resetidle:this.resetIdleTimeout,scope:this}},Ext.apply(e,t),e},isEditMode:function(){return!!this.tinymceEditMode},resizeEditorHeight:function(){Ext.isEmpty(this.tinymcePanel)||Ext.isEmpty(this.metadataPanel)||0!==this.getInnerHeight()&&this.tinymcePanel.setHeight(this.getInnerHeight()-this.metadataPanel.getHeight())},getStatusBtn:function(){return this.getTopToolbar().getComponent("status_btn")},setSyncStatus:function(t){var e=this.getStatusBtn();this.isDestroyed||("done"===t&&e.isVisible()?(e.setIconClass("syno-ns-editor-done-btn"),Ext.defer(function(){this.isDestroyed||e.isDestroyed||e.hide()},2e3,this)):"syncing"===t?(e.setIconClass("syno-ns-editor-syncing-btn"),e.show()):"interrupt"===t?e.hide():"error"===t&&(e.setIconClass("syno-ns-editor-error-btn"),e.show()))},startIdleSession:function(){Ext.isEmpty(this.idleSession)||this.pollUnreg(this.idleSession),this.idleSession=this.pollReg({interval:45,immediate:!0,webapi:{api:"SYNO.NoteStation.Note",version:3,method:"idle"},status_callback:Ext.emptyFn,scope:this})},stopIdleSession:function(){Ext.isEmpty(this.idleSession)||(this.pollUnreg(this.idleSession),this.idleSession=null)},resetIdleTimeout:function(t){var e=this;null!==this.idleId&&(window.clearTimeout(this.idleId),this.idleId=null),!0!==t&&(this.idleId=window.setTimeout(function(){e.saveNote()},this.idleTimeout))},resetAutoSaveTimeout:function(t){var e=this;null!==this.autoSaveId&&(window.clearTimeout(this.autoSaveId),this.autoSaveId=null),!0!==t&&(this.autoSaveId=window.setTimeout(function(){e.saveNote()},this.autoSaveTimeout))},setTrimValue:function(t){var e=t.getValue().trim();t.setValue(e),Ext.isEmpty(e)&&t.setValue(SYNO.SDS.NoteStation._T("note","untitled"))},getTitleValue:function(t){var e=this.getTopToolbar().getComponent("title"),o=e.getValue();return!0===t?o.trim():o},createEditorTBar:function(){var t=[{xtype:"syno_textfield",itemId:"title",cls:"syno-ns-editor-title normal-font",emptyClass:"diable-font",emptyText:SYNO.SDS.NoteStation._T("note","untitled"),maxlength:SYNO.SDS.NoteStation.Define.TITLE_MAX_LENGTH,enableKeyEvents:!0,listeners:{keydown:function(){this.fireEvent("resetidle")},keyup:function(t,e){13===e.keyCode&&(this.setTrimValue(t),t.blur())},blur:function(t){this.setTrimValue(t),t.isDirty()&&this.saveNote()},focus:function(t){SYNO.SDS.NoteStation._T("note","untitled")===t.getValue()&&t.setValue("")},scope:this}},"->",{xtype:"syno_button",itemId:"status_btn",disabled:!0,iconCls:"syno-ns-editor-syncing-btn",hidden:!0},this._createShortcutBtnConfig(),{xtype:"syno_button",itemId:"copy_btn",iconCls:"syno-ns-editor-copy-btn",tooltip:SYNO.SDS.NoteStation._T("common","copy"),handler:function(){this.getCopyToWin().show()},scope:this},{xtype:"syno_button",iconCls:"syno-ns-editor-info-btn",itemId:"info_btn",tooltip:SYNO.SDS.NoteStation._T("tooltip","info"),handler:this.showInfoWin,scope:this},{xtype:"syno_button",itemId:"encrypt_btn",tooltip:SYNO.SDS.NoteStation._T("tooltip","encrypt"),handler:this.handleEncrypt,scope:this},{xtype:"syno_button",iconCls:"syno-ns-editor-share-btn",itemId:"share_btn",tooltip:SYNO.SDS.NoteStation._T("tooltip","share"),handler:function(){this.findAppWindow().getMainPanel().shareNote(this.noteData.object_id,this.afterAclChanged,this)},scope:this},{xtype:"syno_button",iconCls:"syno-ns-editor-presentation-btn",itemId:"present_btn",tooltip:SYNO.SDS.NoteStation._T("tooltip","presentation"),hidden:!SYNO.SDS.NoteStation.Utils.supportFullscreen(),handler:this.enterFullscreen,scope:this},{xtype:"syno_button",iconCls:"syno-ns-editor-todo-btn",itemId:"todo_btn",tooltip:SYNO.SDS.NoteStation._T("setting","todo_task"),listeners:{click:this.onTodoIconClick,mouseover:function(){this.tinymcePanel.enableKeepFocusOnEditor()},mouseout:function(){var t=this.tinymcePanel.getEditor(),e=document.querySelector("iframe#"+t.id+"_ifr");this.tinymcePanel.disableKeepFocusOnEditor(),!0===this.metadataPanel.collapsed&&e&&document.activeElement!==e&&(e.focus(),t.getBody().focus())},scope:this}},{xtype:"syno_button",iconCls:"syno-ns-editor-open-btn",itemId:"open_btn",tooltip:SYNO.SDS.NoteStation._T("common","open_note_in_new_tab"),handler:function(){this.openNoteInNewTab()},scope:this},{xtype:"syno_button",iconCls:"syno-ns-editor-more-btn",itemId:"more_btn",tooltip:SYNO.SDS.NoteStation._T("common","extra"),handler:this.showMoreMenu,scope:this}];return new SYNO.ux.Toolbar({cls:"syno-ns-editor-toolbar",items:t})},showMoreMenu:function(t,e){var o=[{text:SYNO.SDS.NoteStation._T("tooltip","delete"),itemId:"more_delete",handler:this.deleteNote,scope:this},{text:SYNO.SDS.NoteStation._T("tooltip","print"),itemId:"more_print",handler:function(){this.print()},scope:this},{text:SYNO.SDS.NoteStation._T("tooltip","mail"),itemId:"more_mail",hidden:!SYNO.SDS.NoteStation.Utils.supportPersonalMail(),handler:function(){this.findAppWindow().selectNote(this.noteData.object_id,"mail",this.notePerm)},scope:this},{text:SYNO.SDS.NoteStation._T("export","word"),itemId:"export_word",handler:function(){this.exportWord(this.tinymcePanel,this.noteData)},scope:this}],i={normalMenu:[0,1,2,3],joinedMenu:[1,2,3]},n=function(t,e){Ext.isEmpty(e)||Ext.iterate(e,function(e,i){t.addMenuItem(o[e])},this)};Ext.isEmpty(this.moreMenu)&&(this.moreMenu=new SYNO.ux.Menu({cls:"syno-ux-groupcheck-menu",items:o,listeners:{show:function(t){t.removeAll(),this.isJoined?n(t,i.joinedMenu):n(t,i.normalMenu)},scope:this}})),this.moreMenu.showAt(e.getXY())},getFloatTodoWindow:function(){return this.float_todo_window},onTodoIconClick:function(){var t=this.findAppWindow(),e=this.tinymcePanel.getEditor(),o=e.selection.getContent();if(Ext.isEmpty(this.float_todo_window)||this.float_todo_window.isDestroyed)this.float_todo_window=new SYNO.SDS.NoteStation.Editor.Tinymce.Todo.Window({owner:t,module:this.owner}),this.float_todo_window.show(),this.float_todo_window.anchorTo(t.getEl(),"br-br?");else{if(this.float_todo_window.isVisible()&&Ext.isEmpty(o.trim()))return void this.float_todo_window.hide();this.float_todo_window.show()}this.float_todo_window.listNoteTodo(this.noteData),Ext.isEmpty(o.trim())||SYNO.SDS.NoteStation.Todo.Common.addTodoByNoteHtml(o,this.float_todo_window.todoMainPanel,this.noteData.object_id)},showTodoFloatWindow:function(){var t=this.findAppWindow();(Ext.isEmpty(this.float_todo_window)||this.float_todo_window.isDestroyed)&&(this.float_todo_window=new SYNO.SDS.NoteStation.Editor.Tinymce.Todo.Window({owner:this.findAppWindow(),module:this.owner})),this.float_todo_window.isVisible()||(this.float_todo_window.show(),this.float_todo_window.anchorTo(t.getEl(),"br-br?")),this.float_todo_window.listNoteTodo(this.noteData)},afterAclChanged:function(t,e){var o,i,n,s,a=this.findAppWindow();!0===t&&(this.noteData.acl=e.acl,i=SYNO.SDS.NoteStation.Utils.isSharedAcl(e.acl),o=this.noteData.object_id,o in a.shortcut&&a.shortcut[o].shared!==i&&this.owner.fireEvent("tagchanged"),n=this.getTopToolbar(),Ext.isObject(n)&&(s=n.getComponent("share_btn"),s.toggle(i)))},openNoteInNewTab:function(){this.callParent(arguments),this.resetIdleTimeout(!0),this.resetAutoSaveTimeout(!0)},loadNote:function(t,e,o){"single"===e&&Ext.isObject(this.noteData)&&t===this.noteData.object_id||(Ext.isObject(o)||(o={}),this.setStatusBusy(),this.noteAction=e,this.clearNote(),this.notePerm=Ext.copyTo({},o,"perm_from,smart_id"),this.findAppWindow().getStorage().getNote(Ext.apply({object_id:t,callback:function(t,e){this.isActive()&&this.onLoadNote(t,e,o)},scope:this},this.notePerm)))},onLoadNote:function(t,e,o){var i,n=this.findAppWindow(),s="";if(!t||Ext.isEmpty(this.tinymcePanel)||Ext.isEmpty(this.getEditor()))return this.clearStatusBusy(),this.noteAction=null,this.notePerm=null,void SYNO.SDS.NoteStation.Utils.showErrorMsg(n,e);if(!0!==e.encrypt)this.onLoadNoteDone(e);else{if(void 0!==(i=n.getEncryptPassword(e.object_id).password)&&""!==i){try{s=CryptoJS.AES.decrypt(e.content,i).toString(CryptoJS.enc.Utf8)}catch(t){}if(s.substring(0,SYNO.SDS.NoteStation.Define.MAGIC.length)===SYNO.SDS.NoteStation.Define.MAGIC)return e.content=s.substring(SYNO.SDS.NoteStation.Define.MAGIC.length),void this.onLoadNoteDone(e)}this.owner.switchToPasswordPanel(t,e,this.getItemId())}},onLoadNoteDone:function(t){var e=this.getTopToolbar(),o=this.findAppWindow(),i=SYNO.SDS.NoteStation.Utils.isJoinednote(o,t.object_id),n=SYNO.SDS.NoteStation.Utils.isSharedAcl(t.acl),s=e.getComponent("shortcut_btn"),a=e.getComponent("share_btn"),r=e.getComponent("info_btn"),l=e.getComponent("open_btn"),d=e.getComponent("copy_btn"),c=e.getComponent("encrypt_btn"),h=e.getComponent("todo_btn"),u=e.getComponent("more_btn"),S=[s,a,r,l,c,d,h,u],p=[a,h],m=[d];this.tinymcePanel.fireEvent("editorLoadNote"),this.applySetting(),this.setTitle(t.title,t.object_id),this.tinymcePanel.setContent(t.content),this.tinymcePanel.getEditor().undoManager.add(),this.tinymcePanel.setAttachment(t.attachment,void 0,!0),this.metadataPanel.setData(t),this.resizeEditorHeight(),this.noteData=t,s.toggle(t.object_id in o.shortcut),c.toggle(t.encrypt),a.toggle(n),Ext.each(S,function(t){t.show()},this),!0===t.encrypt?h.hide():this.updateTodoBtnIndicator(),!0===t.archive&&(s.hide(),a.hide(),c.hide()),!0===t.recycle&&s.hide(),this.isJoined=i,!0===i?(c.setIconClass("syno-ns-editor-readonly-encrypt-btn"),c.disable(),Ext.each(p,function(t){t.hide()},this),t.encrypt?c.setTooltip(SYNO.SDS.NoteStation._T("note","note_is_encrypted")):c.hide()):(t.encrypt?c.setTooltip(SYNO.SDS.NoteStation._T("tooltip","decrypt")):c.setTooltip(SYNO.SDS.NoteStation._T("tooltip","encrypt")),c.setIconClass("syno-ns-editor-encrypt-btn"),c.enable(),Ext.each(m,function(t){t.hide()},this)),!0===SYNO.SDS.NoteStation.Utils.isShowNote&&(l.hide(),d.hide()),Ext.isObject(this.notePerm)&&"smart"===this.notePerm.perm_from&&!o.owned.smart.hasOwnProperty(this.notePerm.smart_id)&&a.hide(),this.resetIdleTimeout(),this.resetAutoSaveTimeout(),this.clearStatusBusy(),this.handleNoteAction(this.noteAction),this.noteAction=null,this.fireEvent("loadnotedone",this)},updateTodoBtnIndicator:function(){if(Ext.isObject(this.noteData)){var t=this.noteData.object_id;this.findAppWindow().getStorage().listTodo({filter:{note_id:[t]},callback:function(t,e){if(t){this.getTopToolbar().getComponent("todo_btn").toggle(e.total>0)}},scope:this})}},clearNote:function(){this.resetIdleTimeout(!0),this.resetAutoSaveTimeout(!0),this.noteData=null,this.notePerm=null,this.setSyncStatus("interrupt"),Ext.isEmpty(this.tinymcePanel)||Ext.isEmpty(this.tinymcePanel.getEditor())||(this.setTitle("",void 0),this.tinymcePanel.setContent(""),this.tinymcePanel.setAttachment(""),this.tinymcePanel.getEditor().undoManager.clear(),this.metadataPanel.setData(""),this.callParent())},updateData:function(t){Ext.isObject(t)&&!Ext.isEmpty(t.object_id)&&Ext.isObject(this.noteData)&&t.object_id===this.noteData.parent_id&&this.metadataPanel.updateParent(t)},handleNoteAction:function(t){Ext.isEmpty(t)||"single"===t?this.isEditMode()&&this.findAppWindow().focus():"print"===t?this.print():"edit"===t?this.tinymcePanel.getEditor().focus.defer(100,this.tinymcePanel.getEditor()):"info"===t?this.showInfoWin():"share"===t?this.findAppWindow().getMainPanel().shareNote(this.noteData.object_id,this.afterAclChanged,this):"encrypt"===t?this.getEncryptWin().show():"open_note_in_new_tab"===t?this.openNoteInNewTab():"mail"===t?this.launchMail(this.tinymcePanel,this.noteData,this.notePerm):"export"===t?this.exportNote(this.tinymcePanel,this.noteData):"todo"===t?this.showTodoFloatWindow():"export_word"===t&&this.exportWord(this.tinymcePanel,this.noteData)},handleEncrypt:function(){this.setStatusBusy(),this.saveNote(function(t){this.clearStatusBusy(),t&&this.getEncryptWin().show()},this)},showInfoWin:function(){this.getInfoWin().show()},setTitle:function(t,e){var o=this.getTopToolbar().getComponent("title");Ext.isEmpty(o)||(o.el&&document.activeElement===o.el.dom&&this.currentTitleObjectId===e||(o.setValue(t),this.currentTitleObjectId=e),o.originalValue=t)},getTitle:function(){var t=this.getTopToolbar();if(!Ext.isEmpty(t))return t.getComponent("title").getValue().trim()},getEncryptStatus:function(){return!1},deleteNote:function(){var t=this.findAppWindow(),e=t.getMsgBox(),o=String.format(this.noteData.recycle?SYNO.SDS.NoteStation._T("note","delete_title"):SYNO.SDS.NoteStation._T("note","delete_to_recycle"),1);Ext.isEmpty(this.noteData)||Ext.isEmpty(e)||e.confirmDelete(SYNO.SDS.NoteStation._T("note","delete"),o,function(e,o){if("yes"===e)return _S("demo_mode")?void SYNO.SDS.NoteStation.Utils.showErrorMsg(this.owner.findAppWindow(),116):void t.getMainPanel().deleteNoteAsync(this.noteData.object_id,Ext.copyTo({recycle:!this.noteData.recycle},this.notePerm,"perm_from,smart_id"))},this)},saveNote:function(t,e,o){var i,n,s,a,r,l=this.getTopToolbar().getComponent("title"),d={},c={},h={};if(!this.isDestroyed){if(this.addSaveCallback(t,e),!0===this.noteSaving)return!0;if(!0!==this.noteDialogOpened){if(this.noteSaving=!0,Ext.isEmpty(this.noteData))return this.handleSaveCallback(),void(this.noteSaving=!1);if(this.owner.fireEvent("beforenotesaved",this),i=this.findAppWindow(),!0===this.noteData.encrypt&&(a=i.getEncryptPassword(this.noteData.object_id)),!this.metadataPanel.isDefaultGPSEmpty()&&0===this.noteData.longitude&&0===this.noteData.latitude&&""===this.noteData.location&&Ext.isObject(this.noteData.commit_msg)&&!0===this.noteData.commit_msg.first_version&&(d.def_latitude=this.metadataPanel.getDefaultLat(),d.def_longitude=this.metadataPanel.getDefaultLng()),(r=this.getTitle())!==l.originalValue)d.title=r;else if(!this.noteData.encrypt&&Ext.isObject(this.noteData.commit_msg)&&this.noteData.commit_msg.first_version){var u=this.tinymcePanel.getSubstituteTitle();Ext.isEmpty(u)||(d.title=u,l.setValue(u))}return this.metadataPanel.isTagDirty()&&(d.tag=this.metadataPanel.getTags()),(this.metadataPanel.isParentIdDirty()&&(c.parent_id=this.noteData.parent_id,d.parent_id=this.metadataPanel.getParentId()),this.isInfoDirty()&&(Ext.apply(d,this.getInfoData()),Ext.isEmpty(d.parent_id)||(c.parent_id=this.noteData.parent_id)),(this.tinymcePanel.isAttachmentDirty()||this.tinymcePanel.isContentDirty())&&(s=this.tinymcePanel.getAttachment(),Ext.isObject(s)&&(d.attachment=s)),this.tinymcePanel.resetContentAttachment(),this.tinymcePanel.isContentDirty()&&(this.noteData.encrypt?(d.content=CryptoJS.AES.encrypt(SYNO.SDS.NoteStation.Define.MAGIC+this.tinymcePanel.getContent(),a.password).toString(),d.original_content=this.tinymcePanel.getContent(),d.brief=""):(d.content=this.tinymcePanel.getContent(),d.brief=this.tinymcePanel.getBrief()),this.tinymcePanel.isKeepModifyTime()&&(h.listable=!1,d.mtime=this.noteData.mtime)),this.tinymcePanel.restoreContentAttachment(),this.isEmptyObject(d))?(this.handleSaveCallback(!0,d),this.setSyncStatus("interrupt"),Ext.isObject(this.owner.layout)&&this.owner.layout.activeItem===this?(this.resetIdleTimeout(!0),this.resetAutoSaveTimeout()):(this.resetIdleTimeout(!0),this.resetAutoSaveTimeout(!0)),this.noteSaving=!1,void this.owner.fireEvent("notesaved",!0,"unchange")):(Ext.copyTo(c,this.noteData,"object_id,ver"),Ext.copyTo(d,this.noteData,"object_id,ver"),!0===this.noteData.encrypt&&(d.token=a.token),Ext.isObject(o)&&Ext.isObject(o.commit_msg)?d.commit_msg=Ext.apply(h,o.commit_msg):d.commit_msg=h,n=Ext.apply(o||{check_conflict:!0},d),"attachment"in d&&(this.upload_offset=0,this.upload_label=null,n.progress=Ext.createDelegate(this.onProgress,this)),Ext.isObject(this.notePerm)&&Ext.copyTo(n,this.notePerm,"perm_from,smart_id"),n.callback=function(t,e){var o=!1;if(this.isDestroyed)return this.handleSaveCallback(),void this.owner.fireEvent("notesaved",t,e);if(!0===t){if(("tag"in d||d.object_id in i.shortcut&&"title"in d)&&this.owner.fireEvent("tagchanged"),"parent_id"in d&&d.parent_id===e.parent_id&&this.owner.fireEvent("parentchanged",c,d),this.noteData.object_id===d.object_id){if(this.setTitle(e.title,e.object_id),this.metadataPanel.setData(e),this.tinymcePanel.setAttachment(e.attachment,d.attachment),this.noteData.encrypt){this.tinymcePanel.clearContentDirty(d.original_content);var n,s=i.getEncryptPassword(e.object_id).password;try{n=CryptoJS.AES.decrypt(e.content,s).toString(CryptoJS.enc.Utf8)}catch(t){}n.substring(0,SYNO.SDS.NoteStation.Define.MAGIC.length)===SYNO.SDS.NoteStation.Define.MAGIC&&(e.content=n.substring(SYNO.SDS.NoteStation.Define.MAGIC.length))}else this.tinymcePanel.clearContentDirty(e.content);this.noteData=e}}else o=this.handleFailure(d,e);this.handleSaveCallback(t,e),!0!==o&&this.owner.layout.activeItem===this?(this.resetIdleTimeout(t),this.resetAutoSaveTimeout()):(this.resetIdleTimeout(!0),this.resetAutoSaveTimeout(!0)),this.noteSaving=!1,this.owner.fireEvent("notesaved",t,e);try{window.opener.SYNO.SDS.NoteStation.Window.NewTabNoteSavedCallback(t,e)}catch(t){}},n.scope=this,!0===this.noteData.encrypt?this.findAppWindow().getStorage().setNotePolling(n):this.findAppWindow().getStorage().setNote(n),!0)}}},addSaveCallback:function(t,e){!0===Ext.isFunction(t)&&this.save_callback.push({callback:t,scope:e||window})},handleSaveCallback:function(t,e){for(var o=0;o<this.save_callback.length;o++){var i=this.save_callback[o];i.callback.call(i.scope,t,e)}this.save_callback=[]},isInfoDirty:function(){var t,e=this.findAppWindow().getPanelScope("SYNO.SDS.NoteStation.Info.Panel");return!Ext.isEmpty(e)&&(t=e.getForm(),t.isDirty()&&!this.infoWin.isVisible())},getInfoWin:function(){return(Ext.isEmpty(this.infoWin)||this.infoWin.isDestroyed)&&(this.infoWin=new SYNO.SDS.NoteStation.Info.Window({owner:this.findAppWindow(),noteData:this.noteData,notePerm:this.notePerm||{}})),this.infoWin},getEncryptWin:function(){return!0===this.noteData.encrypt?((Ext.isEmpty(this.encryptModifyWin)||this.encryptModifyWin.isDestroyed)&&(this.encryptModifyWin=new SYNO.SDS.NoteStation.Encrypt.Modify.Window({owner:this.findAppWindow()})),this.encryptModifyWin):((Ext.isEmpty(this.encryptCopyWin)||this.encryptCopyWin.isDestroyed)&&(this.encryptCopyWin=new SYNO.SDS.NoteStation.Encrypt.Copy.Window({owner:this.findAppWindow()})),this.encryptCopyWin)},getCopyToWin:function(){return(Ext.isEmpty(this.copyToWin)||this.copyToWin.isDestroyed)&&(this.copyToWin=new SYNO.SDS.NoteStation.CopyTo.Window({owner:this.findAppWindow(),param:{object_id:this.noteData.object_id,title_postfix:" - "+SYNO.SDS.NoteStation._T("common","duplicate")}})),this.copyToWin},getInfoData:function(){var t=this.findAppWindow().getPanelScope("SYNO.SDS.NoteStation.Info.Panel"),e=t.getForm(),o=e.getFieldValues(!0);return Ext.isEmpty(o.source_url)||/^(\/|http[s]?)/i.test(o.source_url)||(o.source_url="http://"+o.source_url),!Ext.isEmpty(o.ctime)&&Ext.isDate(o.ctime)&&(o.ctime=o.ctime.valueOf()/1e3),o.tag=SYNO.SDS.NoteStation.Utils.getTagsArray(e.findField("tag")),Ext.encode(o.tag)===this.metadataPanel.originalTag&&delete o.tag,Ext.isEmpty(o.latitude)&&Ext.isEmpty(o.longitude)&&Ext.isString(o.location)?(o.longitude=0,o.latitude=0):Ext.isEmpty(o.latitude)||Ext.isEmpty(o.longitude)||(o.longitude=parseFloat(o.longitude),o.latitude=parseFloat(o.latitude)),o},onProgress:function(t){var e;Ext.isEmpty(this.upload_label)&&this.tinymcePanel.ddupload.items.forEach(function(t){if(t.state===t.stateEnum.LOCAL)return this.upload_label=t,!1},this),Ext.isEmpty(this.upload_label)||(e=t.loaded||t.position,100<=this.upload_label.onProgress(e-this.upload_offset)&&(this.upload_offset+=this.upload_label.file.size,this.upload_label=null,this.onProgress(t)))},handleFailure:function(t,e){var o,i,n;if(Ext.isObject(e)&&!Ext.isEmpty(e.code))return 1064===e.code?(i=this.getConflictWindow(),n=Ext.apply({},t,this.noteData),n.attachment=this.tinymcePanel.getExistAttachment(),i.setConflictData({noteData:n,params:t,editor:this.getEditor()}),i.show(),
!0):(o=SYNO.SDS.NoteStation.Utils.getErrorStr(e),this.tinymcePanel.ddupload.items.forEach(function(t){t.stateEnum.UPLOADING!==t.state&&t.stateEnum.UPLOADED!==t.state||t.onError(o)},this),SYNO.SDS.NoteStation.Utils.showErrorMsg(this.findAppWindow(),e),!1)},getEditor:function(){return this.tinymcePanel.getEditor()},onImageReady:function(t,e,o){this.tinymcePanel.onImageReady(t,e,o)},getConflictWindow:function(){return(Ext.isEmpty(this.conflictWin)||this.conflictWin.isDestroyed)&&(this.conflictWin=new SYNO.SDS.NoteStation.Conflict.Window({owner:this.findAppWindow(),module:this})),this.conflictWin},focusOnTitle:function(){this.getTopToolbar().getComponent("title").focus()},focusOnTag:function(){this.metadataPanel.focusOnTag()}}),Ext.define("SYNO.SDS.NoteStation.Editor.ReadOnly.Panel",{extend:"SYNO.SDS.NoteStation.Editor.Base.Panel",constructor:function(t){this.owner=t.owner,this.findAppWindow().addPanelScope("SYNO.SDS.NoteStation.Editor.ReadOnly.Panel",this),this.callParent([this.fillConfig(t)])},fillConfig:function(t){this.metadataPanel=new SYNO.SDS.NoteStation.Editor.MetaData.Panel({owner:this,readonly:!0,height:0}),this.ddupload=new SYNO.SDS.NoteStation.Editor.Tinymce.DDUpload({readonly:!0,module:this,owner:this}),this.syno_editor=new SYNO.ux.TinyMCE({owner:this,autoEditorResize:!0,anchor:"100% 100%",mceConfig:{skin_url:"webman/3rdparty/NoteStation/js/TinyMCE/js/tinymce/skins/synostyle",content_css:"webman/3rdparty/NoteStation/js/tinymce_plugins/note_content_patch.css",editorPanel:this,forced_root_block:"div",module:this.owner,owner:this,indent:!1,plugins:["syno_searchreplace syno_search hr","syno_ddupload syno_checkbox syno_attachment_viewer syno_print syno_notefontsizeselect syno_print","syno_reader_style syno_link syno_table syno_chart"],syno_print:{onPrintHtml:function(t,e){var o='<div class="normal-font" style="font-size: 15px;font-weight: bold;padding-left: 4px;">{0}</div>';return o+='<hr style="border:dashed 1px #D7E1EB;" />',o+='<div class="normal-font">{1}</div>',o+='<img src="webman/3rdparty/NoteStation/images/_2x/shadow_title.png?v=2.0-0329" style="height: 4px; width: 100%;" > </img>',"header"===e?String.format(o,this.getPrintTitle(),this.getPrintInfo()):""},onPrintWindowTitle:function(){return this.getPrintTitle()},scope:this},syno_ddupload:{instance:this.ddupload},toolbar:[],statusbar:!1,menubar:!1,readonly:!0,convert_url:!1,detect_reader_content:!0,mode:"textareas",extended_valid_elements:["img[class|src|border=0|alt|title|hspace|vspace|width|height|align|onmouseover|onmouseout|name|ref|adjust|style]","a[href|target=_blank|rel|media|hreflang|type|download|charset|name|rev|shape|coords|file_ref|style]","embed[src|type|width|height|pdf_ref]","table[id|style|title|border|summary|width|frame|rules|cellspacing|cellpadding|align|bgcolor]","div[id|accesskey|class|dir|lang|style|tabindex|title|contenteditable|contextmenu|draggable|dropzone|hidden|spellcheck|translate|xml|align|chart-data|chart-config]"].join(",")},listeners:{initialize:function(t,e){var o,i=this;o=Ext.get(e.getContainer()),e.on("BeforeSetContent",function(){0!==i.getHeight()&&t.fireEvent("resize",t,i.getWidth(),i.getHeight(),i.getWidth(),i.getHeight())}),(Ext.isIE||Ext.isIE11)&&e.on("SetContent",function(){Ext.iterate(e.dom.select("iframe"),function(t,e){var o=SYNO.SDS.NoteStation.Editor.Tinymce.Link.Youtube;o&&o.matchUrl(t.src)&&(t.src=Ext.urlAppend(t.src,"wmode=transparent",!1))})}),Ext.isObject(o)&&o.setStyle("border-width","0px"),Ext.isElement(e.getContentAreaContainer())&&(o=Ext.get(e.getContentAreaContainer()),o.setStyle("border-width","0px")),Ext.fly(e.getDoc()).on("mousedown",function(){var t=i.findAppWindow();Ext.isObject(t)&&!t.isDestroyed&&Ext.isObject(t.manager)&&Ext.isFunction(t.manager.getActiveAppWindow)&&t.manager.getActiveAppWindow()!==t&&t.toFront()})},scope:this}});var e={tbar:this.createEditorTBar(),cls:"syno-ns-editor-normal-panel",itemId:"editor_normal",bodyCssClass:"syno-ns-editor-normal-panel-body",items:[this.metadataPanel,this.syno_editor],listeners:{afterrender:{fn:function(t){Ext.isObject(t.body)&&!0===SYNO.SDS.NoteStation.Utils.isMobileiOS&&t.body.setStyle("overflow-y","scroll")},scope:this,single:!0}}};return Ext.apply(e,t),e},createEditorTBar:function(){var t=SYNO.SDS.NoteStation.Utils,e=[{xtype:"syno_textfield",itemId:"title",cls:"syno-ns-editor-title normal-font",emptyClass:"diable-font",emptyText:"Untitled",readOnly:!0},"->",this._createShortcutBtnConfig(),{xtype:"syno_button",itemId:"copy_btn",iconCls:"syno-ns-editor-copy-btn",tooltip:SYNO.SDS.NoteStation._T("common","copy"),handler:function(){this.getCopyToWin().show()},scope:this},{xtype:"syno_button",itemId:"encrypt_btn",enableToggle:!1,iconCls:"syno-ns-editor-readonly-encrypt-btn",tooltip:SYNO.SDS.NoteStation._T("note","note_is_encrypted"),hidden:t.isPublicShare,isEncrypted:this.getEncryptStatus()},{xtype:"syno_button",iconCls:"syno-ns-editor-presentation-btn",itemId:"present_btn",tooltip:SYNO.SDS.NoteStation._T("tooltip","presentation"),hidden:!SYNO.SDS.NoteStation.Utils.supportFullscreen(),handler:this.enterFullscreen,scope:this},{xtype:"syno_button",iconCls:"syno-ns-editor-print-btn",itemId:"print_btn",tooltip:SYNO.SDS.NoteStation._T("tooltip","print"),hidden:t.isMobileDevice,scope:this,handler:function(){this.print()}},{xtype:"syno_button",iconCls:"syno-ns-editor-mail-btn",itemId:"mail_btn",tooltip:SYNO.SDS.NoteStation._T("tooltip","mail"),hidden:!SYNO.SDS.NoteStation.Utils.supportPersonalMail(),scope:this,handler:function(){this.findAppWindow().selectNote(this.noteData.object_id,"mail",this.notePerm)}},{xtype:"syno_button",iconCls:"syno-ns-editor-open-btn",itemId:"open_btn",tooltip:SYNO.SDS.NoteStation._T("common","open_note_in_new_tab"),hidden:t.isShowNote||t.isMobileDevice,scope:this,handler:function(){this.openNoteInNewTab()}}];return new SYNO.ux.Toolbar({cls:"syno-ns-editor-toolbar",items:e})},loadNote:function(t,e,o){var i,n;"single"===e&&Ext.isObject(this.noteData)&&t===this.noteData.object_id||(this.setStatusBusy(),this.noteAction=e,this.clearNote(),this.notePerm=Ext.copyTo({},o,"perm_from,smart_id"),i=this.findAppWindow(),n=function(){i.getStorage().getNote(Ext.apply({object_id:t,callback:this.onLoadNote,scope:this},this.notePerm))},Ext.isEmpty(this.syno_editor.getEditor())?this.syno_editor.on("initialize",n,this,{single:!0}):n.call(this))},resizeEditorSize:function(){Ext.isEmpty(this.syno_editor)||Ext.isEmpty(this.metadataPanel)||(this.syno_editor.setHeight(this.getInnerHeight()-this.metadataPanel.getHeight()),this.syno_editor.setWidth(this.getInnerWidth()))},onLoadNote:function(t,e){var o,i=this.findAppWindow(),n="";if(!t)return this.clearStatusBusy(),this.noteAction=null,void(SYNO.SDS.NoteStation.Utils.isPublicShare?this.findAppWindow().mask(.5,SYNO.SDS.NoteStation.Utils.getErrorStr(e.code)):SYNO.SDS.NoteStation.Utils.showErrorMsg(this.findAppWindow(),e));if(!0!==e.encrypt)this.onLoadNoteDone(e);else{if(void 0!==(o=i.getEncryptPassword(e.object_id).password)&&""!==o){try{n=CryptoJS.AES.decrypt(e.content,o).toString(CryptoJS.enc.Utf8)}catch(t){}if(n.substring(0,SYNO.SDS.NoteStation.Define.MAGIC.length)===SYNO.SDS.NoteStation.Define.MAGIC)return e.content=n.substring(SYNO.SDS.NoteStation.Define.MAGIC.length),void this.onLoadNoteDone(e)}this.owner.switchToPasswordPanel(t,e,this.getItemId())}},onLoadNoteDone:function(t){var e=this.findAppWindow(),o=this.getTopToolbar(),i=o.getComponent("shortcut_btn"),n=o.getComponent("copy_btn"),s=o.getComponent("encrypt_btn"),a=o.getComponent("open_btn"),r=[n,a,s],l=SYNO.SDS.NoteStation.Utils.isJoinednote(e,t.object_id);if(this.applySetting(),this.setTitle(t.title),this.setContent(t.content),this.setAttachment(t.attachment),this.metadataPanel.setData(t),this.resizeEditorSize(),this.noteData=t,i.toggle(t.object_id in e.shortcut),s.toggle(t.encrypt),Ext.each(r,function(t){t.show()},this),l&&!SYNO.SDS.NoteStation.Utils.isPublicShare||(i.hide(),n.hide()),t.encrypt||s.hide(),SYNO.SDS.NoteStation.Utils.isPublicShare&&document.body.hasAttribute("syno-font-size")){var d=this.getEditor();d&&d.id&&!d.isHidden()&&d.getBody().classList.add("syno-fontsize-"+document.body.getAttribute("syno-font-size"))}!0===SYNO.SDS.NoteStation.Utils.isShowNote&&(a.hide(),n.hide()),this.clearStatusBusy(),this.handleNoteAction(this.noteAction),this.noteAction=null,this.fireEvent("loadnotedone",this)},handleNoteAction:function(t){"print"===t?this.print():"open_note_in_new_tab"===t?this.openNoteInNewTab():"mail"===t?this.launchMail(this,this.noteData,this.notePerm):"export"===t?this.exportNote(this,this.noteData):"export_word"===t&&this.exportWord(this,this.noteData)},clearNote:function(){this.noteData=null,this.notePerm=null,Ext.isEmpty(this.syno_editor)||Ext.isEmpty(this.syno_editor.getEditor())||(this.setTitle(""),this.setContent(""),this.setAttachment(""),this.metadataPanel.setData(""),this.callParent())},setContent:function(t){Ext.isEmpty(this.syno_editor)||Ext.isEmpty(this.syno_editor.getEditor())||!Ext.isString(t)||this.syno_editor.getEditor().setContent(t)},setTitle:function(t){var e=this.getTopToolbar().getComponent("title");Ext.isEmpty(e)||(e.setValue(t),e.originalValue=t)},getTitle:function(){var t=this.getTopToolbar();if(!Ext.isEmpty(t))return t.getComponent("title").getValue()},getEncryptStatus:function(){return!Ext.isEmpty(this.noteData)&&!0===this.noteData.encrypt},setAttachment:function(t){this.ddupload.setFiles(t)},getExistAttachment:function(){return this.ddupload.getExistFiles()},getEditor:function(){return this.syno_editor.getEditor()},getCopyToWin:function(){return(Ext.isEmpty(this.copyToWin)||this.copyToWin.isDestroyed)&&(this.copyToWin=new SYNO.SDS.NoteStation.CopyTo.Window({owner:this.findAppWindow(),param:{object_id:this.noteData.object_id,title_postfix:" - "+SYNO.SDS.NoteStation._T("common","duplicate")}})),this.copyToWin}}),Ext.define("SYNO.SDS.NoteStation.Editor.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Editor.Panel",this),this.owner=t.owner,this.addEvents("beforenotesaved","notesaved","notedeleted","tagchanged","parentchanged"),this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e;return this.normalPanel=new SYNO.SDS.NoteStation.Editor.Normal.Panel({owner:this,layout:"anchor",itemId:"editor_normal"}),this.emptyPanel=new SYNO.SDS.NoteStation.Editor.Empty.Panel({owner:this,layout:"fit",itemId:"editor_empty"}),this.readOnlyPanel=new SYNO.SDS.NoteStation.Editor.ReadOnly.Panel({owner:this,layout:"anchor",itemId:"editor_readonly"}),this.passwordPanel=new SYNO.SDS.NoteStation.Editor.Password.Panel({owner:this,layout:{type:"vbox",align:"center",pack:"center"},itemId:"editor_password"}),e={cls:"syno-ns-editor-panel",items:[this.emptyPanel,this.normalPanel,this.readOnlyPanel,this.passwordPanel],activeItem:0,itemId:"editor",listeners:{activate:function(t){t.items.each(function(t){t.fireEvent("activate",t)},this)}}},this.owner.on("selectnote",this.onSelectNote,this),Ext.apply(e,t),e},onSelectNote:function(t,e,o){var i=["print","edit","single","info","share","encrypt","open_note_in_new_tab","mail","export","todo","export_word"];(Ext.isEmpty(e)||-1!==i.indexOf(e))&&this.switchPanel(t,e,o)},switchPanel:function(t,e,o){if(this.getNoteId()===t)return void this.getLayout().activeItem.handleNoteAction(e);var i,n,s,a;if(s=this.findAppWindow(),Ext.isEmpty(t))n="editor_empty";else if(!0===SYNO.SDS.NoteStation.Utils.isPublicShare)n="editor_readonly";else if("smart"===o.perm_from&&Ext.isString(o.smart_id))n=o.smart_id in s.owned.smart?"editor_normal":o.smart_id in s.joined.smart&&("rw"===s.joined.smart[o.smart_id].perm||"owner"===s.joined.smart[o.smart_id].perm)?"editor_normal":"editor_readonly";else if(-1==s.owned.recycle.indexOf(t)||!Ext.isEmpty(o.recycle)&&!0!==o.recycle)if(t in s.owned.note&&(Ext.isEmpty(o.recycle)||!1===o.recycle))a=s.owned.note[t].commit_msg,Ext.isObject(a)&&!0===a.readonly?(n="editor_readonly",s.getStorage().listNote({filter:{object_id:t},field:{commit_msg:!0},cancel_previous_request:!1,callback:Ext.emptyFn})):n="editor_normal";else{if(!(t in s.joined.note)||!Ext.isEmpty(o.recycle)&&!1!==o.recycle)return void s.getMainPanel().syncNow(t,e);n="ro"===s.joined.note[t].perm?"editor_readonly":"editor_normal"}else{if(Ext.isObject(o)&&!0===o.note_link)return void s.getMsgBox().alert("",SYNO.SDS.NoteStation._T("common","note_link_in_recycle"));n="editor_readonly"}i=this.getComponent(n),Ext.isEmpty(i)||(this.setStatusBusy(),this.getLayout().activeItem.saveNote(function(){this.clearStatusBusy(),this.getLayout().setActiveItem(i),i.loadNote(t,e,o)},this))},isPanelActive:function(t){return this.owner.isViewPanelActive()&&this.getLayout().activeItem===t},setStatusBusy:function(){this.el&&!this.el.isMasked()&&this.el.mask(SYNO.SDS.NoteStation._T("common","loading"),"x-mask-loading")},clearStatusBusy:function(){this.el&&this.el.unmask()},updateData:function(t){this.layout.activeItem.updateData(t)},getNoteId:function(){var t="";try{t=this.getLayout().activeItem.noteData.object_id}catch(t){}return Ext.isEmpty(t)?null:t},reloadNote:function(t,e,o){var i,n;if(i=this.getLayout().activeItem,this.isDestroyed||!Ext.isObject(i)||!Ext.isObject(i.noteData)||!Ext.isString(i.noteData.object_id))return void(Ext.isFunction(e)&&e.call(o));n=i.noteData.object_id,this.setStatusBusy(),i.saveNote(function(){this.clearStatusBusy(),this.getLayout().setActiveItem(i),i.loadNote(n,t,{}),Ext.isFunction(e)&&e.call(o)},this)},switchToPasswordPanel:function(t,e,o){var i={resp:e,succ:t,activeItemId:o};this.layout.setActiveItem("editor_password"),this.layout.activeItem.saveEncryptedObj(i)},handleFullscreen:function(){var t=this.getLayout().activeItem;t!==this.normalPanel&&t!==this.readOnlyPanel||t.enterFullscreen()},handleEncrypt:function(){var t=this.getLayout().activeItem;t===this.normalPanel&&t.handleEncrypt()},handleOpenTodoWindow:function(){var t=this.getLayout().activeItem;t===this.normalPanel&&t.onTodoIconClick()},handleSave:function(){var t=this.getLayout().activeItem;t===this.normalPanel&&t.saveNote()},handleCreateTag:function(){var t=this.getLayout().activeItem;t===this.normalPanel&&t.metadataPanel.openCreateTagDialog()},handleShowInfo:function(){var t=this.getLayout().activeItem;t===this.normalPanel&&t.showInfoWin()},handlePrint:function(){var t=this.getLayout().activeItem;t!==this.normalPanel&&t!==this.readOnlyPanel||t.print()},focusOnTitle:function(){var t=this.getLayout().activeItem;t!==this.normalPanel&&t!==this.readOnlyPanel||t.focusOnTitle()},focusOnTag:function(){var t=this.getLayout().activeItem;t!==this.normalPanel&&t!==this.readOnlyPanel||t.focusOnTag()},verify_note:function(){var t,e,o,i="na";t=this.findAppWindow();try{e=this.layout.activeItem.noteData}catch(t){}Ext.isObject(e)&&(!0===Ext.isString(e.object_id)&&0===e.object_id.indexOf(String(t.owner_uid)+"_")?i="owner":Ext.isEmpty(e.smart_id)?e.object_id in t.owned.note?i=!0===t.owned.note[e.object_id].recycle?"ro":t.owned.note[e.object_id].perm:e.object_id in t.joined.note&&(i=t.joined.note[e.object_id].perm):e.smart_id in t.owned.smart?i=t.owned.smart[e.smart_id]:e.smart_id in t.joined.smart&&(i=t.owned.smart[e.smart_id]),o=this.layout.activeItem.itemId,"ro"===i&&"editor_readonly"!==o?this.layout.setActiveItem("editor_empty"):"owner"!==i&&"rw"!==i||"editor_normal"===o?"na"===i&&this.layout.setActiveItem("editor_empty"):this.layout.setActiveItem("editor_empty"))}}),Ext.define("SYNO.SDS.NoteStation.FormPanel.AdvancedSearch",{extend:"SYNO.ux.FormPanel",constructor:function(t){var e=this.fillConfig(t);this.callParent([e]),this.mon(Ext.getDoc(),"mousedown",this.onMouseDown,this),!0!==t.smart&&this.on("afterlayout",function(){this.checkGroupNotebookCategory=new SYNO.ux.Utils.EnableRadioGroup(this.getForm(),"notebook_category",{archive:["notebook_archive"],common:["notebook_common"]})},this,{single:!0})},onMouseDown:function(t){var e=this.datefromField,o=this.datetoField;this.handleHideDateField(t,e),this.handleHideDateField(t,o)},handleHideDateField:function(t,e){var o=e.menu;e&&e.menu&&(t.within(e.trigger)||t.within(this.getEl())&&!t.within(e.getEl())&&!t.within(o.getEl())&&o.isVisible()&&e.menuEvents("hide"))},getSearchValues:function(){var t=[],e=[],o={},i=this.getForm(),n=i.findField("keyword").getValue(),s=i.findField("title").getValue(),a=i.findField("tag_operator").getValue()?"and":"or",r=i.findField("datetype").getValue(),l=i.findField("searchdatefrom").getValue(),d=i.findField("searchdateto").getValue();return Ext.isEmpty(n)||(o.keyword=n),Ext.isEmpty(s)||(o.title=s),Ext.isEmpty(a)||(o.tag_operator=a),Ext.iterate(this.tagSuperBox.getValueEx(),function(e,o){t.push(e.id)},this),!1===this.notebookSuperBox.disabled?(Ext.iterate(this.notebookSuperBox.getValueEx(),function(t,o){e.push(t.id)},this),o.archive=!1):!1===this.archiveSuperBox.disabled&&(Ext.iterate(this.archiveSuperBox.getValueEx(),function(t,o){e.push(t.id)},this),o.archive=!0),t.length>0&&(o.tag=t),e.length>0&&(o.parent_id=e),""===l&&""===d||(l=Ext.isEmpty(l)?null:l.getTime()/1e3,d=Ext.isEmpty(d)?null:d.getTime()/1e3+86400,o[r+"_start"]=l,o[r+"_end"]=d,o.datetype=r),o},handleClickSearch:function(){this.owner.hideMenu(),this.owner.fullTextSearch(this.getSearchValues())},handleClickCancel:function(){this.getForm().reset(),this.getForm().findField("searchdatefrom").setMaxValue(null),this.getForm().findField("searchdateto").setMinValue(null),this.handleSuperBoxChange()},fillConfig:function(t){var e=new Ext.data.SimpleStore({autoDestroy:!0,fields:["value","display"],data:[["mtime",SYNO.SDS.NoteStation._T("sort","by_mtime")],["ctime",SYNO.SDS.NoteStation._T("sort","by_ctime")]]}),o=new Ext.data.SimpleStore({fields:["tag","id"]});this.tagSuperBox=new SYNO.SDS.NoteStation.SuperBoxSelect({emptyText:void 0,store:o,displayField:"tag",itemCls:"syno-ns-form-last-field syno-ns-menu-sbs",listClass:"x-menu syno-ux-combobox-list syno-ns-advancedsearch-combobox-list",valueField:"id",listeners:{addItem:this.handleSuperBoxChange,removeItem:this.handleSuperBoxChange,scope:this}}),this.notebookSuperBox=new SYNO.ux.SuperBoxSelect({indent:!0===t.smart?0:1,store:new Ext.data.SimpleStore({fields:["notebook","id"]}),mode:"local",name:"notebook_common",itemCls:"syno-ns-form-last-field syno-ns-menu-sbs",allowAddNewData:!0,displayField:"notebook",listClass:"x-menu syno-ux-combobox-list syno-ns-advancedsearch-combobox-list",valueField:"id",listeners:{addItem:this.handleSuperBoxChange,removeItem:this.handleSuperBoxChange,scope:this}}),this.archiveSuperBox=new SYNO.ux.SuperBoxSelect({indent:1,hidden:!0===t.smart,store:new Ext.data.SimpleStore({fields:["notebook","id"]}),mode:"local",name:"notebook_archive",itemCls:"syno-ns-form-last-field syno-ns-menu-sbs",itemId:"notebook_archive",allowAddNewData:!0,displayField:"notebook",listClass:"x-menu syno-ux-combobox-list syno-ns-advancedsearch-combobox-list",valueField:"id",listeners:{addItem:this.handleSuperBoxChange,removeItem:this.handleSuperBoxChange,scope:this}}),this.datefromField=new SYNO.SDS.NoteStation.DateField({name:"searchdatefrom",emptyText:SYNO.SDS.NoteStation._T("search","date_from"),itemId:"searchdatefrom",listeners:{select:{fn:function(t,e){this.form.findField("searchdateto").setMinValue(e)},scope:this}}}),this.datetoField=new SYNO.SDS.NoteStation.DateField({name:"searchdateto",emptyText:SYNO.SDS.NoteStation._T("search","date_to"),itemId:"searchdateto",listeners:{select:{fn:function(t,e){this.form.findField("searchdatefrom").setMaxValue(e)},scope:this}}});var i={width:342,autoHeight:!0,cls:"syno-ns-advancedsearch",bodyStyle:"padding: 8px 16px",trackResetOnLoad:!0,defaults:{anchor:"100%",hideLabel:!0},items:[{xtype:"syno_displayfield",itemCls:"syno-ns-form-display-field",value:SYNO.SDS.NoteStation._T("search","keyword")+SYNO.SDS.NoteStation._T("common","colon"),flex:1},{xtype:"syno_textfield",name:"keyword",itemCls:"syno-ns-form-last-field",flex:2,value:""},{xtype:"syno_displayfield",itemCls:"syno-ns-form-display-field",value:SYNO.SDS.NoteStation._T("search","title")+SYNO.SDS.NoteStation._T("common","colon"),flex:1},{xtype:"syno_textfield",name:"title",itemCls:"syno-ns-form-last-field",flex:2,value:""},{xtype:"syno_displayfield",itemCls:"syno-ns-form-display-field",value:SYNO.SDS.NoteStation._T("time","time_date")+SYNO.SDS.NoteStation._T("common","colon")},{xtype:"syno_combobox",name:"datetype",triggerAction:"all",editable:!1,mode:"local",store:e,displayField:"display",valueField:"value",lazyRender:!0,listClass:"x-menu syno-ux-combobox-list",value:"mtime"},{xtype:"syno_compositefield",itemCls:"syno-ns-form-last-field",hideLabel:!0,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[this.datefromField,this.datetoField]},{xtype:"syno_displayfield",itemCls:"syno-ns-form-display-field",value:SYNO.SDS.NoteStation._T("category","tag")+SYNO.SDS.NoteStation._T("common","colon")},this.tagSuperBox,{xtype:"syno_checkbox",boxLabel:SYNO.SDS.NoteStation._T("search","tag_operator"),itemCls:"syno-ns-form-last-field",name:"tag_operator"},{xtype:"syno_displayfield",hidden:!0!==t.smart,value:SYNO.SDS.NoteStation._T("category","notebook")+SYNO.SDS.NoteStation._T("common","colon")},{xtype:"syno_radio",hidden:!0===t.smart,boxLabel:SYNO.SDS.NoteStation._T("category","notebook")+SYNO.SDS.NoteStation._T("common","colon"),name:"notebook_category",inputValue:"common",checked:!0},this.notebookSuperBox,{xtype:"syno_radio",hidden:!0===t.smart,boxLabel:SYNO.SDS.NoteStation._T("category","archive")+SYNO.SDS.NoteStation._T("common","colon"),name:"notebook_category",inputValue:"archive"},this.archiveSuperBox,{xtype:"toolbar",cls:"syno-ns-advancedsearch-toolbar",items:[{xtype:"tbfill"},{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","reset"),btnStyle:"grey",listeners:{click:this.handleClickCancel,scope:this}},{xtype:"tbspacer",width:10},{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","search"),hidden:!0===t.smart,btnStyle:"blue",listeners:{click:this.handleClickSearch,scope:this}},{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","apply"),hidden:!0!==t.smart,btnStyle:"blue",handler:this.handleEditSmart,scope:this}]}]};return Ext.apply(i,t),i},loadTags:function(){var t=[],e={},o=SYNO.SDS.NoteStation.Window;this.tagSuperBox.items.each(function(t){t.value in o.tag||t.preDestroy()},this),Ext.iterate(this.tagSuperBox.getValueEx(),function(t,o){e[t.id]=!0},this),Ext.iterate(o.tag,function(o,i){i.id in e||t.push(new Ext.data.Record({tag:i.title,id:i.id}))},this),this.tagSuperBox.getStore().removeAll(),this.tagSuperBox.getStore().add(t)},loadCategoryNotebook:function(t,e){var o=[],i={},n=SYNO.SDS.NoteStation.Window;t.items.each(function(t){t.value in n.owned.notebook||t.preDestroy()},this),Ext.iterate(t.getValueEx(),function(t,e){i[t.id]=!0},this),Ext.iterate(n.owned.notebook,function(t,n){n.id in i||e!==n.archive||o.push(new Ext.data.Record({notebook:n.title,id:n.id}))},this),t.getStore().removeAll(),t.getStore().add(o)},loadNotebook:function(){this.loadCategoryNotebook(this.notebookSuperBox,!1),this.loadCategoryNotebook(this.archiveSuperBox,!0)},handleSuperBoxChange:function(){this.owner.menu.doLayout()},setTags:function(t){var e=[];this.tagSuperBox.clearValue(),Ext.iterate(t,function(t){e.push({id:t,tag:t.substr(0,t.lastIndexOf("@"))})}),Ext.isEmpty(e)||(this.tagSuperBox.rendered?(this.tagSuperBox.addItems(e),this.tagSuperBox.blur()):this.tagSuperBox.addListener("afterrender",function(){this.tagSuperBox.addItems(e),this.tagSuperBox.blur()},this,{single:!0})),this.tagSuperBox.originalValue=this.tagSuperBox.getValue()},setNotebooks:function(t){var e=[],o=this.owner.findAppWindow();Ext.iterate(t,function(t){t in o.owned.notebook&&e.push({id:t,notebook:o.owned.notebook[t].title})}),Ext.isEmpty(e)?this.notebookSuperBox.clearValue():this.addListener("show",function(){this.notebookSuperBox.setValueEx(e),this.notebookSuperBox.blur.defer(300)},this,{single:!0}),this.notebookSuperBox.originalValue=this.notebookSuperBox.getValue()},setSmartConfig:function(t){var e=this.getForm();this.smart_id=null,e.setValues({keyword:null,title:null,ctime_start:null,ctime_end:null,mtime_start:null,mtime_end:null}),this.setTags(null),this.setNotebooks(null),Ext.isObject(t)&&(this.smart_id=t.object_id,Ext.isObject(t.query)&&(e.setValues(t.query),this.setTags(t.query.tag),this.setNotebooks(t.query.parent_id)))},handleEditSmart:function(t,e){var o=this.owner.findAppWindow();if(!this.getForm().isDirty())return this.owner.hideMenu(),!1;this.el.mask(SYNO.SDS.NoteStation._T("common","loading"),"x-mask-loading"),o.getMainPanel().setSmart({object_id:this.smart_id,query:this.getSearchValues()},function(t,e){var i,n,s;if(this.el.unmask(),!0!==t)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(o,e);this.owner.hideMenu(),i=o.getMainPanel().getNotebookPanel(),"full_menu"===i.layout.activeItem.itemId&&(n=i.layout.activeItem,s=n.getSelectionModel().getSelectedNodes(),Ext.isArray(s)&&1===s.length&&(s=s[0],s.attributes.object_id in o.owned.smart&&n.selectNode(s)))},this)}}),Ext.define("SYNO.SDS.NoteStation.SearchField",{extend:"SYNO.ux.SearchField",constructor:function(t){this.previous_keyword="",this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={enableKeyEvents:!0,listeners:{keyup:function(t,e){13!==e.keyCode&&this.previous_keyword===this.getValue()||(this.searchTimer&&window.clearTimeout(this.searchTimer),this.previous_keyword=this.getValue(),this.searchTimer=this.onSearchFieldKeyDown.defer(400,this))}},onTriggerClick:function(){if(!this.disabled){SYNO.ux.SearchField.superclass.onTriggerClick.apply(this,arguments);SYNO.SDS.NoteStation.Utils.getTodoPanel().isVisible()?this.todoSearch():this.fullTextSearch({keyword:this.getValue()})}}};return Ext.apply(e,t),e},reset:function(){this.previous_keyword="",this.callParent()},onSearchFieldKeyDown:function(){this.searchTimer&&(window.clearTimeout(this.searchTimer),this.searchTimer=null);var t=SYNO.SDS.NoteStation.Window.getMainPanel(),e=t.getTodoPanel(),o=t.getNotebookPanel(),i=!1;if(o.fullMenu.isVisible()){var n=o.fullMenu.getSelectionModel().getSelectedNodes();i=!Ext.isEmpty(n)&&"todo"===n[0].attributes.type}else if(o.lightMenu.isVisible()){var s=o.lightMenu.getSelectedRecords();i="todo"===s[0].get("type")}e.isVisible()||i?this.todoSearch():this.fullTextSearch({keyword:this.getValue()})},todoSearch:function(){var t=SYNO.SDS.NoteStation.Window.getMainPanel(),e=t.getNotebookPanel();t.hasTodoSearch=!0,e.fullMenu.isVisible()?e.fullMenu.selectTodoById("all"):e.lightMenu.isVisible()&&e.lightMenu.selectTodoById("all")},fullTextSearch:function(t){this.findAppWindow().getMainPanel().fullTextSearch(t)},getAdvSearchPanel:function(){return this.advSearchPanel||(this.advSearchPanel=new SYNO.SDS.NoteStation.FormPanel.AdvancedSearch({owner:this})),this.advSearchPanel},getMenu:function(){var t=this,e=this.getAdvSearchPanel();return this.menu||(this.menu=new SYNO.ux.Menu({items:[e]}),this.menu.on("beforeshow",function(){this.loadTags(),this.loadNotebook(),this.getForm().findField("keyword").setValue(t.getValue())},e),this.menu.on("beforehide",function(){t.setValue(this.getForm().findField("keyword").getValue())},e)),this.menu},hideMenu:function(){this.menu.hide()}}),Ext.define("SYNO.SDS.NoteStation.Mobile.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Mobile.Panel",this),this.owner=t.owner;var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e={items:[this.owner.getNotePanel(),this.owner.getEditorPanel()],activeItem:0,listeners:{activate:function(t){t.items.each(function(t){t.fireEvent("activate",t)},this)}}};return Ext.apply(e,t),e}}),Ext.define("SYNO.SDS.NoteStation.Todo.Editor.Panel",{extend:"SYNO.SDS.NoteStation.Operate.FormPanel",meKey:"orig",constructor:function(t){this.records=t.records,this.owner=t.owner,this.module=t.module,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e=[this.meKey,SYNO.SDS.NoteStation._T("common","different_values")],o=[[!0,SYNO.SDS.NoteStation._T("todo","completed")],[!1,SYNO.SDS.NoteStation._T("todo","uncompleted")]],i=[[-1,SYNO.SDS.NoteStation._T("todo","priority_no")],[100,SYNO.SDS.NoteStation._T("todo","priority_low")],[200,SYNO.SDS.NoteStation._T("todo","priority_medium")],[300,SYNO.SDS.NoteStation._T("todo","priority_high")]],n=[["none",SYNO.SDS.NoteStation._T("todo","off")],["ontime",SYNO.SDS.NoteStation._T("todo","on_time")],["30min","30 "+SYNO.SDS.NoteStation._T("todo","minute")],["1hour","1 "+SYNO.SDS.NoteStation._T("todo","hour")],["12hour","12 "+SYNO.SDS.NoteStation._T("todo","hour")],["1day","1 "+SYNO.SDS.NoteStation._T("todo","day")],["customized",SYNO.SDS.NoteStation._T("todo","customized")]];1<this.records.length&&(i.unshift(e),o.unshift(e),n.unshift(e));var s=this.getRagneStore(1,60),a={autoHeight:!0,items:[{xtype:"syno_combobox",name:"done",width:180,fieldLabel:_T("common","status"),store:o},{xtype:"syno_compositefield",items:[{xtype:"syno_todo_datetimefield",width:180,hideDateIcon:!1,name:"due_date",fieldLabel:SYNO.SDS.NoteStation._T("todo","due_time"),listeners:{scope:this,select:function(t,e){var o=this.getForm().findField("reminder_predefined");o.setDisabled(!1),SYNO.SDS.NoteStation.Utils.isNoDueDate(e)&&(o.setValue(SYNO.SDS.NoteStation._T("todo","off")),o.setDisabled(!0))}}},{xtype:"syno_checkbox",boxLabel:SYNO.SDS.NoteStation._T("common","different_values"),hidden:!(1<this.records.length),name:"due_date_me",listeners:{scope:this,check:function(t,e){var o=this.getForm(),i=o.findField("due_date");i.setDisabled(e);var n=o.findField("reminder_predefined");if(!0===e){var s=!0;Ext.each(this.records,function(t,e){if(SYNO.SDS.NoteStation.Utils.isNoDueDate(t.get("due_date")))return s=!1,!1},this),n.setDisabled(!s)}else!1===e&&SYNO.SDS.NoteStation.Utils.isNoDueDate(i.getValue())&&(n.setValue(SYNO.SDS.NoteStation._T("todo","off")),n.setDisabled(!0))}}}]},{xtype:"syno_combobox",name:"priority",width:180,fieldLabel:SYNO.SDS.NoteStation._T("todo","priority"),store:i},{xtype:"syno_compositefield",items:[{xtype:"syno_combobox",fieldLabel:SYNO.SDS.NoteStation._T("todo","reminder_time"),name:"reminder_predefined",width:180,store:n,listeners:{scope:this,select:function(t,e,o){var i=["reminder_value","reminder_unit"];this.disableComponent("customized"!==e.get("field1"),i)}}},{xtype:"syno_combobox",hideLabel:!0,name:"reminder_value",value:1,width:70,id:this.r_value=Ext.id(),store:s},{xtype:"syno_combobox",hideLabel:!0,name:"reminder_unit",value:"hour",width:100,id:this.r_unit=Ext.id(),store:[["min",SYNO.SDS.NoteStation._T("todo","minute")],["hour",SYNO.SDS.NoteStation._T("todo","hour")],["day",SYNO.SDS.NoteStation._T("todo","day")],["week",SYNO.SDS.NoteStation._T("todo","week")]],listeners:{scope:this,select:function(t,e,o){this.bindReminderValueStore(e.get("field1"))},afterrender:function(t){SYNO.ux.AddTip(t.getEl(),SYNO.SDS.NoteStation._T("setting","reminder_offset_desc"))}}}]}]};return Ext.apply(a,t),a},getRagneStore:function(t,e){for(var o=[],i=[],n=t;n<=e;n++)i=[n,n],o.push(i);return o},updateForm:function(t){var e,o,i,n,s=this.getForm(),a=s.findField("done"),r=s.findField("priority"),l=s.findField("due_date"),d=s.findField("due_date_me");if(1===t.length){var c=t[0];e=c.get("done"),o=c.get("priority"),n=c.get("due_date"),i=c.get("reminder_offset"),l.setValue(n),l.originalValue=l.getValue()}else e=o=i=this.meKey,d.setValue(!0),d.originalValue=d.getValue();a.setValue(e),a.originalValue=a.getValue(),r.setValue(o),r.originalValue=r.getValue(),this.applyToReminderSet(n,i),s.reset()},applyToReminderSet:function(t,e){var o,i,n,s,a,r=this.getForm();this.meKey===e?o=this.meKey:SYNO.SDS.NoteStation.Utils.isNoDueDate(t)?(o="none",r.findField("reminder_predefined").setDisabled(!0)):(a=SYNO.SDS.NoteStation.Utils.getReminderObject(e),o=a.predefined,i=a.unit,n=a.value,"customized"===o&&(s=r.findField("reminder_unit"),s.setValue(i),s.originalValue=s.getValue(),s=r.findField("reminder_value"),s.setValue(n),s.originalValue=s.getValue())),s=r.findField("reminder_predefined"),s.setValue(o),s.originalValue=s.getValue(),
this.disableComponent("customized"!==o,["reminder_unit","reminder_value"])},getReminderOffset:function(){var t,e,o=this.getForm(),i="none",n="hour",s=1;return t=o.findField("reminder_predefined"),e=t.findRecord(t.valueField,t.getValue()),e&&(i=e.get("field1")),this.meKey===i||"none"===i?-1:("customized"===i&&(t=o.findField("reminder_unit"),e=t.findRecord(t.valueField,t.getValue()),e&&(n=e.get("field1")),t=o.findField("reminder_value"),(e=t.findRecord(t.valueField,t.getValue()))&&(s=e.get("field1"))),SYNO.SDS.NoteStation.Utils.getReminderOffset(i,n,s))},disableComponent:function(t,e){var o=this.getForm();Ext.each(e,function(e,i,n){o.findField(e).setDisabled(t)},this)},bindReminderValueStore:function(t){var e=[];"min"==t?e=this.getRagneStore(1,60):"hour"==t?e=this.getRagneStore(1,24):"day"==t?e=this.getRagneStore(1,31):"week"==t&&(e=this.getRagneStore(1,4));var o=this.getForm(),i=o.findField("reminder_value");i.bindStore(e),i.setValue(1)}}),Ext.define("SYNO.SDS.NoteStation.Todo.Editor.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.owner=t.owner,this.records=t.records,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("window","todo_information"),width:640,autoHeight:!0,layout:"fit",items:this.getEditorFormPanel(),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onClickOk,scope:this}],scope:this,listeners:{beforeshow:this.onBeforeshow,scope:this}};return Ext.apply(e,t),e},getEditorFormPanel:function(){return Ext.isEmpty(this.editorFormPanel)&&(this.editorFormPanel=new SYNO.SDS.NoteStation.Todo.Editor.Panel({records:this.records,owner:this,module:this})),this.editorFormPanel},onBeforeshow:function(t){this.editorFormPanel.updateForm(this.records)},onClickOk:function(){var t=this.editorFormPanel.getForm();if(t.isDirty()){var e,o,i,n,s={},a=[];this.records.forEach(function(t){a.push(t.get("object_id"))}),s.object_id=a,e=t.findField("done"),e.isDirty()&&(s.done=e.getValue()),e=t.findField("priority"),e.isDirty()&&(s.priority=e.getValue()),e=t.findField("due_date"),1===this.records.length?e.isDirty()&&(s.due_date=SYNO.SDS.NoteStation.Utils.dateToEpoch(e.getValue())):1<this.records.length&&(t.findField("due_date_me").checked||(s.due_date=SYNO.SDS.NoteStation.Utils.dateToEpoch(e.getValue()))),e=t.findField("reminder_predefined"),i=t.findField("reminder_unit"),n=t.findField("reminder_value"),(e.isDirty()||i.isDirty()||n.isDirty())&&(s.reminder_offset=this.editorFormPanel.getReminderOffset(e.getValue(),i.getValue(),n.getValue())),Ext.isEmpty(s)||(o=SYNO.SDS.NoteStation.Utils.getTodoPanel().getActiveGrid(),SYNO.SDS.NoteStation.Todo.Common.setTodo(o,s))}this.close()},onClickCancel:function(){this.close()}}),Ext.define("SYNO.SDS.NoteStation.Todo.Menu.SortBy",{extend:"SYNO.ux.Menu",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={cls:"syno-ux-groupcheck-menu",items:[{text:SYNO.SDS.NoteStation._T("todo","due_date"),group:"sort_by",scope:this,itemId:"due_date",checked:!1,handler:this.switchTodoView},{text:SYNO.SDS.NoteStation._T("todo","priority"),group:"sort_by",scope:this,itemId:"priority",checked:!1,handler:this.switchTodoView},{text:SYNO.SDS.NoteStation._T("todo","reminder_time"),group:"sort_by",scope:this,itemId:"reminder_date",checked:!1,handler:this.switchTodoView},{text:SYNO.SDS.NoteStation._T("todo","note"),group:"sort_by",scope:this,itemId:"note_id",checked:!1,handler:this.switchTodoView},"-",{text:SYNO.SDS.NoteStation._T("sort","order_desc"),group:"sort_order",scope:this,itemId:"desc",checked:!1,handler:this.switchTodoOrder},{text:SYNO.SDS.NoteStation._T("sort","order_asc"),group:"sort_order",scope:this,itemId:"asc",checked:!1,handler:this.switchTodoOrder}],listeners:{scope:this,render:function(t){var e=t.findAppWindow(),o=e.appInstance.getUserSettings("todo_sort_by");o=Ext.isEmpty(o)?"due_date":o,t.getComponent(o).setChecked(!0);var i=e.appInstance.getUserSettings("todo_sort_order");i=Ext.isEmpty(i)?"asc":i,t.getComponent(i).setChecked(!0)}}};return Ext.apply(e,t),e},getSortBy:function(){var t;if(this.items.each(function(e){if("sort_by"===e.group&&e.checked)return t=e.itemId,!1},this),void 0===t){var e=this.findAppWindow();t=e.appInstance.getUserSettings("todo_sort_by")}return Ext.isEmpty(t)?"due_date":t},getSortOrder:function(){var t;if(this.items.each(function(e){if("sort_order"===e.group&&e.checked)return t=e.itemId,!1},this),void 0===t){var e=this.findAppWindow();t=e.appInstance.getUserSettings("todo_sort_order")}return Ext.isEmpty(t)?"asc":t},switchTodoView:function(t,e){var o=t.getItemId();SYNO.SDS.NoteStation.Utils.getTodoPanel().setActiveGrid(o,this.getSortOrder()),this.findAppWindow().appInstance.setUserSettings("todo_sort_by",o)},switchTodoOrder:function(t,e){var o=t.getItemId();SYNO.SDS.NoteStation.Utils.getTodoPanel().setActiveGrid(this.getSortBy(),o),this.findAppWindow().appInstance.setUserSettings("todo_sort_order",o)}}),Ext.define("SYNO.SDS.NoteStation.Todo.Menu.Filter",{extend:"SYNO.ux.Menu",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={cls:"syno-ux-groupcheck-menu",items:[{text:SYNO.SDS.NoteStation._T("todo","all_tasks"),group:"status",itemId:"status_all",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","completed"),group:"status",itemId:"completed",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","uncompleted"),group:"status",itemId:"uncompleted",checked:!1},"-",{text:SYNO.SDS.NoteStation._T("todo","all"),group:"priority",itemId:"priority_all",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","priority_high"),group:"priority",itemId:"high",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","priority_medium"),group:"priority",itemId:"medium",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","priority_low"),group:"priority",itemId:"low",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","priority_no"),group:"priority",itemId:"none",checked:!1},"-",{text:SYNO.SDS.NoteStation._T("todo","all"),group:"date",itemId:"date_all",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","today"),group:"date",itemId:"today",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","tomorrow"),group:"date",itemId:"tomorrow",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","overdue"),group:"date",itemId:"overdue",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","next_7_days"),group:"date",itemId:"next_7_days",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","next_30_days"),group:"date",itemId:"next_30_days",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","no_due_date"),group:"date",itemId:"no_due_date",checked:!1}],listeners:{scope:this,beforehide:this.onBeforeHide,render:this.onMenuRender}};return Ext.apply(e,t),e},onMenuRender:function(t){var e=this.findAppWindow(),o=e.appInstance.getUserSettings("todo_filter_status");o=Ext.isEmpty(o)?"uncompleted":o,t.getComponent(o).setChecked(!0);var i=e.appInstance.getUserSettings("todo_filter_priority");i=Ext.isEmpty(i)?"priority_all":i,t.getComponent(i).setChecked(!0);var n=e.appInstance.getUserSettings("todo_filter_date");n=Ext.isEmpty(n)?"date_all":n,t.getComponent(n).setChecked(!0)},onBeforeHide:function(t){return!!Ext.isEmpty(t.activeItem)||(this.switchTodoFilter(),!1)},getFilter:function(){var t,e,o={},i={};this.items.each(function(n){if(!n.hasOwnProperty("group"))return!0;if(!n.checked)return!0;if("status"===n.group)i.status=n.itemId,"completed"===n.itemId?o.done=!0:"uncompleted"===n.itemId&&(o.done=!1);else if("priority"===n.group){if(i.priority=n.itemId,"priority_all"===n.itemId)return!0;o.priority=[],o.priority.push(SYNO.SDS.NoteStation.Utils.getPriorityCode(n.itemId))}else if("date"===n.group){if(i.date=n.itemId,"date_all"===n.itemId)return!0;t=n.itemId,"today"===t||"tomorrow"===t||"next_7_days"===t||"next_30_days"===t?(e=SYNO.SDS.NoteStation.Utils.convertStringToDate("yesterday"),o.due_date_start=SYNO.SDS.NoteStation.Utils.dateToEpoch(e)+1,e=SYNO.SDS.NoteStation.Utils.convertStringToDate(t),o.due_date_end=SYNO.SDS.NoteStation.Utils.dateToEpoch(e)):"overdue"===t?(e=SYNO.SDS.NoteStation.Utils.convertStringToDate("yesterday"),o.due_date_end=SYNO.SDS.NoteStation.Utils.dateToEpoch(e)):"no_due_date"===t&&(o.due_date_start=-1,o.due_date_end=-1)}}),this.applyUserFilter(o,i);var n=SYNO.SDS.NoteStation.Window.getMainPanel(),s=n.searchField.getValue();return Ext.isEmpty(s)||(o.title=s),o},applyUserFilter:function(t,e){var o=this.findAppWindow();if(!e.hasOwnProperty("status")){var i=o.appInstance.getUserSettings("todo_filter_status");Ext.isEmpty(i)?t.done=!1:"completed"===i?t.done=!0:"uncompleted"===i&&(t.done=!1)}if(!e.hasOwnProperty("priority")){var n=o.appInstance.getUserSettings("todo_filter_priority");Ext.isEmpty(n)||"priority_all"!==n&&(t.priority=[],t.priority.push(SYNO.SDS.NoteStation.Utils.getPriorityCode(n)))}if(!e.hasOwnProperty("date")){var s,a=o.appInstance.getUserSettings("todo_filter_date");Ext.isEmpty(a)||("today"===a||"tomorrow"===a||"next_7_days"===a||"next_30_days"===a?(s=SYNO.SDS.NoteStation.Utils.convertStringToDate("yesterday"),t.due_date_start=SYNO.SDS.NoteStation.Utils.dateToEpoch(s)+1,s=SYNO.SDS.NoteStation.Utils.convertStringToDate(a),t.due_date_end=SYNO.SDS.NoteStation.Utils.dateToEpoch(s)):"overdue"===a?(s=SYNO.SDS.NoteStation.Utils.convertStringToDate("yesterday"),t.due_date_end=SYNO.SDS.NoteStation.Utils.dateToEpoch(s)):"no_due_date"===a&&(t.due_date_start=-1,t.due_date_end=-1))}},saveUserFilter:function(){var t=this.findAppWindow();this.items.each(function(e){return!e.hasOwnProperty("group")||(!e.checked||void("status"===e.group?t.appInstance.setUserSettings("todo_filter_status",e.itemId):"priority"===e.group?t.appInstance.setUserSettings("todo_filter_priority",e.itemId):"date"===e.group&&t.appInstance.setUserSettings("todo_filter_date",e.itemId)))})},switchTodoFilter:function(){var t=this.getFilter();SYNO.SDS.NoteStation.Utils.getTodoPanel().setActiveGridFilter(t),this.saveUserFilter()}}),Ext.define("SYNO.SDS.NoteStation.Todo.Menu.Priority",{extend:"SYNO.ux.Menu",record:null,constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={cls:"syno-ns-menu syno-ns-todo-menu-priority",items:[{iconCls:"priority-icon syno-ns-todo-menu-priority-none",itemId:"none",text:SYNO.SDS.NoteStation._T("todo","priority_no")},{iconCls:"priority-icon syno-ns-todo-menu-priority-low",itemId:"low",text:SYNO.SDS.NoteStation._T("todo","priority_low")},{iconCls:"priority-icon syno-ns-todo-menu-priority-medium",itemId:"medium",text:SYNO.SDS.NoteStation._T("todo","priority_medium")},{iconCls:"priority-icon syno-ns-todo-menu-priority-high",itemId:"high",text:SYNO.SDS.NoteStation._T("todo","priority_high")}],listeners:{itemclick:this.onSetMenuPriority.createDelegate(this)}};return Ext.apply(e,t),e},setRecord:function(t){this.record=t},onSetMenuPriority:function(t,e){var o,i=t.getItemId();o=SYNO.SDS.NoteStation.Utils.getPriorityCode(i),this.owner.fireEvent("setpriority",{record:this.record,priority:o})}}),Ext.define("SYNO.SDS.NoteStation.Todo.Menu.ReminderOffset",{extend:"SYNO.ux.Menu",record:null,constructor:function(t){this.owner=t.owner,this.lastCustomizedUnit="hour",this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={cls:"syno-ns-menu syno-ns-todo-menu-reminder syno-ux-groupcheck-menu",items:[{text:SYNO.SDS.NoteStation._T("todo","off"),group:"reminder_offset",itemId:"none",checked:!0},{text:SYNO.SDS.NoteStation._T("todo","on_time"),group:"reminder_offset",itemId:"ontime",checked:!0},{text:"30 "+SYNO.SDS.NoteStation._T("todo","minute"),group:"reminder_offset",itemId:"30min",checked:!1},{text:"1 "+SYNO.SDS.NoteStation._T("todo","hour"),group:"reminder_offset",itemId:"1hour",checked:!1},{text:"12 "+SYNO.SDS.NoteStation._T("todo","hour"),group:"reminder_offset",itemId:"12hour",checked:!1},{text:"1 "+SYNO.SDS.NoteStation._T("todo","day"),group:"reminder_offset",itemId:"1day",checked:!1},{text:SYNO.SDS.NoteStation._T("todo","customized"),group:"reminder_offset",itemId:"customized",checked:!1},{xtype:"syno_compositefield",itemId:"customized_set",cls:"syno-ns-todo-reminder-composite",items:[{xtype:"syno_combobox",width:100,value:1,id:this.customized_value=Ext.id(),store:this.getRangeStore(1,24)},{xtype:"syno_combobox",width:100,value:"hour",id:this.customized_unit=Ext.id(),store:[["min",SYNO.SDS.NoteStation._T("todo","minute")],["hour",SYNO.SDS.NoteStation._T("todo","hour")],["day",SYNO.SDS.NoteStation._T("todo","day")],["week",SYNO.SDS.NoteStation._T("todo","week")]],listeners:{scope:this,select:function(t,e,o){this.updateCustomizedValue(e.get("field1"))}}}]}],listeners:{itemclick:this.onItemClick.createDelegate(this),beforehide:this.onBeforeHide.createDelegate(this)}};return Ext.apply(e,t),e},setRecord:function(t){this.record=t},onBeforeHide:function(t){if(!Ext.isEmpty(t.activeItem)){var e=t.activeItem.itemId;if("customized"===e||"customized_set"===e)return!1}if(!0===Ext.getCmp(this.customized_value).isExpanded()||!0===Ext.getCmp(this.customized_unit).isExpanded())return!1;var o="none";Ext.each(t.items.items,function(t){if(t.checked)return o=t.itemId,!0},this);var i=this.getFromMenu(o);return this.owner.fireEvent("setreminderoffset",{record:this.record,reminderOffset:i}),!0},onItemClick:function(t,e){var o=t.getItemId();this.disableCustomizedCombo(o)},updateCustomizedValue:function(t){if(t!=this.lastCustomizedUnit){this.lastCustomizedUnit=t;var e;"min"===t?e=this.getRangeStore(1,60):"hour"===t?e=this.getRangeStore(1,24):"day"===t?e=this.getRangeStore(1,31):"week"===t&&(e=this.getRangeStore(1,8));var o=Ext.getCmp(this.customized_value);o.bindStore(e),o.getValue()>e.length&&o.setValue(1)}},getRangeStore:function(t,e){for(var o,i=[],n=[],s=t;s<=e;s++)o=SYNO.SDS.NoteStation.Utils.leadingZero(s),n=[s,o],i.push(n);return i},initValue:function(t){Ext.getCmp(this.customized_value).setValue(1),Ext.getCmp(this.customized_unit).setValue(SYNO.SDS.NoteStation._T("todo","hour")),this.updateCustomizedValue("hour"),this.applyToMenu(t)},disableCustomizedCombo:function(t){"customized"===t?(Ext.getCmp(this.customized_value).setDisabled(!1),Ext.getCmp(this.customized_unit).setDisabled(!1)):(Ext.getCmp(this.customized_value).setDisabled(!0),Ext.getCmp(this.customized_unit).setDisabled(!0))},getFromMenu:function(t){var e,o,i=t,n="hour",s=1;return"customized"===i&&(e=Ext.getCmp(this.customized_unit),o=e.findRecord(e.valueField,e.getValue()),o&&(n=o.get("field1")),e=Ext.getCmp(this.customized_value),(o=e.findRecord(e.valueField,e.getValue()))&&(s=o.get("field1"))),SYNO.SDS.NoteStation.Utils.getReminderOffset(i,n,s)},applyToMenu:function(t){var e=SYNO.SDS.NoteStation.Utils.getReminderObject(t),o=e.predefined,i=e.unit,n=e.value;"customized"===o&&(Ext.getCmp(this.customized_value).setValue(n),Ext.getCmp(this.customized_unit).setValue(i),this.updateCustomizedValue(i)),this.getComponent(o).setChecked(!0),this.disableCustomizedCombo(o)}}),Ext.define("SYNO.SDS.NoteStation.Todo.Menu.More",{extend:"SYNO.ux.Menu",note_id:"",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={cls:"syno-ns-menu syno-ns-todo-menu-more syno-ux-groupcheck-menu",items:[{text:SYNO.SDS.NoteStation._T("todo","add_a_new_task"),itemId:"add_a_task"},{text:SYNO.SDS.NoteStation._T("todo","delete_all_tasks"),itemId:"delete_all_tasks"}],listeners:{itemclick:this.onSetMenuMore,scope:this}};return Ext.apply(e,t),e},setNoteId:function(t){this.note_id=t},onSetMenuMore:function(t,e){var o=t.getItemId();if("add_a_task"===o)this.owner.fireEvent("addnotetask",{note_id:this.note_id});else if("delete_all_tasks"===o){var i,n,s=this.owner,a=Ext.isEmpty(this.note_id)?SYNO.SDS.NoteStation._T("todo","delete_independent_todo"):String.format(SYNO.SDS.NoteStation._T("todo","delete_note_todo"),Ext.util.Format.htmlEncode(s.noteTitle[this.note_id])),r=this.findAppWindow();i=r.getMsgBox(),n=a,i.confirmDelete("",n,function(t,e){"yes"===t&&this.owner.fireEvent("deletenotetask",{note_id:this.note_id})},this)}}}),Ext.define("SYNO.SDS.NoteStation.Todo.Menu.Context",{extend:"SYNO.ux.Menu",records:null,constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={items:[{text:SYNO.SDS.NoteStation._T("common","edit"),itemId:"edit_tasks"},{text:SYNO.SDS.NoteStation._T("common","delete"),itemId:"delete_task"},{text:SYNO.SDS.NoteStation._T("note","create_from_todo"),itemId:"create_note",menu:this.getNotebookMenu()}],listeners:{itemclick:this.onSetMenuContext,scope:this}};return Ext.apply(e,t),e},setRecords:function(t){this.records=t},onSetMenuContext:function(t,e){var o=t.getItemId();if("delete_task"===o)this.owner.handleDeleteTask();else if("edit_tasks"===o)this.getEditorWin().show();else if("create_note"===o)return!1},getEditorWin:function(){return(Ext.isEmpty(this.editorWin)||this.editorWin.isDestroyed)&&(this.editorWin=new SYNO.SDS.NoteStation.Todo.Editor.Window({records:this.records,owner:this.findAppWindow()})),this.editorWin},getNotebookMenu:function(){return new SYNO.ux.Menu({cls:"syno-ns-menu",listeners:{beforeshow:this.showNotebookMenu,scope:this}})},showNotebookMenu:function(t){var e=this.records,o=this.findAppWindow();SYNO.SDS.NoteStation.Utils.showNotebookMenu(t,o,function(t){return function(){SYNO.SDS.NoteStation.Todo.Common.convertTodoToNoteParam(e,function(e){var i={};Ext.copyTo(i,e,"content,brief,title,commit_msg"),o.mainPanel.createNote(t.id,i)})}})}}),Ext.define("SYNO.SDS.NoteStation.Todo.GridView.Base",{extend:"SYNO.ux.EditorGridPanel",type:"day",canLoadMore:!0,isLoadingData:!1,query_limit:100,menuPriority:null,menuReminderOffset:null,menuMore:null,menuContext:null,constructor:function(){this.uncompleteNoteId={},this.lastSelectedRowIndex=[],this.lastClickRowIndex=-1,this.noteTitle={},this.query_info={offset:0,limit:this.query_limit},this.groupNoteId=Ext.id(),this.scrollWidth=10,this.callParent(arguments),this.addListener("afterlayout",this.addIconClass,this)},updateDueDateWidth:function(t,e){if(Ext.isNumber(t)){if(t<24&&(t=24),t+=52,!0===e)return void(t>this._due_date_width&&this.adjustDueDateWidth(t));(!Ext.isNumber(this._due_date_width)||t>this._due_date_width)&&(this._due_date_width=t),this.adjustDueDateWidth(this._due_date_width)}},adjustDueDateWidth:function(t){var e,o,i,n=this;Ext.isNumber(t)&&(e=this.getColumnModel(),0!==(o=e.getColumnWidth(4)-t)&&(i=e.getColumnWidth(3)+o,window.clearTimeout(this._set_width_id),this._set_width_id=window.setTimeout(function(){e.setColumnWidth(4,t),e.setColumnWidth(3,i),n._set_width_id=null},12)))},reloadDueDateWidth:function(){this.view&&(this._due_date_width=null,Ext.iterate(this.view.getRows(),function(t){var e=t.querySelector(".syno-ns-todo-display-date");e&&this.updateDueDateWidth(Ext.util.TextMetrics.measure(e,e.textContent).width)},this))},resetSelectRecord:function(){this.lastSelectedRowIndex=[],this.lastClickRowIndex=0},createFillConfig:function(t){return this.type=t,this.addEvents("setstar","setpriority","setreminderoffset","addnotetask","deletenotetask","deletetasks"),this.menuContext=new SYNO.SDS.NoteStation.Todo.Menu.Context({owner:this}),this.menuMore=new SYNO.SDS.NoteStation.Todo.Menu.More({owner:this}),this.title_column_id="title",{hideHeaders:!0,clicksToEdit:1,colModel:this.createColModel(),selModel:this.createSelectModel(),plugins:this.checkColumn,autoExpandColumn:this.title_column_id,collapsible:!1,listeners:{setstar:SYNO.SDS.NoteStation.Todo.Common.onSetStar.createDelegate(this,{grid:this},!0),setpriority:SYNO.SDS.NoteStation.Todo.Common.onSetPriority.createDelegate(this,{grid:this},!0),setreminderoffset:SYNO.SDS.NoteStation.Todo.Common.onSetReminderOffset.createDelegate(this,{grid:this},!0),addnotetask:this.onAddNoteTask,deletenotetask:this.onDeleteNoteTask,deletetasks:this.onDeleteTasks,bodyscroll:this.onBodyScroll,resize:this.onGridResize,bodyresize:this.onBodyResize,groupclick:this.onGridGroupClick,rowcontextmenu:this.onGridRowContextMenu,afteredit:this.onGridAfteredit,beforeedit:this.onGridBeforeedit,afterrender:this.afterGridRender,show:this.onGridShow,destroy:this.onGridDestroy,mouseover:{fn:this.onGridMouseover,buffer:200,scope:this},mouseout:this.onGridMouseout,rowclick:this.switchEditTarget,cellclick:this.onCellClick,scope:this}}},onCellClick:function(t,e,o,i){var n,s=t.getColumnModel();n=s.getColumnAt(o),"due_date"===n.dataIndex&&(n.getCellEditor().show=function(){n.editor.showDateMenu(n.editor)})},createSelectModel:function(){return new Ext.grid.RowSelectionModel({single:!1,onEditorKey:Ext.emptyFn})},createColModel:function(){return this.checkColumn=new SYNO.ux.EnableColumn({header:"done",id:"check",dataIndex:"done",width:40,fixed:!0,align:"center",listeners:{click:SYNO.SDS.NoteStation.Todo.Common.onDoneClick,scope:this}}),this.divider=new Ext.grid.Column({id:"divider",dataIndex:"divider",scope:this,fixed:!0,width:1}),this.titleEditor=new SYNO.ux.TextField({cls:"syno-ns-todo-grid-titlefield",focusClass:"",allowBlank:!1,stripCharsRe:/(^\s+|\s+$)/g,listeners:{scope:this,afterrender:this.onTitleEditorAfterrender}}),new Ext.grid.ColumnModel({columns:[this.checkColumn,this.divider,{dataIndex:"star",id:"star",width:32,fixed:!0,renderer:this.renderTodoStar.createDelegate(this),listeners:{scope:this,click:function(t,e,o,i){var n=i.target.classList.contains("star-off");e.fireEvent("setstar",{record:e.getStore().getAt(o),star:n})}}},{dataIndex:"title",id:this.title_column_id,renderer:this.renderTodoTitle.createDelegate(this),listeners:{click:this.onTitleClick,scope:this},editor:this.titleEditor},this.createDueDateColumn(),this.createNoteColumn(),{dataIndex:"more",width:32,id:"more",fixed:!0,renderer:this.renderTodoMore.createDelegate(this),listeners:{scope:this,click:function(t,e,o,i){var n=this.getTodoPanel().todoEditPanel,s=e.getStore().getAt(o);n.isVisible()&&s.get("object_id")===n.record.get("object_id")?n.hide():n.show(),this.getTodoPanel().doLayout()}}},{dataIndex:"date_category",hidden:!0,groupRenderer:this.renderTodoGroupDateCategory.createDelegate(this)}]})},getTodoPanel:function(){return this.owner.owner.todoPanel},createDueDateColumn:function(){return{dataIndex:"due_date",id:"date",width:230,fixed:!0,renderer:this.renderTodoDueDate.createDelegate(this),editor:new SYNO.SDS.NoteStation.Todo.Component.DateTimeField({cls:"syno-ns-todo-datefield",owner:this})}},createNoteColumn:function(){var t={dataIndex:"note_id",id:"note",fixed:!0,width:32,listeners:{click:this.onNoteIconClick,scope:this}};return"note"===this.type?(t.hidden=!0,t.groupRenderer=this.renderTodoGroupNote.createDelegate(this)):(t.hidden=!0,t.renderer=this.renderTodoNote.createDelegate(this)),t},renderTodoStar:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation.Todo.Common.renderTodoStar(t,e,o,i,n,s)},renderTodoGroupDateCategory:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation._T("todo",t)},renderTodoGroupNote:function(t,e,o,i,n,s){var a;Ext.isEmpty(t)?a=SYNO.SDS.NoteStation._T("todo","independent_tasks"):(a=o.get("note_title"),Ext.isEmpty(a)&&(a=this.noteTitle[t]));var r=['<table class="x-grid3-row-table" border="0" cellspacing="0" cellpadding="0" style="width: {0}px;">',"<tbody>","<tr>",'<td class="x-grid3-col x-grid3-cell x-grid3-td-check x-grid3-cell-first">','<div class="x-grid-group-check syno-ux-grid-enable-column-{1}">&nbsp;</div>',"</td>",'<td class="x-grid3-td-divider">',"</td>",'<td class="x-grid3-col x-grid3-cell x-grid3-td-title">','<div class="x-grid-group-title x-grid-group-title-second">{2}</div>',"</td>",'<td class="x-grid3-col x-grid3-cell x-grid3-td-note">','<div class="x-grid-group-note x-grid-group-note-off" type="{3}">&nbsp</div>',"</td>",'<td class="x-grid3-col x-grid3-cell x-grid3-td-more">','<div class="x-grid-group-more x-grid-group-more-off">&nbsp</div>',"</td>","</tr>","</tbody>","</table>"].join(""),l=this.uncompleteNoteId.hasOwnProperty(t)?"unchecked":"checked",d=this.getWidth();return String.format(r,d-this.scrollWidth,l,Ext.util.Format.htmlEncode(a),Ext.isEmpty(t)?"indep":"note")},renderTodoNote:function(t,e,o,i,n,s){var a=Ext.isEmpty(t)?"off":"on";return String.format('<div class="syno-ns-todo-grid-note syno-ns-todo-grid-note-{0}"></div>',a)},renderTodoReminderOffset:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation.Todo.Common.renderTodoReminderOffset(t,e,o,i,n,s)},renderTodoMore:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation.Todo.Common.renderTodoMore(t,e,o,i,n,s,this)},renderTodoDueDate:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation.Todo.Common.renderTodoDueDate(t,e,o,i,n,s,this,!1)},renderTodoTitle:function(t,e,o,i,n,s){return SYNO.SDS.NoteStation.Todo.Common.renderTodoTitle(t,e,o,i,n,s)},getObjectIdByNoteId:function(t){var e=[];return this.getStore().each(function(o){t===o.get("note_id")&&e.push(o.get("object_id"))},this),e},getFirstRowIndexByNoteId:function(t){var e=this.getStore().find("note_id",t);return-1===e?0:e},jumpToNoteById:function(t){if(!Ext.isEmpty(t)){var e=this.getStore(),o=e.find("note_id",t),i=e.getAt(o).get("note_parent_id"),n=this.findAppWindow();n.selectNotebook(Ext.isEmpty(i)?"all":i),n.selectNote(t,"todo"),n.selectNote(t,"select")}},uniformStoreDataFormat:function(t,e){var o=e;return"due_date"===t&&(o=-1===e?new Date(-1e3):SYNO.SDS.NoteStation.Utils.epochToDate(e)),o},updateStoreByObjectId:function(t,e){var o=this.getStore().find("object_id",t);if(-1!==o){var i;for(var n in e)if(e.hasOwnProperty(n)){if("object_id"===n)continue;i=this.uniformStoreDataFormat(n,e[n]),this.getStore().getAt(o).set(n,i)}}},onGridRowContextMenu:function(t,e,o){var i=t.getSelectionModel();i.isSelected(e)||i.selectRow(e),this.menuContext.setRecords(i.getSelections()),this.menuContext.showAt(o.getXY())},onGridBeforeedit:function(t){if("title"===t.field){this.getColumnModel().getCellEditor(3,t.row).field.removeClass("syno-ns-todo-grid-titlefield-newtask")}},onGridAfteredit:function(t){var e={},o=[];if("title"===t.field){if(t.value.trim()===t.originalValue.trim())return;e={},o=[],o.push(t.record.get("object_id")),e.object_id=o,e.title=t.value.trim(),SYNO.SDS.NoteStation.Todo.Common.setTodo(this,e)}else if("due_date"===t.field){if(t.value=Ext.isEmpty(t.value)?new Date(-1e3):t.value,!0===Ext.isDate(t.originalValue)&&t.value.getTime()===t.originalValue.getTime())return;e={},o=[],o.push(t.record.get("object_id")),e.object_id=o,e.due_date=SYNO.SDS.NoteStation.Utils.dateToEpoch(t.value),SYNO.SDS.NoteStation.Todo.Common.setTodo(this,e)}this.reloadDueDateWidth()},afterGridRender:Ext.emptyFn,addIconClass:function(){this.body.select(".syno-ns-todo-grid-star").elements.forEach(function(t){var e=Ext.fly(t);e.addClassOnOver("icon-mouseover"),e.addClassOnClick("icon-click")}),this.body.select(".syno-ns-todo-grid-more").elements.forEach(function(t){var e=Ext.fly(t);e.addClassOnOver("icon-mouseover"),e.addClassOnClick("icon-click")})},onLoadStore:function(){this.addIconClass()},onUpdateStore:function(t,e,o){this.addIconClass.createDelegate(this).defer(100)},onAddStore:function(t,e,o){this.addIconClass.createDelegate(this).defer(100)},onGridDestroy:Ext.emptyFn,onGridShow:function(t){t.getView().refresh()},onGridMouseout:function(t){var e;if("note"===this.type&&(e=t.getTarget(".x-grid-group-hd"))){var o=Ext.get(e);if(t.within(o,!0))return;this.menuMore.getEl()&&this.menuMore.getEl().isVisible()||this.groupNoteHeaderHover(o,!1)}SYNO.SDS.NoteStation.Todo.Common.onGridMouseout(this,t,!0)},onGridMouseover:function(t){var e;if("note"===this.type&&(e=t.getTarget(".x-grid-group-hd"))){var o=Ext.get(e);this.groupNoteHeaderHover(o,!0)}SYNO.SDS.NoteStation.Todo.Common.onGridMouseover(this,t,!0)},switchEditTarget:function(t,e,o){if(this.getTodoPanel().todoEditPanel.isVisible()){var i=t.getStore().getAt(e);this.getTodoPanel().todoEditPanel.show(),this.getTodoPanel().todoEditPanel.loadRecord(i),this.getTodoPanel().doLayout()}},onGridRowClick:function(t,e,o){SYNO.SDS.NoteStation.Todo.Common.onGridRowClick(t,e,o)},onGridGroupClick:function(t,e,o,i){if("note"===this.type){var n=i.getTarget(".x-grid-group-more");if(n)return this.menuMore.showAt(i.getXY()),void this.menuMore.setNoteId(o);if(n=i.getTarget(".x-grid-group-note"))return void this.jumpToNoteById(o);if(n=i.getTarget(".x-grid-group-check")){var s=!1,a=Ext.get(n);a.hasClass("syno-ux-grid-enable-column-checked")?(a.removeClass("syno-ux-grid-enable-column-checked"),a.addClass("syno-ux-grid-enable-column-unchecked"),s=!1):(a.removeClass("syno-ux-grid-enable-column-unchecked"),a.addClass("syno-ux-grid-enable-column-checked"),s=!0);var r={},l=this.getObjectIdByNoteId(o);return r.object_id=l,r.done=s,void SYNO.SDS.NoteStation.Todo.Common.setTodo(this,r)}}},onBodyScroll:function(t,e){if(!1!==this.canLoadMore&&!0!==this.isLoadingData){var o=this.getView().scroller.dom.fleXdata;if(o&&!1!==o.scrollPosition[1][1]&&o.scrollPosition[1][1]===o.scrollPosition[1][0]){var i=this.owner.getFilter(),n=this.owner.getSortBy();"today"!==this.owner.currentTodoId&&"next_7_days"!==this.owner.currentTodoId&&"overdue"!==this.owner.currentTodoId||(i=SYNO.SDS.NoteStation.Todo.Common.getPredefinedFilter(this.owner.currentTodoId),n="due_date"),SYNO.SDS.NoteStation.Todo.Common.listTodo(this,!0,i,n,this.owner.getSortOrder())}}},onBodyResize:function(t,e,o){if(this.getView().layout(!0),"note"===this.type)for(var i,n=this.getWidth()-this.scrollWidth,s=this.getView().getGroups(),a=0;a<s.length;a++)i=Ext.get(s[a]),Ext.get(i.query(".x-grid3-row-table")[0]).setWidth(n)},onGridResize:function(t,e,o,i,n){SYNO.SDS.NoteStation.Utils.setEmptyTextLineHeight.call(this.getView(),Math.round(.9*o)),this.getView().refresh()},onAddNoteTask:function(t){var e=this.getFirstRowIndexByNoteId(t.note_id),o={};o.title=SYNO.SDS.NoteStation._T("todo","new_task"),o.note_id=0===e?"":t.note_id,SYNO.SDS.NoteStation.Todo.Common.addTodo(this,o,e,!0)},onDeleteNoteTask:function(t){var e=t.note_id,o={},i=this.getObjectIdByNoteId(e);o.object_id=i,SYNO.SDS.NoteStation.Todo.Common.deleteTodo(this,o)},onDeleteTasks:function(t){var e=t.records,o=[];Ext.each(e,function(t,e,i){o.push(t.get("object_id"))},this);var i={};i.object_id=o,SYNO.SDS.NoteStation.Todo.Common.deleteTodo(this,i)},onReminderOffsetIconClick:function(t,e,o,i){this.lastClickRowIndex=o;var n=this.getStore().getAt(o),s=n.get("due_date");SYNO.SDS.NoteStation.Utils.isNoDueDate(s)||(this.menuReminderOffset||(this.menuReminderOffset=new SYNO.SDS.NoteStation.Todo.Menu.ReminderOffset({owner:this})),this.menuReminderOffset.showAt(i.getXY()),this.menuReminderOffset.initValue(e.getStore().getAt(o).get("reminder_offset")),this.menuReminderOffset.setRecord(n))},onDeleteIconClick:function(t,e,o,i){var n,s,a={},r=this.getAppWin();this.lastClickRowIndex=o,a.object_id=[],a.object_id.push(this.getStore().getAt(o).get("object_id")),n=r.getMsgBox(),s=String.format(SYNO.SDS.NoteStation._T("todo","delete_todo"),a.object_id.length),n.confirmDelete("",s,function(t,e){"yes"===t&&SYNO.SDS.NoteStation.Todo.Common.deleteTodo(this,a)},this)},onPriorityIconClick:function(t,e,o,i){this.lastClickRowIndex=o,this.menuPriority||(this.menuPriority=new SYNO.SDS.NoteStation.Todo.Menu.Priority({owner:this})),this.menuPriority.showAt(i.getXY()),this.menuPriority.setRecord(this.getStore().getAt(o))},onNoteIconClick:function(t,e,o,i){var n=e.getStore().getAt(o).get("note_id");this.jumpToNoteById(n)},onTitleClick:function(t,e,o,i){this.lastClickRowIndex=o;var n=e.getStore().getAt(o).get("done");this.getColumnModel().getColumnById(this.title_column_id).getCellEditor().getEl().first()[n?"addClass":"removeClass"]("syno-ns-todo-grid-titlefield-disabled"),i.target.classList.contains("single-line-title")?t.editor.addClass("single-line-title"):t.editor.removeClass("single-line-title")},onTitleEditorAfterrender:function(t){this.titleEditor.getEl().on("contextmenu",function(t){t.preventDefault();var e=this.getSelectionModel();this.menuContext.setRecords(e.getSelections()),this.menuContext.showAt(t.getXY())},this)},getAppWin:function(){
return this.findAppWindow()},focusNewTask:function(t){var e=this.getColumnModel().getCellEditor(3,t);this.startEditing(t,3),e.field.selectText(),e.field.addClass("syno-ns-todo-grid-titlefield-newtask")},toggleDoneTask:function(){var t=this.getSelectionModel().getSelections();if(0!==t.length){var e=t.filter(function(t){return!t.get("done")}),o=[],i=!1;e.length>0?(o=e,i=!0):(o=t,i=!1);var n=o.map(function(t){return t.get("object_id")});SYNO.SDS.NoteStation.Todo.Common.setTodo(this,{object_id:n,done:i})}},handleDeleteTask:function(){var t=this.getSelectionModel().getSelections();if(0!==t.length){var e,o,i=this.findAppWindow();e=i.getMsgBox(),o=String.format(SYNO.SDS.NoteStation._T("todo","delete_todo"),t.length),e.confirmDelete("",o,function(e,o){"yes"===e&&this.onDeleteTasks({records:t})},this)}}}),Ext.define("SYNO.SDS.NoteStation.Todo.GridView.Note",{extend:"SYNO.SDS.NoteStation.Todo.GridView.Base",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e=this.createFillConfig("note"),o={enableDragDrop:!0,ddGroup:"syno-ns-todo-dd",store:this.createGroupingStore(),view:this.createGroupingView(),cls:"syno-ns-todo-grid syno-ns-todo-grid-note"};return Ext.apply(o,e),Ext.apply(o,t),o},createGroupingView:function(){return new SYNO.ux.GroupingView({itemId:"todo_view",markDirty:!1,trackResetOnLoad:!1,showGroupName:!1,getRowClass:SYNO.SDS.NoteStation.Todo.Common.newTaskColorStyle,processEvent:function(t,e){Ext.grid.GroupingView.superclass.processEvent.call(this,t,e);var o=e.getTarget(".x-grid-group-hd",this.mainBody);if(o){var i=this.getGroupField(),n=this.getPrefix(i),s=o.id.substring(n.length),a=new RegExp("gp-"+Ext.escapeRe(i)+"--hd");s=s.substr(0,s.length-3),(s||a.test(o.id))&&this.grid.fireEvent("group"+t,this.grid,i,s,e),"mousedown"===t&&0===e.button&&e.getTarget(".x-grid-group-title-second")&&this.toggleGroup(o.parentNode)}}})},createGroupingStore:function(){var t=SYNO.SDS.NoteStation.Todo.Common.createReader();return new Ext.data.GroupingStore({reader:t,remoteSort:!0,groupField:"note_id",listeners:{scope:this,add:this.onAddStore,load:this.onLoadStore,update:this.onUpdateStore}})},groupNoteHeaderHover:function(t,e){var o=Ext.get(t.query(".x-grid-group-more")[0]),i=Ext.get(t.query(".x-grid-group-note")[0]),n="note"===i.getAttribute("type");t[e?"addClass":"removeClass"]("x-grid-group-hd-over"),o[e?"removeClass":"addClass"]("x-grid-group-more-off"),o[e?"addClass":"removeClass"]("x-grid-group-more-on"),n&&(i[e?"removeClass":"addClass"]("x-grid-group-note-off"),i[e?"addClass":"removeClass"]("x-grid-group-note-on"))},afterGridRender:function(t){t.todoDropTarget||(t.todoDropTarget=new SYNO.SDS.NoteStation.TodoDropTarget(t,{ddGroup:"syno-ns-todo-dd"}))},onGridDestroy:function(){this.todoDropTarget&&this.todoDropTarget.removeFromGroup(this.ddGroup)}}),Ext.define("SYNO.SDS.NoteStation.TodoDropTarget",{extend:"Ext.dd.DropTarget",constructor:function(t,e){this.component=t,this.callParent([t.getEl(),this.fillConfig(e)])},fillConfig:function(t){var e={};return Ext.apply(e,t)},notifyDrop:function(t,e,o){for(var i=[],n=null,s=this.component.view.findRowIndex(e.getTarget()),a=0;a<o.selections.length;a++)i.push(o.selections[a].data.object_id);if(!1===s)for(var r=this.component.view.getGroups(),l=this.component.view.getGroupField(),d=this.component.view.getPrefix(l),c=0;c<r.length&&null===n;c++)for(var h=e.getTarget();!Ext.isEmpty(h);){if(h===r[c]){n=h.id.substring(d.length);break}h=h.parentNode}else n=this.component.store.getAt(s).data.note_id;if(null===n)return t.endDrag(),!1;var u={};return u.note_id=n,u.object_id=i,u.refresh=!0,SYNO.SDS.NoteStation.Todo.Common.setTodo(this.component,u),t.endDrag(),!0}}),Ext.define("SYNO.SDS.NoteStation.Todo.GridView.Day",{extend:"SYNO.SDS.NoteStation.Todo.GridView.Base",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e=this.createFillConfig("day"),o={store:this.createGroupingStore(),cls:"syno-ns-todo-grid syno-ns-todo-grid-day",view:new SYNO.ux.GroupingView({itemId:"todo_view",markDirty:!1,trackResetOnLoad:!1,getRowClass:SYNO.SDS.NoteStation.Todo.Common.newTaskColorStyle,showGroupName:!1})};return Ext.apply(o,e),Ext.apply(o,t),o},createGroupingStore:function(){var t=SYNO.SDS.NoteStation.Todo.Common.createReader();return new Ext.data.GroupingStore({reader:t,remoteSort:!0,groupField:"date_category",listeners:{scope:this,add:this.onAddStore,load:this.onLoadStore,update:this.onUpdateStore}})}}),Ext.define("SYNO.SDS.NoteStation.Todo.GridView.List",{extend:"SYNO.SDS.NoteStation.Todo.GridView.Base",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e=this.createFillConfig("list"),o={store:this.createStore(),cls:"syno-ns-todo-grid syno-ns-todo-grid-list",view:new SYNO.ux.FleXcroll.grid.GridView({itemId:"todo_view",markDirty:!1}),plugins:this.checkColumn};return Ext.apply(o,e),Ext.apply(o,t),o},createStore:function(){var t=SYNO.SDS.NoteStation.Todo.Common.createReader();return new Ext.data.Store({reader:t,remoteSort:!0,listeners:{scope:this,add:this.onAddStore,load:this.onLoadStore,update:this.onUpdateStore}})}}),Ext.define("SYNO.SDS.NoteStation.Todo.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Todo.Panel",this),this.owner=t.owner;var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e={};return e={cls:"syno-ns-todo-panel",listeners:{activate:function(){this.getTodoMainPanel().resetDateWidth()},scope:this},items:[this.getTodoMainPanel(),this.getTodoEditPanel()]},Ext.apply(e,t),e},getTodoMainPanel:function(){return Ext.isEmpty(this.todoMainPanel)&&(this.todoMainPanel=new SYNO.SDS.NoteStation.Todo.MainPanel({owner:this.owner,parent_panel:this,itemId:"todo_main_panel"})),this.todoMainPanel},getTodoEditPanel:function(){return Ext.isEmpty(this.todoEditPanel)&&(this.todoEditPanel=new SYNO.SDS.NoteStation.Todo.EditPanel({itemId:"todo_edit_panel",owner:this,width:346,hidden:!0,region:"east"})),this.todoEditPanel},listTodoPanel:function(t){this.todoMainPanel.listTodoPanel(t)},listPredefined:function(t){this.todoMainPanel.listPredefined(t)},getActiveGrid:function(){return this.todoMainPanel.getActiveGrid()},setActiveGrid:function(t,e){this.todoMainPanel.setActiveGrid(t,e)},setActiveGridFilter:function(t){this.todoMainPanel.setActiveGridFilter(t)},setStatusBusy:function(){this.el&&!this.el.isMasked()&&this.el.mask(SYNO.SDS.NoteStation._T("common","loading"),"x-mask-loading")},clearStatusBusy:function(){this.el&&this.el.unmask()},focusOnAddField:function(){if(!this.owner.isTodoPanelActive())return!1;this.getTodoMainPanel().focusOnAddField()},toggleEditorPanel:function(){if(this.owner.isTodoPanelActive()){var t=this.getTodoMainPanel().getActiveGrid().getSelectionModel().getSelections(),e=this.getTodoEditPanel();e.isVisible()||0===t.length?e.hide():(e.show(),e.loadRecord(t[0])),this.doLayout()}},toggleDoneSelected:function(){this.owner.isTodoPanelActive()&&this.getTodoMainPanel().getActiveGrid().toggleDoneTask()},deleteSelected:function(){this.owner.isTodoPanelActive()&&this.getTodoMainPanel().getActiveGrid().handleDeleteTask()}}),Ext.define("SYNO.SDS.NoteStation.Todo.MainPanel",{extend:"SYNO.ux.Panel",currentTodoId:"all",constructor:function(t){SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.Todo.MainPanel",this),this.owner=t.owner,this.parent_panel=t.parent_panel;var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e={};return e={tbar:this.createTBar(t),layout:"card",region:"center",cls:"syno-ns-todo-main-panel",items:[this.getTodoDayPanel(),this.getTodoNotePanel(),this.getTodoListPanel()],listeners:{scope:this,resize:this.onPanelResize}},Ext.apply(e,t),e},onPanelResize:function(){var t=this.getWidth()-300;this.getTopToolbar().getComponent("title").setWidth(t)},listTodoPanel:function(t){this.currentTodoId=t,this.setFilterText(this.getFilter()),this.setActiveGrid(this.getSortBy(),this.getSortOrder())},listPredefined:function(t){this.currentTodoId=t;var e=SYNO.SDS.NoteStation.Todo.Common.getPredefinedFilter(t);SYNO.SDS.NoteStation.Todo.Common.listTodo(this.getTodoDayPanel(),!1,e,"due_date","asc"),this.getLayout().setActiveItem("todo_day_panel")},setStatusBusy:function(){this.el&&!this.el.isMasked()&&this.el.mask(SYNO.SDS.NoteStation._T("common","loading"),"x-mask-loading")},clearStatusBusy:function(){this.el&&this.el.unmask()},createTBar:function(t){return new SYNO.ux.Toolbar({cls:"syno-ns-todo-toolbar",ctCls:"syno-ns-todo-toolbar-ct",height:36,autoWidth:!0,items:this.getAddTodoField()})},getAddTodoField:function(){var t=new SYNO.SDS.NoteStation.Todo.Component.DateTimeField({owner:this,height:34,width:10,itemId:"date",menuHideFocus:!1,editable:!1,cls:"syno-ns-todo-add-task-date"});return t.on("select",function(t,e){this.getTopToolbar().getComponent("title").focus(),t.triggerBlur(),this.resetDateWidth()},this),t.on("afterrender",this.resetDateWidth,this),[{xtype:"syno_textfield",width:39,readOnly:!0,cls:"syno-ns-todo-add-task-display",height:36,focusClass:""},{xtype:"syno_textfield",readOnly:!0,cls:"syno-ns-todo-add-task-divider",focusClass:""},{xtype:"syno_textfield",cls:"syno-ns-todo-add-task-text",focusClass:"",height:36,itemId:"title",stripCharsRe:/(^\s+|\s+$)/g,emptyText:SYNO.SDS.NoteStation._T("todo","click_add_task"),listeners:{scope:this,specialkey:function(t,e){e.getKey()==e.ENTER&&this.onAddTodoClick()}}},{xtype:"tbfill"},t,{xtype:"syno_button",iconCls:"syno-ns-todo-add-task-button-icon",height:36,cls:"syno-ns-todo-add-task-button",listeners:{scope:this,click:this.onAddTodoClick}}]},onAddTodoClick:function(t,e){var o=this.getTopToolbar(),i=o.getComponent("title").getValue().trim(),n=o.getComponent("date"),s=n.getValue();if(!Ext.isEmpty(i)&&n.isValid()){var a={};a.title=i,Ext.isEmpty(s)||(a.due_date=SYNO.SDS.NoteStation.Utils.dateToEpoch(s)),SYNO.SDS.NoteStation.Todo.Common.addTodo(this.getActiveGrid(),a,0,!1),this.resetToolbar()}},getTodoDayPanel:function(){return Ext.isEmpty(this.todoDayPanel)&&(this.todoDayPanel=new SYNO.SDS.NoteStation.Todo.GridView.Day({owner:this,itemId:"todo_day_panel"})),this.todoDayPanel},getTodoNotePanel:function(){return Ext.isEmpty(this.todoNotePanel)&&(this.todoNotePanel=new SYNO.SDS.NoteStation.Todo.GridView.Note({owner:this,itemId:"todo_note_panel"})),this.todoNotePanel},getTodoListPanel:function(){return Ext.isEmpty(this.todoListPanel)&&(this.todoListPanel=new SYNO.SDS.NoteStation.Todo.GridView.List({owner:this,itemId:"todo_list_panel"})),this.todoListPanel},getActiveGrid:function(){var t=this.getSortBy();return"priority"===t||"reminder_date"===t?this.getTodoListPanel():"note_id"===t?this.getTodoNotePanel():this.getTodoDayPanel()},setActiveGrid:function(t,e){var o,i=this.getFilter();"starred"===this.currentTodoId&&(i.star=!0),"priority"===t||"reminder_date"===t?(SYNO.SDS.NoteStation.Todo.Common.listTodo(this.getTodoListPanel(),!1,i,t,e),this.getLayout().setActiveItem("todo_list_panel"),o="priority"===t?SYNO.SDS.NoteStation._T("todo","priority"):SYNO.SDS.NoteStation._T("todo","reminder_time")):"note_id"===t?(SYNO.SDS.NoteStation.Todo.Common.listTodo(this.getTodoNotePanel(),!1,i,"note_id",e),this.getLayout().setActiveItem("todo_note_panel"),o=SYNO.SDS.NoteStation._T("todo","note")):(SYNO.SDS.NoteStation.Todo.Common.listTodo(this.getTodoDayPanel(),!1,i,"due_date",e),this.getLayout().setActiveItem("todo_day_panel"),o=SYNO.SDS.NoteStation._T("todo","due_date")),this.owner.getTopToolbar().getComponent("todo_sort_by").setText(o)},setActiveGridFilter:function(t){var e=this.getSortBy(),o=this.getSortOrder(),i=this.getActiveGrid();"starred"===this.currentTodoId&&(t.star=!0),SYNO.SDS.NoteStation.Todo.Common.listTodo(i,!1,t,e,o),i.getView().refresh(),i.getView().itemId=Ext.isObject(t)&&t.hasOwnProperty("title")?"todo_search":"todo_view",i.fireEvent("resize",i,i.getWidth(),i.getHeight()),this.setFilterText(t)},setFilterText:function(t){var e=SYNO.SDS.NoteStation._T("todo","all_tasks");t.hasOwnProperty("done")&&(e=t.done?SYNO.SDS.NoteStation._T("todo","completed"):SYNO.SDS.NoteStation._T("todo","uncompleted")),this.owner.getTopToolbar().getComponent("todo_filter").setText(e)},resetToolbar:function(){var t=this.getTopToolbar(),e=t.getComponent("date");e.reset(),e.trigger.setVisible(!0),t.getComponent("title").reset(),this.resetDateWidth()},getFilter:function(){return this.owner.todoMenuFilter.getFilter()},getSortBy:function(){return this.owner.todoMenuSortBy.getSortBy()},getSortOrder:function(){return this.owner.todoMenuSortBy.getSortOrder()},resetDateWidth:function(){var t=this.getTopToolbar().getComponent("date");t&&(t.getResizeEl().getWidth()!==t.getWidth()&&t.setWidth(t.getResizeEl().getWidth()),Ext.isEmpty(t.getValue())?t.setWidth(37):t.setWidth(180))},focusOnAddField:function(){this.getTopToolbar().getComponent("title").focus()}}),Ext.define("SYNO.SDS.NoteStation.Encrypt.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e]),this.notebookStore.loadData(this.getNotebookData())},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("window","note_encryption"),width:450,autoHeight:!0,layout:"fit",cls:"syno-ns-encrypt-win",items:this.getEncryptFormPanel(),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),scope:this,handler:this.onClickOk}],listeners:{beforeshow:function(){var t,e=this.findAppWindow();t=e.choosed.id in e.joined.notebook&&"rw"===e.joined.notebook[e.choosed.id].perm?e.choosed.id:Ext.isEmpty(e.owned.choosed)?e.owned.preset_id:e.owned.choosed,this.notebookComboBox.setValue(t)},scope:this}};return Ext.apply(e,t)},getEncryptFormPanel:function(){return this.notebookStore=new Ext.data.JsonStore({autoDestroy:!0,fields:["notebook_title","notebook_id"]}),this.notebookComboBox=new SYNO.ux.ComboBox({xtype:"syno_combobox",fieldLabel:SYNO.SDS.NoteStation._T("info","notebook"),store:this.notebookStore,displayField:"notebook_title",valueField:"notebook_id",name:"parent_id",mode:"local",scope:this}),this.joinedNotebookOwner=new SYNO.ux.DisplayField({hideLabel:!1,hidden:!0,htmlEncode:!0,fieldLabel:SYNO.SDS.NoteStation._T("category","notebook")}),this.encryptFormPanel=new SYNO.SDS.NoteStation.Operate.FormPanel({defaults:{enableKeyEvents:!0,listeners:{keyup:function(t,e){13===e.keyCode&&this.onClickOk()},scope:this}},items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("note","create_encrypt_desc")},this.joinedNotebookOwner,this.notebookComboBox,{xtype:"syno_textfield",fieldLabel:_T("common","password"),textType:"password",name:"pwd",allowBlank:!1,maxlength:32},{xtype:"syno_textfield",fieldLabel:SYNO.SDS.NoteStation._T("common","confirm_password"),textType:"password_confirm",confirmFor:"pwd",allowBlank:!1,maxlength:32}]}),this.encryptFormPanel},getEncryptBtn:function(){return SYNO.SDS.NoteStation.Window.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel").getTopToolbar().getComponent("encrypt_btn")},onClickCancel:function(){this.close()},onClickOk:function(){var t=this.findAppWindow(),e=t.getMainPanel(),o=this.encryptFormPanel.getForm();o.isValid()&&(e.createNote(this.notebookComboBox.getValue(),{encrypt:!0,pwd:o.findField("pwd").getValue()}),this.close())},getNotebookData:function(){var t,e=SYNO.SDS.NoteStation.Window,o=[];if(!Ext.isEmpty(e))return e.choosed.id in e.joined.notebook&&e.joined.notebook[e.choosed.id].owner in e.joined.owner&&"rw"===e.joined.notebook[e.choosed.id].perm?(t=e.joined.notebook[e.choosed.id].owner,this.joinedNotebookOwner.setValue(t+"/"+e.joined.notebook[e.choosed.id].title),this.joinedNotebookOwner.show(),this.notebookComboBox.hide(),Ext.iterate(e.joined.owner[t].notebook,function(t,i){"rw"===e.joined.notebook[t].perm&&o.push({notebook_title:Ext.util.Format.htmlEncode(e.joined.notebook[t].title),notebook_id:t})})):(this.notebookComboBox.show(),this.joinedNotebookOwner.hide(),Ext.iterate(e.owned.notebook,function(t,e){!0===e.owned&&!0!==e.archive&&o.push({notebook_title:Ext.util.Format.htmlEncode(e.title),notebook_id:e.id})},this)),o}}),Ext.define("SYNO.SDS.NoteStation.Client.PromptToast",{extend:"SYNO.ux.Panel",constructor:function(t){this.callParent([this.fillConfig(t)])},fillConfig:function(t){return Ext.apply({cls:"syno-ns-prompt-toast",width:328,floating:!0,shadow:!1,layout:"auto",items:[{border:!1,data:{},tpl:this.createContentTemplate()},{xtype:"container",layout:"hbox",height:40,layoutConfig:{align:"stretch"},items:[{xtype:"syno_checkbox",wrapCls:SYNO.ux.Checkbox.prototype.wrapCls+" syno-ns-prompt-checkbox",boxLabel:SYNO.SDS.NoteStation._T("prompt","do_not_show_again"),flex:1,scope:this,checked:!1,handler:this.onCheck}]}],listeners:{scope:this,afterrender:this.onAfterRender}},t)},createContentTemplate:function(){var t=SYNO.SDS.NoteStation._T;return new Ext.XTemplate('<div class="x-tool x-tool-close"></div>','<div class="syno-ns-prompt-wrapper">','<div class="syno-ns-prompt-icon"></div>','<div class="syno-ns-prompt-content">','<div class="syno-ns-prompt-tip">'+t("prompt","toast_title")+"</div>",'<span class="syno-ns-prompt-link"><a>'+t("prompt","toast_link")+"</a></span>","</div>","</div>")},onCheck:function(t,e){this.appWindow.appInstance.setUserSettings("hide_prompt_notify",e?SYNO.SDS.NoteStation.Define.NOTIFY_PROMPT_VERSION:0)},onAfterRender:function(){this.mon(this.el.child(".x-tool-close"),"click",this.hidePanel,this),this.mon(this.el.child(".syno-ns-prompt-link"),"click",this.onLinkClick,this)},slideIn:function(){this.el.alignTo(this.alignTargetEl,"br-br",[this.width,-16]),this.el.animate({opacity:{to:1,from:0},left:{by:-16-this.width,unit:"px"}},.5,this.slideInCb.bind(this),"easeOut")},slideInCb:function(){setTimeout(this.hidePanel.bind(this),5e3)},hidePanel:function(){!this.isDestroyed&&this.el&&this.el.animate({opacity:{to:0,from:1},left:{by:16+this.width,unit:"px"}},.5,this.slideOutCb.bind(this),"easeOut")},slideOutCb:function(){this.destroy()},onLinkClick:function(){return new SYNO.SDS.NoteStation.Client.Window({owner:this.appWindow}).show()}}),Ext.define("SYNO.SDS.NoteStation.Client.Window",{extend:"SYNO.SDS.ModalWindow",constructor:function(t){this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e=SYNO.SDS.NoteStation._T;return Ext.apply({cls:"syno-ns-prompt-window",width:658,height:438,closable:!0,resizable:!1,draggable:!1,useStatusBar:!1,items:[{xtype:"container",border:!1,data:{},cls:"syno-ns-prompt-download-title",tpl:this.createTitleTemplate()},{xtype:"container",border:!1,data:{},cls:"syno-ns-prompt-download-content",tpl:this.createContentTemplate()},{xtype:"container",cls:"syno-ns-download-btn-wrapper",itemId:"btn_wrapper",items:[{xtype:"syno_button",btnStyle:"blue",text:e("tinymce","download"),itemId:"download_btn",cls:"syno-ns-download-btn",iconCls:"syno-ns-download-btn-icon",handler:this.onDownloadClick,scope:this},{xtype:"container",border:!1,data:{},itemId:"fallback",tpl:this.createMessageTemplate(),hidden:!0}]}]},t)},getPlatform:function(){return!0===Ext.isWindows?"Windows":!0===Ext.isLinux?"Linux":!0===Ext.isMac?"Mac":"Unknown"},getBits:function(){var t=window.navigator.userAgent;return-1!==t.indexOf("Mac OS")?64:-1!==t.indexOf("WOW64")||-1!==t.indexOf("Win64")||-1!==t.indexOf(" x64")||"Win64"===window.navigator.platform?64:32},onDownloadClick:function(t){var e=this.getPlatform(),o=this.getBits(),i=-1===window.location.search.indexOf("note_client_debug=true")?"":"_QC";if(t.disable(),"Linux"===e||"Unknown"===e)return void window.open("https://www.synology.com/support/download","_blank");var n=SYNO.SDS.NoteStation.Define.isBeta,s="https://utyupdate.synology.com/getUpdate"+i+"/?identify=NoteStationClient&type=Installer&os="+e+"&bits="+o+"&include_beta="+(n?"1":"0");SYNO.SDS.Utils.IFrame.request(s,function(e){this.isDestroyed||"error"===e&&(this.setDownloadStatus(!0),t.enable())},this)},setDownloadStatus:function(t){var e=this.getComponent("btn_wrapper"),o=e.getComponent("fallback");t?o.show():o.hide()},createTitleTemplate:function(){var t=SYNO.SDS.NoteStation._T;return new Ext.XTemplate('<div class="syno-ns-download-title">'+t("prompt","panel_title")+"</div>",'<div class="syno-ns-download-desc">'+t("prompt","panel_desc")+"</div>")},createContentTemplate:function(){return new Ext.XTemplate('<div class="syno-ns-download-image"></div>')},createMessageTemplate:function(){var t=SYNO.SDS.NoteStation._T;return new Ext.XTemplate('<div class="syno-ns-download-msg">',"<span>",String.format(t("prompt","panel_error_msg"),'<a href="https://www.synology.com/support/download" target="_blank">'+t("prompt","download_center_link")+"</a>"),"</span>","</div>")}}),Ext.ns("SYNO.SDS.NoteStation.Setting"),Ext.define("SYNO.SDS.NoteStation.Setting.GeneralPanel",{extend:"SYNO.ux.FormPanel",constructor:function(t){this.owner=t.owner,this.module=t.module,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e;return this.fontSizeCombo=new SYNO.ux.ComboBox({fieldLabel:SYNO.SDS.NoteStation._T("setting","font_size"),allowBlank:!1,editable:!1,mode:"local",value:"x-small",store:[["xxx-small","8pt"],["xx-small","10pt"],["x-small","12pt"],["small","14pt"],["normal","16pt"],["large","18pt"],["x-large","24pt"],["xx-large","36pt"]],listeners:{afterrender:function(t){t.label.setStyle("width","230px"),t.label.setStyle("white-space","nowrap")}}}),this.desktopDesc=new SYNO.ux.DisplayField({value:SYNO.SDS.NoteStation._T("setting","desktop_desc")}),this.desktopButton=new SYNO.ux.Button({text:SYNO.SDS.NoteStation._T("setting","desktop_button"),handler:function(){new SYNO.SDS.NoteStation.Client.Window({owner:this.findAppWindow()}).show()},scope:this}),this.appPortalDesc=new SYNO.ux.DisplayField({value:""}),this.appPortalLink=new SYNO.ux.DisplayField({htmlEncode:!1,hidden:!0}),this.appPortalBtn=new SYNO.ux.Button({text:SYNO.SDS.NoteStation._T("setting","launch_app_portal"),hidden:!0,handler:function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",Ext.apply({fn:"SYNO.SDS.AdminCenter.Login.Main",tab:"applications"},this.findAppWindow().openConfig))},scope:this}),this.notificationBtn=new SYNO.ux.Button({text:_T("dsmnotify","title_setting"),hidden:!1,handler:function(){new SYNO.SDS.PersonalNotification.Window({owner:this.module,enableTest:!0,pkgName:"NoteStation"}).open()},scope:this}),this.copyDeleteOrig=new SYNO.ux.Checkbox({name:"copy_delete_orig",boxLabel:SYNO.SDS.NoteStation._T("setting","crypto_delete_orig")}),this.searchAttachment=new SYNO.ux.Checkbox({name:"search_attachment",boxLabel:SYNO.SDS.NoteStation._T("setting","search_attachment")}),this.spellCheck=new SYNO.ux.Checkbox({name:"spell_check",checked:!0,boxLabel:SYNO.SDS.NoteStation._T("setting","enable_spell_check")}),e={border:!1,frame:!1,autoScroll:!0,header:!1,useDefaultBtn:!1,title:SYNO.SDS.NoteStation._T("setting","general"),listeners:{activate:this.onActivate,deactivate:this.onDeactivate,scope:this},items:[{xtype:"syno_fieldset",title:SYNO.SDS.NoteStation._T("setting","view"),collapsible:!0,items:[this.fontSizeCombo]},{xtype:"syno_fieldset",title:SYNO.SDS.NoteStation._T("setting","note"),collapsible:!0,items:[this.copyDeleteOrig,this.searchAttachment,this.spellCheck]},{xtype:"syno_fieldset",title:SYNO.SDS.NoteStation._T("prompt","panel_title"),collapsible:!0,items:[this.desktopDesc,this.desktopButton]},{xtype:"syno_fieldset",title:SYNO.SDS.NoteStation._T("setting","app_portal"),collapsible:!0,items:[this.appPortalDesc,this.appPortalLink,this.appPortalBtn]},{xtype:"syno_fieldset",title:_T("dsmnotify","title_setting"),collapsible:!0,hidden:!0,items:[this.notificationBtn]}]},Ext.apply(e,t)},onActivate:function(){this.module.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!1,params:[{api:"SYNO.NoteStation.Setting",version:2,method:"get"},{api:"SYNO.NoteStation.Setting.DSM",version:1,method:"get"}]},callback:function(t,e){if(this.module.clearStatusBusy(),!t)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(this.findAppWindow(),e);this.handleNoteSetting(e.result[0].success,e.result[0].data||e.result[0].error),this.handleAppPortal(e.result[1].success,e.result[1].data||e.result[1].error),this.updateScroller()},scope:this})},onDeactivate:function(){},handleNoteSetting:function(t,e){t&&("font_size"in e&&(this.fontSizeCombo.setValue(e.font_size),this.fontSizeCombo.originalValue=e.font_size),"copy_delete_orig"in e&&(this.copyDeleteOrig.setValue(e.copy_delete_orig),this.copyDeleteOrig.originalValue=e.copy_delete_orig),"search_attachment"in e&&(this.searchAttachment.setValue(e.search_attachment),this.searchAttachment.originalValue=e.search_attachment),"spell_check"in e&&(this.spellCheck.setValue(e.spell_check),this.spellCheck.originalValue=e.spell_check))},handleAppPortal:function(t,e){if(!t||Ext.isEmpty(e)||Ext.isEmpty(e.app_portal))return this.appPortalLink.hide(),void(this._S("is_admin")?(this.appPortalDesc.setValue(SYNO.SDS.NoteStation._T("setting","app_portal_enable_desc")),this.appPortalBtn.setText(SYNO.SDS.NoteStation._T("setting","launch_app_portal")),this.appPortalBtn.show()):(this.appPortalDesc.setValue(SYNO.SDS.NoteStation._T("setting","app_portal_admin_desc")),this.appPortalBtn.hide()));this.appPortalDesc.setValue(SYNO.SDS.NoteStation._T("setting","app_portal_link_desc")),this.appPortalLink.setValue(this.makeAppPortalURL(e.app_portal)),this.appPortalLink.show(),this._S("is_admin")&&!0!==this._S("rewrite_mode")&&(this.appPortalBtn.setText(SYNO.SDS.NoteStation._T("common","edit")),this.appPortalBtn.show())},makeAppPortalURL:function(t){var e,o,i=[],n=!1,s='<a href="{0}" target="_blank"> {0} </a>';return Ext.isObject(t)?t.fqdn&&window.location.hostname.toLowerCase()===t.fqdn.toLowerCase()?(o=this.formCustomizedAppPortalURL(t),String.format(s,o)):(e=this.getDsmHost()||window.location.hostname,n=SYNO.SDS.NoteStation.Utils.isQuickConnectHost(e),"alias"in t&&(o="https://"+e+"/"+t.alias+"/",i.push(String.format(s,o))),n||("http_port"in t&&(o="http://"+e+":"+t.http_port,i.push(String.format(s,o))),"https_port"in t&&(o="https://"+e+":"+t.https_port,i.push(String.format(s,o)))),t.fqdn&&(o=this.formCustomizedAppPortalURL(t),i.push(String.format(s,o))),i.join("<br>")):""},formCustomizedAppPortalURL:function(t){var e=Ext.form.VTypes.netbiosName(t.fqdn)?"http":"https";return String.format("{0}://{1}",e,t.fqdn)},applyFormPromise:function(){var t=this;return this.fontSizeCombo.isDirty()||this.copyDeleteOrig.isDirty()||this.searchAttachment.isDirty()||this.spellCheck.isDirty()?new Promise(function(e,o){t.sendWebAPI({compound:{stopwhenerror:!1,params:[{api:"SYNO.NoteStation.Setting",version:2,method:"set",params:{font_size:t.fontSizeCombo.getValue(),copy_delete_orig:t.copyDeleteOrig.getValue(),search_attachment:t.searchAttachment.getValue(),spell_check:t.spellCheck.getValue()}},{api:"SYNO.NoteStation.Setting",version:2,method:"get"}]},callback:function(t,i){if(!t)return void o({text:SYNO.SDS.NoteStation._T("error","save")});e(i.result[1].data)},scope:t})}):Promise.resolve({})}}),Ext.ns("SYNO.SDS.NoteStation.Setting"),Ext.define("SYNO.SDS.NoteStation.Setting.ImportExportPanel",{extend:"SYNO.ux.FormPanel",constructor:function(t){this.owner=t.owner,this.module=t.module,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e,o=this;return this.importEvernoteBtn=new SYNO.ux.Button({text:SYNO.SDS.NoteStation._T("import","import_from_evernote"),disabled:_S("demo_mode"),handler:this.onClickImportEvernote,scope:this}),this.importEvernoteStatus=new Ext.form.Label({xtype:"label",text:"",hidden:!0,set_run_mode:function(t){o.importEvernoteStatus.setVisible(!t)}}),this.importEnexBtn=new SYNO.ux.Button({text:SYNO.SDS.NoteStation._T("import","import_from_enex"),disabled:!0,handler:function(){this.findAppWindow().getMainPanel().createImportNotebookWindow({file_extension:"enex",owner:this.module,module:this})},scope:this}),this.importEnexStatus=new Ext.form.Label({xtype:"label",text:"",hidden:!0,running_text:SYNO.SDS.NoteStation._T("import","importing"),set_run_mode:function(t){o.importEnexBtn.setDisabled(!t),o.importEnexStatus.setVisible(!t)}}),this.importNotebookBtn=new SYNO.ux.Button({text:SYNO.SDS.NoteStation._T("import","import_from_notebook"),disabled:!0,handler:function(){this.findAppWindow().getMainPanel().createImportNotebookWindow({owner:this.module,module:this})},scope:this}),this.importNotebookStatus=new Ext.form.Label({xtype:"label",text:"",hidden:!0,running_text:SYNO.SDS.NoteStation._T("import","importing"),set_run_mode:function(t){o.importNotebookBtn.setDisabled(!t),o.importNotebookStatus.setVisible(!t)}}),this.exportNotebookBtn=new SYNO.ux.Button({text:SYNO.SDS.NoteStation._T("export","notebook"),disabled:!0,handler:function(){this.findAppWindow().getMainPanel().createExportNotebookWindow({owner:this.module,module:this})},scope:this}),this.exportNotebookStatus=new Ext.form.Label({xtype:"label",text:"",hidden:!0,running_text:SYNO.SDS.NoteStation._T("export","exporting"),set_run_mode:function(t){o.exportNotebookBtn.setDisabled(!t),o.exportNotebookStatus.setVisible(!t)}}),e={owner:t.owner,module:t.module,border:!1,frame:!1,autoScroll:!0,header:!1,useDefaultBtn:!1,title:SYNO.SDS.NoteStation._T("setting","import_export"),listeners:{activate:this.onActivate,deactivate:this.onDeactivate,scope:this},items:[{xtype:"syno_fieldset",title:SYNO.SDS.NoteStation._T("setting","export_field"),collapsible:!0,items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("export","guideline")},this.exportNotebookBtn,this.exportNotebookStatus]},{xtype:"syno_fieldset",title:SYNO.SDS.NoteStation._T("setting","import_notebook"),collapsible:!0,items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("import","import_from_evernote_display")},this.importEvernoteBtn,this.importEvernoteStatus,{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("import","import_from_enex_display")},this.importEnexBtn,this.importEnexStatus,{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("import","import_from_notebook_display")},this.importNotebookBtn,this.importNotebookStatus]}]},Ext.apply(e,t)},onClickImportEvernote:function(){var t=this.findAppWindow(),e=t.getMainPanel();this.module.setStatusBusy(),this.stopPolling(),this.sendWebAPI({api:"SYNO.NoteStation.Import.Evernote",version:1,method:"get_status",callback:function(t,o){this.module.clearStatusBusy(),t&&(Ext.isEmpty(o.importing)?e.createImportEvernoteWindow({owner:this.module,module:this}):this.confirmImportEvernoteStop({owner:this.module,module:this}))},scope:this})},confirmImportEvernoteStop:function(t){var e=this.findAppWindow(),o=e.getMainPanel();e.getMsgBox().confirm(SYNO.SDS.NoteStation._T("import","cancel_import"),SYNO.SDS.NoteStation._T("import","confirm_cancel_import"),function(e,i){"yes"===e&&(this.module.setStatusBusy(),this.sendWebAPI({api:"SYNO.NoteStation.Import.Evernote",version:1,method:"import_stop",callback:function(e,i,n){this.module.clearStatusBusy(),e&&o.createImportEvernoteWindow(t)},scope:this}))},this)},onActivate:function(){this.startPolling()},startPolling:function(t){var e=this.findAppWindow();_S("demo_mode")||(this.pollId&&e.pollUnreg(this.pollId),Ext.isObject(t)&&(this.reload_evernote=this.reload_evernote||t.evernote,this.reload_enex_import=this.reload_enex_import||t.enex_import,this.reload_notebook_import=this.reload_notebook_import||t.notebook_import,this.reload_notebook_export=this.reload_notebook_export||t.notebook_export),this.module.setStatusBusy(),this.pollId=e.pollReg({webapi:{api:"SYNO.Entry.Request",version:1,method:"request",params:{compound:[{api:"SYNO.NoteStation.Import.Evernote",version:1,method:"get_status"},{api:"SYNO.NoteStation.Import.Notebook",version:1,method:"status"},{api:"SYNO.NoteStation.Export.Notebook",version:1,method:"status"},{api:"SYNO.NoteStation.Import.Enex",version:1,method:"status"}]}},immediate:!Ext.isObject(t),interval:3,status_callback:this.onStatusCallback,scope:this}))},onDeactivate:function(){
this.stopPolling()},stopPolling:function(){this.pollId&&(this.findAppWindow().pollUnreg(this.pollId),this.pollId=null)},updateEvernoteStatus:function(t,e){var o,i="";e.token<1||(19===e.last_error?i=SYNO.SDS.NoteStation._T("import","waiting")+"...":e.notebook_left>0?(i=SYNO.SDS.NoteStation._T("import","calculating")+"... ",e.notebook_count>0&&e.notebook_count>=e.notebook_left&&(o=100-Math.floor(100*e.notebook_left/e.notebook_count),i+=o+" %")):e.note_left>0?(i=SYNO.SDS.NoteStation._T("import","importing")+"... ",e.note_count>0&&e.note_count>=e.note_left&&(o=100-Math.floor(100*e.note_left/e.note_count),i+=o+" %")):0===e.notebook_left&&0===e.note_left&&this.reload_evernote&&(this.findAppWindow().getMainPanel().syncNow(),this.reload_evernote=!1)),Ext.isEmpty(i)?this.importEvernoteStatus.set_run_mode(!0):(this.importEvernoteStatus.set_run_mode(!1),t.setText(i))},updateNotebookStatus:function(t,e,o){var i,n="",s=new Date;if(!0===e.finish)return!0===this[o]&&(this.findAppWindow().getMainPanel().syncNow(),this[o]=!1),void("finish_time"in e.data&&6>Math.abs(s.getTime()/1e3-e.data.finish_time)?(t.set_run_mode(!1),t.setText(t.running_text+"... 100%")):t.set_run_mode(!0));i=Math.floor(100*e.data.current/e.data.total),i>=100&&(i=99),n=t.running_text+"... "+i+"%",t.set_run_mode(!1),t.setText(n)},onStatusCallback:function(t,e){if(this.isDestroyed)return this.findAppWindow().pollUnreg(this.pollId),!1;if(this.module.clearStatusBusy(),!t)return this.importEvernoteStatus.set_run_mode(!0),this.importEnexStatus.set_run_mode(!0),this.importNotebookStatus.set_run_mode(!0),void this.exportNotebookStatus.set_run_mode(!0);try{this.updateEvernoteStatus(this.importEvernoteStatus,e.result[0].data)}catch(t){this.importEvernoteStatus.set_run_mode(!0)}try{this.updateNotebookStatus(this.importNotebookStatus,e.result[1].data,"reload_notebook_import")}catch(t){this.importNotebookStatus.set_run_mode(!0)}try{this.updateNotebookStatus(this.exportNotebookStatus,e.result[2].data,"reload_notebook_export")}catch(t){this.exportNotebookStatus.set_run_mode(!0)}try{this.updateNotebookStatus(this.importEnexStatus,e.result[3].data,"reload_enex_import")}catch(t){this.importEnexStatus.set_run_mode(!0)}}}),Ext.ns("SYNO.SDS.NoteStation.Setting"),Ext.define("SYNO.SDS.NoteStation.Setting.TodoPanel",{extend:"SYNO.SDS.Utils.FormPanel",export_info_item:["done","star","priority","due_date","subtask","comment"],constructor:function(t){this.owner=t.owner,this.module=t.module,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={owner:t.owner,module:t.module,border:!1,frame:!1,autoScroll:!0,header:!1,useDefaultBtn:!1,method:"POST",title:SYNO.SDS.NoteStation._T("setting","todo_task"),webapi:{api:"SYNO.NoteStation.Setting",methods:{get:"get",set:"set"},version:2},listeners:{scope:this,render:function(){this.setStatusBusy(),this.load({scope:this,success:function(t,e){this.todoInitHandler(e.result.data),this.clearStatusBusy()}})}},items:this.getTodoFieldSetConfig()};return Ext.apply(e,t)},getTodoFieldSetConfig:function(){var t=this.getRagneStore(1,60);return[{xtype:"syno_fieldset",title:SYNO.SDS.NoteStation._T("setting","todo_general"),collapsible:!0,scope:this,items:[{xtype:"syno_combobox",fieldLabel:SYNO.SDS.NoteStation._T("setting","auto_purge"),name:"todo_purge",value:"none",width:160,store:[["none",SYNO.SDS.NoteStation._T("todo","off")],["1month","1 "+SYNO.SDS.NoteStation._T("todo","month")],["3month","3 "+SYNO.SDS.NoteStation._T("todo","month")],["6month","6 "+SYNO.SDS.NoteStation._T("todo","month")]],listeners:{scope:this,afterrender:function(t){SYNO.ux.AddWhiteTipWithMsg(t,SYNO.SDS.NoteStation._T("setting","auto_purge_desc"))}}},{xtype:"syno_combobox",fieldLabel:SYNO.SDS.NoteStation._T("setting","default_priority"),name:"todo_priority",value:"none",width:160,store:[[-1,SYNO.SDS.NoteStation._T("todo","priority_no")],[100,SYNO.SDS.NoteStation._T("todo","priority_low")],[200,SYNO.SDS.NoteStation._T("todo","priority_medium")],[300,SYNO.SDS.NoteStation._T("todo","priority_high")]]},{xtype:"syno_combobox",fieldLabel:SYNO.SDS.NoteStation._T("setting","default_due_date"),name:"todo_due_date_day",width:160,value:"none",store:[["none",SYNO.SDS.NoteStation._T("todo","off")],["today",SYNO.SDS.NoteStation._T("todo","today")],["tomorrow",SYNO.SDS.NoteStation._T("todo","tomorrow")],["1week","7 "+SYNO.SDS.NoteStation._T("todo","days_later")],["2week","14 "+SYNO.SDS.NoteStation._T("todo","days_later")]]},{xtype:"syno_compositefield",items:[{xtype:"syno_combobox",fieldLabel:SYNO.SDS.NoteStation._T("setting","default_reminder_offset"),name:"todo_reminder_predefined",value:"none",width:160,store:[["none",SYNO.SDS.NoteStation._T("todo","off")],["ontime",SYNO.SDS.NoteStation._T("todo","on_time")],["30min","30 "+SYNO.SDS.NoteStation._T("todo","minute")],["1hour","1 "+SYNO.SDS.NoteStation._T("todo","hour")],["12hour","12 "+SYNO.SDS.NoteStation._T("todo","hour")],["1day","1 "+SYNO.SDS.NoteStation._T("todo","day")],["customized",SYNO.SDS.NoteStation._T("todo","customized")]],listeners:{scope:this,select:function(t,e,o){var i=[this.r_value,this.r_unit];this.disableComponent("customized"!==e.get("field1"),i)}}},{xtype:"syno_combobox",hideLabel:!0,name:"todo_reminder_value",value:1,width:70,id:this.r_value=Ext.id(),store:t},{xtype:"syno_combobox",hideLabel:!0,name:"todo_reminder_unit",value:"hour",width:100,id:this.r_unit=Ext.id(),store:[["min",SYNO.SDS.NoteStation._T("todo","minute")],["hour",SYNO.SDS.NoteStation._T("todo","hour")],["day",SYNO.SDS.NoteStation._T("todo","day")],["week",SYNO.SDS.NoteStation._T("todo","week")]],listeners:{scope:this,select:function(t,e,o){this.bindReminderValueStore(e.get("field1"))},afterrender:function(t){SYNO.ux.AddWhiteTipWithMsg(t,SYNO.SDS.NoteStation._T("setting","reminder_offset_desc"))}}}]},{xtype:"syno_checkbox",name:"todo_show_badge",hidden:parseFloat(this.getDsmVersion(),10)<5.2,boxLabel:SYNO.SDS.NoteStation._T("setting","todo_show_badge")}]},{xtype:"syno_fieldset",title:SYNO.SDS.NoteStation._T("setting","todo_export_to_note"),collapsible:!0,scope:this,items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("setting","todo_export_info")},{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_checkbox",name:"export_info_title",width:180,boxLabel:SYNO.SDS.NoteStation._T("setting","todo_title"),checked:!0,disabled:!0},{xtype:"syno_checkbox",name:"export_info_star",boxLabel:SYNO.SDS.NoteStation._T("setting","todo_star")}]},{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_checkbox",name:"export_info_subtask",width:180,boxLabel:SYNO.SDS.NoteStation._T("setting","todo_subtask")},{xtype:"syno_checkbox",name:"export_info_priority",boxLabel:SYNO.SDS.NoteStation._T("setting","todo_priority")}]},{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_checkbox",name:"export_info_comment",width:180,boxLabel:SYNO.SDS.NoteStation._T("setting","todo_comment")},{xtype:"syno_checkbox",name:"export_info_due_date",boxLabel:SYNO.SDS.NoteStation._T("setting","todo_due_date")}]},{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_checkbox",name:"export_info_done",width:180,boxLabel:SYNO.SDS.NoteStation._T("setting","todo_done")}]}]}]},getExportInfoStore:function(){if(!this.exportInfoStore){var t=[["title",SYNO.SDS.NoteStation._T("setting","todo_title")],["done",SYNO.SDS.NoteStation._T("setting","todo_done")],["star",SYNO.SDS.NoteStation._T("setting","todo_star")],["priority",SYNO.SDS.NoteStation._T("setting","todo_priority")],["due_date",SYNO.SDS.NoteStation._T("setting","todo_due_date")],["subtask",SYNO.SDS.NoteStation._T("setting","todo_subtask")],["comment",SYNO.SDS.NoteStation._T("setting","todo_comment")]];this.exportInfoStore=new Ext.data.ArrayStore({autoDestroy:!0,fields:["value","display"],data:t})}return this.exportInfoStore},disableComponent:function(t,e){Ext.each(e,function(e,o,i){Ext.getCmp(e).setDisabled(t)},this)},bindReminderValueStore:function(t){var e=[];"min"==t?e=this.getRagneStore(1,60):"hour"==t?e=this.getRagneStore(1,24):"day"==t?e=this.getRagneStore(1,31):"week"==t&&(e=this.getRagneStore(1,8));var o=Ext.getCmp(this.r_value);o.bindStore(e),o.setValue(1)},getRagneStore:function(t,e){for(var o,i=[],n=[],s=t;s<=e;s++)o=SYNO.SDS.NoteStation.Utils.leadingZero(s),n=[s,o],i.push(n);return i},todoInitHandler:function(t){var e=[];"customized"!=t.todo_reminder_predefined&&(e=[this.r_value,this.r_unit],this.disableComponent(!0,e)),this.bindReminderValueStore(t.todo_reminder_unit),Ext.getCmp(this.r_value).setValue(t.todo_reminder_value);var o=this.getForm();this.export_info_item.forEach(function(e){var i=o.findField("export_info_"+e),n=0<=t.todo_export_info.indexOf(e);i.originalValue=n,i.reset()},this)},processReturnData:function(t,e,o){e.result.length<2||this.module.reloadSetting(this,e.result[1].data)},applyFormPromise:function(){var t=this.getForm();if(!1===this.onBeforeAction(t,"set"))return Promise.resolve({});var e=t.getValues(!1,"set"),o=this.constructApplyParams(e);return o=o.concat(this.getApiArray("get")),o=this.processParams("set",o),this._sendAjaxRequestPromsie("set",o).then(function(t){var e=t.success,o=t.data,i=t.code;return o.has_fail?Promise.reject({text:SYNO.SDS.NoteStation.Utils.getErrorStr(i)}):e?Promise.resolve(o.result[1].data):Promise.reject({text:SYNO.SDS.NoteStation._T("error","save")})})},processParams:function(t,e){if("set"===t){var o=["title"];this.export_info_item.forEach(function(t){var i="export_info_"+t;!0===e[0].params[i]&&o.push(t),delete e[0].params[i]},this),e[0].params.todo_export_info=o.join(",")}return e},reportLoadFail:function(t,e){this.setStatusError({text:SYNO.SDS.NoteStation._T("error","loadsetting_fail"),clear:!0})},reportFormSubmitFail:function(t,e){this.setStatusError({text:SYNO.SDS.NoteStation._T("error","save"),clear:!0})},_sendAjaxRequestPromsie:function(t,e){var o=this;return new Promise(function(i,n){var s=o.getAjaxCfg(t),a=o.getCompoundCfg(t),r=Ext.apply({fileUpload:!1,clientValidation:!1,compound:{stopwhenerror:!1,params:e},scope:o,callback:function(t,e,o){var n=0;e.has_fail&&Ext.iterate(e.result,function(t){try{return n=t.error.code,!1}catch(t){}}),i({success:t,data:e,req:o,code:n})}},s);r.compound=Ext.apply(r.compound,a),o.sendWebAPI(r)})}}),Ext.ns("SYNO.SDS.NoteStation.Setting"),Ext.define("SYNO.SDS.NoteStation.Setting.AdminPanel",{extend:"SYNO.SDS.Utils.FormPanel",changeVolMsg:String.format(SYNO.SDS.NoteStation._T("setting","moving_data"),""),constructor:function(t){this.owner=t.owner,this.module=t.module,this.callParent([this.fillConfig(t)])},fillConfig:function(t){this.share_mode=new SYNO.ux.Checkbox({name:"share_mode",boxLabel:SYNO.SDS.NoteStation._T("setting","share_mode")});var e={owner:t.owner,module:t.module,border:!1,frame:!1,autoScroll:!0,header:!1,useDefaultBtn:!1,method:"POST",title:SYNO.SDS.NoteStation._T("setting","admin"),listeners:{scope:this,activate:this.onActivate},items:[{xtype:"syno_fieldset",title:SYNO.SDS.NoteStation._T("setting","share"),scope:this,items:[this.share_mode]}]};return this.isSupportChangeVolume()&&e.items.unshift(this.volFieldSet=new SYNO.ux.FieldSet({hidden:!0,title:SYNO.SDS.NoteStation._T("tree","leaf_volume"),items:[this.volPath=new SYNO.ux.ComboBox({name:"vol_path",width:260,fieldLabel:SYNO.SDS.NoteStation._T("tree","leaf_volume"),store:this.volumeStore=new Ext.data.JsonStore({idProperty:"id",fields:["id","display","size_total_mb","vol_name","desc"]}),displayField:"display",valueField:"id"}),this.progress=new SYNO.ux.DisplayField({hidden:!0,ctCls:"syno-o-setting-email-desc",value:""})]})),Ext.apply(e,t)},fillffConfig:function(t){var e;return e={border:!1,frame:!1,autoScroll:!0,header:!1,useDefaultBtn:!1,title:SYNO.SDS.NoteStation._T("setting","admin"),listeners:{activate:this.onActivate,deactivate:this.onDeactivate,scope:this},items:[{xtype:"syno_fieldset",title:SYNO.SDS.NoteStation._T("setting","share"),collapsible:!0,items:[this.shareMode,this.searchAttachment]}]},Ext.apply(e,t)},onActivate:function(){this.setStatusBusy(),this.loadData()},loadData:function(){var t=[{api:"SYNO.NoteStation.Setting.Global",method:"get",version:1}];this.isSupportChangeVolume()&&t.push({api:"SYNO.NoteStation.Setting.Volume",method:"get_status",version:1},{api:"SYNO.Core.Storage.Volume",method:"list",version:1,params:{offset:0,limit:-1,location:"internal"}}),this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:t},callback:function(t,e){if(t&&!this.isDestroyed){this.clearStatusBusy();var o=SYNO.API.Response.GetValByAPI(e,"SYNO.NoteStation.Setting.Global","get");if(this.handleAdminSetting(o),this.isSupportChangeVolume()){for(var i=SYNO.API.Response.GetValByAPI(e,"SYNO.NoteStation.Setting.Volume","get_status"),n=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Storage.Volume","list").volumes,s=[],a=0;a<n.length;a++)s.push({id:n[a].volume_path,display:SYNO.SDS.Utils.StorageUtils.VolumeNameSizeRenderer(n[a])});if(1<s.length?this.volFieldSet.show():this.volFieldSet.hide(),this.volumeStore.loadData(s),this.volPath.setValue(o.vol_path),this.volPath.originalValue=o.vol_path,i.task_exist){this.startPollTask();var r=parseInt(i.count,10)/parseInt(i.total,10)*100;r=r.toFixed(0)+" %",this.volPath.disable(),this.progress.show(),this.progress.setValue(String.format(SYNO.SDS.NoteStation._T("setting","moving_data"),r))}i.error&&(this.progress.show(),this.progress.setValue(this.getVolStatusErrStr(i)))}}},scope:this})},getVolStatusErrStr:function(t){return String.format(SYNO.SDS.NoteStation._T("error","change_volume_fail"),SYNO.SDS.Utils.StorageUtils.VolumeNameRenderer({location:"internal",volume_path:t.target_vol}),SYNO.SDS.NoteStation.Utils.getErrorStr(t.error))},startPollTask:function(){this.getPollTask().start(!0)},stopPollTask:function(){this.getPollTask().stop()},getPollTask:function(){return this.pollTask||(this.pollTask=this.findAppWindow().addWebAPITask({interval:2e3,api:"SYNO.NoteStation.Setting.Volume",method:"get_status",version:1,scope:this,callback:function(t,e){if(this.isDestroyed)return void this.stopPollTask();t&&(this.isUpdateToMsgBox?this.updateToMsgBox(e):this.updateToLabel(e))}}))},updateToMsgBox:function(t){var e=0,o=0,i=0;if(!t.task_exist)return this.stopPollTask(),this.module.getMsgBox().hide(),void this.module.close();0!==t.error?(this.stopPollTask(),this.module.getMsgBox().hide(),this.module.getMsgBox().alert(SYNO.SDS.NoteStation._T("app","displayname"),this.getVolStatusErrStr(t),function(){this.module.close()},this)):(i=parseInt(t.total,10),o=parseInt(t.count,10),0!==i&&(e=(o/i*100).toFixed(0)),this.module.getMsgBox().updateProgress(e/100,e+" %",this.changeVolMsg))},updateToLabel:function(t){if(!t.task_exist)return this.stopPollTask(),this.volPath.enable(),void this.progress.hide();if(0!==t.error)this.stopPollTask(),this.progress.show(),this.progress.setValue(this.getVolStatusErrStr(t)),this.volPath.enable(),this.volPath.setValue(t.target_vol),this.volPath.originalValue=t.target_vol;else{var e=parseInt(t.count,10)/parseInt(t.total,10)*100;e=e.toFixed(0)+" %",this.progress.show(),this.progress.setValue(String.format(SYNO.SDS.NoteStation._T("setting","moving_data"),e)),this.volPath.disable(),this.volPath.setValue(t.vol_path)}},handleAdminSetting:function(t){if("share_mode"in t){var e="everyone"===t.share_mode;this.share_mode.setValue(e),this.share_mode.originalValue=e}},calcShareMode:function(t){return"admin"===t&&!0===this._S("is_admin")||"everyone"===t},volumeChanged:function(){return this.isSupportChangeVolume()&&this.volPath.isDirty()},applyFormPromise:function(){var t,e,o,i=this,n=!1;return this.isSupportChangeVolume()&&(n=!0),t=this.getForm(),!1===t.isDirty()?Promise.resolve({}):(e=!0===t.getValues().share_mode?"everyone":"admin",n&&this.volumeChanged()&&(this.isUpdateToMsgBox=!0,this.module.getMsgBox().show({title:SYNO.SDS.NoteStation._T("share","percentage"),wait:!1,progress:!0,progressText:"0 %",msg:this.changeVolMsg,scope:this})),o=[{api:"SYNO.NoteStation.Setting.Global",version:1,method:"set",params:{share_mode:e}},{api:"SYNO.NoteStation.Setting.Global",version:1,method:"get"}],n&&o.push({api:"SYNO.NoteStation.Setting.Volume",version:1,method:"set",params:{vol_path:t.getValues().vol_path}}),new Promise(function(t,e){i.sendWebAPI({compound:{stopwhenerror:!0,params:o},callback:function(o,i){if(!o)return n&&this.module.getMsgBox().hide(),this.module.getMsgBox().alert(SYNO.SDS.NoteStation._T("app","displayname"),SYNO.SDS.NoteStation.Utils.getErrorStr(SYNO.API.Util.GetFirstError(i))),void e({text:SYNO.SDS.NoteStation._T("error","save")});var s=SYNO.API.Response.GetValByAPI(i,"SYNO.NoteStation.Setting.Global","get");t({allow_share:this.calcShareMode(s.share_mode)}),n&&this.startPollTask()},scope:i})}))},isSupportChangeVolume:function(){return 14888<=parseInt(_S("version"),10)&&"yes"!==_D("usbstation","no")}}),Ext.ns("SYNO.SDS.NoteStation.Setting"),Ext.define("SYNO.SDS.NoteStation.Setting.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.owner=t.owner,this.module=t.module;var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("common","setting"),width:640,height:662,layout:"fit",cls:"syno-ns-setting-win",items:this.getSettingPanel(),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onClickOk,scope:this}],listeners:{afterrender:function(){this.module.stopImportStatus()},close:function(){this.module.checkImportStatus()},scope:this}};return Ext.apply(e,t)},getSettingPanel:function(){var t=[];return this.settingPanel?this.settingPanel:(this.general_panel=new SYNO.SDS.NoteStation.Setting.GeneralPanel({owner:this.owner,module:this}),this.import_export_panel=new SYNO.SDS.NoteStation.Setting.ImportExportPanel({owner:this.owner,module:this}),this.todo_panel=new SYNO.SDS.NoteStation.Setting.TodoPanel({owner:this.owner,module:this}),this.admin_panel=new SYNO.SDS.NoteStation.Setting.AdminPanel({owner:this.owner,module:this}),t=[this.general_panel,this.import_export_panel,this.todo_panel],this.applyPanel=[this.general_panel,this.todo_panel],!0===this._S("is_admin")&&(t.push(this.admin_panel),this.applyPanel.push(this.admin_panel)),this.settingPanel=new SYNO.ux.TabPanel({activeTab:0,items:t}),this.settingPanel)},onClickCancel:function(){this.close()},onClickOk:function(){this.admin_panel.volumeChanged()?(this.notClose=!0,this.getMsgBox().alert(SYNO.SDS.NoteStation._T("app","displayname"),SYNO.SDS.NoteStation._T("setting","confirm_move_volume"),function(){this.applySetting()},this)):this.applySetting()},applySetting:function(){var t=this;if(!this.settingPanel)return void this.close();this.setStatusBusy(),Promise.all(this.applyPanel.map(function(t){return t.applyFormPromise()})).then(function(e){var o={};e.forEach(function(t){Ext.apply(o,t)}),t.findAppWindow().reloadSettings(o),t.clearStatusBusy(),t.close()}).catch(function(e){t.clearStatusBusy(),t.setStatusError({text:e.text||SYNO.SDS.NoteStation._T("error","save"),clear:!0})})}}),Ext.define("SYNO.SDS.NoteStation.Smart.Panel",{extend:"SYNO.SDS.NoteStation.Operate.FormPanel",constructor:function(t){this.callParent([this.fillConfig(t)]),this.mon(Ext.getDoc(),"mousedown",this.onMouseDown,this)},onMouseDown:function(t){var e=this.datefromField,o=this.datetoField;this.handleHideDateField(t,e),this.handleHideDateField(t,o)},handleHideDateField:function(t,e){var o=e.menu;e&&e.menu&&(t.within(e.trigger)||t.within(this.getEl())&&!t.within(e.getEl())&&!t.within(o.getEl())&&o.isVisible()&&e.menuEvents("hide"))},getData:function(){var t=[],e=[],o={},i=this.getForm(),n=i.findField("smart_title").getValue(),s=i.findField("keyword").getValue(),a=i.findField("title").getValue(),r=i.findField("tag_operator").getValue()?"and":"or",l=i.findField("datetype").getValue(),d=i.findField("searchdatefrom").getValue(),c=i.findField("searchdateto").getValue();return Ext.isEmpty(s)||(o.keyword=s),Ext.isEmpty(a)||(o.title=a),Ext.iterate(this.tagSuperBox.getValueEx(),function(e,o){t.push(e.id)},this),Ext.iterate(this.notebookSuperBox.getValueEx(),function(t,o){e.push(t.id)},this),t.length>0&&(o.tag=t,Ext.isEmpty(r)||(o.tag_operator=r)),e.length>0&&(o.parent_id=e),""===d&&""===c||(d=""===d?0:d.getTime()/1e3,c=""===c?0:c.getTime()/1e3+86399,o[l+"_start"]=d,o[l+"_end"]=c),{title:n,query:o}},fillConfig:function(t){this.tagSuperBox=new SYNO.SDS.NoteStation.SuperBoxSelect({emptyText:void 0,store:new Ext.data.SimpleStore({fields:["tag","id"]}),displayField:"tag",itemCls:"syno-ns-smart-tag-item",listClass:"x-menu syno-ux-combobox-list syno-ns-smart-combobox-list",valueField:"id",listeners:{addItem:this.handleSuperBoxChange,removeItem:this.handleSuperBoxChange,afterrender:this.loadTags,scope:this}}),this.notebookSuperBox=new SYNO.ux.SuperBoxSelect({store:new Ext.data.SimpleStore({fields:["notebook","id"]}),mode:"local",name:"notebook_common",allowAddNewData:!0,displayField:"notebook",listClass:"x-menu syno-ux-combobox-list syno-ns-smart-combobox-list",valueField:"id",listeners:{addItem:this.handleSuperBoxChange,removeItem:this.handleSuperBoxChange,afterrender:this.loadNotebook,scope:this}}),this.datefromField=new SYNO.SDS.NoteStation.DateField({name:"searchdatefrom",emptyText:SYNO.SDS.NoteStation._T("search","date_from"),itemId:"searchdatefrom",listeners:{select:{fn:function(t,e){this.form.findField("searchdateto").setMinValue(e)},scope:this}}}),this.datetoField=new SYNO.SDS.NoteStation.DateField({name:"searchdateto",emptyText:SYNO.SDS.NoteStation._T("search","date_to"),itemId:"searchdateto",listeners:{select:{fn:function(t,e){this.form.findField("searchdatefrom").setMaxValue(e)},scope:this}}}),this.dateTypeField=new SYNO.ux.ComboBox({name:"datetype",triggerAction:"all",editable:!1,mode:"local",store:new Ext.data.SimpleStore({fields:["value","display"],data:[["mtime",SYNO.SDS.NoteStation._T("sort","by_mtime")],["ctime",SYNO.SDS.NoteStation._T("sort","by_ctime")]]}),displayField:"display",valueField:"value",lazyRender:!0,listClass:"x-menu syno-ux-combobox-list",value:"mtime"});var e={width:368,cls:"syno-ns-smart-panel",trackResetOnLoad:!0,defaults:{anchor:"100%",hideLabel:!0},items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("smart","title")+SYNO.SDS.NoteStation._T("common","colon"),flex:1},{xtype:"syno_textfield",name:"smart_title",allowBlank:!1,emptyText:SYNO.SDS.NoteStation._T("smart","create_message"),flex:2,value:""},{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("search","keyword")+SYNO.SDS.NoteStation._T("common","colon"),flex:1},{xtype:"syno_textfield",name:"keyword",flex:2,value:""},{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("search","title")+SYNO.SDS.NoteStation._T("common","colon"),flex:1},{xtype:"syno_textfield",name:"title",flex:2,value:""},{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("time","time_date")+SYNO.SDS.NoteStation._T("common","colon")},this.dateTypeField,{xtype:"syno_compositefield",hideLabel:!0,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[this.datefromField,this.datetoField]},{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("category","tag")+SYNO.SDS.NoteStation._T("common","colon")},this.tagSuperBox,{xtype:"syno_checkbox",boxLabel:SYNO.SDS.NoteStation._T("search","tag_operator"),itemCls:"syno-ns-smart-tag-operator-item",name:"tag_operator"},{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("category","notebook")+SYNO.SDS.NoteStation._T("common","colon")},this.notebookSuperBox]};return Ext.apply(e,t),e},loadTags:function(){var t=[],e={},o=SYNO.SDS.NoteStation.Window;this.tagSuperBox.items.each(function(t){t.value in o.tag||t.preDestroy()},this),Ext.iterate(this.tagSuperBox.getValueEx(),function(t,o){e[t.id]=!0},this),Ext.iterate(o.tag,function(o,i){i.id in e||t.push(new Ext.data.Record({tag:i.title,id:i.id}))},this),this.tagSuperBox.getStore().removeAll(),this.tagSuperBox.getStore().add(t)},loadNotebook:function(){var t=[],e={},o=this.owner.findAppWindow();this.notebookSuperBox.items.each(function(t){t.value in o.owned.notebook||t.preDestroy()},this),Ext.iterate(this.notebookSuperBox.getValueEx(),function(t,o){e[t.id]=!0},this),Ext.iterate(o.owned.notebook,function(o,i){i.id in e||t.push(new Ext.data.Record({notebook:i.title,id:i.id}))},this),this.notebookSuperBox.getStore().removeAll(),this.notebookSuperBox.getStore().add(t)},handleSuperBoxChange:function(){this.owner.doLayout()},setTags:function(t){var e=[];this.tagSuperBox.clearValue(),Ext.iterate(t,function(t){e.push({id:t,tag:t.substr(0,t.lastIndexOf("@"))})}),Ext.isEmpty(e)||(this.tagSuperBox.rendered?this.tagSuperBox.addItems(e):this.tagSuperBox.addListener("afterrender",function(){this.tagSuperBox.addItems(e)},this,{single:!0})),this.tagSuperBox.originalValue=this.tagSuperBox.getValue()},setTagOperator:function(t){var e="and"===t;this.getForm().findField("tag_operator").setValue(e),this.getForm().findField("tag_operator").originalValue=e},setNotebooks:function(t){var e=[],o=this.owner.findAppWindow();Ext.iterate(t,function(t){t in o.owned.notebook&&e.push({id:t,notebook:o.owned.notebook[t].title})}),Ext.isEmpty(e)?this.notebookSuperBox.clearValue():this.notebookSuperBox.rendered?this.notebookSuperBox.addItems(e):this.notebookSuperBox.addListener("afterrender",function(){this.notebookSuperBox.addItems(e)},this,{single:!0}),this.notebookSuperBox.originalValue=this.notebookSuperBox.getValue()},clearValue:function(){this.getForm().setValues({keyword:null,title:null}),this.getForm().clearInvalid(),this.datefromField.setMaxValue(null),this.datetoField.setMinValue(null),this.setTags(null),this.setTagOperator(null),this.setNotebooks(null)},isValidDate:function(t){return!(!Ext.isNumber(t)||0===t)},loadData:function(t,e){var o,i=this.getForm();this.clearValue(),Ext.isObject(e)&&(i.setValues(Ext.apply({smart_title:t},e)),Ext.isNumber(e.mtime_start)||Ext.isNumber(e.mtime_end)?o="mtime":(Ext.isNumber(e.ctime_start)||Ext.isNumber(e.ctime_end))&&(o="ctime"),Ext.isEmpty(o)||(this.dateTypeField.setValue(o),this.dateTypeField.originalValue=o,this.isValidDate(e[o+"_start"])&&this.datefromField.initValue(new Date(1e3*e[o+"_start"])),this.isValidDate(e[o+"_end"])&&this.datetoField.initValue(new Date(1e3*e[o+"_end"]))),this.setTags(e.tag),this.setTagOperator(e.tag_operator),this.setNotebooks(e.parent_id),i.clearInvalid())}}),Ext.define("SYNO.SDS.NoteStation.Smart.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={width:640,autoHeight:!0,layout:"fit",cls:"syno-ns-smart-win",items:[this.getSmartPanel(t)],buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onClickOk,scope:this}],listeners:{afterrender:function(){this.getSmartPanel().loadData(this.smart_title,this.query)},scope:this}};return Ext.apply(e,t)},getSmartPanel:function(t){return this.smartPanel||(this.smartPanel=new SYNO.SDS.NoteStation.Smart.Panel({owner:this,module:this})),this.smartPanel},onClickCancel:function(){this.close()},onClickOk:function(){var t,e,o=this.findAppWindow(),i=this.getSmartPanel();if(t=i.getForm(),t.isValid()){if(!t.isDirty())return void this.close();if(e=i.getData(),"{}"===Ext.encode(e.query))return void o.getMsgBox().alert("",SYNO.SDS.NoteStation._T("smart","query_empty"));"set"===this.action?(e.object_id=this.object_id,e.callback=this.afterEditSmart):"create"===this.action&&(e.callback=this.afterCreateSmart),e.scope=this,this.setStatusBusy(),o.getStorage()[this.action+"Smart"](e,this)}},afterCreateSmart:function(t,e){var o=this.findAppWindow();if(this.clearStatusBusy(),!1===t)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(o,e.code);this.close(),o.getStorage().listSmart({callback:function(t,e){o.onLoadAllData(!0,{smart:e.smart}),o.getMainPanel().getNotePanel().reloadData()},scope:this})},afterEditSmart:function(t,e){var o,i,n,s=this.findAppWindow();if(this.clearStatusBusy(),!0!==t)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(s,e.code);this.close(),o=s.getMainPanel().getNotebookPanel(),"full_menu"===o.layout.activeItem.itemId&&(o.updateNotebook(e.object_id,{title:e.title,text:e.title}),i=o.layout.activeItem,n=i.getSelectionModel().getSelectedNodes(),Ext.isArray(n)&&1===n.length&&(n=n[0],n.attributes.object_id in s.owned.smart&&i.selectNode(n)))}}),Ext.namespace("SYNO.SDS.NoteStation.ExportNotebook"),Ext.define("SYNO.SDS.NoteStation.ExportNotebook.Window",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){return this.owner=t.owner,this.exportConfig=new SYNO.SDS.NoteStation.ExportNotebook.Config({itemId:"export_config",owner:this,nextId:"export_target"}),this.exportTarget=new SYNO.SDS.NoteStation.ExportNotebook.Target({itemId:"export_target",owner:this,nextId:"export_notebook"}),this.exportNotebook=new SYNO.SDS.NoteStation.ExportNotebook.Panel({itemId:"export_notebook",owner:this,nextId:null}),Ext.apply({title:SYNO.SDS.NoteStation._T("export","export_wizard"),showHelp:!1,width:800,height:500,steps:[this.exportConfig,this.exportTarget,this.exportNotebook],activeStep:0},t)},startExport:function(){this.findAppWindow().getMainPanel().exportNotebook({object_id:this.choosed_notebooks,save_config:this.choosed_save_config,export_todo:this.export_todo,dest:this.choosed_share_path},function(t,e){t&&this.module.startPolling()},this),this.close()},setStatusBusy:function(t){this.el.mask(t||"","x-mask-loading")},clearStatusBusy:function(){this.el.unmask()}}),Ext.define("SYNO.SDS.NoteStation.ExportNotebook.Config",{extend:"SYNO.ux.FormPanel",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){return this.choose_btn=new SYNO.ux.Button({itemId:"ds_path_btn",text:_T("common","choose"),handler:function(){new SYNO.SDS.Utils.FileChooser.Chooser({owner:this.findAppWindow(),width:800,enumC2Share:!0,usage:{type:"chooseDir"},listeners:{choose:{fn:function(t,e,o){this.getForm().findField("share_path").setValue(e.path),t.close()}},scope:this}}).show()},scope:this}),Ext.apply({headline:SYNO.SDS.NoteStation._T("export","title"),description:SYNO.SDS.NoteStation._T("export","description"),items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("export","dest_desc")},{xtype:"syno_compositefield",fieldLabel:SYNO.SDS.NoteStation._T("export","dest"),items:[{xtype:"syno_textfield",itemId:"share_path",name:"share_path",readOnly:!0,value:"",allowBlank:!1},this.choose_btn]},{xtype:"syno_checkbox",name:"save_config",hidden:!0,boxLabel:SYNO.SDS.NoteStation._T("export","personal_config")}]},t)},activate:function(){this.getForm().findField("share_path").clearInvalid()},getNext:function(){var t=this.getForm();return!!t.isValid()&&(this.owner.choosed_share_path=t.findField("share_path").getValue(),this.owner.choosed_save_config=t.findField("save_config").getValue(),this.nextId)}}),Ext.define("SYNO.SDS.NoteStation.ExportNotebook.Target",{extend:"SYNO.ux.FormPanel",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){return Ext.apply({headline:SYNO.SDS.NoteStation._T("export","title"),description:SYNO.SDS.NoteStation._T("export","description"),items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("export","target_desc")},{xtype:"syno_checkbox",name:"export_notebook",boxLabel:SYNO.SDS.NoteStation._T("export","target_notebook")},{xtype:"syno_checkbox",name:"export_todo",boxLabel:SYNO.SDS.NoteStation._T("export","todo_list")}]},t)},getNext:function(){var t=this.getForm();return this.owner.export_notebook=t.findField("export_notebook").getValue(),this.owner.export_todo=t.findField("export_todo").getValue(),this.owner.export_notebook||this.owner.export_todo?this.owner.export_notebook?this.nextId:(this.owner.startExport(),
null):(this.owner.getMsgBox().alert("",SYNO.SDS.NoteStation._T("error","export_no_select_target")),!1)}}),Ext.define("SYNO.SDS.NoteStation.ExportNotebook.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){this.grid=new SYNO.SDS.NoteStation.ExportNotebook.Notebook({owner:this});var e={headline:SYNO.SDS.NoteStation._T("export","select_notebook"),description:SYNO.SDS.NoteStation._T("export","select_notebook_desc"),items:[this.grid]};return Ext.apply(e,t)},getNext:function(){var t=[];return Ext.iterate(this.grid.getChoosedNotebook(),function(e,o){o&&t.push(e)}),0===t.length?(this.owner.setStatusError({text:SYNO.SDS.NoteStation._T("error","export_no_select_notebook")}),!1):(this.owner.choosed_notebooks=t,this.owner.startExport(),this.nextId)},activate:function(){this.grid.clearChoosedNotebook()}}),Ext.define("SYNO.SDS.NoteStation.ExportNotebook.Notebook",{extend:"SYNO.ux.GridPanel",itemPerPage:50,constructor:function(t){this.owner=t.owner,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e,o=this.findAppWindow();this.clearChoosedNotebook(),e=new SYNO.API.Store({autoDestroy:!0,autoLoad:!0,appWindow:this,api:"SYNO.NoteStation.Notebook",method:"list",version:1,baseParams:{limit:this.itemPerPage,filter:{owner:o.owner_uid}},reader:new Ext.data.JsonReader({totalProperty:"total",idProperty:"object_id",root:"notebooks"},["checked","object_id","title","ctime","mtime"]),listeners:{load:function(t,e,o){Ext.each(e,function(t){this.choosed_notebooks[t.data.object_id]&&t.set("checked",this.choosed_notebooks[t.data.object_id])},this)},update:function(t,e,o){this.choosed_notebooks[e.data.object_id]=e.data.checked},scope:this}});var i=new SYNO.ux.EnableColumn({header:"",dataIndex:"checked",disableSelectAll:!1,sortable:!1,hideable:!1,menuDisabled:!0,width:120,align:"center",cls:"without-dirty-red-grid",toggleRec:function(t){SYNO.ux.EnableColumn.prototype.toggleRec.call(this,t),!0!==t.data.checked&&t.commit()}}),n=new Ext.grid.ColumnModel({defaults:{width:120,sortable:!0},columns:[i,{header:SYNO.SDS.NoteStation._T("export","notebook_title"),dataIndex:"title",width:200,renderer:function(t,e,o,i,n,s){return Ext.isEmpty(t)&&(t=SYNO.SDS.NoteStation._T("notebook","default")),Ext.util.Format.htmlEncode(t)}},{header:SYNO.SDS.NoteStation._T("export","ctime"),dataIndex:"ctime",width:200,renderer:function(t,e,o,i,n,s){return'<font class="syno-ns-info-mtime">'+new Date(1e3*t).format("y-m-d H:i:s")+"</font>"}},{header:SYNO.SDS.NoteStation._T("export","mtime"),dataIndex:"mtime",width:200,renderer:function(t,e,o,i,n,s){return'<font class="syno-ns-info-mtime">'+new Date(1e3*t).format("y-m-d H:i:s")+"</font>"}}]});return this.paging=new SYNO.ux.PagingToolbar({store:e,pageSize:this.itemPerPage,displayInfo:!0}),Ext.apply({width:720,height:321,colModel:n,store:e,plugins:[i],bbar:this.paging},t)},clearChoosedNotebook:function(){this.choosed_notebooks={}},getChoosedNotebook:function(){return this.choosed_notebooks}}),Ext.namespace("SYNO.SDS.NoteStation.ImportNotebook"),Ext.define("SYNO.SDS.NoteStation.ImportNotebook.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.module=t.module,this.owner=t.owner,this.appWin=this.findAppWindow(),this.callParent([this.fillConfig(t||{})]),this.createFileInputFromPC(t)},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("import","import_from_notebook"),width:600,height:500,cls:"syno-ns-add-file-win",items:[this.getFileUploadFormPanel(t)],layout:"fit",buttons:[{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.onClickCancel},{xtype:"syno_button",btnStyle:"blue",text:_T("common","ok"),handler:this.onClickOk,scope:this}]};return Ext.apply(e,t)},createFileInputFromDS:function(t){new SYNO.SDS.Utils.FileChooser.Chooser({owner:this,width:800,enumC2Share:!0,usage:{type:"open",multiple:!0},getFilterPattern:function(e){return t.file_extension||"nsx"},listeners:{choose:{fn:function(t,e,o){this.handleFileSelectFromDS(e),t.close()}},scope:this}}).show()},createFileInputFromPC:function(t){var e,o=this.fileUploadFormPanel.getTopToolbar();this.fromPCBtn&&(this.mun(this.fromPCBtn.getEl(),"change"),e=Ext.get(this.fileUploadFormPanel.getForm().getEl().query("div")[0]),this.fromPCBtn.getEl().insertAfter(e),this.fromPCBtn.hide()),this.fromPCBtn=new SYNO.ux.FileButton({name:Ext.id(void 0,"file_"),buttonText:SYNO.SDS.NoteStation._T("upload","from_pc"),buttonOnly:!0}),o.add(this.fromPCBtn),o.doLayout(),this.fromPCBtn.getEl().set({multiple:!0,accept:"."+(t.file_extension||"nsx")},!0),this.mon(this.fromPCBtn.getEl(),"change",this.handleFileSelectFromPC.createDelegate(this,[t],!0),this)},handleFileSelectFromDS:function(t){var e=this.fileUploadFormPanel.getComponent("upload_file_grid");if(Ext.isEmpty(t.records)){var o=t.path.substr(t.path.lastIndexOf("/")+1),i=new Ext.data.Record({name:o,filename:o,sharepath:t.path,selectfrom:"ds"});e.getStore().add(i)}else Ext.each(t.records,function(t){var o=new Ext.data.Record({name:t.get("filename"),filename:t.get("filename"),filesize:Ext.util.Format.fileSize(t.get("filesize")),sharepath:t.get("path"),selectfrom:"ds"});e.getStore().add(o)})},handleFileSelectFromPC:function(t,e,o,i){var n=!1,s=this.fileUploadFormPanel.getComponent("upload_file_grid"),a="."+(i.file_extension||"nsx");if(SYNO.SDS.HTML5Utils.isSupportHTML5Upload()){var r=t.target.files;Ext.each(r,function(t){if(!1===t.name.endsWith(a))return n=!0,!1;s.getStore().add(new Ext.data.Record({inputElm:this,name:Ext.id(void 0,"file_upload_"),filename:t.name,filesize:Ext.util.Format.fileSize(t.size),fileObj:t,selectfrom:"pc"}))},e)}else{var l,d=e.getValue(),c=/fakepath\\(.+)$/.exec(d);if(l=null!==c?c[1]:d,Ext.isEmpty(l))return;!1===l.endsWith(a)?n=!0:s.getStore().add(new Ext.data.Record({inputElm:e,name:e.getAttribute("name"),filename:l,filesize:"",fileObj:null,selectfrom:"pc"}))}if(!0===n)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(this.findAppWindow(),1063);this.createFileInputFromPC(i)},getFileUploadFormPanel:function(t){var e;return e={xtype:"syno_button",text:SYNO.SDS.NoteStation._T("upload","from_ds"),scope:this,handler:function(){this.createFileInputFromDS(t)}},this.fileUploadFormPanel=new SYNO.SDS.NoteStation.ImportNotebook.UploadPanel({owner:this.owner,module:this.module,title:SYNO.SDS.NoteStation._T("upload","upload_file"),tbar:[e],itemId:"upload_file_form"}),this.fileUploadFormPanel},getAttachment:function(){var t=[];return this.fileUploadFormPanel.getComponent("upload_file_grid").getStore().each(function(e){var o={name:e.get("name")};Ext.isEmpty(e.get("fileObj"))?(o.format="ds",o.path=e.get("sharepath")):(o.format="raw",o.source=e.get("fileObj")),t.push(o)},this),t},closeModalWindow:function(){this.close()},onClickCancel:function(){this.closeModalWindow()},onClickOk:function(){this.uploadFile()},uploadFile:function(){var t,e=[];if(this.setStatusBusy(),e=this.getAttachment(),Ext.isEmpty(e))return this.clearStatusBusy(),void this.closeModalWindow();t={file:e},SYNO.SDS.HTML5Utils.isSupportHTML5Upload()||(t.form=this.fileUploadFormPanel.getForm()),t.file_extension=this.file_extension,this.appWin.getMainPanel().importNotebook(t,function(t,e){if(this.clearStatusBusy(),this.closeModalWindow(),t){var o="notebook_import";"enex"===this.file_extension&&(o="enex_import");var i={};i[o]=!0,this.module.startPolling(i)}},this)}}),Ext.define("SYNO.SDS.NoteStation.ImportNotebook.UploadPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(t){this.module=t.module,this.owner=t.owner,this.appWin=this.findAppWindow(),this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={bodyStyle:"padding: 0",webapi:{api:"SYNO.NoteStation.Import.Notebook",version:1,method:"start"},fieldWidth:250,labelWidth:100,fileUpload:!0,layout:{type:"vbox",align:"stretch"},items:[{xtype:"syno_editorgrid",itemId:"upload_file_grid",cls:"syno-ns-tinymce-fileupload-grid",colModel:new Ext.grid.ColumnModel({defaults:{menuDisabled:!0},columns:[{dataIndex:"filename",header:SYNO.SDS.NoteStation._T("common","name")},{dataIndex:"filesize",header:SYNO.SDS.NoteStation._T("common","size"),width:60,hidden:!SYNO.SDS.Utils.FileChooser.Chooser.supportMultiSelect},{xtype:"actioncolumn",css:"syno-ns-actioncolumn",header:SYNO.SDS.NoteStation._T("common","action"),items:[{iconCls:"syno-ns-tinymce-fileupload-delete-icon",handler:function(t,e,o){var i=t.getStore().getAt(e).get("inputElm");t.getStore().removeAt(e),Ext.isObject(i)&&Ext.removeNode(Ext.getDom(i))}}],width:24,align:"center"}]}),store:this.getFileStore()}]};return Ext.apply(e,t)},getFileStore:function(){return this.fileStore?this.fileStore:(this.fileStore=new Ext.data.JsonStore({fields:["filename","filesize"]}),this.fileStore)}}),Ext.define("SYNO.SDS.NoteStation.Chart.Preview.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={layout:"fit",cls:"syno-ns-charteditor-preview-panel",items:[{itemId:"iframe",cls:"syno-ns-chart-preview-iframe",autoEl:{tag:"iframe"}},{xtype:"container",autoEl:"div",cls:"syno-ns-chart-preview-cover"},{xtype:"syno_button",cls:"syno-ns-chart-dataeditor-button",iconCls:"syno-ns-chart-dataeditor-icon",handler:function(){this.owner.owner.openDataEditorWindow()},scope:this}],listeners:{afterlayout:function(){this.isIframeReady||(this.initIframeByBrowser(),this.isIframeReady=!0)},scope:this}};return Ext.apply(e,t)},initIframeByBrowser:function(){this.owner.owner.setStatusBusy(),this.iframeDom=this.getComponent("iframe").getEl().dom,Ext.isGecko?this.iframeDom.onload=function(t){this.initIframe(this.iframeDom)}.createDelegate(this):this.initIframe(this.iframeDom)},initIframe:function(t){Ext.fly(t).setHeight(this.getHeight()-this.getEl().getPadding("tb")-this.getEl().getBorderWidth("tb")),this.initFlotr2(this.iframeDom),this.initDrawingContainer(this.iframeDom)},initFlotr2:function(t){var e=Ext.DomHelper.createDom({tag:"script",src:"webman/3rdparty/NoteStation/js/flotr2/flotr2.min.js"});e.onload=function(){this.isPreviewable=!0,this.draw(),this.owner.owner.clearStatusBusy()}.createDelegate(this),t.contentDocument.head.appendChild(e)},initDrawingContainer:function(t){t.drawingContainer=Ext.DomHelper.createDom({tag:"div",style:{width:"100%",height:"100%"}}),t.contentDocument.body.appendChild(t.drawingContainer)},draw:function(){var t,e,o;this.isPreviewable&&(t=this.iframeDom.contentWindow.Flotr,e=this.iframeDom.drawingContainer,o=this.chartInfo.getFlotrParameters(),t.draw(e,o.data,o.options))}}),Ext.define("SYNO.SDS.NoteStation.Chart.Property.Panel",{extend:"SYNO.ux.TabPanel",constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e,o;return o={owner:this,bodyWidth:this.getBodyWidth(t.width),chartInfo:t.chartInfo,defaults:{cls:"syno-ns-charteditor-property-subpanel"}},e={activeTab:0,width:t.width,autoScroll:!0,items:[this.createChartPanel(o),this.createCustomizedPanel(o)]},Ext.apply(e,t)},isValid:function(){return!this.customizedPanel||!this.customizedPanel.form||this.customizedPanel.form.isValid()},createChartPanel:function(t){return this.chartPanel=new SYNO.SDS.NoteStation.Chart.Property.Chart.Panel(t),this.chartPanel.on("headerchange",this.onHeaderChange,this),this.chartPanel.on("chartchange",this.onChartChange,this),this.chartPanel},createCustomizedPanel:function(t){return this.customizedPanel=new SYNO.SDS.NoteStation.Chart.Property.Config.Panel(t),this.customizedPanel.on("chartchange",this.onChartChange,this),this.customizedPanel},getBodyWidth:function(t){return t-16-10},onHeaderChange:function(t){this.owner.owner.updateDataHeader(t)},onChartChange:function(){this.owner.updatePreviewPanel()}}),Ext.define("SYNO.SDS.NoteStation.Chart.Property.Chart.Panel",{extend:"SYNO.ux.FormPanel",constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("chart","tab_title_chart"),items:[this.getHeaderPanelConfig(t),this.getDirectionPanelConfig(t),this.getTypePanelConfig(t)]};return Ext.apply(e,t)},getHeaderPanelConfig:function(t){return{xtype:"syno_panel",items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("chart","data_header")+":"},{xtype:"syno_checkbox",name:"columnHeaderExisted",checked:t.chartInfo.columnHeaderExisted,boxLabel:SYNO.SDS.NoteStation._T("chart","data_header_first_column"),listeners:{check:function(t,e){this.chartInfo.columnHeaderExisted=e,this.fireEvent("headerchange",SYNO.SDS.NoteStation.Chart.ChartInfo.DIRECTION.COLUMN),this.fireEvent("chartchange")},scope:this}},{xtype:"syno_checkbox",name:"rowHeaderExisted",checked:t.chartInfo.rowHeaderExisted,boxLabel:SYNO.SDS.NoteStation._T("chart","data_header_first_row"),listeners:{check:function(t,e){this.chartInfo.rowHeaderExisted=e,this.fireEvent("headerchange",SYNO.SDS.NoteStation.Chart.ChartInfo.DIRECTION.ROW),this.fireEvent("chartchange")},scope:this}}]}},getDirectionPanelConfig:function(t){return{xtype:"syno_panel",items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("chart","data_direction")+":"},{xtype:"radiogroup",columns:1,itemId:"direction",value:t.chartInfo.direction,items:[{xtype:"syno_radio",boxLabel:SYNO.SDS.NoteStation._T("chart","data_direction_by_row"),name:"direction",inputValue:SYNO.SDS.NoteStation.Chart.ChartInfo.DIRECTION.ROW},{xtype:"syno_radio",boxLabel:SYNO.SDS.NoteStation._T("chart","data_direction_by_column"),name:"direction",inputValue:SYNO.SDS.NoteStation.Chart.ChartInfo.DIRECTION.COLUMN}],listeners:{change:function(t,e){this.chartInfo.direction=e.getInputValue(),this.fireEvent("chartchange")},scope:this}}]}},getTypePanelConfig:function(t){var e=new Ext.data.ArrayStore({autoDestroy:!0,fields:["type"],data:[[SYNO.SDS.NoteStation.Chart.ChartInfo.CHART_TYPE.BAR],[SYNO.SDS.NoteStation.Chart.ChartInfo.CHART_TYPE.LINE],[SYNO.SDS.NoteStation.Chart.ChartInfo.CHART_TYPE.PIE]]});return{xtype:"syno_panel",items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("chart","type")+":"},this.chartTypeSelector=new Ext.DataView({cls:"syno-ns-charttype-selector",singleSelect:!0,itemSelector:"div.charttype-option",overClass:"x-view-over",store:e,tpl:new Ext.XTemplate('<tpl for=".">','<div class="charttype-option syno-ns-charttype-icon-{type}" id="{type}"></div>',"</tpl>"),initChartType:t.chartInfo.chartType,selectById:function(t){return this.select(this.store.find("type",t))},listeners:{afterrender:{fn:function(){this.initChartType&&this.selectById(this.initChartType)},scope:this.chartTypeSelector},selectionchange:{fn:function(t,e){var o=e[0];if(o){var i=o.getAttribute("id");this.chartType!=i&&(this.chartType=i,this.fireEvent("typechange",i))}else this.selectById(this.chartType)},scope:this.chartTypeSelector},typechange:{fn:function(t){this.chartInfo.chartType=t,this.fireEvent("chartchange")},scope:this}}})]}}}),Ext.define("SYNO.SDS.NoteStation.Chart.Property.Config.Panel",{extend:"SYNO.ux.FormPanel",constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("chart","tab_title_config"),items:[this.getChartTitlePanel(t),this.getXAxisTitlePanel(t),this.getYAxisTitlePanel(t),this.getSizePanel(t)]};return Ext.apply(e,t)},getChartTitlePanel:function(t){return{xtype:"syno_panel",items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("chart","chart_title")+":"},{xtype:"syno_textfield",name:"chartTitle",width:t.bodyWidth,value:t.chartInfo.title,listeners:{change:function(t,e){this.chartInfo.title=e,this.fireEvent("chartchange")},scope:this}}]}},getXAxisTitlePanel:function(t){return{xtype:"syno_panel",items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("chart","x_axis_title")+":"},{xtype:"syno_textfield",name:"xAxisTitle",width:t.bodyWidth,value:t.chartInfo.xAxisTitle,listeners:{change:function(t,e){this.chartInfo.xAxisTitle=e,this.fireEvent("chartchange")},scope:this}}]}},getYAxisTitlePanel:function(t){return{xtype:"syno_panel",items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("chart","y_axis_title")+":"},{xtype:"syno_textfield",name:"yAxisTitle",width:t.bodyWidth,value:t.chartInfo.yAxisTitle,listeners:{change:function(t,e){this.chartInfo.yAxisTitle=e,this.fireEvent("chartchange")},scope:this}}]}},getSizePanel:function(t){return{xtype:"syno_panel",items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("chart","chart_size")+":"},{xtype:"syno_compositefield",items:[{xtype:"syno_numberfield",flex:1,rawValue:t.chartInfo.width,value:t.chartInfo.width,minValue:10,allowNegative:!1,listeners:{change:function(t,e){!0===t.isValid()&&!0===Ext.isNumber(e)&&(this.chartInfo.width=e)},scope:this}},{xtype:"syno_displayfield",width:14,style:{"text-align":"center"},value:"x"},{xtype:"syno_numberfield",flex:1,minValue:10,allowNegative:!1,rawValue:t.chartInfo.height,value:t.chartInfo.height,listeners:{change:function(t,e){!0===t.isValid()&&!0===Ext.isNumber(e)&&(this.chartInfo.height=e)},scope:this}}]}]}}}),Ext.define("SYNO.SDS.NoteStation.Chart.ChartEditor.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={layout:"border",cls:"syno-ns-charteditor-mainpanel",items:[this.createPropertyPanel(t),this.createPreviewPanel(t)]};return Ext.apply(e,t)},createPropertyPanel:function(t){return this.propertyPanel=new SYNO.SDS.NoteStation.Chart.Property.Panel({owner:this,region:"west",width:266,chartInfo:t.chartInfo,margins:{right:12}}),this.propertyPanel},createPreviewPanel:function(t){return this.previewPanel=new SYNO.SDS.NoteStation.Chart.Preview.Panel({owner:this,region:"center",chartInfo:t.chartInfo,margins:{bottom:8}}),this.previewPanel},updatePreviewPanel:function(){this.previewPanel.draw()}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataEditor.Inner.Panel",{extend:"SYNO.ux.Panel",NAN_CLASS:"syno-ns-chart-nan-cell",constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){this.data=t.owner.data;var e={cls:"syno-ns-chart-inner-dataeditor-panel",autoFlexcroll:!0,items:[this.createViewOfHeader(),this.createViewOfGridLine(),this.createViewOfSelection(),this.createViewOfData()]};return Ext.apply(e,t)},createViewOfHeader:function(){return this.viewOfHeader=new Ext.BoxComponent({cls:"syno-ns-chart-title-header-dataview",html:""}),this.viewOfHeader.on("afterrender",this.createHeaderDivsAfterRender,this),this.viewOfHeader},createHeaderDivsAfterRender:function(){this.owner.on("headerchange",this.onHeaderChange,this),this.rowHeaderDiv=Ext.DomHelper.append(this.viewOfHeader.getEl(),{tag:"div",class:"syno-ns-chart-header-box",style:{height:String.format("{0}px",this.owner.ROW_HEIGHT)}}),this.columnHeaderDiv=Ext.DomHelper.append(this.viewOfHeader.getEl(),{tag:"div",class:"syno-ns-chart-header-box",style:{width:String.format("{0}px",this.owner.COLUMN_WIDTH)}}),this.updateRowHeaderDivVisible(),this.updateColumnHeaderDivVisible()},onHeaderChange:function(t){var e,o;e=t.concat("HeaderTds"),Ext.each(this[e].elements,function(t){this.updateNanClass(t)},this),o=String.format("update{0}HeaderDivVisible",this.capitalizeFirstLetter(t)),this[o]()},capitalizeFirstLetter:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},updateRowHeaderDivVisible:function(){this.owner.rowHeaderExisted?this.rowHeaderDiv.style.display="":this.rowHeaderDiv.style.display="none"},updateColumnHeaderDivVisible:function(){this.owner.columnHeaderExisted?this.columnHeaderDiv.style.display="":this.columnHeaderDiv.style.display="none"},resizeHeaderDivs:function(){var t,e;t=this.data[0].length*this.owner.COLUMN_WIDTH,e=this.data.length*this.owner.ROW_HEIGHT,this.rowHeaderDiv.offsetWidth!==t&&Ext.fly(this.rowHeaderDiv).setWidth(t),this.columnHeaderDiv.offsetWidth!==e&&Ext.fly(this.columnHeaderDiv).setHeight(e)},createViewOfGridLine:function(){return this.viewOfGridLine=new Ext.DataView({cls:"syno-ns-chart-gridline-dataview",store:new Ext.data.ArrayStore({autoDestroy:!0,fields:[]}),tpl:this.createGridLineTemplate()}),this.viewOfGridLine},createGridLineTemplate:function(){return new Ext.XTemplate("<table>","<tbody>",'<tpl for=".">',"{[this.generateRowTemplate(values, xindex-1)]}","</tpl>","</tbody>","</table>",{generateRowTemplate:this.generateGridLineRowTemplate.createDelegate(this)})},generateGridLineRowTemplate:function(t,e){var o,i,n=[];for(i=Math.max(this.data[0].length,this.owner.MIN_COLUMN_NUMBER),n.push("<tr>"),o=0;o<i;o++)n.push("<td></td>");return n.push("</tr>"),n.join("\n")},updateGridLineStore:function(){var t,e,o=[];for(e=Math.max(this.data.length,this.owner.MIN_ROW_NUMBER),t=0;t<e;t++)o[t]=[];this.viewOfGridLine.store.loadData(o,!1)},createViewOfSelection:function(){return this.viewOfSelection=new Ext.BoxComponent({cls:"syno-ns-chart-selection-dataview",html:""}),this.viewOfSelection},createViewOfData:function(){return this.viewOfData=new Ext.DataView({cls:"syno-ns-chart-data-dataview",tpl:this.createDataTemplate(),listeners:{dblclick:function(t,e,o){this.owner.changeToCellEditingState(o)},scope:this}}),this.viewOfData},createDataTemplate:function(){return new Ext.XTemplate("<table>","<tbody>",'<tpl for=".">',"{[this.generateRowTemplate(values, xindex-1)]}","</tpl>","</tbody>","</table>",{generateRowTemplate:this.generateDataRowTemplate.createDelegate(this)})},generateDataRowTemplate:function(t,e){var o,i=[];for(i.push("<tr>"),o=0;o<this.data[0].length;o++)i.push(String.format("<td id=chart_data_{0}_{1}>{2}</td>",e,o,t[o]));return i.push("</tr>"),i.join("\n")},updateDataStore:function(){var t,e=[];for(t=0;t<this.data[0].length;t++)e.push(String.format("{0}",t));this.viewOfData.setStore(new Ext.data.ArrayStore({autoDestroy:!0,fields:e,data:this.data}))},updateDataViews:function(){this.resizeHeaderDivs(),this.updateGridLineStore(),this.updateDataStore(),this.doLayout(!1),this.collectTdsOnViewOfData(),this.initializeTdsOnViewOfData()},collectTdsOnViewOfData:function(){var t=this.viewOfData.el.dom;this.rowHeaderTds=new Ext.CompositeElementLite,this.rowHeaderTds.fill(Ext.query("tr:first-child>td",t)),this.columnHeaderTds=new Ext.CompositeElementLite,this.columnHeaderTds.fill(Ext.query("tr>td:first-child",t)),this.tds=new Ext.CompositeElementLite,this.tds.fill(Ext.query("tr>td",t))},initializeTdsOnViewOfData:function(){Ext.each(this.tds.elements,function(t){var e=t.getAttribute("id").split("_");t.rowId=parseInt(e[2],10),t.columnId=parseInt(e[3],10),this.updateNanClass(t)},this)},getScrollPosition:function(){return this.body.dom.fleXdata.scrollPosition},setScrollPosition:function(t,e){this.body.dom.fleXcroll.setScrollPos(t,e)},updateNanClass:function(t){var e,o,i;e=this.owner.rowHeaderExisted&&0===t.rowId,o=this.owner.columnHeaderExisted&&0===t.columnId,i=Ext.isNumber(this.data[t.rowId][t.columnId]),e||o||i?Ext.fly(t).removeClass(this.NAN_CLASS):Ext.fly(t).addClass(this.NAN_CLASS)}}),Ext.define("SYNO.SDS.NoteStation.Chart.HeaderIndexConverter",{statics:{CHAR_SIZE:26,INT_TO_CHAR_SHIFT:64,convertRangeToObject:function(t){var e=t.split(":");return{column1:this.convertCharToInt(e[0].replace(/\d+/,"")),column2:this.convertCharToInt(e[1].replace(/\d+/,"")),row1:parseInt(e[0].replace(/\D+/,""),10),row2:parseInt(e[1].replace(/\D+/,""),10)}},convertIntToChar:function(t){for(var e=t,o="";e>=1;)o=String.fromCharCode(e%this.CHAR_SIZE+this.INT_TO_CHAR_SHIFT)+o,e/=this.CHAR_SIZE;return o},convertCharToInt:function(t){var e,o=0;for(e=0;e<t.length;e++)o+=(t.charCodeAt(t.length-e-1)-this.INT_TO_CHAR_SHIFT)*Math.pow(this.CHAR_SIZE,e);return o}}}),Ext.define("SYNO.SDS.NoteStation.Chart.TableParser",{statics:{generateData:function(t,e){if(!Ext.isEmpty(t)&&!Ext.isEmpty(e)){var o=[];return this.addRowDataRecursively(t,o),this.truncateDataBySelectedPos(o,e)}},addRowDataRecursively:function(t,e){for(var o=t.firstChild;o;)"THEAD"==o.tagName||"TBODY"==o.tagName||"TFOOT"==o.tagName?this.addRowDataRecursively(o,e):"TR"==o.tagName&&e.push(this.parseRowData(o)),o=o.nextSibling},parseRowData:function(t){var e,o,i=[],n=/^\s*-?\d+(\.\d)?\d*\s*$/,s=/^\s?$/;for(e=t.firstChild;e;)"TD"!=e.tagName&&"TH"!=e.tagName||(o=e.textContent,n.test(o)?i.push(parseFloat(o)):i.push(s.test(o)?"":o)),e=e.nextSibling;return i},truncateDataBySelectedPos:function(t,e){return e.startX==e.endX&&e.startY==e.endY?t:SYNO.SDS.NoteStation.Chart.DataOperater.Utils.truncateByRange(t,{row1:e.startY,row2:e.endY,column1:e.startX,column2:e.endX})}}}),Ext.define("SYNO.SDS.NoteStation.Chart.ChartInfo",{extend:"Ext.util.Observable",statics:{DEFAULT_WIDTH:520,DEFAULT_HEIGHT:350,DIRECTION:{ROW:"row",COLUMN:"column"},CHART_TYPE:{BAR:"bar",LINE:"line",PIE:"pie"}},constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={data:t.data||this.createDefaultData(),width:t.width||SYNO.SDS.NoteStation.Chart.ChartInfo.DEFAULT_WIDTH,height:t.height||SYNO.SDS.NoteStation.Chart.ChartInfo.DEFAULT_HEIGHT,rowHeaderExisted:!1!==t.rowHeaderExisted,columnHeaderExisted:!1!==t.columnHeaderExisted,direction:t.direction||SYNO.SDS.NoteStation.Chart.ChartInfo.DIRECTION.ROW,chartType:t.chartType||SYNO.SDS.NoteStation.Chart.ChartInfo.CHART_TYPE.BAR,title:t.title||"",xAxisTitle:t.xAxisTitle||"",yAxisTitle:t.yAxisTitle||""};return Ext.apply(this,e),e},updateChartDataAndConfig:function(t){t.setAttribute("chart-data",Ext.encode(this.data)),t.setAttribute("chart-config",this.getChartConfig())},getChartConfig:function(){return Ext.encode({range:this.getRangeConfig(),direction:this.direction,rowHeaderExisted:this.rowHeaderExisted,columnHeaderExisted:this.columnHeaderExisted,title:this.title,chartType:this.chartType,xAxisTitle:this.xAxisTitle,yAxisTitle:this.yAxisTitle})},getRangeConfig:function(){return"A1:"+SYNO.SDS.NoteStation.Chart.HeaderIndexConverter.convertIntToChar(this.data[0].length)+this.data.length.toString()},getFlotrParameters:function(t,e){var o;if(this.chartType===SYNO.SDS.NoteStation.Chart.ChartInfo.CHART_TYPE.LINE)o=new SYNO.SDS.NoteStation.Chart.FlotrLineParametersConverter({chartInfo:this});else if(this.chartType===SYNO.SDS.NoteStation.Chart.ChartInfo.CHART_TYPE.BAR)o=new SYNO.SDS.NoteStation.Chart.FlotrBarParametersConverter({chartInfo:this});else{if(this.chartType!==SYNO.SDS.NoteStation.Chart.ChartInfo.CHART_TYPE.PIE)return;o=new SYNO.SDS.NoteStation.Chart.FlotrPieParametersConverter({chartInfo:this})}return o.convert()},createDefaultData:function(){return[["","Number 1","Number 2","Number 3","Number 4"],["Category A",500,520,540,520],["Category B",520,540,560,540],["Category C",540,560,580,560]]}}),Ext.define("SYNO.SDS.NoteStation.Chart.FlotrParametersConverter",{extend:"Ext.util.Observable",constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={chartInfo:t.chartInfo};return Ext.apply(this,e),e},convert:function(){var t={};return t.data=this.generateDataParameterAndStoreSpecificInfo(),t.options=this.generateOptionsParameter(),t},generateDataParameterAndStoreSpecificInfo:function(){var t,e,o,i,n=[];for(i=this.separateIntoHeaderAndData(),this.chartInfo.direction===SYNO.SDS.NoteStation.Chart.ChartInfo.DIRECTION.ROW?(o=i.columnHeader,this.xTicksNames=i.rowHeader):(o=i.rowHeader,this.xTicksNames=i.columnHeader,i.valueData=this.transposeData(i.valueData)),this.findAndStoreSpecificInfo(i.valueData),e=this.convertDataToFlotrData(i.valueData),t=0;t<this.listCount;t++)n.push({data:e[t],label:o[t]});return n},separateIntoHeaderAndData:function(){var t,e,o,i,n,s,a,r,l,d=[],c=[],h=[];for(t=this.chartInfo.data.length,e=this.chartInfo.data[0].length,o=this.chartInfo.rowHeaderExisted?1:0,i=this.chartInfo.columnHeaderExisted?1:0,n=i;n<e;n++)l=this.chartInfo.rowHeaderExisted?String(this.chartInfo.data[0][n]):SYNO.SDS.NoteStation.Chart.HeaderIndexConverter.convertIntToChar(n+1),c.push(l);for(n=o;n<t;n++)l=String(this.chartInfo.columnHeaderExisted?this.chartInfo.data[n][0]:n+1),h.push(l);for(s=o;s<t;s++){for(r=[],a=i;a<e;a++)r.push(Ext.isNumber(this.chartInfo.data[s][a])?this.chartInfo.data[s][a]:0);d.push(r)}return 0===d.length&&(d[0]=""),{valueData:d,rowHeader:c,columnHeader:h}},transposeData:function(t){return t[0].map(function(e,o){return t.map(function(t){return t[o]})})},findAndStoreSpecificInfo:function(t){var e,o,i,n;for(this.listCount=t.length,this.barBasicShift=-1*(this.listCount-1)/(2*(this.listCount+1)),this.barStep=1/(this.listCount+1),i=t[0][0],n=t[0][0],e=0;e<t.length;e++)for(o=0;o<t[e].length;o++)t[e][o]>n&&(n=t[e][o]),t[e][o]<i&&(i=t[e][o]);this.assignProperYMinAndYMax(i,n)},assignProperYMinAndYMax:function(t,e){var o;t>=0?(o=.2*(e-t),this.yMin=Math.max(t-o,0),this.yMax=e+o):e<=0?(this.yMin=t,this.yMax=0):(o=.2*e,this.yMin=t,this.yMax=e+o)},convertDataToFlotrData:function(t){var e,o,i,n=[];for(e=0;e<t.length;e++){for(i=[],o=0;o<t[e].length;o++)i.push([this.calculateXPosition(e,o),Ext.isNumber(t[e][o])?t[e][o]:0]);n.push(i)}return n},calculateXPosition:function(t,e){return e+1},generateOptionsParameter:function(){var t={colors:["#1893F3","#FABB00","#9FD92B","#FA575D","#4BC0FA"],shadowSize:0,HtmlText:!1,title:this.chartInfo.title,fontSize:9.5,legend:{position:"ne",backgroundOpacity:0,labelBoxBorderColor:"#ffffff",labelBoxHeight:13,hideLegendBox:!0},xaxis:{title:this.chartInfo.xAxisTitle},yaxis:{title:this.chartInfo.yAxisTitle,max:this.yMax,min:this.yMin},grid:{labelMargin:11,outlineWidth:1,outline:"s",color:"#000"}};return this.fillTicks(t),t},fillTicks:function(t){var e,o=[];for(e=0;e<this.xTicksNames.length;e++)o.push([e+1,this.xTicksNames[e]]);t.xaxis.ticks=o}}),Ext.define("SYNO.SDS.NoteStation.Chart.FlotrLineParametersConverter",{extend:"SYNO.SDS.NoteStation.Chart.FlotrParametersConverter"}),Ext.define("SYNO.SDS.NoteStation.Chart.FlotrBarParametersConverter",{extend:"SYNO.SDS.NoteStation.Chart.FlotrParametersConverter",calculateXPosition:function(t,e){return this.callParent([t,e])+this.barBasicShift+this.barStep*t},generateOptionsParameter:function(){var t=this.callParent([]);return t.bars={show:!0,horizontal:!1,barWidth:1/(this.listCount+1),fillOpacity:1,spaceBetweenBars:1},t}}),Ext.define("SYNO.SDS.NoteStation.Chart.FlotrPieParametersConverter",{extend:"SYNO.SDS.NoteStation.Chart.FlotrParametersConverter",convertDataToFlotrData:function(t){var e,o=[];for(e=0;e<t.length;e++)o.push([[this.calculateXPosition(e,0),Ext.isNumber(t[e][0])?t[e][0]:0]]);return o},generateOptionsParameter:function(){var t=this.callParent([]);return t.grid.outline="",t.pie={show:!0,explode:3,fillOpacity:1},t},fillTicks:function(t){t.xaxis.ticks=[],t.yaxis.ticks=[]}}),Ext.define("SYNO.SDS.NoteStation.Chart.ChartObjectHelper",{statics:{drawTarget:null,getDrawTarget:function(){return this.drawTarget||(this.drawTarget=Ext.DomHelper.createDom({tag:"div"}),this.drawTarget.style.position="absolute",this.drawTarget.style.left="-9999px",this.drawTarget.style.top="-9999px",document.body.appendChild(this.drawTarget)),this.drawTarget},cleanUpTarget:function(){if(this.drawTarget)for(;this.drawTarget.firstChild;)this.drawTarget.removeChild(this.drawTarget.firstChild)},verifyChartObject:function(t){return Ext.isElement(t)&&Ext.fly(t).hasClass("syno-ns-chart-object")&&t.hasAttribute("chart-data")&&t.hasAttribute("chart-config")},generateChartInfo:function(t){var e,o;if(this.verifyChartObject(t))return e=Ext.decode(t.getAttribute("chart-data")),o=Ext.decode(t.getAttribute("chart-config")),new SYNO.SDS.NoteStation.Chart.ChartInfo(Ext.apply({data:this.truncateDataByRange(e,o),width:Ext.fly(t).getWidth(),height:Ext.fly(t).getHeight()},o))},truncateDataByRange:function(t,e){if(!e.range)return t;var o=SYNO.SDS.NoteStation.Chart.HeaderIndexConverter.convertRangeToObject(e.range);return SYNO.SDS.NoteStation.Chart.DataOperater.Utils.truncateByRange(t,{row1:o.row1-1,row2:o.row2-1,column1:o.column1-1,column2:o.column2-1})},draw:function(t,e,o){var i,n,s;this.verifyChartObject(e)&&(o=o||this.generateChartInfo(e),Ext.isObject(o)&&(this.adjustChartObjectSize(e,o.width,o.height),n=this.getDrawTarget(),this.adjustSize(n,o.width,o.height),i=o.getFlotrParameters(),t.draw(n,i.data,i.options),s=n.querySelector("canvas.flotr-canvas"),this.translateToImage(e,s),this.cleanUpTarget()))},
adjustChartObjectSize:function(t,e,o){this.adjustSize(t,e,o),t.removeAttribute("data-mce-style")},adjustSize:function(t,e,o){var i=Ext.fly(t);i.getWidth()!==e&&i.setWidth(e),i.getHeight()!==o&&i.setHeight(o)},insertNewChartObject:function(t,e,o){var i,n;n=this.createChartObject(o),i=Ext.DomHelper.createDom({tag:"div"}),i.appendChild(n),Ext.fly(i).insertAfter(e),this.draw(t,n,o)},createChartObject:function(t){var e=Ext.DomHelper.createDom({tag:"img",cls:"syno-ns-chart-object",style:{width:String.format("{0}px",t.width),height:String.format("{0}px",t.height),padding:String.format("{0}px",this.padding)}});return e.setAttribute("data-mce-object",""),t.updateChartDataAndConfig(e),e},translateToImage:function(t,e){var o,i,n;this.verifyChartObject(t)&&e&&Ext.isFunction(e.toDataURL)&&(i=e.width,n=e.height,o=e.getContext("2d"),o.globalCompositeOperation="destination-over",o.fillStyle="#FFFFFF",o.fillRect(0,0,i,n),t.src=e.toDataURL("image/png"))},generateImage:function(t,e){if(!this.verifyChartObject(e))return!1;var o=document.createElement("img");o.src=e.src,Ext.fly(o).insertAfter(e.parentNode||e)},translateChartTag:function(t,e,o){var i=t.parentNode;if(!i||t.tagName!==e)return t;var n=document.createElement(o);return["class","style","chart-data","chart-config","data-mce-style"].forEach(function(e){var o=t.getAttribute(e);o&&n.setAttribute(e,o)}),i.insertBefore(n,t),i.removeChild(t),n}}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataOperater.Utils",{statics:{DEFAULT_VALUE:"",insertRows:function(t,e,o){var i,n=[e,0];for(i=0;i<o;i++)n.push(function(e){return t[0].map(function(){return e})}(this.DEFAULT_VALUE));t.splice.apply(t,n)},insertColumns:function(t,e,o){var i,n;t.forEach(function(t){for(n=[e,0],i=0;i<o;i++)n.push(this.DEFAULT_VALUE);t.splice.apply(t,n)},this)},truncateByRange:function(t,e){return SYNO.SDS.NoteStation.Chart.DataOperater.Utils.removeRows(t,e.row2+1,t.length),SYNO.SDS.NoteStation.Chart.DataOperater.Utils.removeRows(t,0,e.row1-1),SYNO.SDS.NoteStation.Chart.DataOperater.Utils.removeColumns(t,e.column2+1,t[0].length),SYNO.SDS.NoteStation.Chart.DataOperater.Utils.removeColumns(t,0,e.column1-1),t},removeRows:function(t,e,o){var i=t.length-1;return!(e>i||o<e)&&((0!==e||o!==i)&&(t.splice(e,o-e+1),!0))},removeColumns:function(t,e,o){var i=t[0].length-1;return!(e>i||o<e)&&((0!==e||o!==i)&&(t.forEach(function(t){t.splice(e,o-e+1)}),!0))}}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.Base",{extend:"Ext.util.Observable",constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){return this.addEvents({}),Ext.apply(this,t),t},startState:function(t){},endState:function(){}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.CellEditing",{extend:"SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.Base",startState:function(t){this.escaped=!1,this.td=t,this.scrollToTd(t),this.textField=this.createTextField(t),this.innerPanel.insert(this.panel.items.length,this.textField),this.innerPanel.doLayout()},endState:function(){this.escaped||this.updateData(),this.innerPanel.remove(this.textField,!0),this.textField=void 0},createTextField:function(t){return new Ext.create({xtype:"syno_textfield",cls:"syno-ns-chart-cell-editor",value:t.textContent,selectOnFocus:!0,style:{left:String.format("{0}px",t.offsetLeft),top:String.format("{0}px",t.offsetTop)},listeners:{afterrender:function(t){t.focus(!0)},specialkey:function(t,e,o){e.getKey()==e.ENTER&&this.panel.changeToNormalState(),e.getKey()==e.ESC&&(e.stopPropagation(),this.escaped=!0,this.panel.changeToNormalState())},blur:function(){this.panel.changeToNormalState()},scope:this}})},updateData:function(){var t=/^-?\d+(\.\d)?\d*$/,e=this.textField.getValue();this.panel.data[this.td.rowId][this.td.columnId]=t.test(e)?parseFloat(e):e,this.innerPanel.updateNanClass(this.td),this.td.textContent=e,this.panel.fireEvent("datachange")},scrollToTd:function(t){var e,o;e=this.calculateProperScrollPosition(t.offsetLeft,this.panel.COLUMN_WIDTH,this.innerPanel.getScrollPosition()[0][0],this.panel.getCellableWidth()),o=this.calculateProperScrollPosition(t.offsetTop,this.panel.ROW_HEIGHT,this.innerPanel.getScrollPosition()[1][0],this.panel.getCellableHeight()),this.innerPanel.setScrollPosition(e,o)},calculateProperScrollPosition:function(t,e,o,i){var n=t+e,s=o+i;return t<o?t:n>s?n-i:void 0}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.VectorOperating",{extend:"SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.Base",SELECTION_HEADER:"syno-ns-chart-selected-header",startState:function(t){this.initSpecificInfo(),this.startTd=t,this.endTd=t,this.addDragListener(),this.innerPanel.viewOfGridLine.el.on("mousedown",this.panel.changeToNormalState,this.panel),this.innerPanel.viewOfData.el.on("mousedown",this.panel.changeToNormalState,this.panel),Ext.each(this.listeningTds.elements,function(t){Ext.fly(t).on("contextmenu",this.onContextMenu,this)},this),this.selectionDiv=Ext.DomHelper.append(this.innerPanel.viewOfSelection.getEl(),{tag:"div",class:"syno-ns-chart-selection-box"}),this.updateSelectionDiv()},endState:function(){this.innerPanel.viewOfGridLine.el.un("mousedown",this.panel.changeToNormalState,this.panel),this.innerPanel.viewOfData.el.un("mousedown",this.panel.changeToNormalState,this.panel),Ext.each(this.listeningTds.elements,function(t){Ext.fly(t).un("contextmenu",this.onContextMenu,this),Ext.fly(t).removeClass(this.SELECTION_HEADER)},this),this.selectionDiv.remove(),this.selectionDiv=void 0},updateSelectionDiv:function(){this.updateOrderedTd(),this.updateHeaderBackground(),this.adjustSelectionDivSize(this.getRectangle())},updateHeaderBackground:function(){Ext.each(this.listeningTds.elements,function(t){this.isTdOnSelection(t)?Ext.fly(t).addClass(this.SELECTION_HEADER):Ext.fly(t).removeClass(this.SELECTION_HEADER)},this)},adjustSelectionDivSize:function(t){Ext.fly(this.selectionDiv).setTop(t.top),Ext.fly(this.selectionDiv).setLeft(t.left),Ext.fly(this.selectionDiv).setWidth(t.right-t.left),Ext.fly(this.selectionDiv).setHeight(t.bottom-t.top)},finishDragging:function(){var t=this;this.selectionDiv.style.setProperty("display","none"),setTimeout(function(){t.selectionDiv.style.removeProperty("display")},100),this.removeDragListener()},addDragListener:function(){Ext.each(this.listeningTds.elements,function(t){Ext.fly(t).on("mouseover",this.onMouseOver,this)},this),this.listeningView.on("mouseleave",this.finishDragging,this),this.listeningView.on("mouseup",this.finishDragging,this)},removeDragListener:function(){Ext.each(this.listeningTds.elements,function(t){Ext.fly(t).un("mouseover",this.onMouseOver,this)},this),this.listeningView.un("mouseleave",this.finishDragging,this),this.listeningView.un("mouseup",this.finishDragging,this)},onMouseOver:function(t){this.endTd=t.target,this.updateSelectionDiv()},onContextMenu:function(t,e){this.isTdOnSelection(e)||(this.startTd=e,this.endTd=e,this.updateSelectionDiv()),this.getCorrespondingMenu().showAt(t.xy)},isTdOnSelection:function(t){return this.getFrontIndex()<=t.index&&t.index<=this.getHindIndex()},updateWithNewData:function(){this.panel.updateDataViews(),this.panel.fireEvent("datachange")},getData:function(){return this.panel.data},getFrontIndex:function(){return this.frontTd.index},getHindIndex:function(){return this.hindTd.index},insertVectorsBefore:function(t){var e=this.getFrontIndex();t=Ext.isNumber(t)?t:1,this.doInsertVectors(this.getData(),e,t),this.updateWithNewData(),this.doAdjustScrollAfterInsertBefore(e)},insertVectorsAfter:function(t){var e=this.getHindIndex()+1;t=Ext.isNumber(t)?t:1,this.doInsertVectors(this.getData(),e,t),this.updateWithNewData(),this.doAdjustScrollAfterInsertAfter(e,t)},deleteVectors:function(){this.doDeleteVectors(this.getData(),this.getFrontIndex(),this.getHindIndex())?(this.updateWithNewData(),this.panel.changeToNormalState()):this.panel.owner.getMsgBox().alert("",this.getDeletionFailMessage())}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.RowOperating",{extend:"SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.VectorOperating",initSpecificInfo:function(){this.width=this.panel.data[0].length*this.panel.COLUMN_WIDTH,this.listeningView=this.panel.intHeaderView.el,this.listeningTds=this.panel.intHeaderTds},updateOrderedTd:function(){this.frontTd=this.startTd.offsetTop<this.endTd.offsetTop?this.startTd:this.endTd,this.hindTd=this.startTd.offsetTop<this.endTd.offsetTop?this.endTd:this.startTd},getRectangle:function(){return{top:this.frontTd.offsetTop+1,bottom:this.hindTd.offsetTop+this.hindTd.offsetHeight+1,left:1,right:this.width+1}},getCorrespondingMenu:function(){return this.panel.getRowContextMenu()},doInsertVectors:function(t,e,o){SYNO.SDS.NoteStation.Chart.DataOperater.Utils.insertRows(t,e,o)},openInsertorWindow:function(){this.panel.openDataInsertorWindow(SYNO.SDS.NoteStation.Chart.ChartInfo.DIRECTION.ROW,this)},doDeleteVectors:function(t,e,o){return SYNO.SDS.NoteStation.Chart.DataOperater.Utils.removeRows(t,e,o)},getDeletionFailMessage:function(){return SYNO.SDS.NoteStation._T("chart","remove_all_row_notify")},doAdjustScrollAfterInsertBefore:function(t){var e=t*this.panel.ROW_HEIGHT;this.innerPanel.getScrollPosition()[1][0]>e&&this.innerPanel.setScrollPosition(void 0,e)},doAdjustScrollAfterInsertAfter:function(t,e){var o,i,n,s;o=t*this.panel.ROW_HEIGHT,i=Math.floor(this.panel.getCellableHeight()/this.panel.ROW_HEIGHT),n=Math.min(i,e),s=o+n*this.panel.ROW_HEIGHT-this.innerPanel.getHeight()+this.panel.PADDING_SCROLLBAR,this.innerPanel.getScrollPosition()[1][0]<s&&this.innerPanel.setScrollPosition(void 0,s)}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.ColumnOperating",{extend:"SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.VectorOperating",initSpecificInfo:function(){this.height=this.panel.data.length*this.panel.ROW_HEIGHT,this.listeningView=this.panel.charHeaderView.el,this.listeningTds=this.panel.charHeaderTds},updateOrderedTd:function(){this.frontTd=this.startTd.offsetLeft<this.endTd.offsetLeft?this.startTd:this.endTd,this.hindTd=this.startTd.offsetLeft<this.endTd.offsetLeft?this.endTd:this.startTd},getRectangle:function(){return{top:1,bottom:this.height+1,left:this.frontTd.offsetLeft+1,right:this.hindTd.offsetLeft+this.hindTd.offsetWidth+1}},getCorrespondingMenu:function(){return this.panel.getColumnContextMenu()},doInsertVectors:function(t,e,o){SYNO.SDS.NoteStation.Chart.DataOperater.Utils.insertColumns(t,e,o)},openInsertorWindow:function(){this.panel.openDataInsertorWindow(SYNO.SDS.NoteStation.Chart.ChartInfo.DIRECTION.COLUMN,this)},doDeleteVectors:function(t,e,o){return SYNO.SDS.NoteStation.Chart.DataOperater.Utils.removeColumns(t,e,o)},getDeletionFailMessage:function(){return SYNO.SDS.NoteStation._T("chart","remove_all_column_notify")},doAdjustScrollAfterInsertBefore:function(t){var e=t*this.panel.COLUMN_WIDTH;this.innerPanel.getScrollPosition()[0][0]>e&&this.innerPanel.setScrollPosition(e,void 0)},doAdjustScrollAfterInsertAfter:function(t,e){var o,i,n,s;o=t*this.panel.COLUMN_WIDTH,i=Math.floor(this.panel.getCellableWidth()/this.panel.COLUMN_WIDTH),n=Math.min(i,e),s=o+n*this.panel.COLUMN_WIDTH-this.innerPanel.getWidth()+this.panel.PADDING_SCROLLBAR,this.innerPanel.getScrollPosition()[0][0]<s&&this.innerPanel.setScrollPosition(s,void 0)}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataInsertor.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",MIN_VECTOR_NUMBER:1,MAX_VECTOR_NUMBER:10,constructor:function(t){this.callParent([this.fillConfig(t)]),this.on("activate",function(){this.fireEvent("deactivate")},this.owner)},fillConfig:function(t){var e;return this.insertOption=new Ext.data.ArrayStore({fields:["value","display"],data:[]}),e={width:405,autoHeight:!0,resizable:!1,items:[new SYNO.SDS.NoteStation.Operate.FormPanel({border:!1,items:[this.comboBox=new SYNO.ux.ComboBox({width:180,fieldLabel:SYNO.SDS.NoteStation._T("chart","insert_position"),labelSeparator:":",labelStyle:{width:"110px;"},mode:"local",store:this.insertOption,valueField:"value",displayField:"display"}),this.numberField=new SYNO.ux.NumberField({width:180,selectOnFocus:!0,fieldLabel:SYNO.SDS.NoteStation._T("chart","insert_number"),labelSeparator:":",labelStyle:{width:"110px;"},validator:this.validateInsertionNumber.createDelegate(this),invalidText:String.format(SYNO.SDS.NoteStation._T("chart","invalid_must_between"),this.MIN_VECTOR_NUMBER,this.MAX_VECTOR_NUMBER)})]})],buttons:[{xtype:"syno_button",text:_T("common","cancel"),listeners:{click:this.onCancel,scope:this}},{xtype:"syno_button",text:_T("common","ok"),btnStyle:"blue",listeners:{click:this.onApply,scope:this}}]},Ext.apply(e,t)},validateInsertionNumber:function(t){var e,o;return e=/^\d+$/.test(t),o=this.MIN_VECTOR_NUMBER<=parseInt(t,10)&&parseInt(t,10)<=this.MAX_VECTOR_NUMBER,e&&o},showDialog:function(t,e){this.initWindow(t,e),this.show(),this.numberField.focus.defer(100,this.numberField)},initWindow:function(t,e){this.handler=e,t===SYNO.SDS.NoteStation.Chart.ChartInfo.DIRECTION.ROW?(this.setTitle(SYNO.SDS.NoteStation._T("chart","menu_insert_multi_rows")),this.insertOption.loadData([[0,SYNO.SDS.NoteStation._T("chart","position_above")],[1,SYNO.SDS.NoteStation._T("chart","position_below")]])):(this.setTitle(SYNO.SDS.NoteStation._T("chart","menu_insert_multi_columns")),this.insertOption.loadData([[0,SYNO.SDS.NoteStation._T("chart","position_left")],[1,SYNO.SDS.NoteStation._T("chart","position_right")]])),this.comboBox.setValue(0),this.numberField.setValue(1)},onApply:function(){var t,e,o;if(!this.numberField.isValid())return void this.getMsgBox().alert("",this.numberField.invalidText);t=0===this.comboBox.getValue()?"insertVectorsBefore":"insertVectorsAfter",e=this.handler[t].createDelegate(this.handler),o=parseInt(this.numberField.getValue(),10),e(o),this.hide()},onCancel:function(){this.hide()}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataOperater.Menu",{extend:"SYNO.ux.Menu",constructor:function(t){this.callParent([this.fillConfig(t||{})])},createMenuItemConfig:function(t,e){var o=t.replace(/_/g,"-");return{itemId:t,cls:o+"-menu-item",iconCls:"syno-sh-"+o+"-menu-icon",text:SYNO.SDS.NoteStation._T("chart","menu_"+t),disabled:!e,handler:e?e.createDelegate(this):void 0}},onInsertVectorsBefore:function(){this.handler.insertVectorsBefore(1)},onInsertVectorsAfter:function(){this.handler.insertVectorsAfter(1)},onOpenInsertorWindow:function(){this.handler.openInsertorWindow()},onDeleteVectors:function(){this.handler.deleteVectors()}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataOperater.Row.Menu",{extend:"SYNO.SDS.NoteStation.Chart.DataOperater.Menu",constructor:function(t){this.callParent([t])},fillConfig:function(t){this.owner=t.owner,this.handler=t.handler;var e={items:[this.createMenuItemConfig("insert_row_above",this.onInsertVectorsBefore),this.createMenuItemConfig("insert_row_below",this.onInsertVectorsAfter),this.createMenuItemConfig("insert_multi_rows",this.onOpenInsertorWindow),this.createMenuItemConfig("delete_rows",this.onDeleteVectors)]};return Ext.apply(e,t)}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataOperater.Column.Menu",{extend:"SYNO.SDS.NoteStation.Chart.DataOperater.Menu",constructor:function(t){this.callParent([t])},fillConfig:function(t){this.owner=t.owner,this.handler=t.handler;var e={items:[this.createMenuItemConfig("insert_column_left",this.onInsertVectorsBefore),this.createMenuItemConfig("insert_column_right",this.onInsertVectorsAfter),this.createMenuItemConfig("insert_multi_columns",this.onOpenInsertorWindow),this.createMenuItemConfig("delete_columns",this.onDeleteVectors)]};return Ext.apply(e,t)}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataEditor.Panel",{extend:"SYNO.ux.Panel",MIN_COLUMN_NUMBER:5,MIN_ROW_NUMBER:6,MOUSE_CLICK_RIGHT:2,COLUMN_WIDTH:112,INDEX_COLUMN_WIDTH:36,ROW_HEIGHT:24,PADDING_SCROLLBAR:12,constructor:function(t){this.callParent([this.fillConfig(t||{})]),this.innerPanel.on("flexcroll",this.updateHeaderViewPosition,this),this.initStates()},fillConfig:function(t){this.data=t.data,this.innerPanel=new SYNO.SDS.NoteStation.Chart.DataEditor.Inner.Panel({owner:this});var e={cls:"syno-ns-dataeditor-mainpanel",items:[{xtype:"container",autoEl:"div",cls:"syno-ns-chart-header-root"},this.createViewOfCharHeader(),this.createViewOfIntHeader(),this.innerPanel],listeners:{afterlayout:function(t){this.innerPanel.setWidth(this.getWidth()-this.INDEX_COLUMN_WIDTH),this.innerPanel.setHeight(this.getHeight()-this.ROW_HEIGHT)},headerchange:function(t){var e=t.concat("HeaderExisted");this[e]=!this[e]},scope:this}};return Ext.apply(e,t)},initLayoutOnce:function(){this.UNCELLABLE_WIDTH=this.owner.getWidth()-this.getCellableWidth(),this.UNCELLABLE_HEIGHT=this.owner.getHeight()-this.getCellableHeight(),this.owner.minWidth=this.UNCELLABLE_WIDTH+this.MIN_COLUMN_NUMBER*this.COLUMN_WIDTH,this.owner.minHeight=this.UNCELLABLE_HEIGHT+this.MIN_ROW_NUMBER*this.ROW_HEIGHT,this.updateDataViews()},getCellableWidth:function(){return this.innerPanel.getWidth()-this.PADDING_SCROLLBAR},getCellableHeight:function(){return this.innerPanel.getHeight()-this.PADDING_SCROLLBAR},createViewOfCharHeader:function(){return this.charHeaderView=new Ext.DataView({cls:"syno-ns-chart-char-header-dataview",store:new Ext.data.ArrayStore({autoDestroy:!0,fields:["columnId"]}),tpl:this.createCharHeaderTemplate()}),this.charHeaderView},createCharHeaderTemplate:function(){return new Ext.XTemplate("<table>","<tbody>","<tr>",'<tpl for=".">',"<td id=chart_char_header_{[xindex-1]}>{columnId}</td>","</tpl>","</tr>","</tbody>","</table>")},updateCharHeaderStore:function(){var t,e=[];for(t=0;t<this.data[0].length;t++)e[t]=[SYNO.SDS.NoteStation.Chart.HeaderIndexConverter.convertIntToChar(t+1)];for(t=this.data[0].length;t<this.MIN_COLUMN_NUMBER;t++)e[t]=[];e[t]=[],this.charHeaderView.store.loadData(e,!1)},createViewOfIntHeader:function(){return this.intHeaderView=new Ext.DataView({cls:"syno-ns-chart-int-header-dataview",store:new Ext.data.ArrayStore({autoDestroy:!0,fields:["rowId"]}),tpl:this.createIntHeaderTemplate()}),this.intHeaderView},createIntHeaderTemplate:function(){return new Ext.XTemplate("<table>","<tbody>",'<tpl for=".">',"<tr><td id=chart_int_header_{[xindex-1]}>{rowId}</td></tr>","</tpl>","</tbody>","</table>")},updateIntHeaderStore:function(){var t,e=[];for(t=0;t<this.data.length;t++)e[t]=[String.format("{0}",t+1)];for(t=this.data.length;t<this.MIN_ROW_NUMBER;t++)e[t]=[];e[t]=[],this.intHeaderView.store.loadData(e,!1)},updateDataViews:function(){this.updateWindowMaxSize(),this.updateCharHeaderStore(),this.updateIntHeaderStore(),this.innerPanel.updateDataViews(),this.collectTdsOnHeader(),this.initializeTdOfEachHeader()},updateWindowMaxSize:function(){var t,e,o,i;Ext.isEmpty(this.owner.resizer)||(t=Math.max(this.data[0].length,this.MIN_COLUMN_NUMBER),e=Math.max(this.data.length,this.MIN_ROW_NUMBER),this.owner.resizer.maxWidth=t*this.COLUMN_WIDTH+this.UNCELLABLE_WIDTH,this.owner.resizer.maxHeight=e*this.ROW_HEIGHT+this.UNCELLABLE_HEIGHT,o=this.owner.getSize().width>this.owner.resizer.maxWidth?this.owner.resizer.maxWidth:void 0,i=this.owner.getSize().height>this.owner.resizer.maxHeight?this.owner.resizer.maxHeight:void 0,this.owner.setSize(o,i))},updateHeaderViewPosition:function(t,e){this.charHeaderView.setPosition(this.getHeaderMinLeft()-e.scrollLeft,void 0),this.intHeaderView.setPosition(void 0,this.getHeaderMinTop()-e.scrollTop)},collectTdsOnHeader:function(){this.intHeaderTds=new Ext.CompositeElementLite,this.intHeaderTds.fill(Ext.query("td:not(:empty)",this.intHeaderView.el.dom)),this.charHeaderTds=new Ext.CompositeElementLite,this.charHeaderTds.fill(Ext.query("td:not(:empty)",this.charHeaderView.el.dom))},initializeTdOfEachHeader:function(){Ext.each(this.intHeaderTds.elements,function(t){var e=t.getAttribute("id").split("_");t.index=parseInt(e[3],10),Ext.fly(t).on("mousedown",this.onIntHeaderMouseDown,this)},this),Ext.each(this.charHeaderTds.elements,function(t){var e=t.getAttribute("id").split("_");t.index=parseInt(e[3],10),Ext.fly(t).on("mousedown",this.onCharHeaderMouseDown,this)},this)},onIntHeaderMouseDown:function(t,e){t.button==this.MOUSE_CLICK_RIGHT&&this.currentState==this.states.rowOperating&&this.currentState.isTdOnSelection(e)||this.changeToRowOperatingState(e)},onCharHeaderMouseDown:function(t,e){t.button==this.MOUSE_CLICK_RIGHT&&this.currentState==this.states.columnOperating&&this.currentState.isTdOnSelection(e)||this.changeToColumnOperatingState(e)},initStates:function(){this.states={},this.states.normal=new SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.Base({panel:this,innerPanel:this.innerPanel}),this.states.cellEditing=new SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.CellEditing({panel:this,innerPanel:this.innerPanel}),this.states.rowOperating=new SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.RowOperating({panel:this,innerPanel:this.innerPanel}),this.states.columnOperating=new SYNO.SDS.NoteStation.Chart.DataEditor.InteractionState.ColumnOperating({panel:this,innerPanel:this.innerPanel}),this.currentState=this.states.normal},changeState:function(t,e){var o=Array.prototype.slice.call(arguments,1);this.currentState.endState(),this.currentState=t,this.currentState.startState.apply(this.currentState,o)},changeToNormalState:function(){this.changeState(this.states.normal)},changeToCellEditingState:function(t){this.changeState(this.states.cellEditing,t)},changeToRowOperatingState:function(t){this.changeState(this.states.rowOperating,t)},changeToColumnOperatingState:function(t){this.changeState(this.states.columnOperating,t)},getHeaderMinTop:function(t){return this.ROW_HEIGHT-1},getHeaderMinLeft:function(t){return this.INDEX_COLUMN_WIDTH-1},getRowContextMenu:function(){return this.rowContextMenu||(this.rowContextMenu=new SYNO.SDS.NoteStation.Chart.DataOperater.Row.Menu({owner:this,handler:this.states.rowOperating})),this.rowContextMenu},getColumnContextMenu:function(){return this.columnContextMenu||(this.columnContextMenu=new SYNO.SDS.NoteStation.Chart.DataOperater.Column.Menu({owner:this,handler:this.states.columnOperating})),this.columnContextMenu},openDataInsertorWindow:function(t,e){this.dataInsertorWindow||(this.dataInsertorWindow=new SYNO.SDS.NoteStation.Chart.DataInsertor.Window({owner:this.owner})),this.dataInsertorWindow.showDialog(t,e)}}),Ext.define("SYNO.SDS.NoteStation.Chart.DataEditor.Window",{extend:"SYNO.SDS.Window",constructor:function(t){this.callParent([this.fillConfig(t||{})]),this.on("activate",this.owner.activateIfNot,this.owner)},fillConfig:function(t){var e={width:648,height:259,cls:"syno-ns-dialog syno-ns-chart-dataeditor-win",layout:"fit",useStatusBar:!0,maximizable:!1,closable:!1,padding:"0px 20px 12px",items:[this.getPanel(t)],buttons:[{xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","done"),handler:this.onCloseClick,scope:this}],listeners:{afterrender:function(){this.panel.initLayoutOnce()},scope:this}};return Ext.apply(e,t)},getPanel:function(t){return Ext.isEmpty(this.Panel)&&(this.panel=new SYNO.SDS.NoteStation.Chart.DataEditor.Panel({owner:this,data:t.data,rowHeaderExisted:t.rowHeaderExisted,columnHeaderExisted:t.columnHeaderExisted})),this.panel},onCloseClick:function(){this.hide()},toFront:function(){this.isVisible()&&this.setZIndex(this.owner.el.getZIndex())}}),Ext.ns("SYNO.SDS.NoteStation.Chart"),Ext.define("SYNO.SDS.NoteStation.Chart.ChartEditor.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.callParent([this.fillConfig(t||{})]),this.appWin=this.findAppWindow(),this.enableKeepFocusOnEditor()},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("chart","title"),width:920,height:529,cls:"syno-ns-chart-win",layout:"fit",resizable:!1,items:[this.createPanel(t)],buttons:[{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.onCloseWin},{xtype:"syno_button",btnStyle:"blue",text:_T("common","commit"),handler:this.onClickOk,scope:this}],listeners:{afterrender:this.openDataEditorWindow,scope:this}};return Ext.apply(e,t)},enableKeepFocusOnEditor:function(){this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel").tinymcePanel.enableKeepFocusOnEditor()},disableKeepFocusOnEditor:function(){this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel").tinymcePanel.disableKeepFocusOnEditor()},createPanel:function(t){return this.panel=new SYNO.SDS.NoteStation.Chart.ChartEditor.Panel({owner:this,chartInfo:this.generateChartInfo(t)}),this.panel},onCloseWin:function(){this.disableKeepFocusOnEditor(),this.close()},getFlotr2:function(){return this.editor.getWin().Flotr},openDataEditorWindow:function(){Ext.isEmpty(this.dataEditorWindow)&&this.createDataEditorWindow(),this.dataEditorWindow.show()},createDataEditorWindow:function(){this.dataEditorWindow=new SYNO.SDS.NoteStation.Chart.DataEditor.Window({owner:this,data:this.panel.chartInfo.data,rowHeaderExisted:this.panel.chartInfo.rowHeaderExisted,columnHeaderExisted:this.panel.chartInfo.columnHeaderExisted}),this.dataEditorWindow.panel.on("datachange",this.panel.updatePreviewPanel,this.panel),this.on("activate",function(){this.dataEditorWindow.fireEvent("activate"),this.dataEditorWindow.toFront()},this)},updateDataHeader:function(t){this.dataEditorWindow.panel.fireEvent("headerchange",t)},blinkShadowV5:function(t){this.callParent([t]),0===t&&this.dataEditorWindow.toFront()},activateIfNot:function(){this!==this.manager.getActive()&&this.manager.setActiveWin(this)}}),Ext.define("SYNO.SDS.NoteStation.Chart.ChartEditor.NewChart.Window",{extend:"SYNO.SDS.NoteStation.Chart.ChartEditor.Window",generateChartInfo:function(t){return new SYNO.SDS.NoteStation.Chart.ChartInfo({data:SYNO.SDS.NoteStation.Chart.TableParser.generateData(t.tableElm,t.selectedPos)})},onClickOk:function(t){SYNO.SDS.NoteStation.Chart.ChartObjectHelper.insertNewChartObject(this.getFlotr2(),this.nodeToInsertAfter,this.panel.chartInfo),this.onCloseWin()}}),Ext.define("SYNO.SDS.NoteStation.Chart.ChartEditor.ExistingChart.Window",{extend:"SYNO.SDS.NoteStation.Chart.ChartEditor.Window",generateChartInfo:function(t){return SYNO.SDS.NoteStation.Chart.ChartObjectHelper.generateChartInfo(t.chartObject)},onClickOk:function(t){var e=this.panel.chartInfo;!1!==this.panel.propertyPanel.isValid()&&(e.updateChartDataAndConfig(this.chartObject),SYNO.SDS.NoteStation.Chart.ChartObjectHelper.draw(this.getFlotr2(),this.chartObject,e),this.onCloseWin())}}),Ext.define("SYNO.SDS.NoteStation.MainPanel",{extend:"SYNO.ux.Panel",isSyncing:!1,syncDuration:1500,constructor:function(t){var e;SYNO.SDS.NoteStation.Window.addPanelScope("SYNO.SDS.NoteStation.MainPanel",this),e=this.fillConfig(t),this.callParent([e]),this.owner.on("afterdataload",this.onShowContentByDefault,this)},fillConfig:function(t){var e,o,i=[];return this.sync_callback=[],this.owner=t.owner,this.addEvents("selectnotebook","selectnote","selecttag","selectuser","selectjoinednote","selectstack","selectodo"),this.crossPanelCtxMenu=new SYNO.SDS.NoteStation.CtxMenu({owner:this}),i=SYNO.SDS.NoteStation.Utils.isShowNote?[this.getEditorPanel()]:SYNO.SDS.NoteStation.Utils.isShowNotebook||SYNO.SDS.NoteStation.Utils.isShowSmart?SYNO.SDS.NoteStation.Utils.isMobileDevice?[this.getMobilePanel()]:[this.getNotePanel(),this.getEditorPanel()]:[this.getNotebookPanel(),{xtype:"syno_panel",region:"center",width:"80%",layout:"card",minWidth:800,itemId:"center_region",items:[this.getViewPanel(),this.getTodoPanel()],split:!0}],this.getEditorPanel().on("notesaved",this.getNotePanel().updateNote,this.getNotePanel()),this.getEditorPanel().on("tagchanged",this.owner.loadTagAndShortcut,this.owner),this.getEditorPanel().on("parentchanged",this.onChangeParent,this),SYNO.SDS.NoteStation.Utils.isPublicShare?o=this.createPublicShareTBar():SYNO.SDS.NoteStation.Utils.isNormal&&(o=this.createTBar()),e={cls:"syno-ns-mainpanel",tbar:o,layout:"border",items:i},Ext.apply(e,t),e},onShowContentByDefault:function(){var t,e=this.findAppWindow();if(SYNO.SDS.NoteStation.Utils.isShowNote)return void e.selectNote(SYNO.SDS.NoteStation.Define.OBJECT_ID);t=e.getPanelScope("SYNO.SDS.NoteStation.Note.Panel"),SYNO.SDS.NoteStation.Utils.isShowNotebook?e.getStorage().getNotebook({object_id:SYNO.SDS.NoteStation.Define.OBJECT_ID,callback:function(o,i){if(!0!==o)return void this.owner.mask(.5,SYNO.SDS.NoteStation.Utils.getErrorStr(i.code));e.analyzeNotebook({total:1,notebooks:[i]},!0),t.switchPanel(!0,SYNO.SDS.NoteStation.Define.OBJECT_ID,"notebook")},scope:this}):SYNO.SDS.NoteStation.Utils.isShowSmart&&e.getStorage().getSmart({object_id:SYNO.SDS.NoteStation.Define.OBJECT_ID,callback:function(o,i){if(!0!==o)return void this.owner.mask(.5,SYNO.SDS.NoteStation.Utils.getErrorStr(i.code));e.analyzeSmart({total:1,smarts:[i]},!0),t.switchPanel(!0,SYNO.SDS.NoteStation.Define.OBJECT_ID,"smart")},scope:this})},onChangeParent:function(t,e){var o,i,n,s,a,r;i=this.findAppWindow(),i.owned.note[t.object_id].parent_id=e.parent_id,i.owned.notebook[t.parent_id].item_count--,i.owned.notebook[e.parent_id].item_count++;try{r="all"===this.notebookPanel.fullMenu.getSelectionModel().getSelectedNodes()[0].attributes.ref_id}catch(t){r=!1}Ext.isObject(this.getNotebookPanel().getLayout())&&(n=this.getNotebookPanel().getLayout().activeItem,o=n.getNodeById(n.notebook_id),s=o.findChild("object_id",t.parent_id),Ext.isObject(s)&&(a=Ext.apply({},s.attributes),a.total--,o.replaceChild(new Ext.tree.AsyncTreeNode(a),s)),s=o.findChild("object_id",e.parent_id),Ext.isObject(s)&&(a=Ext.apply({},s.attributes),a.total++,o.replaceChild(new Ext.tree.AsyncTreeNode(a),s))),r||i.selectNotebook(e.parent_id),i.selectNote(e.object_id)},getMobilePanel:function(){return Ext.isEmpty(this.mobilePanel)&&(this.mobilePanel=new SYNO.SDS.NoteStation.Mobile.Panel({owner:this,region:"center",layout:"card"})),this.mobilePanel},getNotebookPanel:function(){return Ext.isEmpty(this.notebookPanel)&&(this.notebookPanel=new SYNO.SDS.NoteStation.Notebook.Panel({width:200,minWidth:60,owner:this,region:"west",layout:"card",split:!0,html:""})),this.notebookPanel},getViewPanel:function(){return Ext.isEmpty(this.viewPanel)&&(this.viewPanel=new SYNO.ux.Panel({xtype:"syno_panel",layout:"border",itemId:"view_panel",items:[this.getNotePanel(),this.getEditorPanel()],split:!0})),this.viewPanel},getNotePanel:function(){return Ext.isEmpty(this.notePanel)&&(this.notePanel=new SYNO.SDS.NoteStation.Note.Panel({owner:this,region:"west",width:SYNO.SDS.NoteStation.Define.SNIPPETVIEW_MINIMUM_WIDTH,layout:"card",html:"",split:!0,minWidth:SYNO.SDS.NoteStation.Define.SNIPPETVIEW_MINIMUM_WIDTH,itemId:"note"})),this.notePanel},getEditorPanel:function(){return Ext.isEmpty(this.editorPanel)&&(this.editorPanel=new SYNO.SDS.NoteStation.Editor.Panel({owner:this,region:"center",layout:"card",minWidth:600})),this.editorPanel},getTodoPanel:function(){return Ext.isEmpty(this.todoPanel)&&(this.todoPanel=new SYNO.SDS.NoteStation.Todo.Panel({owner:this,itemId:"todo_panel",layout:"border"})),this.todoPanel},getCrossPanelCtxMenu:function(){return Ext.isEmpty(this.crossPanelCtxMenu)&&(this.crossPanelCtxMenu=new SYNO.SDS.NoteStation.CtxMenu({})),this.crossPanelCtxMenu},createTBar:function(){var t=this.getSearchField();this.statusBtn=new Ext.BoxComponent({cls:"syno-ns-status-syncing-btn",itemId:"status",hidden:!0});var e=[t,{xtype:"tbspacer",width:8},{disabled:_S("demo_mode"),xtype:"syno_splitbutton",itemId:"note_create_btn",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","create"),cls:"syno-ns-create-btn",iconCls:"syno-ns-create-btn-icon",handler:this.createNote,scope:this,menu:new SYNO.ux.Menu({ignoreParentClicks:!0,cls:"syno-ns-menu",items:[{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("note","create"),handler:this.createNote,scope:this},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("note","create_encrypt"),handler:function(){new SYNO.SDS.NoteStation.Encrypt.Window({owner:this.findAppWindow()}).show()},scope:this},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("note","create_in"),menu:this.getNotebookMenu()},"-",{
text:SYNO.SDS.NoteStation._T("stack","create"),handler:function(){this.createStack([])},scope:this},{disabled:_S("demo_mode"),text:SYNO.SDS.NoteStation._T("notebook","create"),handler:this.createNotebook,scope:this},{text:SYNO.SDS.NoteStation._T("smart","create"),handler:this.createSmart,scope:this}]})},{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","sync"),listeners:{click:{fn:function(){this.syncNowWithSelect(this.getEditorPanel().getNoteId())},scope:this}},scope:this},{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","setting"),handler:function(){new SYNO.SDS.NoteStation.Setting.Window({owner:this.owner,module:this}).show()},scope:this},this.statusBtn,{xtype:"tbfill"},this.getTodoFilterConfig(),this.getTodoSortConfig()];return new SYNO.ux.Toolbar({cls:"syno-ns-toolbar",items:e})},getTodoFilterConfig:function(){return this.todoMenuFilter=new SYNO.SDS.NoteStation.Todo.Menu.Filter({owner:this}),{itemId:"todo_filter",cls:"syno-ns-todo-filter-btn",hidden:!0,menu:this.todoMenuFilter}},getTodoSortConfig:function(){return this.todoMenuSortBy=new SYNO.SDS.NoteStation.Todo.Menu.SortBy({owner:this}),{itemId:"todo_sort_by",hidden:!0,cls:"syno-ns-todo-sort-btn",menu:this.todoMenuSortBy}},createImportEvernoteWindow:function(t){new SYNO.SDS.NoteStation.ImportEvernote.Window(Ext.apply({owner:this.owner},t)).open()},createNote:function(t,e){var o=this,i=this.findAppWindow();if(!Ext.isEmpty(t)&&Ext.isString(t)||(t=Ext.isObject(i.choosed)&&i.choosed.id&&i.choosed.id in i.joined.notebook&&"rw"===i.joined.notebook[i.choosed.id].perm?i.choosed.id:Ext.isEmpty(i.owned.choosed)?i.owned.preset_id:i.owned.choosed),Ext.isEmpty(t))return void SYNO.Debug("No Notebook selected!");var n={parent_id:t,title:SYNO.SDS.NoteStation._T("note","untitled"),encrypt:!1};Ext.isObject(e)&&Ext.copyTo(n,e,"content,brief,title,commit_msg"),Ext.isObject(e)&&!0===e.encrypt&&(n.encrypt=!0,n.password=e.pwd,n.content=CryptoJS.AES.encrypt(SYNO.SDS.NoteStation.Define.MAGIC,e.pwd).toString()),i.setStatusBusy(),SYNO.SDS.NoteStation.Geolocation.getCurrentGPS().then(function(t){return t&&(n.latitude=t.lat,n.longitude=t.lng),n}).then(function(t){return i.getStorage().createNoteAsync(t)}).then(function(t){var e=t.succ,i=t.resp,n=t.result;o.afterCreateNote(e,n,i)})},afterCreateNote:function(t,e,o){var i,n=this.findAppWindow();if(!t)return n.getMsgBox().alert("",SYNO.SDS.NoteStation.Utils.getErrorStr(e)),void n.clearStatusBusy();i=function(){n.analyzeNote({total:1,notes:[o]}),!0===e.owned?(n.owned.notebook[e.parent_id].item_count++,-1===n.owned.all.indexOf(o.object_id)&&n.owned.all.push(o.object_id)):n.joined.notebook[e.parent_id].item_count++,n.clearStatusBusy(),n.selectNotebook(e.parent_id),n.selectNote(e.object_id,"select"),n.selectNote(e.object_id,"edit"),e.parent_id in n.shortcut&&(n.shortcut[e.parent_id].item_count++,n.fireEvent("shortcutloaded",n.shortcut)),n.fireEvent("ownednotebookloaded",n.owned),n.fireEvent("joinednotebookloaded",n.joined),n.selectNotebook(e.parent_id,"highlight"),n.selectNote(e.object_id,"select")},e.encrypt?n.createEncryptToken(e,i,this):i.call(this)},createNotebook:function(){var t=this.findAppWindow();this.createNotebookWin=new SYNO.SDS.NoteStation.Operate.Window({owner:t,title:SYNO.SDS.NoteStation._T("notebook","create"),message:SYNO.SDS.NoteStation._T("notebook","create_title"),type:"create_notebook"}),this.createNotebookWin.show()},afterCreateNotebook:function(t,e){var o=this.findAppWindow();!1===t&&SYNO.SDS.NoteStation.Utils.showErrorMsg(o,e),o.getStorage().listNotebook({callback:function(t,e){o.onLoadAllData(!0,{notebook:e.notebook}),Ext.isObject(o.choosed)&&"category"===o.choosed.type&&"owned"===o.choosed.id&&o.selectNotebook("owned")},scope:this})},renameNotebook:function(t,e,o,i){var n=this.findAppWindow();new SYNO.SDS.NoteStation.Operate.Window({owner:n,object_id:t,ori_title:e,callback_scope:i,callback:o,title:SYNO.SDS.NoteStation._T("notebook","rename"),message:SYNO.SDS.NoteStation._T("notebook","create_title"),type:"rename_notebook"}).show()},moveToNotebook:function(t,e){var o,i=this.findAppWindow(),n={};o=SYNO.SDS.NoteStation.Utils.getNoteDataById(i,t),Ext.apply(o,{object_id:t}),n=Ext.apply({},{parent_id:e},o),n.callback=function(t,e){if(!this.isDestroyed)return!1===t?void SYNO.SDS.NoteStation.Utils.showErrorMsg(i,e):void this.syncNow(void 0,void 0,"selectfirst")},n.scope=this,i.getStorage().setNote(n)},moveNotesToNotebook:function(t,e){var o,i=this.findAppWindow(),n={},s=this.getNotebookPanel();o=t.slice(),Ext.each(o,function(o,n){o in i.owned.note&&e===i.owned.note[o].parent_id&&t.remove(o)}),Ext.isEmpty(t)||(s.setStatusBusy(),n=Ext.apply({},{parent_id:e,object_id:t}),n.callback=function(e,o){if(!this.isDestroyed){!1===e&&SYNO.SDS.NoteStation.Utils.showErrorMsg(i,o);try{-1!==t.indexOf(this.getEditorPanel().getLayout().activeItem.noteData.object_id)&&this.getEditorPanel().reloadNote()}catch(t){}this.syncNow(void 0,void 0,"selectfirst")}},n.scope=this,i.getStorage().setNote(n))},openCreateTagDialog:function(t,e){var o=this.findAppWindow();new SYNO.SDS.NoteStation.Operate.Window({owner:o,height:264,tag_id:"",ori_parent:"",ori_title:"",callback_scope:e,callback:t,title:SYNO.SDS.NoteStation._T("tag","add_tag"),type:"create_tag",message:SYNO.SDS.NoteStation._T("tag","create_title")}).show()},renameTag:function(t,e,o,i){var n=this.findAppWindow(),s=t.substr(0,t.lastIndexOf("@")),a=SYNO.SDS.NoteStation.Utils.getTagParent(s,e);new SYNO.SDS.NoteStation.Operate.Window({owner:n,height:264,tag_id:t,ori_parent:a,ori_title:e,callback_scope:i,callback:o,title:SYNO.SDS.NoteStation._T("tag","rename"),type:"rename_tag",message:SYNO.SDS.NoteStation._T("tag","create_title")}).show()},deleteNotebook:function(t){var e,o=this.findAppWindow(),i=this.getNotePanel(),n=this.getEditorPanel(),s=[],a=!1,r=!1,l=!1,d=function(){o.clearStatusBusy(),"note_category"===i.layout.activeItem.itemId?a?o.selectNotebook("owned"):r&&o.selectNotebook("joined"):Ext.isObject(i.query_params)&&-1!==s.indexOf(i.query_params.parent_id)&&i.clearData(),Ext.isObject(n.layout.activeItem.noteData)&&-1!==s.indexOf(n.layout.activeItem.noteData.parent_id)&&n.layout.setActiveItem("editor_empty")};Ext.isString(t)?s.push(t):Ext.isArray(t)&&(s=t),Ext.isEmpty(s)||(s[0]in o.owned.notebook?(l=o.owned.notebook[s[0]].archive,a=!0):s[0]in o.joined.notebook&&(l=o.joined.notebook[s[0]].archive,r=!0),e=!0===l?SYNO.SDS.NoteStation._T("notebook","archive_delete"):SYNO.SDS.NoteStation._T("notebook","delete"),o.getMsgBox().confirmDelete("",e,function(e){"yes"===e&&(o.setStatusBusy(),o.getStorage().deleteNotebook({object_id:t,recursive:l,callback:function(t,e){t||SYNO.SDS.NoteStation.Utils.showErrorMsg(o,e),o.loadAllDataAsync().then(d)},scope:this}))},this))},deleteNoteAsync:function(t,e){void 0===e&&(e={});var o=this.findAppWindow(),i=this.getNotePanel(),n=this.getEditorPanel();return Ext.isEmpty(t)?Promise.resolve(!1):(Ext.isBoolean(e.recycle)||(t in o.owned.note&&!0===o.owned.note[t].archive?e.recycle=!1:e.recycle=!0),i.setStatusBusy(),o.getStorage().deleteNoteAsync(Object.assign({object_id:t},e)).then(function(e){var s=e.succ,a=e.resp;return new Promise(function(e){var r=i.layout.activeItem;s||(SYNO.SDS.NoteStation.Utils.showErrorMsg(o,a),e(!1)),o.loadAllDataAsync().then(function(){var o,s;i.clearStatusBusy(),r.loadData(!1,i.sort_info.sort_by,i.sort_info.sort_direction),o=n.layout.activeItem,Ext.isObject(o.noteData)&&(s=o.noteData.object_id,(Ext.isString(t)&&s===t||Ext.isArray(t)&&-1!==t.indexOf(s))&&(o.clearNote(),n.layout.setActiveItem("editor_empty"))),e(!0)})})}))},deletePermission:function(t){var e=this.findAppWindow(),o=this.getNotePanel(),i=this.getEditorPanel();o.setStatusBusy(),e.getStorage().deletePermission({object_id:t,username:e._S("user"),callback:function(n,s){n||SYNO.SDS.NoteStation.Utils.showErrorMsg(e,s);var a=o.layout.activeItem,r=i.layout.activeItem;o.clearStatusBusy(),e.loadAllDataAsync().then(function(){a.loadData(!1,o.sort_info.sort_by,o.sort_info.sort_direction)}),r&&Ext.isObject(r.noteData)&&(r.noteData.parent_id!==t&&r.noteData.smart_id!==t||i.layout.setActiveItem("editor_empty"))},scope:this})},emptyRecycleBin:function(){var t=this.findAppWindow(),e=t.owned.recycle,o=[];0!==e.length&&t.getMsgBox().confirmDelete(SYNO.SDS.NoteStation._T("note","delete"),SYNO.SDS.NoteStation._T("common","empty_recycle"),function(t,i){var n=this;"cancel"!==t&&(Ext.each(e,function(t){o.push(t)},this),this.deleteNoteAsync(o,{recycle:!1}).then(function(){n.getNotePanel().setStatusBusy(),n.getNotePanel().clearData(),n.getNotePanel().clearStatusBusy()}))},this)},restoreNote:function(t){var e=this.findAppWindow(),o=this.getNotePanel();o.setStatusBusy(),e.getStorage().restoreNote({object_id:t,callback:function(i,n){i||SYNO.SDS.NoteStation.Utils.showErrorMsg(e,n),o.clearStatusBusy(),e.loadAllDataAsync().then(function(){e.selectNote(t)})},scope:this})},copyNote:function(t,e,o){var i=this.findAppWindow();i.setStatusBusy(),i.getStorage().copyNote(Ext.apply({callback:function(n,s){n||SYNO.SDS.NoteStation.Utils.showErrorMsg(i,s),t.encrypt&&i.createEncryptToken({object_id:s.object_id,password:t.password}),i.clearStatusBusy(),i.loadAllDataAsync().then(function(){Ext.isEmpty(t.parent_id)?Ext.isEmpty(t.choosed)?i.selectNotebook(i.owned.preset_id):"notebook"===t.choosed.type?i.selectNotebook(t.choosed.id):"tag"===t.choosed.type?i.selectTag(t.choosed.id):"note"===t.choosed.type?i.selectNotebook(i.owned.note[t.choosed.id].parent_id):i.selectNotebook(i.owned.preset_id):i.selectNotebook(t.parent_id),Ext.isString(t.object_id)?i.selectNote(s.object_id):Ext.isArray(t.object_id)&&1===t.object_id.length&&Ext.isString(t.object_id[0])&&i.selectNote(s[0].object_id),Ext.isFunction(e)&&e.call(o||window,s)})},scope:this},t))},restoreNoteVersion:function(t,e,o){var i=this.findAppWindow();i.getStorage().restoreNoteVersion(Ext.apply({callback:function(n,s){n||SYNO.SDS.NoteStation.Utils.showErrorMsg(i,s),this.getEditorPanel().layout.activeItem.clearNote(),i.loadAllDataAsync().then(function(){i.selectNotebook(t.parent_id),i.selectNote(t.object_id),Ext.isFunction(e)&&e.call(o||window,n,s)})},scope:this},t))},deleteTag:function(t){var e,o=this.findAppWindow(),i=this.getNotebookPanel();e=o.tag[t].title,i.setStatusBusy(),o.getStorage().deleteTag({tag_id:t,callback:function(t,n){if(i.clearStatusBusy(),!0!==t)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(o,n);o.loadTagAndShortcut(function(){var t=this.getEditorPanel().getLayout().activeItem;"editor_normal"===t.itemId&&Ext.isObject(t.noteData)&&Ext.isArray(t.noteData.tag)&&t.noteData.owner.uid===o.owner_uid&&-1!==t.noteData.tag.indexOf(e)&&this.getEditorPanel().reloadNote()},this)},scope:this})},addToShortcut:function(t,e,o){var i=this.findAppWindow(),n=this.getNotebookPanel();n.setStatusBusy(),i.getStorage().setShortcut(Ext.copyTo({callback:function(t,s){n.clearStatusBusy(),!0===t?i.loadTagAndShortcut.call(i,e,o):SYNO.SDS.NoteStation.Utils.showErrorMsg(i,s)},scope:this},t,"object_id,tag_id,stack_id"))},removeFromShortcut:function(t,e,o){var i=this.findAppWindow(),n=this.getNotebookPanel();n.setStatusBusy(),i.getStorage().deleteShortcut(Ext.copyTo({callback:function(t,s){n.clearStatusBusy(),!0===t?i.loadTagAndShortcut.call(i,e,o):SYNO.SDS.NoteStation.Utils.showErrorMsg(i,s)},scope:this},t,"object_id,tag_id,stack_id"))},shareNote:function(t,e,o){var i=this.findAppWindow();Ext.isEmpty(t)||i.getStorage().getNote({object_id:t,callback:function(t,i){!0===t&&this.openShareWindow(i,e,o)},scope:this})},shareNotebook:function(t,e,o){var i=this.findAppWindow();Ext.isEmpty(t)||i.getStorage().getNotebook({object_id:t,callback:function(t,i){!0===t&&this.openShareWindow(i,e,o)},scope:this})},setAsPreset:function(t,e,o){var i=this.findAppWindow(),n=this.getNotebookPanel();Ext.isEmpty(t)||(n.setStatusBusy(),i.getStorage().setAsPreset({object_id:t,callback:function(s,a){if(n.clearStatusBusy(),!s)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(i,a);i.owned.preset_id=t,Ext.iterate(i.owned.notebook,function(e,o){o.preset=e===t},this),i.fireEvent("ownednotebookloaded",i.owned),i.fireEvent("joinednotebookloaded",i.joined),Ext.isFunction(e)&&e.call(o||this,!0)},scope:this}))},refreshNotebook:function(t,e){var o=this.findAppWindow();this.getNotebookPanel().setStatusBusy(),o.getStorage().listNotebook({callback:function(i,n){var s=this.getNotePanel().getLayout().activeItem;if(!i)return this.getNotebookPanel().clearStatusBusy(),void(Ext.isFunction(t)&&t.call(e||this,i,n));o.onLoadAllData(!0,{notebook:n.notebook}),o.loadTagAndShortcut(),Ext.isObject(s)&&"note_category"===s.itemId&&Ext.isObject(s.query_info)&&"owned"===s.query_info.category&&this.getNotePanel().reloadData(),this.getNotebookPanel().clearStatusBusy(),Ext.isFunction(t)&&t.call(e||this,i,n)},scope:this})},createStack:function(t){new SYNO.SDS.NoteStation.Stack.Window({owner:this.findAppWindow(),title:SYNO.SDS.NoteStation._T("stack","create"),message:SYNO.SDS.NoteStation._T("stack","create_title"),notebookIds:t}).show()},moveNotebooksToStack:function(t,e){var o=this.findAppWindow();!Ext.isEmpty(t)&&Ext.isString(e)&&(this.getNotebookPanel().setStatusBusy(),o.getStorage().setNotebook({object_id:t,stack:e,callback:function(t,e){this.getNotebookPanel().clearStatusBusy(),t||SYNO.SDS.NoteStation.Utils.showErrorMsg(o,e),this.refreshNotebook()},scope:this}))},renameStackAsync:function(t){var e=this,o=this.findAppWindow(),i=o.getMainPanel(),n=new SYNO.SDS.NoteStation.RenameStack.Window({owner:o,stack_id:t,ori_title:o.owned.stack[t].title});return n.show(),n.getDialogPromise().then(function(n){if(!n)return null;var s=n.name;return i.notebookPanel.setStatusBusy(),new Promise(function(e){o.getStorage().setStack({stack_id:t,name:s,callback:function(t,o){e({succ:t,resp:o})}})}).then(function(t){var n=t.succ,a=t.resp;return i.notebookPanel.clearStatusBusy(),n?new Promise(function(t){e.refreshNotebook(function(e,o){t(s)})}):(SYNO.SDS.NoteStation.Utils.showErrorMsg(o,a),null)})})},deleteStack:function(t,e,o){var i=this.findAppWindow();i.getMsgBox().confirmDelete("",SYNO.SDS.NoteStation._T("stack","delete"),function(n){"yes"===n&&(this.getNotebookPanel().setStatusBusy(),i.getStorage().deleteStack({stack_id:t,callback:function(t,n){this.getNotebookPanel().clearStatusBusy(),t?this.refreshNotebook(e,o):(SYNO.SDS.NoteStation.Utils.showErrorMsg(i,n),Ext.isFunction(e)&&e.call(o||this,t,n))},scope:this}))},this)},openShareWindow:function(t,e,o){new SYNO.SDS.NoteStation.Share.Window({owner:this.findAppWindow(),shareType:t.category,objectData:t,onObjectChanged:{callback:e,scope:o}}).show()},getNotebookMenu:function(){return new SYNO.ux.Menu({cls:"syno-ns-menu",ignoreParentClicks:!0,listeners:{beforeshow:function(t){var e=this;SYNO.SDS.NoteStation.Utils.showNotebookMenu(t,this.findAppWindow(),function(t){return e.createNote.createDelegate(e,[t.id,void 0])})},scope:this}})},getSearchField:function(){return this.searchField||(this.searchField=new SYNO.SDS.NoteStation.SearchField({owner:this,width:200})),this.searchField},getAdvancedSearchPanel:function(){},createPublicShareTBar:function(){var t=this,e=[{xtype:"syno_button",iconCls:"syno-ns-publicshare-prev-icon",itemId:"prev_btn",hidden:!0,listeners:{click:this.onClickPrevious,beforehide:function(t){this.getTopToolbar().getComponent("title_left_space").setWidth(this.getTitleCenter(!1))},beforeshow:function(t){this.getTopToolbar().getComponent("title_left_space").setWidth(this.getTitleCenter(!0))},scope:this}},{xtype:"tbspacer",itemId:"title_left_space",width:this.getTitleCenter()},{xtype:"label",text:SYNO.SDS.NoteStation._T("app","displayname"),cls:"syno-ns-publishare-title",itemId:"title_label"},"->",{xtype:"syno_button",iconCls:"syno-ns-publicshare-share-icon",menuAlign:"tr-br?",itemId:"share_btn",menu:new SYNO.ux.Menu({cls:"syno-ns-publicshare-menu",items:[this.getShareFormPanel()],anchor:"100% 100%",defaultOffsets:[44,6]})},{xtype:"syno_button",itemId:"search_btn",iconCls:"syno-ns-publicshare-search-icon",hidden:SYNO.SDS.NoteStation.Utils.isShowNote,listeners:{click:this.onClickSearch,scope:this}},{xtype:"syno_searchfield",hidden:!0,itemId:"publicshare_searchfield",ctCls:"syno-ns-publicshare-searchfield-ct",width:250,cls:"syno-ns-publicshare-searchfield",listeners:{keyup:{fn:function(){t.fullTextSearch({keyword:this.getValue(),parent_id:SYNO.SDS.NoteStation.Define.OBJECT_ID})},buffer:200}},onTriggerClick:function(){this.disabled||(SYNO.ux.SearchField.superclass.onTriggerClick.apply(this,arguments),t.fullTextSearch({keyword:this.getValue(),parent_id:SYNO.SDS.NoteStation.Define.OBJECT_ID}))}},{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),cls:"syno-publicshare-cancel-btn",iconCls:"syno-ns-publicshare-cancel-icon",listeners:{click:this.onClickCancel,scope:this},itemId:"cancel_btn",hidden:!0}];return new SYNO.ux.Toolbar({cls:"syno-ns-toolbar-publicshare",items:e,listeners:{scope:this,resize:function(t,e,o,i,n){var s=t.getComponent("prev_btn").isVisible();t.getComponent("title_left_space").setWidth(this.getTitleCenter(s,e))}}})},onClickPrevious:function(){var t=this.getTopToolbar(),e=this.getMobilePanel();t.getComponent("prev_btn").hide(),t.getComponent("share_btn").show(),t.getComponent("search_btn").show(),SYNO.SDS.NoteStation.Utils.isMobileDevice&&e.layout.setActiveItem("note")},onClickSearch:function(){var t=this.getTopToolbar();t.getComponent("share_btn").hide(),t.getComponent("search_btn").hide(),t.getComponent("publicshare_searchfield").show(),t.getComponent("cancel_btn").show(),SYNO.SDS.NoteStation.Utils.isMobileDevice&&(t.getComponent("title_label").hide(),t.getComponent("title_left_space").hide())},onClickCancel:function(){var t=this.getTopToolbar();t.getComponent("share_btn").show(),t.getComponent("search_btn").show(),t.getComponent("publicshare_searchfield").setValue(""),t.getComponent("publicshare_searchfield").hide(),t.getComponent("cancel_btn").hide(),SYNO.SDS.NoteStation.Utils.isMobileDevice&&(t.getComponent("title_label").show(),t.getComponent("title_left_space").show()),this.switchToOrigin()},getTitleCenter:function(t,e){var o=0,i=this.getTopToolbar();if(!Ext.isEmpty(i))return Ext.isEmpty(e)&&(e=window.innerWidth),Ext.isBoolean(t)&&t&&o++,e/2-56-34*o},getShareFormPanel:function(){var t=document.location.href;return this.shareSNFormPanel=new SYNO.ux.FormPanel({width:320,height:68,hideLabel:!0,hideLabels:!0,cls:"syno-ns-publicshare-formpanel",shareType:"note",items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("share","public_share_link")+SYNO.SDS.NoteStation._T("common","colon")},{xtype:"syno_textfield",readOnly:!0,anchor:"100%",itemId:"sharelink",value:t,selectOnFocus:!0,cls:"syno-ns-share-publicshare-text",listeners:{focus:function(){var t=this.getEl().dom;t.setSelectionRange(0,t.value.length)}}}]}),this.shareSNFormPanel},fullTextSearch:function(t){var e=this.getNotePanel(),o=e.getTopToolbar(),i=o.getComponent("btn_note_display_mode"),n=o.getComponent("btn_switch_notebook"),s=o.getComponent("display_title"),a=o.getComponent("search_title"),r=e.sort_info;if(function(){var e;for(e in t){if("keyword"!==e)return!1;if(""!==t[e])return!1}return!0}())return void this.switchToOrigin();n.hide(),i.hide(),s.hide(),a.show(),a.setValue(SYNO.SDS.NoteStation._T("search","result_title")),e.layout.setActiveItem("note_search"),e.getComponent("note_search").loadData(!1,r.sort_by,r.sort_direction,t)},switchToOrigin:function(){var t,e,o=this.getNotePanel(),i=this.getNotebookPanel(),n=o.getTopToolbar(),s=n.getComponent("btn_note_display_mode"),a=n.getComponent("btn_switch_notebook"),r=n.getComponent("display_title"),l=n.getComponent("search_title");s.show(),l.hide(),o.layout.setActiveItem("note_"+o.view_by),t=i.layout.activeItem,Ext.isObject(t)&&(e=t.getItemId(),"full_menu"===e?(a.hide(),r.show()):"light_menu"===e?(a.show(),r.hide()):SYNO.Debug("notebookMode error",e))},getSelectedString:function(){var t,e,o=this.getNotebookPanel(),i=o.layout.activeItem;if("full_menu"===i.itemId?t=i.getSelectionModel().getSelectedNodes()[0]:"light_menu"===i.itemId&&(t=i.getSelectedRecords()[0]),Ext.isEmpty(t))return i.itemId+":NULL";if(!0===Ext.isObject(t.attributes)){var n=t.attributes;e=t.category||"None",e+=n.object_id||String(n.ref_id)||n.tag_id||"None"}else e=t.id||"NULL";return i.itemId+":"+e},syncNowWithSelect:function(t){var e=this.getSelectedString();Ext.isEmpty(t)&&(t=this.getEditorPanel().getNoteId()),this.syncNow(void 0,void 0,void 0,function(){var o=this.findAppWindow(),i=this.getEditorPanel().layout.activeItem,n=i.itemId;if(!Ext.isEmpty(t)&&e===this.getSelectedString())if("editor_empty"===n)o.selectNote(t,"select"),o.selectNote(t);else try{i.noteData.object_id===t&&o.selectNote(t,"select")}catch(t){}},this)},syncNow:function(t,e,o,i,n){var s,a,r,l,d,c,h,u=this,S=!1;Ext.isFunction(i)&&this.sync_callback.push({cb:i,scope:n}),!0!==this.isSyncing&&(s=this.findAppWindow(),a=this.getEditorPanel().normalPanel,r=this.getNotebookPanel(),r.fullMenu.isVisible()?(l=r.fullMenu.getSelectionModel().getSelectedNodes()[0],Ext.isObject(l)&&(h=l.attributes,c=Ext.isEmpty(h.object_id)?h.ref_id:h.object_id)):r.lightMenu.isVisible()&&(l=r.lightMenu.getSelectedRecords()[0],c=l.data.note_type),!Ext.isEmpty(t)&&(t in s.owned.note||t in s.joined.note)&&(S=!0),d=function(i){var n=i.succ;i.resp;if(u.getEditorPanel().verify_note(),Ext.isEmpty(l)||u.isDestroyed)return void(!0===n?u.setSyncStatus("done"):u.setSyncStatus("error"));!0===S?s.selectNote(t,e):s.selectNotebook(c,o),!0===n?u.setSyncStatus("done"):u.setSyncStatus("error")},this.setSyncStatus("syncing"),a.isVisible()?a.saveNote(function(){s.loadAllDataAsync().then(d)}):s.loadAllDataAsync().then(d))},setSyncStatus:function(t){!this.isDestroyed&&this.statusBtn&&(this.statusBtn.removeClass("syno-ns-status-done-btn"),this.statusBtn.removeClass("syno-ns-status-syncing-btn-btn"),this.statusBtn.removeClass("syno-ns-status-error-btn"),"syncing"===t?(this.statusBtn.addClass("syno-ns-status-syncing-btn"),this.statusBtn.show(),this.setSyncFlag(!0)):"done"===t?(this.statusBtn.addClass("syno-ns-status-done-btn"),Ext.defer(function(){this.isDestroyed||(this.statusBtn.hide(),this.setSyncFlag(!1))},this.syncDuration,this)):"error"===t&&(this.statusBtn.addClass("syno-ns-status-error-btn"),this.statusBtn.show(),this.setSyncFlag(!1)))},handleSyncCallback:function(){var t;0!==this.sync_callback.length&&(t=this.sync_callback,this.sync_callback=[],window.setTimeout(function(){Ext.iterate(t,function(t){t.cb.call(t.scope)})},80))},setSyncFlag:function(t){this.isSyncing=t,!1===t&&this.handleSyncCallback()},createExportNotebookWindow:function(t){new SYNO.SDS.NoteStation.ExportNotebook.Window(Ext.apply({owner:this.owner},t)).open()},createImportNotebookWindow:function(t){new SYNO.SDS.NoteStation.ImportNotebook.Window(Ext.apply({owner:this.owner},t)).open()},exportNotebook:function(t,e,o){var i=this.findAppWindow();Ext.isObject(t)&&(t.callback=function(t,n){!0!==t&&SYNO.SDS.NoteStation.Utils.showErrorMsg(i,n),Ext.isFunction(e)&&e.call(o||window,t,n)},i.getStorage().exportNotebook(t))},importNotebook:function(t,e,o){var i=this.findAppWindow();Ext.isObject(t)&&(t.callback=function(t,n){t||SYNO.SDS.NoteStation.Utils.showErrorMsg(i,n),Ext.isFunction(e)&&e.call(o||window,t,n)},t.scope=this,"enex"===t.file_extension?i.getStorage().importEnex(t):i.getStorage().importNotebook(t))},exportNote:function(t,e,o){var i=this.findAppWindow();Ext.isObject(t)&&(t.callback=function(t,n){t||SYNO.SDS.NoteStation.Utils.showErrorMsg(i,n),Ext.isFunction(e)&&e.call(o||window,t,n)},t.scope=this,t.timezone_offset=-60*(new Date).getTimezoneOffset(),i.getStorage().exportNote(t))},exportWord:function(t,e,o){var i=this.findAppWindow();Ext.isObject(t)&&(t.callback=function(t,n){t||SYNO.SDS.NoteStation.Utils.showErrorMsg(i,n),Ext.isFunction(e)&&e.call(o||window,t,n)},t.scope=this,i.getStorage().exportWord(t))},archiveNotebook:function(t,e,o,i){var n,s,a=this.findAppWindow(),r=this.getNotebookPanel(),l="skip_archive_notify";if(!Ext.isEmpty(t))if(n=function(e,n){var s,l;if(r.clearStatusBusy(),e){try{s=this.getEditorPanel().layout.activeItem.noteData,l=Ext.isString(t)&&t===s.parent_id?s.object_id:Ext.isArray(t)&&-1!==t.indexOf(s.parent_id)?s.object_id:null}catch(t){SYNO.Debug(t)}this.syncNow(l)}else SYNO.SDS.NoteStation.Utils.showErrorMsg(a,n);Ext.isFunction(o)&&o.call(i||window,e,n)},s=function(){r.setStatusBusy(),a.getStorage().archiveNotebook({object_id:t,enable:e,callback:n,scope:this})},!0===e&&!0!==a.appInstance.getUserSettings(l)){var d=new SYNO.SDS.NoteStation.Notify.Window({title:SYNO.SDS.NoteStation._T("notebook","archive"),notify_text:SYNO.SDS.NoteStation._T("notebook","archive_warning"),notify_state:l,owner:a,module:this,callback:function(t){"yes"===t&&s.call(this)},scope:this});d.open()}else s.call(this)},createSmart:function(t){var e=this.findAppWindow();Ext.isObject(t)?Ext.isEmpty(t.query)&&(t.query={}):t={query:{}},this.createSmartWin=new SYNO.SDS.NoteStation.Smart.Window({owner:e,title:SYNO.SDS.NoteStation._T("smart","create"),action:"create",query:t.query}),this.createSmartWin.show()},setSmart:function(t,e,o){var i=this.findAppWindow();Ext.isString(t)&&i.getStorage().getSmart({object_id:t,callback:function(e,o){if(!0!==e)return void SYNO.SDS.NoteStation.Utils.showErrorMsg(i,o);this.editSmartWin=new SYNO.SDS.NoteStation.Smart.Window({owner:i,title:SYNO.SDS.NoteStation._T("smart","edit"),action:"set",object_id:t,smart_title:o.title,query:o.query}),this.editSmartWin.show()},scope:this})},renameSmart:function(t,e,o,i){new SYNO.SDS.NoteStation.Operate.Window({owner:this.findAppWindow(),object_id:t,ori_title:e,callback_scope:i,callback:o,title:SYNO.SDS.NoteStation._T("notebook","rename"),message:SYNO.SDS.NoteStation._T("notebook","create_title"),type:"rename_smart"}).show()},deleteSmart:function(t){var e,o=this.findAppWindow(),i=this.getNotePanel(),n=this.getEditorPanel(),s=[],a=!1,r=!1,l=function(){o.clearStatusBusy(),"note_category"===i.layout.activeItem.itemId?a?o.selectNotebook("smart"):r&&o.selectNotebook("joined"):Ext.isObject(i.query_params)&&i.query_params.smart_id&&-1!==s.indexOf(i.query_params.smart_id)&&i.clearData(),Ext.isObject(n.layout.activeItem.noteData)&&n.layout.activeItem.noteData.smart_id&&-1!==s.indexOf(n.layout.activeItem.noteData.smart_id)&&n.layout.setActiveItem("editor_empty")};Ext.isString(t)?s.push(t):Ext.isArray(t)&&(s=t),Ext.isEmpty(s)||(s[0]in o.owned.smart?a=!0:s[0]in o.joined.smart&&(r=!0),e=SYNO.SDS.NoteStation._T("smart","delete"),o.getMsgBox().confirmDelete("",e,function(e){"yes"===e&&(o.setStatusBusy(),o.getStorage().deleteSmart({object_id:t,callback:function(t,e){t||SYNO.SDS.NoteStation.Utils.showErrorMsg(o,e),o.loadAllDataAsync().then(l)},scope:this}))},this))},shareSmart:function(t,e,o){var i=this.findAppWindow();Ext.isEmpty(t)||i.getStorage().getSmart({object_id:t,callback:function(t,i){!0===t&&this.openShareWindow(i,e,o)},scope:this})},checkImportStatus:function(){var t,e;t={api:"SYNO.NoteStation.Import.Evernote",version:1,method:"get_status"},e={api:"SYNO.NoteStation.Import.Notebook",version:1,method:"status"},this.pollImportId&&this.pollUnreg(this.pollImportId),this.sendWebAPI({compound:{stopwhenerror:!1,params:[t,e]},callback:function(o,i){var n,s=[];if(o){try{n=i.result[0].data,Ext.isEmpty(n.importing)||0===n.notebook_left&&0===n.note_left||s.push(t)}catch(t){}try{n=i.result[1].data,!0!==n.finish&&s.push(e)}catch(t){}Ext.isEmpty(s)||(this.pollImportId=this.pollReg({webapi:{api:"SYNO.Entry.Request",version:1,method:"request",params:{compound:s}},interval:2,status_callback:this.onImportStatusCallback,scope:this}))}},scope:this})},stopImportStatus:function(){this.pollImportId&&(this.pollUnreg(this.pollImportId),this.pollImportId=null)},onImportStatusCallback:function(t,e){var o=!1;if(!t)return void this.stopImportStatus();Ext.iterate(e.result,function(t){if("SYNO.NoteStation.Import.Evernote"===t.api&&Ext.isObject(t.data)){if(Ext.isEmpty(t.data.importing)||0===t.data.notebook_left&&0===t.data.note_left)return o=!0,!1}else if("SYNO.NoteStation.Import.Notebook"===t.api&&Ext.isObject(t.data)&&!0===t.data.finish)return o=!0,!1},this),!0===o&&(this.syncNow(),this.checkImportStatus())},isViewPanelActive:function(){var t=this.getComponent("center_region");return!t||t.getLayout().activeItem===this.getViewPanel()},isTodoPanelActive:function(){var t=this.getComponent("center_region");return!!t&&t.getLayout().activeItem===this.getTodoPanel()},getCurrentNoteId:function(){return this.isViewPanelActive()&&this.notePanel?this.getEditorPanel().getNoteId():null},switchCenterPanel:function(t,e){var o=this.getTopToolbar(),i=this.getComponent("center_region"),n=this.getSearchField(),s=n.wrap.child(".x-form-field-wrap-center-img"),a=i.layout,r=function(){var t=i.getComponent("todo_panel");t.todoEditPanel.hide(),a.setActiveItem("todo_panel"),this.findAppWindow().focusEl.focus(),"today"===e||"next_7_days"===e||"overdue"===e?(t.listPredefined(e),o.getComponent("todo_filter").hide(),o.getComponent("todo_sort_by").hide()):(t.listTodoPanel(e),o.getComponent("todo_filter").show(),o.getComponent("todo_sort_by").show()),n.ignoreNextClick=1,n.emptyText=SYNO.SDS.NoteStation._T("common","search_todo_tasks"),n.applyEmptyText(),s&&s.addClass("syno-ns-search-icon")};"todo"===t?(o.getComponent("note_create_btn").hide(),Ext.isObject(a.activeItem)&&"view_panel"===a.activeItem.itemId?this.getEditorPanel().reloadNote(void 0,r,this):r.call(this)):(i.layout.setActiveItem("view_panel"),this.findAppWindow().focusEl.focus(),o.getComponent("todo_filter").hide(),o.getComponent("todo_sort_by").hide(),o.getComponent("note_create_btn").show(),n.ignoreNextClick=0,n.emptyText=SYNO.SDS.NoteStation._T("common","search"),n.applyEmptyText(),s&&s.removeClass("syno-ns-search-icon"))}}),Ext.define("SYNO.SDS.NoteStation.Hotkey",{keyCodes:{MOUSE_LEFT:1,MOUSE_RIGHT:3,MOUSE_MIDDLE:2,BACKSPACE:8,COMMA:188,INSERT:45,DELETE:46,END:35,ENTER:13,ESCAPE:27,CONTROL_LEFT:91,COMMAND_LEFT:17,COMMAND_RIGHT:93,ALT:18,HOME:36,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,SPACE:32,SHIFT:16,CAPS_LOCK:20,TAB:9,ARROW_RIGHT:39,ARROW_LEFT:37,ARROW_UP:38,ARROW_DOWN:40,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,PA_BR:19,SLASH:191,BACKSLASH:220,SEMICOLON:186},constructor:function(t){this.applyKeyCodes(),this.initHandlerPools(),this.onKeyDownRef=this.onKeyDown.bind(this),this.appWin=t.win,this.appWin.el.dom.addEventListener("keydown",this.onKeyDownRef,!1),this.registerAll()},applyKeyCodes:function(){for(var t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",e=0;e<t.length;e++)this.keyCodes[t.charAt(e)]=t.charCodeAt(e)},initHandlerPools:function(){this.handlerPools=[];for(var t=0;t<8;t++)this.handlerPools[t]={}},getHandlerPool:function(t){var e=t.ctrl?1:0;return e=(e<<1)+(t.shift?1:0),e=(e<<1)+(t.alt?1:0),this.handlerPools[e]},stopEventPropagation:function(t){t.preventDefault(),t.stopPropagation()},onKeyDown:function(t){var e={ctrl:t.ctrlKey||t.metaKey,shift:t.shiftKey,alt:t.altKey,target:t.target,event:t},o=this.getHandlerPool(e),i=o[t.keyCode];Ext.isFunction(i)&&!1!==i.call(this,t,e)&&this.stopEventPropagation(t)},destroy:function(){this.onKeyDownRef&&(this.appWin.el.dom.removeEventListener("keydown",this.onKeyDownRef),this.onKeyDownRef=null)},register:function(t,e,o){Array.isArray(t)||(t=[t]);for(var i=0;i<t.length;i++)this._register(t[i],e,o)},_register:function(t,e,o){var i=this.getHandlerPool(e),n=this.keyCodes[t];n&&(i[n]=o)},registerAll:function(){this.register("N",{ctrl:!0},function(){this.appWin.getMainPanel().createNote()}),this.register("P",{ctrl:!0},function(){this.appWin.getMainPanel().getEditorPanel().handlePrint()}),this.register("F",{ctrl:!0,shift:!0},function(){this.appWin.getMainPanel().getSearchField().focus()}),this.register("S",{ctrl:!0},function(){this.appWin.getMainPanel().getEditorPanel().handleSave()}),this.register("T",{ctrl:!0,alt:!0},function(){this.appWin.getMainPanel().getEditorPanel().handleCreateTag()}),this.register("F1",{},function(){this.appWin.onClickHelp()}),this.register("F2",{},function(){
this.appWin.getMainPanel().getEditorPanel().focusOnTitle()}),this.register("F3",{},function(){this.appWin.getMainPanel().getEditorPanel().focusOnTag()}),this.register("I",{ctrl:!0,shift:!0},function(){this.appWin.getMainPanel().getEditorPanel().handleShowInfo()}),this.register("DELETE",{},function(t){if("INPUT"===t.target.tagName||"TEXTAREA"===t.target.tagName)return!1;this.appWin.getMainPanel().getNotePanel().handleDeleteNote()}),this.register("ENTER",{ctrl:!0,alt:!0},function(){if(!SYNO.SDS.NoteStation.Utils.supportFullscreen())return!1;this.appWin.getMainPanel().getEditorPanel().handleFullscreen()}),this.register("L",{ctrl:!0,alt:!0},function(){var t=SYNO.SDS.NoteStation.Utils.getCurrentNoteData();if(!t.object_id)return!1;var e=SYNO.SDS.NoteStation.Utils.getInternalLink(t.object_id,t.smart_id);if(!e)return!1;var o=SYNO.SDS.NoteStation.Utils.genElementToCopy(e);document.body.appendChild(o),SYNO.SDS.NoteStation.Utils.copyElement(o)?document.body.removeChild(o):new SYNO.SDS.NoteStation.Copy.Window({owner:this.appWin,title:SYNO.SDS.NoteStation._T("note","copy_link"),copy_content:e,close_callback:function(){document.body.removeChild(o)}}).show()}),this.register("M",{ctrl:!0,shift:!0},function(){this.appWin.getMainPanel().getNotePanel().handleMoveNotes()}),this.register("8",{ctrl:!0,alt:!0},function(){this.appWin.getMainPanel().getNotePanel().handleAddShortcut()}),this.register("E",{ctrl:!0,shift:!0},function(){this.appWin.getMainPanel().getEditorPanel().handleEncrypt()}),this.register("T",{ctrl:!0,shift:!0},function(){this.appWin.getMainPanel().getEditorPanel().handleOpenTodoWindow()}),this.register("A",{ctrl:!0,shift:!0},function(){this.appWin.getMainPanel().getTodoPanel().focusOnAddField()}),this.register("J",{ctrl:!0,shift:!0},function(){this.appWin.getMainPanel().getTodoPanel().toggleEditorPanel()}),this.register("C",{ctrl:!0,shift:!0},function(){this.appWin.getMainPanel().getTodoPanel().toggleDoneSelected()}),this.register("D",{ctrl:!0,shift:!0},function(){this.appWin.getMainPanel().getTodoPanel().deleteSelected()})}}),Ext.ns("SYNO.SDS.NoteStation"),SYNO.SDS.NoteStation.Application=Ext.extend(SYNO.SDS.AppInstance,{appWindowName:"SYNO.SDS.NoteStation.MainWindow",constructor:function(){SYNO.SDS.NoteStation.Application.superclass.constructor.apply(this,arguments)}}),Ext.define("SYNO.SDS.NoteStation.MainWindow",{extend:SYNO.SDS.NoteStation.Utils.isPublicShare?"SYNO.SDS.Window":"SYNO.SDS.AppWindow",mainPanel:null,constructor:function(t){var e=this;this.panelList={},this.enc_pwd=new Map,SYNO.SDS.NoteStation.Window=this,this.addEvents("storageready","ownednotebookloaded","joinednotebookloaded","tagloaded","shortcutloaded","ownedtodoloaded"),this.addEvents("ownedsmartloaded"),this.addEvents("beforedataload","afterdataload"),this.storage=new SYNO.SDS.NoteStation.Storage.Interface,Promise.all([new Promise(function(t){e.storage.initial({appWindow:e,callback:function(e,o){this.getMainPanel().isVisible()?t({succ:e,resp:o}):this.getMainPanel().on("afterlayout",function(){t({succ:e,resp:o})},this,{single:!0})},scope:e})}),this._getAuthKeyPromise()]).then(function(t){var o=t[0],i=o.succ,n=o.resp;e.getMainPanel().getNotePanel().applyDefaultSetting(),!0===SYNO.SDS.NoteStation.Utils.isPublicShare?e.getMainPanel().onShowContentByDefault.call(e.getMainPanel()):!0===i&&!1===n.has_fail?(e.loadAllDataAsync().then(function(){e.initSelectionOnOpen()}),e.fireEvent("storageready"),e.owner_uid=n.result[1].data.uid,e.settings=n.result[2].data,e.settings.allow_share=n.result[1].data.allow_share,e.showClipperNotify()):e.onInitFail(SYNO.API.Response.GetFirstError(n))}),this.tag={},this.shortcut={},this.joined={notebook:null,smart:null,note:{},owner:{}},this.owned={notebook:null,smart:null,stack:{},archive:[],note:{},all:[],shared:[],recycle:[],choosed:null,preset_id:null},this.uid_map={},this.settings={},this.initTinymcePlugins(),SYNO.SDS.NoteStation.Utils.initErrorStr(),this.callParent([this.fillConfig(t)])},_getAuthKeyPromise:function(){var t=this;return SYNO.SDS.NoteStation.Utils.isPublicShare?Promise.resolve():this.sendWebAPIPromise({api:"SYNO.API.Auth.Key",version:7,method:"grant",params:{allow_api:"SYNO.NoteStation.Note",allow_methods:["download"]}}).catch(function(t){return{}}).then(function(e){t.tid=e.tid})},fillConfig:function(t){var e={cls:"syno-ns-win",layout:"fit",height:580,width:1150,minHeight:480,minWidth:930,html:"",items:[this.getMainPanel()],listeners:{scope:this,afterrender:function(){SYNO.SDS.NoteStation.Utils.isPublicShare&&(this.header.setVisibilityMode(Ext.Element.DISPLAY),this.header.hide()),this.initHotkey()},beforeDestroy:function(){SYNO.SDS.NoteStation.Window&&delete SYNO.SDS.NoteStation.Window,this.destroyHotkey()},show:{fn:this.showPromptToast,scope:this,delay:2e3,single:!0}}};return SYNO.SDS.NoteStation.Utils.isPublicShare&&Ext.apply(e,{cls:"syno-ns-win syno-ns-win-publicshare"}),Ext.apply(e,t),e},initTinymcePlugins:function(){try{window.tinymce.synoReloadPlugins("SYNO.SDS.NoteStation.Application",["syno_autolink syno_searchreplace hr syno_table","syno_print syno_ddupload syno_checkbox syno_attachment_viewer textcolor","syno_fontselect syno_notefontsizeselect syno_listbox syno_copyformat syno_alignbutton","syno_tab syno_image syno_link syno_formupload syno_removeformat","syno_mobileoutput syno_lang syno_textcolor syno_recorder syno_paste syno_ns_lists syno_search","syno_reader_style syno_chart"])}catch(t){}},onInitFail:function(t){var e=this.getMsgBox(),o={};if(!Ext.isEmpty(e)){if(1047===t.code?o.fn="SYNO.SDS.AdminCenter.DirectoryService.Main":1011===t.code&&(o.fn="SYNO.SDS.AdminCenter.User.Main",o.userHomeDialog=!0),this._S("standalone"))return void this.getMainPanel().getEl().mask(SYNO.SDS.NoteStation.Utils.getErrorStr(t.code),"syno-ux-mask-info");e.alert("",SYNO.SDS.NoteStation.Utils.getErrorStr(t.code),function(){Ext.isString(o.fn)&&SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",Ext.apply(o,this.findAppWindow().openConfig)),this.close()},this)}},getMainPanel:function(){return Ext.isEmpty(this.mainPanel)&&(this.mainPanel=new SYNO.SDS.NoteStation.MainPanel({owner:this,header:!1,itemId:"main"})),this.mainPanel},addPanelScope:function(t,e){this.panelList[t]=e},getPanelScope:function(t){return t in this.panelList?this.panelList[t]:null},getStorage:function(){return this.storage},_getAbsoluteURL:function(t,e){return String.format("{0}/{1}/{2}",this.jsConfig.jsBaseURL,e||"webapi",t)},_getWebAPIURL:function(t){return String.format("{0}/{1}","/webapi/NoteStation",t)},_getImageURL:function(t){var e=SYNO.SDS.UIFeatures.IconSizeManager.isRetinaMode()?"_2x":"_1x";return String.format("{0}/images/{1}/{2}","webman/3rdparty/NoteStation",e,t)},initHotkey:function(){this.hotkeyManager||(this.hotkeyManager=new SYNO.SDS.NoteStation.Hotkey({win:this}))},destroyHotkey:function(){this.hotkeyManager&&this.hotkeyManager.destroy()},loadAllDataAsync:function(){var t=this;return this.fireEvent("beforedataload","all"),this.getStorage().listAllAsync().then(function(e){var o=e.succ,i=e.resp;return t.onLoadAllData(o,i),new Promise(function(t){setTimeout(function(){return t({succ:o,resp:i})},40)})})},loadTagAndShortcut:function(t,e){this.fireEvent("beforedataload",["tag","shortcut"]),this.getStorage().listTagAndShortcut({callback:function(o,i){this.onLoadAllData(o,i),Ext.isFunction(t)&&t.defer(200,e||window,[o,i])},scope:this})},loadTodo:function(t,e){this.fireEvent("beforedataload","todo"),this.getStorage().listTodo({callback:function(o,i){var n={};n.todo=i,this.onLoadAllData(o,n),Ext.isFunction(t)&&t.defer(200,e||window,[o,n])},scope:this})},selectNotebook:function(t,e){var o=this.getMainPanel();Ext.isEmpty(o)||o.fireEvent("selectnotebook",t,e)},selectNote:function(t,e,o){var i=this.getMainPanel();!Ext.isEmpty(i)&&Ext.isString(t)&&(Ext.isObject(o)||(o={}),this.joined.note.hasOwnProperty(t)||this.owned.note.hasOwnProperty(t)||-1===t.indexOf("_")?i.fireEvent("selectnote",t,e,o):this.getStorage().listNote(Ext.copyTo({filter:{object_id:t},field:{commit_msg:!0},cancel_previous_request:!1,callback:function(){i.fireEvent("selectnote",t,e,o)},scope:this},o,"perm_from,smart_id")))},selectTag:function(t){var e=this.getMainPanel();!Ext.isEmpty(e)&&Ext.isString(t)&&e.fireEvent("selecttag",t)},selectTodo:function(t){var e=this.getMainPanel();!Ext.isEmpty(e)&&Ext.isString(t)&&e.fireEvent("selecttodo",t)},selectUser:function(t){var e=this.getMainPanel();!Ext.isEmpty(e)&&Ext.isString(t)&&e.fireEvent("selectuser",t)},selectJoinedNote:function(t,e){var o=this.getMainPanel();!Ext.isEmpty(o)&&Ext.isNumber(t)&&Ext.isString(e)&&o.fireEvent("selectjoinednote",t,e)},selectStack:function(t,e){var o=this.getMainPanel();Ext.isEmpty(o)||Ext.isEmpty(t)||o.fireEvent("selectstack",t,e)},selectSmart:function(t,e){var o=this.getMainPanel();Ext.isEmpty(o)||Ext.isEmpty(t)||o.fireEvent("selectsmart",t,e)},selectNoteLink:function(t){var e,o,i=!1;if(!Ext.isString(t)||0!==t.indexOf("notestation://"))return i;if(e=t.split("/"),4>e.length)return i;if("remote"!==e[2])return i;if("self"===e[3])o=e[4],o in this.owned.note?this.selectNotebook(this.owned.note[o].parent_id):o in this.joined.note&&this.selectNotebook(this.joined.note[o].parent_id),this.selectNote(o,"select"),this.selectNote(o,void 0,{note_link:!0}),i=!0;else if("smart"===e[3]&&6===e.length){var n={perm_from:"smart",smart_id:e[4],note_link:!0};this.selectSmart(e[4]),this.selectNote(e[5],"select",n),this.selectNote(e[5],void 0,n),i=!0}return i},analyzeNotebook:function(t,e){var o,i,n={},s=!1;if(Ext.isObject(t)){if(!0!==e&&0!==t.total||(this.owned.notebook={},this.owned.all=[],this.owned.stack={},this.owned.choosed=null,this.owned.preset_id=null,this.owned.archive=[],this.joined.notebook={},s=!0),0===t.total)return this.fireEvent("ownednotebookloaded",this.owned),void this.fireEvent("joinednotebookloaded",this.joined);s||Ext.iterate(this.owned.all,function(t,e){n[t]=e}),t.notebooks.forEach(function(t){var e=Ext.isArray(t.items)?t.items:[],a=0;if(this.uid_map[t.owner.display_name]=t.owner.uid,i={id:t.object_id,title:t.title,item_count:e.length,shared:SYNO.SDS.NoteStation.Utils.isSharedAcl(t.acl),owner:t.owner.display_name,owned:t.owner.display_name===this._S("user"),perm:t.perm,preset:t.preset,ctime:t.ctime,mtime:t.mtime,stack:t.stack,archive:t.archive},""===i.title&&(i.title=SYNO.SDS.NoteStation._T("notebook","default")),i.owned){if(o=this.owned.notebook,!0===t.preset&&(this.owned.preset_id=i.id),!Ext.isEmpty(t.stack)){var r=SYNO.SDS.NoteStation.Utils.getStackId(t.stack);Ext.isObject(this.owned.stack[r])||(this.owned.stack[r]={title:t.stack,items:[]}),this.owned.stack[r].items.push(t.object_id)}!0===t.archive?this.owned.archive.push(t.object_id):!0===s?this.owned.all=this.owned.all.concat(e):Ext.iterate(e,function(t){n.hasOwnProperty(t)||(n[t]=-1,this.owned.all.push(t))},this)}else o=this.joined.notebook,Ext.isObject(this.joined.owner[i.owner])||(this.joined.owner[i.owner]={all:[],notebook:[],smart:[]}),-1==this.joined.owner[i.owner].notebook.indexOf(i.id)&&this.joined.owner[i.owner].notebook.push(i.id),a=0,e.forEach(function(t){Ext.isEmpty(this.joined.note[t])||a++},this),i.item_count=a;o[i.id]=i},this),this.fireEvent("ownednotebookloaded",this.owned),this.fireEvent("joinednotebookloaded",this.joined)}},analyzeSmart:function(t,e){var o,i;if(Ext.isObject(t)){if(!0!==e&&0!==t.total||(this.owned.smart={},this.joined.smart={}),0===t.total)return this.fireEvent("ownedsmartloaded",this.owned.smart),void this.fireEvent("joinednotebookloaded",this.joined);t.smarts.forEach(function(t){this.uid_map[t.owner.display_name]=t.owner.uid,i={id:t.object_id,title:t.title,owner:t.owner.display_name,owned:t.owner.display_name===this._S("user"),perm:t.perm,ctime:t.ctime,mtime:t.mtime},""===i.title&&(i.title=SYNO.SDS.NoteStation._T("notebook","default")),i.owned?o=this.owned.smart:(o=this.joined.smart,Ext.isObject(this.joined.owner[i.owner])||(this.joined.owner[i.owner]={all:[],notebook:[],smart:[]}),-1==this.joined.owner[i.owner].smart.indexOf(i.id)&&this.joined.owner[i.owner].smart.push(i.id)),o[i.id]=i},this),this.fireEvent("ownedsmartloaded",this.owned.smart),this.fireEvent("joinednotebookloaded",this.joined)}},analyzeNote:function(t,e){var o;if(Ext.isObject(t)&&(!0===e&&(this.owned.recycle=[],this.owned.note={},this.owned.shared=[],this.joined.note={},this.joined.owner={}),0!==t.total)){t.notes.forEach(function(t){if(this.uid_map[t.owner.display_name]=t.owner.uid,o={id:t.object_id,commit_msg:t.commit_msg,title:t.title||SYNO.SDS.NoteStation._T("note","untitled"),item_count:Ext.isArray(t.items)?t.items.length:0,shared:SYNO.SDS.NoteStation.Utils.isSharedAcl(t.acl),ind_shared:SYNO.SDS.NoteStation.Utils.isIndividualSharedAcl(t.acl),ind_joined:SYNO.SDS.NoteStation.Utils.isIndividualJoined(t.acl,this.owner_uid),owner:t.owner.display_name,owned:t.owner.display_name===this._S("user"),recycle:t.recycle,parent_id:t.parent_id,smart_id:t.smart_id,mtime:t.mtime,ctime:t.ctime,perm:t.perm,ver:t.ver,archive:t.archive},o.owned){if(this.owned.note[o.id]=o,!0===o.recycle)return void(!0!==o.archive&&-1===this.owned.recycle.indexOf(o.id)&&this.owned.recycle.push(o.id));if(!0===o.archive)return;o.ind_shared&&-1===this.owned.shared.indexOf(o.id)&&this.owned.shared.push(o.id)}else Ext.isObject(this.joined.owner[o.owner])||(this.joined.owner[o.owner]={all:[],notebook:[],smart:[]}),!0!==o.ind_joined||-1!==this.joined.owner[o.owner].all.indexOf(o.id)||o.recycle||this.joined.owner[o.owner].all.push(o.id),this.joined.note[o.id]=o},this);for(var i=this.enc_pwd.keys(),n=Array.isArray(i),s=0,i=n?i:i[Symbol.iterator]();;){var a;if(n){if(s>=i.length)break;a=i[s++]}else{if(s=i.next(),s.done)break;a=s.value}var r=a;if(!this.owned.note[r]&&!this.joined.note[r]){var l=this.enc_pwd.get(r).polling_id;l&&this.pollUnreg(l),this.enc_pwd.delete(r)}}}},analyzeShortCut:function(t,e){if(Ext.isObject(t)){if(!0!==e&&0!==t.total||(this.shortcut={}),0===t.total)return void this.fireEvent("shortcutloaded",this.shortcut);t.shortcuts.forEach(function(t){var e=t.owner.display_name===this._S("user"),o=1/0,i=1/0;if(!0===e){if(t.id in this.owned.notebook)o=this.owned.notebook[t.id].ctime,i=this.owned.notebook[t.id].mtime,""===t.title&&(t.title=this.owned.notebook[t.id].title);else if(t.id in this.owned.note)o=this.owned.note[t.id].ctime,i=this.owned.note[t.id].mtime;else if(t.id in this.owned.smart)o=this.owned.smart[t.id].ctime,i=this.owned.smart[t.id].mtime;else if("tag"!==t.category&&"stack"!==t.category)return}else if(t.id in this.joined.notebook)o=this.joined.notebook[t.id].ctime,i=this.joined.notebook[t.id].mtime,!0===this.joined.notebook[t.id].preset&&(t.title=this.joined.notebook[t.id].title);else{if(!(t.id in this.joined.note))return;o=this.joined.note[t.id].ctime,i=this.joined.note[t.id].mtime}this.shortcut[t.id]={id:t.id,category:t.category,title:t.title,item_count:Ext.isArray(t.items)?t.items.length:null,shared:SYNO.SDS.NoteStation.Utils.isSharedAcl(t.acl),owner:t.owner.display_name,owned:e,ctime:o,mtime:i}},this),this.fireEvent("shortcutloaded",this.shortcut)}},analyzeTag:function(t,e){if(Ext.isObject(t)){if(!0!==e&&0!==t.total||(this.tag={}),0===t.total)return void this.fireEvent("tagloaded",this.tag);t.tags.forEach(function(t){this.tag[t.tag_id]={id:t.tag_id,category:"tag",title:t.title,item_count:Ext.isArray(t.items)?t.items.length:0}},this),this.fireEvent("tagloaded",this.tag)}},analyzeTodo:function(t,e){if(Ext.isObject(t)){if(!0!==e&&0!==t.total||(this.owned.todo={},this.owned.star_todo={},this.owned.overdue_todo={},this.owned.today_todo={},this.owned.n7d_todo={},this.owned.todo.total=this.owned.star_todo.total=this.owned.overdue_todo.total=this.owned.today_todo.total=this.owned.n7d_todo.total=0),0===t.total)return void this.fireEvent("ownedtodoloaded",this.owned);var o={},i=0,n=0,s=0,a=0,r=0;t.todos.forEach(function(t){o={object_id:t.object_id,title:t.title,done:t.done,due_date:t.due_date,star:t.star,priority:t.priority,reminder_offset:t.reminder_offset,note_id:t.note_id},this.owned.todo[o.object_id]=o;var e=SYNO.SDS.NoteStation.Todo.Common.belongToWhichSubCategory(o);-1!==e.indexOf("today")&&(this.owned.today_todo[o.object_id]=o,s++),-1!==e.indexOf("next_7_days")&&(this.owned.n7d_todo[o.object_id]=o,a++),-1!==e.indexOf("overdue")&&(this.owned.overdue_todo[o.object_id]=o,r++),-1!==e.indexOf("star")&&(this.owned.star_todo[o.object_id]=o,n++),i++},this),this.owned.todo.total=i,this.owned.star_todo.total=n,this.owned.today_todo.total=s,this.owned.n7d_todo.total=a,this.owned.overdue_todo.total=r,this.fireEvent("ownedtodoloaded",this.owned)}},onLoadAllData:function(t,e){var o=!0;if(!1===t)return this.clearStatusBusy(),void this.fireEvent("afterdataload","all");!1===e.clear&&(o=!1),Ext.isEmpty(e.todo)||this.analyzeTodo(e.todo,o),Ext.isEmpty(e.note)||this.analyzeNote(e.note,o),Ext.isEmpty(e.notebook)||this.analyzeNotebook(e.notebook,o),Ext.isEmpty(e.smart)||this.analyzeSmart(e.smart,o),Ext.isEmpty(e.tag)||this.analyzeTag(e.tag,o),Ext.isEmpty(e.shortcut)||this.analyzeShortCut(e.shortcut,o),this.fireEvent("afterdataload","all")},setEncryptPassword:function(t,e,o,i){this.enc_pwd.set(t,{password:e,token:o,polling_id:i})},getEncryptPassword:function(t){return this.enc_pwd.has(t)?this.enc_pwd.get(t):{}},createEncryptToken:function(t,e,o){this.setEncryptPassword(t.object_id,t.password,null,null),synowebapi.request({api:"SYNO.NoteStation.Note.Encrypt",version:1,method:"create",params:{object_id:t.object_id,password:t.password,duration:120},encryption:["password"],callback:function(i,n){if(this.enc_pwd.has(t.object_id)){var s=this.pollReg({interval:30,webapi:{api:"SYNO.NoteStation.Note.Encrypt",version:1,method:"check",params:{object_id:t.object_id,token:n.token}},status_callback:function(e){e||(this.pollUnreg(s),this.createEncryptToken(t))},scope:this});this.setEncryptPassword(t.object_id,t.password,n.token,s)}Ext.isFunction(e)&&e.call(o||window)},scope:this})},reloadSettings:function(t){var e=!1;Ext.isObject(t)&&(this.settings.inline_thumb===t.inline_thumb&&this.settings.font_size===t.font_size&&this.settings.spell_check===t.spell_check||(e=!0),this.settings=Ext.apply(this.settings,t),e&&this.getMainPanel().getEditorPanel().reloadNote())},showClipperNotify:function(){var t,e,o,i,n=Ext.id();!0!==this.appInstance.getUserSettings("hide_clipper_notify")&&(t=String.format(SYNO.SDS.NoteStation._T("notify","clipper_install"),'<a href="https://chrome.google.com/webstore/detail/'+SYNO.SDS.NoteStation.Utils.clipperExtensionId+'" target="_blank">Synology Web Clipper</a>'),t+="<br><br><input type='checkbox' id='"+n+"' autocomplete='off' class=' x-form-checkbox x-form-field'>",t+="<label class='x-form-cb-label' style='top: -2px;'>"+SYNO.SDS.NoteStation._T("java","java_not_remind")+"</label>",SYNO.SDS.NoteStation.Utils.detectClipperInstalled(function(s){!0!==s&&(o=SYNO.SDS.SystemTray.notifyMsg("SYNO.SDS.NoteStation.Application",SYNO.SDS.NoteStation._T("app","displayname"),t,0,!1),e=Ext.get(n),i=function(){this.appInstance.setUserSettings("hide_clipper_notify",e.dom.checked)},e.on("click",i,this),o.mon(o,"destory",function(){e.un("click",i,this)},this))},this))},open:function(t){Ext.isEmpty(t.note_id)||(this.getMainPanel().isVisible()?this.selectNoteOnOpen(t):this.noteToSelect=t),this.callParent(arguments)},initSelectionOnOpen:function(){if(this.getMainPanel()){if(Ext.isEmpty(this.noteToSelect))return void this.selectNotebook("all",void 0);this.selectNoteOnOpen(this.noteToSelect),delete this.noteToSelect}},selectNoteOnOpen:function(t){Ext.isEmpty(t.notebook_id)?t.individual_join&&this.selectJoinedNote(t.uid,t.username):this.selectNotebook(t.notebook_id,void 0),this.selectNote(t.note_id,"select"),this.selectNote(t.note_id,"single")},showPromptToast:function(){if((!this.promptToast||!this.promptToast.isVisible())&&!this.isDestroyed&&this.appInstance){var t=this.appInstance.getUserSettings("hide_prompt_notify");SYNO.SDS.NoteStation.Define.NOTIFY_PROMPT_VERSION<=(Ext.isNumber(t)?t:0)||(this.promptToast=new SYNO.SDS.NoteStation.Client.PromptToast({renderTo:this.el,alignTargetEl:this.el,appWindow:this}),this.promptToast.slideIn(),this.mon(this.promptToast,"destroy",function(){this.promptToast=null},this,{single:!0}))}}}),Ext.ns("SYNO.SDS.NoteStation.Editor.Tinymce.Table"),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.Table.Property.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={resizable:!1,title:SYNO.SDS.NoteStation._T("tinymce","table_property"),autoHeight:!0,width:270,layout:"fit",cls:"syno-ns-table-property-win",items:this.getFormPanel(t),buttons:[{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.onClickCancel},{xtype:"syno_button",btnStyle:"blue",text:_T("common","ok"),handler:this.onClickOk,scope:this}],listeners:{afterLayout:function(){this.fillDefaultValue()},scope:this}};return this.module=t.module,this.owner=t.owner,this.editor=t.editor,this.appWin=this.findAppWindow(),this.enableKeepFocusOnEditor(),Ext.apply(e,t)},enableKeepFocusOnEditor:function(){this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel").tinymcePanel.enableKeepFocusOnEditor()},disableKeepFocusOnEditor:function(){this.appWin.getPanelScope("SYNO.SDS.NoteStation.Editor.Normal.Panel").tinymcePanel.disableKeepFocusOnEditor()},fillDefaultValue:function(){var t=this.getFormPanel().getForm(),e=this.editor.dom.getStyle(this.tableElm,"width"),o=this.editor.dom.getStyle(this.tableElm,"height");t.findField("user_set_width").setValue(e),t.findField("user_set_height").setValue(o)},getFormPanel:function(t){return Ext.isEmpty(this.tablePanel)&&(this.tablePanel=new SYNO.SDS.NoteStation.Editor.Tinymce.Table.Property.Panel({owner:this})),this.tablePanel},onClickCancel:function(){this.onCloseWin()},onClickOk:function(t){var e=this.getFormPanel().getForm(),o=e.findField("user_set_width").getValue(),i=e.findField("user_set_height").getValue();e.isValid()&&(Ext.isNumber(o)&&this.editor.dom.setStyle(this.tableElm,"width",o+"px"),Ext.isNumber(i)&&this.editor.dom.setStyle(this.tableElm,"height",i+"px"),this.editor.nodeChanged(),this.onCloseWin())},onCloseWin:function(){this.disableKeepFocusOnEditor(),this.close()}}),Ext.define("SYNO.SDS.NoteStation.Editor.Tinymce.Table.Property.Panel",{extend:"SYNO.SDS.NoteStation.Operate.FormPanel",constructor:function(t){this.callParent([this.fillConfig(t||{})])},fillConfig:function(t){var e={labelWidth:120,fieldWidth:100,items:[{xtype:"syno_numberfield",fieldLabel:SYNO.SDS.NoteStation._T("tinymce","width"),width:100,itemId:"table_width",name:"user_set_width",maxlength:4,cls:"syno-ns-editor-table-width",allowBlank:!1},{xtype:"syno_numberfield",fieldLabel:SYNO.SDS.NoteStation._T("tinymce","height"),width:100,itemId:"table_height",name:"user_set_height",maxlength:4,cls:"syno-ns-editor-table-height",allowBlank:!1}]};return Ext.apply(e,t)}}),Ext.define("SYNO.SDS.NoteStation.Editor.ColorPicker",{extend:"SYNO.ux.SplitButton",defaultColor:"000000",colNumber:10,transparentReset:!1,resetBtn:!0,Color:["000000","980000","ff0000","ff9000","fff001","1ee20f","0078ff","4a86e8","643ddb","d30e91","2e3133","5b0f00","a62929","b35900","7f6000","00802b","115ba6","1c4587","543d99","8c2a6c","64696e","85200c","e04343","e67300","bf9000","009933","1470cc","1155cc","7052cc","cc3d9c","7b8187","a61c00","ed4747","fa7d00","f1c232","00b23b","177ee5","4176cc","7e5ce5","e545b0","d0d4d9","cc4125","fa8282","fa9c3e","ffd966","4dbf73","499df2","6399f7","a18ae6","e67ec3","e6ebf0","dd7e6b","ffb2b2","ffb973","ffe599","70e096","99ceff","94b9f7","cebfff","ffa6e0","ffffff","e6b8af","ffcccc","ffd9b2","fff2cc","c4f5d4","cce6ff","c9daf8","e2d9ff","ffd9f2"],ColorDeep:["000000","980000","ff0000","ff9000","1ee20f","0078ff","4a86e8","643ddb","d30e91","2e3133","5b0f00","a62929","b35900","7f6000","00802b","115ba6","1c4587","543d99","8c2a6c","64696e","85200c","e04343","e67300","bf9000","009933","1470cc","1155cc","7052cc","cc3d9c","7b8187","a61c00","ed4747","fa7d00","f1c232","00b23b","177ee5","4176cc","7e5ce5","e545b0","cc4125","fa8282","fa9c3e","4dbf73","499df2","6399f7","a18ae6","e67ec3","dd7e6b","ffb2b2","ffb973","70e096","99ceff","94b9f7","cebfff","ffa6e0"],ColorLight:["fff001","d0d4d9","ffd966","e6ebf0","ffe599","ffffff","e6b8af","ffcccc","ffd9b2","fff2cc","c4f5d4","cce6ff","c9daf8","e2d9ff","ffd9f2"],constructor:function(t){this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={itemId:"custom_color_item",text:SYNO.SDS.NoteStation._T("editor","custom_color"),cls:"custom-item",iconCls:"custom-color-icon"},o=[];if(this.initColor(),Ext.isDefined(t.resetBtn)&&(this.resetBtn=t.resetBtn),this.resetBtn){var i={itemId:"reset_color_item",text:_T("common","reset"),cls:"reset-item",iconCls:"reset-color-icon"};o.push(i)}var n={cls:"syno-ns-colorjoe-color-item-horizontal-line",htmlEncode:!1,disabled:!0};o.push(n);var s,a=this.Color;for(s=0;s<a.length;s++){var r=this.ColorDeep.indexOf(a[s])>=0?"syno-ns-colorjoe-color-deep":"syno-ns-colorjoe-color-light";this.colNumber===s&&o.push(n),o.push({itemId:"color-"+a[s],htmlEncode:!1,cls:"syno-ns-colorjoe-color-item syno-ns-colorjoe-color-"+a[s]+" "+r})}o.push(n),o.push(e);var l=t.name||"color_picker";return Ext.apply({itemId:l+"_sbtn",cls:"syno-ns-colorjoe-"+l.replace(/_/g,"-")+"-sbtn",tooltip:"STRING:"+l,menu:new SYNO.ux.Menu(Ext.apply({cls:"syno-ns-colorjoe-toolbar-color-menu",items:o,listeners:{scope:this,itemclick:function(t,e){var o=t.itemId.match(/color-[0-9a-f]{6}/);if(o){var i=o[0].split("-")[1];this.setColor(i),this.oncolorselect(this,i)}else if("reset_color_item"===t.itemId)this.setColor(null),this.oncolorselect(Ext.apply({name:l},t),null);else if("set_transparent_item"===t.itemId)this.setColor("transparent"),this.oncolorselect(Ext.apply({name:l},t),"transparent");else if("custom_color_item"===t.itemId){var n=new SYNO.SDS.NoteStation.Editor.ColorWindow({colorBtn:this,color:this.color});n.show()}},beforeshow:function(t){this.updateCustomColor();var e="color-"+(this.color||this.defaultColor),o=t.getComponent("custom_color_item");this.CustomColor.length>0?o.el.dom.style.marginBottom="6px":o.el.dom.style.marginBottom="",Ext.each(this.CustomColor,function(e,o){var i="color-"+e,n=t.getComponent(i);Ext.isDefined(n)||t.addItem({itemId:i,htmlEncode:!1,cls:"syno-ns-colorjoe-color-item syno-ns-colorjoe-color-custom",listeners:{scope:this,afterrender:function(t){t.el.dom.firstChild.style.backgroundColor="#"+e}}})}),Ext.each(t.items.items,function(t){if(t.itemId){t.itemId.match(/color-[0-9a-f]{6}/)&&(t.itemId===e?t.el.dom.classList.add("syno-ns-colorjoe-color-selected"):t.el.dom.classList.remove("syno-ns-colorjoe-color-selected"))}},this)}}},t.menuCfg||{})),listeners:{render:{single:!0,scope:this,fn:function(t){var e=document.createElement("span");e.classList.add("syno-ns-colorjoe-color-preview"),t.getEl().child("button").appendChild(e)}},click:function(t,e){t.showMenu()}}},t)},initColor:function(){this.CustomColor=[],this.AllColor=new Set;for(var t=0;t<this.Color.length;t++)this.AllColor.add(this.Color[t])},setColorPreview:function(t){this.getEl()&&(t=null===t&&this.transparentReset?"transparent":t||"#"+this.defaultColor,this.getEl().child("span").setStyle("background-color",t))},updateCustomColor:function(t){t&&(t=t.toLowerCase(),this.AllColor.has(t)||(this.CustomColor.push(t),this.AllColor.add(t)))},resetCustomColor:function(){var t,e=this.menu;Ext.iterate(this.CustomColor,function(t){this.AllColor.delete(t)},this),this.CustomColor=[],t=e.findBy(function(t){if(t.el)return!!t.el.hasClass("syno-ns-colorjoe-color-custom")||void 0}),Ext.iterate(t,function(t){e.remove(t)})},convert_to_hex:function(t){var e,o,i,n;if(Ext.isString(t))return"#"===t.substr(0,1)?t.substr(1):(n=/(.*?)rgb\((\d+),\s*(\d+),\s*(\d+)\)/i.exec(t),e=parseInt(n[2],10).toString(16),o=parseInt(n[3],10).toString(16),i=parseInt(n[4],10).toString(16),(1==e.length?"0"+e:e)+(1==o.length?"0"+o:o)+(1==i.length?"0"+i:i))},scanColor:function(t){t&&Ext.iterate(t.querySelectorAll('[style*="color"]'),function(t){Ext.isEmpty(t.style.color)||this.updateCustomColor(this.convert_to_hex(t.style.color)),Ext.isEmpty(t.style.backgroundColor)||this.updateCustomColor(this.convert_to_hex(t.style.backgroundColor))},this)},oncolorselect:Ext.emptyFn,getColor:function(){return this.color},setColor:function(t){null===t||"transparent"===t?this.color=t:(this.color=t.replace("#","").toLowerCase(),-1===t.indexOf("#")&&(t="#"+t)),this.setColorPreview(t)}}),Ext.define("SYNO.SDS.NoteStation.Editor.ColorWindow",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.colorBtn=t.colorBtn,this.color=t.color,this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("editor","custom_color_win_title"),itemId:"customer_color_window",width:440,height:360,cls:"syno-custom-color-picker-win syno-ns-custom-color-picker-win",buttons:[{text:_T("common","cancel"),scope:this,handler:this.onCancel},{text:_T("common","ok"),btnStyle:"blue",scope:this,handler:this.onApply}],items:[{xtype:"box",autoEl:{html:'<div id="customPicker"></div>'},listeners:{scope:this,afterrender:function(){this.customColorPalette=window.colorjoe.rgb("customPicker","#"+this.color,["currentColor",["fields",{space:"RGB",limit:255,fix:0}],"hex","text",["text",{text:"param demo"}]])}}}]};return Ext.apply(e,t)},onApply:function(t,e){13===t&&e.preventDefault(),this.setStatusBusy({text:_T("common","saving")});var o=this.customColorPalette.get().hex().toLowerCase().replace("#","");this.colorBtn.setColor(o),this.colorBtn.oncolorselect(this.colorBtn,o),this.colorBtn.updateCustomColor(o),this.clearStatusBusy(),this.close()},onCancel:function(){this.close()},onEnter:function(t,e){this.onApply(t,e)}}),Ext.define("SYNO.SDS.NoteStation.Encrypt.Copy.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e]),this.notebookStore.loadData(this.getNotebookData())},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("window","note_encryption"),width:450,autoHeight:!0,layout:"fit",cls:"syno-ns-encrypt-win",items:this.getEncryptCopyFormPanel(),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),scope:this,handler:this.onClickOk}],listeners:{beforeshow:function(){this.noteData=SYNO.SDS.NoteStation.Utils.getCurrentNoteData(),this.encryptCopyFormPanel.getForm().findField("title").setValue(this.noteData.title+" - "+SYNO.SDS.NoteStation._T("common","encrypt")),this.notebookComboBox.setValue(this.noteData.parent_id)},scope:this}};return Ext.apply(e,t)},getEncryptCopyFormPanel:function(){return this.notebookStore=new Ext.data.JsonStore({autoDestroy:!0,fields:["notebook_title","notebook_id"]}),this.notebookComboBox=new SYNO.ux.ComboBox({xtype:"syno_combobox",fieldLabel:SYNO.SDS.NoteStation._T("info","notebook"),store:this.notebookStore,displayField:"notebook_title",valueField:"notebook_id",name:"parent_id",mode:"local",scope:this}),this.encryptCopyFormPanel=new SYNO.SDS.NoteStation.Operate.FormPanel({defaults:{enableKeyEvents:!0,listeners:{keyup:function(t,e){13===e.keyCode&&this.onClickOk()},scope:this}},items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("note","copy_to_encrypt")},{xtype:"syno_textfield",fieldLabel:SYNO.SDS.NoteStation._T("info","title"),maxlength:SYNO.SDS.NoteStation.Define.TITLE_MAX_LENGTH,allowBlank:!1,name:"title"},this.notebookComboBox,{xtype:"syno_textfield",fieldLabel:_T("common","password"),textType:"password",name:"pwd",allowBlank:!1,maxlength:32},{xtype:"syno_textfield",fieldLabel:SYNO.SDS.NoteStation._T("common","confirm_password"),textType:"password_confirm",confirmFor:"pwd",allowBlank:!1,maxlength:32}],listeners:{beforeshow:function(){var t,e=this.findAppWindow();t=Ext.isEmpty(e.owned.choosed)?e.owned.preset_id:e.owned.choosed,this.notebookComboBox.setValue(t)},scope:this}}),this.encryptCopyFormPanel},onClickCancel:function(){this.close()},onClickOk:function(){
var t=this.encryptCopyFormPanel.getForm(),e=t.findField("pwd").getValue();if(!t.isValid())return!1;var o=this.findAppWindow(),i=o.getMainPanel(),n=CryptoJS.AES.encrypt(SYNO.SDS.NoteStation.Define.MAGIC+this.noteData.content,e).toString(),s=Ext.apply({},this.noteData);s.title=t.findField("title").getValue(),s.parent_id=this.notebookComboBox.getValue(),s.content=n,s.encrypt=!0,s.new_password=e,s.password=e,this.close(),i.copyNote(s)},getNotebookData:function(){var t=SYNO.SDS.NoteStation.Window,e=[];if(!Ext.isEmpty(t))return Ext.iterate(t.owned.notebook,function(t,o){!0===o.owned&&!0!==o.archive&&e.push({notebook_title:Ext.util.Format.htmlEncode(o.title),notebook_id:o.id})},this),e}}),Ext.define("SYNO.SDS.NoteStation.Encrypt.Modify.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e={title:SYNO.SDS.NoteStation._T("window","note_encryption"),width:640,autoHeight:!0,layout:"fit",cls:"syno-ns-encrypt-win",items:this.getEncryptModifyFormPanel(),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),scope:this,handler:this.onClickCancel},{disabled:_S("demo_mode"),xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onClickOk,scope:this}],listeners:{}};return Ext.apply(e,t)},getEncryptModifyFormPanel:function(){return this.encryptModifyFormPanel=new SYNO.SDS.NoteStation.Operate.FormPanel({fieldWidth:300,labelWidth:250,defaults:{enableKeyEvents:!0,listeners:{keyup:function(t,e){13===e.keyCode&&this.onClickOk()},scope:this}},items:[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("note","encrypt_desc")},{xtype:"syno_radio",boxLabel:SYNO.SDS.NoteStation._T("common","change_password"),inputValue:"encrypt_change",name:"encrypt"},{xtype:"syno_textfield",fieldLabel:_T("common","password"),textType:"password",name:"old_pwd",allowBlank:!1,maxlength:32,indent:2},{xtype:"syno_textfield",fieldLabel:SYNO.SDS.NoteStation._T("common","new_password"),textType:"password",name:"new_pwd",allowBlank:!1,maxlength:32,indent:2},{xtype:"syno_textfield",fieldLabel:SYNO.SDS.NoteStation._T("common","confirm_password"),textType:"password_confirm",confirmFor:"new_pwd",name:"confirm_new_pwd",allowBlank:!1,maxlength:32,indent:2},{xtype:"syno_radio",boxLabel:SYNO.SDS.NoteStation._T("note","copy_to_unencrypt"),inputValue:"copy_to_unencrypt",name:"encrypt"},{xtype:"syno_textfield",fieldLabel:_T("common","password"),textType:"password",name:"pwd",allowBlank:!1,maxlength:32,indent:2}],listeners:{single:!0,afterlayout:function(t,e){this.dummyEncryptRadioGroup=new SYNO.ux.Utils.EnableRadioGroup(t.getForm(),"encrypt",{encrypt_change:["old_pwd","new_pwd","confirm_new_pwd"],copy_to_unencrypt:["pwd"]}),SYNO.ux.AddWhiteTipWithMsg(t.getForm().findField("encrypt"),SYNO.SDS.NoteStation._T("common","change_password_tip"))}}}),this.encryptModifyFormPanel},onClickCancel:function(){this.hide()},onClickOk:function(t){var e=this.encryptModifyFormPanel.getForm();if(!e.isValid())return!1;var o,i,n,s,a=this.findAppWindow(),r=a.getMainPanel(),l=SYNO.SDS.NoteStation.Utils.getCurrentNoteData();if("encrypt_change"===e.findField("encrypt").getGroupValue()){if(s=e.findField("new_pwd").getValue(),a.getEncryptPassword(l.object_id).password!==e.findField("old_pwd").getValue())return this.setStatusError({text:_T("common","err_pass"),clear:!0}),!1;o=CryptoJS.AES.encrypt(SYNO.SDS.NoteStation.Define.MAGIC+l.content,s).toString(),i=!0}else{if(a.getEncryptPassword(l.object_id).password!==e.findField("pwd").getValue())return this.setStatusError({text:_T("common","err_pass"),clear:!0}),!1;o=l.content,i=!1}n=Ext.apply({},l),n.title=l.title+" - "+SYNO.SDS.NoteStation._T("common","duplicate"),n.content=o,n.encrypt=i,n.old_password=a.getEncryptPassword(l.object_id).password,i&&(n.new_password=s,n.password=s),this.close(),r.copyNote(n)}}),Ext.namespace("SYNO.SDS.NoteStation.ImportEvernote"),Ext.define("SYNO.SDS.NoteStation.ImportEvernote.Window",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e;return this.disableImportStop=!1,this.owner=t.owner,this.configPanel=new SYNO.SDS.NoteStation.ImportEvernote.Config({owner:this}),this.authPanel=new SYNO.SDS.NoteStation.ImportEvernote.Auth({owner:this}),this.selectNotebookPanel=new SYNO.SDS.NoteStation.ImportEvernote.NotebookPanel({owner:this}),this.importStatus={},this.stepStack=[],e=[this.configPanel,this.authPanel,this.selectNotebookPanel],Ext.apply({title:SYNO.SDS.NoteStation._T("import","import_wizard"),showHelp:!1,width:800,height:500,steps:e},t)},updateStatus:function(t){t=t||{},this.sendWebAPI({api:"SYNO.NoteStation.Import.Evernote",version:1,method:"get_status",callback:function(e,o,i){if(!e)return void(Ext.isFunction(t.callback)&&t.callback.call(t.scope||window,e,o,i));this.importStatus=o,Ext.isFunction(t.callback)&&t.callback.call(t.scope||window,e,o,i)},scope:this})},onOpen:function(){this.callParent(arguments),this.importLock(),this.setActiveStep("syno-ns-import-server")},onClose:function(){this.callParent(arguments),this.importStop()},addImportTaskAndStart:function(t,e){e=e||{},this.setStatusBusy(SYNO.SDS.NoteStation._T("import","prepare_import"));var o=function(){this.sendWebAPI({compound:{stopwhenerror:!0,params:[{api:"SYNO.NoteStation.Import.Evernote",version:1,method:"add_import_task",params:{notebook_guid:t,merge_notebook:this.getNotebookMerge()}},{api:"SYNO.NoteStation.Import.Evernote",version:1,method:"import"}]},callback:function(t,o){Ext.isFunction(e.callback)&&e.callback.call(e.scope||window,t,o),t&&(this.clearStatusBusy(),this.close())},scope:this})};this.checkLock({callback:o,scope:this})},importStop:function(t){t=t||{};var e=function(){this.sendWebAPI({api:"SYNO.NoteStation.Import.Evernote",version:1,method:"import_stop",callback:function(e,o,i){Ext.isFunction(t.callback)&&t.callback.call(t.scope||window,e,o,i)},scope:this})};if(this.disableImportStop)return void this.module.startPolling({evernote:!0});this.updateStatus({callback:function(t,o,i){t&&o.importing===this.lock&&e.call(this)},scope:this})},importLock:function(t){t=t||{},this.sendWebAPI({api:"SYNO.NoteStation.Import.Evernote",version:1,method:"import_lock",callback:function(e,o,i){Ext.isFunction(t.callback)&&t.callback.call(t.scope||window,e,o,i),e&&(this.lock=o.lock)},scope:this})},checkLock:function(t){var e=this.findAppWindow();this.updateStatus({callback:function(o,i,n){o&&(i.importing!==this.lock?(Ext.isFunction(t.onFail)&&t.onFail.call(t.scope||window),this.disableImportStop=!0,e.getMsgBox().alert(SYNO.SDS.NoteStation._T("error","title"),SYNO.SDS.NoteStation._T("import","task_canceled"),function(){this.close()},this)):Ext.isFunction(t.callback)&&t.callback.call(t.scope||window))},scope:this})},openEvernoteOAuth:function(){var t,e;t=this.getBaseURL({api:"SYNO.NoteStation.Import.Evernote",version:1,method:"get_oauth_url",params:{server:this.getServerName()}}),e=window.open(t),e.onbeforeunload=function(){};var o=function(){e.close()};this.checkLock({onFail:o,scope:this})},setStatusBusy:function(t){this.el.mask(t||"","x-mask-loading")},clearStatusBusy:function(){this.el.unmask()},getServerName:function(){return this.configPanel?this.configPanel.getForm().getValues().server_name:"evernote"},getNotebookMerge:function(){return!!this.configPanel&&"true"===this.configPanel.getForm().getValues().merge_notebook}}),Ext.define("SYNO.SDS.NoteStation.ImportEvernote.Config",{extend:"SYNO.ux.FormPanel",constructor:function(t){this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e=[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("import","evernote_server"),indent:0},{xtype:"syno_radio",boxLabel:"Evernote",name:"server_name",inputValue:"evernote",checked:!0,indent:1},{xtype:"syno_radio",boxLabel:SYNO.SDS.NoteStation._T("import","yinxiang"),name:"server_name",inputValue:"yinxiang",indent:1},{xtype:"syno_checkbox",boxLabel:SYNO.SDS.NoteStation._T("import","merge_into_notebook"),name:"merge_notebook",itemId:"merge_notebook",indent:0}];return Ext.apply({headline:SYNO.SDS.NoteStation._T("import","evernote_config"),itemId:"syno-ns-import-server",nextId:"syno-ns-import-auth",items:e},t)},getNext:function(){return this.nextId}}),Ext.define("SYNO.SDS.NoteStation.ImportEvernote.Auth",{extend:"SYNO.ux.FormPanel",constructor:function(t){var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e=t.owner,o=[{xtype:"syno_displayfield",value:SYNO.SDS.NoteStation._T("import","get_access_right_desc")},{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("import","get_access_right_btn"),handler:function(){e.openEvernoteOAuth()}}];return Ext.apply({headline:SYNO.SDS.NoteStation._T("import","get_access_right"),itemId:"syno-ns-import-auth",nextId:"syno-ns-import-notebook",items:o},t)},activate:function(){!0!==this.owner.skipAuthPolling?(this.owner.getButton("next").disable(),this.owner.setStatusBusy(SYNO.SDS.NoteStation._T("import","wait_evernote")),this.sendWebAPI({api:"SYNO.NoteStation.Import.Evernote",version:1,method:"check_oauth_token",callback:this.startPolling,scope:this})):this.owner.getButton("next").enable(),this.owner.skipAuthPolling=!1},checkState:function(){var t=this.owner.getButton("next"),e=t.disabled;SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments),!0===e?t.disable():t.enable()},deactivate:function(){Ext.isObject(this.statusTask)&&this.runner&&(this.runner.stopAll(),delete this.runner,delete this.statusTask)},getNext:function(){return this.nextId},startPolling:function(){var t=this.owner,e=this;Ext.isObject(this.statusTask)&&this.runner&&(this.runner.stopAll(),delete this.runner,delete this.statusTask),this.statusTask={run:function(){t.updateStatus({callback:function(){if(this.isDestroyed)return void e.runner.stop(e.statusTask);this.importStatus.token>0&&(e.runner.stop(e.statusTask),this.getButton("next").enable(),this.goNext(e.getNext()))},scope:t})},interval:1e3},this.sendWebAPI({api:"SYNO.NoteStation.Import.Evernote",version:1,method:"check_oauth_token",params:{server:this.owner.getServerName()},callback:function(e,o){t.clearStatusBusy(),!0===e?(t.getButton("next").enable(),t.goNext(this.getNext())):(this.runner=new Ext.util.TaskRunner,this.runner.start(this.statusTask))},scope:this})}}),Ext.define("SYNO.SDS.NoteStation.ImportEvernote.NotebookPanel",{extend:"SYNO.ux.Panel",constructor:function(t){this.callParent([this.fillConfig(t)])},fillConfig:function(t){this.grid=new SYNO.SDS.NoteStation.ImportEvernote.SelectNotebook({owner:this});var e={headline:SYNO.SDS.NoteStation._T("import","select_notebook"),description:SYNO.SDS.NoteStation._T("import","select_notebook_desc"),itemId:"syno-ns-import-notebook",nextId:null,items:[this.grid]};return Ext.apply(e,t)},getNext:function(){var t=[];return Ext.iterate(this.grid.getNotebookCheckedMap(),function(e,o,i){o&&t.push(e)},this),0===t.length?(this.owner.setStatusError({text:SYNO.SDS.NoteStation._T("error","import_no_select_notebook")}),!1):(this.owner.disableImportStop=!0,this.owner.addImportTaskAndStart.call(this.owner,t),!1)},activate:function(){this.grid.prepareNotebooks(),this.owner.skipAuthPolling=!0},deactivate:function(){}}),Ext.define("SYNO.SDS.NoteStation.ImportEvernote.SelectNotebook",{extend:"SYNO.ux.GridPanel",constructor:function(t){var e=this.fillConfig(t);this.callParent([e])},fillConfig:function(t){var e;this.itemPerPage=50,this.notebookCheckedMap={},e=new SYNO.API.Store({autoDestroy:!0,appWindow:this,api:"SYNO.NoteStation.Import.Evernote",method:"list_notebooks",version:1,baseParams:{limit:this.itemPerPage},reader:new Ext.data.JsonReader({root:"notebooks",totalProperty:"total",idProperty:"guid"},["guid","name","checked","ctime","mtime","stack"]),listeners:{load:function(t,e,o){Ext.each(e,function(t){t.data.guid in this.notebookCheckedMap&&t.set("checked",this.notebookCheckedMap[t.data.guid])},this)},loadexception:function(t,e,o){var i;if(Ext.isObject(o)&&Ext.isObject(o.errors)&&o.errors.code){switch(o.errors.code){case 2:case 3:i=SYNO.SDS.NoteStation._T("error","import_evernote_auth_fail");break;case 19:i=SYNO.SDS.NoteStation._T("error","import_reach_limit");break;default:i=SYNO.SDS.NoteStation._T("error","import_unknown")+o.errors.msg}this.setStatusError(i)}},update:function(t,e,o){this.notebookCheckedMap[e.data.guid]=e.data.checked},scope:this}});var o=new SYNO.ux.EnableColumn({header:"",dataIndex:"checked",disableSelectAll:!1,sortable:!1,resizable:!1,hideable:!1,width:120,align:"center",id:"enable"}),i=new Ext.grid.ColumnModel({defaults:{width:120,sortable:!0},columns:[o,{header:SYNO.SDS.NoteStation._T("import","notebook_name"),dataIndex:"name",width:200},{header:SYNO.SDS.NoteStation._T("import","ctime"),dataIndex:"ctime",width:200,renderer:function(t,e,o,i,n,s){return'<font class="syno-ns-info-mtime">'+new Date(1e3*t).format("y-m-d H:i:s")+"</font>"}},{header:SYNO.SDS.NoteStation._T("import","mtime"),dataIndex:"mtime",width:200,renderer:function(t,e,o,i,n,s){return'<font class="syno-ns-info-mtime">'+new Date(1e3*t).format("y-m-d H:i:s")+"</font>"}},{header:SYNO.SDS.NoteStation._T("import","notebook_stack"),dataIndex:"stack",width:200}]});return this.paging=new SYNO.ux.PagingToolbar({store:e,pageSize:this.itemPerPage,displayInfo:!0}),Ext.apply({width:720,height:321,colModel:i,store:e,plugins:[o],bbar:this.paging},t)},prepareNotebooks:function(){var t=this.owner.owner,e=function t(){this.sendWebAPI({api:"SYNO.NoteStation.Import.Evernote",version:1,method:"prepare_notebooks_status",callback:function(e,o,i){e&&(o.finish?(this.paging.doLoad(),this.clearStatusBusy()):Ext.defer(t,500,this))},scope:this})},o=function(){this.sendWebAPI({api:"SYNO.NoteStation.Import.Evernote",version:1,method:"prepare_notebooks",callback:function(t,o,i){t&&(this.prepareNotebooksTaskId=o.task_id,e.apply(this))},scope:this})};this.setStatusBusy(SYNO.SDS.NoteStation._T("import","wait_evernote")),this.getStore()&&this.getStore().removeAll(),t.checkLock.call(t,{callback:o,scope:this})},getNotebookCheckedMap:function(){return this.notebookCheckedMap},setStatusError:function(t){this.owner.owner.setStatusError({text:t})},setStatusBusy:function(t){this.owner.owner.setStatusBusy(t)},clearStatusBusy:function(){this.owner.owner.clearStatusBusy()}}),Ext.define("SYNO.SDS.NoteStation.Todo.Preview.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){var e=this.fillConfig(t);this.callParent([e]),this.loadNote()},fillConfig:function(t){var e={owner:t.owner,module:t.module,cls:"syno-ns-info-history-preview-win",width:700,height:520,title:"title",layout:"fit",items:[this.getPreviewPanel()],buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","close"),scope:this,handler:this.close}]};return Ext.apply(e,t)},getPreviewEditor:function(){return this.previewEditor=new SYNO.SDS.NoteStation.Editor.Preview.Panel({layout:"fit",anchor:"100% 100%",owner:this}),this.previewEditor},getPreviewPanel:function(){return this.previewPanel=new SYNO.ux.Panel({layout:"fit",items:[this.getPreviewEditor()],owner:this}),this.previewPanel},loadNote:function(){this.setStatusBusy(),this.noteData=null,this.owner.findAppWindow().getStorage().getNote({object_id:this.object_id,callback:this.onLoadNote,scope:this})},onLoadNote:function(t,e){if(!t||Ext.isEmpty(this.previewEditor))return void this.clearStatusBusy();this.noteData=e,this.previewEditor.setData(e),this.setTitle(e.title),this.clearStatusBusy(),this.onResize(this.getWidth()+1,this.getHeight()+1)}}),Ext.define("SYNO.SDS.NoteStation.Conflict.Panel",{extend:"SYNO.ux.Panel",constructor:function(t){this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={owner:t.owner,module:t.module,layout:"form",cls:"syno-ns-conflict-editor-panel",items:[new SYNO.ux.DisplayField({cls:"syno-ns-conflict-readme",value:SYNO.SDS.NoteStation._T("conflict","readme")}),new SYNO.ux.CompositeField({cls:"syno-ns-conflict-options",hideLabel:!0,items:[this.getOptionCombo(),{xtype:"syno_button",hideLabel:!0,btnStyle:"blue",style:{marginLeft:"3px"},text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onClickOk,scope:this}]}),this.getPreviewEditor()],listeners:{afterlayout:function(){this.isVisible()&&this.loadNote()},scope:this}};return this.owner=t.owner,Ext.apply(e,t)},getOptionCombo:function(){return this.optionCombo||(this.optionCombo=new SYNO.ux.ComboBox({xtype:"syno_combobox",hideLabel:!0,allowBlank:!1,forceSelection:!0,displayField:"text",valueField:"value",width:300,store:new Ext.data.ArrayStore({fields:["text","value"],data:[[SYNO.SDS.NoteStation._T("conflict","skip"),"skip"],[SYNO.SDS.NoteStation._T("conflict","overwrite"),"overwrite"],[SYNO.SDS.NoteStation._T("conflict","duplicate"),"duplicate"]]}),value:"overwrite"})),this.optionCombo},getPreviewEditor:function(){return this.previewEditor||(this.previewEditor=new SYNO.SDS.NoteStation.Editor.Preview.Panel({layout:"fit",owner:this,itemId:"editor"})),this.previewEditor},setNoteData:function(t){this.currNoteData=Ext.apply({},t)},loadNote:function(){Ext.isObject(this.currNoteData)&&(this.module.setStatusBusy(),this.owner.findAppWindow().getStorage().getNote({object_id:this.currNoteData.object_id,callback:this.onLoadNote,scope:this}))},onLoadNote:function(t,e){var o,i,n,s={title:SYNO.SDS.NoteStation._T("info","title"),tag:SYNO.SDS.NoteStation._T("category","tag"),location_all:SYNO.SDS.NoteStation._T("info","location"),source_url:SYNO.SDS.NoteStation._T("info","source_url"),content:SYNO.SDS.NoteStation._T("tooltip","content"),attachment:SYNO.SDS.NoteStation._T("tooltip","attach_file")};if(!t||Ext.isEmpty(this.previewEditor)||!Ext.isObject(this.currNoteData))return void this.module.clearStatusBusy();this.latestNoteData=e,this.latestNoteData.location_all=this.getLocationDisplayText(this.latestNoteData),this.currNoteData.location_all=this.getLocationDisplayText(this.currNoteData),i=this.getPreviewEditor().getEditor(),o="",n='<div class="syno-ns-conflict-diff-item"><span class="syno-ns-conflict-diff-item-title">{0}</span></div><div class="syno-ns-conflict-diff-result">{1}</div><div><br><div>',this.syno_diff_seq=0,Ext.iterate(s,function(t,e){var i,s=this.currNoteData[t],a=this.latestNoteData[t];if("attachment"===t)return i=this.getAttachmentDiff(a,this.latestNoteData.ver,s,this.currNoteData.ver),void(!0===i.result&&(o+=String.format(n,e,i.html)));Ext.encode(a)!==Ext.encode(s)&&(Ext.isString(a)&&Ext.isString(s)?(i=window.htmldiff(a,s),o+=String.format(n,e,i)):Ext.isObject(a)&&Ext.isObject(s)?(a=Ext.encode(a),s=Ext.encode(s),a!==s&&(o+=String.format(n,e,window.htmldiff(a,s)))):Ext.isArray(a)&&Ext.isArray(s)&&(a=Ext.encode(a),s=Ext.encode(s),a!==s&&(o+=String.format(n,e,window.htmldiff(a,s)))))},this),i.setContent(o),this.adjustEditorSize(),this.module.clearStatusBusy()},getAttachmentDiff:function(t,e,o,i){var n,s={},a=0,r={},l={};return Ext.isObject(o)&&Ext.iterate(o,function(t,e){if(!Ext.isEmpty(e.ref))return l[t]=e,void(l[t].diff_ver=i);s[t]=Ext.apply({},{diff_result:"create",diff_ver:i},e),a++}),Ext.isObject(t)&&Ext.iterate(t,function(t,o){if(!Ext.isEmpty(o.ref))return l[t]=o,void(l[t].diff_value=e);s.hasOwnProperty(t)?s[t].md5===o.md5?(s[t].diff_result="equal",a--):(s[t].diff_result="modify",s[t].diff_size=o.size):(s[t]=Ext.apply({},{diff_result:"remove",diff_ver:e},o),a++)}),0!==a?(r.result=!0,r.html="",n="<div><{0}>{1}({2})</{0}></div>",Ext.iterate(s,function(t,e){"equal"===e.diff_result?r.html+=String.format(n,"span",e.name,Ext.util.Format.fileSize(e.size)):"create"===e.diff_result?r.html+=String.format(n,"ins",e.name,Ext.util.Format.fileSize(e.size)):"remove"===e.diff_result?r.html+=String.format(n,"del",e.name,Ext.util.Format.fileSize(e.size)):"modify"===e.diff_result&&(r.html+=String.format(n,"del",e.name,Ext.util.Format.fileSize(e.size)),r.html+=String.format(n,"ins",e.name,Ext.util.Format.fileSize(e.diff_size)))})):r.result=!1,this.noteData=Ext.apply({},{attachment:l},this.currNoteData),this.getPreviewEditor().setAttachment(l),r},adjustEditorSize:function(){var t=this.bwrap.getHeight();this.items.each(function(e){"editor"!==e.itemId&&(t-=e.getHeight())},this),this.getPreviewEditor().setHeight(t),Ext.get(this.getPreviewEditor().getEditor().getBody()).setStyle({margin:0})},getLocationDisplayText:function(t){var e,o,i,n,s="";return Ext.isObject(t)?(o=t.location||"",i=t.latitude||0,n=t.longitude||0,""!==o&&0!==n&&0!==i?(e="{0} ({1},{2})",s=String.format(e,o,Ext.util.Format.number(i,"0.00"),Ext.util.Format.number(n,"0.00"))):""===o&&0!==n&&0!==i?(e="({0},{1})",s=String.format(e,Ext.util.Format.number(i,"0.00"),Ext.util.Format.number(n,"0.00"))):(e="{0}",s=String.format(e,o)),s):s},onClickOk:function(){var t=this.getOptionCombo().getValue();if("overwrite"===t)this.module.onClickOverwrite(this.currNoteData);else if("skip"===t)this.module.onClickSkip();else{if("duplicate"!==t)return;this.module.onClickDuplicate(this.currNoteData)}}}),Ext.define("SYNO.SDS.NoteStation.Conflict.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(t){this.callParent([this.fillConfig(t)])},fillConfig:function(t){var e={owner:t.owner,module:t.module,cls:"syno-ns-conflict-win",title:SYNO.SDS.NoteStation._T("conflict","title"),width:800,height:560,layout:"fit",items:this.getConflictPanel(t),footer:!1,buttons:[],useStatusBar:!1};return Ext.apply(e,t)},getConflictPanel:function(t){return this.conflictPanel?this.conflictPanel:(this.conflictPanel=new SYNO.SDS.NoteStation.Conflict.Panel({title:SYNO.SDS.NoteStation._T("conflict","current_version"),itemId:"current",owner:t.owner,cls:"syno-ns-conflict-panel",module:this}),this.conflictPanel)},setConflictData:function(t){if(!Ext.isObject(t))return!1;this.getConflictPanel().setNoteData(t.noteData),this.noteParams=Ext.apply({},t.params)},onClickSkip:function(){this.closeWin()},onClickOverwrite:function(){var t=this;this.setStatusBusy(),this.overwriteNote().then(function(e){var o=e.succ,i=e.resp;t.clearStatusBusy(),o?t.module.owner.fireEvent("notesaved",o,i):SYNO.SDS.NoteStation.Utils.showErrorMsg(t.module.findAppWindow(),i),t.closeWin()})},onClickDuplicate:function(t){var e=this,o=t.object_id,i=t.ver,n=this.owner.findAppWindow();this.setStatusBusy(),new Promise(function(t){n.mainPanel.copyNote({title_postfix:" - "+SYNO.SDS.NoteStation._T("common","duplicate"),object_id:o,ver:i},function(e){t({resp:e})})}).then(function(t){var o=t.resp;return e.module.clearNote(),e.overwriteNote({object_id:o.object_id,ver:o.ver})}).then(function(t){var o=t.succ,i=t.resp;e.clearStatusBusy(),o?(e.module.owner.fireEvent("notesaved",o,i),e.module.loadNote(i.object_id)):SYNO.SDS.NoteStation.Utils.showErrorMsg(e.module.findAppWindow(),i),e.closeWin()})},overwriteNote:function(t){var e=this;return new Promise(function(o,i){var n=e.owner.findAppWindow(),s=_extends({},e.noteParams,t,{check_conflict:!1,callback:function(t,e){o({succ:t,resp:e})}});e.noteParams.token?n.getStorage().setNotePolling(s):n.getStorage().setNote(s)})},closeWin:function(){this.close()}});
